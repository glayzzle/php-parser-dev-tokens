[["T_OPEN_TAG","<?php\n",1],["T_DOC_COMMENT","\/**\n * Magento\n *\n * NOTICE OF LICENSE\n *\n * This source file is subject to the Open Software License (OSL 3.0)\n * that is bundled with this package in the file LICENSE.txt.\n * It is also available through the world-wide-web at this URL:\n * http:\/\/opensource.org\/licenses\/osl-3.0.php\n * If you did not receive a copy of the license and are unable to\n * obtain it through the world-wide-web, please send an email\n * to license@magento.com so we can send you a copy immediately.\n *\n * DISCLAIMER\n *\n * Do not edit or add to this file if you wish to upgrade Magento to newer\n * versions in the future. If you wish to customize Magento for your\n * needs please refer to http:\/\/www.magento.com for more information.\n *\n * @category    Mage\n * @package     Mage_Review\n * @copyright  Copyright (c) 2006-2016 X.commerce, Inc. and affiliates (http:\/\/www.magento.com)\n * @license    http:\/\/opensource.org\/licenses\/osl-3.0.php  Open Software License (OSL 3.0)\n *\/",2],["T_WHITESPACE","\n\n\n",25],["T_DOC_COMMENT","\/**\n * Review resource model\n *\n * @category    Mage\n * @package     Mage_Review\n * @author      Magento Core Team <core@magentocommerce.com>\n *\/",28],["T_WHITESPACE","\n",34],["T_CLASS","class",35],["T_WHITESPACE"," ",35],["T_STRING","Mage_Review_Model_Resource_Review",35],["T_WHITESPACE"," ",35],["T_EXTENDS","extends",35],["T_WHITESPACE"," ",35],["T_STRING","Mage_Core_Model_Resource_Db_Abstract",35],["T_WHITESPACE","\n",35],"{",["T_WHITESPACE","\n    ",36],["T_DOC_COMMENT","\/**\n     * Review table\n     *\n     * @var string\n     *\/",37],["T_WHITESPACE","\n    ",41],["T_PROTECTED","protected",42],["T_WHITESPACE"," ",42],["T_VARIABLE","$_reviewTable",42],";",["T_WHITESPACE","\n\n    ",42],["T_DOC_COMMENT","\/**\n     * Review Detail table\n     *\n     * @var string\n     *\/",44],["T_WHITESPACE","\n    ",48],["T_PROTECTED","protected",49],["T_WHITESPACE"," ",49],["T_VARIABLE","$_reviewDetailTable",49],";",["T_WHITESPACE","\n\n    ",49],["T_DOC_COMMENT","\/**\n     * Review status table\n     *\n     * @var string\n     *\/",51],["T_WHITESPACE","\n    ",55],["T_PROTECTED","protected",56],["T_WHITESPACE"," ",56],["T_VARIABLE","$_reviewStatusTable",56],";",["T_WHITESPACE","\n\n    ",56],["T_DOC_COMMENT","\/**\n     * Review entity table\n     *\n     * @var string\n     *\/",58],["T_WHITESPACE","\n    ",62],["T_PROTECTED","protected",63],["T_WHITESPACE"," ",63],["T_VARIABLE","$_reviewEntityTable",63],";",["T_WHITESPACE","\n\n    ",63],["T_DOC_COMMENT","\/**\n     * Review store table\n     *\n     * @var string\n     *\/",65],["T_WHITESPACE","\n    ",69],["T_PROTECTED","protected",70],["T_WHITESPACE"," ",70],["T_VARIABLE","$_reviewStoreTable",70],";",["T_WHITESPACE","\n\n    ",70],["T_DOC_COMMENT","\/**\n     * Review aggregate table\n     *\n     * @var string\n     *\/",72],["T_WHITESPACE","\n    ",76],["T_PROTECTED","protected",77],["T_WHITESPACE"," ",77],["T_VARIABLE","$_aggregateTable",77],";",["T_WHITESPACE","\n\n    ",77],["T_DOC_COMMENT","\/**\n     * Cache of deleted rating data\n     *\n     * @var array\n     *\/",79],["T_WHITESPACE","\n    ",83],["T_PRIVATE","private",84],["T_WHITESPACE"," ",84],["T_VARIABLE","$_deleteCache",84],["T_WHITESPACE","   ",84],"=",["T_WHITESPACE"," ",84],["T_ARRAY","array",84],"(",")",";",["T_WHITESPACE","\n\n    ",84],["T_DOC_COMMENT","\/**\n     * Define main table. Define other tables name\n     *\n     *\/",86],["T_WHITESPACE","\n    ",89],["T_PROTECTED","protected",90],["T_WHITESPACE"," ",90],["T_FUNCTION","function",90],["T_WHITESPACE"," ",90],["T_STRING","_construct",90],"(",")",["T_WHITESPACE","\n    ",90],"{",["T_WHITESPACE","\n        ",91],["T_VARIABLE","$this",92],["T_OBJECT_OPERATOR","->",92],["T_STRING","_init",92],"(",["T_CONSTANT_ENCAPSED_STRING","'review\/review'",92],",",["T_WHITESPACE"," ",92],["T_CONSTANT_ENCAPSED_STRING","'review_id'",92],")",";",["T_WHITESPACE","\n        ",92],["T_VARIABLE","$this",93],["T_OBJECT_OPERATOR","->",93],["T_STRING","_reviewTable",93],["T_WHITESPACE","         ",93],"=",["T_WHITESPACE"," ",93],["T_VARIABLE","$this",93],["T_OBJECT_OPERATOR","->",93],["T_STRING","getTable",93],"(",["T_CONSTANT_ENCAPSED_STRING","'review\/review'",93],")",";",["T_WHITESPACE","\n        ",93],["T_VARIABLE","$this",94],["T_OBJECT_OPERATOR","->",94],["T_STRING","_reviewDetailTable",94],["T_WHITESPACE","   ",94],"=",["T_WHITESPACE"," ",94],["T_VARIABLE","$this",94],["T_OBJECT_OPERATOR","->",94],["T_STRING","getTable",94],"(",["T_CONSTANT_ENCAPSED_STRING","'review\/review_detail'",94],")",";",["T_WHITESPACE","\n        ",94],["T_VARIABLE","$this",95],["T_OBJECT_OPERATOR","->",95],["T_STRING","_reviewStatusTable",95],["T_WHITESPACE","   ",95],"=",["T_WHITESPACE"," ",95],["T_VARIABLE","$this",95],["T_OBJECT_OPERATOR","->",95],["T_STRING","getTable",95],"(",["T_CONSTANT_ENCAPSED_STRING","'review\/review_status'",95],")",";",["T_WHITESPACE","\n        ",95],["T_VARIABLE","$this",96],["T_OBJECT_OPERATOR","->",96],["T_STRING","_reviewEntityTable",96],["T_WHITESPACE","   ",96],"=",["T_WHITESPACE"," ",96],["T_VARIABLE","$this",96],["T_OBJECT_OPERATOR","->",96],["T_STRING","getTable",96],"(",["T_CONSTANT_ENCAPSED_STRING","'review\/review_entity'",96],")",";",["T_WHITESPACE","\n        ",96],["T_VARIABLE","$this",97],["T_OBJECT_OPERATOR","->",97],["T_STRING","_reviewStoreTable",97],["T_WHITESPACE","    ",97],"=",["T_WHITESPACE"," ",97],["T_VARIABLE","$this",97],["T_OBJECT_OPERATOR","->",97],["T_STRING","getTable",97],"(",["T_CONSTANT_ENCAPSED_STRING","'review\/review_store'",97],")",";",["T_WHITESPACE","\n        ",97],["T_VARIABLE","$this",98],["T_OBJECT_OPERATOR","->",98],["T_STRING","_aggregateTable",98],["T_WHITESPACE","      ",98],"=",["T_WHITESPACE"," ",98],["T_VARIABLE","$this",98],["T_OBJECT_OPERATOR","->",98],["T_STRING","getTable",98],"(",["T_CONSTANT_ENCAPSED_STRING","'review\/review_aggregate'",98],")",";",["T_WHITESPACE","\n    ",98],"}",["T_WHITESPACE","\n\n    ",99],["T_DOC_COMMENT","\/**\n     * Retrieve select object for load object data\n     *\n     * @param string $field\n     * @param mixed $value\n     * @param unknown_type $object\n     * @return Zend_Db_Select\n     *\/",101],["T_WHITESPACE","\n    ",108],["T_PROTECTED","protected",109],["T_WHITESPACE"," ",109],["T_FUNCTION","function",109],["T_WHITESPACE"," ",109],["T_STRING","_getLoadSelect",109],"(",["T_VARIABLE","$field",109],",",["T_WHITESPACE"," ",109],["T_VARIABLE","$value",109],",",["T_WHITESPACE"," ",109],["T_VARIABLE","$object",109],")",["T_WHITESPACE","\n    ",109],"{",["T_WHITESPACE","\n        ",110],["T_VARIABLE","$select",111],["T_WHITESPACE"," ",111],"=",["T_WHITESPACE"," ",111],["T_STRING","parent",111],["T_DOUBLE_COLON","::",111],["T_STRING","_getLoadSelect",111],"(",["T_VARIABLE","$field",111],",",["T_WHITESPACE"," ",111],["T_VARIABLE","$value",111],",",["T_WHITESPACE"," ",111],["T_VARIABLE","$object",111],")",";",["T_WHITESPACE","\n        ",111],["T_VARIABLE","$select",112],["T_OBJECT_OPERATOR","->",112],["T_STRING","join",112],"(",["T_WHITESPACE","\n            ",112],["T_VARIABLE","$this",113],["T_OBJECT_OPERATOR","->",113],["T_STRING","_reviewDetailTable",113],",",["T_WHITESPACE","\n            ",113],["T_VARIABLE","$this",114],["T_OBJECT_OPERATOR","->",114],["T_STRING","getMainTable",114],"(",")",".","\"",["T_ENCAPSED_AND_WHITESPACE",".review_id = ",114],["T_CURLY_OPEN","{",114],["T_VARIABLE","$this",114],["T_OBJECT_OPERATOR","->",114],["T_STRING","_reviewDetailTable",114],"}",["T_ENCAPSED_AND_WHITESPACE",".review_id",114],"\"",["T_WHITESPACE","\n        ",114],")",";",["T_WHITESPACE","\n        ",115],["T_RETURN","return",116],["T_WHITESPACE"," ",116],["T_VARIABLE","$select",116],";",["T_WHITESPACE","\n    ",116],"}",["T_WHITESPACE","\n\n    ",117],["T_DOC_COMMENT","\/**\n     * Perform actions before object save\n     *\n     * @param Varien_Object $object\n     * @return Mage_Review_Model_Resource_Review\n     *\/",119],["T_WHITESPACE","\n    ",124],["T_PROTECTED","protected",125],["T_WHITESPACE"," ",125],["T_FUNCTION","function",125],["T_WHITESPACE"," ",125],["T_STRING","_beforeSave",125],"(",["T_STRING","Mage_Core_Model_Abstract",125],["T_WHITESPACE"," ",125],["T_VARIABLE","$object",125],")",["T_WHITESPACE","\n    ",125],"{",["T_WHITESPACE","\n        ",126],["T_IF","if",127],["T_WHITESPACE"," ",127],"(","!",["T_VARIABLE","$object",127],["T_OBJECT_OPERATOR","->",127],["T_STRING","getId",127],"(",")",")",["T_WHITESPACE"," ",127],"{",["T_WHITESPACE","\n            ",127],["T_VARIABLE","$object",128],["T_OBJECT_OPERATOR","->",128],["T_STRING","setCreatedAt",128],"(",["T_STRING","Mage",128],["T_DOUBLE_COLON","::",128],["T_STRING","getSingleton",128],"(",["T_CONSTANT_ENCAPSED_STRING","'core\/date'",128],")",["T_OBJECT_OPERATOR","->",128],["T_STRING","gmtDate",128],"(",")",")",";",["T_WHITESPACE","\n        ",128],"}",["T_WHITESPACE","\n        ",129],["T_IF","if",130],["T_WHITESPACE"," ",130],"(",["T_VARIABLE","$object",130],["T_OBJECT_OPERATOR","->",130],["T_STRING","hasData",130],"(",["T_CONSTANT_ENCAPSED_STRING","'stores'",130],")",["T_WHITESPACE"," ",130],["T_BOOLEAN_AND","&&",130],["T_WHITESPACE"," ",130],["T_STRING","is_array",130],"(",["T_VARIABLE","$object",130],["T_OBJECT_OPERATOR","->",130],["T_STRING","getStores",130],"(",")",")",")",["T_WHITESPACE"," ",130],"{",["T_WHITESPACE","\n            ",130],["T_VARIABLE","$stores",131],["T_WHITESPACE"," ",131],"=",["T_WHITESPACE"," ",131],["T_VARIABLE","$object",131],["T_OBJECT_OPERATOR","->",131],["T_STRING","getStores",131],"(",")",";",["T_WHITESPACE","\n            ",131],["T_VARIABLE","$stores",132],"[","]",["T_WHITESPACE"," ",132],"=",["T_WHITESPACE"," ",132],["T_LNUMBER","0",132],";",["T_WHITESPACE","\n            ",132],["T_VARIABLE","$object",133],["T_OBJECT_OPERATOR","->",133],["T_STRING","setStores",133],"(",["T_VARIABLE","$stores",133],")",";",["T_WHITESPACE","\n        ",133],"}",["T_WHITESPACE"," ",134],["T_ELSEIF","elseif",134],["T_WHITESPACE"," ",134],"(",["T_VARIABLE","$object",134],["T_OBJECT_OPERATOR","->",134],["T_STRING","hasData",134],"(",["T_CONSTANT_ENCAPSED_STRING","'stores'",134],")",")",["T_WHITESPACE"," ",134],"{",["T_WHITESPACE","\n            ",134],["T_VARIABLE","$object",135],["T_OBJECT_OPERATOR","->",135],["T_STRING","setStores",135],"(",["T_ARRAY","array",135],"(",["T_VARIABLE","$object",135],["T_OBJECT_OPERATOR","->",135],["T_STRING","getStores",135],"(",")",",",["T_WHITESPACE"," ",135],["T_LNUMBER","0",135],")",")",";",["T_WHITESPACE","\n        ",135],"}",["T_WHITESPACE","\n        ",136],["T_RETURN","return",137],["T_WHITESPACE"," ",137],["T_VARIABLE","$this",137],";",["T_WHITESPACE","\n    ",137],"}",["T_WHITESPACE","\n\n    ",138],["T_DOC_COMMENT","\/**\n     * Perform actions after object save\n     *\n     * @param Varien_Object $object\n     * @return Mage_Review_Model_Resource_Review\n     *\/",140],["T_WHITESPACE","\n    ",145],["T_PROTECTED","protected",146],["T_WHITESPACE"," ",146],["T_FUNCTION","function",146],["T_WHITESPACE"," ",146],["T_STRING","_afterSave",146],"(",["T_STRING","Mage_Core_Model_Abstract",146],["T_WHITESPACE"," ",146],["T_VARIABLE","$object",146],")",["T_WHITESPACE","\n    ",146],"{",["T_WHITESPACE","\n        ",147],["T_VARIABLE","$adapter",148],["T_WHITESPACE"," ",148],"=",["T_WHITESPACE"," ",148],["T_VARIABLE","$this",148],["T_OBJECT_OPERATOR","->",148],["T_STRING","_getWriteAdapter",148],"(",")",";",["T_WHITESPACE","\n        ",148],["T_DOC_COMMENT","\/**\n         * save detail\n         *\/",149],["T_WHITESPACE","\n        ",151],["T_VARIABLE","$detail",152],["T_WHITESPACE"," ",152],"=",["T_WHITESPACE"," ",152],["T_ARRAY","array",152],"(",["T_WHITESPACE","\n            ",152],["T_CONSTANT_ENCAPSED_STRING","'title'",153],["T_WHITESPACE","     ",153],["T_DOUBLE_ARROW","=>",153],["T_WHITESPACE"," ",153],["T_VARIABLE","$object",153],["T_OBJECT_OPERATOR","->",153],["T_STRING","getTitle",153],"(",")",",",["T_WHITESPACE","\n            ",153],["T_CONSTANT_ENCAPSED_STRING","'detail'",154],["T_WHITESPACE","    ",154],["T_DOUBLE_ARROW","=>",154],["T_WHITESPACE"," ",154],["T_VARIABLE","$object",154],["T_OBJECT_OPERATOR","->",154],["T_STRING","getDetail",154],"(",")",",",["T_WHITESPACE","\n            ",154],["T_CONSTANT_ENCAPSED_STRING","'nickname'",155],["T_WHITESPACE","  ",155],["T_DOUBLE_ARROW","=>",155],["T_WHITESPACE"," ",155],["T_VARIABLE","$object",155],["T_OBJECT_OPERATOR","->",155],["T_STRING","getNickname",155],"(",")",",",["T_WHITESPACE","\n        ",155],")",";",["T_WHITESPACE","\n        ",156],["T_VARIABLE","$select",157],["T_WHITESPACE"," ",157],"=",["T_WHITESPACE"," ",157],["T_VARIABLE","$adapter",157],["T_OBJECT_OPERATOR","->",157],["T_STRING","select",157],"(",")",["T_WHITESPACE","\n            ",157],["T_OBJECT_OPERATOR","->",158],["T_STRING","from",158],"(",["T_VARIABLE","$this",158],["T_OBJECT_OPERATOR","->",158],["T_STRING","_reviewDetailTable",158],",",["T_WHITESPACE"," ",158],["T_CONSTANT_ENCAPSED_STRING","'detail_id'",158],")",["T_WHITESPACE","\n            ",158],["T_OBJECT_OPERATOR","->",159],["T_STRING","where",159],"(",["T_CONSTANT_ENCAPSED_STRING","'review_id = :review_id'",159],")",";",["T_WHITESPACE","\n        ",159],["T_VARIABLE","$detailId",160],["T_WHITESPACE"," ",160],"=",["T_WHITESPACE"," ",160],["T_VARIABLE","$adapter",160],["T_OBJECT_OPERATOR","->",160],["T_STRING","fetchOne",160],"(",["T_VARIABLE","$select",160],",",["T_WHITESPACE"," ",160],["T_ARRAY","array",160],"(",["T_CONSTANT_ENCAPSED_STRING","':review_id'",160],["T_WHITESPACE"," ",160],["T_DOUBLE_ARROW","=>",160],["T_WHITESPACE"," ",160],["T_VARIABLE","$object",160],["T_OBJECT_OPERATOR","->",160],["T_STRING","getId",160],"(",")",")",")",";",["T_WHITESPACE","\n\n        ",160],["T_IF","if",162],["T_WHITESPACE"," ",162],"(",["T_VARIABLE","$detailId",162],")",["T_WHITESPACE"," ",162],"{",["T_WHITESPACE","\n            ",162],["T_VARIABLE","$condition",163],["T_WHITESPACE"," ",163],"=",["T_WHITESPACE"," ",163],["T_ARRAY","array",163],"(",["T_CONSTANT_ENCAPSED_STRING","\"detail_id = ?\"",163],["T_WHITESPACE"," ",163],["T_DOUBLE_ARROW","=>",163],["T_WHITESPACE"," ",163],["T_VARIABLE","$detailId",163],")",";",["T_WHITESPACE","\n            ",163],["T_VARIABLE","$adapter",164],["T_OBJECT_OPERATOR","->",164],["T_STRING","update",164],"(",["T_VARIABLE","$this",164],["T_OBJECT_OPERATOR","->",164],["T_STRING","_reviewDetailTable",164],",",["T_WHITESPACE"," ",164],["T_VARIABLE","$detail",164],",",["T_WHITESPACE"," ",164],["T_VARIABLE","$condition",164],")",";",["T_WHITESPACE","\n        ",164],"}",["T_WHITESPACE"," ",165],["T_ELSE","else",165],["T_WHITESPACE"," ",165],"{",["T_WHITESPACE","\n            ",165],["T_VARIABLE","$detail",166],"[",["T_CONSTANT_ENCAPSED_STRING","'store_id'",166],"]",["T_WHITESPACE","   ",166],"=",["T_WHITESPACE"," ",166],["T_VARIABLE","$object",166],["T_OBJECT_OPERATOR","->",166],["T_STRING","getStoreId",166],"(",")",";",["T_WHITESPACE","\n            ",166],["T_VARIABLE","$detail",167],"[",["T_CONSTANT_ENCAPSED_STRING","'customer_id'",167],"]","=",["T_WHITESPACE"," ",167],["T_VARIABLE","$object",167],["T_OBJECT_OPERATOR","->",167],["T_STRING","getCustomerId",167],"(",")",";",["T_WHITESPACE","\n            ",167],["T_VARIABLE","$detail",168],"[",["T_CONSTANT_ENCAPSED_STRING","'review_id'",168],"]",["T_WHITESPACE","  ",168],"=",["T_WHITESPACE"," ",168],["T_VARIABLE","$object",168],["T_OBJECT_OPERATOR","->",168],["T_STRING","getId",168],"(",")",";",["T_WHITESPACE","\n            ",168],["T_VARIABLE","$adapter",169],["T_OBJECT_OPERATOR","->",169],["T_STRING","insert",169],"(",["T_VARIABLE","$this",169],["T_OBJECT_OPERATOR","->",169],["T_STRING","_reviewDetailTable",169],",",["T_WHITESPACE"," ",169],["T_VARIABLE","$detail",169],")",";",["T_WHITESPACE","\n        ",169],"}",["T_WHITESPACE","\n\n\n        ",170],["T_DOC_COMMENT","\/**\n         * save stores\n         *\/",173],["T_WHITESPACE","\n        ",175],["T_VARIABLE","$stores",176],["T_WHITESPACE"," ",176],"=",["T_WHITESPACE"," ",176],["T_VARIABLE","$object",176],["T_OBJECT_OPERATOR","->",176],["T_STRING","getStores",176],"(",")",";",["T_WHITESPACE","\n        ",176],["T_IF","if",177],["T_WHITESPACE"," ",177],"(","!",["T_EMPTY","empty",177],"(",["T_VARIABLE","$stores",177],")",")",["T_WHITESPACE"," ",177],"{",["T_WHITESPACE","\n            ",177],["T_VARIABLE","$condition",178],["T_WHITESPACE"," ",178],"=",["T_WHITESPACE"," ",178],["T_ARRAY","array",178],"(",["T_CONSTANT_ENCAPSED_STRING","'review_id = ?'",178],["T_WHITESPACE"," ",178],["T_DOUBLE_ARROW","=>",178],["T_WHITESPACE"," ",178],["T_VARIABLE","$object",178],["T_OBJECT_OPERATOR","->",178],["T_STRING","getId",178],"(",")",")",";",["T_WHITESPACE","\n            ",178],["T_VARIABLE","$adapter",179],["T_OBJECT_OPERATOR","->",179],["T_STRING","delete",179],"(",["T_VARIABLE","$this",179],["T_OBJECT_OPERATOR","->",179],["T_STRING","_reviewStoreTable",179],",",["T_WHITESPACE"," ",179],["T_VARIABLE","$condition",179],")",";",["T_WHITESPACE","\n\n            ",179],["T_VARIABLE","$insertedStoreIds",181],["T_WHITESPACE"," ",181],"=",["T_WHITESPACE"," ",181],["T_ARRAY","array",181],"(",")",";",["T_WHITESPACE","\n            ",181],["T_FOREACH","foreach",182],["T_WHITESPACE"," ",182],"(",["T_VARIABLE","$stores",182],["T_WHITESPACE"," ",182],["T_AS","as",182],["T_WHITESPACE"," ",182],["T_VARIABLE","$storeId",182],")",["T_WHITESPACE"," ",182],"{",["T_WHITESPACE","\n                ",182],["T_IF","if",183],["T_WHITESPACE"," ",183],"(",["T_STRING","in_array",183],"(",["T_VARIABLE","$storeId",183],",",["T_WHITESPACE"," ",183],["T_VARIABLE","$insertedStoreIds",183],")",")",["T_WHITESPACE"," ",183],"{",["T_WHITESPACE","\n                    ",183],["T_CONTINUE","continue",184],";",["T_WHITESPACE","\n                ",184],"}",["T_WHITESPACE","\n\n                ",185],["T_VARIABLE","$insertedStoreIds",187],"[","]",["T_WHITESPACE"," ",187],"=",["T_WHITESPACE"," ",187],["T_VARIABLE","$storeId",187],";",["T_WHITESPACE","\n                ",187],["T_VARIABLE","$storeInsert",188],["T_WHITESPACE"," ",188],"=",["T_WHITESPACE"," ",188],["T_ARRAY","array",188],"(",["T_WHITESPACE","\n                    ",188],["T_CONSTANT_ENCAPSED_STRING","'store_id'",189],["T_WHITESPACE"," ",189],["T_DOUBLE_ARROW","=>",189],["T_WHITESPACE"," ",189],["T_VARIABLE","$storeId",189],",",["T_WHITESPACE","\n                    ",189],["T_CONSTANT_ENCAPSED_STRING","'review_id'",190],["T_DOUBLE_ARROW","=>",190],["T_WHITESPACE"," ",190],["T_VARIABLE","$object",190],["T_OBJECT_OPERATOR","->",190],["T_STRING","getId",190],"(",")",["T_WHITESPACE","\n                ",190],")",";",["T_WHITESPACE","\n                ",191],["T_VARIABLE","$adapter",192],["T_OBJECT_OPERATOR","->",192],["T_STRING","insert",192],"(",["T_VARIABLE","$this",192],["T_OBJECT_OPERATOR","->",192],["T_STRING","_reviewStoreTable",192],",",["T_WHITESPACE"," ",192],["T_VARIABLE","$storeInsert",192],")",";",["T_WHITESPACE","\n            ",192],"}",["T_WHITESPACE","\n        ",193],"}",["T_WHITESPACE","\n\n        ",194],["T_COMMENT","\/\/ reaggregate ratings, that depend on this review\n",196],["T_WHITESPACE","        ",197],["T_VARIABLE","$this",197],["T_OBJECT_OPERATOR","->",197],["T_STRING","_aggregateRatings",197],"(",["T_WHITESPACE","\n            ",197],["T_VARIABLE","$this",198],["T_OBJECT_OPERATOR","->",198],["T_STRING","_loadVotedRatingIds",198],"(",["T_VARIABLE","$object",198],["T_OBJECT_OPERATOR","->",198],["T_STRING","getId",198],"(",")",")",",",["T_WHITESPACE","\n            ",198],["T_VARIABLE","$object",199],["T_OBJECT_OPERATOR","->",199],["T_STRING","getEntityPkValue",199],"(",")",["T_WHITESPACE","\n        ",199],")",";",["T_WHITESPACE","\n\n        ",200],["T_RETURN","return",202],["T_WHITESPACE"," ",202],["T_VARIABLE","$this",202],";",["T_WHITESPACE","\n    ",202],"}",["T_WHITESPACE","\n\n    ",203],["T_DOC_COMMENT","\/**\n     * Perform actions after object load\n     *\n     * @param Varien_Object $object\n     * @return Mage_Review_Model_Resource_Review\n     *\/",205],["T_WHITESPACE","\n    ",210],["T_PROTECTED","protected",211],["T_WHITESPACE"," ",211],["T_FUNCTION","function",211],["T_WHITESPACE"," ",211],["T_STRING","_afterLoad",211],"(",["T_STRING","Mage_Core_Model_Abstract",211],["T_WHITESPACE"," ",211],["T_VARIABLE","$object",211],")",["T_WHITESPACE","\n    ",211],"{",["T_WHITESPACE","\n        ",212],["T_VARIABLE","$adapter",213],["T_WHITESPACE"," ",213],"=",["T_WHITESPACE"," ",213],["T_VARIABLE","$this",213],["T_OBJECT_OPERATOR","->",213],["T_STRING","_getReadAdapter",213],"(",")",";",["T_WHITESPACE","\n        ",213],["T_VARIABLE","$select",214],["T_WHITESPACE"," ",214],"=",["T_WHITESPACE"," ",214],["T_VARIABLE","$adapter",214],["T_OBJECT_OPERATOR","->",214],["T_STRING","select",214],"(",")",["T_WHITESPACE","\n            ",214],["T_OBJECT_OPERATOR","->",215],["T_STRING","from",215],"(",["T_VARIABLE","$this",215],["T_OBJECT_OPERATOR","->",215],["T_STRING","_reviewStoreTable",215],",",["T_WHITESPACE"," ",215],["T_ARRAY","array",215],"(",["T_CONSTANT_ENCAPSED_STRING","'store_id'",215],")",")",["T_WHITESPACE","\n            ",215],["T_OBJECT_OPERATOR","->",216],["T_STRING","where",216],"(",["T_CONSTANT_ENCAPSED_STRING","'review_id = :review_id'",216],")",";",["T_WHITESPACE","\n        ",216],["T_VARIABLE","$stores",217],["T_WHITESPACE"," ",217],"=",["T_WHITESPACE"," ",217],["T_VARIABLE","$adapter",217],["T_OBJECT_OPERATOR","->",217],["T_STRING","fetchCol",217],"(",["T_VARIABLE","$select",217],",",["T_WHITESPACE"," ",217],["T_ARRAY","array",217],"(",["T_CONSTANT_ENCAPSED_STRING","':review_id'",217],["T_WHITESPACE"," ",217],["T_DOUBLE_ARROW","=>",217],["T_WHITESPACE"," ",217],["T_VARIABLE","$object",217],["T_OBJECT_OPERATOR","->",217],["T_STRING","getId",217],"(",")",")",")",";",["T_WHITESPACE","\n        ",217],["T_IF","if",218],["T_WHITESPACE"," ",218],"(",["T_EMPTY","empty",218],"(",["T_VARIABLE","$stores",218],")",["T_WHITESPACE"," ",218],["T_BOOLEAN_AND","&&",218],["T_WHITESPACE"," ",218],["T_STRING","Mage",218],["T_DOUBLE_COLON","::",218],["T_STRING","app",218],"(",")",["T_OBJECT_OPERATOR","->",218],["T_STRING","isSingleStoreMode",218],"(",")",")",["T_WHITESPACE"," ",218],"{",["T_WHITESPACE","\n            ",218],["T_VARIABLE","$object",219],["T_OBJECT_OPERATOR","->",219],["T_STRING","setStores",219],"(",["T_ARRAY","array",219],"(",["T_STRING","Mage",219],["T_DOUBLE_COLON","::",219],["T_STRING","app",219],"(",")",["T_OBJECT_OPERATOR","->",219],["T_STRING","getStore",219],"(",["T_STRING","true",219],")",["T_OBJECT_OPERATOR","->",219],["T_STRING","getId",219],"(",")",")",")",";",["T_WHITESPACE","\n        ",219],"}",["T_WHITESPACE"," ",220],["T_ELSE","else",220],["T_WHITESPACE"," ",220],"{",["T_WHITESPACE","\n            ",220],["T_VARIABLE","$object",221],["T_OBJECT_OPERATOR","->",221],["T_STRING","setStores",221],"(",["T_VARIABLE","$stores",221],")",";",["T_WHITESPACE","\n        ",221],"}",["T_WHITESPACE","\n        ",222],["T_RETURN","return",223],["T_WHITESPACE"," ",223],["T_VARIABLE","$this",223],";",["T_WHITESPACE","\n    ",223],"}",["T_WHITESPACE","\n\n    ",224],["T_DOC_COMMENT","\/**\n     * Action before delete\n     *\n     * @param Mage_Core_Model_Abstract $object\n     * @return Mage_Review_Model_Resource_Review\n     *\/",226],["T_WHITESPACE","\n    ",231],["T_PROTECTED","protected",232],["T_WHITESPACE"," ",232],["T_FUNCTION","function",232],["T_WHITESPACE"," ",232],["T_STRING","_beforeDelete",232],"(",["T_STRING","Mage_Core_Model_Abstract",232],["T_WHITESPACE"," ",232],["T_VARIABLE","$object",232],")",["T_WHITESPACE","\n    ",232],"{",["T_WHITESPACE","\n        ",233],["T_COMMENT","\/\/ prepare rating ids, that depend on review\n",234],["T_WHITESPACE","        ",235],["T_VARIABLE","$this",235],["T_OBJECT_OPERATOR","->",235],["T_STRING","_deleteCache",235],["T_WHITESPACE"," ",235],"=",["T_WHITESPACE"," ",235],["T_ARRAY","array",235],"(",["T_WHITESPACE","\n            ",235],["T_CONSTANT_ENCAPSED_STRING","'ratingIds'",236],["T_WHITESPACE","     ",236],["T_DOUBLE_ARROW","=>",236],["T_WHITESPACE"," ",236],["T_VARIABLE","$this",236],["T_OBJECT_OPERATOR","->",236],["T_STRING","_loadVotedRatingIds",236],"(",["T_VARIABLE","$object",236],["T_OBJECT_OPERATOR","->",236],["T_STRING","getId",236],"(",")",")",",",["T_WHITESPACE","\n            ",236],["T_CONSTANT_ENCAPSED_STRING","'entityPkValue'",237],["T_WHITESPACE"," ",237],["T_DOUBLE_ARROW","=>",237],["T_WHITESPACE"," ",237],["T_VARIABLE","$object",237],["T_OBJECT_OPERATOR","->",237],["T_STRING","getEntityPkValue",237],"(",")",["T_WHITESPACE","\n        ",237],")",";",["T_WHITESPACE","\n        ",238],["T_RETURN","return",239],["T_WHITESPACE"," ",239],["T_VARIABLE","$this",239],";",["T_WHITESPACE","\n    ",239],"}",["T_WHITESPACE","\n\n    ",240],["T_DOC_COMMENT","\/**\n     * Perform actions after object delete\n     *\n     * @param Mage_Core_Model_Abstract $object\n     * @return Mage_Review_Model_Resource_Review\n     *\/",242],["T_WHITESPACE","\n    ",247],["T_PUBLIC","public",248],["T_WHITESPACE"," ",248],["T_FUNCTION","function",248],["T_WHITESPACE"," ",248],["T_STRING","afterDeleteCommit",248],"(",["T_STRING","Mage_Core_Model_Abstract",248],["T_WHITESPACE"," ",248],["T_VARIABLE","$object",248],")",["T_WHITESPACE","\n    ",248],"{",["T_WHITESPACE","\n        ",249],["T_VARIABLE","$this",250],["T_OBJECT_OPERATOR","->",250],["T_STRING","aggregate",250],"(",["T_VARIABLE","$object",250],")",";",["T_WHITESPACE","\n\n        ",250],["T_COMMENT","\/\/ reaggregate ratings, that depended on this review\n",252],["T_WHITESPACE","        ",253],["T_VARIABLE","$this",253],["T_OBJECT_OPERATOR","->",253],["T_STRING","_aggregateRatings",253],"(",["T_WHITESPACE","\n            ",253],["T_VARIABLE","$this",254],["T_OBJECT_OPERATOR","->",254],["T_STRING","_deleteCache",254],"[",["T_CONSTANT_ENCAPSED_STRING","'ratingIds'",254],"]",",",["T_WHITESPACE","\n            ",254],["T_VARIABLE","$this",255],["T_OBJECT_OPERATOR","->",255],["T_STRING","_deleteCache",255],"[",["T_CONSTANT_ENCAPSED_STRING","'entityPkValue'",255],"]",["T_WHITESPACE","\n        ",255],")",";",["T_WHITESPACE","\n        ",256],["T_VARIABLE","$this",257],["T_OBJECT_OPERATOR","->",257],["T_STRING","_deleteCache",257],["T_WHITESPACE"," ",257],"=",["T_WHITESPACE"," ",257],["T_ARRAY","array",257],"(",")",";",["T_WHITESPACE","\n\n        ",257],["T_RETURN","return",259],["T_WHITESPACE"," ",259],["T_VARIABLE","$this",259],";",["T_WHITESPACE","\n    ",259],"}",["T_WHITESPACE","\n\n    ",260],["T_DOC_COMMENT","\/**\n     * Retrieves total reviews\n     *\n     * @param int $entityPkValue\n     * @param bool $approvedOnly\n     * @param int $storeId\n     * @return int\n     *\/",262],["T_WHITESPACE","\n    ",269],["T_PUBLIC","public",270],["T_WHITESPACE"," ",270],["T_FUNCTION","function",270],["T_WHITESPACE"," ",270],["T_STRING","getTotalReviews",270],"(",["T_VARIABLE","$entityPkValue",270],",",["T_WHITESPACE"," ",270],["T_VARIABLE","$approvedOnly",270],["T_WHITESPACE"," ",270],"=",["T_WHITESPACE"," ",270],["T_STRING","false",270],",",["T_WHITESPACE"," ",270],["T_VARIABLE","$storeId",270],["T_WHITESPACE"," ",270],"=",["T_WHITESPACE"," ",270],["T_LNUMBER","0",270],")",["T_WHITESPACE","\n    ",270],"{",["T_WHITESPACE","\n        ",271],["T_VARIABLE","$adapter",272],["T_WHITESPACE"," ",272],"=",["T_WHITESPACE"," ",272],["T_VARIABLE","$this",272],["T_OBJECT_OPERATOR","->",272],["T_STRING","_getReadAdapter",272],"(",")",";",["T_WHITESPACE","\n        ",272],["T_VARIABLE","$select",273],["T_WHITESPACE"," ",273],"=",["T_WHITESPACE"," ",273],["T_VARIABLE","$adapter",273],["T_OBJECT_OPERATOR","->",273],["T_STRING","select",273],"(",")",["T_WHITESPACE","\n            ",273],["T_OBJECT_OPERATOR","->",274],["T_STRING","from",274],"(",["T_VARIABLE","$this",274],["T_OBJECT_OPERATOR","->",274],["T_STRING","_reviewTable",274],",",["T_WHITESPACE","\n                ",274],["T_ARRAY","array",275],"(",["T_WHITESPACE","\n                    ",275],["T_CONSTANT_ENCAPSED_STRING","'review_count'",276],["T_WHITESPACE"," ",276],["T_DOUBLE_ARROW","=>",276],["T_WHITESPACE"," ",276],["T_NEW","new",276],["T_WHITESPACE"," ",276],["T_STRING","Zend_Db_Expr",276],"(",["T_CONSTANT_ENCAPSED_STRING","'COUNT(*)'",276],")",["T_WHITESPACE","\n                ",276],")",")",["T_WHITESPACE","\n            ",277],["T_OBJECT_OPERATOR","->",278],["T_STRING","where",278],"(","\"",["T_CURLY_OPEN","{",278],["T_VARIABLE","$this",278],["T_OBJECT_OPERATOR","->",278],["T_STRING","_reviewTable",278],"}",["T_ENCAPSED_AND_WHITESPACE",".entity_pk_value = :pk_value",278],"\"",")",";",["T_WHITESPACE","\n        ",278],["T_VARIABLE","$bind",279],["T_WHITESPACE"," ",279],"=",["T_WHITESPACE"," ",279],["T_ARRAY","array",279],"(",["T_CONSTANT_ENCAPSED_STRING","':pk_value'",279],["T_WHITESPACE"," ",279],["T_DOUBLE_ARROW","=>",279],["T_WHITESPACE"," ",279],["T_VARIABLE","$entityPkValue",279],")",";",["T_WHITESPACE","\n        ",279],["T_IF","if",280],["T_WHITESPACE"," ",280],"(",["T_VARIABLE","$storeId",280],["T_WHITESPACE"," ",280],">",["T_WHITESPACE"," ",280],["T_LNUMBER","0",280],")",["T_WHITESPACE"," ",280],"{",["T_WHITESPACE","\n            ",280],["T_VARIABLE","$select",281],["T_OBJECT_OPERATOR","->",281],["T_STRING","join",281],"(",["T_ARRAY","array",281],"(",["T_CONSTANT_ENCAPSED_STRING","'store'",281],["T_DOUBLE_ARROW","=>",281],["T_VARIABLE","$this",281],["T_OBJECT_OPERATOR","->",281],["T_STRING","_reviewStoreTable",281],")",",",["T_WHITESPACE","\n                ",281],["T_VARIABLE","$this",282],["T_OBJECT_OPERATOR","->",282],["T_STRING","_reviewTable",282],".",["T_CONSTANT_ENCAPSED_STRING","'.review_id=store.review_id AND store.store_id = :store_id'",282],",",["T_WHITESPACE","\n                ",282],["T_ARRAY","array",283],"(",")",")",";",["T_WHITESPACE","\n            ",283],["T_VARIABLE","$bind",284],"[",["T_CONSTANT_ENCAPSED_STRING","':store_id'",284],"]",["T_WHITESPACE"," ",284],"=",["T_WHITESPACE"," ",284],["T_INT_CAST","(int)",284],["T_VARIABLE","$storeId",284],";",["T_WHITESPACE","\n        ",284],"}",["T_WHITESPACE","\n        ",285],["T_IF","if",286],["T_WHITESPACE"," ",286],"(",["T_VARIABLE","$approvedOnly",286],")",["T_WHITESPACE"," ",286],"{",["T_WHITESPACE","\n            ",286],["T_VARIABLE","$select",287],["T_OBJECT_OPERATOR","->",287],["T_STRING","where",287],"(","\"",["T_CURLY_OPEN","{",287],["T_VARIABLE","$this",287],["T_OBJECT_OPERATOR","->",287],["T_STRING","_reviewTable",287],"}",["T_ENCAPSED_AND_WHITESPACE",".status_id = :status_id",287],"\"",")",";",["T_WHITESPACE","\n            ",287],["T_VARIABLE","$bind",288],"[",["T_CONSTANT_ENCAPSED_STRING","':status_id'",288],"]",["T_WHITESPACE"," ",288],"=",["T_WHITESPACE"," ",288],["T_STRING","Mage_Review_Model_Review",288],["T_DOUBLE_COLON","::",288],["T_STRING","STATUS_APPROVED",288],";",["T_WHITESPACE","\n        ",288],"}",["T_WHITESPACE","\n        ",289],["T_RETURN","return",290],["T_WHITESPACE"," ",290],["T_VARIABLE","$adapter",290],["T_OBJECT_OPERATOR","->",290],["T_STRING","fetchOne",290],"(",["T_VARIABLE","$select",290],",",["T_WHITESPACE"," ",290],["T_VARIABLE","$bind",290],")",";",["T_WHITESPACE","\n    ",290],"}",["T_WHITESPACE","\n\n    ",291],["T_DOC_COMMENT","\/**\n     * Aggregate\n     *\n     * @param Mage_Core_Model_Abstract $object\n     *\/",293],["T_WHITESPACE","\n    ",297],["T_PUBLIC","public",298],["T_WHITESPACE"," ",298],["T_FUNCTION","function",298],["T_WHITESPACE"," ",298],["T_STRING","aggregate",298],"(",["T_VARIABLE","$object",298],")",["T_WHITESPACE","\n    ",298],"{",["T_WHITESPACE","\n        ",299],["T_VARIABLE","$readAdapter",300],["T_WHITESPACE","    ",300],"=",["T_WHITESPACE"," ",300],["T_VARIABLE","$this",300],["T_OBJECT_OPERATOR","->",300],["T_STRING","_getReadAdapter",300],"(",")",";",["T_WHITESPACE","\n        ",300],["T_VARIABLE","$writeAdapter",301],["T_WHITESPACE","   ",301],"=",["T_WHITESPACE"," ",301],["T_VARIABLE","$this",301],["T_OBJECT_OPERATOR","->",301],["T_STRING","_getWriteAdapter",301],"(",")",";",["T_WHITESPACE","\n        ",301],["T_IF","if",302],["T_WHITESPACE"," ",302],"(","!",["T_VARIABLE","$object",302],["T_OBJECT_OPERATOR","->",302],["T_STRING","getEntityPkValue",302],"(",")",["T_WHITESPACE"," ",302],["T_BOOLEAN_AND","&&",302],["T_WHITESPACE"," ",302],["T_VARIABLE","$object",302],["T_OBJECT_OPERATOR","->",302],["T_STRING","getId",302],"(",")",")",["T_WHITESPACE"," ",302],"{",["T_WHITESPACE","\n            ",302],["T_VARIABLE","$object",303],["T_OBJECT_OPERATOR","->",303],["T_STRING","load",303],"(",["T_VARIABLE","$object",303],["T_OBJECT_OPERATOR","->",303],["T_STRING","getReviewId",303],"(",")",")",";",["T_WHITESPACE","\n        ",303],"}",["T_WHITESPACE","\n\n        ",304],["T_VARIABLE","$ratingModel",306],["T_WHITESPACE","    ",306],"=",["T_WHITESPACE"," ",306],["T_STRING","Mage",306],["T_DOUBLE_COLON","::",306],["T_STRING","getModel",306],"(",["T_CONSTANT_ENCAPSED_STRING","'rating\/rating'",306],")",";",["T_WHITESPACE","\n        ",306],["T_VARIABLE","$ratingSummaries",307],"=",["T_WHITESPACE"," ",307],["T_VARIABLE","$ratingModel",307],["T_OBJECT_OPERATOR","->",307],["T_STRING","getEntitySummary",307],"(",["T_VARIABLE","$object",307],["T_OBJECT_OPERATOR","->",307],["T_STRING","getEntityPkValue",307],"(",")",",",["T_WHITESPACE"," ",307],["T_STRING","false",307],")",";",["T_WHITESPACE","\n\n        ",307],["T_FOREACH","foreach",309],["T_WHITESPACE"," ",309],"(",["T_VARIABLE","$ratingSummaries",309],["T_WHITESPACE"," ",309],["T_AS","as",309],["T_WHITESPACE"," ",309],["T_VARIABLE","$ratingSummaryObject",309],")",["T_WHITESPACE"," ",309],"{",["T_WHITESPACE","\n            ",309],["T_IF","if",310],["T_WHITESPACE"," ",310],"(",["T_VARIABLE","$ratingSummaryObject",310],["T_OBJECT_OPERATOR","->",310],["T_STRING","getCount",310],"(",")",")",["T_WHITESPACE"," ",310],"{",["T_WHITESPACE","\n                ",310],["T_VARIABLE","$ratingSummary",311],["T_WHITESPACE"," ",311],"=",["T_WHITESPACE"," ",311],["T_STRING","round",311],"(",["T_VARIABLE","$ratingSummaryObject",311],["T_OBJECT_OPERATOR","->",311],["T_STRING","getSum",311],"(",")",["T_WHITESPACE"," ",311],"\/",["T_WHITESPACE"," ",311],["T_VARIABLE","$ratingSummaryObject",311],["T_OBJECT_OPERATOR","->",311],["T_STRING","getCount",311],"(",")",")",";",["T_WHITESPACE","\n            ",311],"}",["T_WHITESPACE"," ",312],["T_ELSE","else",312],["T_WHITESPACE"," ",312],"{",["T_WHITESPACE","\n                ",312],["T_VARIABLE","$ratingSummary",313],["T_WHITESPACE"," ",313],"=",["T_WHITESPACE"," ",313],["T_VARIABLE","$ratingSummaryObject",313],["T_OBJECT_OPERATOR","->",313],["T_STRING","getSum",313],"(",")",";",["T_WHITESPACE","\n            ",313],"}",["T_WHITESPACE","\n\n            ",314],["T_VARIABLE","$reviewsCount",316],["T_WHITESPACE"," ",316],"=",["T_WHITESPACE"," ",316],["T_VARIABLE","$this",316],["T_OBJECT_OPERATOR","->",316],["T_STRING","getTotalReviews",316],"(",["T_WHITESPACE","\n                ",316],["T_VARIABLE","$object",317],["T_OBJECT_OPERATOR","->",317],["T_STRING","getEntityPkValue",317],"(",")",",",["T_WHITESPACE","\n                ",317],["T_STRING","true",318],",",["T_WHITESPACE","\n                ",318],["T_VARIABLE","$ratingSummaryObject",319],["T_OBJECT_OPERATOR","->",319],["T_STRING","getStoreId",319],"(",")",["T_WHITESPACE","\n            ",319],")",";",["T_WHITESPACE","\n            ",320],["T_VARIABLE","$select",321],["T_WHITESPACE"," ",321],"=",["T_WHITESPACE"," ",321],["T_VARIABLE","$readAdapter",321],["T_OBJECT_OPERATOR","->",321],["T_STRING","select",321],"(",")",["T_WHITESPACE","\n                ",321],["T_OBJECT_OPERATOR","->",322],["T_STRING","from",322],"(",["T_VARIABLE","$this",322],["T_OBJECT_OPERATOR","->",322],["T_STRING","_aggregateTable",322],")",["T_WHITESPACE","\n                ",322],["T_OBJECT_OPERATOR","->",323],["T_STRING","where",323],"(",["T_CONSTANT_ENCAPSED_STRING","'entity_pk_value = :pk_value'",323],")",["T_WHITESPACE","\n                ",323],["T_OBJECT_OPERATOR","->",324],["T_STRING","where",324],"(",["T_CONSTANT_ENCAPSED_STRING","'entity_type = :entity_type'",324],")",["T_WHITESPACE","\n                ",324],["T_OBJECT_OPERATOR","->",325],["T_STRING","where",325],"(",["T_CONSTANT_ENCAPSED_STRING","'store_id = :store_id'",325],")",";",["T_WHITESPACE","\n            ",325],["T_VARIABLE","$bind",326],["T_WHITESPACE"," ",326],"=",["T_WHITESPACE"," ",326],["T_ARRAY","array",326],"(",["T_WHITESPACE","\n                ",326],["T_CONSTANT_ENCAPSED_STRING","':pk_value'",327],["T_WHITESPACE","    ",327],["T_DOUBLE_ARROW","=>",327],["T_WHITESPACE"," ",327],["T_VARIABLE","$object",327],["T_OBJECT_OPERATOR","->",327],["T_STRING","getEntityPkValue",327],"(",")",",",["T_WHITESPACE","\n                ",327],["T_CONSTANT_ENCAPSED_STRING","':entity_type'",328],["T_WHITESPACE"," ",328],["T_DOUBLE_ARROW","=>",328],["T_WHITESPACE"," ",328],["T_VARIABLE","$object",328],["T_OBJECT_OPERATOR","->",328],["T_STRING","getEntityId",328],"(",")",",",["T_WHITESPACE","\n                ",328],["T_CONSTANT_ENCAPSED_STRING","':store_id'",329],["T_WHITESPACE","    ",329],["T_DOUBLE_ARROW","=>",329],["T_VARIABLE","$ratingSummaryObject",329],["T_OBJECT_OPERATOR","->",329],["T_STRING","getStoreId",329],"(",")",["T_WHITESPACE","\n            ",329],")",";",["T_WHITESPACE","\n            ",330],["T_VARIABLE","$oldData",331],["T_WHITESPACE"," ",331],"=",["T_WHITESPACE"," ",331],["T_VARIABLE","$readAdapter",331],["T_OBJECT_OPERATOR","->",331],["T_STRING","fetchRow",331],"(",["T_VARIABLE","$select",331],",",["T_WHITESPACE"," ",331],["T_VARIABLE","$bind",331],")",";",["T_WHITESPACE","\n\n            ",331],["T_VARIABLE","$data",333],["T_WHITESPACE"," ",333],"=",["T_WHITESPACE"," ",333],["T_NEW","new",333],["T_WHITESPACE"," ",333],["T_STRING","Varien_Object",333],"(",")",";",["T_WHITESPACE","\n\n            ",333],["T_VARIABLE","$data",335],["T_OBJECT_OPERATOR","->",335],["T_STRING","setReviewsCount",335],"(",["T_VARIABLE","$reviewsCount",335],")",["T_WHITESPACE","\n                ",335],["T_OBJECT_OPERATOR","->",336],["T_STRING","setEntityPkValue",336],"(",["T_VARIABLE","$object",336],["T_OBJECT_OPERATOR","->",336],["T_STRING","getEntityPkValue",336],"(",")",")",["T_WHITESPACE","\n                ",336],["T_OBJECT_OPERATOR","->",337],["T_STRING","setEntityType",337],"(",["T_VARIABLE","$object",337],["T_OBJECT_OPERATOR","->",337],["T_STRING","getEntityId",337],"(",")",")",["T_WHITESPACE","\n                ",337],["T_OBJECT_OPERATOR","->",338],["T_STRING","setRatingSummary",338],"(","(",["T_VARIABLE","$ratingSummary",338],["T_WHITESPACE"," ",338],">",["T_WHITESPACE"," ",338],["T_LNUMBER","0",338],")",["T_WHITESPACE"," ",338],"?",["T_WHITESPACE"," ",338],["T_VARIABLE","$ratingSummary",338],["T_WHITESPACE"," ",338],":",["T_WHITESPACE"," ",338],["T_LNUMBER","0",338],")",["T_WHITESPACE","\n                ",338],["T_OBJECT_OPERATOR","->",339],["T_STRING","setStoreId",339],"(",["T_VARIABLE","$ratingSummaryObject",339],["T_OBJECT_OPERATOR","->",339],["T_STRING","getStoreId",339],"(",")",")",";",["T_WHITESPACE","\n\n           ",339],["T_VARIABLE","$writeAdapter",341],["T_OBJECT_OPERATOR","->",341],["T_STRING","beginTransaction",341],"(",")",";",["T_WHITESPACE","\n            ",341],["T_TRY","try",342],["T_WHITESPACE"," ",342],"{",["T_WHITESPACE","\n                ",342],["T_IF","if",343],["T_WHITESPACE"," ",343],"(",["T_VARIABLE","$oldData",343],"[",["T_CONSTANT_ENCAPSED_STRING","'primary_id'",343],"]",["T_WHITESPACE"," ",343],">",["T_WHITESPACE"," ",343],["T_LNUMBER","0",343],")",["T_WHITESPACE"," ",343],"{",["T_WHITESPACE","\n                    ",343],["T_VARIABLE","$condition",344],["T_WHITESPACE"," ",344],"=",["T_WHITESPACE"," ",344],["T_ARRAY","array",344],"(","\"",["T_CURLY_OPEN","{",344],["T_VARIABLE","$this",344],["T_OBJECT_OPERATOR","->",344],["T_STRING","_aggregateTable",344],"}",["T_ENCAPSED_AND_WHITESPACE",".primary_id = ?",344],"\"",["T_WHITESPACE"," ",344],["T_DOUBLE_ARROW","=>",344],["T_WHITESPACE"," ",344],["T_VARIABLE","$oldData",344],"[",["T_CONSTANT_ENCAPSED_STRING","'primary_id'",344],"]",")",";",["T_WHITESPACE","\n                    ",344],["T_VARIABLE","$writeAdapter",345],["T_OBJECT_OPERATOR","->",345],["T_STRING","update",345],"(",["T_VARIABLE","$this",345],["T_OBJECT_OPERATOR","->",345],["T_STRING","_aggregateTable",345],",",["T_WHITESPACE"," ",345],["T_VARIABLE","$data",345],["T_OBJECT_OPERATOR","->",345],["T_STRING","getData",345],"(",")",",",["T_WHITESPACE"," ",345],["T_VARIABLE","$condition",345],")",";",["T_WHITESPACE","\n                ",345],"}",["T_WHITESPACE"," ",346],["T_ELSE","else",346],["T_WHITESPACE"," ",346],"{",["T_WHITESPACE","\n                    ",346],["T_VARIABLE","$writeAdapter",347],["T_OBJECT_OPERATOR","->",347],["T_STRING","insert",347],"(",["T_VARIABLE","$this",347],["T_OBJECT_OPERATOR","->",347],["T_STRING","_aggregateTable",347],",",["T_WHITESPACE"," ",347],["T_VARIABLE","$data",347],["T_OBJECT_OPERATOR","->",347],["T_STRING","getData",347],"(",")",")",";",["T_WHITESPACE","\n                ",347],"}",["T_WHITESPACE","\n                ",348],["T_VARIABLE","$writeAdapter",349],["T_OBJECT_OPERATOR","->",349],["T_STRING","commit",349],"(",")",";",["T_WHITESPACE","\n            ",349],"}",["T_WHITESPACE"," ",350],["T_CATCH","catch",350],["T_WHITESPACE"," ",350],"(",["T_STRING","Exception",350],["T_WHITESPACE"," ",350],["T_VARIABLE","$e",350],")",["T_WHITESPACE"," ",350],"{",["T_WHITESPACE","\n                ",350],["T_VARIABLE","$writeAdapter",351],["T_OBJECT_OPERATOR","->",351],["T_STRING","rollBack",351],"(",")",";",["T_WHITESPACE","\n            ",351],"}",["T_WHITESPACE","\n        ",352],"}",["T_WHITESPACE","\n    ",353],"}",["T_WHITESPACE","\n\n    ",354],["T_DOC_COMMENT","\/**\n     * Get rating IDs from review votes\n     *\n     * @param int $reviewId\n     * @return array\n     *\/",356],["T_WHITESPACE","\n    ",361],["T_PROTECTED","protected",362],["T_WHITESPACE"," ",362],["T_FUNCTION","function",362],["T_WHITESPACE"," ",362],["T_STRING","_loadVotedRatingIds",362],"(",["T_VARIABLE","$reviewId",362],")",["T_WHITESPACE","\n    ",362],"{",["T_WHITESPACE","\n        ",363],["T_VARIABLE","$adapter",364],["T_WHITESPACE"," ",364],"=",["T_WHITESPACE"," ",364],["T_VARIABLE","$this",364],["T_OBJECT_OPERATOR","->",364],["T_STRING","_getReadAdapter",364],"(",")",";",["T_WHITESPACE","\n        ",364],["T_IF","if",365],["T_WHITESPACE"," ",365],"(",["T_EMPTY","empty",365],"(",["T_VARIABLE","$reviewId",365],")",")",["T_WHITESPACE"," ",365],"{",["T_WHITESPACE","\n            ",365],["T_RETURN","return",366],["T_WHITESPACE"," ",366],["T_ARRAY","array",366],"(",")",";",["T_WHITESPACE","\n        ",366],"}",["T_WHITESPACE","\n        ",367],["T_VARIABLE","$select",368],["T_WHITESPACE"," ",368],"=",["T_WHITESPACE"," ",368],["T_VARIABLE","$adapter",368],["T_OBJECT_OPERATOR","->",368],["T_STRING","select",368],"(",")",["T_WHITESPACE","\n            ",368],["T_OBJECT_OPERATOR","->",369],["T_STRING","from",369],"(",["T_ARRAY","array",369],"(",["T_CONSTANT_ENCAPSED_STRING","'v'",369],["T_WHITESPACE"," ",369],["T_DOUBLE_ARROW","=>",369],["T_WHITESPACE"," ",369],["T_VARIABLE","$this",369],["T_OBJECT_OPERATOR","->",369],["T_STRING","getTable",369],"(",["T_CONSTANT_ENCAPSED_STRING","'rating\/rating_option_vote'",369],")",")",",",["T_WHITESPACE"," ",369],["T_CONSTANT_ENCAPSED_STRING","'r.rating_id'",369],")",["T_WHITESPACE","\n            ",369],["T_OBJECT_OPERATOR","->",370],["T_STRING","joinInner",370],"(",["T_ARRAY","array",370],"(",["T_CONSTANT_ENCAPSED_STRING","'r'",370],["T_WHITESPACE"," ",370],["T_DOUBLE_ARROW","=>",370],["T_WHITESPACE"," ",370],["T_VARIABLE","$this",370],["T_OBJECT_OPERATOR","->",370],["T_STRING","getTable",370],"(",["T_CONSTANT_ENCAPSED_STRING","'rating\/rating'",370],")",")",",",["T_WHITESPACE"," ",370],["T_CONSTANT_ENCAPSED_STRING","'v.rating_id=r.rating_id'",370],")",["T_WHITESPACE","\n            ",370],["T_OBJECT_OPERATOR","->",371],["T_STRING","where",371],"(",["T_CONSTANT_ENCAPSED_STRING","'v.review_id = :revire_id'",371],")",";",["T_WHITESPACE","\n        ",371],["T_RETURN","return",372],["T_WHITESPACE"," ",372],["T_VARIABLE","$adapter",372],["T_OBJECT_OPERATOR","->",372],["T_STRING","fetchCol",372],"(",["T_VARIABLE","$select",372],",",["T_WHITESPACE"," ",372],["T_ARRAY","array",372],"(",["T_CONSTANT_ENCAPSED_STRING","':revire_id'",372],["T_WHITESPACE"," ",372],["T_DOUBLE_ARROW","=>",372],["T_WHITESPACE"," ",372],["T_VARIABLE","$reviewId",372],")",")",";",["T_WHITESPACE","\n    ",372],"}",["T_WHITESPACE","\n\n    ",373],["T_DOC_COMMENT","\/**\n     * Aggregate this review's ratings.\n     * Useful, when changing the review.\n     *\n     * @param array $ratingIds\n     * @param int $entityPkValue\n     * @return Mage_Review_Model_Resource_Review\n     *\/",375],["T_WHITESPACE","\n    ",382],["T_PROTECTED","protected",383],["T_WHITESPACE"," ",383],["T_FUNCTION","function",383],["T_WHITESPACE"," ",383],["T_STRING","_aggregateRatings",383],"(",["T_VARIABLE","$ratingIds",383],",",["T_WHITESPACE"," ",383],["T_VARIABLE","$entityPkValue",383],")",["T_WHITESPACE","\n    ",383],"{",["T_WHITESPACE","\n        ",384],["T_IF","if",385],["T_WHITESPACE"," ",385],"(",["T_VARIABLE","$ratingIds",385],["T_WHITESPACE"," ",385],["T_BOOLEAN_AND","&&",385],["T_WHITESPACE"," ",385],"!",["T_STRING","is_array",385],"(",["T_VARIABLE","$ratingIds",385],")",")",["T_WHITESPACE"," ",385],"{",["T_WHITESPACE","\n            ",385],["T_VARIABLE","$ratingIds",386],["T_WHITESPACE"," ",386],"=",["T_WHITESPACE"," ",386],["T_ARRAY","array",386],"(",["T_INT_CAST","(int)",386],["T_VARIABLE","$ratingIds",386],")",";",["T_WHITESPACE","\n        ",386],"}",["T_WHITESPACE","\n        ",387],["T_IF","if",388],["T_WHITESPACE"," ",388],"(",["T_VARIABLE","$ratingIds",388],["T_WHITESPACE"," ",388],["T_BOOLEAN_AND","&&",388],["T_WHITESPACE"," ",388],["T_VARIABLE","$entityPkValue",388],["T_WHITESPACE","\n            ",388],["T_BOOLEAN_AND","&&",389],["T_WHITESPACE"," ",389],"(",["T_VARIABLE","$resource",389],["T_WHITESPACE"," ",389],"=",["T_WHITESPACE"," ",389],["T_STRING","Mage",389],["T_DOUBLE_COLON","::",389],["T_STRING","getResourceSingleton",389],"(",["T_CONSTANT_ENCAPSED_STRING","'rating\/rating_option'",389],")",")",["T_WHITESPACE","\n            ",389],")",["T_WHITESPACE"," ",390],"{",["T_WHITESPACE","\n            ",390],["T_FOREACH","foreach",391],["T_WHITESPACE"," ",391],"(",["T_VARIABLE","$ratingIds",391],["T_WHITESPACE"," ",391],["T_AS","as",391],["T_WHITESPACE"," ",391],["T_VARIABLE","$ratingId",391],")",["T_WHITESPACE"," ",391],"{",["T_WHITESPACE","\n                ",391],["T_VARIABLE","$resource",392],["T_OBJECT_OPERATOR","->",392],["T_STRING","aggregateEntityByRatingId",392],"(",["T_WHITESPACE","\n                    ",392],["T_VARIABLE","$ratingId",393],",",["T_WHITESPACE"," ",393],["T_VARIABLE","$entityPkValue",393],["T_WHITESPACE","\n                ",393],")",";",["T_WHITESPACE","\n            ",394],"}",["T_WHITESPACE","\n        ",395],"}",["T_WHITESPACE","\n        ",396],["T_RETURN","return",397],["T_WHITESPACE"," ",397],["T_VARIABLE","$this",397],";",["T_WHITESPACE","\n    ",397],"}",["T_WHITESPACE","\n\n    ",398],["T_DOC_COMMENT","\/**\n     * Reaggregate this review's ratings.\n     *\n     * @param int $reviewId\n     * @param int $entityPkValue\n     *\/",400],["T_WHITESPACE","\n    ",405],["T_PUBLIC","public",406],["T_WHITESPACE"," ",406],["T_FUNCTION","function",406],["T_WHITESPACE"," ",406],["T_STRING","reAggregateReview",406],"(",["T_VARIABLE","$reviewId",406],",",["T_WHITESPACE"," ",406],["T_VARIABLE","$entityPkValue",406],")",["T_WHITESPACE","\n    ",406],"{",["T_WHITESPACE","\n        ",407],["T_VARIABLE","$this",408],["T_OBJECT_OPERATOR","->",408],["T_STRING","_aggregateRatings",408],"(",["T_VARIABLE","$this",408],["T_OBJECT_OPERATOR","->",408],["T_STRING","_loadVotedRatingIds",408],"(",["T_VARIABLE","$reviewId",408],")",",",["T_WHITESPACE"," ",408],["T_VARIABLE","$entityPkValue",408],")",";",["T_WHITESPACE","\n    ",408],"}",["T_WHITESPACE","\n\n    ",409],["T_DOC_COMMENT","\/**\n     * Get review entity type id by code\n     *\n     * @param string $entityCode\n     * @return int|bool\n     *\/",411],["T_WHITESPACE","\n    ",416],["T_PUBLIC","public",417],["T_WHITESPACE"," ",417],["T_FUNCTION","function",417],["T_WHITESPACE"," ",417],["T_STRING","getEntityIdByCode",417],"(",["T_VARIABLE","$entityCode",417],")",["T_WHITESPACE","\n    ",417],"{",["T_WHITESPACE","\n        ",418],["T_VARIABLE","$adapter",419],["T_WHITESPACE"," ",419],"=",["T_WHITESPACE"," ",419],["T_VARIABLE","$this",419],["T_OBJECT_OPERATOR","->",419],["T_STRING","_getReadAdapter",419],"(",")",";",["T_WHITESPACE","\n        ",419],["T_VARIABLE","$select",420],["T_WHITESPACE"," ",420],"=",["T_WHITESPACE"," ",420],["T_VARIABLE","$adapter",420],["T_OBJECT_OPERATOR","->",420],["T_STRING","select",420],"(",")",["T_WHITESPACE","\n            ",420],["T_OBJECT_OPERATOR","->",421],["T_STRING","from",421],"(",["T_VARIABLE","$this",421],["T_OBJECT_OPERATOR","->",421],["T_STRING","_reviewEntityTable",421],",",["T_WHITESPACE"," ",421],["T_ARRAY","array",421],"(",["T_CONSTANT_ENCAPSED_STRING","'entity_id'",421],")",")",["T_WHITESPACE","\n            ",421],["T_OBJECT_OPERATOR","->",422],["T_STRING","where",422],"(",["T_CONSTANT_ENCAPSED_STRING","'entity_code = :entity_code'",422],")",";",["T_WHITESPACE","\n        ",422],["T_RETURN","return",423],["T_WHITESPACE"," ",423],["T_VARIABLE","$adapter",423],["T_OBJECT_OPERATOR","->",423],["T_STRING","fetchOne",423],"(",["T_VARIABLE","$select",423],",",["T_WHITESPACE"," ",423],["T_ARRAY","array",423],"(",["T_CONSTANT_ENCAPSED_STRING","':entity_code'",423],["T_WHITESPACE"," ",423],["T_DOUBLE_ARROW","=>",423],["T_WHITESPACE"," ",423],["T_VARIABLE","$entityCode",423],")",")",";",["T_WHITESPACE","\n    ",423],"}",["T_WHITESPACE","\n\n    ",424],["T_DOC_COMMENT","\/**\n     * Delete reviews by product id.\n     * Better to call this method in transaction, because operation performed on two separated tables\n     *\n     * @param int $productId\n     * @return Mage_Review_Model_Resource_Review\n     *\/",426],["T_WHITESPACE","\n    ",432],["T_PUBLIC","public",433],["T_WHITESPACE"," ",433],["T_FUNCTION","function",433],["T_WHITESPACE"," ",433],["T_STRING","deleteReviewsByProductId",433],"(",["T_VARIABLE","$productId",433],")",["T_WHITESPACE","\n    ",433],"{",["T_WHITESPACE","\n        ",434],["T_VARIABLE","$this",435],["T_OBJECT_OPERATOR","->",435],["T_STRING","_getWriteAdapter",435],"(",")",["T_OBJECT_OPERATOR","->",435],["T_STRING","delete",435],"(",["T_VARIABLE","$this",435],["T_OBJECT_OPERATOR","->",435],["T_STRING","_reviewTable",435],",",["T_WHITESPACE"," ",435],["T_ARRAY","array",435],"(",["T_WHITESPACE","\n            ",435],["T_CONSTANT_ENCAPSED_STRING","'entity_pk_value=?'",436],["T_WHITESPACE"," ",436],["T_DOUBLE_ARROW","=>",436],["T_WHITESPACE"," ",436],["T_VARIABLE","$productId",436],",",["T_WHITESPACE","\n            ",436],["T_CONSTANT_ENCAPSED_STRING","'entity_id=?'",437],["T_WHITESPACE"," ",437],["T_DOUBLE_ARROW","=>",437],["T_WHITESPACE"," ",437],["T_VARIABLE","$this",437],["T_OBJECT_OPERATOR","->",437],["T_STRING","getEntityIdByCode",437],"(",["T_STRING","Mage_Review_Model_Review",437],["T_DOUBLE_COLON","::",437],["T_STRING","ENTITY_PRODUCT_CODE",437],")",["T_WHITESPACE","\n        ",437],")",")",";",["T_WHITESPACE","\n        ",438],["T_VARIABLE","$this",439],["T_OBJECT_OPERATOR","->",439],["T_STRING","_getWriteAdapter",439],"(",")",["T_OBJECT_OPERATOR","->",439],["T_STRING","delete",439],"(",["T_VARIABLE","$this",439],["T_OBJECT_OPERATOR","->",439],["T_STRING","getTable",439],"(",["T_CONSTANT_ENCAPSED_STRING","'review\/review_aggregate'",439],")",",",["T_WHITESPACE"," ",439],["T_ARRAY","array",439],"(",["T_WHITESPACE","\n            ",439],["T_CONSTANT_ENCAPSED_STRING","'entity_pk_value=?'",440],["T_WHITESPACE"," ",440],["T_DOUBLE_ARROW","=>",440],["T_WHITESPACE"," ",440],["T_VARIABLE","$productId",440],",",["T_WHITESPACE","\n            ",440],["T_CONSTANT_ENCAPSED_STRING","'entity_type=?'",441],["T_WHITESPACE"," ",441],["T_DOUBLE_ARROW","=>",441],["T_WHITESPACE"," ",441],["T_VARIABLE","$this",441],["T_OBJECT_OPERATOR","->",441],["T_STRING","getEntityIdByCode",441],"(",["T_STRING","Mage_Review_Model_Review",441],["T_DOUBLE_COLON","::",441],["T_STRING","ENTITY_PRODUCT_CODE",441],")",["T_WHITESPACE","\n        ",441],")",")",";",["T_WHITESPACE","\n        ",442],["T_RETURN","return",443],["T_WHITESPACE"," ",443],["T_VARIABLE","$this",443],";",["T_WHITESPACE","\n    ",443],"}",["T_WHITESPACE","\n",444],"}",["T_WHITESPACE","\n",445]]