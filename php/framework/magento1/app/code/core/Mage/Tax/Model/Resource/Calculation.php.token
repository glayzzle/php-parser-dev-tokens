[["T_OPEN_TAG","<?php\n",1],["T_DOC_COMMENT","\/**\n * Magento\n *\n * NOTICE OF LICENSE\n *\n * This source file is subject to the Open Software License (OSL 3.0)\n * that is bundled with this package in the file LICENSE.txt.\n * It is also available through the world-wide-web at this URL:\n * http:\/\/opensource.org\/licenses\/osl-3.0.php\n * If you did not receive a copy of the license and are unable to\n * obtain it through the world-wide-web, please send an email\n * to license@magento.com so we can send you a copy immediately.\n *\n * DISCLAIMER\n *\n * Do not edit or add to this file if you wish to upgrade Magento to newer\n * versions in the future. If you wish to customize Magento for your\n * needs please refer to http:\/\/www.magento.com for more information.\n *\n * @category    Mage\n * @package     Mage_Tax\n * @copyright  Copyright (c) 2006-2016 X.commerce, Inc. and affiliates (http:\/\/www.magento.com)\n * @license    http:\/\/opensource.org\/licenses\/osl-3.0.php  Open Software License (OSL 3.0)\n *\/",2],["T_WHITESPACE","\n\n\n",25],["T_DOC_COMMENT","\/**\n * Tax Calculation Resource Model\n *\n * @category    Mage\n * @package     Mage_Tax\n * @author      Magento Core Team <core@magentocommerce.com>\n *\/",28],["T_WHITESPACE","\n",34],["T_CLASS","class",35],["T_WHITESPACE"," ",35],["T_STRING","Mage_Tax_Model_Resource_Calculation",35],["T_WHITESPACE"," ",35],["T_EXTENDS","extends",35],["T_WHITESPACE"," ",35],["T_STRING","Mage_Core_Model_Resource_Db_Abstract",35],["T_WHITESPACE","\n",35],"{",["T_WHITESPACE","\n    ",36],["T_DOC_COMMENT","\/**\n     * Rates cache\n     *\n     * @var unknown\n     *\/",37],["T_WHITESPACE","\n    ",41],["T_PROTECTED","protected",42],["T_WHITESPACE"," ",42],["T_VARIABLE","$_ratesCache",42],["T_WHITESPACE","              ",42],"=",["T_WHITESPACE"," ",42],["T_ARRAY","array",42],"(",")",";",["T_WHITESPACE","\n\n    ",42],["T_DOC_COMMENT","\/**\n     * Primery key auto increment flag\n     *\n     * @var bool\n     *\/",44],["T_WHITESPACE","\n    ",48],["T_PROTECTED","protected",49],["T_WHITESPACE"," ",49],["T_VARIABLE","$_isPkAutoIncrement",49],["T_WHITESPACE","    ",49],"=",["T_WHITESPACE"," ",49],["T_STRING","false",49],";",["T_WHITESPACE","\n\n    ",49],["T_DOC_COMMENT","\/**\n     * Resource initialization\n     *\n     *\/",51],["T_WHITESPACE","\n    ",54],["T_PROTECTED","protected",55],["T_WHITESPACE"," ",55],["T_FUNCTION","function",55],["T_WHITESPACE"," ",55],["T_STRING","_construct",55],"(",")",["T_WHITESPACE","\n    ",55],"{",["T_WHITESPACE","\n        ",56],["T_VARIABLE","$this",57],["T_OBJECT_OPERATOR","->",57],["T_STRING","_setMainTable",57],"(",["T_CONSTANT_ENCAPSED_STRING","'tax\/tax_calculation'",57],")",";",["T_WHITESPACE","\n    ",57],"}",["T_WHITESPACE","\n\n    ",58],["T_DOC_COMMENT","\/**\n     * Delete calculation settings by rule id\n     *\n     * @param int $ruleId\n     * @return Mage_Tax_Model_Resource_Calculation\n     *\/",60],["T_WHITESPACE","\n    ",65],["T_PUBLIC","public",66],["T_WHITESPACE"," ",66],["T_FUNCTION","function",66],["T_WHITESPACE"," ",66],["T_STRING","deleteByRuleId",66],"(",["T_VARIABLE","$ruleId",66],")",["T_WHITESPACE","\n    ",66],"{",["T_WHITESPACE","\n        ",67],["T_VARIABLE","$conn",68],["T_WHITESPACE"," ",68],"=",["T_WHITESPACE"," ",68],["T_VARIABLE","$this",68],["T_OBJECT_OPERATOR","->",68],["T_STRING","_getWriteAdapter",68],"(",")",";",["T_WHITESPACE","\n        ",68],["T_VARIABLE","$where",69],["T_WHITESPACE"," ",69],"=",["T_WHITESPACE"," ",69],["T_VARIABLE","$conn",69],["T_OBJECT_OPERATOR","->",69],["T_STRING","quoteInto",69],"(",["T_CONSTANT_ENCAPSED_STRING","'tax_calculation_rule_id = ?'",69],",",["T_WHITESPACE"," ",69],["T_INT_CAST","(int)",69],["T_VARIABLE","$ruleId",69],")",";",["T_WHITESPACE","\n        ",69],["T_VARIABLE","$conn",70],["T_OBJECT_OPERATOR","->",70],["T_STRING","delete",70],"(",["T_VARIABLE","$this",70],["T_OBJECT_OPERATOR","->",70],["T_STRING","getMainTable",70],"(",")",",",["T_WHITESPACE"," ",70],["T_VARIABLE","$where",70],")",";",["T_WHITESPACE","\n\n        ",70],["T_RETURN","return",72],["T_WHITESPACE"," ",72],["T_VARIABLE","$this",72],";",["T_WHITESPACE","\n    ",72],"}",["T_WHITESPACE","\n\n    ",73],["T_DOC_COMMENT","\/**\n     * Retreive distinct calculation\n     *\n     * @param  string $field\n     * @param  int $ruleId\n     * @return array\n     *\/",75],["T_WHITESPACE","\n    ",81],["T_PUBLIC","public",82],["T_WHITESPACE"," ",82],["T_FUNCTION","function",82],["T_WHITESPACE"," ",82],["T_STRING","getDistinct",82],"(",["T_VARIABLE","$field",82],",",["T_WHITESPACE"," ",82],["T_VARIABLE","$ruleId",82],")",["T_WHITESPACE","\n    ",82],"{",["T_WHITESPACE","\n        ",83],["T_VARIABLE","$select",84],["T_WHITESPACE"," ",84],"=",["T_WHITESPACE"," ",84],["T_VARIABLE","$this",84],["T_OBJECT_OPERATOR","->",84],["T_STRING","_getReadAdapter",84],"(",")",["T_OBJECT_OPERATOR","->",84],["T_STRING","select",84],"(",")",";",["T_WHITESPACE","\n        ",84],["T_VARIABLE","$select",85],["T_OBJECT_OPERATOR","->",85],["T_STRING","from",85],"(",["T_VARIABLE","$this",85],["T_OBJECT_OPERATOR","->",85],["T_STRING","getMainTable",85],"(",")",",",["T_WHITESPACE"," ",85],["T_VARIABLE","$field",85],")",["T_WHITESPACE","\n            ",85],["T_OBJECT_OPERATOR","->",86],["T_STRING","where",86],"(",["T_CONSTANT_ENCAPSED_STRING","'tax_calculation_rule_id = ?'",86],",",["T_WHITESPACE"," ",86],["T_INT_CAST","(int)",86],["T_VARIABLE","$ruleId",86],")",";",["T_WHITESPACE","\n\n        ",86],["T_RETURN","return",88],["T_WHITESPACE"," ",88],["T_VARIABLE","$this",88],["T_OBJECT_OPERATOR","->",88],["T_STRING","_getReadAdapter",88],"(",")",["T_OBJECT_OPERATOR","->",88],["T_STRING","fetchCol",88],"(",["T_VARIABLE","$select",88],")",";",["T_WHITESPACE","\n    ",88],"}",["T_WHITESPACE","\n\n    ",89],["T_DOC_COMMENT","\/**\n     * Get tax rate information: calculation process data and tax rate\n     *\n     * @param Varien_Object $request\n     * @return array\n     *\/",91],["T_WHITESPACE","\n    ",96],["T_PUBLIC","public",97],["T_WHITESPACE"," ",97],["T_FUNCTION","function",97],["T_WHITESPACE"," ",97],["T_STRING","getRateInfo",97],"(",["T_VARIABLE","$request",97],")",["T_WHITESPACE","\n    ",97],"{",["T_WHITESPACE","\n        ",98],["T_VARIABLE","$rates",99],["T_WHITESPACE"," ",99],"=",["T_WHITESPACE"," ",99],["T_VARIABLE","$this",99],["T_OBJECT_OPERATOR","->",99],["T_STRING","_getRates",99],"(",["T_VARIABLE","$request",99],")",";",["T_WHITESPACE","\n        ",99],["T_RETURN","return",100],["T_WHITESPACE"," ",100],["T_ARRAY","array",100],"(",["T_WHITESPACE","\n            ",100],["T_CONSTANT_ENCAPSED_STRING","'process'",101],["T_WHITESPACE","   ",101],["T_DOUBLE_ARROW","=>",101],["T_WHITESPACE"," ",101],["T_VARIABLE","$this",101],["T_OBJECT_OPERATOR","->",101],["T_STRING","getCalculationProcess",101],"(",["T_VARIABLE","$request",101],",",["T_WHITESPACE"," ",101],["T_VARIABLE","$rates",101],")",",",["T_WHITESPACE","\n            ",101],["T_CONSTANT_ENCAPSED_STRING","'value'",102],["T_WHITESPACE","     ",102],["T_DOUBLE_ARROW","=>",102],["T_WHITESPACE"," ",102],["T_VARIABLE","$this",102],["T_OBJECT_OPERATOR","->",102],["T_STRING","_calculateRate",102],"(",["T_VARIABLE","$rates",102],")",["T_WHITESPACE","\n        ",102],")",";",["T_WHITESPACE","\n    ",103],"}",["T_WHITESPACE","\n\n    ",104],["T_DOC_COMMENT","\/**\n     * Get tax rate for specific tax rate request\n     *\n     * @param Varien_Object $request\n     * @return int\n     *\/",106],["T_WHITESPACE","\n    ",111],["T_PUBLIC","public",112],["T_WHITESPACE"," ",112],["T_FUNCTION","function",112],["T_WHITESPACE"," ",112],["T_STRING","getRate",112],"(",["T_VARIABLE","$request",112],")",["T_WHITESPACE","\n    ",112],"{",["T_WHITESPACE","\n        ",113],["T_RETURN","return",114],["T_WHITESPACE"," ",114],["T_VARIABLE","$this",114],["T_OBJECT_OPERATOR","->",114],["T_STRING","_calculateRate",114],"(",["T_VARIABLE","$this",114],["T_OBJECT_OPERATOR","->",114],["T_STRING","_getRates",114],"(",["T_VARIABLE","$request",114],")",")",";",["T_WHITESPACE","\n    ",114],"}",["T_WHITESPACE","\n\n    ",115],["T_DOC_COMMENT","\/**\n     * Retrieve Calculation Process\n     *\n     * @param Varien_Object $request\n     * @param array $rates\n     * @return array\n     *\/",117],["T_WHITESPACE","\n    ",123],["T_PUBLIC","public",124],["T_WHITESPACE"," ",124],["T_FUNCTION","function",124],["T_WHITESPACE"," ",124],["T_STRING","getCalculationProcess",124],"(",["T_VARIABLE","$request",124],",",["T_WHITESPACE"," ",124],["T_VARIABLE","$rates",124],["T_WHITESPACE"," ",124],"=",["T_WHITESPACE"," ",124],["T_STRING","null",124],")",["T_WHITESPACE","\n    ",124],"{",["T_WHITESPACE","\n        ",125],["T_IF","if",126],["T_WHITESPACE"," ",126],"(",["T_STRING","is_null",126],"(",["T_VARIABLE","$rates",126],")",")",["T_WHITESPACE"," ",126],"{",["T_WHITESPACE","\n            ",126],["T_VARIABLE","$rates",127],["T_WHITESPACE"," ",127],"=",["T_WHITESPACE"," ",127],["T_VARIABLE","$this",127],["T_OBJECT_OPERATOR","->",127],["T_STRING","_getRates",127],"(",["T_VARIABLE","$request",127],")",";",["T_WHITESPACE","\n        ",127],"}",["T_WHITESPACE","\n\n        ",128],["T_VARIABLE","$result",130],["T_WHITESPACE"," ",130],"=",["T_WHITESPACE"," ",130],["T_ARRAY","array",130],"(",")",";",["T_WHITESPACE","\n        ",130],["T_VARIABLE","$row",131],["T_WHITESPACE"," ",131],"=",["T_WHITESPACE"," ",131],["T_ARRAY","array",131],"(",")",";",["T_WHITESPACE","\n        ",131],["T_VARIABLE","$ids",132],["T_WHITESPACE"," ",132],"=",["T_WHITESPACE"," ",132],["T_ARRAY","array",132],"(",")",";",["T_WHITESPACE","\n        ",132],["T_VARIABLE","$currentRate",133],["T_WHITESPACE"," ",133],"=",["T_WHITESPACE"," ",133],["T_LNUMBER","0",133],";",["T_WHITESPACE","\n        ",133],["T_VARIABLE","$totalPercent",134],["T_WHITESPACE"," ",134],"=",["T_WHITESPACE"," ",134],["T_LNUMBER","0",134],";",["T_WHITESPACE","\n        ",134],["T_VARIABLE","$countedRates",135],["T_WHITESPACE"," ",135],"=",["T_WHITESPACE"," ",135],["T_STRING","count",135],"(",["T_VARIABLE","$rates",135],")",";",["T_WHITESPACE","\n        ",135],["T_FOR","for",136],["T_WHITESPACE"," ",136],"(",["T_VARIABLE","$i",136],["T_WHITESPACE"," ",136],"=",["T_WHITESPACE"," ",136],["T_LNUMBER","0",136],";",["T_WHITESPACE"," ",136],["T_VARIABLE","$i",136],["T_WHITESPACE"," ",136],"<",["T_WHITESPACE"," ",136],["T_VARIABLE","$countedRates",136],";",["T_WHITESPACE"," ",136],["T_VARIABLE","$i",136],["T_INC","++",136],")",["T_WHITESPACE"," ",136],"{",["T_WHITESPACE","\n            ",136],["T_VARIABLE","$rate",137],["T_WHITESPACE"," ",137],"=",["T_WHITESPACE"," ",137],["T_VARIABLE","$rates",137],"[",["T_VARIABLE","$i",137],"]",";",["T_WHITESPACE","\n            ",137],["T_VARIABLE","$value",138],["T_WHITESPACE"," ",138],"=",["T_WHITESPACE"," ",138],"(",["T_ISSET","isset",138],"(",["T_VARIABLE","$rate",138],"[",["T_CONSTANT_ENCAPSED_STRING","'value'",138],"]",")",["T_WHITESPACE"," ",138],"?",["T_WHITESPACE"," ",138],["T_VARIABLE","$rate",138],"[",["T_CONSTANT_ENCAPSED_STRING","'value'",138],"]",["T_WHITESPACE"," ",138],":",["T_WHITESPACE"," ",138],["T_VARIABLE","$rate",138],"[",["T_CONSTANT_ENCAPSED_STRING","'percent'",138],"]",")",["T_WHITESPACE"," ",138],"*",["T_WHITESPACE"," ",138],["T_LNUMBER","1",138],";",["T_WHITESPACE","\n\n            ",138],["T_VARIABLE","$oneRate",140],["T_WHITESPACE"," ",140],"=",["T_WHITESPACE"," ",140],["T_ARRAY","array",140],"(",["T_WHITESPACE","\n                ",140],["T_CONSTANT_ENCAPSED_STRING","'code'",141],["T_WHITESPACE"," ",141],["T_DOUBLE_ARROW","=>",141],["T_WHITESPACE"," ",141],["T_VARIABLE","$rate",141],"[",["T_CONSTANT_ENCAPSED_STRING","'code'",141],"]",",",["T_WHITESPACE","\n                ",141],["T_CONSTANT_ENCAPSED_STRING","'title'",142],["T_WHITESPACE"," ",142],["T_DOUBLE_ARROW","=>",142],["T_WHITESPACE"," ",142],["T_VARIABLE","$rate",142],"[",["T_CONSTANT_ENCAPSED_STRING","'title'",142],"]",",",["T_WHITESPACE","\n                ",142],["T_CONSTANT_ENCAPSED_STRING","'percent'",143],["T_WHITESPACE"," ",143],["T_DOUBLE_ARROW","=>",143],["T_WHITESPACE"," ",143],["T_VARIABLE","$value",143],",",["T_WHITESPACE","\n                ",143],["T_CONSTANT_ENCAPSED_STRING","'position'",144],["T_WHITESPACE"," ",144],["T_DOUBLE_ARROW","=>",144],["T_WHITESPACE"," ",144],["T_VARIABLE","$rate",144],"[",["T_CONSTANT_ENCAPSED_STRING","'position'",144],"]",",",["T_WHITESPACE","\n                ",144],["T_CONSTANT_ENCAPSED_STRING","'priority'",145],["T_WHITESPACE"," ",145],["T_DOUBLE_ARROW","=>",145],["T_WHITESPACE"," ",145],["T_VARIABLE","$rate",145],"[",["T_CONSTANT_ENCAPSED_STRING","'priority'",145],"]",",",["T_WHITESPACE","\n            ",145],")",";",["T_WHITESPACE","\n            ",146],["T_IF","if",147],["T_WHITESPACE"," ",147],"(",["T_ISSET","isset",147],"(",["T_VARIABLE","$rate",147],"[",["T_CONSTANT_ENCAPSED_STRING","'tax_calculation_rule_id'",147],"]",")",")",["T_WHITESPACE"," ",147],"{",["T_WHITESPACE","\n                ",147],["T_VARIABLE","$oneRate",148],"[",["T_CONSTANT_ENCAPSED_STRING","'rule_id'",148],"]",["T_WHITESPACE"," ",148],"=",["T_WHITESPACE"," ",148],["T_VARIABLE","$rate",148],"[",["T_CONSTANT_ENCAPSED_STRING","'tax_calculation_rule_id'",148],"]",";",["T_WHITESPACE","\n            ",148],"}",["T_WHITESPACE","\n\n            ",149],["T_IF","if",151],["T_WHITESPACE"," ",151],"(",["T_ISSET","isset",151],"(",["T_VARIABLE","$rate",151],"[",["T_CONSTANT_ENCAPSED_STRING","'hidden'",151],"]",")",")",["T_WHITESPACE"," ",151],"{",["T_WHITESPACE","\n                ",151],["T_VARIABLE","$row",152],"[",["T_CONSTANT_ENCAPSED_STRING","'hidden'",152],"]",["T_WHITESPACE"," ",152],"=",["T_WHITESPACE"," ",152],["T_VARIABLE","$rate",152],"[",["T_CONSTANT_ENCAPSED_STRING","'hidden'",152],"]",";",["T_WHITESPACE","\n            ",152],"}",["T_WHITESPACE","\n\n            ",153],["T_IF","if",155],["T_WHITESPACE"," ",155],"(",["T_ISSET","isset",155],"(",["T_VARIABLE","$rate",155],"[",["T_CONSTANT_ENCAPSED_STRING","'amount'",155],"]",")",")",["T_WHITESPACE"," ",155],"{",["T_WHITESPACE","\n                ",155],["T_VARIABLE","$row",156],"[",["T_CONSTANT_ENCAPSED_STRING","'amount'",156],"]",["T_WHITESPACE"," ",156],"=",["T_WHITESPACE"," ",156],["T_VARIABLE","$rate",156],"[",["T_CONSTANT_ENCAPSED_STRING","'amount'",156],"]",";",["T_WHITESPACE","\n            ",156],"}",["T_WHITESPACE","\n\n            ",157],["T_IF","if",159],["T_WHITESPACE"," ",159],"(",["T_ISSET","isset",159],"(",["T_VARIABLE","$rate",159],"[",["T_CONSTANT_ENCAPSED_STRING","'base_amount'",159],"]",")",")",["T_WHITESPACE"," ",159],"{",["T_WHITESPACE","\n                ",159],["T_VARIABLE","$row",160],"[",["T_CONSTANT_ENCAPSED_STRING","'base_amount'",160],"]",["T_WHITESPACE"," ",160],"=",["T_WHITESPACE"," ",160],["T_VARIABLE","$rate",160],"[",["T_CONSTANT_ENCAPSED_STRING","'base_amount'",160],"]",";",["T_WHITESPACE","\n            ",160],"}",["T_WHITESPACE","\n            ",161],["T_IF","if",162],["T_WHITESPACE"," ",162],"(",["T_ISSET","isset",162],"(",["T_VARIABLE","$rate",162],"[",["T_CONSTANT_ENCAPSED_STRING","'base_real_amount'",162],"]",")",")",["T_WHITESPACE"," ",162],"{",["T_WHITESPACE","\n                ",162],["T_VARIABLE","$row",163],"[",["T_CONSTANT_ENCAPSED_STRING","'base_real_amount'",163],"]",["T_WHITESPACE"," ",163],"=",["T_WHITESPACE"," ",163],["T_VARIABLE","$rate",163],"[",["T_CONSTANT_ENCAPSED_STRING","'base_real_amount'",163],"]",";",["T_WHITESPACE","\n            ",163],"}",["T_WHITESPACE","\n            ",164],["T_VARIABLE","$row",165],"[",["T_CONSTANT_ENCAPSED_STRING","'rates'",165],"]","[","]",["T_WHITESPACE"," ",165],"=",["T_WHITESPACE"," ",165],["T_VARIABLE","$oneRate",165],";",["T_WHITESPACE","\n\n            ",165],["T_IF","if",167],["T_WHITESPACE"," ",167],"(",["T_ISSET","isset",167],"(",["T_VARIABLE","$rates",167],"[",["T_VARIABLE","$i",167],["T_WHITESPACE"," ",167],"+",["T_WHITESPACE"," ",167],["T_LNUMBER","1",167],"]","[",["T_CONSTANT_ENCAPSED_STRING","'tax_calculation_rule_id'",167],"]",")",")",["T_WHITESPACE"," ",167],"{",["T_WHITESPACE","\n                ",167],["T_VARIABLE","$rule",168],["T_WHITESPACE"," ",168],"=",["T_WHITESPACE"," ",168],["T_VARIABLE","$rate",168],"[",["T_CONSTANT_ENCAPSED_STRING","'tax_calculation_rule_id'",168],"]",";",["T_WHITESPACE","\n            ",168],"}",["T_WHITESPACE","\n            ",169],["T_VARIABLE","$priority",170],["T_WHITESPACE"," ",170],"=",["T_WHITESPACE"," ",170],["T_VARIABLE","$rate",170],"[",["T_CONSTANT_ENCAPSED_STRING","'priority'",170],"]",";",["T_WHITESPACE","\n            ",170],["T_VARIABLE","$ids",171],"[","]",["T_WHITESPACE"," ",171],"=",["T_WHITESPACE"," ",171],["T_VARIABLE","$rate",171],"[",["T_CONSTANT_ENCAPSED_STRING","'code'",171],"]",";",["T_WHITESPACE","\n\n            ",171],["T_IF","if",173],["T_WHITESPACE"," ",173],"(",["T_ISSET","isset",173],"(",["T_VARIABLE","$rates",173],"[",["T_VARIABLE","$i",173],["T_WHITESPACE"," ",173],"+",["T_WHITESPACE"," ",173],["T_LNUMBER","1",173],"]","[",["T_CONSTANT_ENCAPSED_STRING","'tax_calculation_rule_id'",173],"]",")",")",["T_WHITESPACE"," ",173],"{",["T_WHITESPACE","\n                ",173],["T_WHILE","while",174],["T_WHITESPACE"," ",174],"(",["T_ISSET","isset",174],"(",["T_VARIABLE","$rates",174],"[",["T_VARIABLE","$i",174],["T_WHITESPACE"," ",174],"+",["T_WHITESPACE"," ",174],["T_LNUMBER","1",174],"]",")",["T_WHITESPACE"," ",174],["T_BOOLEAN_AND","&&",174],["T_WHITESPACE"," ",174],["T_VARIABLE","$rates",174],"[",["T_VARIABLE","$i",174],["T_WHITESPACE"," ",174],"+",["T_WHITESPACE"," ",174],["T_LNUMBER","1",174],"]","[",["T_CONSTANT_ENCAPSED_STRING","'tax_calculation_rule_id'",174],"]",["T_WHITESPACE"," ",174],["T_IS_EQUAL","==",174],["T_WHITESPACE"," ",174],["T_VARIABLE","$rule",174],")",["T_WHITESPACE"," ",174],"{",["T_WHITESPACE","\n                    ",174],["T_VARIABLE","$i",175],["T_INC","++",175],";",["T_WHITESPACE","\n                ",175],"}",["T_WHITESPACE","\n            ",176],"}",["T_WHITESPACE","\n\n            ",177],["T_VARIABLE","$currentRate",179],["T_WHITESPACE"," ",179],["T_PLUS_EQUAL","+=",179],["T_WHITESPACE"," ",179],["T_VARIABLE","$value",179],";",["T_WHITESPACE","\n\n            ",179],["T_IF","if",181],["T_WHITESPACE"," ",181],"(","!",["T_ISSET","isset",181],"(",["T_VARIABLE","$rates",181],"[",["T_VARIABLE","$i",181],["T_WHITESPACE"," ",181],"+",["T_WHITESPACE"," ",181],["T_LNUMBER","1",181],"]",")",["T_WHITESPACE"," ",181],["T_BOOLEAN_OR","||",181],["T_WHITESPACE"," ",181],["T_VARIABLE","$rates",181],"[",["T_VARIABLE","$i",181],["T_WHITESPACE"," ",181],"+",["T_WHITESPACE"," ",181],["T_LNUMBER","1",181],"]","[",["T_CONSTANT_ENCAPSED_STRING","'priority'",181],"]",["T_WHITESPACE"," ",181],["T_IS_NOT_EQUAL","!=",181],["T_WHITESPACE"," ",181],["T_VARIABLE","$priority",181],["T_WHITESPACE","\n                ",181],["T_BOOLEAN_OR","||",182],["T_WHITESPACE"," ",182],"(",["T_ISSET","isset",182],"(",["T_VARIABLE","$rates",182],"[",["T_VARIABLE","$i",182],["T_WHITESPACE"," ",182],"+",["T_WHITESPACE"," ",182],["T_LNUMBER","1",182],"]","[",["T_CONSTANT_ENCAPSED_STRING","'process'",182],"]",")",["T_WHITESPACE"," ",182],["T_BOOLEAN_AND","&&",182],["T_WHITESPACE"," ",182],["T_VARIABLE","$rates",182],"[",["T_VARIABLE","$i",182],["T_WHITESPACE"," ",182],"+",["T_WHITESPACE"," ",182],["T_LNUMBER","1",182],"]","[",["T_CONSTANT_ENCAPSED_STRING","'process'",182],"]",["T_WHITESPACE"," ",182],["T_IS_NOT_EQUAL","!=",182],["T_WHITESPACE"," ",182],["T_VARIABLE","$rate",182],"[",["T_CONSTANT_ENCAPSED_STRING","'process'",182],"]",")",["T_WHITESPACE","\n            ",182],")",["T_WHITESPACE"," ",183],"{",["T_WHITESPACE","\n                ",183],["T_IF","if",184],["T_WHITESPACE"," ",184],"(","!",["T_EMPTY","empty",184],"(",["T_VARIABLE","$rates",184],"[",["T_VARIABLE","$i",184],"]","[",["T_CONSTANT_ENCAPSED_STRING","'calculate_subtotal'",184],"]",")",")",["T_WHITESPACE"," ",184],"{",["T_WHITESPACE","\n                    ",184],["T_VARIABLE","$row",185],"[",["T_CONSTANT_ENCAPSED_STRING","'percent'",185],"]",["T_WHITESPACE"," ",185],"=",["T_WHITESPACE"," ",185],["T_VARIABLE","$currentRate",185],";",["T_WHITESPACE","\n                    ",185],["T_VARIABLE","$totalPercent",186],["T_WHITESPACE"," ",186],["T_PLUS_EQUAL","+=",186],["T_WHITESPACE"," ",186],["T_VARIABLE","$currentRate",186],";",["T_WHITESPACE","\n                ",186],"}",["T_WHITESPACE"," ",187],["T_ELSE","else",187],["T_WHITESPACE"," ",187],"{",["T_WHITESPACE","\n                    ",187],["T_VARIABLE","$row",188],"[",["T_CONSTANT_ENCAPSED_STRING","'percent'",188],"]",["T_WHITESPACE"," ",188],"=",["T_WHITESPACE"," ",188],["T_VARIABLE","$this",188],["T_OBJECT_OPERATOR","->",188],["T_STRING","_collectPercent",188],"(",["T_VARIABLE","$totalPercent",188],",",["T_WHITESPACE"," ",188],["T_VARIABLE","$currentRate",188],")",";",["T_WHITESPACE","\n                    ",188],["T_VARIABLE","$totalPercent",189],["T_WHITESPACE"," ",189],["T_PLUS_EQUAL","+=",189],["T_WHITESPACE"," ",189],["T_VARIABLE","$row",189],"[",["T_CONSTANT_ENCAPSED_STRING","'percent'",189],"]",";",["T_WHITESPACE","\n                ",189],"}",["T_WHITESPACE","\n                ",190],["T_VARIABLE","$row",191],"[",["T_CONSTANT_ENCAPSED_STRING","'id'",191],"]",["T_WHITESPACE"," ",191],"=",["T_WHITESPACE"," ",191],["T_STRING","implode",191],"(",["T_VARIABLE","$ids",191],")",";",["T_WHITESPACE","\n                ",191],["T_VARIABLE","$result",192],"[","]",["T_WHITESPACE"," ",192],"=",["T_WHITESPACE"," ",192],["T_VARIABLE","$row",192],";",["T_WHITESPACE","\n                ",192],["T_VARIABLE","$row",193],["T_WHITESPACE"," ",193],"=",["T_WHITESPACE"," ",193],["T_ARRAY","array",193],"(",")",";",["T_WHITESPACE","\n                ",193],["T_VARIABLE","$ids",194],["T_WHITESPACE"," ",194],"=",["T_WHITESPACE"," ",194],["T_ARRAY","array",194],"(",")",";",["T_WHITESPACE","\n\n                ",194],["T_VARIABLE","$currentRate",196],["T_WHITESPACE"," ",196],"=",["T_WHITESPACE"," ",196],["T_LNUMBER","0",196],";",["T_WHITESPACE","\n            ",196],"}",["T_WHITESPACE","\n        ",197],"}",["T_WHITESPACE","\n\n        ",198],["T_RETURN","return",200],["T_WHITESPACE"," ",200],["T_VARIABLE","$result",200],";",["T_WHITESPACE","\n    ",200],"}",["T_WHITESPACE","\n\n    ",201],["T_DOC_COMMENT","\/**\n     * Return combined percent value\n     *\n     * @param float|int $percent\n     * @param float|int $rate\n     * @return int\n     *\/",203],["T_WHITESPACE","\n    ",209],["T_PROTECTED","protected",210],["T_WHITESPACE"," ",210],["T_FUNCTION","function",210],["T_WHITESPACE"," ",210],["T_STRING","_collectPercent",210],"(",["T_VARIABLE","$percent",210],",",["T_WHITESPACE"," ",210],["T_VARIABLE","$rate",210],")",["T_WHITESPACE","\n    ",210],"{",["T_WHITESPACE","\n        ",211],["T_RETURN","return",212],["T_WHITESPACE"," ",212],"(",["T_LNUMBER","100",212],["T_WHITESPACE"," ",212],"+",["T_WHITESPACE"," ",212],["T_VARIABLE","$percent",212],")",["T_WHITESPACE"," ",212],"*",["T_WHITESPACE"," ",212],"(",["T_VARIABLE","$rate",212],["T_WHITESPACE"," ",212],"\/",["T_WHITESPACE"," ",212],["T_LNUMBER","100",212],")",";",["T_WHITESPACE","\n    ",212],"}",["T_WHITESPACE","\n\n    ",213],["T_DOC_COMMENT","\/**\n     * Create search templates for postcode\n     *\n     * @param string $postcode\n     * @return array  $strArr\n     *\/",215],["T_WHITESPACE","\n    ",220],["T_PROTECTED","protected",221],["T_WHITESPACE"," ",221],["T_FUNCTION","function",221],["T_WHITESPACE"," ",221],["T_STRING","_createSearchPostCodeTemplates",221],"(",["T_VARIABLE","$postcode",221],")",["T_WHITESPACE","\n    ",221],"{",["T_WHITESPACE","\n        ",222],["T_VARIABLE","$len",223],["T_WHITESPACE"," ",223],"=",["T_WHITESPACE"," ",223],["T_STRING","Mage",223],["T_DOUBLE_COLON","::",223],["T_STRING","helper",223],"(",["T_CONSTANT_ENCAPSED_STRING","'tax'",223],")",["T_OBJECT_OPERATOR","->",223],["T_STRING","getPostCodeSubStringLength",223],"(",")",";",["T_WHITESPACE","\n        ",223],["T_VARIABLE","$strlen",224],["T_WHITESPACE"," ",224],"=",["T_WHITESPACE"," ",224],["T_STRING","strlen",224],"(",["T_VARIABLE","$postcode",224],")",";",["T_WHITESPACE","\n        ",224],["T_IF","if",225],["T_WHITESPACE"," ",225],"(",["T_VARIABLE","$strlen",225],["T_WHITESPACE"," ",225],">",["T_WHITESPACE"," ",225],["T_VARIABLE","$len",225],")",["T_WHITESPACE"," ",225],"{",["T_WHITESPACE","\n            ",225],["T_VARIABLE","$postcode",226],["T_WHITESPACE"," ",226],"=",["T_WHITESPACE"," ",226],["T_STRING","substr",226],"(",["T_VARIABLE","$postcode",226],",",["T_WHITESPACE"," ",226],["T_LNUMBER","0",226],",",["T_WHITESPACE"," ",226],["T_VARIABLE","$len",226],")",";",["T_WHITESPACE","\n            ",226],["T_VARIABLE","$strlen",227],["T_WHITESPACE"," ",227],"=",["T_WHITESPACE"," ",227],["T_VARIABLE","$len",227],";",["T_WHITESPACE","\n        ",227],"}",["T_WHITESPACE","\n\n        ",228],["T_VARIABLE","$strArr",230],["T_WHITESPACE"," ",230],"=",["T_WHITESPACE"," ",230],["T_ARRAY","array",230],"(",["T_STRING_CAST","(string)",230],["T_VARIABLE","$postcode",230],",",["T_WHITESPACE"," ",230],["T_VARIABLE","$postcode",230],["T_WHITESPACE"," ",230],".",["T_WHITESPACE"," ",230],["T_CONSTANT_ENCAPSED_STRING","'*'",230],")",";",["T_WHITESPACE","\n        ",230],["T_IF","if",231],["T_WHITESPACE"," ",231],"(",["T_VARIABLE","$strlen",231],["T_WHITESPACE"," ",231],">",["T_WHITESPACE"," ",231],["T_LNUMBER","1",231],")",["T_WHITESPACE"," ",231],"{",["T_WHITESPACE","\n            ",231],["T_FOR","for",232],["T_WHITESPACE"," ",232],"(",["T_VARIABLE","$i",232],["T_WHITESPACE"," ",232],"=",["T_WHITESPACE"," ",232],["T_LNUMBER","1",232],";",["T_WHITESPACE"," ",232],["T_VARIABLE","$i",232],["T_WHITESPACE"," ",232],"<",["T_WHITESPACE"," ",232],["T_VARIABLE","$strlen",232],";",["T_WHITESPACE"," ",232],["T_VARIABLE","$i",232],["T_INC","++",232],")",["T_WHITESPACE"," ",232],"{",["T_WHITESPACE","\n                ",232],["T_VARIABLE","$strArr",233],"[","]",["T_WHITESPACE"," ",233],"=",["T_WHITESPACE"," ",233],["T_STRING","sprintf",233],"(",["T_CONSTANT_ENCAPSED_STRING","'%s*'",233],",",["T_WHITESPACE"," ",233],["T_STRING","substr",233],"(",["T_VARIABLE","$postcode",233],",",["T_WHITESPACE"," ",233],["T_LNUMBER","0",233],",",["T_WHITESPACE"," ",233],"-",["T_WHITESPACE"," ",233],["T_VARIABLE","$i",233],")",")",";",["T_WHITESPACE","\n            ",233],"}",["T_WHITESPACE","\n        ",234],"}",["T_WHITESPACE","\n\n        ",235],["T_RETURN","return",237],["T_WHITESPACE"," ",237],["T_VARIABLE","$strArr",237],";",["T_WHITESPACE","\n    ",237],"}",["T_WHITESPACE","\n\n    ",238],["T_DOC_COMMENT","\/**\n     * Returns tax rates for request - either pereforms SELECT from DB, or returns already cached result\n     * Notice that productClassId due to optimization can be array of ids\n     *\n     * @param Varien_Object $request\n     * @return array\n     *\/",240],["T_WHITESPACE","\n    ",246],["T_PROTECTED","protected",247],["T_WHITESPACE"," ",247],["T_FUNCTION","function",247],["T_WHITESPACE"," ",247],["T_STRING","_getRates",247],"(",["T_VARIABLE","$request",247],")",["T_WHITESPACE","\n    ",247],"{",["T_WHITESPACE","\n        ",248],["T_COMMENT","\/\/ Extract params that influence our SELECT statement and use them to create cache key\n",249],["T_WHITESPACE","        ",250],["T_VARIABLE","$storeId",250],["T_WHITESPACE"," ",250],"=",["T_WHITESPACE"," ",250],["T_STRING","Mage",250],["T_DOUBLE_COLON","::",250],["T_STRING","app",250],"(",")",["T_OBJECT_OPERATOR","->",250],["T_STRING","getStore",250],"(",["T_VARIABLE","$request",250],["T_OBJECT_OPERATOR","->",250],["T_STRING","getStore",250],"(",")",")",["T_OBJECT_OPERATOR","->",250],["T_STRING","getId",250],"(",")",";",["T_WHITESPACE","\n        ",250],["T_VARIABLE","$customerClassId",251],["T_WHITESPACE"," ",251],"=",["T_WHITESPACE"," ",251],["T_VARIABLE","$request",251],["T_OBJECT_OPERATOR","->",251],["T_STRING","getCustomerClassId",251],"(",")",";",["T_WHITESPACE","\n        ",251],["T_VARIABLE","$countryId",252],["T_WHITESPACE"," ",252],"=",["T_WHITESPACE"," ",252],["T_VARIABLE","$request",252],["T_OBJECT_OPERATOR","->",252],["T_STRING","getCountryId",252],"(",")",";",["T_WHITESPACE","\n        ",252],["T_VARIABLE","$regionId",253],["T_WHITESPACE"," ",253],"=",["T_WHITESPACE"," ",253],["T_VARIABLE","$request",253],["T_OBJECT_OPERATOR","->",253],["T_STRING","getRegionId",253],"(",")",";",["T_WHITESPACE","\n        ",253],["T_VARIABLE","$postcode",254],["T_WHITESPACE"," ",254],"=",["T_WHITESPACE"," ",254],["T_VARIABLE","$request",254],["T_OBJECT_OPERATOR","->",254],["T_STRING","getPostcode",254],"(",")",";",["T_WHITESPACE","\n\n        ",254],["T_COMMENT","\/\/ Process productClassId as it can be array or usual value. Form best key for cache.\n",256],["T_WHITESPACE","        ",257],["T_VARIABLE","$productClassId",257],["T_WHITESPACE"," ",257],"=",["T_WHITESPACE"," ",257],["T_VARIABLE","$request",257],["T_OBJECT_OPERATOR","->",257],["T_STRING","getProductClassId",257],"(",")",";",["T_WHITESPACE","\n        ",257],["T_VARIABLE","$ids",258],["T_WHITESPACE"," ",258],"=",["T_WHITESPACE"," ",258],["T_STRING","is_array",258],"(",["T_VARIABLE","$productClassId",258],")",["T_WHITESPACE"," ",258],"?",["T_WHITESPACE"," ",258],["T_VARIABLE","$productClassId",258],["T_WHITESPACE"," ",258],":",["T_WHITESPACE"," ",258],["T_ARRAY","array",258],"(",["T_VARIABLE","$productClassId",258],")",";",["T_WHITESPACE","\n        ",258],["T_FOREACH","foreach",259],["T_WHITESPACE"," ",259],"(",["T_VARIABLE","$ids",259],["T_WHITESPACE"," ",259],["T_AS","as",259],["T_WHITESPACE"," ",259],["T_VARIABLE","$key",259],["T_WHITESPACE"," ",259],["T_DOUBLE_ARROW","=>",259],["T_WHITESPACE"," ",259],["T_VARIABLE","$val",259],")",["T_WHITESPACE"," ",259],"{",["T_WHITESPACE","\n            ",259],["T_VARIABLE","$ids",260],"[",["T_VARIABLE","$key",260],"]",["T_WHITESPACE"," ",260],"=",["T_WHITESPACE"," ",260],["T_INT_CAST","(int)",260],["T_WHITESPACE"," ",260],["T_VARIABLE","$val",260],";",["T_WHITESPACE"," ",260],["T_COMMENT","\/\/ Make it integer for equal cache keys even in case of null\/false\/0 values\n",260],["T_WHITESPACE","        ",261],"}",["T_WHITESPACE","\n        ",261],["T_VARIABLE","$ids",262],["T_WHITESPACE"," ",262],"=",["T_WHITESPACE"," ",262],["T_STRING","array_unique",262],"(",["T_VARIABLE","$ids",262],")",";",["T_WHITESPACE","\n        ",262],["T_STRING","sort",263],"(",["T_VARIABLE","$ids",263],")",";",["T_WHITESPACE","\n        ",263],["T_VARIABLE","$productClassKey",264],["T_WHITESPACE"," ",264],"=",["T_WHITESPACE"," ",264],["T_STRING","implode",264],"(",["T_CONSTANT_ENCAPSED_STRING","','",264],",",["T_WHITESPACE"," ",264],["T_VARIABLE","$ids",264],")",";",["T_WHITESPACE","\n\n        ",264],["T_COMMENT","\/\/ Form cache key and either get data from cache or from DB\n",266],["T_WHITESPACE","        ",267],["T_VARIABLE","$cacheKey",267],["T_WHITESPACE"," ",267],"=",["T_WHITESPACE"," ",267],["T_STRING","implode",267],"(",["T_CONSTANT_ENCAPSED_STRING","'|'",267],",",["T_WHITESPACE"," ",267],["T_ARRAY","array",267],"(",["T_VARIABLE","$storeId",267],",",["T_WHITESPACE"," ",267],["T_VARIABLE","$customerClassId",267],",",["T_WHITESPACE"," ",267],["T_VARIABLE","$productClassKey",267],",",["T_WHITESPACE"," ",267],["T_VARIABLE","$countryId",267],",",["T_WHITESPACE"," ",267],["T_VARIABLE","$regionId",267],",",["T_WHITESPACE"," ",267],["T_VARIABLE","$postcode",267],")",")",";",["T_WHITESPACE","\n\n        ",267],["T_IF","if",269],["T_WHITESPACE"," ",269],"(","!",["T_ISSET","isset",269],"(",["T_VARIABLE","$this",269],["T_OBJECT_OPERATOR","->",269],["T_STRING","_ratesCache",269],"[",["T_VARIABLE","$cacheKey",269],"]",")",")",["T_WHITESPACE"," ",269],"{",["T_WHITESPACE","\n            ",269],["T_COMMENT","\/\/ Make SELECT and get data\n",270],["T_WHITESPACE","            ",271],["T_VARIABLE","$select",271],["T_WHITESPACE"," ",271],"=",["T_WHITESPACE"," ",271],["T_VARIABLE","$this",271],["T_OBJECT_OPERATOR","->",271],["T_STRING","_getReadAdapter",271],"(",")",["T_OBJECT_OPERATOR","->",271],["T_STRING","select",271],"(",")",";",["T_WHITESPACE","\n            ",271],["T_VARIABLE","$select",272],["T_WHITESPACE","\n                ",272],["T_OBJECT_OPERATOR","->",273],["T_STRING","from",273],"(",["T_ARRAY","array",273],"(",["T_CONSTANT_ENCAPSED_STRING","'main_table'",273],["T_WHITESPACE"," ",273],["T_DOUBLE_ARROW","=>",273],["T_WHITESPACE"," ",273],["T_VARIABLE","$this",273],["T_OBJECT_OPERATOR","->",273],["T_STRING","getMainTable",273],"(",")",")",",",["T_WHITESPACE","\n                ",273],["T_ARRAY","array",274],"(",["T_CONSTANT_ENCAPSED_STRING","'tax_calculation_rate_id'",274],",",["T_WHITESPACE","\n                      ",274],["T_CONSTANT_ENCAPSED_STRING","'tax_calculation_rule_id'",275],",",["T_WHITESPACE","\n                      ",275],["T_CONSTANT_ENCAPSED_STRING","'customer_tax_class_id'",276],",",["T_WHITESPACE","\n                      ",276],["T_CONSTANT_ENCAPSED_STRING","'product_tax_class_id'",277],["T_WHITESPACE","\n                    ",277],")",["T_WHITESPACE","\n                ",278],")",["T_WHITESPACE","\n                ",279],["T_OBJECT_OPERATOR","->",280],["T_STRING","where",280],"(",["T_CONSTANT_ENCAPSED_STRING","'customer_tax_class_id = ?'",280],",",["T_WHITESPACE"," ",280],["T_INT_CAST","(int)",280],["T_VARIABLE","$customerClassId",280],")",";",["T_WHITESPACE","\n            ",280],["T_IF","if",281],["T_WHITESPACE"," ",281],"(",["T_VARIABLE","$productClassId",281],")",["T_WHITESPACE"," ",281],"{",["T_WHITESPACE","\n                ",281],["T_VARIABLE","$select",282],["T_OBJECT_OPERATOR","->",282],["T_STRING","where",282],"(",["T_CONSTANT_ENCAPSED_STRING","'product_tax_class_id IN (?)'",282],",",["T_WHITESPACE"," ",282],["T_VARIABLE","$productClassId",282],")",";",["T_WHITESPACE","\n            ",282],"}",["T_WHITESPACE","\n            ",283],["T_VARIABLE","$ifnullTitleValue",284],["T_WHITESPACE"," ",284],"=",["T_WHITESPACE"," ",284],["T_VARIABLE","$this",284],["T_OBJECT_OPERATOR","->",284],["T_STRING","_getReadAdapter",284],"(",")",["T_OBJECT_OPERATOR","->",284],["T_STRING","getCheckSql",284],"(",["T_WHITESPACE","\n                ",284],["T_CONSTANT_ENCAPSED_STRING","'title_table.value IS NULL'",285],",",["T_WHITESPACE","\n                ",285],["T_CONSTANT_ENCAPSED_STRING","'rate.code'",286],",",["T_WHITESPACE","\n                ",286],["T_CONSTANT_ENCAPSED_STRING","'title_table.value'",287],["T_WHITESPACE","\n            ",287],")",";",["T_WHITESPACE","\n            ",288],["T_VARIABLE","$ruleTableAliasName",289],["T_WHITESPACE"," ",289],"=",["T_WHITESPACE"," ",289],["T_VARIABLE","$this",289],["T_OBJECT_OPERATOR","->",289],["T_STRING","_getReadAdapter",289],"(",")",["T_OBJECT_OPERATOR","->",289],["T_STRING","quoteIdentifier",289],"(",["T_CONSTANT_ENCAPSED_STRING","'rule.tax_calculation_rule_id'",289],")",";",["T_WHITESPACE","\n            ",289],["T_VARIABLE","$select",290],["T_WHITESPACE","\n                ",290],["T_OBJECT_OPERATOR","->",291],["T_STRING","join",291],"(",["T_WHITESPACE","\n                    ",291],["T_ARRAY","array",292],"(",["T_CONSTANT_ENCAPSED_STRING","'rule'",292],["T_WHITESPACE"," ",292],["T_DOUBLE_ARROW","=>",292],["T_WHITESPACE"," ",292],["T_VARIABLE","$this",292],["T_OBJECT_OPERATOR","->",292],["T_STRING","getTable",292],"(",["T_CONSTANT_ENCAPSED_STRING","'tax\/tax_calculation_rule'",292],")",")",",",["T_WHITESPACE","\n                    ",292],["T_VARIABLE","$ruleTableAliasName",293],["T_WHITESPACE"," ",293],".",["T_WHITESPACE"," ",293],["T_CONSTANT_ENCAPSED_STRING","' = main_table.tax_calculation_rule_id'",293],",",["T_WHITESPACE","\n                    ",293],["T_ARRAY","array",294],"(",["T_CONSTANT_ENCAPSED_STRING","'rule.priority'",294],",",["T_WHITESPACE"," ",294],["T_CONSTANT_ENCAPSED_STRING","'rule.position'",294],",",["T_WHITESPACE"," ",294],["T_CONSTANT_ENCAPSED_STRING","'rule.calculate_subtotal'",294],")",")",["T_WHITESPACE","\n                ",294],["T_OBJECT_OPERATOR","->",295],["T_STRING","join",295],"(",["T_WHITESPACE","\n                    ",295],["T_ARRAY","array",296],"(",["T_CONSTANT_ENCAPSED_STRING","'rate'",296],["T_WHITESPACE"," ",296],["T_DOUBLE_ARROW","=>",296],["T_WHITESPACE"," ",296],["T_VARIABLE","$this",296],["T_OBJECT_OPERATOR","->",296],["T_STRING","getTable",296],"(",["T_CONSTANT_ENCAPSED_STRING","'tax\/tax_calculation_rate'",296],")",")",",",["T_WHITESPACE","\n                    ",296],["T_CONSTANT_ENCAPSED_STRING","'rate.tax_calculation_rate_id = main_table.tax_calculation_rate_id'",297],",",["T_WHITESPACE","\n                    ",297],["T_ARRAY","array",298],"(",["T_WHITESPACE","\n                        ",298],["T_CONSTANT_ENCAPSED_STRING","'value'",299],["T_WHITESPACE"," ",299],["T_DOUBLE_ARROW","=>",299],["T_WHITESPACE"," ",299],["T_CONSTANT_ENCAPSED_STRING","'rate.rate'",299],",",["T_WHITESPACE","\n                        ",299],["T_CONSTANT_ENCAPSED_STRING","'rate.tax_country_id'",300],",",["T_WHITESPACE","\n                        ",300],["T_CONSTANT_ENCAPSED_STRING","'rate.tax_region_id'",301],",",["T_WHITESPACE","\n                        ",301],["T_CONSTANT_ENCAPSED_STRING","'rate.tax_postcode'",302],",",["T_WHITESPACE","\n                        ",302],["T_CONSTANT_ENCAPSED_STRING","'rate.tax_calculation_rate_id'",303],",",["T_WHITESPACE","\n                        ",303],["T_CONSTANT_ENCAPSED_STRING","'rate.code'",304],["T_WHITESPACE","\n                ",304],")",")",["T_WHITESPACE","\n                ",305],["T_OBJECT_OPERATOR","->",306],["T_STRING","joinLeft",306],"(",["T_WHITESPACE","\n                    ",306],["T_ARRAY","array",307],"(",["T_CONSTANT_ENCAPSED_STRING","'title_table'",307],["T_WHITESPACE"," ",307],["T_DOUBLE_ARROW","=>",307],["T_WHITESPACE"," ",307],["T_VARIABLE","$this",307],["T_OBJECT_OPERATOR","->",307],["T_STRING","getTable",307],"(",["T_CONSTANT_ENCAPSED_STRING","'tax\/tax_calculation_rate_title'",307],")",")",",",["T_WHITESPACE","\n                   ",307],["T_CONSTANT_ENCAPSED_STRING","\"rate.tax_calculation_rate_id = title_table.tax_calculation_rate_id \"",308],["T_WHITESPACE","\n                   ",308],".",["T_WHITESPACE"," ",309],"\"",["T_ENCAPSED_AND_WHITESPACE","AND title_table.store_id = '",309],["T_CURLY_OPEN","{",309],["T_VARIABLE","$storeId",309],"}",["T_ENCAPSED_AND_WHITESPACE","'",309],"\"",",",["T_WHITESPACE","\n                    ",309],["T_ARRAY","array",310],"(",["T_CONSTANT_ENCAPSED_STRING","'title'",310],["T_WHITESPACE"," ",310],["T_DOUBLE_ARROW","=>",310],["T_WHITESPACE"," ",310],["T_VARIABLE","$ifnullTitleValue",310],")",")",["T_WHITESPACE","\n                ",310],["T_OBJECT_OPERATOR","->",311],["T_STRING","where",311],"(",["T_CONSTANT_ENCAPSED_STRING","'rate.tax_country_id = ?'",311],",",["T_WHITESPACE"," ",311],["T_VARIABLE","$countryId",311],")",["T_WHITESPACE","\n                ",311],["T_OBJECT_OPERATOR","->",312],["T_STRING","where",312],"(",["T_CONSTANT_ENCAPSED_STRING","\"rate.tax_region_id IN(?)\"",312],",",["T_WHITESPACE"," ",312],["T_ARRAY","array",312],"(",["T_LNUMBER","0",312],",",["T_WHITESPACE"," ",312],["T_INT_CAST","(int)",312],["T_VARIABLE","$regionId",312],")",")",";",["T_WHITESPACE","\n            ",312],["T_VARIABLE","$postcodeIsNumeric",313],["T_WHITESPACE"," ",313],"=",["T_WHITESPACE"," ",313],["T_STRING","is_numeric",313],"(",["T_VARIABLE","$postcode",313],")",";",["T_WHITESPACE","\n            ",313],["T_VARIABLE","$postcodeIsRange",314],["T_WHITESPACE"," ",314],"=",["T_WHITESPACE"," ",314],["T_STRING","is_string",314],"(",["T_VARIABLE","$postcode",314],")",["T_WHITESPACE"," ",314],["T_BOOLEAN_AND","&&",314],["T_WHITESPACE"," ",314],["T_STRING","preg_match",314],"(",["T_CONSTANT_ENCAPSED_STRING","'\/^(.+)-(.+)$\/'",314],",",["T_WHITESPACE"," ",314],["T_VARIABLE","$postcode",314],",",["T_WHITESPACE"," ",314],["T_VARIABLE","$matches",314],")",";",["T_WHITESPACE","\n            ",314],["T_IF","if",315],["T_WHITESPACE"," ",315],"(",["T_VARIABLE","$postcodeIsRange",315],")",["T_WHITESPACE"," ",315],"{",["T_WHITESPACE","\n                ",315],["T_VARIABLE","$zipFrom",316],["T_WHITESPACE"," ",316],"=",["T_WHITESPACE"," ",316],["T_VARIABLE","$matches",316],"[",["T_LNUMBER","1",316],"]",";",["T_WHITESPACE","\n                ",316],["T_VARIABLE","$zipTo",317],["T_WHITESPACE"," ",317],"=",["T_WHITESPACE"," ",317],["T_VARIABLE","$matches",317],"[",["T_LNUMBER","2",317],"]",";",["T_WHITESPACE","\n            ",317],"}",["T_WHITESPACE","\n\n            ",318],["T_IF","if",320],["T_WHITESPACE"," ",320],"(",["T_VARIABLE","$postcodeIsNumeric",320],["T_WHITESPACE"," ",320],["T_BOOLEAN_OR","||",320],["T_WHITESPACE"," ",320],["T_VARIABLE","$postcodeIsRange",320],")",["T_WHITESPACE"," ",320],"{",["T_WHITESPACE","\n                ",320],["T_VARIABLE","$selectClone",321],["T_WHITESPACE"," ",321],"=",["T_WHITESPACE"," ",321],["T_CLONE","clone",321],["T_WHITESPACE"," ",321],["T_VARIABLE","$select",321],";",["T_WHITESPACE","\n                ",321],["T_VARIABLE","$selectClone",322],["T_OBJECT_OPERATOR","->",322],["T_STRING","where",322],"(",["T_CONSTANT_ENCAPSED_STRING","'rate.zip_is_range IS NOT NULL'",322],")",";",["T_WHITESPACE","\n            ",322],"}",["T_WHITESPACE","\n            ",323],["T_VARIABLE","$select",324],["T_OBJECT_OPERATOR","->",324],["T_STRING","where",324],"(",["T_CONSTANT_ENCAPSED_STRING","'rate.zip_is_range IS NULL'",324],")",";",["T_WHITESPACE","\n\n            ",324],["T_IF","if",326],["T_WHITESPACE"," ",326],"(",["T_VARIABLE","$postcode",326],["T_WHITESPACE"," ",326],["T_IS_NOT_EQUAL","!=",326],["T_WHITESPACE"," ",326],["T_CONSTANT_ENCAPSED_STRING","'*'",326],["T_WHITESPACE"," ",326],["T_BOOLEAN_OR","||",326],["T_WHITESPACE"," ",326],["T_VARIABLE","$postcodeIsRange",326],")",["T_WHITESPACE"," ",326],"{",["T_WHITESPACE","\n                ",326],["T_VARIABLE","$select",327],["T_WHITESPACE","\n                    ",327],["T_OBJECT_OPERATOR","->",328],["T_STRING","where",328],"(",["T_CONSTANT_ENCAPSED_STRING","\"rate.tax_postcode IS NULL OR rate.tax_postcode IN('*', '', ?)\"",328],",",["T_WHITESPACE","\n                        ",328],["T_VARIABLE","$postcodeIsRange",329],["T_WHITESPACE"," ",329],"?",["T_WHITESPACE"," ",329],["T_VARIABLE","$postcode",329],["T_WHITESPACE"," ",329],":",["T_WHITESPACE"," ",329],["T_VARIABLE","$this",329],["T_OBJECT_OPERATOR","->",329],["T_STRING","_createSearchPostCodeTemplates",329],"(",["T_VARIABLE","$postcode",329],")",")",";",["T_WHITESPACE","\n                ",329],["T_IF","if",330],["T_WHITESPACE"," ",330],"(",["T_VARIABLE","$postcodeIsNumeric",330],")",["T_WHITESPACE"," ",330],"{",["T_WHITESPACE","\n                    ",330],["T_VARIABLE","$selectClone",331],["T_WHITESPACE","\n                        ",331],["T_OBJECT_OPERATOR","->",332],["T_STRING","where",332],"(",["T_CONSTANT_ENCAPSED_STRING","'? BETWEEN rate.zip_from AND rate.zip_to'",332],",",["T_WHITESPACE"," ",332],["T_VARIABLE","$postcode",332],")",";",["T_WHITESPACE","\n                ",332],"}",["T_WHITESPACE"," ",333],["T_ELSE","else",333],["T_WHITESPACE"," ",333],["T_IF","if",333],["T_WHITESPACE"," ",333],"(",["T_VARIABLE","$postcodeIsRange",333],")",["T_WHITESPACE"," ",333],"{",["T_WHITESPACE","\n                    ",333],["T_VARIABLE","$selectClone",334],["T_OBJECT_OPERATOR","->",334],["T_STRING","where",334],"(",["T_CONSTANT_ENCAPSED_STRING","'rate.zip_from >= ?'",334],",",["T_WHITESPACE"," ",334],["T_VARIABLE","$zipFrom",334],")",["T_WHITESPACE","\n                        ",334],["T_OBJECT_OPERATOR","->",335],["T_STRING","where",335],"(",["T_CONSTANT_ENCAPSED_STRING","'rate.zip_to <= ?'",335],",",["T_WHITESPACE"," ",335],["T_VARIABLE","$zipTo",335],")",";",["T_WHITESPACE","\n                ",335],"}",["T_WHITESPACE","\n            ",336],"}",["T_WHITESPACE","\n\n            ",337],["T_DOC_COMMENT","\/**\n             * @see ZF-7592 issue http:\/\/framework.zend.com\/issues\/browse\/ZF-7592\n             *\/",339],["T_WHITESPACE","\n            ",341],["T_IF","if",342],["T_WHITESPACE"," ",342],"(",["T_VARIABLE","$postcodeIsNumeric",342],["T_WHITESPACE"," ",342],["T_BOOLEAN_OR","||",342],["T_WHITESPACE"," ",342],["T_VARIABLE","$postcodeIsRange",342],")",["T_WHITESPACE"," ",342],"{",["T_WHITESPACE","\n                ",342],["T_VARIABLE","$select",343],["T_WHITESPACE"," ",343],"=",["T_WHITESPACE"," ",343],["T_VARIABLE","$this",343],["T_OBJECT_OPERATOR","->",343],["T_STRING","_getReadAdapter",343],"(",")",["T_OBJECT_OPERATOR","->",343],["T_STRING","select",343],"(",")",["T_OBJECT_OPERATOR","->",343],["T_STRING","union",343],"(",["T_WHITESPACE","\n                    ",343],["T_ARRAY","array",344],"(",["T_WHITESPACE","\n                        ",344],["T_CONSTANT_ENCAPSED_STRING","'('",345],["T_WHITESPACE"," ",345],".",["T_WHITESPACE"," ",345],["T_VARIABLE","$select",345],["T_WHITESPACE"," ",345],".",["T_WHITESPACE"," ",345],["T_CONSTANT_ENCAPSED_STRING","')'",345],",",["T_WHITESPACE","\n                        ",345],["T_CONSTANT_ENCAPSED_STRING","'('",346],["T_WHITESPACE"," ",346],".",["T_WHITESPACE"," ",346],["T_VARIABLE","$selectClone",346],["T_WHITESPACE"," ",346],".",["T_WHITESPACE"," ",346],["T_CONSTANT_ENCAPSED_STRING","')'",346],["T_WHITESPACE","\n                    ",346],")",["T_WHITESPACE","\n                ",347],")",";",["T_WHITESPACE","\n            ",348],"}",["T_WHITESPACE","\n\n            ",349],["T_VARIABLE","$select",351],["T_OBJECT_OPERATOR","->",351],["T_STRING","order",351],"(",["T_CONSTANT_ENCAPSED_STRING","'priority '",351],["T_WHITESPACE"," ",351],".",["T_WHITESPACE"," ",351],["T_STRING","Varien_Db_Select",351],["T_DOUBLE_COLON","::",351],["T_STRING","SQL_ASC",351],")",["T_WHITESPACE","\n                   ",351],["T_OBJECT_OPERATOR","->",352],["T_STRING","order",352],"(",["T_CONSTANT_ENCAPSED_STRING","'tax_calculation_rule_id '",352],["T_WHITESPACE"," ",352],".",["T_WHITESPACE"," ",352],["T_STRING","Varien_Db_Select",352],["T_DOUBLE_COLON","::",352],["T_STRING","SQL_ASC",352],")",["T_WHITESPACE","\n                   ",352],["T_OBJECT_OPERATOR","->",353],["T_STRING","order",353],"(",["T_CONSTANT_ENCAPSED_STRING","'tax_country_id '",353],["T_WHITESPACE"," ",353],".",["T_WHITESPACE"," ",353],["T_STRING","Varien_Db_Select",353],["T_DOUBLE_COLON","::",353],["T_STRING","SQL_DESC",353],")",["T_WHITESPACE","\n                   ",353],["T_OBJECT_OPERATOR","->",354],["T_STRING","order",354],"(",["T_CONSTANT_ENCAPSED_STRING","'tax_region_id '",354],["T_WHITESPACE"," ",354],".",["T_WHITESPACE"," ",354],["T_STRING","Varien_Db_Select",354],["T_DOUBLE_COLON","::",354],["T_STRING","SQL_DESC",354],")",["T_WHITESPACE","\n                   ",354],["T_OBJECT_OPERATOR","->",355],["T_STRING","order",355],"(",["T_CONSTANT_ENCAPSED_STRING","'tax_postcode '",355],["T_WHITESPACE"," ",355],".",["T_WHITESPACE"," ",355],["T_STRING","Varien_Db_Select",355],["T_DOUBLE_COLON","::",355],["T_STRING","SQL_DESC",355],")",["T_WHITESPACE","\n                   ",355],["T_OBJECT_OPERATOR","->",356],["T_STRING","order",356],"(",["T_CONSTANT_ENCAPSED_STRING","'value '",356],["T_WHITESPACE"," ",356],".",["T_WHITESPACE"," ",356],["T_STRING","Varien_Db_Select",356],["T_DOUBLE_COLON","::",356],["T_STRING","SQL_DESC",356],")",";",["T_WHITESPACE","\n\n            ",356],["T_VARIABLE","$this",358],["T_OBJECT_OPERATOR","->",358],["T_STRING","_ratesCache",358],"[",["T_VARIABLE","$cacheKey",358],"]",["T_WHITESPACE"," ",358],"=",["T_WHITESPACE"," ",358],["T_VARIABLE","$this",358],["T_OBJECT_OPERATOR","->",358],["T_STRING","_getReadAdapter",358],"(",")",["T_OBJECT_OPERATOR","->",358],["T_STRING","fetchAll",358],"(",["T_VARIABLE","$select",358],")",";",["T_WHITESPACE","\n        ",358],"}",["T_WHITESPACE","\n\n        ",359],["T_RETURN","return",361],["T_WHITESPACE"," ",361],["T_VARIABLE","$this",361],["T_OBJECT_OPERATOR","->",361],["T_STRING","_ratesCache",361],"[",["T_VARIABLE","$cacheKey",361],"]",";",["T_WHITESPACE","\n    ",361],"}",["T_WHITESPACE","\n\n    ",362],["T_DOC_COMMENT","\/**\n     * Get rate ids applicable for some address\n     *\n     * @param Varien_Object $request\n     * @return array\n     *\/",364],["T_WHITESPACE","\n    ",369],["T_FUNCTION","function",370],["T_WHITESPACE"," ",370],["T_STRING","getApplicableRateIds",370],"(",["T_VARIABLE","$request",370],")",["T_WHITESPACE","\n    ",370],"{",["T_WHITESPACE","\n        ",371],["T_VARIABLE","$countryId",372],["T_WHITESPACE"," ",372],"=",["T_WHITESPACE"," ",372],["T_VARIABLE","$request",372],["T_OBJECT_OPERATOR","->",372],["T_STRING","getCountryId",372],"(",")",";",["T_WHITESPACE","\n        ",372],["T_VARIABLE","$regionId",373],["T_WHITESPACE"," ",373],"=",["T_WHITESPACE"," ",373],["T_VARIABLE","$request",373],["T_OBJECT_OPERATOR","->",373],["T_STRING","getRegionId",373],"(",")",";",["T_WHITESPACE","\n        ",373],["T_VARIABLE","$postcode",374],["T_WHITESPACE"," ",374],"=",["T_WHITESPACE"," ",374],["T_VARIABLE","$request",374],["T_OBJECT_OPERATOR","->",374],["T_STRING","getPostcode",374],"(",")",";",["T_WHITESPACE","\n\n        ",374],["T_VARIABLE","$select",376],["T_WHITESPACE"," ",376],"=",["T_WHITESPACE"," ",376],["T_VARIABLE","$this",376],["T_OBJECT_OPERATOR","->",376],["T_STRING","_getReadAdapter",376],"(",")",["T_OBJECT_OPERATOR","->",376],["T_STRING","select",376],"(",")",["T_WHITESPACE","\n            ",376],["T_OBJECT_OPERATOR","->",377],["T_STRING","from",377],"(",["T_ARRAY","array",377],"(",["T_CONSTANT_ENCAPSED_STRING","'rate'",377],["T_WHITESPACE"," ",377],["T_DOUBLE_ARROW","=>",377],["T_WHITESPACE"," ",377],["T_VARIABLE","$this",377],["T_OBJECT_OPERATOR","->",377],["T_STRING","getTable",377],"(",["T_CONSTANT_ENCAPSED_STRING","'tax\/tax_calculation_rate'",377],")",")",",",["T_WHITESPACE"," ",377],["T_ARRAY","array",377],"(",["T_CONSTANT_ENCAPSED_STRING","'tax_calculation_rate_id'",377],")",")",["T_WHITESPACE","\n            ",377],["T_OBJECT_OPERATOR","->",378],["T_STRING","where",378],"(",["T_CONSTANT_ENCAPSED_STRING","'rate.tax_country_id = ?'",378],",",["T_WHITESPACE"," ",378],["T_VARIABLE","$countryId",378],")",["T_WHITESPACE","\n            ",378],["T_OBJECT_OPERATOR","->",379],["T_STRING","where",379],"(",["T_CONSTANT_ENCAPSED_STRING","\"rate.tax_region_id IN(?)\"",379],",",["T_WHITESPACE"," ",379],["T_ARRAY","array",379],"(",["T_LNUMBER","0",379],",",["T_WHITESPACE"," ",379],["T_INT_CAST","(int)",379],["T_VARIABLE","$regionId",379],")",")",";",["T_WHITESPACE","\n\n        ",379],["T_VARIABLE","$expr",381],["T_WHITESPACE"," ",381],"=",["T_WHITESPACE"," ",381],["T_VARIABLE","$this",381],["T_OBJECT_OPERATOR","->",381],["T_STRING","_getWriteAdapter",381],"(",")",["T_OBJECT_OPERATOR","->",381],["T_STRING","getCheckSql",381],"(",["T_WHITESPACE","\n            ",381],["T_CONSTANT_ENCAPSED_STRING","'zip_is_range is NULL'",382],",",["T_WHITESPACE","\n            ",382],["T_VARIABLE","$this",383],["T_OBJECT_OPERATOR","->",383],["T_STRING","_getWriteAdapter",383],"(",")",["T_OBJECT_OPERATOR","->",383],["T_STRING","quoteInto",383],"(",["T_WHITESPACE","\n                ",383],["T_CONSTANT_ENCAPSED_STRING","\"rate.tax_postcode IS NULL OR rate.tax_postcode IN('*', '', ?)\"",384],",",["T_WHITESPACE","\n                ",384],["T_VARIABLE","$this",385],["T_OBJECT_OPERATOR","->",385],["T_STRING","_createSearchPostCodeTemplates",385],"(",["T_VARIABLE","$postcode",385],")",["T_WHITESPACE","\n            ",385],")",",",["T_WHITESPACE","\n            ",386],["T_VARIABLE","$this",387],["T_OBJECT_OPERATOR","->",387],["T_STRING","_getWriteAdapter",387],"(",")",["T_OBJECT_OPERATOR","->",387],["T_STRING","quoteInto",387],"(",["T_CONSTANT_ENCAPSED_STRING","'? BETWEEN rate.zip_from AND rate.zip_to'",387],",",["T_WHITESPACE"," ",387],["T_VARIABLE","$postcode",387],")",["T_WHITESPACE","\n        ",387],")",";",["T_WHITESPACE","\n        ",388],["T_VARIABLE","$select",389],["T_OBJECT_OPERATOR","->",389],["T_STRING","where",389],"(",["T_VARIABLE","$expr",389],")",";",["T_WHITESPACE","\n        ",389],["T_VARIABLE","$select",390],["T_OBJECT_OPERATOR","->",390],["T_STRING","order",390],"(",["T_CONSTANT_ENCAPSED_STRING","'tax_calculation_rate_id'",390],")",";",["T_WHITESPACE","\n        ",390],["T_RETURN","return",391],["T_WHITESPACE"," ",391],["T_VARIABLE","$this",391],["T_OBJECT_OPERATOR","->",391],["T_STRING","_getReadAdapter",391],"(",")",["T_OBJECT_OPERATOR","->",391],["T_STRING","fetchCol",391],"(",["T_VARIABLE","$select",391],")",";",["T_WHITESPACE","\n    ",391],"}",["T_WHITESPACE","\n\n    ",392],["T_DOC_COMMENT","\/**\n     * Calculate rate\n     *\n     * @param array $rates\n     * @return int\n     *\/",394],["T_WHITESPACE","\n    ",399],["T_PROTECTED","protected",400],["T_WHITESPACE"," ",400],["T_FUNCTION","function",400],["T_WHITESPACE"," ",400],["T_STRING","_calculateRate",400],"(",["T_VARIABLE","$rates",400],")",["T_WHITESPACE","\n    ",400],"{",["T_WHITESPACE","\n        ",401],["T_VARIABLE","$result",402],["T_WHITESPACE","      ",402],"=",["T_WHITESPACE"," ",402],["T_LNUMBER","0",402],";",["T_WHITESPACE","\n        ",402],["T_VARIABLE","$currentRate",403],["T_WHITESPACE"," ",403],"=",["T_WHITESPACE"," ",403],["T_LNUMBER","0",403],";",["T_WHITESPACE","\n        ",403],["T_VARIABLE","$countedRates",404],["T_WHITESPACE"," ",404],"=",["T_WHITESPACE"," ",404],["T_STRING","count",404],"(",["T_VARIABLE","$rates",404],")",";",["T_WHITESPACE","\n        ",404],["T_FOR","for",405],["T_WHITESPACE"," ",405],"(",["T_VARIABLE","$i",405],["T_WHITESPACE"," ",405],"=",["T_WHITESPACE"," ",405],["T_LNUMBER","0",405],";",["T_WHITESPACE"," ",405],["T_VARIABLE","$i",405],["T_WHITESPACE"," ",405],"<",["T_WHITESPACE"," ",405],["T_VARIABLE","$countedRates",405],";",["T_WHITESPACE"," ",405],["T_VARIABLE","$i",405],["T_INC","++",405],")",["T_WHITESPACE"," ",405],"{",["T_WHITESPACE","\n            ",405],["T_VARIABLE","$rate",406],["T_WHITESPACE","       ",406],"=",["T_WHITESPACE"," ",406],["T_VARIABLE","$rates",406],"[",["T_VARIABLE","$i",406],"]",";",["T_WHITESPACE","\n            ",406],["T_VARIABLE","$rule",407],["T_WHITESPACE","       ",407],"=",["T_WHITESPACE"," ",407],["T_VARIABLE","$rate",407],"[",["T_CONSTANT_ENCAPSED_STRING","'tax_calculation_rule_id'",407],"]",";",["T_WHITESPACE","\n            ",407],["T_VARIABLE","$value",408],["T_WHITESPACE","      ",408],"=",["T_WHITESPACE"," ",408],["T_VARIABLE","$rate",408],"[",["T_CONSTANT_ENCAPSED_STRING","'value'",408],"]",";",["T_WHITESPACE","\n            ",408],["T_VARIABLE","$priority",409],["T_WHITESPACE","   ",409],"=",["T_WHITESPACE"," ",409],["T_VARIABLE","$rate",409],"[",["T_CONSTANT_ENCAPSED_STRING","'priority'",409],"]",";",["T_WHITESPACE","\n\n            ",409],["T_WHILE","while",411],["T_WHITESPACE"," ",411],"(",["T_ISSET","isset",411],"(",["T_VARIABLE","$rates",411],"[",["T_VARIABLE","$i",411],["T_WHITESPACE"," ",411],"+",["T_WHITESPACE"," ",411],["T_LNUMBER","1",411],"]",")",["T_WHITESPACE"," ",411],["T_BOOLEAN_AND","&&",411],["T_WHITESPACE"," ",411],["T_VARIABLE","$rates",411],"[",["T_VARIABLE","$i",411],["T_WHITESPACE"," ",411],"+",["T_WHITESPACE"," ",411],["T_LNUMBER","1",411],"]","[",["T_CONSTANT_ENCAPSED_STRING","'tax_calculation_rule_id'",411],"]",["T_WHITESPACE"," ",411],["T_IS_EQUAL","==",411],["T_WHITESPACE"," ",411],["T_VARIABLE","$rule",411],")",["T_WHITESPACE"," ",411],"{",["T_WHITESPACE","\n                ",411],["T_VARIABLE","$i",412],["T_INC","++",412],";",["T_WHITESPACE","\n            ",412],"}",["T_WHITESPACE","\n\n            ",413],["T_VARIABLE","$currentRate",415],["T_WHITESPACE"," ",415],["T_PLUS_EQUAL","+=",415],["T_WHITESPACE"," ",415],["T_VARIABLE","$value",415],";",["T_WHITESPACE","\n\n            ",415],["T_IF","if",417],["T_WHITESPACE"," ",417],"(","!",["T_ISSET","isset",417],"(",["T_VARIABLE","$rates",417],"[",["T_VARIABLE","$i",417],["T_WHITESPACE"," ",417],"+",["T_WHITESPACE"," ",417],["T_LNUMBER","1",417],"]",")",["T_WHITESPACE"," ",417],["T_BOOLEAN_OR","||",417],["T_WHITESPACE"," ",417],["T_VARIABLE","$rates",417],"[",["T_VARIABLE","$i",417],["T_WHITESPACE"," ",417],"+",["T_WHITESPACE"," ",417],["T_LNUMBER","1",417],"]","[",["T_CONSTANT_ENCAPSED_STRING","'priority'",417],"]",["T_WHITESPACE"," ",417],["T_IS_NOT_EQUAL","!=",417],["T_WHITESPACE"," ",417],["T_VARIABLE","$priority",417],")",["T_WHITESPACE"," ",417],"{",["T_WHITESPACE","\n                ",417],["T_IF","if",418],["T_WHITESPACE"," ",418],"(","!",["T_EMPTY","empty",418],"(",["T_VARIABLE","$rates",418],"[",["T_VARIABLE","$i",418],"]","[",["T_CONSTANT_ENCAPSED_STRING","'calculate_subtotal'",418],"]",")",")",["T_WHITESPACE"," ",418],"{",["T_WHITESPACE","\n                    ",418],["T_VARIABLE","$result",419],["T_WHITESPACE"," ",419],["T_PLUS_EQUAL","+=",419],["T_WHITESPACE"," ",419],["T_VARIABLE","$currentRate",419],";",["T_WHITESPACE","\n                ",419],"}",["T_WHITESPACE"," ",420],["T_ELSE","else",420],["T_WHITESPACE"," ",420],"{",["T_WHITESPACE","\n                    ",420],["T_VARIABLE","$result",421],["T_WHITESPACE"," ",421],["T_PLUS_EQUAL","+=",421],["T_WHITESPACE"," ",421],["T_VARIABLE","$this",421],["T_OBJECT_OPERATOR","->",421],["T_STRING","_collectPercent",421],"(",["T_VARIABLE","$result",421],",",["T_WHITESPACE"," ",421],["T_VARIABLE","$currentRate",421],")",";",["T_WHITESPACE","\n                ",421],"}",["T_WHITESPACE","\n                ",422],["T_VARIABLE","$currentRate",423],["T_WHITESPACE"," ",423],"=",["T_WHITESPACE"," ",423],["T_LNUMBER","0",423],";",["T_WHITESPACE","\n            ",423],"}",["T_WHITESPACE","\n        ",424],"}",["T_WHITESPACE","\n\n        ",425],["T_RETURN","return",427],["T_WHITESPACE"," ",427],["T_VARIABLE","$result",427],";",["T_WHITESPACE","\n    ",427],"}",["T_WHITESPACE","\n\n    ",428],["T_DOC_COMMENT","\/**\n     * Retrieve rate ids\n     *\n     * @param Varien_Object $request\n     * @return array\n     *\/",430],["T_WHITESPACE","\n    ",435],["T_PUBLIC","public",436],["T_WHITESPACE"," ",436],["T_FUNCTION","function",436],["T_WHITESPACE"," ",436],["T_STRING","getRateIds",436],"(",["T_VARIABLE","$request",436],")",["T_WHITESPACE","\n    ",436],"{",["T_WHITESPACE","\n        ",437],["T_VARIABLE","$result",438],["T_WHITESPACE"," ",438],"=",["T_WHITESPACE"," ",438],["T_ARRAY","array",438],"(",")",";",["T_WHITESPACE","\n        ",438],["T_VARIABLE","$rates",439],["T_WHITESPACE","  ",439],"=",["T_WHITESPACE"," ",439],["T_VARIABLE","$this",439],["T_OBJECT_OPERATOR","->",439],["T_STRING","_getRates",439],"(",["T_VARIABLE","$request",439],")",";",["T_WHITESPACE","\n        ",439],["T_VARIABLE","$countedRates",440],["T_WHITESPACE"," ",440],"=",["T_WHITESPACE"," ",440],["T_STRING","count",440],"(",["T_VARIABLE","$rates",440],")",";",["T_WHITESPACE","\n        ",440],["T_FOR","for",441],["T_WHITESPACE"," ",441],"(",["T_VARIABLE","$i",441],["T_WHITESPACE"," ",441],"=",["T_WHITESPACE"," ",441],["T_LNUMBER","0",441],";",["T_WHITESPACE"," ",441],["T_VARIABLE","$i",441],["T_WHITESPACE"," ",441],"<",["T_WHITESPACE"," ",441],["T_VARIABLE","$countedRates",441],";",["T_WHITESPACE"," ",441],["T_VARIABLE","$i",441],["T_INC","++",441],")",["T_WHITESPACE"," ",441],"{",["T_WHITESPACE","\n            ",441],["T_VARIABLE","$rate",442],["T_WHITESPACE"," ",442],"=",["T_WHITESPACE"," ",442],["T_VARIABLE","$rates",442],"[",["T_VARIABLE","$i",442],"]",";",["T_WHITESPACE","\n            ",442],["T_VARIABLE","$rule",443],["T_WHITESPACE"," ",443],"=",["T_WHITESPACE"," ",443],["T_VARIABLE","$rate",443],"[",["T_CONSTANT_ENCAPSED_STRING","'tax_calculation_rule_id'",443],"]",";",["T_WHITESPACE","\n            ",443],["T_VARIABLE","$result",444],"[","]",["T_WHITESPACE"," ",444],"=",["T_WHITESPACE"," ",444],["T_VARIABLE","$rate",444],"[",["T_CONSTANT_ENCAPSED_STRING","'tax_calculation_rate_id'",444],"]",";",["T_WHITESPACE","\n            ",444],["T_WHILE","while",445],["T_WHITESPACE"," ",445],"(",["T_ISSET","isset",445],"(",["T_VARIABLE","$rates",445],"[",["T_VARIABLE","$i",445],["T_WHITESPACE"," ",445],"+",["T_WHITESPACE"," ",445],["T_LNUMBER","1",445],"]",")",["T_WHITESPACE"," ",445],["T_BOOLEAN_AND","&&",445],["T_WHITESPACE"," ",445],["T_VARIABLE","$rates",445],"[",["T_VARIABLE","$i",445],["T_WHITESPACE"," ",445],"+",["T_WHITESPACE"," ",445],["T_LNUMBER","1",445],"]","[",["T_CONSTANT_ENCAPSED_STRING","'tax_calculation_rule_id'",445],"]",["T_WHITESPACE"," ",445],["T_IS_EQUAL","==",445],["T_WHITESPACE"," ",445],["T_VARIABLE","$rule",445],")",["T_WHITESPACE"," ",445],"{",["T_WHITESPACE","\n                ",445],["T_VARIABLE","$i",446],["T_INC","++",446],";",["T_WHITESPACE","\n            ",446],"}",["T_WHITESPACE","\n        ",447],"}",["T_WHITESPACE","\n\n        ",448],["T_RETURN","return",450],["T_WHITESPACE"," ",450],["T_VARIABLE","$result",450],";",["T_WHITESPACE","\n    ",450],"}",["T_WHITESPACE","\n\n    ",451],["T_DOC_COMMENT","\/**\n     * Retrieve rates by customer tax class\n     *\n     * @param int $customerTaxClassId\n     * @param int $productTaxClassId\n     * @return array\n     *\/",453],["T_WHITESPACE","\n    ",459],["T_PUBLIC","public",460],["T_WHITESPACE"," ",460],["T_FUNCTION","function",460],["T_WHITESPACE"," ",460],["T_STRING","getRatesByCustomerTaxClass",460],"(",["T_VARIABLE","$customerTaxClass",460],",",["T_WHITESPACE"," ",460],["T_VARIABLE","$productTaxClass",460],["T_WHITESPACE"," ",460],"=",["T_WHITESPACE"," ",460],["T_STRING","null",460],")",["T_WHITESPACE","\n    ",460],"{",["T_WHITESPACE","\n        ",461],["T_VARIABLE","$adapter",462],["T_WHITESPACE"," ",462],"=",["T_WHITESPACE"," ",462],["T_VARIABLE","$this",462],["T_OBJECT_OPERATOR","->",462],["T_STRING","_getReadAdapter",462],"(",")",";",["T_WHITESPACE","\n        ",462],["T_VARIABLE","$customerTaxClassId",463],["T_WHITESPACE"," ",463],"=",["T_WHITESPACE"," ",463],["T_INT_CAST","(int)",463],["T_VARIABLE","$customerTaxClass",463],";",["T_WHITESPACE","\n        ",463],["T_VARIABLE","$calcJoinConditions",464],["T_WHITESPACE"," ",464],"=",["T_WHITESPACE"," ",464],["T_ARRAY","array",464],"(",["T_WHITESPACE","\n            ",464],["T_CONSTANT_ENCAPSED_STRING","'calc_table.tax_calculation_rate_id = main_table.tax_calculation_rate_id'",465],",",["T_WHITESPACE","\n            ",465],["T_VARIABLE","$adapter",466],["T_OBJECT_OPERATOR","->",466],["T_STRING","quoteInto",466],"(",["T_CONSTANT_ENCAPSED_STRING","'calc_table.customer_tax_class_id = ?'",466],",",["T_WHITESPACE"," ",466],["T_VARIABLE","$customerTaxClassId",466],")",",",["T_WHITESPACE","\n\n        ",466],")",";",["T_WHITESPACE","\n        ",468],["T_IF","if",469],["T_WHITESPACE"," ",469],"(",["T_VARIABLE","$productTaxClass",469],["T_WHITESPACE"," ",469],["T_IS_NOT_IDENTICAL","!==",469],["T_WHITESPACE"," ",469],["T_STRING","null",469],")",["T_WHITESPACE"," ",469],"{",["T_WHITESPACE","\n            ",469],["T_VARIABLE","$productTaxClassId",470],["T_WHITESPACE"," ",470],"=",["T_WHITESPACE"," ",470],["T_INT_CAST","(int)",470],["T_VARIABLE","$productTaxClass",470],";",["T_WHITESPACE","\n            ",470],["T_VARIABLE","$calcJoinConditions",471],"[","]",["T_WHITESPACE"," ",471],"=",["T_WHITESPACE"," ",471],["T_VARIABLE","$adapter",471],["T_OBJECT_OPERATOR","->",471],["T_STRING","quoteInto",471],"(",["T_CONSTANT_ENCAPSED_STRING","'calc_table.product_tax_class_id = ?'",471],",",["T_WHITESPACE"," ",471],["T_VARIABLE","$productTaxClassId",471],")",";",["T_WHITESPACE","\n        ",471],"}",["T_WHITESPACE","\n\n        ",472],["T_VARIABLE","$selectCSP",474],["T_WHITESPACE"," ",474],"=",["T_WHITESPACE"," ",474],["T_VARIABLE","$adapter",474],["T_OBJECT_OPERATOR","->",474],["T_STRING","select",474],"(",")",";",["T_WHITESPACE","\n        ",474],["T_VARIABLE","$selectCSP",475],["T_WHITESPACE","\n            ",475],["T_OBJECT_OPERATOR","->",476],["T_STRING","from",476],"(",["T_WHITESPACE","\n                ",476],["T_ARRAY","array",477],"(",["T_CONSTANT_ENCAPSED_STRING","'main_table'",477],["T_WHITESPACE"," ",477],["T_DOUBLE_ARROW","=>",477],["T_WHITESPACE"," ",477],["T_VARIABLE","$this",477],["T_OBJECT_OPERATOR","->",477],["T_STRING","getTable",477],"(",["T_CONSTANT_ENCAPSED_STRING","'tax\/tax_calculation_rate'",477],")",")",",",["T_WHITESPACE","\n                ",477],["T_ARRAY","array",478],"(",["T_CONSTANT_ENCAPSED_STRING","'country'",478],["T_WHITESPACE"," ",478],["T_DOUBLE_ARROW","=>",478],["T_WHITESPACE"," ",478],["T_CONSTANT_ENCAPSED_STRING","'tax_country_id'",478],",",["T_WHITESPACE"," ",478],["T_CONSTANT_ENCAPSED_STRING","'region_id'",478],["T_WHITESPACE"," ",478],["T_DOUBLE_ARROW","=>",478],["T_WHITESPACE"," ",478],["T_CONSTANT_ENCAPSED_STRING","'tax_region_id'",478],",",["T_WHITESPACE"," ",478],["T_CONSTANT_ENCAPSED_STRING","'postcode'",478],["T_WHITESPACE"," ",478],["T_DOUBLE_ARROW","=>",478],["T_WHITESPACE"," ",478],["T_CONSTANT_ENCAPSED_STRING","'tax_postcode'",478],")",")",["T_WHITESPACE","\n            ",478],["T_OBJECT_OPERATOR","->",479],["T_STRING","joinInner",479],"(",["T_WHITESPACE","\n                ",479],["T_ARRAY","array",480],"(",["T_CONSTANT_ENCAPSED_STRING","'calc_table'",480],["T_WHITESPACE"," ",480],["T_DOUBLE_ARROW","=>",480],["T_WHITESPACE"," ",480],["T_VARIABLE","$this",480],["T_OBJECT_OPERATOR","->",480],["T_STRING","getTable",480],"(",["T_CONSTANT_ENCAPSED_STRING","'tax\/tax_calculation'",480],")",")",",",["T_WHITESPACE","\n                ",480],["T_STRING","implode",481],"(",["T_CONSTANT_ENCAPSED_STRING","' AND '",481],",",["T_WHITESPACE"," ",481],["T_VARIABLE","$calcJoinConditions",481],")",",",["T_WHITESPACE","\n                ",481],["T_ARRAY","array",482],"(",["T_CONSTANT_ENCAPSED_STRING","'product_class'",482],["T_WHITESPACE"," ",482],["T_DOUBLE_ARROW","=>",482],["T_WHITESPACE"," ",482],["T_CONSTANT_ENCAPSED_STRING","'calc_table.product_tax_class_id'",482],")",")",["T_WHITESPACE","\n            ",482],["T_OBJECT_OPERATOR","->",483],["T_STRING","joinLeft",483],"(",["T_WHITESPACE","\n                ",483],["T_ARRAY","array",484],"(",["T_CONSTANT_ENCAPSED_STRING","'state_table'",484],["T_WHITESPACE"," ",484],["T_DOUBLE_ARROW","=>",484],["T_WHITESPACE"," ",484],["T_VARIABLE","$this",484],["T_OBJECT_OPERATOR","->",484],["T_STRING","getTable",484],"(",["T_CONSTANT_ENCAPSED_STRING","'directory\/country_region'",484],")",")",",",["T_WHITESPACE","\n                ",484],["T_CONSTANT_ENCAPSED_STRING","'state_table.region_id = main_table.tax_region_id'",485],",",["T_WHITESPACE","\n                ",485],["T_ARRAY","array",486],"(",["T_CONSTANT_ENCAPSED_STRING","'region_code'",486],["T_WHITESPACE"," ",486],["T_DOUBLE_ARROW","=>",486],["T_WHITESPACE"," ",486],["T_CONSTANT_ENCAPSED_STRING","'state_table.code'",486],")",")",["T_WHITESPACE","\n            ",486],["T_OBJECT_OPERATOR","->",487],["T_STRING","distinct",487],"(",["T_STRING","true",487],")",";",["T_WHITESPACE","\n\n        ",487],["T_VARIABLE","$CSP",489],["T_WHITESPACE"," ",489],"=",["T_WHITESPACE"," ",489],["T_VARIABLE","$adapter",489],["T_OBJECT_OPERATOR","->",489],["T_STRING","fetchAll",489],"(",["T_VARIABLE","$selectCSP",489],")",";",["T_WHITESPACE","\n\n        ",489],["T_VARIABLE","$result",491],["T_WHITESPACE"," ",491],"=",["T_WHITESPACE"," ",491],["T_ARRAY","array",491],"(",")",";",["T_WHITESPACE","\n        ",491],["T_FOREACH","foreach",492],["T_WHITESPACE"," ",492],"(",["T_VARIABLE","$CSP",492],["T_WHITESPACE"," ",492],["T_AS","as",492],["T_WHITESPACE"," ",492],["T_VARIABLE","$one",492],")",["T_WHITESPACE"," ",492],"{",["T_WHITESPACE","\n            ",492],["T_VARIABLE","$request",493],["T_WHITESPACE"," ",493],"=",["T_WHITESPACE"," ",493],["T_NEW","new",493],["T_WHITESPACE"," ",493],["T_STRING","Varien_Object",493],"(",")",";",["T_WHITESPACE","\n            ",493],["T_VARIABLE","$request",494],["T_OBJECT_OPERATOR","->",494],["T_STRING","setCountryId",494],"(",["T_VARIABLE","$one",494],"[",["T_CONSTANT_ENCAPSED_STRING","'country'",494],"]",")",["T_WHITESPACE","\n                ",494],["T_OBJECT_OPERATOR","->",495],["T_STRING","setRegionId",495],"(",["T_VARIABLE","$one",495],"[",["T_CONSTANT_ENCAPSED_STRING","'region_id'",495],"]",")",["T_WHITESPACE","\n                ",495],["T_OBJECT_OPERATOR","->",496],["T_STRING","setPostcode",496],"(",["T_VARIABLE","$one",496],"[",["T_CONSTANT_ENCAPSED_STRING","'postcode'",496],"]",")",["T_WHITESPACE","\n                ",496],["T_OBJECT_OPERATOR","->",497],["T_STRING","setCustomerClassId",497],"(",["T_VARIABLE","$customerTaxClassId",497],")",["T_WHITESPACE","\n                ",497],["T_OBJECT_OPERATOR","->",498],["T_STRING","setProductClassId",498],"(",["T_VARIABLE","$one",498],"[",["T_CONSTANT_ENCAPSED_STRING","'product_class'",498],"]",")",";",["T_WHITESPACE","\n\n            ",498],["T_VARIABLE","$rate",500],["T_WHITESPACE"," ",500],"=",["T_WHITESPACE"," ",500],["T_VARIABLE","$this",500],["T_OBJECT_OPERATOR","->",500],["T_STRING","getRate",500],"(",["T_VARIABLE","$request",500],")",";",["T_WHITESPACE","\n            ",500],["T_IF","if",501],["T_WHITESPACE"," ",501],"(",["T_VARIABLE","$rate",501],")",["T_WHITESPACE"," ",501],"{",["T_WHITESPACE","\n                ",501],["T_VARIABLE","$row",502],["T_WHITESPACE"," ",502],"=",["T_WHITESPACE"," ",502],["T_ARRAY","array",502],"(",["T_WHITESPACE","\n                    ",502],["T_CONSTANT_ENCAPSED_STRING","'value'",503],["T_WHITESPACE","         ",503],["T_DOUBLE_ARROW","=>",503],["T_WHITESPACE"," ",503],["T_VARIABLE","$rate",503],"\/",["T_LNUMBER","100",503],",",["T_WHITESPACE","\n                    ",503],["T_CONSTANT_ENCAPSED_STRING","'country'",504],["T_WHITESPACE","       ",504],["T_DOUBLE_ARROW","=>",504],["T_WHITESPACE"," ",504],["T_VARIABLE","$one",504],"[",["T_CONSTANT_ENCAPSED_STRING","'country'",504],"]",",",["T_WHITESPACE","\n                    ",504],["T_CONSTANT_ENCAPSED_STRING","'state'",505],["T_WHITESPACE","         ",505],["T_DOUBLE_ARROW","=>",505],["T_WHITESPACE"," ",505],["T_VARIABLE","$one",505],"[",["T_CONSTANT_ENCAPSED_STRING","'region_code'",505],"]",",",["T_WHITESPACE","\n                    ",505],["T_CONSTANT_ENCAPSED_STRING","'postcode'",506],["T_WHITESPACE","      ",506],["T_DOUBLE_ARROW","=>",506],["T_WHITESPACE"," ",506],["T_VARIABLE","$one",506],"[",["T_CONSTANT_ENCAPSED_STRING","'postcode'",506],"]",",",["T_WHITESPACE","\n                    ",506],["T_CONSTANT_ENCAPSED_STRING","'product_class'",507],["T_WHITESPACE"," ",507],["T_DOUBLE_ARROW","=>",507],["T_WHITESPACE"," ",507],["T_VARIABLE","$one",507],"[",["T_CONSTANT_ENCAPSED_STRING","'product_class'",507],"]",",",["T_WHITESPACE","\n                ",507],")",";",["T_WHITESPACE","\n\n                ",508],["T_VARIABLE","$result",510],"[","]",["T_WHITESPACE"," ",510],"=",["T_WHITESPACE"," ",510],["T_VARIABLE","$row",510],";",["T_WHITESPACE","\n            ",510],"}",["T_WHITESPACE","\n        ",511],"}",["T_WHITESPACE","\n\n        ",512],["T_RETURN","return",514],["T_WHITESPACE"," ",514],["T_VARIABLE","$result",514],";",["T_WHITESPACE","\n    ",514],"}",["T_WHITESPACE","\n",515],"}",["T_WHITESPACE","\n",516]]