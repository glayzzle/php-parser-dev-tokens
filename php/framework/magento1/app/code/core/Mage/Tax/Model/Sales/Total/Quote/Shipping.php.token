[["T_OPEN_TAG","<?php\n",1],["T_DOC_COMMENT","\/**\n * Magento\n *\n * NOTICE OF LICENSE\n *\n * This source file is subject to the Open Software License (OSL 3.0)\n * that is bundled with this package in the file LICENSE.txt.\n * It is also available through the world-wide-web at this URL:\n * http:\/\/opensource.org\/licenses\/osl-3.0.php\n * If you did not receive a copy of the license and are unable to\n * obtain it through the world-wide-web, please send an email\n * to license@magento.com so we can send you a copy immediately.\n *\n * DISCLAIMER\n *\n * Do not edit or add to this file if you wish to upgrade Magento to newer\n * versions in the future. If you wish to customize Magento for your\n * needs please refer to http:\/\/www.magento.com for more information.\n *\n * @category    Mage\n * @package     Mage_Tax\n * @copyright  Copyright (c) 2006-2016 X.commerce, Inc. and affiliates (http:\/\/www.magento.com)\n * @license    http:\/\/opensource.org\/licenses\/osl-3.0.php  Open Software License (OSL 3.0)\n *\/",2],["T_WHITESPACE","\n\n",25],["T_DOC_COMMENT","\/**\n * Model to calculate shipping tax\n *\n * @category    Mage\n * @package     Mage_Tax\n * @author      Magento Core Team\n *\/",27],["T_WHITESPACE","\n",33],["T_CLASS","class",34],["T_WHITESPACE"," ",34],["T_STRING","Mage_Tax_Model_Sales_Total_Quote_Shipping",34],["T_WHITESPACE"," ",34],["T_EXTENDS","extends",34],["T_WHITESPACE"," ",34],["T_STRING","Mage_Sales_Model_Quote_Address_Total_Abstract",34],["T_WHITESPACE","\n",34],"{",["T_WHITESPACE","\n    ",35],["T_DOC_COMMENT","\/**\n     * Tax calculation model\n     *\n     * @var Mage_Tax_Model_Calculation\n     *\/",36],["T_WHITESPACE","\n    ",40],["T_PROTECTED","protected",41],["T_WHITESPACE"," ",41],["T_VARIABLE","$_calculator",41],["T_WHITESPACE"," ",41],"=",["T_WHITESPACE"," ",41],["T_STRING","null",41],";",["T_WHITESPACE","\n\n    ",41],["T_DOC_COMMENT","\/**\n     * Tax configuration object\n     *\n     * @var Mage_Tax_Model_Config\n     *\/",43],["T_WHITESPACE","\n    ",47],["T_PROTECTED","protected",48],["T_WHITESPACE"," ",48],["T_VARIABLE","$_config",48],["T_WHITESPACE"," ",48],"=",["T_WHITESPACE"," ",48],["T_STRING","null",48],";",["T_WHITESPACE","\n\n    ",48],["T_DOC_COMMENT","\/**\n     * Tax helper instance\n     *\n     * @var Mage_Tax_Helper_Data|null\n     *\/",50],["T_WHITESPACE","\n    ",54],["T_PROTECTED","protected",55],["T_WHITESPACE"," ",55],["T_VARIABLE","$_helper",55],["T_WHITESPACE"," ",55],"=",["T_WHITESPACE"," ",55],["T_STRING","null",55],";",["T_WHITESPACE","\n\n    ",55],["T_DOC_COMMENT","\/**\n     * Flag which is initialized when collect method is started and catalog prices include tax.\n     * It is used for checking if store tax and customer tax requests are similar\n     *\n     * @var bool\n     *\/",57],["T_WHITESPACE","\n    ",62],["T_PROTECTED","protected",63],["T_WHITESPACE"," ",63],["T_VARIABLE","$_areTaxRequestsSimilar",63],["T_WHITESPACE"," ",63],"=",["T_WHITESPACE"," ",63],["T_STRING","false",63],";",["T_WHITESPACE","\n\n    ",63],["T_DOC_COMMENT","\/**\n     * Request which can be used for tax rate calculation\n     *\n     * @var Varien_Object\n     *\/",65],["T_WHITESPACE","\n    ",69],["T_PROTECTED","protected",70],["T_WHITESPACE"," ",70],["T_VARIABLE","$_storeTaxRequest",70],["T_WHITESPACE"," ",70],"=",["T_WHITESPACE"," ",70],["T_STRING","null",70],";",["T_WHITESPACE","\n\n    ",70],["T_DOC_COMMENT","\/**\n     * Class constructor\n     *\/",72],["T_WHITESPACE","\n    ",74],["T_PUBLIC","public",75],["T_WHITESPACE"," ",75],["T_FUNCTION","function",75],["T_WHITESPACE"," ",75],["T_STRING","__construct",75],"(",")",["T_WHITESPACE","\n    ",75],"{",["T_WHITESPACE","\n        ",76],["T_VARIABLE","$this",77],["T_OBJECT_OPERATOR","->",77],["T_STRING","setCode",77],"(",["T_CONSTANT_ENCAPSED_STRING","'shipping'",77],")",";",["T_WHITESPACE","\n        ",77],["T_VARIABLE","$this",78],["T_OBJECT_OPERATOR","->",78],["T_STRING","_calculator",78],["T_WHITESPACE","  ",78],"=",["T_WHITESPACE"," ",78],["T_STRING","Mage",78],["T_DOUBLE_COLON","::",78],["T_STRING","getSingleton",78],"(",["T_CONSTANT_ENCAPSED_STRING","'tax\/calculation'",78],")",";",["T_WHITESPACE","\n        ",78],["T_VARIABLE","$this",79],["T_OBJECT_OPERATOR","->",79],["T_STRING","_helper",79],["T_WHITESPACE","      ",79],"=",["T_WHITESPACE"," ",79],["T_STRING","Mage",79],["T_DOUBLE_COLON","::",79],["T_STRING","helper",79],"(",["T_CONSTANT_ENCAPSED_STRING","'tax'",79],")",";",["T_WHITESPACE","\n        ",79],["T_VARIABLE","$this",80],["T_OBJECT_OPERATOR","->",80],["T_STRING","_config",80],["T_WHITESPACE","      ",80],"=",["T_WHITESPACE"," ",80],["T_STRING","Mage",80],["T_DOUBLE_COLON","::",80],["T_STRING","getSingleton",80],"(",["T_CONSTANT_ENCAPSED_STRING","'tax\/config'",80],")",";",["T_WHITESPACE","\n    ",80],"}",["T_WHITESPACE","\n\n    ",81],["T_DOC_COMMENT","\/**\n     * Collect totals information about shipping\n     *\n     * @param   Mage_Sales_Model_Quote_Address $address\n     * @return  Mage_Sales_Model_Quote_Address_Total_Shipping\n     *\/",83],["T_WHITESPACE","\n    ",88],["T_PUBLIC","public",89],["T_WHITESPACE"," ",89],["T_FUNCTION","function",89],["T_WHITESPACE"," ",89],["T_STRING","collect",89],"(",["T_STRING","Mage_Sales_Model_Quote_Address",89],["T_WHITESPACE"," ",89],["T_VARIABLE","$address",89],")",["T_WHITESPACE","\n    ",89],"{",["T_WHITESPACE","\n        ",90],["T_STRING","parent",91],["T_DOUBLE_COLON","::",91],["T_STRING","collect",91],"(",["T_VARIABLE","$address",91],")",";",["T_WHITESPACE","\n        ",91],["T_VARIABLE","$calc",92],["T_WHITESPACE","               ",92],"=",["T_WHITESPACE"," ",92],["T_VARIABLE","$this",92],["T_OBJECT_OPERATOR","->",92],["T_STRING","_calculator",92],";",["T_WHITESPACE","\n        ",92],["T_VARIABLE","$store",93],["T_WHITESPACE","              ",93],"=",["T_WHITESPACE"," ",93],["T_VARIABLE","$address",93],["T_OBJECT_OPERATOR","->",93],["T_STRING","getQuote",93],"(",")",["T_OBJECT_OPERATOR","->",93],["T_STRING","getStore",93],"(",")",";",["T_WHITESPACE","\n        ",93],["T_VARIABLE","$storeTaxRequest",94],["T_WHITESPACE","    ",94],"=",["T_WHITESPACE"," ",94],["T_VARIABLE","$calc",94],["T_OBJECT_OPERATOR","->",94],["T_STRING","getRateOriginRequest",94],"(",["T_VARIABLE","$store",94],")",";",["T_WHITESPACE","\n        ",94],["T_VARIABLE","$addressTaxRequest",95],["T_WHITESPACE","  ",95],"=",["T_WHITESPACE"," ",95],["T_VARIABLE","$calc",95],["T_OBJECT_OPERATOR","->",95],["T_STRING","getRateRequest",95],"(",["T_WHITESPACE","\n            ",95],["T_VARIABLE","$address",96],",",["T_WHITESPACE","\n            ",96],["T_VARIABLE","$address",97],["T_OBJECT_OPERATOR","->",97],["T_STRING","getQuote",97],"(",")",["T_OBJECT_OPERATOR","->",97],["T_STRING","getBillingAddress",97],"(",")",",",["T_WHITESPACE","\n            ",97],["T_VARIABLE","$address",98],["T_OBJECT_OPERATOR","->",98],["T_STRING","getQuote",98],"(",")",["T_OBJECT_OPERATOR","->",98],["T_STRING","getCustomerTaxClassId",98],"(",")",",",["T_WHITESPACE","\n            ",98],["T_VARIABLE","$store",99],["T_WHITESPACE","\n        ",99],")",";",["T_WHITESPACE","\n\n        ",100],["T_VARIABLE","$shippingTaxClass",102],["T_WHITESPACE"," ",102],"=",["T_WHITESPACE"," ",102],["T_VARIABLE","$this",102],["T_OBJECT_OPERATOR","->",102],["T_STRING","_config",102],["T_OBJECT_OPERATOR","->",102],["T_STRING","getShippingTaxClass",102],"(",["T_VARIABLE","$store",102],")",";",["T_WHITESPACE","\n        ",102],["T_VARIABLE","$storeTaxRequest",103],["T_OBJECT_OPERATOR","->",103],["T_STRING","setProductClassId",103],"(",["T_VARIABLE","$shippingTaxClass",103],")",";",["T_WHITESPACE","\n        ",103],["T_VARIABLE","$addressTaxRequest",104],["T_OBJECT_OPERATOR","->",104],["T_STRING","setProductClassId",104],"(",["T_VARIABLE","$shippingTaxClass",104],")",";",["T_WHITESPACE","\n\n        ",104],["T_VARIABLE","$priceIncludesTax",106],["T_WHITESPACE"," ",106],"=",["T_WHITESPACE"," ",106],["T_VARIABLE","$this",106],["T_OBJECT_OPERATOR","->",106],["T_STRING","_config",106],["T_OBJECT_OPERATOR","->",106],["T_STRING","shippingPriceIncludesTax",106],"(",["T_VARIABLE","$store",106],")",";",["T_WHITESPACE","\n        ",106],["T_IF","if",107],["T_WHITESPACE"," ",107],"(",["T_VARIABLE","$priceIncludesTax",107],")",["T_WHITESPACE"," ",107],"{",["T_WHITESPACE","\n            ",107],["T_IF","if",108],["T_WHITESPACE"," ",108],"(",["T_VARIABLE","$this",108],["T_OBJECT_OPERATOR","->",108],["T_STRING","_helper",108],["T_OBJECT_OPERATOR","->",108],["T_STRING","isCrossBorderTradeEnabled",108],"(",["T_VARIABLE","$store",108],")",")",["T_WHITESPACE"," ",108],"{",["T_WHITESPACE","\n                ",108],["T_VARIABLE","$this",109],["T_OBJECT_OPERATOR","->",109],["T_STRING","_areTaxRequestsSimilar",109],["T_WHITESPACE"," ",109],"=",["T_WHITESPACE"," ",109],["T_STRING","true",109],";",["T_WHITESPACE","\n            ",109],"}",["T_WHITESPACE"," ",110],["T_ELSE","else",110],["T_WHITESPACE"," ",110],"{",["T_WHITESPACE","\n                ",110],["T_VARIABLE","$this",111],["T_OBJECT_OPERATOR","->",111],["T_STRING","_areTaxRequestsSimilar",111],["T_WHITESPACE"," ",111],"=",["T_WHITESPACE","\n                        ",111],["T_VARIABLE","$this",112],["T_OBJECT_OPERATOR","->",112],["T_STRING","_calculator",112],["T_OBJECT_OPERATOR","->",112],["T_STRING","compareRequests",112],"(",["T_VARIABLE","$storeTaxRequest",112],",",["T_WHITESPACE"," ",112],["T_VARIABLE","$addressTaxRequest",112],")",";",["T_WHITESPACE","\n            ",112],"}",["T_WHITESPACE","\n        ",113],"}",["T_WHITESPACE","\n\n        ",114],["T_VARIABLE","$shipping",116],["T_WHITESPACE","           ",116],"=",["T_WHITESPACE"," ",116],["T_VARIABLE","$taxShipping",116],["T_WHITESPACE"," ",116],"=",["T_WHITESPACE"," ",116],["T_VARIABLE","$address",116],["T_OBJECT_OPERATOR","->",116],["T_STRING","getShippingAmount",116],"(",")",";",["T_WHITESPACE","\n        ",116],["T_VARIABLE","$baseShipping",117],["T_WHITESPACE","       ",117],"=",["T_WHITESPACE"," ",117],["T_VARIABLE","$baseTaxShipping",117],["T_WHITESPACE"," ",117],"=",["T_WHITESPACE"," ",117],["T_VARIABLE","$address",117],["T_OBJECT_OPERATOR","->",117],["T_STRING","getBaseShippingAmount",117],"(",")",";",["T_WHITESPACE","\n        ",117],["T_VARIABLE","$rate",118],["T_WHITESPACE","               ",118],"=",["T_WHITESPACE"," ",118],["T_VARIABLE","$calc",118],["T_OBJECT_OPERATOR","->",118],["T_STRING","getRate",118],"(",["T_VARIABLE","$addressTaxRequest",118],")",";",["T_WHITESPACE","\n        ",118],["T_IF","if",119],["T_WHITESPACE"," ",119],"(",["T_VARIABLE","$priceIncludesTax",119],")",["T_WHITESPACE"," ",119],"{",["T_WHITESPACE","\n            ",119],["T_IF","if",120],["T_WHITESPACE"," ",120],"(",["T_VARIABLE","$this",120],["T_OBJECT_OPERATOR","->",120],["T_STRING","_areTaxRequestsSimilar",120],")",["T_WHITESPACE"," ",120],"{",["T_WHITESPACE","\n                ",120],["T_VARIABLE","$tax",121],["T_WHITESPACE","            ",121],"=",["T_WHITESPACE"," ",121],["T_VARIABLE","$this",121],["T_OBJECT_OPERATOR","->",121],["T_STRING","_round",121],"(",["T_VARIABLE","$calc",121],["T_OBJECT_OPERATOR","->",121],["T_STRING","calcTaxAmount",121],"(",["T_VARIABLE","$shipping",121],",",["T_WHITESPACE"," ",121],["T_VARIABLE","$rate",121],",",["T_WHITESPACE"," ",121],["T_STRING","true",121],",",["T_WHITESPACE"," ",121],["T_STRING","false",121],")",",",["T_WHITESPACE"," ",121],["T_VARIABLE","$rate",121],",",["T_WHITESPACE"," ",121],["T_STRING","true",121],")",";",["T_WHITESPACE","\n                ",121],["T_VARIABLE","$baseTax",122],["T_WHITESPACE","        ",122],"=",["T_WHITESPACE"," ",122],["T_VARIABLE","$this",122],["T_OBJECT_OPERATOR","->",122],["T_STRING","_round",122],"(",["T_WHITESPACE","\n                    ",122],["T_VARIABLE","$calc",123],["T_OBJECT_OPERATOR","->",123],["T_STRING","calcTaxAmount",123],"(",["T_VARIABLE","$baseShipping",123],",",["T_WHITESPACE"," ",123],["T_VARIABLE","$rate",123],",",["T_WHITESPACE"," ",123],["T_STRING","true",123],",",["T_WHITESPACE"," ",123],["T_STRING","false",123],")",",",["T_WHITESPACE"," ",123],["T_VARIABLE","$rate",123],",",["T_WHITESPACE"," ",123],["T_STRING","true",123],",",["T_WHITESPACE"," ",123],["T_CONSTANT_ENCAPSED_STRING","'base'",123],")",";",["T_WHITESPACE","\n                ",123],["T_VARIABLE","$taxShipping",124],["T_WHITESPACE","    ",124],"=",["T_WHITESPACE"," ",124],["T_VARIABLE","$shipping",124],";",["T_WHITESPACE","\n                ",124],["T_VARIABLE","$baseTaxShipping",125],["T_WHITESPACE"," ",125],"=",["T_WHITESPACE"," ",125],["T_VARIABLE","$baseShipping",125],";",["T_WHITESPACE","\n                ",125],["T_VARIABLE","$shipping",126],["T_WHITESPACE","       ",126],"=",["T_WHITESPACE"," ",126],["T_VARIABLE","$shipping",126],["T_WHITESPACE"," ",126],"-",["T_WHITESPACE"," ",126],["T_VARIABLE","$tax",126],";",["T_WHITESPACE","\n                ",126],["T_VARIABLE","$baseShipping",127],["T_WHITESPACE","   ",127],"=",["T_WHITESPACE"," ",127],["T_VARIABLE","$baseShipping",127],["T_WHITESPACE"," ",127],"-",["T_WHITESPACE"," ",127],["T_VARIABLE","$baseTax",127],";",["T_WHITESPACE","\n                ",127],["T_VARIABLE","$taxable",128],["T_WHITESPACE","        ",128],"=",["T_WHITESPACE"," ",128],["T_VARIABLE","$taxShipping",128],";",["T_WHITESPACE","\n                ",128],["T_VARIABLE","$baseTaxable",129],["T_WHITESPACE","    ",129],"=",["T_WHITESPACE"," ",129],["T_VARIABLE","$baseTaxShipping",129],";",["T_WHITESPACE","\n                ",129],["T_VARIABLE","$isPriceInclTax",130],["T_WHITESPACE"," ",130],"=",["T_WHITESPACE"," ",130],["T_STRING","true",130],";",["T_WHITESPACE","\n                ",130],["T_VARIABLE","$address",131],["T_OBJECT_OPERATOR","->",131],["T_STRING","setTotalAmount",131],"(",["T_CONSTANT_ENCAPSED_STRING","'shipping'",131],",",["T_WHITESPACE"," ",131],["T_VARIABLE","$shipping",131],")",";",["T_WHITESPACE","\n                ",131],["T_VARIABLE","$address",132],["T_OBJECT_OPERATOR","->",132],["T_STRING","setBaseTotalAmount",132],"(",["T_CONSTANT_ENCAPSED_STRING","'shipping'",132],",",["T_WHITESPACE"," ",132],["T_VARIABLE","$baseShipping",132],")",";",["T_WHITESPACE","\n            ",132],"}",["T_WHITESPACE"," ",133],["T_ELSE","else",133],["T_WHITESPACE"," ",133],"{",["T_WHITESPACE","\n                ",133],["T_VARIABLE","$storeRate",134],["T_WHITESPACE","      ",134],"=",["T_WHITESPACE"," ",134],["T_VARIABLE","$calc",134],["T_OBJECT_OPERATOR","->",134],["T_STRING","getStoreRate",134],"(",["T_VARIABLE","$addressTaxRequest",134],",",["T_WHITESPACE"," ",134],["T_VARIABLE","$store",134],")",";",["T_WHITESPACE","\n                ",134],["T_VARIABLE","$storeTax",135],["T_WHITESPACE","       ",135],"=",["T_WHITESPACE"," ",135],["T_VARIABLE","$calc",135],["T_OBJECT_OPERATOR","->",135],["T_STRING","calcTaxAmount",135],"(",["T_VARIABLE","$shipping",135],",",["T_WHITESPACE"," ",135],["T_VARIABLE","$storeRate",135],",",["T_WHITESPACE"," ",135],["T_STRING","true",135],",",["T_WHITESPACE"," ",135],["T_STRING","false",135],")",";",["T_WHITESPACE","\n                ",135],["T_VARIABLE","$baseStoreTax",136],["T_WHITESPACE","   ",136],"=",["T_WHITESPACE"," ",136],["T_VARIABLE","$calc",136],["T_OBJECT_OPERATOR","->",136],["T_STRING","calcTaxAmount",136],"(",["T_VARIABLE","$baseShipping",136],",",["T_WHITESPACE"," ",136],["T_VARIABLE","$storeRate",136],",",["T_WHITESPACE"," ",136],["T_STRING","true",136],",",["T_WHITESPACE"," ",136],["T_STRING","false",136],")",";",["T_WHITESPACE","\n                ",136],["T_VARIABLE","$shipping",137],["T_WHITESPACE","       ",137],"=",["T_WHITESPACE"," ",137],["T_VARIABLE","$calc",137],["T_OBJECT_OPERATOR","->",137],["T_STRING","round",137],"(",["T_VARIABLE","$shipping",137],["T_WHITESPACE"," ",137],"-",["T_WHITESPACE"," ",137],["T_VARIABLE","$storeTax",137],")",";",["T_WHITESPACE","\n                ",137],["T_VARIABLE","$baseShipping",138],["T_WHITESPACE","   ",138],"=",["T_WHITESPACE"," ",138],["T_VARIABLE","$calc",138],["T_OBJECT_OPERATOR","->",138],["T_STRING","round",138],"(",["T_VARIABLE","$baseShipping",138],["T_WHITESPACE"," ",138],"-",["T_WHITESPACE"," ",138],["T_VARIABLE","$baseStoreTax",138],")",";",["T_WHITESPACE","\n                ",138],["T_VARIABLE","$tax",139],["T_WHITESPACE","            ",139],"=",["T_WHITESPACE"," ",139],["T_VARIABLE","$this",139],["T_OBJECT_OPERATOR","->",139],["T_STRING","_round",139],"(",["T_VARIABLE","$calc",139],["T_OBJECT_OPERATOR","->",139],["T_STRING","calcTaxAmount",139],"(",["T_VARIABLE","$shipping",139],",",["T_WHITESPACE"," ",139],["T_VARIABLE","$rate",139],",",["T_WHITESPACE"," ",139],["T_STRING","false",139],",",["T_WHITESPACE"," ",139],["T_STRING","false",139],")",",",["T_WHITESPACE"," ",139],["T_VARIABLE","$rate",139],",",["T_WHITESPACE"," ",139],["T_STRING","true",139],")",";",["T_WHITESPACE","\n                ",139],["T_VARIABLE","$baseTax",140],["T_WHITESPACE","        ",140],"=",["T_WHITESPACE"," ",140],["T_VARIABLE","$this",140],["T_OBJECT_OPERATOR","->",140],["T_STRING","_round",140],"(",["T_WHITESPACE","\n                    ",140],["T_VARIABLE","$calc",141],["T_OBJECT_OPERATOR","->",141],["T_STRING","calcTaxAmount",141],"(",["T_VARIABLE","$baseShipping",141],",",["T_WHITESPACE"," ",141],["T_VARIABLE","$rate",141],",",["T_WHITESPACE"," ",141],["T_STRING","false",141],",",["T_WHITESPACE"," ",141],["T_STRING","false",141],")",",",["T_WHITESPACE"," ",141],["T_VARIABLE","$rate",141],",",["T_WHITESPACE"," ",141],["T_STRING","true",141],",",["T_WHITESPACE"," ",141],["T_CONSTANT_ENCAPSED_STRING","'base'",141],")",";",["T_WHITESPACE","\n                ",141],["T_VARIABLE","$taxShipping",142],["T_WHITESPACE","    ",142],"=",["T_WHITESPACE"," ",142],["T_VARIABLE","$shipping",142],["T_WHITESPACE"," ",142],"+",["T_WHITESPACE"," ",142],["T_VARIABLE","$tax",142],";",["T_WHITESPACE","\n                ",142],["T_VARIABLE","$baseTaxShipping",143],["T_WHITESPACE"," ",143],"=",["T_WHITESPACE"," ",143],["T_VARIABLE","$baseShipping",143],["T_WHITESPACE"," ",143],"+",["T_WHITESPACE"," ",143],["T_VARIABLE","$baseTax",143],";",["T_WHITESPACE","\n                ",143],["T_VARIABLE","$taxable",144],["T_WHITESPACE","        ",144],"=",["T_WHITESPACE"," ",144],["T_VARIABLE","$taxShipping",144],";",["T_WHITESPACE","\n                ",144],["T_VARIABLE","$baseTaxable",145],["T_WHITESPACE","    ",145],"=",["T_WHITESPACE"," ",145],["T_VARIABLE","$baseTaxShipping",145],";",["T_WHITESPACE","\n                ",145],["T_VARIABLE","$isPriceInclTax",146],["T_WHITESPACE"," ",146],"=",["T_WHITESPACE"," ",146],["T_STRING","true",146],";",["T_WHITESPACE","\n                ",146],["T_VARIABLE","$address",147],["T_OBJECT_OPERATOR","->",147],["T_STRING","setTotalAmount",147],"(",["T_CONSTANT_ENCAPSED_STRING","'shipping'",147],",",["T_WHITESPACE"," ",147],["T_VARIABLE","$shipping",147],")",";",["T_WHITESPACE","\n                ",147],["T_VARIABLE","$address",148],["T_OBJECT_OPERATOR","->",148],["T_STRING","setBaseTotalAmount",148],"(",["T_CONSTANT_ENCAPSED_STRING","'shipping'",148],",",["T_WHITESPACE"," ",148],["T_VARIABLE","$baseShipping",148],")",";",["T_WHITESPACE","\n            ",148],"}",["T_WHITESPACE","\n        ",149],"}",["T_WHITESPACE"," ",150],["T_ELSE","else",150],["T_WHITESPACE"," ",150],"{",["T_WHITESPACE","\n            ",150],["T_VARIABLE","$appliedRates",151],["T_WHITESPACE"," ",151],"=",["T_WHITESPACE"," ",151],["T_VARIABLE","$calc",151],["T_OBJECT_OPERATOR","->",151],["T_STRING","getAppliedRates",151],"(",["T_VARIABLE","$addressTaxRequest",151],")",";",["T_WHITESPACE","\n            ",151],["T_VARIABLE","$taxes",152],["T_WHITESPACE"," ",152],"=",["T_WHITESPACE"," ",152],["T_ARRAY","array",152],"(",")",";",["T_WHITESPACE","\n            ",152],["T_VARIABLE","$baseTaxes",153],["T_WHITESPACE"," ",153],"=",["T_WHITESPACE"," ",153],["T_ARRAY","array",153],"(",")",";",["T_WHITESPACE","\n            ",153],["T_FOREACH","foreach",154],["T_WHITESPACE"," ",154],"(",["T_VARIABLE","$appliedRates",154],["T_WHITESPACE"," ",154],["T_AS","as",154],["T_WHITESPACE"," ",154],["T_VARIABLE","$appliedRate",154],")",["T_WHITESPACE"," ",154],"{",["T_WHITESPACE","\n                ",154],["T_VARIABLE","$taxRate",155],["T_WHITESPACE"," ",155],"=",["T_WHITESPACE"," ",155],["T_VARIABLE","$appliedRate",155],"[",["T_CONSTANT_ENCAPSED_STRING","'percent'",155],"]",";",["T_WHITESPACE","\n                ",155],["T_VARIABLE","$taxId",156],["T_WHITESPACE"," ",156],"=",["T_WHITESPACE"," ",156],["T_VARIABLE","$appliedRate",156],"[",["T_CONSTANT_ENCAPSED_STRING","'id'",156],"]",";",["T_WHITESPACE","\n                ",156],["T_VARIABLE","$taxes",157],"[","]",["T_WHITESPACE"," ",157],"=",["T_WHITESPACE"," ",157],["T_VARIABLE","$this",157],["T_OBJECT_OPERATOR","->",157],["T_STRING","_round",157],"(",["T_VARIABLE","$calc",157],["T_OBJECT_OPERATOR","->",157],["T_STRING","calcTaxAmount",157],"(",["T_VARIABLE","$shipping",157],",",["T_WHITESPACE"," ",157],["T_VARIABLE","$taxRate",157],",",["T_WHITESPACE"," ",157],["T_STRING","false",157],",",["T_WHITESPACE"," ",157],["T_STRING","false",157],")",",",["T_WHITESPACE"," ",157],["T_VARIABLE","$taxId",157],",",["T_WHITESPACE"," ",157],["T_STRING","false",157],")",";",["T_WHITESPACE","\n                ",157],["T_VARIABLE","$baseTaxes",158],"[","]",["T_WHITESPACE"," ",158],"=",["T_WHITESPACE"," ",158],["T_VARIABLE","$this",158],["T_OBJECT_OPERATOR","->",158],["T_STRING","_round",158],"(",["T_WHITESPACE","\n                    ",158],["T_VARIABLE","$calc",159],["T_OBJECT_OPERATOR","->",159],["T_STRING","calcTaxAmount",159],"(",["T_VARIABLE","$baseShipping",159],",",["T_WHITESPACE"," ",159],["T_VARIABLE","$taxRate",159],",",["T_WHITESPACE"," ",159],["T_STRING","false",159],",",["T_WHITESPACE"," ",159],["T_STRING","false",159],")",",",["T_WHITESPACE"," ",159],["T_VARIABLE","$taxId",159],",",["T_WHITESPACE"," ",159],["T_STRING","false",159],",",["T_WHITESPACE"," ",159],["T_CONSTANT_ENCAPSED_STRING","'base'",159],")",";",["T_WHITESPACE","\n            ",159],"}",["T_WHITESPACE","\n            ",160],["T_VARIABLE","$tax",161],["T_WHITESPACE","            ",161],"=",["T_WHITESPACE"," ",161],["T_STRING","array_sum",161],"(",["T_VARIABLE","$taxes",161],")",";",["T_WHITESPACE","\n            ",161],["T_VARIABLE","$baseTax",162],["T_WHITESPACE","        ",162],"=",["T_WHITESPACE"," ",162],["T_STRING","array_sum",162],"(",["T_VARIABLE","$baseTaxes",162],")",";",["T_WHITESPACE","\n            ",162],["T_VARIABLE","$taxShipping",163],["T_WHITESPACE","    ",163],"=",["T_WHITESPACE"," ",163],["T_VARIABLE","$shipping",163],["T_WHITESPACE"," ",163],"+",["T_WHITESPACE"," ",163],["T_VARIABLE","$tax",163],";",["T_WHITESPACE","\n            ",163],["T_VARIABLE","$baseTaxShipping",164],["T_WHITESPACE"," ",164],"=",["T_WHITESPACE"," ",164],["T_VARIABLE","$baseShipping",164],["T_WHITESPACE"," ",164],"+",["T_WHITESPACE"," ",164],["T_VARIABLE","$baseTax",164],";",["T_WHITESPACE","\n            ",164],["T_VARIABLE","$taxable",165],["T_WHITESPACE","        ",165],"=",["T_WHITESPACE"," ",165],["T_VARIABLE","$shipping",165],";",["T_WHITESPACE","\n            ",165],["T_VARIABLE","$baseTaxable",166],["T_WHITESPACE","    ",166],"=",["T_WHITESPACE"," ",166],["T_VARIABLE","$baseShipping",166],";",["T_WHITESPACE","\n            ",166],["T_VARIABLE","$isPriceInclTax",167],["T_WHITESPACE"," ",167],"=",["T_WHITESPACE"," ",167],["T_STRING","false",167],";",["T_WHITESPACE","\n            ",167],["T_VARIABLE","$address",168],["T_OBJECT_OPERATOR","->",168],["T_STRING","setTotalAmount",168],"(",["T_CONSTANT_ENCAPSED_STRING","'shipping'",168],",",["T_WHITESPACE"," ",168],["T_VARIABLE","$shipping",168],")",";",["T_WHITESPACE","\n            ",168],["T_VARIABLE","$address",169],["T_OBJECT_OPERATOR","->",169],["T_STRING","setBaseTotalAmount",169],"(",["T_CONSTANT_ENCAPSED_STRING","'shipping'",169],",",["T_WHITESPACE"," ",169],["T_VARIABLE","$baseShipping",169],")",";",["T_WHITESPACE","\n        ",169],"}",["T_WHITESPACE","\n        ",170],["T_VARIABLE","$address",171],["T_OBJECT_OPERATOR","->",171],["T_STRING","setShippingInclTax",171],"(",["T_VARIABLE","$taxShipping",171],")",";",["T_WHITESPACE","\n        ",171],["T_VARIABLE","$address",172],["T_OBJECT_OPERATOR","->",172],["T_STRING","setBaseShippingInclTax",172],"(",["T_VARIABLE","$baseTaxShipping",172],")",";",["T_WHITESPACE","\n        ",172],["T_VARIABLE","$address",173],["T_OBJECT_OPERATOR","->",173],["T_STRING","setShippingTaxable",173],"(",["T_VARIABLE","$taxable",173],")",";",["T_WHITESPACE","\n        ",173],["T_VARIABLE","$address",174],["T_OBJECT_OPERATOR","->",174],["T_STRING","setBaseShippingTaxable",174],"(",["T_VARIABLE","$baseTaxable",174],")",";",["T_WHITESPACE","\n        ",174],["T_VARIABLE","$address",175],["T_OBJECT_OPERATOR","->",175],["T_STRING","setIsShippingInclTax",175],"(",["T_VARIABLE","$isPriceInclTax",175],")",";",["T_WHITESPACE","\n        ",175],["T_IF","if",176],["T_WHITESPACE"," ",176],"(",["T_VARIABLE","$this",176],["T_OBJECT_OPERATOR","->",176],["T_STRING","_config",176],["T_OBJECT_OPERATOR","->",176],["T_STRING","discountTax",176],"(",["T_VARIABLE","$store",176],")",")",["T_WHITESPACE"," ",176],"{",["T_WHITESPACE","\n            ",176],["T_VARIABLE","$address",177],["T_OBJECT_OPERATOR","->",177],["T_STRING","setShippingAmountForDiscount",177],"(",["T_VARIABLE","$taxShipping",177],")",";",["T_WHITESPACE","\n            ",177],["T_VARIABLE","$address",178],["T_OBJECT_OPERATOR","->",178],["T_STRING","setBaseShippingAmountForDiscount",178],"(",["T_VARIABLE","$baseTaxShipping",178],")",";",["T_WHITESPACE","\n        ",178],"}",["T_WHITESPACE","\n        ",179],["T_RETURN","return",180],["T_WHITESPACE"," ",180],["T_VARIABLE","$this",180],";",["T_WHITESPACE","\n    ",180],"}",["T_WHITESPACE","\n\n    ",181],["T_DOC_COMMENT","\/**\n     * Round price based on tax rounding settings\n     *\n     * @param float $price\n     * @param string $rate\n     * @param bool $direction\n     * @param string $type\n     * @return float\n     *\/",183],["T_WHITESPACE","\n    ",191],["T_PROTECTED","protected",192],["T_WHITESPACE"," ",192],["T_FUNCTION","function",192],["T_WHITESPACE"," ",192],["T_STRING","_round",192],"(",["T_VARIABLE","$price",192],",",["T_WHITESPACE"," ",192],["T_VARIABLE","$rate",192],",",["T_WHITESPACE"," ",192],["T_VARIABLE","$direction",192],",",["T_WHITESPACE"," ",192],["T_VARIABLE","$type",192],["T_WHITESPACE"," ",192],"=",["T_WHITESPACE"," ",192],["T_CONSTANT_ENCAPSED_STRING","'regular'",192],")",["T_WHITESPACE","\n    ",192],"{",["T_WHITESPACE","\n        ",193],["T_IF","if",194],["T_WHITESPACE"," ",194],"(","!",["T_VARIABLE","$price",194],")",["T_WHITESPACE"," ",194],"{",["T_WHITESPACE","\n            ",194],["T_RETURN","return",195],["T_WHITESPACE"," ",195],["T_VARIABLE","$this",195],["T_OBJECT_OPERATOR","->",195],["T_STRING","_calculator",195],["T_OBJECT_OPERATOR","->",195],["T_STRING","round",195],"(",["T_VARIABLE","$price",195],")",";",["T_WHITESPACE","\n        ",195],"}",["T_WHITESPACE","\n\n        ",196],["T_VARIABLE","$deltas",198],["T_WHITESPACE"," ",198],"=",["T_WHITESPACE"," ",198],["T_VARIABLE","$this",198],["T_OBJECT_OPERATOR","->",198],["T_STRING","_address",198],["T_OBJECT_OPERATOR","->",198],["T_STRING","getRoundingDeltas",198],"(",")",";",["T_WHITESPACE","\n        ",198],["T_VARIABLE","$key",199],["T_WHITESPACE"," ",199],"=",["T_WHITESPACE"," ",199],["T_VARIABLE","$type",199],".",["T_VARIABLE","$direction",199],";",["T_WHITESPACE","\n        ",199],["T_VARIABLE","$rate",200],["T_WHITESPACE"," ",200],"=",["T_WHITESPACE"," ",200],["T_STRING_CAST","(string)",200],["T_WHITESPACE"," ",200],["T_VARIABLE","$rate",200],";",["T_WHITESPACE","\n        ",200],["T_VARIABLE","$delta",201],["T_WHITESPACE"," ",201],"=",["T_WHITESPACE"," ",201],["T_ISSET","isset",201],"(",["T_VARIABLE","$deltas",201],"[",["T_VARIABLE","$key",201],"]","[",["T_VARIABLE","$rate",201],"]",")",["T_WHITESPACE"," ",201],"?",["T_WHITESPACE"," ",201],["T_VARIABLE","$deltas",201],"[",["T_VARIABLE","$key",201],"]","[",["T_VARIABLE","$rate",201],"]",["T_WHITESPACE"," ",201],":",["T_WHITESPACE"," ",201],["T_LNUMBER","0",201],";",["T_WHITESPACE","\n        ",201],["T_RETURN","return",202],["T_WHITESPACE"," ",202],["T_VARIABLE","$this",202],["T_OBJECT_OPERATOR","->",202],["T_STRING","_calculator",202],["T_OBJECT_OPERATOR","->",202],["T_STRING","round",202],"(",["T_VARIABLE","$price",202],"+",["T_VARIABLE","$delta",202],")",";",["T_WHITESPACE","\n    ",202],"}",["T_WHITESPACE","\n\n    ",203],["T_DOC_COMMENT","\/**\n     * Get request for fetching store tax rate\n     *\n     * @deprecated after 1.4.0.0\n     * @param   Mage_Sales_Model_Quote_Address $address\n     * @return  Varien_Object\n     *\/",205],["T_WHITESPACE","\n    ",211],["T_PROTECTED","protected",212],["T_WHITESPACE"," ",212],["T_FUNCTION","function",212],["T_WHITESPACE"," ",212],["T_STRING","_getStoreTaxRequest",212],"(",["T_VARIABLE","$address",212],")",["T_WHITESPACE","\n    ",212],"{",["T_WHITESPACE","\n        ",213],["T_IF","if",214],["T_WHITESPACE"," ",214],"(",["T_STRING","is_null",214],"(",["T_VARIABLE","$this",214],["T_OBJECT_OPERATOR","->",214],["T_STRING","_storeTaxRequest",214],")",")",["T_WHITESPACE"," ",214],"{",["T_WHITESPACE","\n            ",214],["T_VARIABLE","$this",215],["T_OBJECT_OPERATOR","->",215],["T_STRING","_storeTaxRequest",215],["T_WHITESPACE"," ",215],"=",["T_WHITESPACE"," ",215],["T_VARIABLE","$this",215],["T_OBJECT_OPERATOR","->",215],["T_STRING","_calculator",215],["T_OBJECT_OPERATOR","->",215],["T_STRING","getRateOriginRequest",215],"(",["T_VARIABLE","$address",215],["T_OBJECT_OPERATOR","->",215],["T_STRING","getQuote",215],"(",")",["T_OBJECT_OPERATOR","->",215],["T_STRING","getStore",215],"(",")",")",";",["T_WHITESPACE","\n        ",215],"}",["T_WHITESPACE","\n        ",216],["T_RETURN","return",217],["T_WHITESPACE"," ",217],["T_VARIABLE","$this",217],["T_OBJECT_OPERATOR","->",217],["T_STRING","_storeTaxRequest",217],";",["T_WHITESPACE","\n    ",217],"}",["T_WHITESPACE","\n\n    ",218],["T_DOC_COMMENT","\/**\n     * Get request for fetching address tax rate\n     *\n     * @deprecated after 1.4.0.0\n     * @param   Mage_Sales_Model_Quote_Address $address\n     * @return  Varien_Object\n     *\/",220],["T_WHITESPACE","\n    ",226],["T_PROTECTED","protected",227],["T_WHITESPACE"," ",227],["T_FUNCTION","function",227],["T_WHITESPACE"," ",227],["T_STRING","_getAddressTaxRequest",227],"(",["T_VARIABLE","$address",227],")",["T_WHITESPACE","\n    ",227],"{",["T_WHITESPACE","\n        ",228],["T_VARIABLE","$addressTaxRequest",229],["T_WHITESPACE"," ",229],"=",["T_WHITESPACE"," ",229],["T_VARIABLE","$this",229],["T_OBJECT_OPERATOR","->",229],["T_STRING","_calculator",229],["T_OBJECT_OPERATOR","->",229],["T_STRING","getRateRequest",229],"(",["T_WHITESPACE","\n            ",229],["T_VARIABLE","$address",230],",",["T_WHITESPACE","\n            ",230],["T_VARIABLE","$address",231],["T_OBJECT_OPERATOR","->",231],["T_STRING","getQuote",231],"(",")",["T_OBJECT_OPERATOR","->",231],["T_STRING","getBillingAddress",231],"(",")",",",["T_WHITESPACE","\n            ",231],["T_VARIABLE","$address",232],["T_OBJECT_OPERATOR","->",232],["T_STRING","getQuote",232],"(",")",["T_OBJECT_OPERATOR","->",232],["T_STRING","getCustomerTaxClassId",232],"(",")",",",["T_WHITESPACE","\n            ",232],["T_VARIABLE","$address",233],["T_OBJECT_OPERATOR","->",233],["T_STRING","getQuote",233],"(",")",["T_OBJECT_OPERATOR","->",233],["T_STRING","getStore",233],"(",")",["T_WHITESPACE","\n        ",233],")",";",["T_WHITESPACE","\n        ",234],["T_RETURN","return",235],["T_WHITESPACE"," ",235],["T_VARIABLE","$addressTaxRequest",235],";",["T_WHITESPACE","\n    ",235],"}",["T_WHITESPACE","\n\n    ",236],["T_DOC_COMMENT","\/**\n     * Check if we need subtract store tax amount from shipping\n     *\n     * @deprecated after 1.4.0.0\n     * @param Mage_Sales_Model_Quote_Address $address\n     * @return bool\n     *\/",238],["T_WHITESPACE","\n    ",244],["T_PROTECTED","protected",245],["T_WHITESPACE"," ",245],["T_FUNCTION","function",245],["T_WHITESPACE"," ",245],["T_STRING","_needSubtractShippingTax",245],"(",["T_VARIABLE","$address",245],")",["T_WHITESPACE","\n    ",245],"{",["T_WHITESPACE","\n        ",246],["T_VARIABLE","$store",247],["T_WHITESPACE"," ",247],"=",["T_WHITESPACE"," ",247],["T_VARIABLE","$address",247],["T_OBJECT_OPERATOR","->",247],["T_STRING","getQuote",247],"(",")",["T_OBJECT_OPERATOR","->",247],["T_STRING","getStore",247],"(",")",";",["T_WHITESPACE","\n        ",247],["T_IF","if",248],["T_WHITESPACE"," ",248],"(",["T_VARIABLE","$this",248],["T_OBJECT_OPERATOR","->",248],["T_STRING","_config",248],["T_OBJECT_OPERATOR","->",248],["T_STRING","shippingPriceIncludesTax",248],"(",["T_VARIABLE","$store",248],")",["T_WHITESPACE"," ",248],["T_BOOLEAN_OR","||",248],["T_WHITESPACE"," ",248],["T_VARIABLE","$this",248],["T_OBJECT_OPERATOR","->",248],["T_STRING","_config",248],["T_OBJECT_OPERATOR","->",248],["T_STRING","getNeedUseShippingExcludeTax",248],"(",")",")",["T_WHITESPACE"," ",248],"{",["T_WHITESPACE","\n            ",248],["T_RETURN","return",249],["T_WHITESPACE"," ",249],["T_STRING","true",249],";",["T_WHITESPACE","\n        ",249],"}",["T_WHITESPACE","\n        ",250],["T_RETURN","return",251],["T_WHITESPACE"," ",251],["T_STRING","false",251],";",["T_WHITESPACE","\n    ",251],"}",["T_WHITESPACE","\n\n    ",252],["T_DOC_COMMENT","\/**\n     * Calculate shipping price without store tax\n     *\n     * @deprecated after 1.4.0.0\n     * @param   Mage_Sales_Model_Quote_Address $address\n     * @return  Mage_Tax_Model_Sales_Total_Quote_Subtotal\n     *\/",254],["T_WHITESPACE","\n    ",260],["T_PROTECTED","protected",261],["T_WHITESPACE"," ",261],["T_FUNCTION","function",261],["T_WHITESPACE"," ",261],["T_STRING","_processShippingAmount",261],"(",["T_VARIABLE","$address",261],")",["T_WHITESPACE","\n    ",261],"{",["T_WHITESPACE","\n    ",262],"}",["T_WHITESPACE","\n",263],"}",["T_WHITESPACE","\n",264]]