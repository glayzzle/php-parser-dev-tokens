[["T_OPEN_TAG","<?php\n",1],["T_DOC_COMMENT","\/**\n * Magento\n *\n * NOTICE OF LICENSE\n *\n * This source file is subject to the Open Software License (OSL 3.0)\n * that is bundled with this package in the file LICENSE.txt.\n * It is also available through the world-wide-web at this URL:\n * http:\/\/opensource.org\/licenses\/osl-3.0.php\n * If you did not receive a copy of the license and are unable to\n * obtain it through the world-wide-web, please send an email\n * to license@magento.com so we can send you a copy immediately.\n *\n * DISCLAIMER\n *\n * Do not edit or add to this file if you wish to upgrade Magento to newer\n * versions in the future. If you wish to customize Magento for your\n * needs please refer to http:\/\/www.magento.com for more information.\n *\n * @category    Mage\n * @package     Mage_Tax\n * @copyright  Copyright (c) 2006-2016 X.commerce, Inc. and affiliates (http:\/\/www.magento.com)\n * @license    http:\/\/opensource.org\/licenses\/osl-3.0.php  Open Software License (OSL 3.0)\n *\/",2],["T_WHITESPACE","\n\n\n",25],["T_DOC_COMMENT","\/**\n * Tax rule collection\n *\n * @category    Mage\n * @package     Mage_Tax\n * @author      Magento Core Team <core@magentocommerce.com>\n *\/",28],["T_WHITESPACE","\n",34],["T_CLASS","class",35],["T_WHITESPACE"," ",35],["T_STRING","Mage_Tax_Model_Resource_Calculation_Rule_Collection",35],["T_WHITESPACE"," ",35],["T_EXTENDS","extends",35],["T_WHITESPACE"," ",35],["T_STRING","Mage_Core_Model_Resource_Db_Collection_Abstract",35],["T_WHITESPACE","\n",35],"{",["T_WHITESPACE","\n    ",36],["T_DOC_COMMENT","\/**\n     * Resource initialization\n     *\/",37],["T_WHITESPACE","\n    ",39],["T_PROTECTED","protected",40],["T_WHITESPACE"," ",40],["T_FUNCTION","function",40],["T_WHITESPACE"," ",40],["T_STRING","_construct",40],"(",")",["T_WHITESPACE","\n    ",40],"{",["T_WHITESPACE","\n        ",41],["T_VARIABLE","$this",42],["T_OBJECT_OPERATOR","->",42],["T_STRING","_init",42],"(",["T_CONSTANT_ENCAPSED_STRING","'tax\/calculation_rule'",42],")",";",["T_WHITESPACE","\n    ",42],"}",["T_WHITESPACE","\n\n    ",43],["T_DOC_COMMENT","\/**\n     * Join calculation data to result\n     *\n     * @param string $alias table alias\n     * @return Mage_Tax_Model_Resource_Calculation_Rule_Collection\n     *\/",45],["T_WHITESPACE","\n    ",50],["T_PUBLIC","public",51],["T_WHITESPACE"," ",51],["T_FUNCTION","function",51],["T_WHITESPACE"," ",51],["T_STRING","joinCalculationData",51],"(",["T_VARIABLE","$alias",51],")",["T_WHITESPACE","\n    ",51],"{",["T_WHITESPACE","\n        ",52],["T_VARIABLE","$this",53],["T_OBJECT_OPERATOR","->",53],["T_STRING","getSelect",53],"(",")",["T_OBJECT_OPERATOR","->",53],["T_STRING","joinLeft",53],"(",["T_WHITESPACE","\n            ",53],["T_ARRAY","array",54],"(",["T_VARIABLE","$alias",54],["T_WHITESPACE"," ",54],["T_DOUBLE_ARROW","=>",54],["T_WHITESPACE"," ",54],["T_VARIABLE","$this",54],["T_OBJECT_OPERATOR","->",54],["T_STRING","getTable",54],"(",["T_CONSTANT_ENCAPSED_STRING","'tax\/tax_calculation'",54],")",")",",",["T_WHITESPACE","\n            ",54],"\"",["T_ENCAPSED_AND_WHITESPACE","main_table.tax_calculation_rule_id = ",55],["T_CURLY_OPEN","{",55],["T_VARIABLE","$alias",55],"}",["T_ENCAPSED_AND_WHITESPACE",".tax_calculation_rule_id",55],"\"",",",["T_WHITESPACE","\n            ",55],["T_ARRAY","array",56],"(",")",["T_WHITESPACE","\n        ",56],")",";",["T_WHITESPACE","\n        ",57],["T_VARIABLE","$this",58],["T_OBJECT_OPERATOR","->",58],["T_STRING","getSelect",58],"(",")",["T_OBJECT_OPERATOR","->",58],["T_STRING","group",58],"(",["T_CONSTANT_ENCAPSED_STRING","'main_table.tax_calculation_rule_id'",58],")",";",["T_WHITESPACE","\n\n        ",58],["T_RETURN","return",60],["T_WHITESPACE"," ",60],["T_VARIABLE","$this",60],";",["T_WHITESPACE","\n    ",60],"}",["T_WHITESPACE","\n\n    ",61],["T_DOC_COMMENT","\/**\n     * Join tax data to collection\n     *\n     * @param string $itemTable\n     * @param string $primaryJoinField\n     * @param string $secondaryJoinField\n     * @param string $titleField\n     * @param string $dataField\n     * @return Mage_Tax_Model_Resource_Calculation_Rule_Collection\n     *\/",63],["T_WHITESPACE","\n    ",72],["T_PROTECTED","protected",73],["T_WHITESPACE"," ",73],["T_FUNCTION","function",73],["T_WHITESPACE"," ",73],["T_STRING","_add",73],"(",["T_VARIABLE","$itemTable",73],",",["T_WHITESPACE"," ",73],["T_VARIABLE","$primaryJoinField",73],",",["T_WHITESPACE"," ",73],["T_VARIABLE","$secondaryJoinField",73],",",["T_WHITESPACE"," ",73],["T_VARIABLE","$titleField",73],",",["T_WHITESPACE"," ",73],["T_VARIABLE","$dataField",73],")",["T_WHITESPACE","\n    ",73],"{",["T_WHITESPACE","\n        ",74],["T_VARIABLE","$children",75],["T_WHITESPACE"," ",75],"=",["T_WHITESPACE"," ",75],["T_ARRAY","array",75],"(",")",";",["T_WHITESPACE","\n        ",75],["T_FOREACH","foreach",76],["T_WHITESPACE"," ",76],"(",["T_VARIABLE","$this",76],["T_WHITESPACE"," ",76],["T_AS","as",76],["T_WHITESPACE"," ",76],["T_VARIABLE","$rule",76],")",["T_WHITESPACE"," ",76],"{",["T_WHITESPACE","\n            ",76],["T_VARIABLE","$children",77],"[",["T_VARIABLE","$rule",77],["T_OBJECT_OPERATOR","->",77],["T_STRING","getId",77],"(",")","]",["T_WHITESPACE"," ",77],"=",["T_WHITESPACE"," ",77],["T_ARRAY","array",77],"(",")",";",["T_WHITESPACE","\n        ",77],"}",["T_WHITESPACE","\n        ",78],["T_IF","if",79],["T_WHITESPACE"," ",79],"(","!",["T_EMPTY","empty",79],"(",["T_VARIABLE","$children",79],")",")",["T_WHITESPACE"," ",79],"{",["T_WHITESPACE","\n            ",79],["T_VARIABLE","$joinCondition",80],["T_WHITESPACE"," ",80],"=",["T_WHITESPACE"," ",80],["T_STRING","sprintf",80],"(",["T_CONSTANT_ENCAPSED_STRING","'item.%s = calculation.%s'",80],",",["T_WHITESPACE"," ",80],["T_VARIABLE","$secondaryJoinField",80],",",["T_WHITESPACE"," ",80],["T_VARIABLE","$primaryJoinField",80],")",";",["T_WHITESPACE","\n            ",80],["T_VARIABLE","$select",81],["T_WHITESPACE"," ",81],"=",["T_WHITESPACE"," ",81],["T_VARIABLE","$this",81],["T_OBJECT_OPERATOR","->",81],["T_STRING","getConnection",81],"(",")",["T_OBJECT_OPERATOR","->",81],["T_STRING","select",81],"(",")",["T_WHITESPACE","\n                ",81],["T_OBJECT_OPERATOR","->",82],["T_STRING","from",82],"(",["T_WHITESPACE","\n                    ",82],["T_ARRAY","array",83],"(",["T_CONSTANT_ENCAPSED_STRING","'calculation'",83],["T_WHITESPACE"," ",83],["T_DOUBLE_ARROW","=>",83],["T_WHITESPACE"," ",83],["T_VARIABLE","$this",83],["T_OBJECT_OPERATOR","->",83],["T_STRING","getTable",83],"(",["T_CONSTANT_ENCAPSED_STRING","'tax\/tax_calculation'",83],")",")",",",["T_WHITESPACE","\n                    ",83],["T_ARRAY","array",84],"(",["T_CONSTANT_ENCAPSED_STRING","'calculation.tax_calculation_rule_id'",84],")",["T_WHITESPACE","\n                ",84],")",["T_WHITESPACE","\n                ",85],["T_OBJECT_OPERATOR","->",86],["T_STRING","join",86],"(",["T_WHITESPACE","\n                    ",86],["T_ARRAY","array",87],"(",["T_CONSTANT_ENCAPSED_STRING","'item'",87],["T_WHITESPACE"," ",87],["T_DOUBLE_ARROW","=>",87],["T_WHITESPACE"," ",87],["T_VARIABLE","$this",87],["T_OBJECT_OPERATOR","->",87],["T_STRING","getTable",87],"(",["T_VARIABLE","$itemTable",87],")",")",",",["T_WHITESPACE","\n                    ",87],["T_VARIABLE","$joinCondition",88],",",["T_WHITESPACE","\n                    ",88],["T_ARRAY","array",89],"(","\"",["T_ENCAPSED_AND_WHITESPACE","item.",89],["T_CURLY_OPEN","{",89],["T_VARIABLE","$titleField",89],"}","\"",",",["T_WHITESPACE"," ",89],"\"",["T_ENCAPSED_AND_WHITESPACE","item.",89],["T_CURLY_OPEN","{",89],["T_VARIABLE","$secondaryJoinField",89],"}","\"",")",["T_WHITESPACE","\n                ",89],")",["T_WHITESPACE","\n                ",90],["T_OBJECT_OPERATOR","->",91],["T_STRING","where",91],"(",["T_CONSTANT_ENCAPSED_STRING","'calculation.tax_calculation_rule_id IN (?)'",91],",",["T_WHITESPACE"," ",91],["T_STRING","array_keys",91],"(",["T_VARIABLE","$children",91],")",")",["T_WHITESPACE","\n                ",91],["T_OBJECT_OPERATOR","->",92],["T_STRING","distinct",92],"(",["T_STRING","true",92],")",";",["T_WHITESPACE","\n\n            ",92],["T_VARIABLE","$data",94],["T_WHITESPACE"," ",94],"=",["T_WHITESPACE"," ",94],["T_VARIABLE","$this",94],["T_OBJECT_OPERATOR","->",94],["T_STRING","getConnection",94],"(",")",["T_OBJECT_OPERATOR","->",94],["T_STRING","fetchAll",94],"(",["T_VARIABLE","$select",94],")",";",["T_WHITESPACE","\n            ",94],["T_FOREACH","foreach",95],["T_WHITESPACE"," ",95],"(",["T_VARIABLE","$data",95],["T_WHITESPACE"," ",95],["T_AS","as",95],["T_WHITESPACE"," ",95],["T_VARIABLE","$row",95],")",["T_WHITESPACE"," ",95],"{",["T_WHITESPACE","\n               ",95],["T_VARIABLE","$children",96],"[",["T_VARIABLE","$row",96],"[",["T_CONSTANT_ENCAPSED_STRING","'tax_calculation_rule_id'",96],"]","]","[",["T_VARIABLE","$row",96],"[",["T_VARIABLE","$secondaryJoinField",96],"]","]",["T_WHITESPACE"," ",96],"=",["T_WHITESPACE"," ",96],["T_VARIABLE","$row",96],"[",["T_VARIABLE","$titleField",96],"]",";",["T_WHITESPACE","\n            ",96],"}",["T_WHITESPACE","\n        ",97],"}",["T_WHITESPACE","\n\n        ",98],["T_FOREACH","foreach",100],["T_WHITESPACE"," ",100],"(",["T_VARIABLE","$this",100],["T_WHITESPACE"," ",100],["T_AS","as",100],["T_WHITESPACE"," ",100],["T_VARIABLE","$rule",100],")",["T_WHITESPACE"," ",100],"{",["T_WHITESPACE","\n            ",100],["T_IF","if",101],["T_WHITESPACE"," ",101],"(",["T_ISSET","isset",101],"(",["T_VARIABLE","$children",101],"[",["T_VARIABLE","$rule",101],["T_OBJECT_OPERATOR","->",101],["T_STRING","getId",101],"(",")","]",")",")",["T_WHITESPACE"," ",101],"{",["T_WHITESPACE","\n                ",101],["T_VARIABLE","$rule",102],["T_OBJECT_OPERATOR","->",102],["T_STRING","setData",102],"(",["T_VARIABLE","$dataField",102],",",["T_WHITESPACE"," ",102],["T_STRING","array_keys",102],"(",["T_VARIABLE","$children",102],"[",["T_VARIABLE","$rule",102],["T_OBJECT_OPERATOR","->",102],["T_STRING","getId",102],"(",")","]",")",")",";",["T_WHITESPACE","\n            ",102],"}",["T_WHITESPACE","\n        ",103],"}",["T_WHITESPACE","\n\n        ",104],["T_RETURN","return",106],["T_WHITESPACE"," ",106],["T_VARIABLE","$this",106],";",["T_WHITESPACE","\n    ",106],"}",["T_WHITESPACE","\n\n    ",107],["T_DOC_COMMENT","\/**\n     * Add product tax classes to result\n     *\n     * @return Mage_Tax_Model_Resource_Calculation_Rule_Collection\n     *\/",109],["T_WHITESPACE","\n    ",113],["T_PUBLIC","public",114],["T_WHITESPACE"," ",114],["T_FUNCTION","function",114],["T_WHITESPACE"," ",114],["T_STRING","addProductTaxClassesToResult",114],"(",")",["T_WHITESPACE","\n    ",114],"{",["T_WHITESPACE","\n        ",115],["T_RETURN","return",116],["T_WHITESPACE"," ",116],["T_VARIABLE","$this",116],["T_OBJECT_OPERATOR","->",116],["T_STRING","_add",116],"(",["T_CONSTANT_ENCAPSED_STRING","'tax_class'",116],",",["T_WHITESPACE"," ",116],["T_CONSTANT_ENCAPSED_STRING","'product_tax_class_id'",116],",",["T_WHITESPACE"," ",116],["T_CONSTANT_ENCAPSED_STRING","'class_id'",116],",",["T_WHITESPACE"," ",116],["T_CONSTANT_ENCAPSED_STRING","'class_name'",116],",",["T_WHITESPACE"," ",116],["T_CONSTANT_ENCAPSED_STRING","'product_tax_classes'",116],")",";",["T_WHITESPACE","\n    ",116],"}",["T_WHITESPACE","\n\n    ",117],["T_DOC_COMMENT","\/**\n     * Add customer tax classes to result\n     *\n     * @return Mage_Tax_Model_Resource_Calculation_Rule_Collection\n     *\/",119],["T_WHITESPACE","\n    ",123],["T_PUBLIC","public",124],["T_WHITESPACE"," ",124],["T_FUNCTION","function",124],["T_WHITESPACE"," ",124],["T_STRING","addCustomerTaxClassesToResult",124],"(",")",["T_WHITESPACE","\n    ",124],"{",["T_WHITESPACE","\n        ",125],["T_RETURN","return",126],["T_WHITESPACE"," ",126],["T_VARIABLE","$this",126],["T_OBJECT_OPERATOR","->",126],["T_STRING","_add",126],"(",["T_CONSTANT_ENCAPSED_STRING","'tax_class'",126],",",["T_WHITESPACE"," ",126],["T_CONSTANT_ENCAPSED_STRING","'customer_tax_class_id'",126],",",["T_WHITESPACE"," ",126],["T_CONSTANT_ENCAPSED_STRING","'class_id'",126],",",["T_WHITESPACE"," ",126],["T_CONSTANT_ENCAPSED_STRING","'class_name'",126],",",["T_WHITESPACE"," ",126],["T_CONSTANT_ENCAPSED_STRING","'customer_tax_classes'",126],")",";",["T_WHITESPACE","\n    ",126],"}",["T_WHITESPACE","\n\n    ",127],["T_DOC_COMMENT","\/**\n     * Add rates to result\n     *\n     * @return Mage_Tax_Model_Resource_Calculation_Rule_Collection\n     *\/",129],["T_WHITESPACE","\n    ",133],["T_PUBLIC","public",134],["T_WHITESPACE"," ",134],["T_FUNCTION","function",134],["T_WHITESPACE"," ",134],["T_STRING","addRatesToResult",134],"(",")",["T_WHITESPACE","\n    ",134],"{",["T_WHITESPACE","\n        ",135],["T_RETURN","return",136],["T_WHITESPACE"," ",136],["T_VARIABLE","$this",136],["T_OBJECT_OPERATOR","->",136],["T_STRING","_add",136],"(",["T_CONSTANT_ENCAPSED_STRING","'tax_calculation_rate'",136],",",["T_WHITESPACE"," ",136],["T_CONSTANT_ENCAPSED_STRING","'tax_calculation_rate_id'",136],",",["T_WHITESPACE"," ",136],["T_CONSTANT_ENCAPSED_STRING","'tax_calculation_rate_id'",136],",",["T_WHITESPACE"," ",136],["T_CONSTANT_ENCAPSED_STRING","'code'",136],",",["T_WHITESPACE"," ",136],["T_CONSTANT_ENCAPSED_STRING","'tax_rates'",136],")",";",["T_WHITESPACE","\n    ",136],"}",["T_WHITESPACE","\n\n    ",137],["T_DOC_COMMENT","\/**\n     * Add class type filter\n     *\n     * @param string $type\n     * @param int $id\n     * @throws Mage_Core_Exception\n     * @return Mage_Tax_Model_Resource_Calculation_Rule_Collection\n     *\/",139],["T_WHITESPACE","\n    ",146],["T_PUBLIC","public",147],["T_WHITESPACE"," ",147],["T_FUNCTION","function",147],["T_WHITESPACE"," ",147],["T_STRING","setClassTypeFilter",147],"(",["T_VARIABLE","$type",147],",",["T_WHITESPACE"," ",147],["T_VARIABLE","$id",147],")",["T_WHITESPACE","\n    ",147],"{",["T_WHITESPACE","\n        ",148],["T_SWITCH","switch",149],["T_WHITESPACE"," ",149],"(",["T_VARIABLE","$type",149],")",["T_WHITESPACE"," ",149],"{",["T_WHITESPACE","\n            ",149],["T_CASE","case",150],["T_WHITESPACE"," ",150],["T_STRING","Mage_Tax_Model_Class",150],["T_DOUBLE_COLON","::",150],["T_STRING","TAX_CLASS_TYPE_PRODUCT",150],":",["T_WHITESPACE","\n                ",150],["T_VARIABLE","$field",151],["T_WHITESPACE"," ",151],"=",["T_WHITESPACE"," ",151],["T_CONSTANT_ENCAPSED_STRING","'cd.product_tax_class_id'",151],";",["T_WHITESPACE","\n                ",151],["T_BREAK","break",152],";",["T_WHITESPACE","\n            ",152],["T_CASE","case",153],["T_WHITESPACE"," ",153],["T_STRING","Mage_Tax_Model_Class",153],["T_DOUBLE_COLON","::",153],["T_STRING","TAX_CLASS_TYPE_CUSTOMER",153],":",["T_WHITESPACE","\n                ",153],["T_VARIABLE","$field",154],["T_WHITESPACE"," ",154],"=",["T_WHITESPACE"," ",154],["T_CONSTANT_ENCAPSED_STRING","'cd.customer_tax_class_id'",154],";",["T_WHITESPACE","\n                ",154],["T_BREAK","break",155],";",["T_WHITESPACE","\n            ",155],["T_DEFAULT","default",156],":",["T_WHITESPACE","\n                ",156],["T_STRING","Mage",157],["T_DOUBLE_COLON","::",157],["T_STRING","throwException",157],"(",["T_CONSTANT_ENCAPSED_STRING","'Invalid type supplied'",157],")",";",["T_WHITESPACE","\n        ",157],"}",["T_WHITESPACE","\n\n        ",158],["T_VARIABLE","$this",160],["T_OBJECT_OPERATOR","->",160],["T_STRING","joinCalculationData",160],"(",["T_CONSTANT_ENCAPSED_STRING","'cd'",160],")",";",["T_WHITESPACE","\n        ",160],["T_VARIABLE","$this",161],["T_OBJECT_OPERATOR","->",161],["T_STRING","addFieldToFilter",161],"(",["T_VARIABLE","$field",161],",",["T_WHITESPACE"," ",161],["T_VARIABLE","$id",161],")",";",["T_WHITESPACE","\n        ",161],["T_RETURN","return",162],["T_WHITESPACE"," ",162],["T_VARIABLE","$this",162],";",["T_WHITESPACE","\n    ",162],"}",["T_WHITESPACE","\n",163],"}",["T_WHITESPACE","\n",164]]