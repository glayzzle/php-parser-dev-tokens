[["T_OPEN_TAG","<?php\n",1],["T_DOC_COMMENT","\/**\n * Magento\n *\n * NOTICE OF LICENSE\n *\n * This source file is subject to the Open Software License (OSL 3.0)\n * that is bundled with this package in the file LICENSE.txt.\n * It is also available through the world-wide-web at this URL:\n * http:\/\/opensource.org\/licenses\/osl-3.0.php\n * If you did not receive a copy of the license and are unable to\n * obtain it through the world-wide-web, please send an email\n * to license@magento.com so we can send you a copy immediately.\n *\n * DISCLAIMER\n *\n * Do not edit or add to this file if you wish to upgrade Magento to newer\n * versions in the future. If you wish to customize Magento for your\n * needs please refer to http:\/\/www.magento.com for more information.\n *\n * @category    Mage\n * @package     Mage_Tax\n * @copyright  Copyright (c) 2006-2016 X.commerce, Inc. and affiliates (http:\/\/www.magento.com)\n * @license    http:\/\/opensource.org\/licenses\/osl-3.0.php  Open Software License (OSL 3.0)\n *\/",2],["T_WHITESPACE","\n\n",25],["T_DOC_COMMENT","\/**\n * Tax totals calculation model\n *\/",27],["T_WHITESPACE","\n",29],["T_CLASS","class",30],["T_WHITESPACE"," ",30],["T_STRING","Mage_Tax_Model_Sales_Total_Quote_Tax",30],["T_WHITESPACE"," ",30],["T_EXTENDS","extends",30],["T_WHITESPACE"," ",30],["T_STRING","Mage_Sales_Model_Quote_Address_Total_Abstract",30],["T_WHITESPACE","\n",30],"{",["T_WHITESPACE","\n    ",31],["T_DOC_COMMENT","\/**\n     * Tax module helper\n     *\n     * @var Mage_Tax_Helper_Data\n     *\/",32],["T_WHITESPACE","\n    ",36],["T_PROTECTED","protected",37],["T_WHITESPACE"," ",37],["T_VARIABLE","$_helper",37],";",["T_WHITESPACE","\n\n    ",37],["T_DOC_COMMENT","\/**\n     * Tax calculation model\n     *\n     * @var Mage_Tax_Model_Calculation\n     *\/",39],["T_WHITESPACE","\n    ",43],["T_PROTECTED","protected",44],["T_WHITESPACE"," ",44],["T_VARIABLE","$_calculator",44],";",["T_WHITESPACE","\n\n    ",44],["T_DOC_COMMENT","\/**\n     * Tax configuration object\n     *\n     * @var Mage_Tax_Model_Config\n     *\/",46],["T_WHITESPACE","\n    ",50],["T_PROTECTED","protected",51],["T_WHITESPACE"," ",51],["T_VARIABLE","$_config",51],";",["T_WHITESPACE","\n\n    ",51],["T_DOC_COMMENT","\/**\n     * Flag which is initialized when collect method is start.\n     * Is used for checking if store tax and customer tax requests are similar\n     *\n     * @var bool\n     *\/",53],["T_WHITESPACE","\n    ",58],["T_PROTECTED","protected",59],["T_WHITESPACE"," ",59],["T_VARIABLE","$_areTaxRequestsSimilar",59],["T_WHITESPACE"," ",59],"=",["T_WHITESPACE"," ",59],["T_STRING","false",59],";",["T_WHITESPACE","\n\n    ",59],["T_DOC_COMMENT","\/**\n     * Array for the rounding deltas\n     *\n     * @var array\n     *\/",61],["T_WHITESPACE","\n    ",65],["T_PROTECTED","protected",66],["T_WHITESPACE"," ",66],["T_VARIABLE","$_roundingDeltas",66],["T_WHITESPACE"," ",66],"=",["T_WHITESPACE"," ",66],["T_ARRAY","array",66],"(",")",";",["T_WHITESPACE","\n\n    ",66],["T_DOC_COMMENT","\/**\n     * Array for the base rounding deltas\n     *\n     * @var array\n     *\/",68],["T_WHITESPACE","\n    ",72],["T_PROTECTED","protected",73],["T_WHITESPACE"," ",73],["T_VARIABLE","$_baseRoundingDeltas",73],["T_WHITESPACE"," ",73],"=",["T_WHITESPACE"," ",73],["T_ARRAY","array",73],"(",")",";",["T_WHITESPACE","\n\n    ",73],["T_DOC_COMMENT","\/**\n     * @var Mage_Core_Model_Store\n     *\/",75],["T_WHITESPACE","\n    ",77],["T_PROTECTED","protected",78],["T_WHITESPACE"," ",78],["T_VARIABLE","$_store",78],";",["T_WHITESPACE","\n\n    ",78],["T_DOC_COMMENT","\/**\n     * Hidden taxes array\n     *\n     * @var array\n     *\/",80],["T_WHITESPACE","\n    ",84],["T_PROTECTED","protected",85],["T_WHITESPACE"," ",85],["T_VARIABLE","$_hiddenTaxes",85],["T_WHITESPACE"," ",85],"=",["T_WHITESPACE"," ",85],["T_ARRAY","array",85],"(",")",";",["T_WHITESPACE","\n\n\n    ",85],["T_DOC_COMMENT","\/**\n     * Weee helper class\n     *\n     * @var Mage_Weee_Helper_Data\n     *\/",88],["T_WHITESPACE","\n    ",92],["T_PROTECTED","protected",93],["T_WHITESPACE"," ",93],["T_VARIABLE","$_weeeHelper",93],";",["T_WHITESPACE","\n\n    ",93],["T_DOC_COMMENT","\/**\n     * Class constructor\n     *\/",95],["T_WHITESPACE","\n    ",97],["T_PUBLIC","public",98],["T_WHITESPACE"," ",98],["T_FUNCTION","function",98],["T_WHITESPACE"," ",98],["T_STRING","__construct",98],"(",")",["T_WHITESPACE","\n    ",98],"{",["T_WHITESPACE","\n        ",99],["T_VARIABLE","$this",100],["T_OBJECT_OPERATOR","->",100],["T_STRING","setCode",100],"(",["T_CONSTANT_ENCAPSED_STRING","'tax'",100],")",";",["T_WHITESPACE","\n        ",100],["T_VARIABLE","$this",101],["T_OBJECT_OPERATOR","->",101],["T_STRING","_helper",101],["T_WHITESPACE"," ",101],"=",["T_WHITESPACE"," ",101],["T_STRING","Mage",101],["T_DOUBLE_COLON","::",101],["T_STRING","helper",101],"(",["T_CONSTANT_ENCAPSED_STRING","'tax'",101],")",";",["T_WHITESPACE","\n        ",101],["T_VARIABLE","$this",102],["T_OBJECT_OPERATOR","->",102],["T_STRING","_calculator",102],["T_WHITESPACE"," ",102],"=",["T_WHITESPACE"," ",102],["T_STRING","Mage",102],["T_DOUBLE_COLON","::",102],["T_STRING","getSingleton",102],"(",["T_CONSTANT_ENCAPSED_STRING","'tax\/calculation'",102],")",";",["T_WHITESPACE","\n        ",102],["T_VARIABLE","$this",103],["T_OBJECT_OPERATOR","->",103],["T_STRING","_config",103],["T_WHITESPACE"," ",103],"=",["T_WHITESPACE"," ",103],["T_STRING","Mage",103],["T_DOUBLE_COLON","::",103],["T_STRING","getSingleton",103],"(",["T_CONSTANT_ENCAPSED_STRING","'tax\/config'",103],")",";",["T_WHITESPACE","\n        ",103],["T_VARIABLE","$this",104],["T_OBJECT_OPERATOR","->",104],["T_STRING","_weeeHelper",104],["T_WHITESPACE"," ",104],"=",["T_WHITESPACE"," ",104],["T_STRING","Mage",104],["T_DOUBLE_COLON","::",104],["T_STRING","helper",104],"(",["T_CONSTANT_ENCAPSED_STRING","'weee'",104],")",";",["T_WHITESPACE","\n    ",104],"}",["T_WHITESPACE","\n\n    ",105],["T_DOC_COMMENT","\/**\n     * Round the total amounts in address\n     *\n     * @param Mage_Sales_Model_Quote_Address $address\n     * @return Mage_Tax_Model_Sales_Total_Quote_Tax\n     *\/",107],["T_WHITESPACE","\n    ",112],["T_PROTECTED","protected",113],["T_WHITESPACE"," ",113],["T_FUNCTION","function",113],["T_WHITESPACE"," ",113],["T_STRING","_roundTotals",113],"(",["T_STRING","Mage_Sales_Model_Quote_Address",113],["T_WHITESPACE"," ",113],["T_VARIABLE","$address",113],")",["T_WHITESPACE","\n    ",113],"{",["T_WHITESPACE","\n        ",114],["T_COMMENT","\/\/ initialize the delta to a small number to avoid non-deterministic behavior with rounding of 0.5\n",115],["T_WHITESPACE","        ",116],["T_VARIABLE","$totalDelta",116],["T_WHITESPACE"," ",116],"=",["T_WHITESPACE"," ",116],["T_DNUMBER","0.000001",116],";",["T_WHITESPACE","\n        ",116],["T_VARIABLE","$baseTotalDelta",117],["T_WHITESPACE"," ",117],"=",["T_WHITESPACE"," ",117],["T_DNUMBER","0.000001",117],";",["T_WHITESPACE","\n        ",117],["T_COMMENT","\/*\n         * The order of rounding is import here.\n         * Tax is rounded first, to be consistent with unit based calculation.\n         * Hidden tax and shipping_hidden_tax are rounded next, which are really part of tax.\n         * Shipping is rounded before subtotal to minimize the chance that subtotal is\n         * rounded differently because of the delta.\n         * Here is an example: 19.2% tax rate, subtotal = 49.95, shipping = 9.99, discount = 20%\n         * subtotalExclTax = 41.90436, tax = 7.7238, hidden_tax = 1.609128, shippingPriceExclTax = 8.38087\n         * shipping_hidden_tax = 0.321826, discount = -11.988\n         * The grand total is 47.952 ~= 47.95\n         * The rounded values are:\n         * tax = 7.72, hidden_tax = 1.61, shipping_hidden_tax = 0.32,\n         * shipping = 8.39 (instead of 8.38 from simple rounding), subtotal = 41.9, discount = -11.99\n         * The grand total calculated from the rounded value is 47.95\n         * If we simply round each value and add them up, the result is 47.94, which is one penny off\n         *\/",118],["T_WHITESPACE","\n        ",133],["T_VARIABLE","$totalCodes",134],["T_WHITESPACE"," ",134],"=",["T_WHITESPACE"," ",134],["T_ARRAY","array",134],"(",["T_CONSTANT_ENCAPSED_STRING","'tax'",134],",",["T_WHITESPACE"," ",134],["T_CONSTANT_ENCAPSED_STRING","'hidden_tax'",134],",",["T_WHITESPACE"," ",134],["T_CONSTANT_ENCAPSED_STRING","'shipping_hidden_tax'",134],",",["T_WHITESPACE"," ",134],["T_CONSTANT_ENCAPSED_STRING","'shipping'",134],",",["T_WHITESPACE"," ",134],["T_CONSTANT_ENCAPSED_STRING","'subtotal'",134],",",["T_WHITESPACE"," ",134],["T_CONSTANT_ENCAPSED_STRING","'weee'",134],",",["T_WHITESPACE"," ",134],["T_CONSTANT_ENCAPSED_STRING","'discount'",134],")",";",["T_WHITESPACE","\n        ",134],["T_FOREACH","foreach",135],["T_WHITESPACE"," ",135],"(",["T_VARIABLE","$totalCodes",135],["T_WHITESPACE"," ",135],["T_AS","as",135],["T_WHITESPACE"," ",135],["T_VARIABLE","$totalCode",135],")",["T_WHITESPACE"," ",135],"{",["T_WHITESPACE","\n            ",135],["T_VARIABLE","$exactAmount",136],["T_WHITESPACE"," ",136],"=",["T_WHITESPACE"," ",136],["T_VARIABLE","$address",136],["T_OBJECT_OPERATOR","->",136],["T_STRING","getTotalAmount",136],"(",["T_VARIABLE","$totalCode",136],")",";",["T_WHITESPACE","\n            ",136],["T_VARIABLE","$baseExactAmount",137],["T_WHITESPACE"," ",137],"=",["T_WHITESPACE"," ",137],["T_VARIABLE","$address",137],["T_OBJECT_OPERATOR","->",137],["T_STRING","getBaseTotalAmount",137],"(",["T_VARIABLE","$totalCode",137],")",";",["T_WHITESPACE","\n            ",137],["T_IF","if",138],["T_WHITESPACE"," ",138],"(","!",["T_VARIABLE","$exactAmount",138],["T_WHITESPACE"," ",138],["T_BOOLEAN_AND","&&",138],["T_WHITESPACE"," ",138],"!",["T_VARIABLE","$baseExactAmount",138],")",["T_WHITESPACE"," ",138],"{",["T_WHITESPACE","\n                ",138],["T_CONTINUE","continue",139],";",["T_WHITESPACE","\n            ",139],"}",["T_WHITESPACE","\n            ",140],["T_VARIABLE","$roundedAmount",141],["T_WHITESPACE"," ",141],"=",["T_WHITESPACE"," ",141],["T_VARIABLE","$this",141],["T_OBJECT_OPERATOR","->",141],["T_STRING","_calculator",141],["T_OBJECT_OPERATOR","->",141],["T_STRING","round",141],"(",["T_VARIABLE","$exactAmount",141],["T_WHITESPACE"," ",141],"+",["T_WHITESPACE"," ",141],["T_VARIABLE","$totalDelta",141],")",";",["T_WHITESPACE","\n            ",141],["T_VARIABLE","$baseRoundedAmount",142],["T_WHITESPACE"," ",142],"=",["T_WHITESPACE"," ",142],["T_VARIABLE","$this",142],["T_OBJECT_OPERATOR","->",142],["T_STRING","_calculator",142],["T_OBJECT_OPERATOR","->",142],["T_STRING","round",142],"(",["T_VARIABLE","$baseExactAmount",142],["T_WHITESPACE"," ",142],"+",["T_WHITESPACE"," ",142],["T_VARIABLE","$baseTotalDelta",142],")",";",["T_WHITESPACE","\n            ",142],["T_VARIABLE","$address",143],["T_OBJECT_OPERATOR","->",143],["T_STRING","setTotalAmount",143],"(",["T_VARIABLE","$totalCode",143],",",["T_WHITESPACE"," ",143],["T_VARIABLE","$roundedAmount",143],")",";",["T_WHITESPACE","\n            ",143],["T_VARIABLE","$address",144],["T_OBJECT_OPERATOR","->",144],["T_STRING","setBaseTotalAmount",144],"(",["T_VARIABLE","$totalCode",144],",",["T_WHITESPACE"," ",144],["T_VARIABLE","$baseRoundedAmount",144],")",";",["T_WHITESPACE","\n            ",144],["T_VARIABLE","$totalDelta",145],["T_WHITESPACE"," ",145],"=",["T_WHITESPACE"," ",145],["T_VARIABLE","$exactAmount",145],["T_WHITESPACE"," ",145],"+",["T_WHITESPACE"," ",145],["T_VARIABLE","$totalDelta",145],["T_WHITESPACE"," ",145],"-",["T_WHITESPACE"," ",145],["T_VARIABLE","$roundedAmount",145],";",["T_WHITESPACE","\n            ",145],["T_VARIABLE","$baseTotalDelta",146],["T_WHITESPACE"," ",146],"=",["T_WHITESPACE"," ",146],["T_VARIABLE","$baseExactAmount",146],["T_WHITESPACE"," ",146],"+",["T_WHITESPACE"," ",146],["T_VARIABLE","$baseTotalDelta",146],["T_WHITESPACE"," ",146],"-",["T_WHITESPACE"," ",146],["T_VARIABLE","$baseRoundedAmount",146],";",["T_WHITESPACE","\n        ",146],"}",["T_WHITESPACE","\n        ",147],["T_RETURN","return",148],["T_WHITESPACE"," ",148],["T_VARIABLE","$this",148],";",["T_WHITESPACE","\n    ",148],"}",["T_WHITESPACE","\n\n    ",149],["T_DOC_COMMENT","\/**\n     * Collect tax totals for quote address\n     *\n     * @param   Mage_Sales_Model_Quote_Address $address\n     * @return  Mage_Tax_Model_Sales_Total_Quote\n     *\/",151],["T_WHITESPACE","\n    ",156],["T_PUBLIC","public",157],["T_WHITESPACE"," ",157],["T_FUNCTION","function",157],["T_WHITESPACE"," ",157],["T_STRING","collect",157],"(",["T_STRING","Mage_Sales_Model_Quote_Address",157],["T_WHITESPACE"," ",157],["T_VARIABLE","$address",157],")",["T_WHITESPACE","\n    ",157],"{",["T_WHITESPACE","\n        ",158],["T_STRING","parent",159],["T_DOUBLE_COLON","::",159],["T_STRING","collect",159],"(",["T_VARIABLE","$address",159],")",";",["T_WHITESPACE","\n        ",159],["T_VARIABLE","$this",160],["T_OBJECT_OPERATOR","->",160],["T_STRING","_roundingDeltas",160],["T_WHITESPACE"," ",160],"=",["T_WHITESPACE"," ",160],["T_ARRAY","array",160],"(",")",";",["T_WHITESPACE","\n        ",160],["T_VARIABLE","$this",161],["T_OBJECT_OPERATOR","->",161],["T_STRING","_baseRoundingDeltas",161],["T_WHITESPACE"," ",161],"=",["T_WHITESPACE"," ",161],["T_ARRAY","array",161],"(",")",";",["T_WHITESPACE","\n        ",161],["T_VARIABLE","$this",162],["T_OBJECT_OPERATOR","->",162],["T_STRING","_hiddenTaxes",162],["T_WHITESPACE"," ",162],"=",["T_WHITESPACE"," ",162],["T_ARRAY","array",162],"(",")",";",["T_WHITESPACE","\n        ",162],["T_VARIABLE","$address",163],["T_OBJECT_OPERATOR","->",163],["T_STRING","setShippingTaxAmount",163],"(",["T_LNUMBER","0",163],")",";",["T_WHITESPACE","\n        ",163],["T_VARIABLE","$address",164],["T_OBJECT_OPERATOR","->",164],["T_STRING","setBaseShippingTaxAmount",164],"(",["T_LNUMBER","0",164],")",";",["T_WHITESPACE","\n\n        ",164],["T_VARIABLE","$this",166],["T_OBJECT_OPERATOR","->",166],["T_STRING","_store",166],["T_WHITESPACE"," ",166],"=",["T_WHITESPACE"," ",166],["T_VARIABLE","$address",166],["T_OBJECT_OPERATOR","->",166],["T_STRING","getQuote",166],"(",")",["T_OBJECT_OPERATOR","->",166],["T_STRING","getStore",166],"(",")",";",["T_WHITESPACE","\n        ",166],["T_VARIABLE","$customer",167],["T_WHITESPACE"," ",167],"=",["T_WHITESPACE"," ",167],["T_VARIABLE","$address",167],["T_OBJECT_OPERATOR","->",167],["T_STRING","getQuote",167],"(",")",["T_OBJECT_OPERATOR","->",167],["T_STRING","getCustomer",167],"(",")",";",["T_WHITESPACE","\n        ",167],["T_IF","if",168],["T_WHITESPACE"," ",168],"(",["T_VARIABLE","$customer",168],")",["T_WHITESPACE"," ",168],"{",["T_WHITESPACE","\n            ",168],["T_VARIABLE","$this",169],["T_OBJECT_OPERATOR","->",169],["T_STRING","_calculator",169],["T_OBJECT_OPERATOR","->",169],["T_STRING","setCustomer",169],"(",["T_VARIABLE","$customer",169],")",";",["T_WHITESPACE","\n        ",169],"}",["T_WHITESPACE","\n\n        ",170],["T_IF","if",172],["T_WHITESPACE"," ",172],"(","!",["T_VARIABLE","$address",172],["T_OBJECT_OPERATOR","->",172],["T_STRING","getAppliedTaxesReset",172],"(",")",")",["T_WHITESPACE"," ",172],"{",["T_WHITESPACE","\n            ",172],["T_VARIABLE","$address",173],["T_OBJECT_OPERATOR","->",173],["T_STRING","setAppliedTaxes",173],"(",["T_ARRAY","array",173],"(",")",")",";",["T_WHITESPACE","\n        ",173],"}",["T_WHITESPACE","\n\n        ",174],["T_VARIABLE","$items",176],["T_WHITESPACE"," ",176],"=",["T_WHITESPACE"," ",176],["T_VARIABLE","$this",176],["T_OBJECT_OPERATOR","->",176],["T_STRING","_getAddressItems",176],"(",["T_VARIABLE","$address",176],")",";",["T_WHITESPACE","\n        ",176],["T_IF","if",177],["T_WHITESPACE"," ",177],"(","!",["T_STRING","count",177],"(",["T_VARIABLE","$items",177],")",")",["T_WHITESPACE"," ",177],"{",["T_WHITESPACE","\n            ",177],["T_RETURN","return",178],["T_WHITESPACE"," ",178],["T_VARIABLE","$this",178],";",["T_WHITESPACE","\n        ",178],"}",["T_WHITESPACE","\n        ",179],["T_VARIABLE","$request",180],["T_WHITESPACE"," ",180],"=",["T_WHITESPACE"," ",180],["T_VARIABLE","$this",180],["T_OBJECT_OPERATOR","->",180],["T_STRING","_calculator",180],["T_OBJECT_OPERATOR","->",180],["T_STRING","getRateRequest",180],"(",["T_WHITESPACE","\n            ",180],["T_VARIABLE","$address",181],",",["T_WHITESPACE","\n            ",181],["T_VARIABLE","$address",182],["T_OBJECT_OPERATOR","->",182],["T_STRING","getQuote",182],"(",")",["T_OBJECT_OPERATOR","->",182],["T_STRING","getBillingAddress",182],"(",")",",",["T_WHITESPACE","\n            ",182],["T_VARIABLE","$address",183],["T_OBJECT_OPERATOR","->",183],["T_STRING","getQuote",183],"(",")",["T_OBJECT_OPERATOR","->",183],["T_STRING","getCustomerTaxClassId",183],"(",")",",",["T_WHITESPACE","\n            ",183],["T_VARIABLE","$this",184],["T_OBJECT_OPERATOR","->",184],["T_STRING","_store",184],["T_WHITESPACE","\n        ",184],")",";",["T_WHITESPACE","\n\n        ",185],["T_IF","if",187],["T_WHITESPACE"," ",187],"(",["T_VARIABLE","$this",187],["T_OBJECT_OPERATOR","->",187],["T_STRING","_config",187],["T_OBJECT_OPERATOR","->",187],["T_STRING","priceIncludesTax",187],"(",["T_VARIABLE","$this",187],["T_OBJECT_OPERATOR","->",187],["T_STRING","_store",187],")",")",["T_WHITESPACE"," ",187],"{",["T_WHITESPACE","\n            ",187],["T_IF","if",188],["T_WHITESPACE"," ",188],"(",["T_VARIABLE","$this",188],["T_OBJECT_OPERATOR","->",188],["T_STRING","_helper",188],["T_OBJECT_OPERATOR","->",188],["T_STRING","isCrossBorderTradeEnabled",188],"(",["T_VARIABLE","$this",188],["T_OBJECT_OPERATOR","->",188],["T_STRING","_store",188],")",")",["T_WHITESPACE"," ",188],"{",["T_WHITESPACE","\n                ",188],["T_VARIABLE","$this",189],["T_OBJECT_OPERATOR","->",189],["T_STRING","_areTaxRequestsSimilar",189],["T_WHITESPACE"," ",189],"=",["T_WHITESPACE"," ",189],["T_STRING","true",189],";",["T_WHITESPACE","\n            ",189],"}",["T_WHITESPACE"," ",190],["T_ELSE","else",190],["T_WHITESPACE"," ",190],"{",["T_WHITESPACE","\n                ",190],["T_VARIABLE","$this",191],["T_OBJECT_OPERATOR","->",191],["T_STRING","_areTaxRequestsSimilar",191],["T_WHITESPACE"," ",191],"=",["T_WHITESPACE"," ",191],["T_VARIABLE","$this",191],["T_OBJECT_OPERATOR","->",191],["T_STRING","_calculator",191],["T_OBJECT_OPERATOR","->",191],["T_STRING","compareRequests",191],"(",["T_WHITESPACE","\n                    ",191],["T_VARIABLE","$this",192],["T_OBJECT_OPERATOR","->",192],["T_STRING","_calculator",192],["T_OBJECT_OPERATOR","->",192],["T_STRING","getRateOriginRequest",192],"(",["T_VARIABLE","$this",192],["T_OBJECT_OPERATOR","->",192],["T_STRING","_store",192],")",",",["T_WHITESPACE","\n                    ",192],["T_VARIABLE","$request",193],["T_WHITESPACE","\n                ",193],")",";",["T_WHITESPACE","\n            ",194],"}",["T_WHITESPACE","\n        ",195],"}",["T_WHITESPACE","\n\n        ",196],["T_SWITCH","switch",198],["T_WHITESPACE"," ",198],"(",["T_VARIABLE","$this",198],["T_OBJECT_OPERATOR","->",198],["T_STRING","_config",198],["T_OBJECT_OPERATOR","->",198],["T_STRING","getAlgorithm",198],"(",["T_VARIABLE","$this",198],["T_OBJECT_OPERATOR","->",198],["T_STRING","_store",198],")",")",["T_WHITESPACE"," ",198],"{",["T_WHITESPACE","\n            ",198],["T_CASE","case",199],["T_WHITESPACE"," ",199],["T_STRING","Mage_Tax_Model_Calculation",199],["T_DOUBLE_COLON","::",199],["T_STRING","CALC_UNIT_BASE",199],":",["T_WHITESPACE","\n                ",199],["T_VARIABLE","$this",200],["T_OBJECT_OPERATOR","->",200],["T_STRING","_unitBaseCalculation",200],"(",["T_VARIABLE","$address",200],",",["T_WHITESPACE"," ",200],["T_VARIABLE","$request",200],")",";",["T_WHITESPACE","\n                ",200],["T_BREAK","break",201],";",["T_WHITESPACE","\n            ",201],["T_CASE","case",202],["T_WHITESPACE"," ",202],["T_STRING","Mage_Tax_Model_Calculation",202],["T_DOUBLE_COLON","::",202],["T_STRING","CALC_ROW_BASE",202],":",["T_WHITESPACE","\n                ",202],["T_VARIABLE","$this",203],["T_OBJECT_OPERATOR","->",203],["T_STRING","_rowBaseCalculation",203],"(",["T_VARIABLE","$address",203],",",["T_WHITESPACE"," ",203],["T_VARIABLE","$request",203],")",";",["T_WHITESPACE","\n                ",203],["T_BREAK","break",204],";",["T_WHITESPACE","\n            ",204],["T_CASE","case",205],["T_WHITESPACE"," ",205],["T_STRING","Mage_Tax_Model_Calculation",205],["T_DOUBLE_COLON","::",205],["T_STRING","CALC_TOTAL_BASE",205],":",["T_WHITESPACE","\n                ",205],["T_VARIABLE","$this",206],["T_OBJECT_OPERATOR","->",206],["T_STRING","_totalBaseCalculation",206],"(",["T_VARIABLE","$address",206],",",["T_WHITESPACE"," ",206],["T_VARIABLE","$request",206],")",";",["T_WHITESPACE","\n                ",206],["T_BREAK","break",207],";",["T_WHITESPACE","\n            ",207],["T_DEFAULT","default",208],":",["T_WHITESPACE","\n                ",208],["T_BREAK","break",209],";",["T_WHITESPACE","\n        ",209],"}",["T_WHITESPACE","\n\n        ",210],["T_VARIABLE","$this",212],["T_OBJECT_OPERATOR","->",212],["T_STRING","_addAmount",212],"(",["T_VARIABLE","$address",212],["T_OBJECT_OPERATOR","->",212],["T_STRING","getExtraTaxAmount",212],"(",")",")",";",["T_WHITESPACE","\n        ",212],["T_VARIABLE","$this",213],["T_OBJECT_OPERATOR","->",213],["T_STRING","_addBaseAmount",213],"(",["T_VARIABLE","$address",213],["T_OBJECT_OPERATOR","->",213],["T_STRING","getBaseExtraTaxAmount",213],"(",")",")",";",["T_WHITESPACE","\n        ",213],["T_VARIABLE","$this",214],["T_OBJECT_OPERATOR","->",214],["T_STRING","_calculateShippingTax",214],"(",["T_VARIABLE","$address",214],",",["T_WHITESPACE"," ",214],["T_VARIABLE","$request",214],")",";",["T_WHITESPACE","\n\n        ",214],["T_VARIABLE","$this",216],["T_OBJECT_OPERATOR","->",216],["T_STRING","_processHiddenTaxes",216],"(",")",";",["T_WHITESPACE","\n\n        ",216],["T_COMMENT","\/\/round total amounts in address\n",218],["T_WHITESPACE","        ",219],["T_VARIABLE","$this",219],["T_OBJECT_OPERATOR","->",219],["T_STRING","_roundTotals",219],"(",["T_VARIABLE","$address",219],")",";",["T_WHITESPACE","\n        ",219],["T_RETURN","return",220],["T_WHITESPACE"," ",220],["T_VARIABLE","$this",220],";",["T_WHITESPACE","\n    ",220],"}",["T_WHITESPACE","\n\n    ",221],["T_DOC_COMMENT","\/**\n     * Process hidden taxes for items and shippings (in accordance with hidden tax type)\n     *\n     * @return void\n     *\/",223],["T_WHITESPACE","\n    ",227],["T_PROTECTED","protected",228],["T_WHITESPACE"," ",228],["T_FUNCTION","function",228],["T_WHITESPACE"," ",228],["T_STRING","_processHiddenTaxes",228],"(",")",["T_WHITESPACE","\n    ",228],"{",["T_WHITESPACE","\n        ",229],["T_VARIABLE","$this",230],["T_OBJECT_OPERATOR","->",230],["T_STRING","_getAddress",230],"(",")",["T_OBJECT_OPERATOR","->",230],["T_STRING","setTotalAmount",230],"(",["T_CONSTANT_ENCAPSED_STRING","'hidden_tax'",230],",",["T_WHITESPACE"," ",230],["T_LNUMBER","0",230],")",";",["T_WHITESPACE","\n        ",230],["T_VARIABLE","$this",231],["T_OBJECT_OPERATOR","->",231],["T_STRING","_getAddress",231],"(",")",["T_OBJECT_OPERATOR","->",231],["T_STRING","setBaseTotalAmount",231],"(",["T_CONSTANT_ENCAPSED_STRING","'hidden_tax'",231],",",["T_WHITESPACE"," ",231],["T_LNUMBER","0",231],")",";",["T_WHITESPACE","\n        ",231],["T_VARIABLE","$this",232],["T_OBJECT_OPERATOR","->",232],["T_STRING","_getAddress",232],"(",")",["T_OBJECT_OPERATOR","->",232],["T_STRING","setTotalAmount",232],"(",["T_CONSTANT_ENCAPSED_STRING","'shipping_hidden_tax'",232],",",["T_WHITESPACE"," ",232],["T_LNUMBER","0",232],")",";",["T_WHITESPACE","\n        ",232],["T_VARIABLE","$this",233],["T_OBJECT_OPERATOR","->",233],["T_STRING","_getAddress",233],"(",")",["T_OBJECT_OPERATOR","->",233],["T_STRING","setBaseTotalAmount",233],"(",["T_CONSTANT_ENCAPSED_STRING","'shipping_hidden_tax'",233],",",["T_WHITESPACE"," ",233],["T_LNUMBER","0",233],")",";",["T_WHITESPACE","\n        ",233],["T_FOREACH","foreach",234],["T_WHITESPACE"," ",234],"(",["T_VARIABLE","$this",234],["T_OBJECT_OPERATOR","->",234],["T_STRING","_hiddenTaxes",234],["T_WHITESPACE"," ",234],["T_AS","as",234],["T_WHITESPACE"," ",234],["T_VARIABLE","$taxInfoItem",234],")",["T_WHITESPACE"," ",234],"{",["T_WHITESPACE","\n            ",234],["T_IF","if",235],["T_WHITESPACE"," ",235],"(",["T_ISSET","isset",235],"(",["T_VARIABLE","$taxInfoItem",235],"[",["T_CONSTANT_ENCAPSED_STRING","'item'",235],"]",")",")",["T_WHITESPACE"," ",235],"{",["T_WHITESPACE","\n                ",235],["T_COMMENT","\/\/ Item hidden taxes\n",236],["T_WHITESPACE","                ",237],["T_VARIABLE","$item",237],["T_WHITESPACE"," ",237],"=",["T_WHITESPACE"," ",237],["T_VARIABLE","$taxInfoItem",237],"[",["T_CONSTANT_ENCAPSED_STRING","'item'",237],"]",";",["T_WHITESPACE","\n                ",237],["T_VARIABLE","$rateKey",238],["T_WHITESPACE"," ",238],"=",["T_WHITESPACE"," ",238],["T_VARIABLE","$taxInfoItem",238],"[",["T_CONSTANT_ENCAPSED_STRING","'rate_key'",238],"]",";",["T_WHITESPACE","\n                ",238],["T_VARIABLE","$hiddenTax",239],["T_WHITESPACE"," ",239],"=",["T_WHITESPACE"," ",239],["T_VARIABLE","$taxInfoItem",239],"[",["T_CONSTANT_ENCAPSED_STRING","'value'",239],"]",";",["T_WHITESPACE","\n                ",239],["T_VARIABLE","$baseHiddenTax",240],["T_WHITESPACE"," ",240],"=",["T_WHITESPACE"," ",240],["T_VARIABLE","$taxInfoItem",240],"[",["T_CONSTANT_ENCAPSED_STRING","'base_value'",240],"]",";",["T_WHITESPACE","\n                ",240],["T_VARIABLE","$inclTax",241],["T_WHITESPACE"," ",241],"=",["T_WHITESPACE"," ",241],["T_VARIABLE","$taxInfoItem",241],"[",["T_CONSTANT_ENCAPSED_STRING","'incl_tax'",241],"]",";",["T_WHITESPACE","\n                ",241],["T_VARIABLE","$qty",242],["T_WHITESPACE"," ",242],"=",["T_WHITESPACE"," ",242],["T_VARIABLE","$taxInfoItem",242],"[",["T_CONSTANT_ENCAPSED_STRING","'qty'",242],"]",";",["T_WHITESPACE","\n\n                ",242],["T_VARIABLE","$hiddenTax",244],["T_WHITESPACE"," ",244],"=",["T_WHITESPACE"," ",244],["T_VARIABLE","$this",244],["T_OBJECT_OPERATOR","->",244],["T_STRING","_calculator",244],["T_OBJECT_OPERATOR","->",244],["T_STRING","round",244],"(",["T_VARIABLE","$hiddenTax",244],")",";",["T_WHITESPACE","\n                ",244],["T_VARIABLE","$baseHiddenTax",245],["T_WHITESPACE"," ",245],"=",["T_WHITESPACE"," ",245],["T_VARIABLE","$this",245],["T_OBJECT_OPERATOR","->",245],["T_STRING","_calculator",245],["T_OBJECT_OPERATOR","->",245],["T_STRING","round",245],"(",["T_VARIABLE","$baseHiddenTax",245],")",";",["T_WHITESPACE","\n                ",245],["T_VARIABLE","$item",246],["T_OBJECT_OPERATOR","->",246],["T_STRING","setHiddenTaxAmount",246],"(",["T_STRING","max",246],"(",["T_LNUMBER","0",246],",",["T_WHITESPACE"," ",246],["T_VARIABLE","$qty",246],["T_WHITESPACE"," ",246],"*",["T_WHITESPACE"," ",246],["T_VARIABLE","$hiddenTax",246],")",")",";",["T_WHITESPACE","\n                ",246],["T_VARIABLE","$item",247],["T_OBJECT_OPERATOR","->",247],["T_STRING","setBaseHiddenTaxAmount",247],"(",["T_STRING","max",247],"(",["T_LNUMBER","0",247],",",["T_WHITESPACE"," ",247],["T_VARIABLE","$qty",247],["T_WHITESPACE"," ",247],"*",["T_WHITESPACE"," ",247],["T_VARIABLE","$baseHiddenTax",247],")",")",";",["T_WHITESPACE","\n                ",247],["T_VARIABLE","$this",248],["T_OBJECT_OPERATOR","->",248],["T_STRING","_getAddress",248],"(",")",["T_OBJECT_OPERATOR","->",248],["T_STRING","addTotalAmount",248],"(",["T_CONSTANT_ENCAPSED_STRING","'hidden_tax'",248],",",["T_WHITESPACE"," ",248],["T_VARIABLE","$item",248],["T_OBJECT_OPERATOR","->",248],["T_STRING","getHiddenTaxAmount",248],"(",")",")",";",["T_WHITESPACE","\n                ",248],["T_VARIABLE","$this",249],["T_OBJECT_OPERATOR","->",249],["T_STRING","_getAddress",249],"(",")",["T_OBJECT_OPERATOR","->",249],["T_STRING","addBaseTotalAmount",249],"(",["T_CONSTANT_ENCAPSED_STRING","'hidden_tax'",249],",",["T_WHITESPACE"," ",249],["T_VARIABLE","$item",249],["T_OBJECT_OPERATOR","->",249],["T_STRING","getBaseHiddenTaxAmount",249],"(",")",")",";",["T_WHITESPACE","\n            ",249],"}",["T_WHITESPACE"," ",250],["T_ELSE","else",250],["T_WHITESPACE"," ",250],"{",["T_WHITESPACE","\n                ",250],["T_COMMENT","\/\/ Shipping hidden taxes\n",251],["T_WHITESPACE","                ",252],["T_VARIABLE","$rateKey",252],["T_WHITESPACE"," ",252],"=",["T_WHITESPACE"," ",252],["T_VARIABLE","$taxInfoItem",252],"[",["T_CONSTANT_ENCAPSED_STRING","'rate_key'",252],"]",";",["T_WHITESPACE","\n                ",252],["T_VARIABLE","$hiddenTax",253],["T_WHITESPACE"," ",253],"=",["T_WHITESPACE"," ",253],["T_VARIABLE","$taxInfoItem",253],"[",["T_CONSTANT_ENCAPSED_STRING","'value'",253],"]",";",["T_WHITESPACE","\n                ",253],["T_VARIABLE","$baseHiddenTax",254],["T_WHITESPACE"," ",254],"=",["T_WHITESPACE"," ",254],["T_VARIABLE","$taxInfoItem",254],"[",["T_CONSTANT_ENCAPSED_STRING","'base_value'",254],"]",";",["T_WHITESPACE","\n                ",254],["T_VARIABLE","$inclTax",255],["T_WHITESPACE"," ",255],"=",["T_WHITESPACE"," ",255],["T_VARIABLE","$taxInfoItem",255],"[",["T_CONSTANT_ENCAPSED_STRING","'incl_tax'",255],"]",";",["T_WHITESPACE","\n\n                ",255],["T_VARIABLE","$hiddenTax",257],["T_WHITESPACE"," ",257],"=",["T_WHITESPACE"," ",257],["T_VARIABLE","$this",257],["T_OBJECT_OPERATOR","->",257],["T_STRING","_calculator",257],["T_OBJECT_OPERATOR","->",257],["T_STRING","round",257],"(",["T_VARIABLE","$hiddenTax",257],")",";",["T_WHITESPACE","\n                ",257],["T_VARIABLE","$baseHiddenTax",258],["T_WHITESPACE"," ",258],"=",["T_WHITESPACE"," ",258],["T_VARIABLE","$this",258],["T_OBJECT_OPERATOR","->",258],["T_STRING","_calculator",258],["T_OBJECT_OPERATOR","->",258],["T_STRING","round",258],"(",["T_VARIABLE","$baseHiddenTax",258],")",";",["T_WHITESPACE","\n\n                ",258],["T_VARIABLE","$this",260],["T_OBJECT_OPERATOR","->",260],["T_STRING","_getAddress",260],"(",")",["T_OBJECT_OPERATOR","->",260],["T_STRING","addTotalAmount",260],"(",["T_CONSTANT_ENCAPSED_STRING","'shipping_hidden_tax'",260],",",["T_WHITESPACE"," ",260],["T_VARIABLE","$hiddenTax",260],")",";",["T_WHITESPACE","\n                ",260],["T_VARIABLE","$this",261],["T_OBJECT_OPERATOR","->",261],["T_STRING","_getAddress",261],"(",")",["T_OBJECT_OPERATOR","->",261],["T_STRING","addBaseTotalAmount",261],"(",["T_CONSTANT_ENCAPSED_STRING","'shipping_hidden_tax'",261],",",["T_WHITESPACE"," ",261],["T_VARIABLE","$baseHiddenTax",261],")",";",["T_WHITESPACE","\n\n                ",261],["T_VARIABLE","$this",263],["T_OBJECT_OPERATOR","->",263],["T_STRING","_getAddress",263],"(",")",["T_OBJECT_OPERATOR","->",263],["T_STRING","setShippingHiddenTaxAmount",263],"(",["T_STRING","max",263],"(",["T_LNUMBER","0",263],",",["T_WHITESPACE"," ",263],["T_VARIABLE","$hiddenTax",263],")",")",";",["T_WHITESPACE","\n                ",263],["T_VARIABLE","$this",264],["T_OBJECT_OPERATOR","->",264],["T_STRING","_getAddress",264],"(",")",["T_OBJECT_OPERATOR","->",264],["T_STRING","setBaseShippingHiddenTaxAmount",264],"(",["T_STRING","max",264],"(",["T_LNUMBER","0",264],",",["T_WHITESPACE"," ",264],["T_VARIABLE","$baseHiddenTax",264],")",")",";",["T_WHITESPACE","\n            ",264],"}",["T_WHITESPACE","\n        ",265],"}",["T_WHITESPACE","\n    ",266],"}",["T_WHITESPACE","\n\n    ",267],["T_DOC_COMMENT","\/**\n     * Check if price include tax should be used for calculations.\n     * We are using price include tax just in case when catalog prices are including tax\n     * and customer tax request is same as store tax request\n     *\n     * @param $store\n     * @return bool\n     *\/",269],["T_WHITESPACE","\n    ",276],["T_PROTECTED","protected",277],["T_WHITESPACE"," ",277],["T_FUNCTION","function",277],["T_WHITESPACE"," ",277],["T_STRING","_usePriceIncludeTax",277],"(",["T_VARIABLE","$store",277],")",["T_WHITESPACE","\n    ",277],"{",["T_WHITESPACE","\n        ",278],["T_IF","if",279],["T_WHITESPACE"," ",279],"(",["T_VARIABLE","$this",279],["T_OBJECT_OPERATOR","->",279],["T_STRING","_config",279],["T_OBJECT_OPERATOR","->",279],["T_STRING","priceIncludesTax",279],"(",["T_VARIABLE","$store",279],")",["T_WHITESPACE"," ",279],["T_BOOLEAN_OR","||",279],["T_WHITESPACE"," ",279],["T_VARIABLE","$this",279],["T_OBJECT_OPERATOR","->",279],["T_STRING","_config",279],["T_OBJECT_OPERATOR","->",279],["T_STRING","getNeedUsePriceExcludeTax",279],"(",")",")",["T_WHITESPACE"," ",279],"{",["T_WHITESPACE","\n            ",279],["T_RETURN","return",280],["T_WHITESPACE"," ",280],["T_VARIABLE","$this",280],["T_OBJECT_OPERATOR","->",280],["T_STRING","_areTaxRequestsSimilar",280],";",["T_WHITESPACE","\n        ",280],"}",["T_WHITESPACE","\n        ",281],["T_RETURN","return",282],["T_WHITESPACE"," ",282],["T_STRING","false",282],";",["T_WHITESPACE","\n    ",282],"}",["T_WHITESPACE","\n\n    ",283],["T_DOC_COMMENT","\/**\n     *\n     * @param Mage_Sales_Model_Quote_Address $address\n     * @param float $rate\n     * @param array $appliedRates\n     * @param string $taxId\n     *\/",285],["T_WHITESPACE","\n    ",291],["T_PROTECTED","protected",292],["T_WHITESPACE"," ",292],["T_FUNCTION","function",292],["T_WHITESPACE"," ",292],["T_STRING","_calculateShippingTaxByRate",292],"(",["T_WHITESPACE","\n        ",292],["T_STRING","Mage_Sales_Model_Quote_Address",293],["T_WHITESPACE"," ",293],["T_VARIABLE","$address",293],",",["T_WHITESPACE"," ",293],["T_VARIABLE","$rate",293],",",["T_WHITESPACE"," ",293],["T_VARIABLE","$appliedRates",293],",",["T_WHITESPACE"," ",293],["T_VARIABLE","$taxId",293],["T_WHITESPACE"," ",293],"=",["T_WHITESPACE"," ",293],["T_STRING","null",293],")",["T_WHITESPACE","\n    ",293],"{",["T_WHITESPACE","\n        ",294],["T_VARIABLE","$inclTax",295],["T_WHITESPACE"," ",295],"=",["T_WHITESPACE"," ",295],["T_VARIABLE","$address",295],["T_OBJECT_OPERATOR","->",295],["T_STRING","getIsShippingInclTax",295],"(",")",";",["T_WHITESPACE","\n        ",295],["T_VARIABLE","$shipping",296],["T_WHITESPACE"," ",296],"=",["T_WHITESPACE"," ",296],["T_VARIABLE","$address",296],["T_OBJECT_OPERATOR","->",296],["T_STRING","getShippingTaxable",296],"(",")",";",["T_WHITESPACE","\n        ",296],["T_VARIABLE","$baseShipping",297],["T_WHITESPACE"," ",297],"=",["T_WHITESPACE"," ",297],["T_VARIABLE","$address",297],["T_OBJECT_OPERATOR","->",297],["T_STRING","getBaseShippingTaxable",297],"(",")",";",["T_WHITESPACE","\n        ",297],["T_VARIABLE","$rateKey",298],["T_WHITESPACE"," ",298],"=",["T_WHITESPACE"," ",298],"(",["T_VARIABLE","$taxId",298],["T_WHITESPACE"," ",298],["T_IS_EQUAL","==",298],["T_WHITESPACE"," ",298],["T_STRING","null",298],")",["T_WHITESPACE"," ",298],"?",["T_WHITESPACE"," ",298],["T_STRING_CAST","(string)",298],["T_VARIABLE","$rate",298],["T_WHITESPACE"," ",298],":",["T_WHITESPACE"," ",298],["T_VARIABLE","$taxId",298],";",["T_WHITESPACE","\n\n        ",298],["T_VARIABLE","$hiddenTax",300],["T_WHITESPACE"," ",300],"=",["T_WHITESPACE"," ",300],["T_STRING","null",300],";",["T_WHITESPACE","\n        ",300],["T_VARIABLE","$baseHiddenTax",301],["T_WHITESPACE"," ",301],"=",["T_WHITESPACE"," ",301],["T_STRING","null",301],";",["T_WHITESPACE","\n        ",301],["T_SWITCH","switch",302],["T_WHITESPACE"," ",302],"(",["T_VARIABLE","$this",302],["T_OBJECT_OPERATOR","->",302],["T_STRING","_helper",302],["T_OBJECT_OPERATOR","->",302],["T_STRING","getCalculationSequence",302],"(",["T_VARIABLE","$this",302],["T_OBJECT_OPERATOR","->",302],["T_STRING","_store",302],")",")",["T_WHITESPACE"," ",302],"{",["T_WHITESPACE","\n            ",302],["T_CASE","case",303],["T_WHITESPACE"," ",303],["T_STRING","Mage_Tax_Model_Calculation",303],["T_DOUBLE_COLON","::",303],["T_STRING","CALC_TAX_BEFORE_DISCOUNT_ON_EXCL",303],":",["T_WHITESPACE","\n            ",303],["T_CASE","case",304],["T_WHITESPACE"," ",304],["T_STRING","Mage_Tax_Model_Calculation",304],["T_DOUBLE_COLON","::",304],["T_STRING","CALC_TAX_BEFORE_DISCOUNT_ON_INCL",304],":",["T_WHITESPACE","\n                ",304],["T_VARIABLE","$tax",305],["T_WHITESPACE"," ",305],"=",["T_WHITESPACE"," ",305],["T_VARIABLE","$this",305],["T_OBJECT_OPERATOR","->",305],["T_STRING","_calculator",305],["T_OBJECT_OPERATOR","->",305],["T_STRING","calcTaxAmount",305],"(",["T_VARIABLE","$shipping",305],",",["T_WHITESPACE"," ",305],["T_VARIABLE","$rate",305],",",["T_WHITESPACE"," ",305],["T_VARIABLE","$inclTax",305],",",["T_WHITESPACE"," ",305],["T_STRING","false",305],")",";",["T_WHITESPACE","\n                ",305],["T_VARIABLE","$baseTax",306],["T_WHITESPACE"," ",306],"=",["T_WHITESPACE"," ",306],["T_VARIABLE","$this",306],["T_OBJECT_OPERATOR","->",306],["T_STRING","_calculator",306],["T_OBJECT_OPERATOR","->",306],["T_STRING","calcTaxAmount",306],"(",["T_VARIABLE","$baseShipping",306],",",["T_WHITESPACE"," ",306],["T_VARIABLE","$rate",306],",",["T_WHITESPACE"," ",306],["T_VARIABLE","$inclTax",306],",",["T_WHITESPACE"," ",306],["T_STRING","false",306],")",";",["T_WHITESPACE","\n                ",306],["T_BREAK","break",307],";",["T_WHITESPACE","\n            ",307],["T_CASE","case",308],["T_WHITESPACE"," ",308],["T_STRING","Mage_Tax_Model_Calculation",308],["T_DOUBLE_COLON","::",308],["T_STRING","CALC_TAX_AFTER_DISCOUNT_ON_EXCL",308],":",["T_WHITESPACE","\n            ",308],["T_CASE","case",309],["T_WHITESPACE"," ",309],["T_STRING","Mage_Tax_Model_Calculation",309],["T_DOUBLE_COLON","::",309],["T_STRING","CALC_TAX_AFTER_DISCOUNT_ON_INCL",309],":",["T_WHITESPACE","\n                ",309],["T_VARIABLE","$discountAmount",310],["T_WHITESPACE"," ",310],"=",["T_WHITESPACE"," ",310],["T_VARIABLE","$address",310],["T_OBJECT_OPERATOR","->",310],["T_STRING","getShippingDiscountAmount",310],"(",")",";",["T_WHITESPACE","\n                ",310],["T_VARIABLE","$baseDiscountAmount",311],["T_WHITESPACE"," ",311],"=",["T_WHITESPACE"," ",311],["T_VARIABLE","$address",311],["T_OBJECT_OPERATOR","->",311],["T_STRING","getBaseShippingDiscountAmount",311],"(",")",";",["T_WHITESPACE","\n                ",311],["T_VARIABLE","$tax",312],["T_WHITESPACE"," ",312],"=",["T_WHITESPACE"," ",312],["T_VARIABLE","$this",312],["T_OBJECT_OPERATOR","->",312],["T_STRING","_calculator",312],["T_OBJECT_OPERATOR","->",312],["T_STRING","calcTaxAmount",312],"(",["T_WHITESPACE","\n                    ",312],["T_VARIABLE","$shipping",313],["T_WHITESPACE"," ",313],"-",["T_WHITESPACE"," ",313],["T_VARIABLE","$discountAmount",313],",",["T_WHITESPACE","\n                    ",313],["T_VARIABLE","$rate",314],",",["T_WHITESPACE","\n                    ",314],["T_VARIABLE","$inclTax",315],",",["T_WHITESPACE","\n                    ",315],["T_STRING","false",316],["T_WHITESPACE","\n                ",316],")",";",["T_WHITESPACE","\n                ",317],["T_VARIABLE","$baseTax",318],["T_WHITESPACE"," ",318],"=",["T_WHITESPACE"," ",318],["T_VARIABLE","$this",318],["T_OBJECT_OPERATOR","->",318],["T_STRING","_calculator",318],["T_OBJECT_OPERATOR","->",318],["T_STRING","calcTaxAmount",318],"(",["T_WHITESPACE","\n                    ",318],["T_VARIABLE","$baseShipping",319],["T_WHITESPACE"," ",319],"-",["T_WHITESPACE"," ",319],["T_VARIABLE","$baseDiscountAmount",319],",",["T_WHITESPACE","\n                    ",319],["T_VARIABLE","$rate",320],",",["T_WHITESPACE","\n                    ",320],["T_VARIABLE","$inclTax",321],",",["T_WHITESPACE","\n                    ",321],["T_STRING","false",322],["T_WHITESPACE","\n                ",322],")",";",["T_WHITESPACE","\n                ",323],["T_BREAK","break",324],";",["T_WHITESPACE","\n        ",324],"}",["T_WHITESPACE","\n\n        ",325],["T_IF","if",327],["T_WHITESPACE"," ",327],"(",["T_VARIABLE","$this",327],["T_OBJECT_OPERATOR","->",327],["T_STRING","_config",327],["T_OBJECT_OPERATOR","->",327],["T_STRING","getAlgorithm",327],"(",["T_VARIABLE","$this",327],["T_OBJECT_OPERATOR","->",327],["T_STRING","_store",327],")",["T_WHITESPACE"," ",327],["T_IS_EQUAL","==",327],["T_WHITESPACE"," ",327],["T_STRING","Mage_Tax_Model_Calculation",327],["T_DOUBLE_COLON","::",327],["T_STRING","CALC_TOTAL_BASE",327],")",["T_WHITESPACE"," ",327],"{",["T_WHITESPACE","\n            ",327],["T_VARIABLE","$tax",328],["T_WHITESPACE"," ",328],"=",["T_WHITESPACE"," ",328],["T_VARIABLE","$this",328],["T_OBJECT_OPERATOR","->",328],["T_STRING","_deltaRound",328],"(",["T_VARIABLE","$tax",328],",",["T_WHITESPACE"," ",328],["T_VARIABLE","$rateKey",328],",",["T_WHITESPACE"," ",328],["T_VARIABLE","$inclTax",328],")",";",["T_WHITESPACE","\n            ",328],["T_VARIABLE","$baseTax",329],["T_WHITESPACE"," ",329],"=",["T_WHITESPACE"," ",329],["T_VARIABLE","$this",329],["T_OBJECT_OPERATOR","->",329],["T_STRING","_deltaRound",329],"(",["T_VARIABLE","$baseTax",329],",",["T_WHITESPACE"," ",329],["T_VARIABLE","$rateKey",329],",",["T_WHITESPACE"," ",329],["T_VARIABLE","$inclTax",329],",",["T_WHITESPACE"," ",329],["T_CONSTANT_ENCAPSED_STRING","'base'",329],")",";",["T_WHITESPACE","\n            ",329],["T_VARIABLE","$this",330],["T_OBJECT_OPERATOR","->",330],["T_STRING","_addAmount",330],"(",["T_STRING","max",330],"(",["T_LNUMBER","0",330],",",["T_WHITESPACE"," ",330],["T_VARIABLE","$tax",330],")",")",";",["T_WHITESPACE","\n            ",330],["T_VARIABLE","$this",331],["T_OBJECT_OPERATOR","->",331],["T_STRING","_addBaseAmount",331],"(",["T_STRING","max",331],"(",["T_LNUMBER","0",331],",",["T_WHITESPACE"," ",331],["T_VARIABLE","$baseTax",331],")",")",";",["T_WHITESPACE","\n        ",331],"}",["T_WHITESPACE"," ",332],["T_ELSE","else",332],["T_WHITESPACE"," ",332],"{",["T_WHITESPACE","\n            ",332],["T_VARIABLE","$tax",333],["T_WHITESPACE"," ",333],"=",["T_WHITESPACE"," ",333],["T_VARIABLE","$this",333],["T_OBJECT_OPERATOR","->",333],["T_STRING","_calculator",333],["T_OBJECT_OPERATOR","->",333],["T_STRING","round",333],"(",["T_VARIABLE","$tax",333],")",";",["T_WHITESPACE","\n            ",333],["T_VARIABLE","$baseTax",334],["T_WHITESPACE"," ",334],"=",["T_WHITESPACE"," ",334],["T_VARIABLE","$this",334],["T_OBJECT_OPERATOR","->",334],["T_STRING","_calculator",334],["T_OBJECT_OPERATOR","->",334],["T_STRING","round",334],"(",["T_VARIABLE","$baseTax",334],")",";",["T_WHITESPACE","\n            ",334],["T_VARIABLE","$this",335],["T_OBJECT_OPERATOR","->",335],["T_STRING","_addAmount",335],"(",["T_STRING","max",335],"(",["T_LNUMBER","0",335],",",["T_WHITESPACE"," ",335],["T_VARIABLE","$tax",335],")",")",";",["T_WHITESPACE","\n            ",335],["T_VARIABLE","$this",336],["T_OBJECT_OPERATOR","->",336],["T_STRING","_addBaseAmount",336],"(",["T_STRING","max",336],"(",["T_LNUMBER","0",336],",",["T_WHITESPACE"," ",336],["T_VARIABLE","$baseTax",336],")",")",";",["T_WHITESPACE","\n        ",336],"}",["T_WHITESPACE","\n\n        ",337],["T_IF","if",339],["T_WHITESPACE"," ",339],"(",["T_VARIABLE","$inclTax",339],["T_WHITESPACE"," ",339],["T_BOOLEAN_AND","&&",339],["T_WHITESPACE"," ",339],"!",["T_EMPTY","empty",339],"(",["T_VARIABLE","$discountAmount",339],")",")",["T_WHITESPACE"," ",339],"{",["T_WHITESPACE","\n            ",339],["T_VARIABLE","$taxBeforeDiscount",340],["T_WHITESPACE"," ",340],"=",["T_WHITESPACE"," ",340],["T_VARIABLE","$this",340],["T_OBJECT_OPERATOR","->",340],["T_STRING","_calculator",340],["T_OBJECT_OPERATOR","->",340],["T_STRING","calcTaxAmount",340],"(",["T_WHITESPACE","\n                ",340],["T_VARIABLE","$shipping",341],",",["T_WHITESPACE","\n                ",341],["T_VARIABLE","$rate",342],",",["T_WHITESPACE","\n                ",342],["T_VARIABLE","$inclTax",343],",",["T_WHITESPACE","\n                ",343],["T_STRING","false",344],["T_WHITESPACE","\n            ",344],")",";",["T_WHITESPACE","\n            ",345],["T_VARIABLE","$baseTaxBeforeDiscount",346],["T_WHITESPACE"," ",346],"=",["T_WHITESPACE"," ",346],["T_VARIABLE","$this",346],["T_OBJECT_OPERATOR","->",346],["T_STRING","_calculator",346],["T_OBJECT_OPERATOR","->",346],["T_STRING","calcTaxAmount",346],"(",["T_WHITESPACE","\n                ",346],["T_VARIABLE","$baseShipping",347],",",["T_WHITESPACE","\n                ",347],["T_VARIABLE","$rate",348],",",["T_WHITESPACE","\n                ",348],["T_VARIABLE","$inclTax",349],",",["T_WHITESPACE","\n                ",349],["T_STRING","false",350],["T_WHITESPACE","\n            ",350],")",";",["T_WHITESPACE","\n            ",351],["T_IF","if",352],["T_WHITESPACE"," ",352],"(",["T_VARIABLE","$this",352],["T_OBJECT_OPERATOR","->",352],["T_STRING","_config",352],["T_OBJECT_OPERATOR","->",352],["T_STRING","getAlgorithm",352],"(",["T_VARIABLE","$this",352],["T_OBJECT_OPERATOR","->",352],["T_STRING","_store",352],")",["T_WHITESPACE"," ",352],["T_IS_EQUAL","==",352],["T_WHITESPACE"," ",352],["T_STRING","Mage_Tax_Model_Calculation",352],["T_DOUBLE_COLON","::",352],["T_STRING","CALC_TOTAL_BASE",352],")",["T_WHITESPACE"," ",352],"{",["T_WHITESPACE","\n                ",352],["T_VARIABLE","$taxBeforeDiscount",353],["T_WHITESPACE"," ",353],"=",["T_WHITESPACE","\n                    ",353],["T_VARIABLE","$this",354],["T_OBJECT_OPERATOR","->",354],["T_STRING","_deltaRound",354],"(",["T_VARIABLE","$taxBeforeDiscount",354],",",["T_WHITESPACE"," ",354],["T_VARIABLE","$rateKey",354],",",["T_WHITESPACE"," ",354],["T_VARIABLE","$inclTax",354],",",["T_WHITESPACE"," ",354],["T_CONSTANT_ENCAPSED_STRING","'tax_before_discount'",354],")",";",["T_WHITESPACE","\n                ",354],["T_VARIABLE","$baseTaxBeforeDiscount",355],["T_WHITESPACE"," ",355],"=",["T_WHITESPACE","\n                    ",355],["T_VARIABLE","$this",356],["T_OBJECT_OPERATOR","->",356],["T_STRING","_deltaRound",356],"(",["T_VARIABLE","$baseTaxBeforeDiscount",356],",",["T_WHITESPACE"," ",356],["T_VARIABLE","$rateKey",356],",",["T_WHITESPACE"," ",356],["T_VARIABLE","$inclTax",356],",",["T_WHITESPACE"," ",356],["T_CONSTANT_ENCAPSED_STRING","'tax_before_discount_base'",356],")",";",["T_WHITESPACE","\n            ",356],"}",["T_WHITESPACE"," ",357],["T_ELSE","else",357],["T_WHITESPACE"," ",357],"{",["T_WHITESPACE","\n                ",357],["T_VARIABLE","$taxBeforeDiscount",358],["T_WHITESPACE"," ",358],"=",["T_WHITESPACE"," ",358],["T_VARIABLE","$this",358],["T_OBJECT_OPERATOR","->",358],["T_STRING","_calculator",358],["T_OBJECT_OPERATOR","->",358],["T_STRING","round",358],"(",["T_VARIABLE","$taxBeforeDiscount",358],")",";",["T_WHITESPACE","\n                ",358],["T_VARIABLE","$baseTaxBeforeDiscount",359],["T_WHITESPACE"," ",359],"=",["T_WHITESPACE"," ",359],["T_VARIABLE","$this",359],["T_OBJECT_OPERATOR","->",359],["T_STRING","_calculator",359],["T_OBJECT_OPERATOR","->",359],["T_STRING","round",359],"(",["T_VARIABLE","$baseTaxBeforeDiscount",359],")",";",["T_WHITESPACE","\n            ",359],"}",["T_WHITESPACE","\n            ",360],["T_VARIABLE","$hiddenTax",361],["T_WHITESPACE"," ",361],"=",["T_WHITESPACE"," ",361],["T_STRING","max",361],"(",["T_LNUMBER","0",361],",",["T_WHITESPACE"," ",361],["T_VARIABLE","$taxBeforeDiscount",361],["T_WHITESPACE"," ",361],"-",["T_WHITESPACE"," ",361],["T_STRING","max",361],"(",["T_LNUMBER","0",361],",",["T_WHITESPACE"," ",361],["T_VARIABLE","$tax",361],")",")",";",["T_WHITESPACE","\n            ",361],["T_VARIABLE","$baseHiddenTax",362],["T_WHITESPACE"," ",362],"=",["T_WHITESPACE"," ",362],["T_STRING","max",362],"(",["T_LNUMBER","0",362],",",["T_WHITESPACE"," ",362],["T_VARIABLE","$baseTaxBeforeDiscount",362],["T_WHITESPACE"," ",362],"-",["T_WHITESPACE"," ",362],["T_STRING","max",362],"(",["T_LNUMBER","0",362],",",["T_WHITESPACE"," ",362],["T_VARIABLE","$baseTax",362],")",")",";",["T_WHITESPACE","\n            ",362],["T_VARIABLE","$this",363],["T_OBJECT_OPERATOR","->",363],["T_STRING","_hiddenTaxes",363],"[","]",["T_WHITESPACE"," ",363],"=",["T_WHITESPACE"," ",363],["T_ARRAY","array",363],"(",["T_WHITESPACE","\n                ",363],["T_CONSTANT_ENCAPSED_STRING","'rate_key'",364],["T_WHITESPACE"," ",364],["T_DOUBLE_ARROW","=>",364],["T_WHITESPACE"," ",364],["T_VARIABLE","$rateKey",364],",",["T_WHITESPACE","\n                ",364],["T_CONSTANT_ENCAPSED_STRING","'value'",365],["T_WHITESPACE"," ",365],["T_DOUBLE_ARROW","=>",365],["T_WHITESPACE"," ",365],["T_VARIABLE","$hiddenTax",365],",",["T_WHITESPACE","\n                ",365],["T_CONSTANT_ENCAPSED_STRING","'base_value'",366],["T_WHITESPACE"," ",366],["T_DOUBLE_ARROW","=>",366],["T_WHITESPACE"," ",366],["T_VARIABLE","$baseHiddenTax",366],",",["T_WHITESPACE","\n                ",366],["T_CONSTANT_ENCAPSED_STRING","'incl_tax'",367],["T_WHITESPACE"," ",367],["T_DOUBLE_ARROW","=>",367],["T_WHITESPACE"," ",367],["T_VARIABLE","$inclTax",367],",",["T_WHITESPACE","\n            ",367],")",";",["T_WHITESPACE","\n        ",368],"}",["T_WHITESPACE","\n\n        ",369],["T_VARIABLE","$address",371],["T_OBJECT_OPERATOR","->",371],["T_STRING","setShippingTaxAmount",371],"(",["T_VARIABLE","$address",371],["T_OBJECT_OPERATOR","->",371],["T_STRING","getShippingTaxAmount",371],"(",")",["T_WHITESPACE"," ",371],"+",["T_WHITESPACE"," ",371],["T_STRING","max",371],"(",["T_LNUMBER","0",371],",",["T_WHITESPACE"," ",371],["T_VARIABLE","$tax",371],")",")",";",["T_WHITESPACE","\n        ",371],["T_VARIABLE","$address",372],["T_OBJECT_OPERATOR","->",372],["T_STRING","setBaseShippingTaxAmount",372],"(",["T_VARIABLE","$address",372],["T_OBJECT_OPERATOR","->",372],["T_STRING","getBaseShippingTaxAmount",372],"(",")",["T_WHITESPACE"," ",372],"+",["T_WHITESPACE"," ",372],["T_STRING","max",372],"(",["T_LNUMBER","0",372],",",["T_WHITESPACE"," ",372],["T_VARIABLE","$baseTax",372],")",")",";",["T_WHITESPACE","\n        ",372],["T_VARIABLE","$this",373],["T_OBJECT_OPERATOR","->",373],["T_STRING","_saveAppliedTaxes",373],"(",["T_VARIABLE","$address",373],",",["T_WHITESPACE"," ",373],["T_VARIABLE","$appliedRates",373],",",["T_WHITESPACE"," ",373],["T_VARIABLE","$tax",373],",",["T_WHITESPACE"," ",373],["T_VARIABLE","$baseTax",373],",",["T_WHITESPACE"," ",373],["T_VARIABLE","$rate",373],")",";",["T_WHITESPACE","\n    ",373],"}",["T_WHITESPACE","\n\n    ",374],["T_DOC_COMMENT","\/**\n     * Tax caclulation for shipping price\n     *\n     * @param   Mage_Sales_Model_Quote_Address $address\n     * @param   Varien_Object $taxRateRequest\n     * @return  Mage_Tax_Model_Sales_Total_Quote\n     *\/",376],["T_WHITESPACE","\n    ",382],["T_PROTECTED","protected",383],["T_WHITESPACE"," ",383],["T_FUNCTION","function",383],["T_WHITESPACE"," ",383],["T_STRING","_calculateShippingTax",383],"(",["T_STRING","Mage_Sales_Model_Quote_Address",383],["T_WHITESPACE"," ",383],["T_VARIABLE","$address",383],",",["T_WHITESPACE"," ",383],["T_VARIABLE","$taxRateRequest",383],")",["T_WHITESPACE","\n    ",383],"{",["T_WHITESPACE","\n        ",384],["T_VARIABLE","$taxRateRequest",385],["T_OBJECT_OPERATOR","->",385],["T_STRING","setProductClassId",385],"(",["T_VARIABLE","$this",385],["T_OBJECT_OPERATOR","->",385],["T_STRING","_config",385],["T_OBJECT_OPERATOR","->",385],["T_STRING","getShippingTaxClass",385],"(",["T_VARIABLE","$this",385],["T_OBJECT_OPERATOR","->",385],["T_STRING","_store",385],")",")",";",["T_WHITESPACE","\n        ",385],["T_VARIABLE","$rate",386],["T_WHITESPACE"," ",386],"=",["T_WHITESPACE"," ",386],["T_VARIABLE","$this",386],["T_OBJECT_OPERATOR","->",386],["T_STRING","_calculator",386],["T_OBJECT_OPERATOR","->",386],["T_STRING","getRate",386],"(",["T_VARIABLE","$taxRateRequest",386],")",";",["T_WHITESPACE","\n        ",386],["T_VARIABLE","$inclTax",387],["T_WHITESPACE"," ",387],"=",["T_WHITESPACE"," ",387],["T_VARIABLE","$address",387],["T_OBJECT_OPERATOR","->",387],["T_STRING","getIsShippingInclTax",387],"(",")",";",["T_WHITESPACE","\n\n        ",387],["T_VARIABLE","$address",389],["T_OBJECT_OPERATOR","->",389],["T_STRING","setShippingTaxAmount",389],"(",["T_LNUMBER","0",389],")",";",["T_WHITESPACE","\n        ",389],["T_VARIABLE","$address",390],["T_OBJECT_OPERATOR","->",390],["T_STRING","setBaseShippingTaxAmount",390],"(",["T_LNUMBER","0",390],")",";",["T_WHITESPACE","\n        ",390],["T_VARIABLE","$address",391],["T_OBJECT_OPERATOR","->",391],["T_STRING","setShippingHiddenTaxAmount",391],"(",["T_LNUMBER","0",391],")",";",["T_WHITESPACE","\n        ",391],["T_VARIABLE","$address",392],["T_OBJECT_OPERATOR","->",392],["T_STRING","setBaseShippingHiddenTaxAmount",392],"(",["T_LNUMBER","0",392],")",";",["T_WHITESPACE","\n        ",392],["T_VARIABLE","$appliedRates",393],["T_WHITESPACE"," ",393],"=",["T_WHITESPACE"," ",393],["T_VARIABLE","$this",393],["T_OBJECT_OPERATOR","->",393],["T_STRING","_calculator",393],["T_OBJECT_OPERATOR","->",393],["T_STRING","getAppliedRates",393],"(",["T_VARIABLE","$taxRateRequest",393],")",";",["T_WHITESPACE","\n        ",393],["T_IF","if",394],["T_WHITESPACE"," ",394],"(",["T_VARIABLE","$inclTax",394],")",["T_WHITESPACE"," ",394],"{",["T_WHITESPACE","\n            ",394],["T_VARIABLE","$this",395],["T_OBJECT_OPERATOR","->",395],["T_STRING","_calculateShippingTaxByRate",395],"(",["T_VARIABLE","$address",395],",",["T_WHITESPACE"," ",395],["T_VARIABLE","$rate",395],",",["T_WHITESPACE"," ",395],["T_VARIABLE","$appliedRates",395],")",";",["T_WHITESPACE","\n        ",395],"}",["T_WHITESPACE"," ",396],["T_ELSE","else",396],["T_WHITESPACE"," ",396],"{",["T_WHITESPACE","\n            ",396],["T_FOREACH","foreach",397],["T_WHITESPACE"," ",397],"(",["T_VARIABLE","$appliedRates",397],["T_WHITESPACE"," ",397],["T_AS","as",397],["T_WHITESPACE"," ",397],["T_VARIABLE","$appliedRate",397],")",["T_WHITESPACE"," ",397],"{",["T_WHITESPACE","\n                ",397],["T_VARIABLE","$taxRate",398],["T_WHITESPACE"," ",398],"=",["T_WHITESPACE"," ",398],["T_VARIABLE","$appliedRate",398],"[",["T_CONSTANT_ENCAPSED_STRING","'percent'",398],"]",";",["T_WHITESPACE","\n                ",398],["T_VARIABLE","$taxId",399],["T_WHITESPACE"," ",399],"=",["T_WHITESPACE"," ",399],["T_VARIABLE","$appliedRate",399],"[",["T_CONSTANT_ENCAPSED_STRING","'id'",399],"]",";",["T_WHITESPACE","\n                ",399],["T_VARIABLE","$this",400],["T_OBJECT_OPERATOR","->",400],["T_STRING","_calculateShippingTaxByRate",400],"(",["T_VARIABLE","$address",400],",",["T_WHITESPACE"," ",400],["T_VARIABLE","$taxRate",400],",",["T_WHITESPACE"," ",400],["T_ARRAY","array",400],"(",["T_VARIABLE","$appliedRate",400],")",",",["T_WHITESPACE"," ",400],["T_VARIABLE","$taxId",400],")",";",["T_WHITESPACE","\n            ",400],"}",["T_WHITESPACE","\n        ",401],"}",["T_WHITESPACE","\n        ",402],["T_RETURN","return",403],["T_WHITESPACE"," ",403],["T_VARIABLE","$this",403],";",["T_WHITESPACE","\n    ",403],"}",["T_WHITESPACE","\n\n    ",404],["T_DOC_COMMENT","\/**\n     * Calculate address tax amount based on one unit price and tax amount\n     *\n     * @param   Mage_Sales_Model_Quote_Address $address\n     * @return  Mage_Tax_Model_Sales_Total_Quote\n     *\/",406],["T_WHITESPACE","\n    ",411],["T_PROTECTED","protected",412],["T_WHITESPACE"," ",412],["T_FUNCTION","function",412],["T_WHITESPACE"," ",412],["T_STRING","_unitBaseCalculation",412],"(",["T_STRING","Mage_Sales_Model_Quote_Address",412],["T_WHITESPACE"," ",412],["T_VARIABLE","$address",412],",",["T_WHITESPACE"," ",412],["T_VARIABLE","$taxRateRequest",412],")",["T_WHITESPACE","\n    ",412],"{",["T_WHITESPACE","\n        ",413],["T_VARIABLE","$items",414],["T_WHITESPACE"," ",414],"=",["T_WHITESPACE"," ",414],["T_VARIABLE","$this",414],["T_OBJECT_OPERATOR","->",414],["T_STRING","_getAddressItems",414],"(",["T_VARIABLE","$address",414],")",";",["T_WHITESPACE","\n        ",414],["T_VARIABLE","$itemTaxGroups",415],["T_WHITESPACE"," ",415],"=",["T_WHITESPACE"," ",415],["T_ARRAY","array",415],"(",")",";",["T_WHITESPACE","\n        ",415],["T_VARIABLE","$store",416],["T_WHITESPACE"," ",416],"=",["T_WHITESPACE"," ",416],["T_VARIABLE","$address",416],["T_OBJECT_OPERATOR","->",416],["T_STRING","getQuote",416],"(",")",["T_OBJECT_OPERATOR","->",416],["T_STRING","getStore",416],"(",")",";",["T_WHITESPACE","\n        ",416],["T_VARIABLE","$catalogPriceInclTax",417],["T_WHITESPACE"," ",417],"=",["T_WHITESPACE"," ",417],["T_VARIABLE","$this",417],["T_OBJECT_OPERATOR","->",417],["T_STRING","_config",417],["T_OBJECT_OPERATOR","->",417],["T_STRING","priceIncludesTax",417],"(",["T_VARIABLE","$store",417],")",";",["T_WHITESPACE","\n\n        ",417],["T_FOREACH","foreach",419],["T_WHITESPACE"," ",419],"(",["T_VARIABLE","$items",419],["T_WHITESPACE"," ",419],["T_AS","as",419],["T_WHITESPACE"," ",419],["T_VARIABLE","$item",419],")",["T_WHITESPACE"," ",419],"{",["T_WHITESPACE","\n            ",419],["T_IF","if",420],["T_WHITESPACE"," ",420],"(",["T_VARIABLE","$item",420],["T_OBJECT_OPERATOR","->",420],["T_STRING","getParentItem",420],"(",")",")",["T_WHITESPACE"," ",420],"{",["T_WHITESPACE","\n                ",420],["T_CONTINUE","continue",421],";",["T_WHITESPACE","\n            ",421],"}",["T_WHITESPACE","\n\n            ",422],["T_IF","if",424],["T_WHITESPACE"," ",424],"(",["T_VARIABLE","$item",424],["T_OBJECT_OPERATOR","->",424],["T_STRING","getHasChildren",424],"(",")",["T_WHITESPACE"," ",424],["T_BOOLEAN_AND","&&",424],["T_WHITESPACE"," ",424],["T_VARIABLE","$item",424],["T_OBJECT_OPERATOR","->",424],["T_STRING","isChildrenCalculated",424],"(",")",")",["T_WHITESPACE"," ",424],"{",["T_WHITESPACE","\n                ",424],["T_FOREACH","foreach",425],["T_WHITESPACE"," ",425],"(",["T_VARIABLE","$item",425],["T_OBJECT_OPERATOR","->",425],["T_STRING","getChildren",425],"(",")",["T_WHITESPACE"," ",425],["T_AS","as",425],["T_WHITESPACE"," ",425],["T_VARIABLE","$child",425],")",["T_WHITESPACE"," ",425],"{",["T_WHITESPACE","\n                    ",425],["T_VARIABLE","$this",426],["T_OBJECT_OPERATOR","->",426],["T_STRING","_unitBaseProcessItemTax",426],"(",["T_WHITESPACE","\n                        ",426],["T_VARIABLE","$address",427],",",["T_WHITESPACE"," ",427],["T_VARIABLE","$child",427],",",["T_WHITESPACE"," ",427],["T_VARIABLE","$taxRateRequest",427],",",["T_WHITESPACE"," ",427],["T_VARIABLE","$itemTaxGroups",427],",",["T_WHITESPACE"," ",427],["T_VARIABLE","$catalogPriceInclTax",427],")",";",["T_WHITESPACE","\n                ",427],"}",["T_WHITESPACE","\n                ",428],["T_VARIABLE","$this",429],["T_OBJECT_OPERATOR","->",429],["T_STRING","_recalculateParent",429],"(",["T_VARIABLE","$item",429],")",";",["T_WHITESPACE","\n            ",429],"}",["T_WHITESPACE"," ",430],["T_ELSE","else",430],["T_WHITESPACE"," ",430],"{",["T_WHITESPACE","\n                ",430],["T_VARIABLE","$this",431],["T_OBJECT_OPERATOR","->",431],["T_STRING","_unitBaseProcessItemTax",431],"(",["T_WHITESPACE","\n                    ",431],["T_VARIABLE","$address",432],",",["T_WHITESPACE"," ",432],["T_VARIABLE","$item",432],",",["T_WHITESPACE"," ",432],["T_VARIABLE","$taxRateRequest",432],",",["T_WHITESPACE"," ",432],["T_VARIABLE","$itemTaxGroups",432],",",["T_WHITESPACE"," ",432],["T_VARIABLE","$catalogPriceInclTax",432],")",";",["T_WHITESPACE","\n            ",432],"}",["T_WHITESPACE","\n        ",433],"}",["T_WHITESPACE","\n        ",434],["T_IF","if",435],["T_WHITESPACE"," ",435],"(",["T_VARIABLE","$address",435],["T_OBJECT_OPERATOR","->",435],["T_STRING","getQuote",435],"(",")",["T_OBJECT_OPERATOR","->",435],["T_STRING","getTaxesForItems",435],"(",")",")",["T_WHITESPACE"," ",435],"{",["T_WHITESPACE","\n            ",435],["T_VARIABLE","$itemTaxGroups",436],["T_WHITESPACE"," ",436],["T_PLUS_EQUAL","+=",436],["T_WHITESPACE"," ",436],["T_VARIABLE","$address",436],["T_OBJECT_OPERATOR","->",436],["T_STRING","getQuote",436],"(",")",["T_OBJECT_OPERATOR","->",436],["T_STRING","getTaxesForItems",436],"(",")",";",["T_WHITESPACE","\n        ",436],"}",["T_WHITESPACE","\n        ",437],["T_VARIABLE","$address",438],["T_OBJECT_OPERATOR","->",438],["T_STRING","getQuote",438],"(",")",["T_OBJECT_OPERATOR","->",438],["T_STRING","setTaxesForItems",438],"(",["T_VARIABLE","$itemTaxGroups",438],")",";",["T_WHITESPACE","\n        ",438],["T_RETURN","return",439],["T_WHITESPACE"," ",439],["T_VARIABLE","$this",439],";",["T_WHITESPACE","\n    ",439],"}",["T_WHITESPACE","\n\n    ",440],["T_DOC_COMMENT","\/**\n     *\n     * @param Mage_Sales_Model_Quote_Address $address\n     * @param Mage_Sales_Model_Quote_Item_Abstract $item\n     * @param Varien_Object $taxRateRequest\n     * @param array $itemTaxGroups\n     * @param boolean $catalogPriceInclTax\n     *\/",442],["T_WHITESPACE","\n    ",449],["T_PROTECTED","protected",450],["T_WHITESPACE"," ",450],["T_FUNCTION","function",450],["T_WHITESPACE"," ",450],["T_STRING","_unitBaseProcessItemTax",450],"(",["T_WHITESPACE","\n        ",450],["T_VARIABLE","$address",451],",",["T_WHITESPACE"," ",451],["T_VARIABLE","$item",451],",",["T_WHITESPACE"," ",451],["T_VARIABLE","$taxRateRequest",451],",",["T_WHITESPACE"," ",451],"&",["T_VARIABLE","$itemTaxGroups",451],",",["T_WHITESPACE"," ",451],["T_VARIABLE","$catalogPriceInclTax",451],["T_WHITESPACE","\n    ",451],")",["T_WHITESPACE","\n    ",452],"{",["T_WHITESPACE","\n        ",453],["T_VARIABLE","$taxRateRequest",454],["T_OBJECT_OPERATOR","->",454],["T_STRING","setProductClassId",454],"(",["T_VARIABLE","$item",454],["T_OBJECT_OPERATOR","->",454],["T_STRING","getProduct",454],"(",")",["T_OBJECT_OPERATOR","->",454],["T_STRING","getTaxClassId",454],"(",")",")",";",["T_WHITESPACE","\n        ",454],["T_VARIABLE","$rate",455],["T_WHITESPACE"," ",455],"=",["T_WHITESPACE"," ",455],["T_VARIABLE","$this",455],["T_OBJECT_OPERATOR","->",455],["T_STRING","_calculator",455],["T_OBJECT_OPERATOR","->",455],["T_STRING","getRate",455],"(",["T_VARIABLE","$taxRateRequest",455],")",";",["T_WHITESPACE","\n\n        ",455],["T_VARIABLE","$item",457],["T_OBJECT_OPERATOR","->",457],["T_STRING","setTaxAmount",457],"(",["T_LNUMBER","0",457],")",";",["T_WHITESPACE","\n        ",457],["T_VARIABLE","$item",458],["T_OBJECT_OPERATOR","->",458],["T_STRING","setBaseTaxAmount",458],"(",["T_LNUMBER","0",458],")",";",["T_WHITESPACE","\n        ",458],["T_VARIABLE","$item",459],["T_OBJECT_OPERATOR","->",459],["T_STRING","setHiddenTaxAmount",459],"(",["T_LNUMBER","0",459],")",";",["T_WHITESPACE","\n        ",459],["T_VARIABLE","$item",460],["T_OBJECT_OPERATOR","->",460],["T_STRING","setBaseHiddenTaxAmount",460],"(",["T_LNUMBER","0",460],")",";",["T_WHITESPACE","\n        ",460],["T_VARIABLE","$item",461],["T_OBJECT_OPERATOR","->",461],["T_STRING","setTaxPercent",461],"(",["T_VARIABLE","$rate",461],")",";",["T_WHITESPACE","\n        ",461],["T_VARIABLE","$item",462],["T_OBJECT_OPERATOR","->",462],["T_STRING","setDiscountTaxCompensation",462],"(",["T_LNUMBER","0",462],")",";",["T_WHITESPACE","\n        ",462],["T_VARIABLE","$rowTotalInclTax",463],["T_WHITESPACE"," ",463],"=",["T_WHITESPACE"," ",463],["T_VARIABLE","$item",463],["T_OBJECT_OPERATOR","->",463],["T_STRING","getRowTotalInclTax",463],"(",")",";",["T_WHITESPACE","\n        ",463],["T_VARIABLE","$recalculateRowTotalInclTax",464],["T_WHITESPACE"," ",464],"=",["T_WHITESPACE"," ",464],["T_STRING","false",464],";",["T_WHITESPACE","\n        ",464],["T_IF","if",465],["T_WHITESPACE"," ",465],"(","!",["T_ISSET","isset",465],"(",["T_VARIABLE","$rowTotalInclTax",465],")",")",["T_WHITESPACE"," ",465],"{",["T_WHITESPACE","\n            ",465],["T_VARIABLE","$qty",466],["T_WHITESPACE"," ",466],"=",["T_WHITESPACE"," ",466],["T_VARIABLE","$item",466],["T_OBJECT_OPERATOR","->",466],["T_STRING","getTotalQty",466],"(",")",";",["T_WHITESPACE","\n            ",466],["T_VARIABLE","$item",467],["T_OBJECT_OPERATOR","->",467],["T_STRING","setRowTotalInclTax",467],"(",["T_VARIABLE","$this",467],["T_OBJECT_OPERATOR","->",467],["T_STRING","_store",467],["T_OBJECT_OPERATOR","->",467],["T_STRING","roundPrice",467],"(",["T_VARIABLE","$item",467],["T_OBJECT_OPERATOR","->",467],["T_STRING","getTaxableAmount",467],"(",")",["T_WHITESPACE"," ",467],"*",["T_WHITESPACE"," ",467],["T_VARIABLE","$qty",467],")",")",";",["T_WHITESPACE","\n            ",467],["T_VARIABLE","$item",468],["T_OBJECT_OPERATOR","->",468],["T_STRING","setBaseRowTotalInclTax",468],"(",["T_WHITESPACE","\n                ",468],["T_VARIABLE","$this",469],["T_OBJECT_OPERATOR","->",469],["T_STRING","_store",469],["T_OBJECT_OPERATOR","->",469],["T_STRING","roundPrice",469],"(",["T_VARIABLE","$item",469],["T_OBJECT_OPERATOR","->",469],["T_STRING","getBaseTaxableAmount",469],"(",")",["T_WHITESPACE"," ",469],"*",["T_WHITESPACE"," ",469],["T_VARIABLE","$qty",469],")",")",";",["T_WHITESPACE","\n            ",469],["T_VARIABLE","$recalculateRowTotalInclTax",470],["T_WHITESPACE"," ",470],"=",["T_WHITESPACE"," ",470],["T_STRING","true",470],";",["T_WHITESPACE","\n        ",470],"}",["T_WHITESPACE","\n\n        ",471],["T_VARIABLE","$appliedRates",473],["T_WHITESPACE"," ",473],"=",["T_WHITESPACE"," ",473],["T_VARIABLE","$this",473],["T_OBJECT_OPERATOR","->",473],["T_STRING","_calculator",473],["T_OBJECT_OPERATOR","->",473],["T_STRING","getAppliedRates",473],"(",["T_VARIABLE","$taxRateRequest",473],")",";",["T_WHITESPACE","\n        ",473],["T_VARIABLE","$item",474],["T_OBJECT_OPERATOR","->",474],["T_STRING","setTaxRates",474],"(",["T_VARIABLE","$appliedRates",474],")",";",["T_WHITESPACE","\n        ",474],["T_IF","if",475],["T_WHITESPACE"," ",475],"(",["T_VARIABLE","$catalogPriceInclTax",475],")",["T_WHITESPACE"," ",475],"{",["T_WHITESPACE","\n            ",475],["T_VARIABLE","$this",476],["T_OBJECT_OPERATOR","->",476],["T_STRING","_calcUnitTaxAmount",476],"(",["T_VARIABLE","$item",476],",",["T_WHITESPACE"," ",476],["T_VARIABLE","$rate",476],")",";",["T_WHITESPACE","\n            ",476],["T_VARIABLE","$this",477],["T_OBJECT_OPERATOR","->",477],["T_STRING","_saveAppliedTaxes",477],"(",["T_WHITESPACE","\n                ",477],["T_VARIABLE","$address",478],",",["T_WHITESPACE"," ",478],["T_VARIABLE","$appliedRates",478],",",["T_WHITESPACE"," ",478],["T_VARIABLE","$item",478],["T_OBJECT_OPERATOR","->",478],["T_STRING","getTaxAmount",478],"(",")",",",["T_WHITESPACE"," ",478],["T_VARIABLE","$item",478],["T_OBJECT_OPERATOR","->",478],["T_STRING","getBaseTaxAmount",478],"(",")",",",["T_WHITESPACE"," ",478],["T_VARIABLE","$rate",478],")",";",["T_WHITESPACE","\n        ",478],"}",["T_WHITESPACE"," ",479],["T_ELSE","else",479],["T_WHITESPACE"," ",479],"{",["T_WHITESPACE","\n            ",479],["T_COMMENT","\/\/need to calculate each tax separately\n",480],["T_WHITESPACE","            ",481],["T_VARIABLE","$taxGroups",481],["T_WHITESPACE"," ",481],"=",["T_WHITESPACE"," ",481],["T_ARRAY","array",481],"(",")",";",["T_WHITESPACE","\n            ",481],["T_FOREACH","foreach",482],["T_WHITESPACE"," ",482],"(",["T_VARIABLE","$appliedRates",482],["T_WHITESPACE"," ",482],["T_AS","as",482],["T_WHITESPACE"," ",482],["T_VARIABLE","$appliedTax",482],")",["T_WHITESPACE"," ",482],"{",["T_WHITESPACE","\n                ",482],["T_VARIABLE","$taxId",483],["T_WHITESPACE"," ",483],"=",["T_WHITESPACE"," ",483],["T_VARIABLE","$appliedTax",483],"[",["T_CONSTANT_ENCAPSED_STRING","'id'",483],"]",";",["T_WHITESPACE","\n                ",483],["T_VARIABLE","$taxRate",484],["T_WHITESPACE"," ",484],"=",["T_WHITESPACE"," ",484],["T_VARIABLE","$appliedTax",484],"[",["T_CONSTANT_ENCAPSED_STRING","'percent'",484],"]",";",["T_WHITESPACE","\n                ",484],["T_VARIABLE","$this",485],["T_OBJECT_OPERATOR","->",485],["T_STRING","_calcUnitTaxAmount",485],"(",["T_VARIABLE","$item",485],",",["T_WHITESPACE"," ",485],["T_VARIABLE","$taxRate",485],",",["T_WHITESPACE"," ",485],["T_VARIABLE","$taxGroups",485],",",["T_WHITESPACE"," ",485],["T_VARIABLE","$taxId",485],",",["T_WHITESPACE"," ",485],["T_VARIABLE","$recalculateRowTotalInclTax",485],")",";",["T_WHITESPACE","\n                ",485],["T_VARIABLE","$this",486],["T_OBJECT_OPERATOR","->",486],["T_STRING","_saveAppliedTaxes",486],"(",["T_WHITESPACE","\n                    ",486],["T_VARIABLE","$address",487],",",["T_WHITESPACE"," ",487],["T_ARRAY","array",487],"(",["T_VARIABLE","$appliedTax",487],")",",",["T_WHITESPACE"," ",487],["T_VARIABLE","$taxGroups",487],"[",["T_VARIABLE","$taxId",487],"]","[",["T_CONSTANT_ENCAPSED_STRING","'tax'",487],"]",",",["T_WHITESPACE"," ",487],["T_VARIABLE","$taxGroups",487],"[",["T_VARIABLE","$taxId",487],"]","[",["T_CONSTANT_ENCAPSED_STRING","'base_tax'",487],"]",",",["T_WHITESPACE"," ",487],["T_VARIABLE","$taxRate",487],")",";",["T_WHITESPACE","\n            ",487],"}",["T_WHITESPACE","\n            ",488],["T_COMMENT","\/\/We need to calculate weeeAmountInclTax using multiple tax rate here\n",489],["T_WHITESPACE","            ",490],["T_COMMENT","\/\/because the _calculateWeeeTax and _calculateRowWeeeTax only take one tax rate\n",490],["T_WHITESPACE","            ",491],["T_IF","if",491],["T_WHITESPACE"," ",491],"(",["T_VARIABLE","$this",491],["T_OBJECT_OPERATOR","->",491],["T_STRING","_weeeHelper",491],["T_OBJECT_OPERATOR","->",491],["T_STRING","isEnabled",491],"(",")",["T_WHITESPACE"," ",491],["T_BOOLEAN_AND","&&",491],["T_WHITESPACE"," ",491],["T_VARIABLE","$this",491],["T_OBJECT_OPERATOR","->",491],["T_STRING","_weeeHelper",491],["T_OBJECT_OPERATOR","->",491],["T_STRING","isTaxable",491],"(",")",")",["T_WHITESPACE"," ",491],"{",["T_WHITESPACE","\n                ",491],["T_VARIABLE","$this",492],["T_OBJECT_OPERATOR","->",492],["T_STRING","_calculateWeeeAmountInclTax",492],"(",["T_VARIABLE","$item",492],",",["T_WHITESPACE"," ",492],["T_VARIABLE","$appliedRates",492],",",["T_WHITESPACE"," ",492],["T_STRING","false",492],")",";",["T_WHITESPACE","\n                ",492],["T_VARIABLE","$this",493],["T_OBJECT_OPERATOR","->",493],["T_STRING","_calculateWeeeAmountInclTax",493],"(",["T_VARIABLE","$item",493],",",["T_WHITESPACE"," ",493],["T_VARIABLE","$appliedRates",493],",",["T_WHITESPACE"," ",493],["T_STRING","true",493],")",";",["T_WHITESPACE","\n            ",493],"}",["T_WHITESPACE","\n        ",494],"}",["T_WHITESPACE","\n        ",495],["T_IF","if",496],["T_WHITESPACE"," ",496],"(",["T_VARIABLE","$rate",496],["T_WHITESPACE"," ",496],">",["T_WHITESPACE"," ",496],["T_LNUMBER","0",496],")",["T_WHITESPACE"," ",496],"{",["T_WHITESPACE","\n            ",496],["T_VARIABLE","$itemTaxGroups",497],"[",["T_VARIABLE","$item",497],["T_OBJECT_OPERATOR","->",497],["T_STRING","getId",497],"(",")","]",["T_WHITESPACE"," ",497],"=",["T_WHITESPACE"," ",497],["T_VARIABLE","$appliedRates",497],";",["T_WHITESPACE","\n        ",497],"}",["T_WHITESPACE","\n        ",498],["T_VARIABLE","$this",499],["T_OBJECT_OPERATOR","->",499],["T_STRING","_addAmount",499],"(",["T_VARIABLE","$item",499],["T_OBJECT_OPERATOR","->",499],["T_STRING","getTaxAmount",499],"(",")",")",";",["T_WHITESPACE","\n        ",499],["T_VARIABLE","$this",500],["T_OBJECT_OPERATOR","->",500],["T_STRING","_addBaseAmount",500],"(",["T_VARIABLE","$item",500],["T_OBJECT_OPERATOR","->",500],["T_STRING","getBaseTaxAmount",500],"(",")",")",";",["T_WHITESPACE","\n        ",500],["T_RETURN","return",501],";",["T_WHITESPACE","\n    ",501],"}",["T_WHITESPACE","\n\n    ",502],["T_DOC_COMMENT","\/**\n     * Calculate unit tax anount based on unit price\n     *\n     * @param   Mage_Sales_Model_Quote_Item_Abstract $item\n     * @param   float $rate\n     * @param   array $taxGroups\n     * @param   string $taxId\n     * @param   boolean $recalculateRowTotalInclTax\n     * @return  Mage_Tax_Model_Sales_Total_Quote\n     *\/",504],["T_WHITESPACE","\n    ",513],["T_PROTECTED","protected",514],["T_WHITESPACE"," ",514],["T_FUNCTION","function",514],["T_WHITESPACE"," ",514],["T_STRING","_calcUnitTaxAmount",514],"(",["T_WHITESPACE","\n        ",514],["T_VARIABLE","$item",515],",",["T_WHITESPACE"," ",515],["T_VARIABLE","$rate",515],",",["T_WHITESPACE"," ",515],"&",["T_VARIABLE","$taxGroups",515],["T_WHITESPACE"," ",515],"=",["T_WHITESPACE"," ",515],["T_STRING","null",515],",",["T_WHITESPACE"," ",515],["T_VARIABLE","$taxId",515],["T_WHITESPACE"," ",515],"=",["T_WHITESPACE"," ",515],["T_STRING","null",515],",",["T_WHITESPACE"," ",515],["T_VARIABLE","$recalculateRowTotalInclTax",515],["T_WHITESPACE"," ",515],"=",["T_WHITESPACE"," ",515],["T_STRING","false",515],["T_WHITESPACE","\n    ",515],")",["T_WHITESPACE","\n    ",516],"{",["T_WHITESPACE","\n        ",517],["T_VARIABLE","$qty",518],["T_WHITESPACE"," ",518],"=",["T_WHITESPACE"," ",518],["T_VARIABLE","$item",518],["T_OBJECT_OPERATOR","->",518],["T_STRING","getTotalQty",518],"(",")",";",["T_WHITESPACE","\n        ",518],["T_VARIABLE","$inclTax",519],["T_WHITESPACE"," ",519],"=",["T_WHITESPACE"," ",519],["T_VARIABLE","$item",519],["T_OBJECT_OPERATOR","->",519],["T_STRING","getIsPriceInclTax",519],"(",")",";",["T_WHITESPACE","\n        ",519],["T_VARIABLE","$price",520],["T_WHITESPACE"," ",520],"=",["T_WHITESPACE"," ",520],["T_VARIABLE","$item",520],["T_OBJECT_OPERATOR","->",520],["T_STRING","getTaxableAmount",520],"(",")",";",["T_WHITESPACE","\n        ",520],["T_VARIABLE","$basePrice",521],["T_WHITESPACE"," ",521],"=",["T_WHITESPACE"," ",521],["T_VARIABLE","$item",521],["T_OBJECT_OPERATOR","->",521],["T_STRING","getBaseTaxableAmount",521],"(",")",";",["T_WHITESPACE","\n        ",521],["T_VARIABLE","$rateKey",522],["T_WHITESPACE"," ",522],"=",["T_WHITESPACE"," ",522],"(",["T_VARIABLE","$taxId",522],["T_WHITESPACE"," ",522],["T_IS_EQUAL","==",522],["T_WHITESPACE"," ",522],["T_STRING","null",522],")",["T_WHITESPACE"," ",522],"?",["T_WHITESPACE"," ",522],["T_STRING_CAST","(string)",522],["T_VARIABLE","$rate",522],["T_WHITESPACE"," ",522],":",["T_WHITESPACE"," ",522],["T_VARIABLE","$taxId",522],";",["T_WHITESPACE","\n\n        ",522],["T_VARIABLE","$isWeeeEnabled",524],["T_WHITESPACE"," ",524],"=",["T_WHITESPACE"," ",524],["T_VARIABLE","$this",524],["T_OBJECT_OPERATOR","->",524],["T_STRING","_weeeHelper",524],["T_OBJECT_OPERATOR","->",524],["T_STRING","isEnabled",524],"(",")",";",["T_WHITESPACE","\n        ",524],["T_VARIABLE","$isWeeeTaxable",525],["T_WHITESPACE"," ",525],"=",["T_WHITESPACE"," ",525],["T_VARIABLE","$this",525],["T_OBJECT_OPERATOR","->",525],["T_STRING","_weeeHelper",525],["T_OBJECT_OPERATOR","->",525],["T_STRING","isTaxable",525],"(",")",";",["T_WHITESPACE","\n\n        ",525],["T_VARIABLE","$hiddenTax",527],["T_WHITESPACE"," ",527],"=",["T_WHITESPACE"," ",527],["T_STRING","null",527],";",["T_WHITESPACE","\n        ",527],["T_VARIABLE","$baseHiddenTax",528],["T_WHITESPACE"," ",528],"=",["T_WHITESPACE"," ",528],["T_STRING","null",528],";",["T_WHITESPACE","\n        ",528],["T_VARIABLE","$weeeTax",529],["T_WHITESPACE"," ",529],"=",["T_WHITESPACE"," ",529],["T_STRING","null",529],";",["T_WHITESPACE","\n        ",529],["T_VARIABLE","$baseWeeeTax",530],["T_WHITESPACE"," ",530],"=",["T_WHITESPACE"," ",530],["T_STRING","null",530],";",["T_WHITESPACE","\n        ",530],["T_VARIABLE","$unitTaxBeforeDiscount",531],["T_WHITESPACE"," ",531],"=",["T_WHITESPACE"," ",531],["T_STRING","null",531],";",["T_WHITESPACE","\n        ",531],["T_VARIABLE","$weeeTaxBeforeDiscount",532],["T_WHITESPACE"," ",532],"=",["T_WHITESPACE"," ",532],["T_STRING","null",532],";",["T_WHITESPACE","\n        ",532],["T_VARIABLE","$baseUnitTaxBeforeDiscount",533],["T_WHITESPACE"," ",533],"=",["T_WHITESPACE"," ",533],["T_STRING","null",533],";",["T_WHITESPACE","\n        ",533],["T_VARIABLE","$baseWeeeTaxBeforeDiscount",534],["T_WHITESPACE"," ",534],"=",["T_WHITESPACE"," ",534],["T_STRING","null",534],";",["T_WHITESPACE","\n\n        ",534],["T_SWITCH","switch",536],["T_WHITESPACE"," ",536],"(",["T_VARIABLE","$this",536],["T_OBJECT_OPERATOR","->",536],["T_STRING","_config",536],["T_OBJECT_OPERATOR","->",536],["T_STRING","getCalculationSequence",536],"(",["T_VARIABLE","$this",536],["T_OBJECT_OPERATOR","->",536],["T_STRING","_store",536],")",")",["T_WHITESPACE"," ",536],"{",["T_WHITESPACE","\n            ",536],["T_CASE","case",537],["T_WHITESPACE"," ",537],["T_STRING","Mage_Tax_Model_Calculation",537],["T_DOUBLE_COLON","::",537],["T_STRING","CALC_TAX_BEFORE_DISCOUNT_ON_EXCL",537],":",["T_WHITESPACE","\n            ",537],["T_CASE","case",538],["T_WHITESPACE"," ",538],["T_STRING","Mage_Tax_Model_Calculation",538],["T_DOUBLE_COLON","::",538],["T_STRING","CALC_TAX_BEFORE_DISCOUNT_ON_INCL",538],":",["T_WHITESPACE","\n                ",538],["T_VARIABLE","$unitTaxBeforeDiscount",539],["T_WHITESPACE"," ",539],"=",["T_WHITESPACE"," ",539],["T_VARIABLE","$this",539],["T_OBJECT_OPERATOR","->",539],["T_STRING","_calculator",539],["T_OBJECT_OPERATOR","->",539],["T_STRING","calcTaxAmount",539],"(",["T_VARIABLE","$price",539],",",["T_WHITESPACE"," ",539],["T_VARIABLE","$rate",539],",",["T_WHITESPACE"," ",539],["T_VARIABLE","$inclTax",539],",",["T_WHITESPACE"," ",539],["T_STRING","false",539],")",";",["T_WHITESPACE","\n                ",539],["T_VARIABLE","$baseUnitTaxBeforeDiscount",540],["T_WHITESPACE"," ",540],"=",["T_WHITESPACE"," ",540],["T_VARIABLE","$this",540],["T_OBJECT_OPERATOR","->",540],["T_STRING","_calculator",540],["T_OBJECT_OPERATOR","->",540],["T_STRING","calcTaxAmount",540],"(",["T_VARIABLE","$basePrice",540],",",["T_WHITESPACE"," ",540],["T_VARIABLE","$rate",540],",",["T_WHITESPACE"," ",540],["T_VARIABLE","$inclTax",540],",",["T_WHITESPACE"," ",540],["T_STRING","false",540],")",";",["T_WHITESPACE","\n\n                ",540],["T_IF","if",542],["T_WHITESPACE"," ",542],"(",["T_VARIABLE","$isWeeeEnabled",542],["T_WHITESPACE"," ",542],["T_BOOLEAN_AND","&&",542],["T_WHITESPACE"," ",542],["T_VARIABLE","$isWeeeTaxable",542],")",["T_WHITESPACE"," ",542],"{",["T_WHITESPACE","\n                    ",542],["T_VARIABLE","$weeeTaxBeforeDiscount",543],["T_WHITESPACE"," ",543],"=",["T_WHITESPACE"," ",543],["T_VARIABLE","$this",543],["T_OBJECT_OPERATOR","->",543],["T_STRING","_calculateWeeeTax",543],"(",["T_LNUMBER","0",543],",",["T_WHITESPACE"," ",543],["T_VARIABLE","$item",543],",",["T_WHITESPACE"," ",543],["T_VARIABLE","$rate",543],",",["T_WHITESPACE"," ",543],["T_STRING","false",543],")",";",["T_WHITESPACE","\n                    ",543],["T_VARIABLE","$unitTaxBeforeDiscount",544],["T_WHITESPACE"," ",544],["T_PLUS_EQUAL","+=",544],["T_WHITESPACE"," ",544],["T_VARIABLE","$weeeTaxBeforeDiscount",544],";",["T_WHITESPACE","\n                    ",544],["T_VARIABLE","$baseWeeeTaxBeforeDiscount",545],["T_WHITESPACE"," ",545],"=",["T_WHITESPACE"," ",545],["T_VARIABLE","$this",545],["T_OBJECT_OPERATOR","->",545],["T_STRING","_calculateWeeeTax",545],"(",["T_LNUMBER","0",545],",",["T_WHITESPACE"," ",545],["T_VARIABLE","$item",545],",",["T_WHITESPACE"," ",545],["T_VARIABLE","$rate",545],")",";",["T_WHITESPACE","\n                    ",545],["T_VARIABLE","$baseUnitTaxBeforeDiscount",546],["T_WHITESPACE"," ",546],["T_PLUS_EQUAL","+=",546],["T_WHITESPACE"," ",546],["T_VARIABLE","$baseWeeeTaxBeforeDiscount",546],";",["T_WHITESPACE","\n                ",546],"}",["T_WHITESPACE","\n                ",547],["T_VARIABLE","$unitTaxBeforeDiscount",548],["T_WHITESPACE"," ",548],"=",["T_WHITESPACE"," ",548],["T_VARIABLE","$unitTax",548],["T_WHITESPACE"," ",548],"=",["T_WHITESPACE"," ",548],["T_VARIABLE","$this",548],["T_OBJECT_OPERATOR","->",548],["T_STRING","_calculator",548],["T_OBJECT_OPERATOR","->",548],["T_STRING","round",548],"(",["T_VARIABLE","$unitTaxBeforeDiscount",548],")",";",["T_WHITESPACE","\n                ",548],["T_VARIABLE","$baseUnitTaxBeforeDiscount",549],["T_WHITESPACE"," ",549],"=",["T_WHITESPACE"," ",549],["T_VARIABLE","$baseUnitTax",549],["T_WHITESPACE"," ",549],"=",["T_WHITESPACE"," ",549],["T_VARIABLE","$this",549],["T_OBJECT_OPERATOR","->",549],["T_STRING","_calculator",549],["T_OBJECT_OPERATOR","->",549],["T_STRING","round",549],"(",["T_VARIABLE","$baseUnitTaxBeforeDiscount",549],")",";",["T_WHITESPACE","\n                ",549],["T_BREAK","break",550],";",["T_WHITESPACE","\n            ",550],["T_CASE","case",551],["T_WHITESPACE"," ",551],["T_STRING","Mage_Tax_Model_Calculation",551],["T_DOUBLE_COLON","::",551],["T_STRING","CALC_TAX_AFTER_DISCOUNT_ON_EXCL",551],":",["T_WHITESPACE","\n            ",551],["T_CASE","case",552],["T_WHITESPACE"," ",552],["T_STRING","Mage_Tax_Model_Calculation",552],["T_DOUBLE_COLON","::",552],["T_STRING","CALC_TAX_AFTER_DISCOUNT_ON_INCL",552],":",["T_WHITESPACE","\n                ",552],["T_VARIABLE","$discountAmount",553],["T_WHITESPACE"," ",553],"=",["T_WHITESPACE"," ",553],["T_VARIABLE","$item",553],["T_OBJECT_OPERATOR","->",553],["T_STRING","getDiscountAmount",553],"(",")",["T_WHITESPACE"," ",553],"\/",["T_WHITESPACE"," ",553],["T_VARIABLE","$qty",553],";",["T_WHITESPACE","\n                ",553],["T_VARIABLE","$baseDiscountAmount",554],["T_WHITESPACE"," ",554],"=",["T_WHITESPACE"," ",554],["T_VARIABLE","$item",554],["T_OBJECT_OPERATOR","->",554],["T_STRING","getBaseDiscountAmount",554],"(",")",["T_WHITESPACE"," ",554],"\/",["T_WHITESPACE"," ",554],["T_VARIABLE","$qty",554],";",["T_WHITESPACE","\n\n                ",554],["T_COMMENT","\/\/We want to remove weee\n",556],["T_WHITESPACE","                ",557],["T_IF","if",557],["T_WHITESPACE"," ",557],"(",["T_VARIABLE","$isWeeeEnabled",557],["T_WHITESPACE"," ",557],["T_BOOLEAN_AND","&&",557],["T_WHITESPACE"," ",557],["T_VARIABLE","$this",557],["T_OBJECT_OPERATOR","->",557],["T_STRING","_weeeHelper",557],["T_OBJECT_OPERATOR","->",557],["T_STRING","includeInSubtotal",557],"(",")",")",["T_WHITESPACE"," ",557],"{",["T_WHITESPACE","\n                    ",557],["T_VARIABLE","$discountAmount",558],["T_WHITESPACE"," ",558],"=",["T_WHITESPACE"," ",558],["T_VARIABLE","$discountAmount",558],["T_WHITESPACE"," ",558],"-",["T_WHITESPACE"," ",558],["T_VARIABLE","$item",558],["T_OBJECT_OPERATOR","->",558],["T_STRING","getWeeeDiscount",558],"(",")",["T_WHITESPACE"," ",558],"\/",["T_WHITESPACE"," ",558],["T_VARIABLE","$qty",558],";",["T_WHITESPACE","\n                    ",558],["T_VARIABLE","$baseDiscountAmount",559],["T_WHITESPACE"," ",559],"=",["T_WHITESPACE"," ",559],["T_VARIABLE","$baseDiscountAmount",559],["T_WHITESPACE"," ",559],"-",["T_WHITESPACE"," ",559],["T_VARIABLE","$item",559],["T_OBJECT_OPERATOR","->",559],["T_STRING","getBaseWeeeDiscount",559],"(",")",["T_WHITESPACE"," ",559],"\/",["T_WHITESPACE"," ",559],["T_VARIABLE","$qty",559],";",["T_WHITESPACE","\n                ",559],"}",["T_WHITESPACE","\n\n                ",560],["T_VARIABLE","$unitTaxBeforeDiscount",562],["T_WHITESPACE"," ",562],"=",["T_WHITESPACE"," ",562],["T_VARIABLE","$this",562],["T_OBJECT_OPERATOR","->",562],["T_STRING","_calculator",562],["T_OBJECT_OPERATOR","->",562],["T_STRING","calcTaxAmount",562],"(",["T_VARIABLE","$price",562],",",["T_WHITESPACE"," ",562],["T_VARIABLE","$rate",562],",",["T_WHITESPACE"," ",562],["T_VARIABLE","$inclTax",562],",",["T_WHITESPACE"," ",562],["T_STRING","false",562],")",";",["T_WHITESPACE","\n                ",562],["T_VARIABLE","$unitTaxDiscount",563],["T_WHITESPACE"," ",563],"=",["T_WHITESPACE"," ",563],["T_VARIABLE","$this",563],["T_OBJECT_OPERATOR","->",563],["T_STRING","_calculator",563],["T_OBJECT_OPERATOR","->",563],["T_STRING","calcTaxAmount",563],"(",["T_VARIABLE","$discountAmount",563],",",["T_WHITESPACE"," ",563],["T_VARIABLE","$rate",563],",",["T_WHITESPACE"," ",563],["T_VARIABLE","$inclTax",563],",",["T_WHITESPACE"," ",563],["T_STRING","false",563],")",";",["T_WHITESPACE","\n                ",563],["T_VARIABLE","$unitTax",564],["T_WHITESPACE"," ",564],"=",["T_WHITESPACE"," ",564],["T_VARIABLE","$this",564],["T_OBJECT_OPERATOR","->",564],["T_STRING","_calculator",564],["T_OBJECT_OPERATOR","->",564],["T_STRING","round",564],"(",["T_STRING","max",564],"(",["T_VARIABLE","$unitTaxBeforeDiscount",564],["T_WHITESPACE"," ",564],"-",["T_WHITESPACE"," ",564],["T_VARIABLE","$unitTaxDiscount",564],",",["T_WHITESPACE"," ",564],["T_LNUMBER","0",564],")",")",";",["T_WHITESPACE","\n\n                ",564],["T_VARIABLE","$baseUnitTaxBeforeDiscount",566],["T_WHITESPACE"," ",566],"=",["T_WHITESPACE"," ",566],["T_VARIABLE","$this",566],["T_OBJECT_OPERATOR","->",566],["T_STRING","_calculator",566],["T_OBJECT_OPERATOR","->",566],["T_STRING","calcTaxAmount",566],"(",["T_VARIABLE","$basePrice",566],",",["T_WHITESPACE"," ",566],["T_VARIABLE","$rate",566],",",["T_WHITESPACE"," ",566],["T_VARIABLE","$inclTax",566],",",["T_WHITESPACE"," ",566],["T_STRING","false",566],")",";",["T_WHITESPACE","\n                ",566],["T_VARIABLE","$baseUnitTaxDiscount",567],["T_WHITESPACE"," ",567],"=",["T_WHITESPACE"," ",567],["T_VARIABLE","$this",567],["T_OBJECT_OPERATOR","->",567],["T_STRING","_calculator",567],["T_OBJECT_OPERATOR","->",567],["T_STRING","calcTaxAmount",567],"(",["T_VARIABLE","$baseDiscountAmount",567],",",["T_WHITESPACE"," ",567],["T_VARIABLE","$rate",567],",",["T_WHITESPACE"," ",567],["T_VARIABLE","$inclTax",567],",",["T_WHITESPACE"," ",567],["T_STRING","false",567],")",";",["T_WHITESPACE","\n                ",567],["T_VARIABLE","$baseUnitTax",568],["T_WHITESPACE"," ",568],"=",["T_WHITESPACE"," ",568],["T_VARIABLE","$this",568],["T_OBJECT_OPERATOR","->",568],["T_STRING","_calculator",568],["T_OBJECT_OPERATOR","->",568],["T_STRING","round",568],"(",["T_STRING","max",568],"(",["T_VARIABLE","$baseUnitTaxBeforeDiscount",568],["T_WHITESPACE"," ",568],"-",["T_WHITESPACE"," ",568],["T_VARIABLE","$baseUnitTaxDiscount",568],",",["T_WHITESPACE"," ",568],["T_LNUMBER","0",568],")",")",";",["T_WHITESPACE","\n\n                ",568],["T_IF","if",570],["T_WHITESPACE"," ",570],"(",["T_VARIABLE","$isWeeeEnabled",570],["T_WHITESPACE"," ",570],["T_BOOLEAN_AND","&&",570],["T_WHITESPACE"," ",570],["T_VARIABLE","$this",570],["T_OBJECT_OPERATOR","->",570],["T_STRING","_weeeHelper",570],["T_OBJECT_OPERATOR","->",570],["T_STRING","isTaxable",570],"(",")",")",["T_WHITESPACE"," ",570],"{",["T_WHITESPACE","\n                    ",570],["T_VARIABLE","$weeeTax",571],["T_WHITESPACE"," ",571],"=",["T_WHITESPACE"," ",571],["T_VARIABLE","$this",571],["T_OBJECT_OPERATOR","->",571],["T_STRING","_calculateRowWeeeTax",571],"(",["T_VARIABLE","$item",571],["T_OBJECT_OPERATOR","->",571],["T_STRING","getWeeeDiscount",571],"(",")",",",["T_WHITESPACE"," ",571],["T_VARIABLE","$item",571],",",["T_WHITESPACE"," ",571],["T_VARIABLE","$rate",571],",",["T_WHITESPACE"," ",571],["T_STRING","false",571],")",";",["T_WHITESPACE","\n                    ",571],["T_VARIABLE","$weeeTax",572],["T_WHITESPACE"," ",572],"=",["T_WHITESPACE"," ",572],["T_VARIABLE","$weeeTax",572],["T_WHITESPACE"," ",572],"\/",["T_WHITESPACE"," ",572],["T_VARIABLE","$qty",572],";",["T_WHITESPACE","\n                    ",572],["T_VARIABLE","$unitTax",573],["T_WHITESPACE"," ",573],["T_PLUS_EQUAL","+=",573],["T_WHITESPACE"," ",573],["T_VARIABLE","$weeeTax",573],";",["T_WHITESPACE","\n                    ",573],["T_VARIABLE","$baseWeeeTax",574],["T_WHITESPACE"," ",574],"=",["T_WHITESPACE"," ",574],["T_VARIABLE","$this",574],["T_OBJECT_OPERATOR","->",574],["T_STRING","_calculateRowWeeeTax",574],"(",["T_VARIABLE","$item",574],["T_OBJECT_OPERATOR","->",574],["T_STRING","getBaseWeeeDiscount",574],"(",")",",",["T_WHITESPACE"," ",574],["T_VARIABLE","$item",574],",",["T_WHITESPACE"," ",574],["T_VARIABLE","$rate",574],")",";",["T_WHITESPACE","\n                    ",574],["T_VARIABLE","$baseWeeeTax",575],["T_WHITESPACE"," ",575],"=",["T_WHITESPACE"," ",575],["T_VARIABLE","$baseWeeeTax",575],["T_WHITESPACE"," ",575],"\/",["T_WHITESPACE"," ",575],["T_VARIABLE","$qty",575],";",["T_WHITESPACE","\n                    ",575],["T_VARIABLE","$baseUnitTax",576],["T_WHITESPACE"," ",576],["T_PLUS_EQUAL","+=",576],["T_WHITESPACE"," ",576],["T_VARIABLE","$baseWeeeTax",576],";",["T_WHITESPACE","\n                ",576],"}",["T_WHITESPACE","\n\n                ",577],["T_VARIABLE","$unitTax",579],["T_WHITESPACE"," ",579],"=",["T_WHITESPACE"," ",579],["T_VARIABLE","$this",579],["T_OBJECT_OPERATOR","->",579],["T_STRING","_calculator",579],["T_OBJECT_OPERATOR","->",579],["T_STRING","round",579],"(",["T_VARIABLE","$unitTax",579],")",";",["T_WHITESPACE","\n                ",579],["T_VARIABLE","$baseUnitTax",580],["T_WHITESPACE"," ",580],"=",["T_WHITESPACE"," ",580],["T_VARIABLE","$this",580],["T_OBJECT_OPERATOR","->",580],["T_STRING","_calculator",580],["T_OBJECT_OPERATOR","->",580],["T_STRING","round",580],"(",["T_VARIABLE","$baseUnitTax",580],")",";",["T_WHITESPACE","\n\n                ",580],["T_COMMENT","\/\/Calculate the weee taxes before discount\n",582],["T_WHITESPACE","                ",583],["T_VARIABLE","$weeeTaxBeforeDiscount",583],["T_WHITESPACE"," ",583],"=",["T_WHITESPACE"," ",583],["T_LNUMBER","0",583],";",["T_WHITESPACE","\n                ",583],["T_VARIABLE","$baseWeeeTaxBeforeDiscount",584],["T_WHITESPACE"," ",584],"=",["T_WHITESPACE"," ",584],["T_LNUMBER","0",584],";",["T_WHITESPACE","\n\n                ",584],["T_IF","if",586],["T_WHITESPACE"," ",586],"(",["T_VARIABLE","$isWeeeTaxable",586],")",["T_WHITESPACE"," ",586],"{",["T_WHITESPACE","\n                    ",586],["T_VARIABLE","$weeeTaxBeforeDiscount",587],["T_WHITESPACE"," ",587],"=",["T_WHITESPACE"," ",587],["T_VARIABLE","$this",587],["T_OBJECT_OPERATOR","->",587],["T_STRING","_calculateWeeeTax",587],"(",["T_LNUMBER","0",587],",",["T_WHITESPACE"," ",587],["T_VARIABLE","$item",587],",",["T_WHITESPACE"," ",587],["T_VARIABLE","$rate",587],",",["T_WHITESPACE"," ",587],["T_STRING","false",587],")",";",["T_WHITESPACE","\n                    ",587],["T_VARIABLE","$unitTaxBeforeDiscount",588],["T_WHITESPACE"," ",588],["T_PLUS_EQUAL","+=",588],["T_WHITESPACE"," ",588],["T_VARIABLE","$weeeTaxBeforeDiscount",588],";",["T_WHITESPACE","\n                    ",588],["T_VARIABLE","$baseWeeeTaxBeforeDiscount",589],["T_WHITESPACE"," ",589],"=",["T_WHITESPACE"," ",589],["T_VARIABLE","$this",589],["T_OBJECT_OPERATOR","->",589],["T_STRING","_calculateWeeeTax",589],"(",["T_LNUMBER","0",589],",",["T_WHITESPACE"," ",589],["T_VARIABLE","$item",589],",",["T_WHITESPACE"," ",589],["T_VARIABLE","$rate",589],")",";",["T_WHITESPACE","\n                    ",589],["T_VARIABLE","$baseUnitTaxBeforeDiscount",590],["T_WHITESPACE"," ",590],["T_PLUS_EQUAL","+=",590],["T_WHITESPACE"," ",590],["T_VARIABLE","$baseWeeeTaxBeforeDiscount",590],";",["T_WHITESPACE","\n                ",590],"}",["T_WHITESPACE","\n\n                ",591],["T_VARIABLE","$unitTaxBeforeDiscount",593],["T_WHITESPACE"," ",593],"=",["T_WHITESPACE"," ",593],["T_STRING","max",593],"(",["T_LNUMBER","0",593],",",["T_WHITESPACE"," ",593],["T_VARIABLE","$this",593],["T_OBJECT_OPERATOR","->",593],["T_STRING","_calculator",593],["T_OBJECT_OPERATOR","->",593],["T_STRING","round",593],"(",["T_VARIABLE","$unitTaxBeforeDiscount",593],")",")",";",["T_WHITESPACE","\n                ",593],["T_VARIABLE","$baseUnitTaxBeforeDiscount",594],["T_WHITESPACE"," ",594],"=",["T_WHITESPACE"," ",594],["T_STRING","max",594],"(",["T_LNUMBER","0",594],",",["T_WHITESPACE"," ",594],["T_VARIABLE","$this",594],["T_OBJECT_OPERATOR","->",594],["T_STRING","_calculator",594],["T_OBJECT_OPERATOR","->",594],["T_STRING","round",594],"(",["T_VARIABLE","$baseUnitTaxBeforeDiscount",594],")",")",";",["T_WHITESPACE","\n\n                ",594],["T_IF","if",596],["T_WHITESPACE"," ",596],"(",["T_VARIABLE","$inclTax",596],["T_WHITESPACE"," ",596],["T_BOOLEAN_AND","&&",596],["T_WHITESPACE"," ",596],["T_VARIABLE","$discountAmount",596],["T_WHITESPACE"," ",596],">",["T_WHITESPACE"," ",596],["T_LNUMBER","0",596],")",["T_WHITESPACE"," ",596],"{",["T_WHITESPACE","\n                    ",596],["T_VARIABLE","$hiddenTax",597],["T_WHITESPACE"," ",597],"=",["T_WHITESPACE"," ",597],["T_VARIABLE","$unitTaxBeforeDiscount",597],["T_WHITESPACE"," ",597],"-",["T_WHITESPACE"," ",597],["T_VARIABLE","$unitTax",597],";",["T_WHITESPACE","\n                    ",597],["T_VARIABLE","$baseHiddenTax",598],["T_WHITESPACE"," ",598],"=",["T_WHITESPACE"," ",598],["T_VARIABLE","$baseUnitTaxBeforeDiscount",598],["T_WHITESPACE"," ",598],"-",["T_WHITESPACE"," ",598],["T_VARIABLE","$baseUnitTax",598],";",["T_WHITESPACE","\n                    ",598],["T_VARIABLE","$this",599],["T_OBJECT_OPERATOR","->",599],["T_STRING","_hiddenTaxes",599],"[","]",["T_WHITESPACE"," ",599],"=",["T_WHITESPACE"," ",599],["T_ARRAY","array",599],"(",["T_WHITESPACE","\n                        ",599],["T_CONSTANT_ENCAPSED_STRING","'rate_key'",600],["T_WHITESPACE"," ",600],["T_DOUBLE_ARROW","=>",600],["T_WHITESPACE"," ",600],["T_VARIABLE","$rateKey",600],",",["T_WHITESPACE","\n                        ",600],["T_CONSTANT_ENCAPSED_STRING","'qty'",601],["T_WHITESPACE"," ",601],["T_DOUBLE_ARROW","=>",601],["T_WHITESPACE"," ",601],["T_VARIABLE","$qty",601],",",["T_WHITESPACE","\n                        ",601],["T_CONSTANT_ENCAPSED_STRING","'item'",602],["T_WHITESPACE"," ",602],["T_DOUBLE_ARROW","=>",602],["T_WHITESPACE"," ",602],["T_VARIABLE","$item",602],",",["T_WHITESPACE","\n                        ",602],["T_CONSTANT_ENCAPSED_STRING","'value'",603],["T_WHITESPACE"," ",603],["T_DOUBLE_ARROW","=>",603],["T_WHITESPACE"," ",603],["T_VARIABLE","$hiddenTax",603],",",["T_WHITESPACE","\n                        ",603],["T_CONSTANT_ENCAPSED_STRING","'base_value'",604],["T_WHITESPACE"," ",604],["T_DOUBLE_ARROW","=>",604],["T_WHITESPACE"," ",604],["T_VARIABLE","$baseHiddenTax",604],",",["T_WHITESPACE","\n                        ",604],["T_CONSTANT_ENCAPSED_STRING","'incl_tax'",605],["T_WHITESPACE"," ",605],["T_DOUBLE_ARROW","=>",605],["T_WHITESPACE"," ",605],["T_VARIABLE","$inclTax",605],",",["T_WHITESPACE","\n                    ",605],")",";",["T_WHITESPACE","\n                ",606],"}",["T_WHITESPACE"," ",607],["T_ELSEIF","elseif",607],["T_WHITESPACE"," ",607],"(",["T_VARIABLE","$discountAmount",607],["T_WHITESPACE"," ",607],">",["T_WHITESPACE"," ",607],["T_VARIABLE","$price",607],")",["T_WHITESPACE"," ",607],"{",["T_WHITESPACE"," ",607],["T_COMMENT","\/\/ case with 100% discount on price incl. tax\n",607],["T_WHITESPACE","                    ",608],["T_VARIABLE","$hiddenTax",608],["T_WHITESPACE"," ",608],"=",["T_WHITESPACE"," ",608],["T_VARIABLE","$discountAmount",608],["T_WHITESPACE"," ",608],"-",["T_WHITESPACE"," ",608],["T_VARIABLE","$price",608],";",["T_WHITESPACE","\n                    ",608],["T_VARIABLE","$baseHiddenTax",609],["T_WHITESPACE"," ",609],"=",["T_WHITESPACE"," ",609],["T_VARIABLE","$baseDiscountAmount",609],["T_WHITESPACE"," ",609],"-",["T_WHITESPACE"," ",609],["T_VARIABLE","$basePrice",609],";",["T_WHITESPACE","\n                    ",609],["T_VARIABLE","$this",610],["T_OBJECT_OPERATOR","->",610],["T_STRING","_hiddenTaxes",610],"[","]",["T_WHITESPACE"," ",610],"=",["T_WHITESPACE"," ",610],["T_ARRAY","array",610],"(",["T_WHITESPACE","\n                        ",610],["T_CONSTANT_ENCAPSED_STRING","'rate_key'",611],["T_WHITESPACE"," ",611],["T_DOUBLE_ARROW","=>",611],["T_WHITESPACE"," ",611],["T_VARIABLE","$rateKey",611],",",["T_WHITESPACE","\n                        ",611],["T_CONSTANT_ENCAPSED_STRING","'qty'",612],["T_WHITESPACE"," ",612],["T_DOUBLE_ARROW","=>",612],["T_WHITESPACE"," ",612],["T_VARIABLE","$qty",612],",",["T_WHITESPACE","\n                        ",612],["T_CONSTANT_ENCAPSED_STRING","'item'",613],["T_WHITESPACE"," ",613],["T_DOUBLE_ARROW","=>",613],["T_WHITESPACE"," ",613],["T_VARIABLE","$item",613],",",["T_WHITESPACE","\n                        ",613],["T_CONSTANT_ENCAPSED_STRING","'value'",614],["T_WHITESPACE"," ",614],["T_DOUBLE_ARROW","=>",614],["T_WHITESPACE"," ",614],["T_VARIABLE","$hiddenTax",614],",",["T_WHITESPACE","\n                        ",614],["T_CONSTANT_ENCAPSED_STRING","'base_value'",615],["T_WHITESPACE"," ",615],["T_DOUBLE_ARROW","=>",615],["T_WHITESPACE"," ",615],["T_VARIABLE","$baseHiddenTax",615],",",["T_WHITESPACE","\n                        ",615],["T_CONSTANT_ENCAPSED_STRING","'incl_tax'",616],["T_WHITESPACE"," ",616],["T_DOUBLE_ARROW","=>",616],["T_WHITESPACE"," ",616],["T_VARIABLE","$inclTax",616],",",["T_WHITESPACE","\n                    ",616],")",";",["T_WHITESPACE","\n                ",617],"}",["T_WHITESPACE","\n                ",618],["T_COMMENT","\/\/ calculate discount compensation\n",619],["T_WHITESPACE","                ",620],["T_COMMENT","\/\/ We need the discount compensation when dont calculate the hidden taxes\n",620],["T_WHITESPACE","                ",621],["T_COMMENT","\/\/ (when product does not include taxes)\n",621],["T_WHITESPACE","                ",622],["T_IF","if",622],["T_WHITESPACE"," ",622],"(","!",["T_VARIABLE","$item",622],["T_OBJECT_OPERATOR","->",622],["T_STRING","getNoDiscount",622],"(",")",["T_WHITESPACE"," ",622],["T_BOOLEAN_AND","&&",622],["T_WHITESPACE"," ",622],["T_VARIABLE","$item",622],["T_OBJECT_OPERATOR","->",622],["T_STRING","getWeeeTaxApplied",622],"(",")",")",["T_WHITESPACE"," ",622],"{",["T_WHITESPACE","\n                    ",622],["T_VARIABLE","$item",623],["T_OBJECT_OPERATOR","->",623],["T_STRING","setDiscountTaxCompensation",623],"(",["T_VARIABLE","$item",623],["T_OBJECT_OPERATOR","->",623],["T_STRING","getDiscountTaxCompensation",623],"(",")",["T_WHITESPACE"," ",623],"+",["T_WHITESPACE","\n                    ",623],["T_VARIABLE","$unitTaxBeforeDiscount",624],["T_WHITESPACE"," ",624],"*",["T_WHITESPACE"," ",624],["T_VARIABLE","$qty",624],["T_WHITESPACE"," ",624],"-",["T_WHITESPACE"," ",624],["T_STRING","max",624],"(",["T_LNUMBER","0",624],",",["T_WHITESPACE"," ",624],["T_VARIABLE","$unitTax",624],")",["T_WHITESPACE"," ",624],"*",["T_WHITESPACE"," ",624],["T_VARIABLE","$qty",624],")",";",["T_WHITESPACE","\n                ",624],"}",["T_WHITESPACE","\n                ",625],["T_BREAK","break",626],";",["T_WHITESPACE","\n        ",626],"}",["T_WHITESPACE","\n\n        ",627],["T_VARIABLE","$rowTax",629],["T_WHITESPACE"," ",629],"=",["T_WHITESPACE"," ",629],["T_VARIABLE","$this",629],["T_OBJECT_OPERATOR","->",629],["T_STRING","_store",629],["T_OBJECT_OPERATOR","->",629],["T_STRING","roundPrice",629],"(",["T_STRING","max",629],"(",["T_LNUMBER","0",629],",",["T_WHITESPACE"," ",629],["T_VARIABLE","$qty",629],["T_WHITESPACE"," ",629],"*",["T_WHITESPACE"," ",629],["T_VARIABLE","$unitTax",629],")",")",";",["T_WHITESPACE","\n        ",629],["T_VARIABLE","$baseRowTax",630],["T_WHITESPACE"," ",630],"=",["T_WHITESPACE"," ",630],["T_VARIABLE","$this",630],["T_OBJECT_OPERATOR","->",630],["T_STRING","_store",630],["T_OBJECT_OPERATOR","->",630],["T_STRING","roundPrice",630],"(",["T_STRING","max",630],"(",["T_LNUMBER","0",630],",",["T_WHITESPACE"," ",630],["T_VARIABLE","$qty",630],["T_WHITESPACE"," ",630],"*",["T_WHITESPACE"," ",630],["T_VARIABLE","$baseUnitTax",630],")",")",";",["T_WHITESPACE","\n        ",630],["T_VARIABLE","$item",631],["T_OBJECT_OPERATOR","->",631],["T_STRING","setTaxAmount",631],"(",["T_VARIABLE","$item",631],["T_OBJECT_OPERATOR","->",631],["T_STRING","getTaxAmount",631],"(",")",["T_WHITESPACE"," ",631],"+",["T_WHITESPACE"," ",631],["T_VARIABLE","$rowTax",631],")",";",["T_WHITESPACE","\n        ",631],["T_VARIABLE","$item",632],["T_OBJECT_OPERATOR","->",632],["T_STRING","setBaseTaxAmount",632],"(",["T_VARIABLE","$item",632],["T_OBJECT_OPERATOR","->",632],["T_STRING","getBaseTaxAmount",632],"(",")",["T_WHITESPACE"," ",632],"+",["T_WHITESPACE"," ",632],["T_VARIABLE","$baseRowTax",632],")",";",["T_WHITESPACE","\n        ",632],["T_IF","if",633],["T_WHITESPACE"," ",633],"(",["T_STRING","is_array",633],"(",["T_VARIABLE","$taxGroups",633],")",")",["T_WHITESPACE"," ",633],"{",["T_WHITESPACE","\n            ",633],["T_VARIABLE","$taxGroups",634],"[",["T_VARIABLE","$rateKey",634],"]","[",["T_CONSTANT_ENCAPSED_STRING","'tax'",634],"]",["T_WHITESPACE"," ",634],"=",["T_WHITESPACE"," ",634],["T_STRING","max",634],"(",["T_LNUMBER","0",634],",",["T_WHITESPACE"," ",634],["T_VARIABLE","$rowTax",634],")",";",["T_WHITESPACE","\n            ",634],["T_VARIABLE","$taxGroups",635],"[",["T_VARIABLE","$rateKey",635],"]","[",["T_CONSTANT_ENCAPSED_STRING","'base_tax'",635],"]",["T_WHITESPACE"," ",635],"=",["T_WHITESPACE"," ",635],["T_STRING","max",635],"(",["T_LNUMBER","0",635],",",["T_WHITESPACE"," ",635],["T_VARIABLE","$baseRowTax",635],")",";",["T_WHITESPACE","\n        ",635],"}",["T_WHITESPACE","\n\n        ",636],["T_VARIABLE","$rowTotalInclTax",638],["T_WHITESPACE"," ",638],"=",["T_WHITESPACE"," ",638],["T_VARIABLE","$item",638],["T_OBJECT_OPERATOR","->",638],["T_STRING","getRowTotalInclTax",638],"(",")",";",["T_WHITESPACE","\n        ",638],["T_IF","if",639],["T_WHITESPACE"," ",639],"(","!",["T_ISSET","isset",639],"(",["T_VARIABLE","$rowTotalInclTax",639],")",["T_WHITESPACE"," ",639],["T_BOOLEAN_OR","||",639],["T_WHITESPACE"," ",639],["T_VARIABLE","$recalculateRowTotalInclTax",639],")",["T_WHITESPACE"," ",639],"{",["T_WHITESPACE","\n            ",639],["T_IF","if",640],["T_WHITESPACE"," ",640],"(",["T_VARIABLE","$this",640],["T_OBJECT_OPERATOR","->",640],["T_STRING","_config",640],["T_OBJECT_OPERATOR","->",640],["T_STRING","priceIncludesTax",640],"(",["T_VARIABLE","$this",640],["T_OBJECT_OPERATOR","->",640],["T_STRING","_store",640],")",")",["T_WHITESPACE"," ",640],"{",["T_WHITESPACE","\n                ",640],["T_VARIABLE","$item",641],["T_OBJECT_OPERATOR","->",641],["T_STRING","setRowTotalInclTax",641],"(",["T_VARIABLE","$price",641],["T_WHITESPACE"," ",641],"*",["T_WHITESPACE"," ",641],["T_VARIABLE","$qty",641],")",";",["T_WHITESPACE","\n                ",641],["T_VARIABLE","$item",642],["T_OBJECT_OPERATOR","->",642],["T_STRING","setBaseRowTotalInclTax",642],"(",["T_VARIABLE","$basePrice",642],["T_WHITESPACE"," ",642],"*",["T_WHITESPACE"," ",642],["T_VARIABLE","$qty",642],")",";",["T_WHITESPACE","\n            ",642],"}",["T_WHITESPACE"," ",643],["T_ELSE","else",643],["T_WHITESPACE"," ",643],"{",["T_WHITESPACE","\n                ",643],["T_VARIABLE","$item",644],["T_OBJECT_OPERATOR","->",644],["T_STRING","setRowTotalInclTax",644],"(",["T_WHITESPACE","\n                    ",644],["T_VARIABLE","$item",645],["T_OBJECT_OPERATOR","->",645],["T_STRING","getRowTotalInclTax",645],"(",")",["T_WHITESPACE"," ",645],"+",["T_WHITESPACE"," ",645],"(",["T_VARIABLE","$unitTaxBeforeDiscount",645],["T_WHITESPACE"," ",645],"-",["T_WHITESPACE"," ",645],["T_VARIABLE","$weeeTaxBeforeDiscount",645],")",["T_WHITESPACE"," ",645],"*",["T_WHITESPACE"," ",645],["T_VARIABLE","$qty",645],")",";",["T_WHITESPACE","\n                ",645],["T_VARIABLE","$item",646],["T_OBJECT_OPERATOR","->",646],["T_STRING","setBaseRowTotalInclTax",646],"(",["T_WHITESPACE","\n                    ",646],["T_VARIABLE","$item",647],["T_OBJECT_OPERATOR","->",647],["T_STRING","getBaseRowTotalInclTax",647],"(",")",["T_WHITESPACE"," ",647],"+",["T_WHITESPACE","\n                    ",647],"(",["T_VARIABLE","$baseUnitTaxBeforeDiscount",648],["T_WHITESPACE"," ",648],"-",["T_WHITESPACE"," ",648],["T_VARIABLE","$baseWeeeTaxBeforeDiscount",648],")",["T_WHITESPACE"," ",648],"*",["T_WHITESPACE"," ",648],["T_VARIABLE","$qty",648],")",";",["T_WHITESPACE","\n            ",648],"}",["T_WHITESPACE","\n        ",649],"}",["T_WHITESPACE","\n\n        ",650],["T_RETURN","return",652],["T_WHITESPACE"," ",652],["T_VARIABLE","$this",652],";",["T_WHITESPACE","\n    ",652],"}",["T_WHITESPACE","\n\n    ",653],["T_DOC_COMMENT","\/**\n     * Calculate address total tax based on row total\n     *\n     * @param   Mage_Sales_Model_Quote_Address $address\n     * @param   Varien_Object $taxRateRequest\n     * @return  Mage_Tax_Model_Sales_Total_Quote\n     *\/",655],["T_WHITESPACE","\n    ",661],["T_PROTECTED","protected",662],["T_WHITESPACE"," ",662],["T_FUNCTION","function",662],["T_WHITESPACE"," ",662],["T_STRING","_rowBaseCalculation",662],"(",["T_STRING","Mage_Sales_Model_Quote_Address",662],["T_WHITESPACE"," ",662],["T_VARIABLE","$address",662],",",["T_WHITESPACE"," ",662],["T_VARIABLE","$taxRateRequest",662],")",["T_WHITESPACE","\n    ",662],"{",["T_WHITESPACE","\n        ",663],["T_VARIABLE","$items",664],["T_WHITESPACE"," ",664],"=",["T_WHITESPACE"," ",664],["T_VARIABLE","$this",664],["T_OBJECT_OPERATOR","->",664],["T_STRING","_getAddressItems",664],"(",["T_VARIABLE","$address",664],")",";",["T_WHITESPACE","\n        ",664],["T_VARIABLE","$itemTaxGroups",665],["T_WHITESPACE"," ",665],"=",["T_WHITESPACE"," ",665],["T_ARRAY","array",665],"(",")",";",["T_WHITESPACE","\n        ",665],["T_VARIABLE","$store",666],["T_WHITESPACE"," ",666],"=",["T_WHITESPACE"," ",666],["T_VARIABLE","$address",666],["T_OBJECT_OPERATOR","->",666],["T_STRING","getQuote",666],"(",")",["T_OBJECT_OPERATOR","->",666],["T_STRING","getStore",666],"(",")",";",["T_WHITESPACE","\n        ",666],["T_VARIABLE","$catalogPriceInclTax",667],["T_WHITESPACE"," ",667],"=",["T_WHITESPACE"," ",667],["T_VARIABLE","$this",667],["T_OBJECT_OPERATOR","->",667],["T_STRING","_config",667],["T_OBJECT_OPERATOR","->",667],["T_STRING","priceIncludesTax",667],"(",["T_VARIABLE","$store",667],")",";",["T_WHITESPACE","\n\n        ",667],["T_FOREACH","foreach",669],["T_WHITESPACE"," ",669],"(",["T_VARIABLE","$items",669],["T_WHITESPACE"," ",669],["T_AS","as",669],["T_WHITESPACE"," ",669],["T_VARIABLE","$item",669],")",["T_WHITESPACE"," ",669],"{",["T_WHITESPACE","\n            ",669],["T_IF","if",670],["T_WHITESPACE"," ",670],"(",["T_VARIABLE","$item",670],["T_OBJECT_OPERATOR","->",670],["T_STRING","getParentItem",670],"(",")",")",["T_WHITESPACE"," ",670],"{",["T_WHITESPACE","\n                ",670],["T_CONTINUE","continue",671],";",["T_WHITESPACE","\n            ",671],"}",["T_WHITESPACE","\n            ",672],["T_IF","if",673],["T_WHITESPACE"," ",673],"(",["T_VARIABLE","$item",673],["T_OBJECT_OPERATOR","->",673],["T_STRING","getHasChildren",673],"(",")",["T_WHITESPACE"," ",673],["T_BOOLEAN_AND","&&",673],["T_WHITESPACE"," ",673],["T_VARIABLE","$item",673],["T_OBJECT_OPERATOR","->",673],["T_STRING","isChildrenCalculated",673],"(",")",")",["T_WHITESPACE"," ",673],"{",["T_WHITESPACE","\n                ",673],["T_FOREACH","foreach",674],["T_WHITESPACE"," ",674],"(",["T_VARIABLE","$item",674],["T_OBJECT_OPERATOR","->",674],["T_STRING","getChildren",674],"(",")",["T_WHITESPACE"," ",674],["T_AS","as",674],["T_WHITESPACE"," ",674],["T_VARIABLE","$child",674],")",["T_WHITESPACE"," ",674],"{",["T_WHITESPACE","\n                    ",674],["T_VARIABLE","$this",675],["T_OBJECT_OPERATOR","->",675],["T_STRING","_rowBaseProcessItemTax",675],"(",["T_WHITESPACE","\n                        ",675],["T_VARIABLE","$address",676],",",["T_WHITESPACE"," ",676],["T_VARIABLE","$child",676],",",["T_WHITESPACE"," ",676],["T_VARIABLE","$taxRateRequest",676],",",["T_WHITESPACE"," ",676],["T_VARIABLE","$itemTaxGroups",676],",",["T_WHITESPACE"," ",676],["T_VARIABLE","$catalogPriceInclTax",676],")",";",["T_WHITESPACE","\n                ",676],"}",["T_WHITESPACE","\n                ",677],["T_VARIABLE","$this",678],["T_OBJECT_OPERATOR","->",678],["T_STRING","_recalculateParent",678],"(",["T_VARIABLE","$item",678],")",";",["T_WHITESPACE","\n            ",678],"}",["T_WHITESPACE"," ",679],["T_ELSE","else",679],["T_WHITESPACE"," ",679],"{",["T_WHITESPACE","\n                ",679],["T_VARIABLE","$this",680],["T_OBJECT_OPERATOR","->",680],["T_STRING","_rowBaseProcessItemTax",680],"(",["T_WHITESPACE","\n                    ",680],["T_VARIABLE","$address",681],",",["T_WHITESPACE"," ",681],["T_VARIABLE","$item",681],",",["T_WHITESPACE"," ",681],["T_VARIABLE","$taxRateRequest",681],",",["T_WHITESPACE"," ",681],["T_VARIABLE","$itemTaxGroups",681],",",["T_WHITESPACE"," ",681],["T_VARIABLE","$catalogPriceInclTax",681],")",";",["T_WHITESPACE","\n            ",681],"}",["T_WHITESPACE","\n        ",682],"}",["T_WHITESPACE","\n\n        ",683],["T_IF","if",685],["T_WHITESPACE"," ",685],"(",["T_VARIABLE","$address",685],["T_OBJECT_OPERATOR","->",685],["T_STRING","getQuote",685],"(",")",["T_OBJECT_OPERATOR","->",685],["T_STRING","getTaxesForItems",685],"(",")",")",["T_WHITESPACE"," ",685],"{",["T_WHITESPACE","\n            ",685],["T_VARIABLE","$itemTaxGroups",686],["T_WHITESPACE"," ",686],["T_PLUS_EQUAL","+=",686],["T_WHITESPACE"," ",686],["T_VARIABLE","$address",686],["T_OBJECT_OPERATOR","->",686],["T_STRING","getQuote",686],"(",")",["T_OBJECT_OPERATOR","->",686],["T_STRING","getTaxesForItems",686],"(",")",";",["T_WHITESPACE","\n        ",686],"}",["T_WHITESPACE","\n        ",687],["T_VARIABLE","$address",688],["T_OBJECT_OPERATOR","->",688],["T_STRING","getQuote",688],"(",")",["T_OBJECT_OPERATOR","->",688],["T_STRING","setTaxesForItems",688],"(",["T_VARIABLE","$itemTaxGroups",688],")",";",["T_WHITESPACE","\n        ",688],["T_RETURN","return",689],["T_WHITESPACE"," ",689],["T_VARIABLE","$this",689],";",["T_WHITESPACE","\n    ",689],"}",["T_WHITESPACE","\n\n    ",690],["T_DOC_COMMENT","\/**\n     *\n     * @param Mage_Sales_Model_Quote_Address $address\n     * @param Mage_Sales_Model_Quote_Item_Abstract $item\n     * @param Varien_Object $taxRateRequest\n     * @param array $itemTaxGroups\n     * @param boolean $catalogPriceInclTax\n     *\/",692],["T_WHITESPACE","\n    ",699],["T_PROTECTED","protected",700],["T_WHITESPACE"," ",700],["T_FUNCTION","function",700],["T_WHITESPACE"," ",700],["T_STRING","_rowBaseProcessItemTax",700],"(",["T_VARIABLE","$address",700],",",["T_WHITESPACE"," ",700],["T_VARIABLE","$item",700],",",["T_WHITESPACE"," ",700],["T_VARIABLE","$taxRateRequest",700],",",["T_WHITESPACE"," ",700],"&",["T_VARIABLE","$itemTaxGroups",700],",",["T_WHITESPACE"," ",700],["T_VARIABLE","$catalogPriceInclTax",700],")",["T_WHITESPACE","\n    ",700],"{",["T_WHITESPACE","\n        ",701],["T_VARIABLE","$taxRateRequest",702],["T_OBJECT_OPERATOR","->",702],["T_STRING","setProductClassId",702],"(",["T_VARIABLE","$item",702],["T_OBJECT_OPERATOR","->",702],["T_STRING","getProduct",702],"(",")",["T_OBJECT_OPERATOR","->",702],["T_STRING","getTaxClassId",702],"(",")",")",";",["T_WHITESPACE","\n        ",702],["T_VARIABLE","$rate",703],["T_WHITESPACE"," ",703],"=",["T_WHITESPACE"," ",703],["T_VARIABLE","$this",703],["T_OBJECT_OPERATOR","->",703],["T_STRING","_calculator",703],["T_OBJECT_OPERATOR","->",703],["T_STRING","getRate",703],"(",["T_VARIABLE","$taxRateRequest",703],")",";",["T_WHITESPACE","\n\n        ",703],["T_VARIABLE","$item",705],["T_OBJECT_OPERATOR","->",705],["T_STRING","setTaxAmount",705],"(",["T_LNUMBER","0",705],")",";",["T_WHITESPACE","\n        ",705],["T_VARIABLE","$item",706],["T_OBJECT_OPERATOR","->",706],["T_STRING","setBaseTaxAmount",706],"(",["T_LNUMBER","0",706],")",";",["T_WHITESPACE","\n        ",706],["T_VARIABLE","$item",707],["T_OBJECT_OPERATOR","->",707],["T_STRING","setHiddenTaxAmount",707],"(",["T_LNUMBER","0",707],")",";",["T_WHITESPACE","\n        ",707],["T_VARIABLE","$item",708],["T_OBJECT_OPERATOR","->",708],["T_STRING","setBaseHiddenTaxAmount",708],"(",["T_LNUMBER","0",708],")",";",["T_WHITESPACE","\n        ",708],["T_VARIABLE","$item",709],["T_OBJECT_OPERATOR","->",709],["T_STRING","setTaxPercent",709],"(",["T_VARIABLE","$rate",709],")",";",["T_WHITESPACE","\n        ",709],["T_VARIABLE","$item",710],["T_OBJECT_OPERATOR","->",710],["T_STRING","setDiscountTaxCompensation",710],"(",["T_LNUMBER","0",710],")",";",["T_WHITESPACE","\n        ",710],["T_VARIABLE","$rowTotalInclTax",711],["T_WHITESPACE"," ",711],"=",["T_WHITESPACE"," ",711],["T_VARIABLE","$item",711],["T_OBJECT_OPERATOR","->",711],["T_STRING","getRowTotalInclTax",711],"(",")",";",["T_WHITESPACE","\n        ",711],["T_VARIABLE","$recalculateRowTotalInclTax",712],["T_WHITESPACE"," ",712],"=",["T_WHITESPACE"," ",712],["T_STRING","false",712],";",["T_WHITESPACE","\n        ",712],["T_IF","if",713],["T_WHITESPACE"," ",713],"(","!",["T_ISSET","isset",713],"(",["T_VARIABLE","$rowTotalInclTax",713],")",")",["T_WHITESPACE"," ",713],"{",["T_WHITESPACE","\n            ",713],["T_VARIABLE","$item",714],["T_OBJECT_OPERATOR","->",714],["T_STRING","setRowTotalInclTax",714],"(",["T_VARIABLE","$item",714],["T_OBJECT_OPERATOR","->",714],["T_STRING","getTaxableAmount",714],"(",")",")",";",["T_WHITESPACE","\n            ",714],["T_VARIABLE","$item",715],["T_OBJECT_OPERATOR","->",715],["T_STRING","setBaseRowTotalInclTax",715],"(",["T_VARIABLE","$item",715],["T_OBJECT_OPERATOR","->",715],["T_STRING","getBaseTaxableAmount",715],"(",")",")",";",["T_WHITESPACE","\n            ",715],["T_VARIABLE","$recalculateRowTotalInclTax",716],["T_WHITESPACE"," ",716],"=",["T_WHITESPACE"," ",716],["T_STRING","true",716],";",["T_WHITESPACE","\n        ",716],"}",["T_WHITESPACE","\n\n        ",717],["T_VARIABLE","$appliedRates",719],["T_WHITESPACE"," ",719],"=",["T_WHITESPACE"," ",719],["T_VARIABLE","$this",719],["T_OBJECT_OPERATOR","->",719],["T_STRING","_calculator",719],["T_OBJECT_OPERATOR","->",719],["T_STRING","getAppliedRates",719],"(",["T_VARIABLE","$taxRateRequest",719],")",";",["T_WHITESPACE","\n        ",719],["T_VARIABLE","$item",720],["T_OBJECT_OPERATOR","->",720],["T_STRING","setTaxRates",720],"(",["T_VARIABLE","$appliedRates",720],")",";",["T_WHITESPACE","\n        ",720],["T_IF","if",721],["T_WHITESPACE"," ",721],"(",["T_VARIABLE","$catalogPriceInclTax",721],")",["T_WHITESPACE"," ",721],"{",["T_WHITESPACE","\n            ",721],["T_VARIABLE","$this",722],["T_OBJECT_OPERATOR","->",722],["T_STRING","_calcRowTaxAmount",722],"(",["T_VARIABLE","$item",722],",",["T_WHITESPACE"," ",722],["T_VARIABLE","$rate",722],")",";",["T_WHITESPACE","\n            ",722],["T_VARIABLE","$this",723],["T_OBJECT_OPERATOR","->",723],["T_STRING","_saveAppliedTaxes",723],"(",["T_WHITESPACE","\n                ",723],["T_VARIABLE","$address",724],",",["T_WHITESPACE"," ",724],["T_VARIABLE","$appliedRates",724],",",["T_WHITESPACE"," ",724],["T_VARIABLE","$item",724],["T_OBJECT_OPERATOR","->",724],["T_STRING","getTaxAmount",724],"(",")",",",["T_WHITESPACE"," ",724],["T_VARIABLE","$item",724],["T_OBJECT_OPERATOR","->",724],["T_STRING","getBaseTaxAmount",724],"(",")",",",["T_WHITESPACE"," ",724],["T_VARIABLE","$rate",724],")",";",["T_WHITESPACE","\n        ",724],"}",["T_WHITESPACE"," ",725],["T_ELSE","else",725],["T_WHITESPACE"," ",725],"{",["T_WHITESPACE","\n            ",725],["T_COMMENT","\/\/need to calculate each tax separately\n",726],["T_WHITESPACE","            ",727],["T_VARIABLE","$taxGroups",727],["T_WHITESPACE"," ",727],"=",["T_WHITESPACE"," ",727],["T_ARRAY","array",727],"(",")",";",["T_WHITESPACE","\n            ",727],["T_FOREACH","foreach",728],["T_WHITESPACE"," ",728],"(",["T_VARIABLE","$appliedRates",728],["T_WHITESPACE"," ",728],["T_AS","as",728],["T_WHITESPACE"," ",728],["T_VARIABLE","$appliedTax",728],")",["T_WHITESPACE"," ",728],"{",["T_WHITESPACE","\n                ",728],["T_VARIABLE","$taxId",729],["T_WHITESPACE"," ",729],"=",["T_WHITESPACE"," ",729],["T_VARIABLE","$appliedTax",729],"[",["T_CONSTANT_ENCAPSED_STRING","'id'",729],"]",";",["T_WHITESPACE","\n                ",729],["T_VARIABLE","$taxRate",730],["T_WHITESPACE"," ",730],"=",["T_WHITESPACE"," ",730],["T_VARIABLE","$appliedTax",730],"[",["T_CONSTANT_ENCAPSED_STRING","'percent'",730],"]",";",["T_WHITESPACE","\n                ",730],["T_VARIABLE","$this",731],["T_OBJECT_OPERATOR","->",731],["T_STRING","_calcRowTaxAmount",731],"(",["T_VARIABLE","$item",731],",",["T_WHITESPACE"," ",731],["T_VARIABLE","$taxRate",731],",",["T_WHITESPACE"," ",731],["T_VARIABLE","$taxGroups",731],",",["T_WHITESPACE"," ",731],["T_VARIABLE","$taxId",731],",",["T_WHITESPACE"," ",731],["T_VARIABLE","$recalculateRowTotalInclTax",731],")",";",["T_WHITESPACE","\n                ",731],["T_VARIABLE","$this",732],["T_OBJECT_OPERATOR","->",732],["T_STRING","_saveAppliedTaxes",732],"(",["T_WHITESPACE","\n                    ",732],["T_VARIABLE","$address",733],",",["T_WHITESPACE"," ",733],["T_ARRAY","array",733],"(",["T_VARIABLE","$appliedTax",733],")",",",["T_WHITESPACE"," ",733],["T_VARIABLE","$taxGroups",733],"[",["T_VARIABLE","$taxId",733],"]","[",["T_CONSTANT_ENCAPSED_STRING","'tax'",733],"]",",",["T_WHITESPACE"," ",733],["T_VARIABLE","$taxGroups",733],"[",["T_VARIABLE","$taxId",733],"]","[",["T_CONSTANT_ENCAPSED_STRING","'base_tax'",733],"]",",",["T_WHITESPACE"," ",733],["T_VARIABLE","$taxRate",733],")",";",["T_WHITESPACE","\n            ",733],"}",["T_WHITESPACE","\n            ",734],["T_COMMENT","\/\/We need to calculate weeeAmountInclTax using multiple tax rate here\n",735],["T_WHITESPACE","            ",736],["T_COMMENT","\/\/because the _calculateWeeeTax and _calculateRowWeeeTax only take one tax rate\n",736],["T_WHITESPACE","            ",737],["T_IF","if",737],["T_WHITESPACE"," ",737],"(",["T_VARIABLE","$this",737],["T_OBJECT_OPERATOR","->",737],["T_STRING","_weeeHelper",737],["T_OBJECT_OPERATOR","->",737],["T_STRING","isEnabled",737],"(",")",["T_WHITESPACE"," ",737],["T_BOOLEAN_AND","&&",737],["T_WHITESPACE"," ",737],["T_VARIABLE","$this",737],["T_OBJECT_OPERATOR","->",737],["T_STRING","_weeeHelper",737],["T_OBJECT_OPERATOR","->",737],["T_STRING","isTaxable",737],"(",")",")",["T_WHITESPACE"," ",737],"{",["T_WHITESPACE","\n                ",737],["T_VARIABLE","$this",738],["T_OBJECT_OPERATOR","->",738],["T_STRING","_calculateWeeeAmountInclTax",738],"(",["T_VARIABLE","$item",738],",",["T_WHITESPACE"," ",738],["T_VARIABLE","$appliedRates",738],",",["T_WHITESPACE"," ",738],["T_STRING","false",738],")",";",["T_WHITESPACE","\n                ",738],["T_VARIABLE","$this",739],["T_OBJECT_OPERATOR","->",739],["T_STRING","_calculateWeeeAmountInclTax",739],"(",["T_VARIABLE","$item",739],",",["T_WHITESPACE"," ",739],["T_VARIABLE","$appliedRates",739],",",["T_WHITESPACE"," ",739],["T_STRING","true",739],")",";",["T_WHITESPACE","\n            ",739],"}",["T_WHITESPACE","\n        ",740],"}",["T_WHITESPACE","\n        ",741],["T_IF","if",742],["T_WHITESPACE"," ",742],"(",["T_VARIABLE","$rate",742],["T_WHITESPACE"," ",742],">",["T_WHITESPACE"," ",742],["T_LNUMBER","0",742],")",["T_WHITESPACE"," ",742],"{",["T_WHITESPACE","\n            ",742],["T_VARIABLE","$itemTaxGroups",743],"[",["T_VARIABLE","$item",743],["T_OBJECT_OPERATOR","->",743],["T_STRING","getId",743],"(",")","]",["T_WHITESPACE"," ",743],"=",["T_WHITESPACE"," ",743],["T_VARIABLE","$appliedRates",743],";",["T_WHITESPACE","\n        ",743],"}",["T_WHITESPACE","\n        ",744],["T_VARIABLE","$this",745],["T_OBJECT_OPERATOR","->",745],["T_STRING","_addAmount",745],"(",["T_VARIABLE","$item",745],["T_OBJECT_OPERATOR","->",745],["T_STRING","getTaxAmount",745],"(",")",")",";",["T_WHITESPACE","\n        ",745],["T_VARIABLE","$this",746],["T_OBJECT_OPERATOR","->",746],["T_STRING","_addBaseAmount",746],"(",["T_VARIABLE","$item",746],["T_OBJECT_OPERATOR","->",746],["T_STRING","getBaseTaxAmount",746],"(",")",")",";",["T_WHITESPACE","\n        ",746],["T_RETURN","return",747],";",["T_WHITESPACE","\n    ",747],"}",["T_WHITESPACE","\n\n    ",748],["T_DOC_COMMENT","\/**\n     * Calculate item tax amount based on row total\n     *\n     * @param   Mage_Sales_Model_Quote_Item_Abstract $item\n     * @param   float $rate\n     * @param   array $taxGroups\n     * @param   string $taxId\n     * @param   boolean $recalculateRowTotalInclTax\n     * @return  Mage_Tax_Model_Sales_Total_Quote\n     *\/",750],["T_WHITESPACE","\n    ",759],["T_PROTECTED","protected",760],["T_WHITESPACE"," ",760],["T_FUNCTION","function",760],["T_WHITESPACE"," ",760],["T_STRING","_calcRowTaxAmount",760],"(",["T_WHITESPACE","\n        ",760],["T_VARIABLE","$item",761],",",["T_WHITESPACE"," ",761],["T_VARIABLE","$rate",761],",",["T_WHITESPACE"," ",761],"&",["T_VARIABLE","$taxGroups",761],["T_WHITESPACE"," ",761],"=",["T_WHITESPACE"," ",761],["T_STRING","null",761],",",["T_WHITESPACE"," ",761],["T_VARIABLE","$taxId",761],["T_WHITESPACE"," ",761],"=",["T_WHITESPACE"," ",761],["T_STRING","null",761],",",["T_WHITESPACE"," ",761],["T_VARIABLE","$recalculateRowTotalInclTax",761],["T_WHITESPACE"," ",761],"=",["T_WHITESPACE"," ",761],["T_STRING","false",761],["T_WHITESPACE","\n    ",761],")",["T_WHITESPACE","\n    ",762],"{",["T_WHITESPACE","\n        ",763],["T_VARIABLE","$inclTax",764],["T_WHITESPACE"," ",764],"=",["T_WHITESPACE"," ",764],["T_VARIABLE","$item",764],["T_OBJECT_OPERATOR","->",764],["T_STRING","getIsPriceInclTax",764],"(",")",";",["T_WHITESPACE","\n        ",764],["T_VARIABLE","$subtotal",765],["T_WHITESPACE"," ",765],"=",["T_WHITESPACE"," ",765],["T_VARIABLE","$taxSubtotal",765],["T_WHITESPACE"," ",765],"=",["T_WHITESPACE"," ",765],["T_VARIABLE","$item",765],["T_OBJECT_OPERATOR","->",765],["T_STRING","getTaxableAmount",765],"(",")",";",["T_WHITESPACE","\n        ",765],["T_VARIABLE","$baseSubtotal",766],["T_WHITESPACE"," ",766],"=",["T_WHITESPACE"," ",766],["T_VARIABLE","$baseTaxSubtotal",766],["T_WHITESPACE"," ",766],"=",["T_WHITESPACE"," ",766],["T_VARIABLE","$item",766],["T_OBJECT_OPERATOR","->",766],["T_STRING","getBaseTaxableAmount",766],"(",")",";",["T_WHITESPACE","\n        ",766],["T_VARIABLE","$rateKey",767],["T_WHITESPACE"," ",767],"=",["T_WHITESPACE"," ",767],"(",["T_VARIABLE","$taxId",767],["T_WHITESPACE"," ",767],["T_IS_EQUAL","==",767],["T_WHITESPACE"," ",767],["T_STRING","null",767],")",["T_WHITESPACE"," ",767],"?",["T_WHITESPACE"," ",767],["T_STRING_CAST","(string)",767],["T_VARIABLE","$rate",767],["T_WHITESPACE"," ",767],":",["T_WHITESPACE"," ",767],["T_VARIABLE","$taxId",767],";",["T_WHITESPACE","\n\n        ",767],["T_VARIABLE","$isWeeeEnabled",769],["T_WHITESPACE"," ",769],"=",["T_WHITESPACE"," ",769],["T_VARIABLE","$this",769],["T_OBJECT_OPERATOR","->",769],["T_STRING","_weeeHelper",769],["T_OBJECT_OPERATOR","->",769],["T_STRING","isEnabled",769],"(",")",";",["T_WHITESPACE","\n        ",769],["T_VARIABLE","$isWeeeTaxable",770],["T_WHITESPACE"," ",770],"=",["T_WHITESPACE"," ",770],["T_VARIABLE","$this",770],["T_OBJECT_OPERATOR","->",770],["T_STRING","_weeeHelper",770],["T_OBJECT_OPERATOR","->",770],["T_STRING","isTaxable",770],"(",")",";",["T_WHITESPACE","\n\n        ",770],["T_VARIABLE","$hiddenTax",772],["T_WHITESPACE"," ",772],"=",["T_WHITESPACE"," ",772],["T_STRING","null",772],";",["T_WHITESPACE","\n        ",772],["T_VARIABLE","$baseHiddenTax",773],["T_WHITESPACE"," ",773],"=",["T_WHITESPACE"," ",773],["T_STRING","null",773],";",["T_WHITESPACE","\n        ",773],["T_VARIABLE","$weeeTax",774],["T_WHITESPACE"," ",774],"=",["T_WHITESPACE"," ",774],["T_STRING","null",774],";",["T_WHITESPACE","\n        ",774],["T_VARIABLE","$baseWeeeTax",775],["T_WHITESPACE"," ",775],"=",["T_WHITESPACE"," ",775],["T_STRING","null",775],";",["T_WHITESPACE","\n        ",775],["T_VARIABLE","$rowTaxBeforeDiscount",776],["T_WHITESPACE"," ",776],"=",["T_WHITESPACE"," ",776],["T_STRING","null",776],";",["T_WHITESPACE","\n        ",776],["T_VARIABLE","$baseRowTaxBeforeDiscount",777],["T_WHITESPACE"," ",777],"=",["T_WHITESPACE"," ",777],["T_STRING","null",777],";",["T_WHITESPACE","\n        ",777],["T_VARIABLE","$weeeRowTaxBeforeDiscount",778],["T_WHITESPACE"," ",778],"=",["T_WHITESPACE"," ",778],["T_STRING","null",778],";",["T_WHITESPACE","\n        ",778],["T_VARIABLE","$baseWeeeRowTaxBeforeDiscount",779],["T_WHITESPACE"," ",779],"=",["T_WHITESPACE"," ",779],["T_STRING","null",779],";",["T_WHITESPACE","\n\n        ",779],["T_SWITCH","switch",781],["T_WHITESPACE"," ",781],"(",["T_VARIABLE","$this",781],["T_OBJECT_OPERATOR","->",781],["T_STRING","_helper",781],["T_OBJECT_OPERATOR","->",781],["T_STRING","getCalculationSequence",781],"(",["T_VARIABLE","$this",781],["T_OBJECT_OPERATOR","->",781],["T_STRING","_store",781],")",")",["T_WHITESPACE"," ",781],"{",["T_WHITESPACE","\n            ",781],["T_CASE","case",782],["T_WHITESPACE"," ",782],["T_STRING","Mage_Tax_Model_Calculation",782],["T_DOUBLE_COLON","::",782],["T_STRING","CALC_TAX_BEFORE_DISCOUNT_ON_EXCL",782],":",["T_WHITESPACE","\n            ",782],["T_CASE","case",783],["T_WHITESPACE"," ",783],["T_STRING","Mage_Tax_Model_Calculation",783],["T_DOUBLE_COLON","::",783],["T_STRING","CALC_TAX_BEFORE_DISCOUNT_ON_INCL",783],":",["T_WHITESPACE","\n                ",783],["T_VARIABLE","$rowTaxBeforeDiscount",784],["T_WHITESPACE"," ",784],"=",["T_WHITESPACE"," ",784],["T_VARIABLE","$this",784],["T_OBJECT_OPERATOR","->",784],["T_STRING","_calculator",784],["T_OBJECT_OPERATOR","->",784],["T_STRING","calcTaxAmount",784],"(",["T_VARIABLE","$subtotal",784],",",["T_WHITESPACE"," ",784],["T_VARIABLE","$rate",784],",",["T_WHITESPACE"," ",784],["T_VARIABLE","$inclTax",784],",",["T_WHITESPACE"," ",784],["T_STRING","false",784],")",";",["T_WHITESPACE","\n                ",784],["T_VARIABLE","$baseRowTaxBeforeDiscount",785],["T_WHITESPACE"," ",785],"=",["T_WHITESPACE"," ",785],["T_VARIABLE","$this",785],["T_OBJECT_OPERATOR","->",785],["T_STRING","_calculator",785],["T_OBJECT_OPERATOR","->",785],["T_STRING","calcTaxAmount",785],"(",["T_VARIABLE","$baseSubtotal",785],",",["T_WHITESPACE"," ",785],["T_VARIABLE","$rate",785],",",["T_WHITESPACE"," ",785],["T_VARIABLE","$inclTax",785],",",["T_WHITESPACE"," ",785],["T_STRING","false",785],")",";",["T_WHITESPACE","\n\n                ",785],["T_IF","if",787],["T_WHITESPACE"," ",787],"(",["T_VARIABLE","$isWeeeEnabled",787],["T_WHITESPACE"," ",787],["T_BOOLEAN_AND","&&",787],["T_WHITESPACE"," ",787],["T_VARIABLE","$isWeeeTaxable",787],")",["T_WHITESPACE"," ",787],"{",["T_WHITESPACE","\n                    ",787],["T_VARIABLE","$weeeRowTaxBeforeDiscount",788],["T_WHITESPACE"," ",788],"=",["T_WHITESPACE"," ",788],["T_VARIABLE","$this",788],["T_OBJECT_OPERATOR","->",788],["T_STRING","_calculateRowWeeeTax",788],"(",["T_LNUMBER","0",788],",",["T_WHITESPACE"," ",788],["T_VARIABLE","$item",788],",",["T_WHITESPACE"," ",788],["T_VARIABLE","$rate",788],",",["T_WHITESPACE"," ",788],["T_STRING","false",788],")",";",["T_WHITESPACE","\n                    ",788],["T_VARIABLE","$rowTaxBeforeDiscount",789],["T_WHITESPACE"," ",789],["T_PLUS_EQUAL","+=",789],["T_WHITESPACE"," ",789],["T_VARIABLE","$weeeRowTaxBeforeDiscount",789],";",["T_WHITESPACE","\n                    ",789],["T_VARIABLE","$baseWeeeRowTaxBeforeDiscount",790],["T_WHITESPACE"," ",790],"=",["T_WHITESPACE"," ",790],["T_VARIABLE","$this",790],["T_OBJECT_OPERATOR","->",790],["T_STRING","_calculateRowWeeeTax",790],"(",["T_LNUMBER","0",790],",",["T_WHITESPACE"," ",790],["T_VARIABLE","$item",790],",",["T_WHITESPACE"," ",790],["T_VARIABLE","$rate",790],")",";",["T_WHITESPACE","\n                    ",790],["T_VARIABLE","$baseRowTaxBeforeDiscount",791],["T_WHITESPACE"," ",791],["T_PLUS_EQUAL","+=",791],["T_WHITESPACE"," ",791],["T_VARIABLE","$baseWeeeRowTaxBeforeDiscount",791],";",["T_WHITESPACE","\n                ",791],"}",["T_WHITESPACE","\n                ",792],["T_VARIABLE","$rowTaxBeforeDiscount",793],["T_WHITESPACE"," ",793],"=",["T_WHITESPACE"," ",793],["T_VARIABLE","$rowTax",793],["T_WHITESPACE"," ",793],"=",["T_WHITESPACE"," ",793],["T_VARIABLE","$this",793],["T_OBJECT_OPERATOR","->",793],["T_STRING","_calculator",793],["T_OBJECT_OPERATOR","->",793],["T_STRING","round",793],"(",["T_VARIABLE","$rowTaxBeforeDiscount",793],")",";",["T_WHITESPACE","\n                ",793],["T_VARIABLE","$baseRowTaxBeforeDiscount",794],["T_WHITESPACE"," ",794],"=",["T_WHITESPACE"," ",794],["T_VARIABLE","$baseRowTax",794],["T_WHITESPACE"," ",794],"=",["T_WHITESPACE"," ",794],["T_VARIABLE","$this",794],["T_OBJECT_OPERATOR","->",794],["T_STRING","_calculator",794],["T_OBJECT_OPERATOR","->",794],["T_STRING","round",794],"(",["T_VARIABLE","$baseRowTaxBeforeDiscount",794],")",";",["T_WHITESPACE","\n                ",794],["T_BREAK","break",795],";",["T_WHITESPACE","\n            ",795],["T_CASE","case",796],["T_WHITESPACE"," ",796],["T_STRING","Mage_Tax_Model_Calculation",796],["T_DOUBLE_COLON","::",796],["T_STRING","CALC_TAX_AFTER_DISCOUNT_ON_EXCL",796],":",["T_WHITESPACE","\n            ",796],["T_CASE","case",797],["T_WHITESPACE"," ",797],["T_STRING","Mage_Tax_Model_Calculation",797],["T_DOUBLE_COLON","::",797],["T_STRING","CALC_TAX_AFTER_DISCOUNT_ON_INCL",797],":",["T_WHITESPACE","\n                ",797],["T_VARIABLE","$discountAmount",798],["T_WHITESPACE"," ",798],"=",["T_WHITESPACE"," ",798],["T_VARIABLE","$item",798],["T_OBJECT_OPERATOR","->",798],["T_STRING","getDiscountAmount",798],"(",")",";",["T_WHITESPACE","\n                ",798],["T_VARIABLE","$baseDiscountAmount",799],["T_WHITESPACE"," ",799],"=",["T_WHITESPACE"," ",799],["T_VARIABLE","$item",799],["T_OBJECT_OPERATOR","->",799],["T_STRING","getBaseDiscountAmount",799],"(",")",";",["T_WHITESPACE","\n\n                ",799],["T_IF","if",801],["T_WHITESPACE"," ",801],"(",["T_VARIABLE","$isWeeeEnabled",801],["T_WHITESPACE"," ",801],["T_BOOLEAN_AND","&&",801],["T_WHITESPACE"," ",801],["T_VARIABLE","$this",801],["T_OBJECT_OPERATOR","->",801],["T_STRING","_weeeHelper",801],["T_OBJECT_OPERATOR","->",801],["T_STRING","includeInSubtotal",801],"(",")",")",["T_WHITESPACE"," ",801],"{",["T_WHITESPACE","\n                    ",801],["T_VARIABLE","$discountAmount",802],["T_WHITESPACE"," ",802],"=",["T_WHITESPACE"," ",802],["T_VARIABLE","$discountAmount",802],["T_WHITESPACE"," ",802],"-",["T_WHITESPACE"," ",802],["T_VARIABLE","$item",802],["T_OBJECT_OPERATOR","->",802],["T_STRING","getWeeeDiscount",802],"(",")",";",["T_WHITESPACE","\n                    ",802],["T_VARIABLE","$baseDiscountAmount",803],["T_WHITESPACE"," ",803],"=",["T_WHITESPACE"," ",803],["T_VARIABLE","$baseDiscountAmount",803],["T_WHITESPACE"," ",803],"-",["T_WHITESPACE"," ",803],["T_VARIABLE","$item",803],["T_OBJECT_OPERATOR","->",803],["T_STRING","getBaseWeeeDiscount",803],"(",")",";",["T_WHITESPACE","\n                ",803],"}",["T_WHITESPACE","\n\n                ",804],["T_VARIABLE","$rowTax",806],["T_WHITESPACE"," ",806],"=",["T_WHITESPACE"," ",806],["T_VARIABLE","$this",806],["T_OBJECT_OPERATOR","->",806],["T_STRING","_calculator",806],["T_OBJECT_OPERATOR","->",806],["T_STRING","calcTaxAmount",806],"(",["T_WHITESPACE","\n                    ",806],["T_STRING","max",807],"(",["T_VARIABLE","$subtotal",807],["T_WHITESPACE"," ",807],"-",["T_WHITESPACE"," ",807],["T_VARIABLE","$discountAmount",807],",",["T_WHITESPACE"," ",807],["T_LNUMBER","0",807],")",",",["T_WHITESPACE","\n                    ",807],["T_VARIABLE","$rate",808],",",["T_WHITESPACE","\n                    ",808],["T_VARIABLE","$inclTax",809],["T_WHITESPACE","\n                ",809],")",";",["T_WHITESPACE","\n                ",810],["T_VARIABLE","$baseRowTax",811],["T_WHITESPACE"," ",811],"=",["T_WHITESPACE"," ",811],["T_VARIABLE","$this",811],["T_OBJECT_OPERATOR","->",811],["T_STRING","_calculator",811],["T_OBJECT_OPERATOR","->",811],["T_STRING","calcTaxAmount",811],"(",["T_WHITESPACE","\n                    ",811],["T_STRING","max",812],"(",["T_VARIABLE","$baseSubtotal",812],["T_WHITESPACE"," ",812],"-",["T_WHITESPACE"," ",812],["T_VARIABLE","$baseDiscountAmount",812],",",["T_WHITESPACE"," ",812],["T_LNUMBER","0",812],")",",",["T_WHITESPACE","\n                    ",812],["T_VARIABLE","$rate",813],",",["T_WHITESPACE","\n                    ",813],["T_VARIABLE","$inclTax",814],["T_WHITESPACE","\n                ",814],")",";",["T_WHITESPACE","\n\n                ",815],["T_IF","if",817],["T_WHITESPACE"," ",817],"(",["T_VARIABLE","$isWeeeEnabled",817],["T_WHITESPACE"," ",817],["T_BOOLEAN_AND","&&",817],["T_WHITESPACE"," ",817],["T_VARIABLE","$this",817],["T_OBJECT_OPERATOR","->",817],["T_STRING","_weeeHelper",817],["T_OBJECT_OPERATOR","->",817],["T_STRING","isTaxable",817],"(",")",")",["T_WHITESPACE"," ",817],"{",["T_WHITESPACE","\n                    ",817],["T_VARIABLE","$weeeTax",818],["T_WHITESPACE"," ",818],"=",["T_WHITESPACE"," ",818],["T_VARIABLE","$this",818],["T_OBJECT_OPERATOR","->",818],["T_STRING","_calculateRowWeeeTax",818],"(",["T_VARIABLE","$item",818],["T_OBJECT_OPERATOR","->",818],["T_STRING","getWeeeDiscount",818],"(",")",",",["T_WHITESPACE"," ",818],["T_VARIABLE","$item",818],",",["T_WHITESPACE"," ",818],["T_VARIABLE","$rate",818],",",["T_WHITESPACE"," ",818],["T_STRING","false",818],")",";",["T_WHITESPACE","\n                    ",818],["T_VARIABLE","$rowTax",819],["T_WHITESPACE"," ",819],["T_PLUS_EQUAL","+=",819],["T_WHITESPACE"," ",819],["T_VARIABLE","$weeeTax",819],";",["T_WHITESPACE","\n                    ",819],["T_VARIABLE","$baseWeeeTax",820],["T_WHITESPACE"," ",820],"=",["T_WHITESPACE"," ",820],["T_VARIABLE","$this",820],["T_OBJECT_OPERATOR","->",820],["T_STRING","_calculateRowWeeeTax",820],"(",["T_VARIABLE","$item",820],["T_OBJECT_OPERATOR","->",820],["T_STRING","getBaseWeeeDiscount",820],"(",")",",",["T_WHITESPACE"," ",820],["T_VARIABLE","$item",820],",",["T_WHITESPACE"," ",820],["T_VARIABLE","$rate",820],")",";",["T_WHITESPACE","\n                    ",820],["T_VARIABLE","$baseRowTax",821],["T_WHITESPACE"," ",821],["T_PLUS_EQUAL","+=",821],["T_WHITESPACE"," ",821],["T_VARIABLE","$baseWeeeTax",821],";",["T_WHITESPACE","\n                ",821],"}",["T_WHITESPACE","\n\n                ",822],["T_VARIABLE","$rowTax",824],["T_WHITESPACE"," ",824],"=",["T_WHITESPACE"," ",824],["T_VARIABLE","$this",824],["T_OBJECT_OPERATOR","->",824],["T_STRING","_calculator",824],["T_OBJECT_OPERATOR","->",824],["T_STRING","round",824],"(",["T_VARIABLE","$rowTax",824],")",";",["T_WHITESPACE","\n                ",824],["T_VARIABLE","$baseRowTax",825],["T_WHITESPACE"," ",825],"=",["T_WHITESPACE"," ",825],["T_VARIABLE","$this",825],["T_OBJECT_OPERATOR","->",825],["T_STRING","_calculator",825],["T_OBJECT_OPERATOR","->",825],["T_STRING","round",825],"(",["T_VARIABLE","$baseRowTax",825],")",";",["T_WHITESPACE","\n\n                ",825],["T_COMMENT","\/\/Calculate the Row Tax before discount\n",827],["T_WHITESPACE","                ",828],["T_VARIABLE","$rowTaxBeforeDiscount",828],["T_WHITESPACE"," ",828],"=",["T_WHITESPACE"," ",828],["T_VARIABLE","$this",828],["T_OBJECT_OPERATOR","->",828],["T_STRING","_calculator",828],["T_OBJECT_OPERATOR","->",828],["T_STRING","calcTaxAmount",828],"(",["T_WHITESPACE","\n                    ",828],["T_VARIABLE","$subtotal",829],",",["T_WHITESPACE","\n                    ",829],["T_VARIABLE","$rate",830],",",["T_WHITESPACE","\n                    ",830],["T_VARIABLE","$inclTax",831],",",["T_WHITESPACE","\n                    ",831],["T_STRING","false",832],["T_WHITESPACE","\n                ",832],")",";",["T_WHITESPACE","\n                ",833],["T_VARIABLE","$baseRowTaxBeforeDiscount",834],["T_WHITESPACE"," ",834],"=",["T_WHITESPACE"," ",834],["T_VARIABLE","$this",834],["T_OBJECT_OPERATOR","->",834],["T_STRING","_calculator",834],["T_OBJECT_OPERATOR","->",834],["T_STRING","calcTaxAmount",834],"(",["T_WHITESPACE","\n                    ",834],["T_VARIABLE","$baseSubtotal",835],",",["T_WHITESPACE","\n                    ",835],["T_VARIABLE","$rate",836],",",["T_WHITESPACE","\n                    ",836],["T_VARIABLE","$inclTax",837],",",["T_WHITESPACE","\n                    ",837],["T_STRING","false",838],["T_WHITESPACE","\n                ",838],")",";",["T_WHITESPACE","\n\n                ",839],["T_COMMENT","\/\/Calculate the Weee taxes before discount\n",841],["T_WHITESPACE","                ",842],["T_VARIABLE","$weeeRowTaxBeforeDiscount",842],["T_WHITESPACE"," ",842],"=",["T_WHITESPACE"," ",842],["T_LNUMBER","0",842],";",["T_WHITESPACE","\n                ",842],["T_VARIABLE","$baseWeeeRowTaxBeforeDiscount",843],["T_WHITESPACE"," ",843],"=",["T_WHITESPACE"," ",843],["T_LNUMBER","0",843],";",["T_WHITESPACE","\n                ",843],["T_IF","if",844],["T_WHITESPACE"," ",844],"(",["T_VARIABLE","$isWeeeTaxable",844],")",["T_WHITESPACE"," ",844],"{",["T_WHITESPACE","\n                    ",844],["T_VARIABLE","$weeeRowTaxBeforeDiscount",845],["T_WHITESPACE"," ",845],"=",["T_WHITESPACE"," ",845],["T_VARIABLE","$this",845],["T_OBJECT_OPERATOR","->",845],["T_STRING","_calculateRowWeeeTax",845],"(",["T_LNUMBER","0",845],",",["T_WHITESPACE"," ",845],["T_VARIABLE","$item",845],",",["T_WHITESPACE"," ",845],["T_VARIABLE","$rate",845],",",["T_WHITESPACE"," ",845],["T_STRING","false",845],")",";",["T_WHITESPACE","\n                    ",845],["T_VARIABLE","$rowTaxBeforeDiscount",846],["T_WHITESPACE"," ",846],["T_PLUS_EQUAL","+=",846],["T_WHITESPACE"," ",846],["T_VARIABLE","$weeeRowTaxBeforeDiscount",846],";",["T_WHITESPACE","\n                    ",846],["T_VARIABLE","$baseWeeeRowTaxBeforeDiscount",847],["T_WHITESPACE"," ",847],"=",["T_WHITESPACE"," ",847],["T_VARIABLE","$this",847],["T_OBJECT_OPERATOR","->",847],["T_STRING","_calculateRowWeeeTax",847],"(",["T_LNUMBER","0",847],",",["T_WHITESPACE"," ",847],["T_VARIABLE","$item",847],",",["T_WHITESPACE"," ",847],["T_VARIABLE","$rate",847],")",";",["T_WHITESPACE","\n                    ",847],["T_VARIABLE","$baseRowTaxBeforeDiscount",848],["T_WHITESPACE"," ",848],["T_PLUS_EQUAL","+=",848],["T_WHITESPACE"," ",848],["T_VARIABLE","$baseWeeeRowTaxBeforeDiscount",848],";",["T_WHITESPACE","\n                ",848],"}",["T_WHITESPACE","\n\n                ",849],["T_VARIABLE","$rowTaxBeforeDiscount",851],["T_WHITESPACE"," ",851],"=",["T_WHITESPACE"," ",851],["T_STRING","max",851],"(",["T_LNUMBER","0",851],",",["T_WHITESPACE"," ",851],["T_VARIABLE","$this",851],["T_OBJECT_OPERATOR","->",851],["T_STRING","_calculator",851],["T_OBJECT_OPERATOR","->",851],["T_STRING","round",851],"(",["T_VARIABLE","$rowTaxBeforeDiscount",851],")",")",";",["T_WHITESPACE","\n                ",851],["T_VARIABLE","$baseRowTaxBeforeDiscount",852],["T_WHITESPACE"," ",852],"=",["T_WHITESPACE"," ",852],["T_STRING","max",852],"(",["T_LNUMBER","0",852],",",["T_WHITESPACE"," ",852],["T_VARIABLE","$this",852],["T_OBJECT_OPERATOR","->",852],["T_STRING","_calculator",852],["T_OBJECT_OPERATOR","->",852],["T_STRING","round",852],"(",["T_VARIABLE","$baseRowTaxBeforeDiscount",852],")",")",";",["T_WHITESPACE","\n\n                ",852],["T_IF","if",854],["T_WHITESPACE"," ",854],"(",["T_VARIABLE","$inclTax",854],["T_WHITESPACE"," ",854],["T_BOOLEAN_AND","&&",854],["T_WHITESPACE"," ",854],["T_VARIABLE","$discountAmount",854],["T_WHITESPACE"," ",854],">",["T_WHITESPACE"," ",854],["T_LNUMBER","0",854],")",["T_WHITESPACE"," ",854],"{",["T_WHITESPACE","\n                    ",854],["T_VARIABLE","$hiddenTax",855],["T_WHITESPACE"," ",855],"=",["T_WHITESPACE"," ",855],["T_VARIABLE","$rowTaxBeforeDiscount",855],["T_WHITESPACE"," ",855],"-",["T_WHITESPACE"," ",855],["T_VARIABLE","$rowTax",855],";",["T_WHITESPACE","\n                    ",855],["T_VARIABLE","$baseHiddenTax",856],["T_WHITESPACE"," ",856],"=",["T_WHITESPACE"," ",856],["T_VARIABLE","$baseRowTaxBeforeDiscount",856],["T_WHITESPACE"," ",856],"-",["T_WHITESPACE"," ",856],["T_VARIABLE","$baseRowTax",856],";",["T_WHITESPACE","\n                    ",856],["T_VARIABLE","$this",857],["T_OBJECT_OPERATOR","->",857],["T_STRING","_hiddenTaxes",857],"[","]",["T_WHITESPACE"," ",857],"=",["T_WHITESPACE"," ",857],["T_ARRAY","array",857],"(",["T_WHITESPACE","\n                        ",857],["T_CONSTANT_ENCAPSED_STRING","'rate_key'",858],["T_WHITESPACE"," ",858],["T_DOUBLE_ARROW","=>",858],["T_WHITESPACE"," ",858],["T_VARIABLE","$rateKey",858],",",["T_WHITESPACE","\n                        ",858],["T_CONSTANT_ENCAPSED_STRING","'qty'",859],["T_WHITESPACE"," ",859],["T_DOUBLE_ARROW","=>",859],["T_WHITESPACE"," ",859],["T_LNUMBER","1",859],",",["T_WHITESPACE","\n                        ",859],["T_CONSTANT_ENCAPSED_STRING","'item'",860],["T_WHITESPACE"," ",860],["T_DOUBLE_ARROW","=>",860],["T_WHITESPACE"," ",860],["T_VARIABLE","$item",860],",",["T_WHITESPACE","\n                        ",860],["T_CONSTANT_ENCAPSED_STRING","'value'",861],["T_WHITESPACE"," ",861],["T_DOUBLE_ARROW","=>",861],["T_WHITESPACE"," ",861],["T_VARIABLE","$hiddenTax",861],",",["T_WHITESPACE","\n                        ",861],["T_CONSTANT_ENCAPSED_STRING","'base_value'",862],["T_WHITESPACE"," ",862],["T_DOUBLE_ARROW","=>",862],["T_WHITESPACE"," ",862],["T_VARIABLE","$baseHiddenTax",862],",",["T_WHITESPACE","\n                        ",862],["T_CONSTANT_ENCAPSED_STRING","'incl_tax'",863],["T_WHITESPACE"," ",863],["T_DOUBLE_ARROW","=>",863],["T_WHITESPACE"," ",863],["T_VARIABLE","$inclTax",863],",",["T_WHITESPACE","\n                    ",863],")",";",["T_WHITESPACE","\n                ",864],"}",["T_WHITESPACE"," ",865],["T_ELSEIF","elseif",865],["T_WHITESPACE"," ",865],"(",["T_VARIABLE","$discountAmount",865],["T_WHITESPACE"," ",865],">",["T_WHITESPACE"," ",865],["T_VARIABLE","$subtotal",865],")",["T_WHITESPACE"," ",865],"{",["T_WHITESPACE"," ",865],["T_COMMENT","\/\/ case with 100% discount on price incl. tax\n",865],["T_WHITESPACE","                    ",866],["T_VARIABLE","$hiddenTax",866],["T_WHITESPACE"," ",866],"=",["T_WHITESPACE"," ",866],["T_VARIABLE","$discountAmount",866],["T_WHITESPACE"," ",866],"-",["T_WHITESPACE"," ",866],["T_VARIABLE","$subtotal",866],";",["T_WHITESPACE","\n                    ",866],["T_VARIABLE","$baseHiddenTax",867],["T_WHITESPACE"," ",867],"=",["T_WHITESPACE"," ",867],["T_VARIABLE","$baseDiscountAmount",867],["T_WHITESPACE"," ",867],"-",["T_WHITESPACE"," ",867],["T_VARIABLE","$baseSubtotal",867],";",["T_WHITESPACE","\n                    ",867],["T_VARIABLE","$this",868],["T_OBJECT_OPERATOR","->",868],["T_STRING","_hiddenTaxes",868],"[","]",["T_WHITESPACE"," ",868],"=",["T_WHITESPACE"," ",868],["T_ARRAY","array",868],"(",["T_WHITESPACE","\n                        ",868],["T_CONSTANT_ENCAPSED_STRING","'rate_key'",869],["T_WHITESPACE"," ",869],["T_DOUBLE_ARROW","=>",869],["T_WHITESPACE"," ",869],["T_VARIABLE","$rateKey",869],",",["T_WHITESPACE","\n                        ",869],["T_CONSTANT_ENCAPSED_STRING","'qty'",870],["T_WHITESPACE"," ",870],["T_DOUBLE_ARROW","=>",870],["T_WHITESPACE"," ",870],["T_LNUMBER","1",870],",",["T_WHITESPACE","\n                        ",870],["T_CONSTANT_ENCAPSED_STRING","'item'",871],["T_WHITESPACE"," ",871],["T_DOUBLE_ARROW","=>",871],["T_WHITESPACE"," ",871],["T_VARIABLE","$item",871],",",["T_WHITESPACE","\n                        ",871],["T_CONSTANT_ENCAPSED_STRING","'value'",872],["T_WHITESPACE"," ",872],["T_DOUBLE_ARROW","=>",872],["T_WHITESPACE"," ",872],["T_VARIABLE","$hiddenTax",872],",",["T_WHITESPACE","\n                        ",872],["T_CONSTANT_ENCAPSED_STRING","'base_value'",873],["T_WHITESPACE"," ",873],["T_DOUBLE_ARROW","=>",873],["T_WHITESPACE"," ",873],["T_VARIABLE","$baseHiddenTax",873],",",["T_WHITESPACE","\n                        ",873],["T_CONSTANT_ENCAPSED_STRING","'incl_tax'",874],["T_WHITESPACE"," ",874],["T_DOUBLE_ARROW","=>",874],["T_WHITESPACE"," ",874],["T_VARIABLE","$inclTax",874],",",["T_WHITESPACE","\n                    ",874],")",";",["T_WHITESPACE","\n                ",875],"}",["T_WHITESPACE","\n                ",876],["T_COMMENT","\/\/ calculate discount compensation\n",877],["T_WHITESPACE","                ",878],["T_IF","if",878],["T_WHITESPACE"," ",878],"(","!",["T_VARIABLE","$item",878],["T_OBJECT_OPERATOR","->",878],["T_STRING","getNoDiscount",878],"(",")",["T_WHITESPACE"," ",878],["T_BOOLEAN_AND","&&",878],["T_WHITESPACE"," ",878],["T_VARIABLE","$item",878],["T_OBJECT_OPERATOR","->",878],["T_STRING","getWeeeTaxApplied",878],"(",")",")",["T_WHITESPACE"," ",878],"{",["T_WHITESPACE","\n                    ",878],["T_VARIABLE","$item",879],["T_OBJECT_OPERATOR","->",879],["T_STRING","setDiscountTaxCompensation",879],"(",["T_VARIABLE","$item",879],["T_OBJECT_OPERATOR","->",879],["T_STRING","getDiscountTaxCompensation",879],"(",")",["T_WHITESPACE"," ",879],"+",["T_WHITESPACE","\n                    ",879],["T_VARIABLE","$rowTaxBeforeDiscount",880],["T_WHITESPACE"," ",880],"-",["T_WHITESPACE"," ",880],["T_STRING","max",880],"(",["T_LNUMBER","0",880],",",["T_WHITESPACE"," ",880],["T_VARIABLE","$rowTax",880],")",")",";",["T_WHITESPACE","\n                ",880],"}",["T_WHITESPACE","\n                ",881],["T_BREAK","break",882],";",["T_WHITESPACE","\n        ",882],"}",["T_WHITESPACE","\n        ",883],["T_VARIABLE","$item",884],["T_OBJECT_OPERATOR","->",884],["T_STRING","setTaxAmount",884],"(",["T_VARIABLE","$item",884],["T_OBJECT_OPERATOR","->",884],["T_STRING","getTaxAmount",884],"(",")",["T_WHITESPACE"," ",884],"+",["T_WHITESPACE"," ",884],["T_STRING","max",884],"(",["T_LNUMBER","0",884],",",["T_WHITESPACE"," ",884],["T_VARIABLE","$rowTax",884],")",")",";",["T_WHITESPACE","\n        ",884],["T_VARIABLE","$item",885],["T_OBJECT_OPERATOR","->",885],["T_STRING","setBaseTaxAmount",885],"(",["T_VARIABLE","$item",885],["T_OBJECT_OPERATOR","->",885],["T_STRING","getBaseTaxAmount",885],"(",")",["T_WHITESPACE"," ",885],"+",["T_WHITESPACE"," ",885],["T_STRING","max",885],"(",["T_LNUMBER","0",885],",",["T_WHITESPACE"," ",885],["T_VARIABLE","$baseRowTax",885],")",")",";",["T_WHITESPACE","\n        ",885],["T_IF","if",886],["T_WHITESPACE"," ",886],"(",["T_STRING","is_array",886],"(",["T_VARIABLE","$taxGroups",886],")",")",["T_WHITESPACE"," ",886],"{",["T_WHITESPACE","\n            ",886],["T_VARIABLE","$taxGroups",887],"[",["T_VARIABLE","$rateKey",887],"]","[",["T_CONSTANT_ENCAPSED_STRING","'tax'",887],"]",["T_WHITESPACE"," ",887],"=",["T_WHITESPACE"," ",887],["T_STRING","max",887],"(",["T_LNUMBER","0",887],",",["T_WHITESPACE"," ",887],["T_VARIABLE","$rowTax",887],")",";",["T_WHITESPACE","\n            ",887],["T_VARIABLE","$taxGroups",888],"[",["T_VARIABLE","$rateKey",888],"]","[",["T_CONSTANT_ENCAPSED_STRING","'base_tax'",888],"]",["T_WHITESPACE"," ",888],"=",["T_WHITESPACE"," ",888],["T_STRING","max",888],"(",["T_LNUMBER","0",888],",",["T_WHITESPACE"," ",888],["T_VARIABLE","$baseRowTax",888],")",";",["T_WHITESPACE","\n        ",888],"}",["T_WHITESPACE","\n\n        ",889],["T_VARIABLE","$rowTotalInclTax",891],["T_WHITESPACE"," ",891],"=",["T_WHITESPACE"," ",891],["T_VARIABLE","$item",891],["T_OBJECT_OPERATOR","->",891],["T_STRING","getRowTotalInclTax",891],"(",")",";",["T_WHITESPACE","\n        ",891],["T_IF","if",892],["T_WHITESPACE"," ",892],"(","!",["T_ISSET","isset",892],"(",["T_VARIABLE","$rowTotalInclTax",892],")",["T_WHITESPACE"," ",892],["T_BOOLEAN_OR","||",892],["T_WHITESPACE"," ",892],["T_VARIABLE","$recalculateRowTotalInclTax",892],")",["T_WHITESPACE"," ",892],"{",["T_WHITESPACE","\n            ",892],["T_IF","if",893],["T_WHITESPACE"," ",893],"(",["T_VARIABLE","$this",893],["T_OBJECT_OPERATOR","->",893],["T_STRING","_config",893],["T_OBJECT_OPERATOR","->",893],["T_STRING","priceIncludesTax",893],"(",["T_VARIABLE","$this",893],["T_OBJECT_OPERATOR","->",893],["T_STRING","_store",893],")",")",["T_WHITESPACE"," ",893],"{",["T_WHITESPACE","\n                ",893],["T_VARIABLE","$item",894],["T_OBJECT_OPERATOR","->",894],["T_STRING","setRowTotalInclTax",894],"(",["T_VARIABLE","$subtotal",894],")",";",["T_WHITESPACE","\n                ",894],["T_VARIABLE","$item",895],["T_OBJECT_OPERATOR","->",895],["T_STRING","setBaseRowTotalInclTax",895],"(",["T_VARIABLE","$baseSubtotal",895],")",";",["T_WHITESPACE","\n            ",895],"}",["T_WHITESPACE"," ",896],["T_ELSE","else",896],["T_WHITESPACE"," ",896],"{",["T_WHITESPACE","\n                ",896],["T_VARIABLE","$item",897],["T_OBJECT_OPERATOR","->",897],["T_STRING","setRowTotalInclTax",897],"(",["T_WHITESPACE","\n                    ",897],["T_VARIABLE","$item",898],["T_OBJECT_OPERATOR","->",898],["T_STRING","getRowTotalInclTax",898],"(",")",["T_WHITESPACE"," ",898],"+",["T_WHITESPACE"," ",898],["T_VARIABLE","$rowTaxBeforeDiscount",898],["T_WHITESPACE"," ",898],"-",["T_WHITESPACE"," ",898],["T_VARIABLE","$weeeRowTaxBeforeDiscount",898],")",";",["T_WHITESPACE","\n                ",898],["T_VARIABLE","$item",899],["T_OBJECT_OPERATOR","->",899],["T_STRING","setBaseRowTotalInclTax",899],"(",["T_VARIABLE","$item",899],["T_OBJECT_OPERATOR","->",899],["T_STRING","getBaseRowTotalInclTax",899],"(",")",["T_WHITESPACE"," ",899],"+",["T_WHITESPACE","\n                ",899],["T_VARIABLE","$baseRowTaxBeforeDiscount",900],["T_WHITESPACE"," ",900],"-",["T_WHITESPACE"," ",900],["T_VARIABLE","$baseWeeeRowTaxBeforeDiscount",900],")",";",["T_WHITESPACE","\n            ",900],"}",["T_WHITESPACE","\n        ",901],"}",["T_WHITESPACE","\n        ",902],["T_RETURN","return",903],["T_WHITESPACE"," ",903],["T_VARIABLE","$this",903],";",["T_WHITESPACE","\n    ",903],"}",["T_WHITESPACE","\n\n    ",904],["T_DOC_COMMENT","\/**\n     * Calculate address total tax based on address subtotal\n     *\n     * @param   Mage_Sales_Model_Quote_Address $address\n     * @param   Varien_Object $taxRateRequest\n     * @return  Mage_Tax_Model_Sales_Total_Quote\n     *\/",906],["T_WHITESPACE","\n    ",912],["T_PROTECTED","protected",913],["T_WHITESPACE"," ",913],["T_FUNCTION","function",913],["T_WHITESPACE"," ",913],["T_STRING","_totalBaseCalculation",913],"(",["T_STRING","Mage_Sales_Model_Quote_Address",913],["T_WHITESPACE"," ",913],["T_VARIABLE","$address",913],",",["T_WHITESPACE"," ",913],["T_VARIABLE","$taxRateRequest",913],")",["T_WHITESPACE","\n    ",913],"{",["T_WHITESPACE","\n        ",914],["T_VARIABLE","$items",915],["T_WHITESPACE"," ",915],"=",["T_WHITESPACE"," ",915],["T_VARIABLE","$this",915],["T_OBJECT_OPERATOR","->",915],["T_STRING","_getAddressItems",915],"(",["T_VARIABLE","$address",915],")",";",["T_WHITESPACE","\n        ",915],["T_VARIABLE","$store",916],["T_WHITESPACE"," ",916],"=",["T_WHITESPACE"," ",916],["T_VARIABLE","$address",916],["T_OBJECT_OPERATOR","->",916],["T_STRING","getQuote",916],"(",")",["T_OBJECT_OPERATOR","->",916],["T_STRING","getStore",916],"(",")",";",["T_WHITESPACE","\n        ",916],["T_VARIABLE","$taxGroups",917],["T_WHITESPACE"," ",917],"=",["T_WHITESPACE"," ",917],["T_ARRAY","array",917],"(",")",";",["T_WHITESPACE","\n        ",917],["T_VARIABLE","$itemTaxGroups",918],["T_WHITESPACE"," ",918],"=",["T_WHITESPACE"," ",918],["T_ARRAY","array",918],"(",")",";",["T_WHITESPACE","\n        ",918],["T_VARIABLE","$catalogPriceInclTax",919],["T_WHITESPACE"," ",919],"=",["T_WHITESPACE"," ",919],["T_VARIABLE","$this",919],["T_OBJECT_OPERATOR","->",919],["T_STRING","_config",919],["T_OBJECT_OPERATOR","->",919],["T_STRING","priceIncludesTax",919],"(",["T_VARIABLE","$store",919],")",";",["T_WHITESPACE","\n\n        ",919],["T_FOREACH","foreach",921],["T_WHITESPACE"," ",921],"(",["T_VARIABLE","$items",921],["T_WHITESPACE"," ",921],["T_AS","as",921],["T_WHITESPACE"," ",921],["T_VARIABLE","$item",921],")",["T_WHITESPACE"," ",921],"{",["T_WHITESPACE","\n            ",921],["T_IF","if",922],["T_WHITESPACE"," ",922],"(",["T_VARIABLE","$item",922],["T_OBJECT_OPERATOR","->",922],["T_STRING","getParentItem",922],"(",")",")",["T_WHITESPACE"," ",922],"{",["T_WHITESPACE","\n                ",922],["T_CONTINUE","continue",923],";",["T_WHITESPACE","\n            ",923],"}",["T_WHITESPACE","\n\n            ",924],["T_IF","if",926],["T_WHITESPACE"," ",926],"(",["T_VARIABLE","$item",926],["T_OBJECT_OPERATOR","->",926],["T_STRING","getHasChildren",926],"(",")",["T_WHITESPACE"," ",926],["T_BOOLEAN_AND","&&",926],["T_WHITESPACE"," ",926],["T_VARIABLE","$item",926],["T_OBJECT_OPERATOR","->",926],["T_STRING","isChildrenCalculated",926],"(",")",")",["T_WHITESPACE"," ",926],"{",["T_WHITESPACE","\n                ",926],["T_FOREACH","foreach",927],["T_WHITESPACE"," ",927],"(",["T_VARIABLE","$item",927],["T_OBJECT_OPERATOR","->",927],["T_STRING","getChildren",927],"(",")",["T_WHITESPACE"," ",927],["T_AS","as",927],["T_WHITESPACE"," ",927],["T_VARIABLE","$child",927],")",["T_WHITESPACE"," ",927],"{",["T_WHITESPACE","\n                    ",927],["T_VARIABLE","$this",928],["T_OBJECT_OPERATOR","->",928],["T_STRING","_totalBaseProcessItemTax",928],"(",["T_WHITESPACE","\n                        ",928],["T_VARIABLE","$child",929],",",["T_WHITESPACE"," ",929],["T_VARIABLE","$taxRateRequest",929],",",["T_WHITESPACE"," ",929],["T_VARIABLE","$taxGroups",929],",",["T_WHITESPACE"," ",929],["T_VARIABLE","$itemTaxGroups",929],",",["T_WHITESPACE"," ",929],["T_VARIABLE","$catalogPriceInclTax",929],")",";",["T_WHITESPACE","\n                ",929],"}",["T_WHITESPACE","\n                ",930],["T_VARIABLE","$this",931],["T_OBJECT_OPERATOR","->",931],["T_STRING","_recalculateParent",931],"(",["T_VARIABLE","$item",931],")",";",["T_WHITESPACE","\n            ",931],"}",["T_WHITESPACE"," ",932],["T_ELSE","else",932],["T_WHITESPACE"," ",932],"{",["T_WHITESPACE","\n                ",932],["T_VARIABLE","$this",933],["T_OBJECT_OPERATOR","->",933],["T_STRING","_totalBaseProcessItemTax",933],"(",["T_WHITESPACE","\n                    ",933],["T_VARIABLE","$item",934],",",["T_WHITESPACE"," ",934],["T_VARIABLE","$taxRateRequest",934],",",["T_WHITESPACE"," ",934],["T_VARIABLE","$taxGroups",934],",",["T_WHITESPACE"," ",934],["T_VARIABLE","$itemTaxGroups",934],",",["T_WHITESPACE"," ",934],["T_VARIABLE","$catalogPriceInclTax",934],")",";",["T_WHITESPACE","\n            ",934],"}",["T_WHITESPACE","\n        ",935],"}",["T_WHITESPACE","\n\n        ",936],["T_IF","if",938],["T_WHITESPACE"," ",938],"(",["T_VARIABLE","$address",938],["T_OBJECT_OPERATOR","->",938],["T_STRING","getQuote",938],"(",")",["T_OBJECT_OPERATOR","->",938],["T_STRING","getTaxesForItems",938],"(",")",")",["T_WHITESPACE"," ",938],"{",["T_WHITESPACE","\n            ",938],["T_VARIABLE","$itemTaxGroups",939],["T_WHITESPACE"," ",939],["T_PLUS_EQUAL","+=",939],["T_WHITESPACE"," ",939],["T_VARIABLE","$address",939],["T_OBJECT_OPERATOR","->",939],["T_STRING","getQuote",939],"(",")",["T_OBJECT_OPERATOR","->",939],["T_STRING","getTaxesForItems",939],"(",")",";",["T_WHITESPACE","\n        ",939],"}",["T_WHITESPACE","\n        ",940],["T_VARIABLE","$address",941],["T_OBJECT_OPERATOR","->",941],["T_STRING","getQuote",941],"(",")",["T_OBJECT_OPERATOR","->",941],["T_STRING","setTaxesForItems",941],"(",["T_VARIABLE","$itemTaxGroups",941],")",";",["T_WHITESPACE","\n\n        ",941],["T_FOREACH","foreach",943],["T_WHITESPACE"," ",943],"(",["T_VARIABLE","$taxGroups",943],["T_WHITESPACE"," ",943],["T_AS","as",943],["T_WHITESPACE"," ",943],["T_VARIABLE","$taxId",943],["T_WHITESPACE"," ",943],["T_DOUBLE_ARROW","=>",943],["T_WHITESPACE"," ",943],["T_VARIABLE","$data",943],")",["T_WHITESPACE"," ",943],"{",["T_WHITESPACE","\n            ",943],["T_IF","if",944],["T_WHITESPACE"," ",944],"(",["T_VARIABLE","$catalogPriceInclTax",944],")",["T_WHITESPACE"," ",944],"{",["T_WHITESPACE","\n                ",944],["T_VARIABLE","$rate",945],["T_WHITESPACE"," ",945],"=",["T_WHITESPACE"," ",945],["T_DOUBLE_CAST","(float)",945],["T_VARIABLE","$taxId",945],";",["T_WHITESPACE","\n            ",945],"}",["T_WHITESPACE"," ",946],["T_ELSE","else",946],["T_WHITESPACE"," ",946],"{",["T_WHITESPACE","\n                ",946],["T_VARIABLE","$rate",947],["T_WHITESPACE"," ",947],"=",["T_WHITESPACE"," ",947],["T_VARIABLE","$data",947],"[",["T_CONSTANT_ENCAPSED_STRING","'applied_rates'",947],"]","[",["T_LNUMBER","0",947],"]","[",["T_CONSTANT_ENCAPSED_STRING","'percent'",947],"]",";",["T_WHITESPACE","\n            ",947],"}",["T_WHITESPACE","\n\n            ",948],["T_VARIABLE","$inclTax",950],["T_WHITESPACE"," ",950],"=",["T_WHITESPACE"," ",950],["T_VARIABLE","$data",950],"[",["T_CONSTANT_ENCAPSED_STRING","'incl_tax'",950],"]",";",["T_WHITESPACE","\n\n            ",950],["T_VARIABLE","$totalTax",952],["T_WHITESPACE"," ",952],"=",["T_WHITESPACE"," ",952],["T_STRING","array_sum",952],"(",["T_VARIABLE","$data",952],"[",["T_CONSTANT_ENCAPSED_STRING","'tax'",952],"]",")",";",["T_WHITESPACE","\n            ",952],["T_VARIABLE","$baseTotalTax",953],["T_WHITESPACE"," ",953],"=",["T_WHITESPACE"," ",953],["T_STRING","array_sum",953],"(",["T_VARIABLE","$data",953],"[",["T_CONSTANT_ENCAPSED_STRING","'base_tax'",953],"]",")",";",["T_WHITESPACE","\n            ",953],["T_VARIABLE","$this",954],["T_OBJECT_OPERATOR","->",954],["T_STRING","_addAmount",954],"(",["T_VARIABLE","$totalTax",954],")",";",["T_WHITESPACE","\n            ",954],["T_VARIABLE","$this",955],["T_OBJECT_OPERATOR","->",955],["T_STRING","_addBaseAmount",955],"(",["T_VARIABLE","$baseTotalTax",955],")",";",["T_WHITESPACE","\n            ",955],["T_VARIABLE","$totalTaxRounded",956],["T_WHITESPACE"," ",956],"=",["T_WHITESPACE"," ",956],["T_VARIABLE","$this",956],["T_OBJECT_OPERATOR","->",956],["T_STRING","_calculator",956],["T_OBJECT_OPERATOR","->",956],["T_STRING","round",956],"(",["T_VARIABLE","$totalTax",956],")",";",["T_WHITESPACE","\n            ",956],["T_VARIABLE","$baseTotalTaxRounded",957],["T_WHITESPACE"," ",957],"=",["T_WHITESPACE"," ",957],["T_VARIABLE","$this",957],["T_OBJECT_OPERATOR","->",957],["T_STRING","_calculator",957],["T_OBJECT_OPERATOR","->",957],["T_STRING","round",957],"(",["T_VARIABLE","$totalTaxRounded",957],")",";",["T_WHITESPACE","\n            ",957],["T_VARIABLE","$this",958],["T_OBJECT_OPERATOR","->",958],["T_STRING","_saveAppliedTaxes",958],"(",["T_VARIABLE","$address",958],",",["T_WHITESPACE"," ",958],["T_VARIABLE","$data",958],"[",["T_CONSTANT_ENCAPSED_STRING","'applied_rates'",958],"]",",",["T_WHITESPACE"," ",958],["T_VARIABLE","$totalTaxRounded",958],",",["T_WHITESPACE"," ",958],["T_VARIABLE","$baseTotalTaxRounded",958],",",["T_WHITESPACE"," ",958],["T_VARIABLE","$rate",958],")",";",["T_WHITESPACE","\n        ",958],"}",["T_WHITESPACE","\n        ",959],["T_RETURN","return",960],["T_WHITESPACE"," ",960],["T_VARIABLE","$this",960],";",["T_WHITESPACE","\n    ",960],"}",["T_WHITESPACE","\n\n    ",961],["T_DOC_COMMENT","\/**\n     *\n     * @param Mage_Sales_Model_Quote_Item_Abstract $item\n     * @param Varien_Object $taxRateRequest\n     * @param array $taxGroups\n     * @param array $itemTaxGroups\n     * @param boolean $catalogPriceInclTax\n     *\/",963],["T_WHITESPACE","\n    ",970],["T_PROTECTED","protected",971],["T_WHITESPACE"," ",971],["T_FUNCTION","function",971],["T_WHITESPACE"," ",971],["T_STRING","_totalBaseProcessItemTax",971],"(",["T_WHITESPACE","\n        ",971],["T_VARIABLE","$item",972],",",["T_WHITESPACE"," ",972],["T_VARIABLE","$taxRateRequest",972],",",["T_WHITESPACE"," ",972],"&",["T_VARIABLE","$taxGroups",972],",",["T_WHITESPACE"," ",972],"&",["T_VARIABLE","$itemTaxGroups",972],",",["T_WHITESPACE"," ",972],["T_VARIABLE","$catalogPriceInclTax",972],["T_WHITESPACE","\n    ",972],")",["T_WHITESPACE","\n    ",973],"{",["T_WHITESPACE","\n        ",974],["T_VARIABLE","$taxRateRequest",975],["T_OBJECT_OPERATOR","->",975],["T_STRING","setProductClassId",975],"(",["T_VARIABLE","$item",975],["T_OBJECT_OPERATOR","->",975],["T_STRING","getProduct",975],"(",")",["T_OBJECT_OPERATOR","->",975],["T_STRING","getTaxClassId",975],"(",")",")",";",["T_WHITESPACE","\n        ",975],["T_VARIABLE","$rate",976],["T_WHITESPACE"," ",976],"=",["T_WHITESPACE"," ",976],["T_VARIABLE","$this",976],["T_OBJECT_OPERATOR","->",976],["T_STRING","_calculator",976],["T_OBJECT_OPERATOR","->",976],["T_STRING","getRate",976],"(",["T_VARIABLE","$taxRateRequest",976],")",";",["T_WHITESPACE","\n\n        ",976],["T_VARIABLE","$item",978],["T_OBJECT_OPERATOR","->",978],["T_STRING","setTaxAmount",978],"(",["T_LNUMBER","0",978],")",";",["T_WHITESPACE","\n        ",978],["T_VARIABLE","$item",979],["T_OBJECT_OPERATOR","->",979],["T_STRING","setBaseTaxAmount",979],"(",["T_LNUMBER","0",979],")",";",["T_WHITESPACE","\n        ",979],["T_VARIABLE","$item",980],["T_OBJECT_OPERATOR","->",980],["T_STRING","setHiddenTaxAmount",980],"(",["T_LNUMBER","0",980],")",";",["T_WHITESPACE","\n        ",980],["T_VARIABLE","$item",981],["T_OBJECT_OPERATOR","->",981],["T_STRING","setBaseHiddenTaxAmount",981],"(",["T_LNUMBER","0",981],")",";",["T_WHITESPACE","\n        ",981],["T_VARIABLE","$item",982],["T_OBJECT_OPERATOR","->",982],["T_STRING","setTaxPercent",982],"(",["T_VARIABLE","$rate",982],")",";",["T_WHITESPACE","\n        ",982],["T_VARIABLE","$item",983],["T_OBJECT_OPERATOR","->",983],["T_STRING","setDiscountTaxCompensation",983],"(",["T_LNUMBER","0",983],")",";",["T_WHITESPACE","\n        ",983],["T_VARIABLE","$rowTotalInclTax",984],["T_WHITESPACE"," ",984],"=",["T_WHITESPACE"," ",984],["T_VARIABLE","$item",984],["T_OBJECT_OPERATOR","->",984],["T_STRING","getRowTotalInclTax",984],"(",")",";",["T_WHITESPACE","\n        ",984],["T_VARIABLE","$recalculateRowTotalInclTax",985],["T_WHITESPACE"," ",985],"=",["T_WHITESPACE"," ",985],["T_STRING","false",985],";",["T_WHITESPACE","\n        ",985],["T_IF","if",986],["T_WHITESPACE"," ",986],"(","!",["T_ISSET","isset",986],"(",["T_VARIABLE","$rowTotalInclTax",986],")",")",["T_WHITESPACE"," ",986],"{",["T_WHITESPACE","\n            ",986],["T_VARIABLE","$item",987],["T_OBJECT_OPERATOR","->",987],["T_STRING","setRowTotalInclTax",987],"(",["T_VARIABLE","$item",987],["T_OBJECT_OPERATOR","->",987],["T_STRING","getTaxableAmount",987],"(",")",")",";",["T_WHITESPACE","\n            ",987],["T_VARIABLE","$item",988],["T_OBJECT_OPERATOR","->",988],["T_STRING","setBaseRowTotalInclTax",988],"(",["T_VARIABLE","$item",988],["T_OBJECT_OPERATOR","->",988],["T_STRING","getBaseTaxableAmount",988],"(",")",")",";",["T_WHITESPACE","\n            ",988],["T_VARIABLE","$recalculateRowTotalInclTax",989],["T_WHITESPACE"," ",989],"=",["T_WHITESPACE"," ",989],["T_STRING","true",989],";",["T_WHITESPACE","\n        ",989],"}",["T_WHITESPACE","\n\n        ",990],["T_VARIABLE","$appliedRates",992],["T_WHITESPACE"," ",992],"=",["T_WHITESPACE"," ",992],["T_VARIABLE","$this",992],["T_OBJECT_OPERATOR","->",992],["T_STRING","_calculator",992],["T_OBJECT_OPERATOR","->",992],["T_STRING","getAppliedRates",992],"(",["T_VARIABLE","$taxRateRequest",992],")",";",["T_WHITESPACE","\n        ",992],["T_IF","if",993],["T_WHITESPACE"," ",993],"(",["T_VARIABLE","$catalogPriceInclTax",993],")",["T_WHITESPACE"," ",993],"{",["T_WHITESPACE","\n            ",993],["T_VARIABLE","$taxGroups",994],"[",["T_STRING_CAST","(string)",994],["T_VARIABLE","$rate",994],"]","[",["T_CONSTANT_ENCAPSED_STRING","'applied_rates'",994],"]",["T_WHITESPACE"," ",994],"=",["T_WHITESPACE"," ",994],["T_VARIABLE","$appliedRates",994],";",["T_WHITESPACE","\n            ",994],["T_VARIABLE","$taxGroups",995],"[",["T_STRING_CAST","(string)",995],["T_VARIABLE","$rate",995],"]","[",["T_CONSTANT_ENCAPSED_STRING","'incl_tax'",995],"]",["T_WHITESPACE"," ",995],"=",["T_WHITESPACE"," ",995],["T_VARIABLE","$item",995],["T_OBJECT_OPERATOR","->",995],["T_STRING","getIsPriceInclTax",995],"(",")",";",["T_WHITESPACE","\n            ",995],["T_VARIABLE","$this",996],["T_OBJECT_OPERATOR","->",996],["T_STRING","_aggregateTaxPerRate",996],"(",["T_VARIABLE","$item",996],",",["T_WHITESPACE"," ",996],["T_VARIABLE","$rate",996],",",["T_WHITESPACE"," ",996],["T_VARIABLE","$taxGroups",996],")",";",["T_WHITESPACE","\n        ",996],"}",["T_WHITESPACE"," ",997],["T_ELSE","else",997],["T_WHITESPACE"," ",997],"{",["T_WHITESPACE","\n            ",997],["T_COMMENT","\/\/need to calculate each tax separately\n",998],["T_WHITESPACE","            ",999],["T_FOREACH","foreach",999],["T_WHITESPACE"," ",999],"(",["T_VARIABLE","$appliedRates",999],["T_WHITESPACE"," ",999],["T_AS","as",999],["T_WHITESPACE"," ",999],["T_VARIABLE","$appliedTax",999],")",["T_WHITESPACE"," ",999],"{",["T_WHITESPACE","\n                ",999],["T_VARIABLE","$taxId",1000],["T_WHITESPACE"," ",1000],"=",["T_WHITESPACE"," ",1000],["T_VARIABLE","$appliedTax",1000],"[",["T_CONSTANT_ENCAPSED_STRING","'id'",1000],"]",";",["T_WHITESPACE","\n                ",1000],["T_VARIABLE","$taxRate",1001],["T_WHITESPACE"," ",1001],"=",["T_WHITESPACE"," ",1001],["T_VARIABLE","$appliedTax",1001],"[",["T_CONSTANT_ENCAPSED_STRING","'percent'",1001],"]",";",["T_WHITESPACE","\n                ",1001],["T_VARIABLE","$taxGroups",1002],"[",["T_VARIABLE","$taxId",1002],"]","[",["T_CONSTANT_ENCAPSED_STRING","'applied_rates'",1002],"]",["T_WHITESPACE"," ",1002],"=",["T_WHITESPACE"," ",1002],["T_ARRAY","array",1002],"(",["T_VARIABLE","$appliedTax",1002],")",";",["T_WHITESPACE","\n                ",1002],["T_VARIABLE","$taxGroups",1003],"[",["T_VARIABLE","$taxId",1003],"]","[",["T_CONSTANT_ENCAPSED_STRING","'incl_tax'",1003],"]",["T_WHITESPACE"," ",1003],"=",["T_WHITESPACE"," ",1003],["T_VARIABLE","$item",1003],["T_OBJECT_OPERATOR","->",1003],["T_STRING","getIsPriceInclTax",1003],"(",")",";",["T_WHITESPACE","\n                ",1003],["T_VARIABLE","$this",1004],["T_OBJECT_OPERATOR","->",1004],["T_STRING","_aggregateTaxPerRate",1004],"(",["T_VARIABLE","$item",1004],",",["T_WHITESPACE"," ",1004],["T_VARIABLE","$taxRate",1004],",",["T_WHITESPACE"," ",1004],["T_VARIABLE","$taxGroups",1004],",",["T_WHITESPACE"," ",1004],["T_VARIABLE","$taxId",1004],",",["T_WHITESPACE"," ",1004],["T_VARIABLE","$recalculateRowTotalInclTax",1004],")",";",["T_WHITESPACE","\n            ",1004],"}",["T_WHITESPACE","\n\n            ",1005],["T_COMMENT","\/\/We need to calculate weeeAmountInclTax using multiple tax rate here\n",1007],["T_WHITESPACE","            ",1008],["T_COMMENT","\/\/because the _calculateWeeeTax and _calculateRowWeeeTax only take one tax rate\n",1008],["T_WHITESPACE","            ",1009],["T_IF","if",1009],["T_WHITESPACE"," ",1009],"(",["T_VARIABLE","$this",1009],["T_OBJECT_OPERATOR","->",1009],["T_STRING","_weeeHelper",1009],["T_OBJECT_OPERATOR","->",1009],["T_STRING","isEnabled",1009],"(",")",["T_WHITESPACE"," ",1009],["T_BOOLEAN_AND","&&",1009],["T_WHITESPACE"," ",1009],["T_VARIABLE","$this",1009],["T_OBJECT_OPERATOR","->",1009],["T_STRING","_weeeHelper",1009],["T_OBJECT_OPERATOR","->",1009],["T_STRING","isTaxable",1009],"(",")",")",["T_WHITESPACE"," ",1009],"{",["T_WHITESPACE","\n                ",1009],["T_VARIABLE","$this",1010],["T_OBJECT_OPERATOR","->",1010],["T_STRING","_calculateWeeeAmountInclTax",1010],"(",["T_VARIABLE","$item",1010],",",["T_WHITESPACE"," ",1010],["T_VARIABLE","$appliedRates",1010],",",["T_WHITESPACE"," ",1010],["T_STRING","false",1010],")",";",["T_WHITESPACE","\n                ",1010],["T_VARIABLE","$this",1011],["T_OBJECT_OPERATOR","->",1011],["T_STRING","_calculateWeeeAmountInclTax",1011],"(",["T_VARIABLE","$item",1011],",",["T_WHITESPACE"," ",1011],["T_VARIABLE","$appliedRates",1011],",",["T_WHITESPACE"," ",1011],["T_STRING","true",1011],")",";",["T_WHITESPACE","\n            ",1011],"}",["T_WHITESPACE","\n        ",1012],"}",["T_WHITESPACE","\n        ",1013],["T_IF","if",1014],["T_WHITESPACE"," ",1014],"(",["T_VARIABLE","$rate",1014],["T_WHITESPACE"," ",1014],">",["T_WHITESPACE"," ",1014],["T_LNUMBER","0",1014],")",["T_WHITESPACE"," ",1014],"{",["T_WHITESPACE","\n            ",1014],["T_VARIABLE","$itemTaxGroups",1015],"[",["T_VARIABLE","$item",1015],["T_OBJECT_OPERATOR","->",1015],["T_STRING","getId",1015],"(",")","]",["T_WHITESPACE"," ",1015],"=",["T_WHITESPACE"," ",1015],["T_VARIABLE","$appliedRates",1015],";",["T_WHITESPACE","\n        ",1015],"}",["T_WHITESPACE","\n        ",1016],["T_RETURN","return",1017],";",["T_WHITESPACE","\n    ",1017],"}",["T_WHITESPACE","\n\n    ",1018],["T_DOC_COMMENT","\/**\n     * Aggregate row totals per tax rate in array\n     *\n     * @param   Mage_Sales_Model_Quote_Item_Abstract $item\n     * @param   float $rate\n     * @param   array $taxGroups\n     * @return  Mage_Tax_Model_Sales_Total_Quote\n     *\/",1020],["T_WHITESPACE","\n    ",1027],["T_PROTECTED","protected",1028],["T_WHITESPACE"," ",1028],["T_FUNCTION","function",1028],["T_WHITESPACE"," ",1028],["T_STRING","_aggregateTaxPerRate",1028],"(",["T_WHITESPACE","\n        ",1028],["T_VARIABLE","$item",1029],",",["T_WHITESPACE"," ",1029],["T_VARIABLE","$rate",1029],",",["T_WHITESPACE"," ",1029],"&",["T_VARIABLE","$taxGroups",1029],",",["T_WHITESPACE"," ",1029],["T_VARIABLE","$taxId",1029],["T_WHITESPACE"," ",1029],"=",["T_WHITESPACE"," ",1029],["T_STRING","null",1029],",",["T_WHITESPACE"," ",1029],["T_VARIABLE","$recalculateRowTotalInclTax",1029],["T_WHITESPACE"," ",1029],"=",["T_WHITESPACE"," ",1029],["T_STRING","false",1029],["T_WHITESPACE","\n    ",1029],")",["T_WHITESPACE","\n    ",1030],"{",["T_WHITESPACE","\n        ",1031],["T_VARIABLE","$inclTax",1032],["T_WHITESPACE"," ",1032],"=",["T_WHITESPACE"," ",1032],["T_VARIABLE","$item",1032],["T_OBJECT_OPERATOR","->",1032],["T_STRING","getIsPriceInclTax",1032],"(",")",";",["T_WHITESPACE","\n        ",1032],["T_VARIABLE","$rateKey",1033],["T_WHITESPACE"," ",1033],"=",["T_WHITESPACE"," ",1033],"(",["T_VARIABLE","$taxId",1033],["T_WHITESPACE"," ",1033],["T_IS_EQUAL","==",1033],["T_WHITESPACE"," ",1033],["T_STRING","null",1033],")",["T_WHITESPACE"," ",1033],"?",["T_WHITESPACE"," ",1033],["T_STRING_CAST","(string)",1033],["T_VARIABLE","$rate",1033],["T_WHITESPACE"," ",1033],":",["T_WHITESPACE"," ",1033],["T_VARIABLE","$taxId",1033],";",["T_WHITESPACE","\n        ",1033],["T_VARIABLE","$taxSubtotal",1034],["T_WHITESPACE"," ",1034],"=",["T_WHITESPACE"," ",1034],["T_VARIABLE","$subtotal",1034],["T_WHITESPACE"," ",1034],"=",["T_WHITESPACE"," ",1034],["T_VARIABLE","$item",1034],["T_OBJECT_OPERATOR","->",1034],["T_STRING","getTaxableAmount",1034],"(",")",";",["T_WHITESPACE","\n        ",1034],["T_VARIABLE","$baseTaxSubtotal",1035],["T_WHITESPACE"," ",1035],"=",["T_WHITESPACE"," ",1035],["T_VARIABLE","$baseSubtotal",1035],["T_WHITESPACE"," ",1035],"=",["T_WHITESPACE"," ",1035],["T_VARIABLE","$item",1035],["T_OBJECT_OPERATOR","->",1035],["T_STRING","getBaseTaxableAmount",1035],"(",")",";",["T_WHITESPACE","\n\n        ",1035],["T_VARIABLE","$isWeeeEnabled",1037],["T_WHITESPACE"," ",1037],"=",["T_WHITESPACE"," ",1037],["T_VARIABLE","$this",1037],["T_OBJECT_OPERATOR","->",1037],["T_STRING","_weeeHelper",1037],["T_OBJECT_OPERATOR","->",1037],["T_STRING","isEnabled",1037],"(",")",";",["T_WHITESPACE","\n        ",1037],["T_VARIABLE","$isWeeeTaxable",1038],["T_WHITESPACE"," ",1038],"=",["T_WHITESPACE"," ",1038],["T_VARIABLE","$this",1038],["T_OBJECT_OPERATOR","->",1038],["T_STRING","_weeeHelper",1038],["T_OBJECT_OPERATOR","->",1038],["T_STRING","isTaxable",1038],"(",")",";",["T_WHITESPACE","\n\n        ",1038],["T_IF","if",1040],["T_WHITESPACE"," ",1040],"(","!",["T_ISSET","isset",1040],"(",["T_VARIABLE","$taxGroups",1040],"[",["T_VARIABLE","$rateKey",1040],"]","[",["T_CONSTANT_ENCAPSED_STRING","'totals'",1040],"]",")",")",["T_WHITESPACE"," ",1040],"{",["T_WHITESPACE","\n            ",1040],["T_VARIABLE","$taxGroups",1041],"[",["T_VARIABLE","$rateKey",1041],"]","[",["T_CONSTANT_ENCAPSED_STRING","'totals'",1041],"]",["T_WHITESPACE"," ",1041],"=",["T_WHITESPACE"," ",1041],["T_ARRAY","array",1041],"(",")",";",["T_WHITESPACE","\n            ",1041],["T_VARIABLE","$taxGroups",1042],"[",["T_VARIABLE","$rateKey",1042],"]","[",["T_CONSTANT_ENCAPSED_STRING","'base_totals'",1042],"]",["T_WHITESPACE"," ",1042],"=",["T_WHITESPACE"," ",1042],["T_ARRAY","array",1042],"(",")",";",["T_WHITESPACE","\n            ",1042],["T_VARIABLE","$taxGroups",1043],"[",["T_VARIABLE","$rateKey",1043],"]","[",["T_CONSTANT_ENCAPSED_STRING","'weee_tax'",1043],"]",["T_WHITESPACE"," ",1043],"=",["T_WHITESPACE"," ",1043],["T_ARRAY","array",1043],"(",")",";",["T_WHITESPACE","\n            ",1043],["T_VARIABLE","$taxGroups",1044],"[",["T_VARIABLE","$rateKey",1044],"]","[",["T_CONSTANT_ENCAPSED_STRING","'base_weee_tax'",1044],"]",["T_WHITESPACE"," ",1044],"=",["T_WHITESPACE"," ",1044],["T_ARRAY","array",1044],"(",")",";",["T_WHITESPACE","\n        ",1044],"}",["T_WHITESPACE","\n\n        ",1045],["T_VARIABLE","$hiddenTax",1047],["T_WHITESPACE"," ",1047],"=",["T_WHITESPACE"," ",1047],["T_STRING","null",1047],";",["T_WHITESPACE","\n        ",1047],["T_VARIABLE","$baseHiddenTax",1048],["T_WHITESPACE"," ",1048],"=",["T_WHITESPACE"," ",1048],["T_STRING","null",1048],";",["T_WHITESPACE","\n        ",1048],["T_VARIABLE","$weeeTax",1049],["T_WHITESPACE"," ",1049],"=",["T_WHITESPACE"," ",1049],["T_STRING","null",1049],";",["T_WHITESPACE","\n        ",1049],["T_VARIABLE","$baseWeeeTax",1050],["T_WHITESPACE"," ",1050],"=",["T_WHITESPACE"," ",1050],["T_STRING","null",1050],";",["T_WHITESPACE","\n        ",1050],["T_VARIABLE","$discount",1051],["T_WHITESPACE"," ",1051],"=",["T_WHITESPACE"," ",1051],["T_LNUMBER","0",1051],";",["T_WHITESPACE","\n        ",1051],["T_VARIABLE","$rowTaxBeforeDiscount",1052],["T_WHITESPACE"," ",1052],"=",["T_WHITESPACE"," ",1052],["T_LNUMBER","0",1052],";",["T_WHITESPACE","\n        ",1052],["T_VARIABLE","$baseRowTaxBeforeDiscount",1053],["T_WHITESPACE"," ",1053],"=",["T_WHITESPACE"," ",1053],["T_LNUMBER","0",1053],";",["T_WHITESPACE","\n        ",1053],["T_VARIABLE","$weeeRowTaxBeforeDiscount",1054],["T_WHITESPACE"," ",1054],"=",["T_WHITESPACE"," ",1054],["T_LNUMBER","0",1054],";",["T_WHITESPACE","\n        ",1054],["T_VARIABLE","$baseWeeeRowTaxBeforeDiscount",1055],["T_WHITESPACE"," ",1055],"=",["T_WHITESPACE"," ",1055],["T_LNUMBER","0",1055],";",["T_WHITESPACE","\n\n\n        ",1055],["T_SWITCH","switch",1058],["T_WHITESPACE"," ",1058],"(",["T_VARIABLE","$this",1058],["T_OBJECT_OPERATOR","->",1058],["T_STRING","_helper",1058],["T_OBJECT_OPERATOR","->",1058],["T_STRING","getCalculationSequence",1058],"(",["T_VARIABLE","$this",1058],["T_OBJECT_OPERATOR","->",1058],["T_STRING","_store",1058],")",")",["T_WHITESPACE"," ",1058],"{",["T_WHITESPACE","\n            ",1058],["T_CASE","case",1059],["T_WHITESPACE"," ",1059],["T_STRING","Mage_Tax_Model_Calculation",1059],["T_DOUBLE_COLON","::",1059],["T_STRING","CALC_TAX_BEFORE_DISCOUNT_ON_EXCL",1059],":",["T_WHITESPACE","\n            ",1059],["T_CASE","case",1060],["T_WHITESPACE"," ",1060],["T_STRING","Mage_Tax_Model_Calculation",1060],["T_DOUBLE_COLON","::",1060],["T_STRING","CALC_TAX_BEFORE_DISCOUNT_ON_INCL",1060],":",["T_WHITESPACE","\n                ",1060],["T_VARIABLE","$rowTaxBeforeDiscount",1061],["T_WHITESPACE"," ",1061],"=",["T_WHITESPACE"," ",1061],["T_VARIABLE","$this",1061],["T_OBJECT_OPERATOR","->",1061],["T_STRING","_calculator",1061],["T_OBJECT_OPERATOR","->",1061],["T_STRING","calcTaxAmount",1061],"(",["T_VARIABLE","$subtotal",1061],",",["T_WHITESPACE"," ",1061],["T_VARIABLE","$rate",1061],",",["T_WHITESPACE"," ",1061],["T_VARIABLE","$inclTax",1061],",",["T_WHITESPACE"," ",1061],["T_STRING","false",1061],")",";",["T_WHITESPACE","\n                ",1061],["T_VARIABLE","$baseRowTaxBeforeDiscount",1062],["T_WHITESPACE"," ",1062],"=",["T_WHITESPACE"," ",1062],["T_VARIABLE","$this",1062],["T_OBJECT_OPERATOR","->",1062],["T_STRING","_calculator",1062],["T_OBJECT_OPERATOR","->",1062],["T_STRING","calcTaxAmount",1062],"(",["T_VARIABLE","$baseSubtotal",1062],",",["T_WHITESPACE"," ",1062],["T_VARIABLE","$rate",1062],",",["T_WHITESPACE"," ",1062],["T_VARIABLE","$inclTax",1062],",",["T_WHITESPACE"," ",1062],["T_STRING","false",1062],")",";",["T_WHITESPACE","\n\n                ",1062],["T_IF","if",1064],["T_WHITESPACE"," ",1064],"(",["T_VARIABLE","$isWeeeEnabled",1064],["T_WHITESPACE"," ",1064],["T_BOOLEAN_AND","&&",1064],["T_WHITESPACE"," ",1064],["T_VARIABLE","$isWeeeTaxable",1064],")",["T_WHITESPACE"," ",1064],"{",["T_WHITESPACE","\n                    ",1064],["T_VARIABLE","$weeeRowTaxBeforeDiscount",1065],["T_WHITESPACE"," ",1065],"=",["T_WHITESPACE"," ",1065],["T_VARIABLE","$this",1065],["T_OBJECT_OPERATOR","->",1065],["T_STRING","_calculateRowWeeeTax",1065],"(",["T_LNUMBER","0",1065],",",["T_WHITESPACE"," ",1065],["T_VARIABLE","$item",1065],",",["T_WHITESPACE"," ",1065],["T_VARIABLE","$rate",1065],",",["T_WHITESPACE"," ",1065],["T_STRING","false",1065],")",";",["T_WHITESPACE","\n                    ",1065],["T_VARIABLE","$baseWeeeRowTaxBeforeDiscount",1066],["T_WHITESPACE"," ",1066],"=",["T_WHITESPACE"," ",1066],["T_VARIABLE","$this",1066],["T_OBJECT_OPERATOR","->",1066],["T_STRING","_calculateRowWeeeTax",1066],"(",["T_LNUMBER","0",1066],",",["T_WHITESPACE"," ",1066],["T_VARIABLE","$item",1066],",",["T_WHITESPACE"," ",1066],["T_VARIABLE","$rate",1066],")",";",["T_WHITESPACE","\n                    ",1066],["T_VARIABLE","$rowTaxBeforeDiscount",1067],["T_WHITESPACE"," ",1067],["T_PLUS_EQUAL","+=",1067],["T_WHITESPACE"," ",1067],["T_VARIABLE","$weeeRowTaxBeforeDiscount",1067],";",["T_WHITESPACE","\n                    ",1067],["T_VARIABLE","$baseRowTaxBeforeDiscount",1068],["T_WHITESPACE"," ",1068],["T_PLUS_EQUAL","+=",1068],["T_WHITESPACE"," ",1068],["T_VARIABLE","$baseWeeeRowTaxBeforeDiscount",1068],";",["T_WHITESPACE","\n                    ",1068],["T_VARIABLE","$taxGroups",1069],"[",["T_VARIABLE","$rateKey",1069],"]","[",["T_CONSTANT_ENCAPSED_STRING","'weee_tax'",1069],"]","[","]",["T_WHITESPACE"," ",1069],"=",["T_WHITESPACE"," ",1069],["T_VARIABLE","$this",1069],["T_OBJECT_OPERATOR","->",1069],["T_STRING","_deltaRound",1069],"(",["T_VARIABLE","$weeeRowTaxBeforeDiscount",1069],",",["T_WHITESPACE","\n                        ",1069],["T_VARIABLE","$rateKey",1070],",",["T_WHITESPACE"," ",1070],["T_VARIABLE","$inclTax",1070],")",";",["T_WHITESPACE","\n                    ",1070],["T_VARIABLE","$taxGroups",1071],"[",["T_VARIABLE","$rateKey",1071],"]","[",["T_CONSTANT_ENCAPSED_STRING","'base_weee_tax'",1071],"]","[","]",["T_WHITESPACE"," ",1071],"=",["T_WHITESPACE"," ",1071],["T_VARIABLE","$this",1071],["T_OBJECT_OPERATOR","->",1071],["T_STRING","_deltaRound",1071],"(",["T_VARIABLE","$baseWeeeRowTaxBeforeDiscount",1071],",",["T_WHITESPACE","\n                        ",1071],["T_VARIABLE","$rateKey",1072],",",["T_WHITESPACE"," ",1072],["T_VARIABLE","$inclTax",1072],")",";",["T_WHITESPACE","\n                ",1072],"}",["T_WHITESPACE","\n                ",1073],["T_VARIABLE","$taxBeforeDiscountRounded",1074],["T_WHITESPACE"," ",1074],"=",["T_WHITESPACE"," ",1074],["T_VARIABLE","$rowTax",1074],["T_WHITESPACE"," ",1074],"=",["T_WHITESPACE"," ",1074],["T_VARIABLE","$this",1074],["T_OBJECT_OPERATOR","->",1074],["T_STRING","_deltaRound",1074],"(",["T_VARIABLE","$rowTaxBeforeDiscount",1074],",",["T_WHITESPACE"," ",1074],["T_VARIABLE","$rateKey",1074],",",["T_WHITESPACE"," ",1074],["T_VARIABLE","$inclTax",1074],")",";",["T_WHITESPACE","\n                ",1074],["T_VARIABLE","$baseTaxBeforeDiscountRounded",1075],["T_WHITESPACE"," ",1075],"=",["T_WHITESPACE"," ",1075],["T_VARIABLE","$baseRowTax",1075],["T_WHITESPACE"," ",1075],"=",["T_WHITESPACE"," ",1075],["T_VARIABLE","$this",1075],["T_OBJECT_OPERATOR","->",1075],["T_STRING","_deltaRound",1075],"(",["T_VARIABLE","$baseRowTaxBeforeDiscount",1075],",",["T_WHITESPACE","\n                    ",1075],["T_VARIABLE","$rateKey",1076],",",["T_WHITESPACE"," ",1076],["T_VARIABLE","$inclTax",1076],",",["T_WHITESPACE"," ",1076],["T_CONSTANT_ENCAPSED_STRING","'base'",1076],")",";",["T_WHITESPACE","\n                ",1076],["T_VARIABLE","$item",1077],["T_OBJECT_OPERATOR","->",1077],["T_STRING","setTaxAmount",1077],"(",["T_VARIABLE","$item",1077],["T_OBJECT_OPERATOR","->",1077],["T_STRING","getTaxAmount",1077],"(",")",["T_WHITESPACE"," ",1077],"+",["T_WHITESPACE"," ",1077],["T_STRING","max",1077],"(",["T_LNUMBER","0",1077],",",["T_WHITESPACE"," ",1077],["T_VARIABLE","$rowTax",1077],")",")",";",["T_WHITESPACE","\n                ",1077],["T_VARIABLE","$item",1078],["T_OBJECT_OPERATOR","->",1078],["T_STRING","setBaseTaxAmount",1078],"(",["T_VARIABLE","$item",1078],["T_OBJECT_OPERATOR","->",1078],["T_STRING","getBaseTaxAmount",1078],"(",")",["T_WHITESPACE"," ",1078],"+",["T_WHITESPACE"," ",1078],["T_STRING","max",1078],"(",["T_LNUMBER","0",1078],",",["T_WHITESPACE"," ",1078],["T_VARIABLE","$baseRowTax",1078],")",")",";",["T_WHITESPACE","\n                ",1078],["T_BREAK","break",1079],";",["T_WHITESPACE","\n            ",1079],["T_CASE","case",1080],["T_WHITESPACE"," ",1080],["T_STRING","Mage_Tax_Model_Calculation",1080],["T_DOUBLE_COLON","::",1080],["T_STRING","CALC_TAX_AFTER_DISCOUNT_ON_EXCL",1080],":",["T_WHITESPACE","\n            ",1080],["T_CASE","case",1081],["T_WHITESPACE"," ",1081],["T_STRING","Mage_Tax_Model_Calculation",1081],["T_DOUBLE_COLON","::",1081],["T_STRING","CALC_TAX_AFTER_DISCOUNT_ON_INCL",1081],":",["T_WHITESPACE","\n                ",1081],["T_IF","if",1082],["T_WHITESPACE"," ",1082],"(",["T_VARIABLE","$this",1082],["T_OBJECT_OPERATOR","->",1082],["T_STRING","_helper",1082],["T_OBJECT_OPERATOR","->",1082],["T_STRING","applyTaxOnOriginalPrice",1082],"(",["T_VARIABLE","$this",1082],["T_OBJECT_OPERATOR","->",1082],["T_STRING","_store",1082],")",")",["T_WHITESPACE"," ",1082],"{",["T_WHITESPACE","\n                    ",1082],["T_VARIABLE","$discount",1083],["T_WHITESPACE"," ",1083],"=",["T_WHITESPACE"," ",1083],["T_VARIABLE","$item",1083],["T_OBJECT_OPERATOR","->",1083],["T_STRING","getOriginalDiscountAmount",1083],"(",")",";",["T_WHITESPACE","\n                    ",1083],["T_VARIABLE","$baseDiscount",1084],["T_WHITESPACE"," ",1084],"=",["T_WHITESPACE"," ",1084],["T_VARIABLE","$item",1084],["T_OBJECT_OPERATOR","->",1084],["T_STRING","getBaseOriginalDiscountAmount",1084],"(",")",";",["T_WHITESPACE","\n                ",1084],"}",["T_WHITESPACE"," ",1085],["T_ELSE","else",1085],["T_WHITESPACE"," ",1085],"{",["T_WHITESPACE","\n                    ",1085],["T_VARIABLE","$discount",1086],["T_WHITESPACE"," ",1086],"=",["T_WHITESPACE"," ",1086],["T_VARIABLE","$item",1086],["T_OBJECT_OPERATOR","->",1086],["T_STRING","getDiscountAmount",1086],"(",")",";",["T_WHITESPACE","\n                    ",1086],["T_VARIABLE","$baseDiscount",1087],["T_WHITESPACE"," ",1087],"=",["T_WHITESPACE"," ",1087],["T_VARIABLE","$item",1087],["T_OBJECT_OPERATOR","->",1087],["T_STRING","getBaseDiscountAmount",1087],"(",")",";",["T_WHITESPACE","\n                ",1087],"}",["T_WHITESPACE","\n\n                ",1088],["T_COMMENT","\/\/We remove weee discount from discount if weee is not taxed\n",1090],["T_WHITESPACE","                ",1091],["T_IF","if",1091],["T_WHITESPACE"," ",1091],"(",["T_VARIABLE","$isWeeeEnabled",1091],["T_WHITESPACE"," ",1091],["T_BOOLEAN_AND","&&",1091],["T_WHITESPACE"," ",1091],["T_VARIABLE","$this",1091],["T_OBJECT_OPERATOR","->",1091],["T_STRING","_weeeHelper",1091],["T_OBJECT_OPERATOR","->",1091],["T_STRING","includeInSubtotal",1091],"(",")",")",["T_WHITESPACE"," ",1091],"{",["T_WHITESPACE","\n                    ",1091],["T_VARIABLE","$discount",1092],["T_WHITESPACE"," ",1092],"=",["T_WHITESPACE"," ",1092],["T_VARIABLE","$discount",1092],["T_WHITESPACE"," ",1092],"-",["T_WHITESPACE"," ",1092],["T_VARIABLE","$item",1092],["T_OBJECT_OPERATOR","->",1092],["T_STRING","getWeeeDiscount",1092],"(",")",";",["T_WHITESPACE","\n                    ",1092],["T_VARIABLE","$baseDiscount",1093],["T_WHITESPACE"," ",1093],"=",["T_WHITESPACE"," ",1093],["T_VARIABLE","$baseDiscount",1093],["T_WHITESPACE"," ",1093],"-",["T_WHITESPACE"," ",1093],["T_VARIABLE","$item",1093],["T_OBJECT_OPERATOR","->",1093],["T_STRING","getBaseWeeeDiscount",1093],"(",")",";",["T_WHITESPACE","\n                ",1093],"}",["T_WHITESPACE","\n                ",1094],["T_VARIABLE","$taxSubtotal",1095],["T_WHITESPACE"," ",1095],"=",["T_WHITESPACE"," ",1095],["T_STRING","max",1095],"(",["T_VARIABLE","$subtotal",1095],["T_WHITESPACE"," ",1095],"-",["T_WHITESPACE"," ",1095],["T_VARIABLE","$discount",1095],",",["T_WHITESPACE"," ",1095],["T_LNUMBER","0",1095],")",";",["T_WHITESPACE","\n                ",1095],["T_VARIABLE","$baseTaxSubtotal",1096],["T_WHITESPACE"," ",1096],"=",["T_WHITESPACE"," ",1096],["T_STRING","max",1096],"(",["T_VARIABLE","$baseSubtotal",1096],["T_WHITESPACE"," ",1096],"-",["T_WHITESPACE"," ",1096],["T_VARIABLE","$baseDiscount",1096],",",["T_WHITESPACE"," ",1096],["T_LNUMBER","0",1096],")",";",["T_WHITESPACE","\n\n                ",1096],["T_VARIABLE","$rowTax",1098],["T_WHITESPACE"," ",1098],"=",["T_WHITESPACE"," ",1098],["T_VARIABLE","$this",1098],["T_OBJECT_OPERATOR","->",1098],["T_STRING","_calculator",1098],["T_OBJECT_OPERATOR","->",1098],["T_STRING","calcTaxAmount",1098],"(",["T_VARIABLE","$taxSubtotal",1098],",",["T_WHITESPACE"," ",1098],["T_VARIABLE","$rate",1098],",",["T_WHITESPACE"," ",1098],["T_VARIABLE","$inclTax",1098],",",["T_WHITESPACE"," ",1098],["T_STRING","false",1098],")",";",["T_WHITESPACE","\n                ",1098],["T_VARIABLE","$baseRowTax",1099],["T_WHITESPACE"," ",1099],"=",["T_WHITESPACE"," ",1099],["T_VARIABLE","$this",1099],["T_OBJECT_OPERATOR","->",1099],["T_STRING","_calculator",1099],["T_OBJECT_OPERATOR","->",1099],["T_STRING","calcTaxAmount",1099],"(",["T_VARIABLE","$baseTaxSubtotal",1099],",",["T_WHITESPACE"," ",1099],["T_VARIABLE","$rate",1099],",",["T_WHITESPACE"," ",1099],["T_VARIABLE","$inclTax",1099],",",["T_WHITESPACE"," ",1099],["T_STRING","false",1099],")",";",["T_WHITESPACE","\n\n                ",1099],["T_IF","if",1101],["T_WHITESPACE"," ",1101],"(",["T_VARIABLE","$isWeeeEnabled",1101],["T_WHITESPACE"," ",1101],["T_BOOLEAN_AND","&&",1101],["T_WHITESPACE"," ",1101],["T_VARIABLE","$this",1101],["T_OBJECT_OPERATOR","->",1101],["T_STRING","_weeeHelper",1101],["T_OBJECT_OPERATOR","->",1101],["T_STRING","isTaxable",1101],"(",")",")",["T_WHITESPACE"," ",1101],"{",["T_WHITESPACE","\n                    ",1101],["T_VARIABLE","$weeeTax",1102],["T_WHITESPACE"," ",1102],"=",["T_WHITESPACE"," ",1102],["T_VARIABLE","$this",1102],["T_OBJECT_OPERATOR","->",1102],["T_STRING","_calculateRowWeeeTax",1102],"(",["T_VARIABLE","$item",1102],["T_OBJECT_OPERATOR","->",1102],["T_STRING","getWeeeDiscount",1102],"(",")",",",["T_WHITESPACE"," ",1102],["T_VARIABLE","$item",1102],",",["T_WHITESPACE"," ",1102],["T_VARIABLE","$rate",1102],",",["T_WHITESPACE"," ",1102],["T_STRING","false",1102],")",";",["T_WHITESPACE","\n                    ",1102],["T_VARIABLE","$rowTax",1103],["T_WHITESPACE"," ",1103],["T_PLUS_EQUAL","+=",1103],["T_WHITESPACE"," ",1103],["T_VARIABLE","$weeeTax",1103],";",["T_WHITESPACE","\n                    ",1103],["T_VARIABLE","$baseWeeeTax",1104],["T_WHITESPACE"," ",1104],"=",["T_WHITESPACE"," ",1104],["T_VARIABLE","$this",1104],["T_OBJECT_OPERATOR","->",1104],["T_STRING","_calculateRowWeeeTax",1104],"(",["T_VARIABLE","$item",1104],["T_OBJECT_OPERATOR","->",1104],["T_STRING","getBaseWeeeDiscount",1104],"(",")",",",["T_WHITESPACE"," ",1104],["T_VARIABLE","$item",1104],",",["T_WHITESPACE"," ",1104],["T_VARIABLE","$rate",1104],")",";",["T_WHITESPACE","\n                    ",1104],["T_VARIABLE","$baseRowTax",1105],["T_WHITESPACE"," ",1105],["T_PLUS_EQUAL","+=",1105],["T_WHITESPACE"," ",1105],["T_VARIABLE","$baseWeeeTax",1105],";",["T_WHITESPACE","\n                    ",1105],["T_VARIABLE","$taxGroups",1106],"[",["T_VARIABLE","$rateKey",1106],"]","[",["T_CONSTANT_ENCAPSED_STRING","'weee_tax'",1106],"]","[","]",["T_WHITESPACE"," ",1106],"=",["T_WHITESPACE"," ",1106],["T_VARIABLE","$weeeTax",1106],";",["T_WHITESPACE","\n                    ",1106],["T_VARIABLE","$taxGroups",1107],"[",["T_VARIABLE","$rateKey",1107],"]","[",["T_CONSTANT_ENCAPSED_STRING","'base_weee_tax'",1107],"]","[","]",["T_WHITESPACE"," ",1107],"=",["T_WHITESPACE"," ",1107],["T_VARIABLE","$baseWeeeTax",1107],";",["T_WHITESPACE","\n                ",1107],"}",["T_WHITESPACE","\n\n                ",1108],["T_VARIABLE","$rowTax",1110],["T_WHITESPACE"," ",1110],"=",["T_WHITESPACE"," ",1110],["T_VARIABLE","$this",1110],["T_OBJECT_OPERATOR","->",1110],["T_STRING","_deltaRound",1110],"(",["T_VARIABLE","$rowTax",1110],",",["T_WHITESPACE"," ",1110],["T_VARIABLE","$rateKey",1110],",",["T_WHITESPACE"," ",1110],["T_VARIABLE","$inclTax",1110],")",";",["T_WHITESPACE","\n                ",1110],["T_VARIABLE","$baseRowTax",1111],["T_WHITESPACE"," ",1111],"=",["T_WHITESPACE"," ",1111],["T_VARIABLE","$this",1111],["T_OBJECT_OPERATOR","->",1111],["T_STRING","_deltaRound",1111],"(",["T_VARIABLE","$baseRowTax",1111],",",["T_WHITESPACE"," ",1111],["T_VARIABLE","$rateKey",1111],",",["T_WHITESPACE"," ",1111],["T_VARIABLE","$inclTax",1111],",",["T_WHITESPACE"," ",1111],["T_CONSTANT_ENCAPSED_STRING","'base'",1111],")",";",["T_WHITESPACE","\n\n                ",1111],["T_VARIABLE","$item",1113],["T_OBJECT_OPERATOR","->",1113],["T_STRING","setTaxAmount",1113],"(",["T_VARIABLE","$item",1113],["T_OBJECT_OPERATOR","->",1113],["T_STRING","getTaxAmount",1113],"(",")",["T_WHITESPACE"," ",1113],"+",["T_WHITESPACE"," ",1113],["T_STRING","max",1113],"(",["T_LNUMBER","0",1113],",",["T_WHITESPACE"," ",1113],["T_VARIABLE","$rowTax",1113],")",")",";",["T_WHITESPACE","\n                ",1113],["T_VARIABLE","$item",1114],["T_OBJECT_OPERATOR","->",1114],["T_STRING","setBaseTaxAmount",1114],"(",["T_VARIABLE","$item",1114],["T_OBJECT_OPERATOR","->",1114],["T_STRING","getBaseTaxAmount",1114],"(",")",["T_WHITESPACE"," ",1114],"+",["T_WHITESPACE"," ",1114],["T_STRING","max",1114],"(",["T_LNUMBER","0",1114],",",["T_WHITESPACE"," ",1114],["T_VARIABLE","$baseRowTax",1114],")",")",";",["T_WHITESPACE","\n\n                ",1114],["T_COMMENT","\/\/Calculate the Row taxes before discount\n",1116],["T_WHITESPACE","                ",1117],["T_VARIABLE","$rowTaxBeforeDiscount",1117],["T_WHITESPACE"," ",1117],"=",["T_WHITESPACE"," ",1117],["T_VARIABLE","$this",1117],["T_OBJECT_OPERATOR","->",1117],["T_STRING","_calculator",1117],["T_OBJECT_OPERATOR","->",1117],["T_STRING","calcTaxAmount",1117],"(",["T_WHITESPACE","\n                    ",1117],["T_VARIABLE","$subtotal",1118],",",["T_WHITESPACE","\n                    ",1118],["T_VARIABLE","$rate",1119],",",["T_WHITESPACE","\n                    ",1119],["T_VARIABLE","$inclTax",1120],",",["T_WHITESPACE","\n                    ",1120],["T_STRING","false",1121],["T_WHITESPACE","\n                ",1121],")",";",["T_WHITESPACE","\n                ",1122],["T_VARIABLE","$baseRowTaxBeforeDiscount",1123],["T_WHITESPACE"," ",1123],"=",["T_WHITESPACE"," ",1123],["T_VARIABLE","$this",1123],["T_OBJECT_OPERATOR","->",1123],["T_STRING","_calculator",1123],["T_OBJECT_OPERATOR","->",1123],["T_STRING","calcTaxAmount",1123],"(",["T_WHITESPACE","\n                    ",1123],["T_VARIABLE","$baseSubtotal",1124],",",["T_WHITESPACE","\n                    ",1124],["T_VARIABLE","$rate",1125],",",["T_WHITESPACE","\n                    ",1125],["T_VARIABLE","$inclTax",1126],",",["T_WHITESPACE","\n                    ",1126],["T_STRING","false",1127],["T_WHITESPACE","\n                ",1127],")",";",["T_WHITESPACE","\n\n\n                ",1128],["T_IF","if",1131],["T_WHITESPACE"," ",1131],"(",["T_VARIABLE","$isWeeeTaxable",1131],")",["T_WHITESPACE"," ",1131],"{",["T_WHITESPACE","\n                    ",1131],["T_VARIABLE","$weeeRowTaxBeforeDiscount",1132],["T_WHITESPACE"," ",1132],"=",["T_WHITESPACE"," ",1132],["T_VARIABLE","$this",1132],["T_OBJECT_OPERATOR","->",1132],["T_STRING","_calculateRowWeeeTax",1132],"(",["T_LNUMBER","0",1132],",",["T_WHITESPACE"," ",1132],["T_VARIABLE","$item",1132],",",["T_WHITESPACE"," ",1132],["T_VARIABLE","$rate",1132],",",["T_WHITESPACE"," ",1132],["T_STRING","false",1132],")",";",["T_WHITESPACE","\n                    ",1132],["T_VARIABLE","$rowTaxBeforeDiscount",1133],["T_WHITESPACE"," ",1133],["T_PLUS_EQUAL","+=",1133],["T_WHITESPACE"," ",1133],["T_VARIABLE","$weeeRowTaxBeforeDiscount",1133],";",["T_WHITESPACE","\n                    ",1133],["T_VARIABLE","$baseWeeeRowTaxBeforeDiscount",1134],["T_WHITESPACE"," ",1134],"=",["T_WHITESPACE"," ",1134],["T_VARIABLE","$this",1134],["T_OBJECT_OPERATOR","->",1134],["T_STRING","_calculateRowWeeeTax",1134],"(",["T_LNUMBER","0",1134],",",["T_WHITESPACE"," ",1134],["T_VARIABLE","$item",1134],",",["T_WHITESPACE"," ",1134],["T_VARIABLE","$rate",1134],")",";",["T_WHITESPACE","\n                    ",1134],["T_VARIABLE","$baseRowTaxBeforeDiscount",1135],["T_WHITESPACE"," ",1135],["T_PLUS_EQUAL","+=",1135],["T_WHITESPACE"," ",1135],["T_VARIABLE","$baseWeeeRowTaxBeforeDiscount",1135],";",["T_WHITESPACE","\n                ",1135],"}",["T_WHITESPACE","\n\n                ",1136],["T_VARIABLE","$taxBeforeDiscountRounded",1138],["T_WHITESPACE"," ",1138],"=",["T_WHITESPACE"," ",1138],["T_STRING","max",1138],"(",["T_WHITESPACE","\n                    ",1138],["T_LNUMBER","0",1139],",",["T_WHITESPACE","\n                    ",1139],["T_VARIABLE","$this",1140],["T_OBJECT_OPERATOR","->",1140],["T_STRING","_deltaRound",1140],"(",["T_VARIABLE","$rowTaxBeforeDiscount",1140],",",["T_WHITESPACE"," ",1140],["T_VARIABLE","$rateKey",1140],",",["T_WHITESPACE"," ",1140],["T_VARIABLE","$inclTax",1140],",",["T_WHITESPACE"," ",1140],["T_CONSTANT_ENCAPSED_STRING","'tax_before_discount'",1140],")",["T_WHITESPACE","\n                ",1140],")",";",["T_WHITESPACE","\n                ",1141],["T_VARIABLE","$baseTaxBeforeDiscountRounded",1142],["T_WHITESPACE"," ",1142],"=",["T_WHITESPACE"," ",1142],["T_STRING","max",1142],"(",["T_WHITESPACE","\n                    ",1142],["T_LNUMBER","0",1143],",",["T_WHITESPACE","\n                    ",1143],["T_VARIABLE","$this",1144],["T_OBJECT_OPERATOR","->",1144],["T_STRING","_deltaRound",1144],"(",["T_VARIABLE","$baseRowTaxBeforeDiscount",1144],",",["T_WHITESPACE"," ",1144],["T_VARIABLE","$rateKey",1144],",",["T_WHITESPACE"," ",1144],["T_VARIABLE","$inclTax",1144],",",["T_WHITESPACE"," ",1144],["T_CONSTANT_ENCAPSED_STRING","'tax_before_discount_base'",1144],")",["T_WHITESPACE","\n                ",1144],")",";",["T_WHITESPACE","\n\n                ",1145],["T_IF","if",1147],["T_WHITESPACE"," ",1147],"(","!",["T_VARIABLE","$item",1147],["T_OBJECT_OPERATOR","->",1147],["T_STRING","getNoDiscount",1147],"(",")",")",["T_WHITESPACE"," ",1147],"{",["T_WHITESPACE","\n                    ",1147],["T_IF","if",1148],["T_WHITESPACE"," ",1148],"(",["T_VARIABLE","$item",1148],["T_OBJECT_OPERATOR","->",1148],["T_STRING","getWeeeTaxApplied",1148],"(",")",")",["T_WHITESPACE"," ",1148],"{",["T_WHITESPACE","\n                        ",1148],["T_VARIABLE","$item",1149],["T_OBJECT_OPERATOR","->",1149],["T_STRING","setDiscountTaxCompensation",1149],"(",["T_VARIABLE","$item",1149],["T_OBJECT_OPERATOR","->",1149],["T_STRING","getDiscountTaxCompensation",1149],"(",")",["T_WHITESPACE"," ",1149],"+",["T_WHITESPACE","\n                        ",1149],["T_VARIABLE","$taxBeforeDiscountRounded",1150],["T_WHITESPACE"," ",1150],"-",["T_WHITESPACE"," ",1150],["T_STRING","max",1150],"(",["T_LNUMBER","0",1150],",",["T_WHITESPACE"," ",1150],["T_VARIABLE","$rowTax",1150],")",")",";",["T_WHITESPACE","\n                    ",1150],"}",["T_WHITESPACE","\n                ",1151],"}",["T_WHITESPACE","\n\n                ",1152],["T_IF","if",1154],["T_WHITESPACE"," ",1154],"(",["T_VARIABLE","$inclTax",1154],["T_WHITESPACE"," ",1154],["T_BOOLEAN_AND","&&",1154],["T_WHITESPACE"," ",1154],["T_VARIABLE","$discount",1154],["T_WHITESPACE"," ",1154],">",["T_WHITESPACE"," ",1154],["T_LNUMBER","0",1154],")",["T_WHITESPACE"," ",1154],"{",["T_WHITESPACE","\n                    ",1154],["T_VARIABLE","$roundedHiddenTax",1155],["T_WHITESPACE"," ",1155],"=",["T_WHITESPACE"," ",1155],["T_VARIABLE","$taxBeforeDiscountRounded",1155],["T_WHITESPACE"," ",1155],"-",["T_WHITESPACE"," ",1155],["T_STRING","max",1155],"(",["T_LNUMBER","0",1155],",",["T_WHITESPACE"," ",1155],["T_VARIABLE","$rowTax",1155],")",";",["T_WHITESPACE","\n                    ",1155],["T_VARIABLE","$baseRoundedHiddenTax",1156],["T_WHITESPACE"," ",1156],"=",["T_WHITESPACE"," ",1156],["T_VARIABLE","$baseTaxBeforeDiscountRounded",1156],["T_WHITESPACE"," ",1156],"-",["T_WHITESPACE"," ",1156],["T_STRING","max",1156],"(",["T_LNUMBER","0",1156],",",["T_WHITESPACE"," ",1156],["T_VARIABLE","$baseRowTax",1156],")",";",["T_WHITESPACE","\n                    ",1156],["T_VARIABLE","$this",1157],["T_OBJECT_OPERATOR","->",1157],["T_STRING","_hiddenTaxes",1157],"[","]",["T_WHITESPACE"," ",1157],"=",["T_WHITESPACE"," ",1157],["T_ARRAY","array",1157],"(",["T_WHITESPACE","\n                        ",1157],["T_CONSTANT_ENCAPSED_STRING","'rate_key'",1158],["T_WHITESPACE"," ",1158],["T_DOUBLE_ARROW","=>",1158],["T_WHITESPACE"," ",1158],["T_VARIABLE","$rateKey",1158],",",["T_WHITESPACE","\n                        ",1158],["T_CONSTANT_ENCAPSED_STRING","'qty'",1159],["T_WHITESPACE"," ",1159],["T_DOUBLE_ARROW","=>",1159],["T_WHITESPACE"," ",1159],["T_LNUMBER","1",1159],",",["T_WHITESPACE","\n                        ",1159],["T_CONSTANT_ENCAPSED_STRING","'item'",1160],["T_WHITESPACE"," ",1160],["T_DOUBLE_ARROW","=>",1160],["T_WHITESPACE"," ",1160],["T_VARIABLE","$item",1160],",",["T_WHITESPACE","\n                        ",1160],["T_CONSTANT_ENCAPSED_STRING","'value'",1161],["T_WHITESPACE"," ",1161],["T_DOUBLE_ARROW","=>",1161],["T_WHITESPACE"," ",1161],["T_VARIABLE","$roundedHiddenTax",1161],",",["T_WHITESPACE","\n                        ",1161],["T_CONSTANT_ENCAPSED_STRING","'base_value'",1162],["T_WHITESPACE"," ",1162],["T_DOUBLE_ARROW","=>",1162],["T_WHITESPACE"," ",1162],["T_VARIABLE","$baseRoundedHiddenTax",1162],",",["T_WHITESPACE","\n                        ",1162],["T_CONSTANT_ENCAPSED_STRING","'incl_tax'",1163],["T_WHITESPACE"," ",1163],["T_DOUBLE_ARROW","=>",1163],["T_WHITESPACE"," ",1163],["T_VARIABLE","$inclTax",1163],",",["T_WHITESPACE","\n                    ",1163],")",";",["T_WHITESPACE","\n                ",1164],"}",["T_WHITESPACE","\n                ",1165],["T_BREAK","break",1166],";",["T_WHITESPACE","\n        ",1166],"}",["T_WHITESPACE","\n\n        ",1167],["T_VARIABLE","$rowTotalInclTax",1169],["T_WHITESPACE"," ",1169],"=",["T_WHITESPACE"," ",1169],["T_VARIABLE","$item",1169],["T_OBJECT_OPERATOR","->",1169],["T_STRING","getRowTotalInclTax",1169],"(",")",";",["T_WHITESPACE","\n        ",1169],["T_IF","if",1170],["T_WHITESPACE"," ",1170],"(","!",["T_ISSET","isset",1170],"(",["T_VARIABLE","$rowTotalInclTax",1170],")",["T_WHITESPACE"," ",1170],["T_BOOLEAN_OR","||",1170],["T_WHITESPACE"," ",1170],["T_VARIABLE","$recalculateRowTotalInclTax",1170],")",["T_WHITESPACE"," ",1170],"{",["T_WHITESPACE","\n            ",1170],["T_IF","if",1171],["T_WHITESPACE"," ",1171],"(",["T_VARIABLE","$this",1171],["T_OBJECT_OPERATOR","->",1171],["T_STRING","_config",1171],["T_OBJECT_OPERATOR","->",1171],["T_STRING","priceIncludesTax",1171],"(",["T_VARIABLE","$this",1171],["T_OBJECT_OPERATOR","->",1171],["T_STRING","_store",1171],")",")",["T_WHITESPACE"," ",1171],"{",["T_WHITESPACE","\n                ",1171],["T_VARIABLE","$item",1172],["T_OBJECT_OPERATOR","->",1172],["T_STRING","setRowTotalInclTax",1172],"(",["T_VARIABLE","$subtotal",1172],")",";",["T_WHITESPACE","\n                ",1172],["T_VARIABLE","$item",1173],["T_OBJECT_OPERATOR","->",1173],["T_STRING","setBaseRowTotalInclTax",1173],"(",["T_VARIABLE","$baseSubtotal",1173],")",";",["T_WHITESPACE","\n            ",1173],"}",["T_WHITESPACE"," ",1174],["T_ELSE","else",1174],["T_WHITESPACE"," ",1174],"{",["T_WHITESPACE","\n                ",1174],["T_VARIABLE","$item",1175],["T_OBJECT_OPERATOR","->",1175],["T_STRING","setRowTotalInclTax",1175],"(",["T_WHITESPACE","\n                    ",1175],["T_VARIABLE","$item",1176],["T_OBJECT_OPERATOR","->",1176],["T_STRING","getRowTotalInclTax",1176],"(",")",["T_WHITESPACE"," ",1176],"+",["T_WHITESPACE"," ",1176],["T_VARIABLE","$taxBeforeDiscountRounded",1176],["T_WHITESPACE"," ",1176],"-",["T_WHITESPACE"," ",1176],["T_VARIABLE","$weeeRowTaxBeforeDiscount",1176],")",";",["T_WHITESPACE","\n                ",1176],["T_VARIABLE","$item",1177],["T_OBJECT_OPERATOR","->",1177],["T_STRING","setBaseRowTotalInclTax",1177],"(",["T_WHITESPACE","\n                    ",1177],["T_VARIABLE","$item",1178],["T_OBJECT_OPERATOR","->",1178],["T_STRING","getBaseRowTotalInclTax",1178],"(",")",["T_WHITESPACE","\n                    ",1178],"+",["T_WHITESPACE"," ",1179],["T_VARIABLE","$baseTaxBeforeDiscountRounded",1179],["T_WHITESPACE","\n                    ",1179],"-",["T_WHITESPACE"," ",1180],["T_VARIABLE","$baseWeeeRowTaxBeforeDiscount",1180],")",";",["T_WHITESPACE","\n            ",1180],"}",["T_WHITESPACE","\n        ",1181],"}",["T_WHITESPACE","\n\n        ",1182],["T_VARIABLE","$taxGroups",1184],"[",["T_VARIABLE","$rateKey",1184],"]","[",["T_CONSTANT_ENCAPSED_STRING","'totals'",1184],"]","[","]",["T_WHITESPACE"," ",1184],"=",["T_WHITESPACE"," ",1184],["T_STRING","max",1184],"(",["T_LNUMBER","0",1184],",",["T_WHITESPACE"," ",1184],["T_VARIABLE","$taxSubtotal",1184],")",";",["T_WHITESPACE","\n        ",1184],["T_VARIABLE","$taxGroups",1185],"[",["T_VARIABLE","$rateKey",1185],"]","[",["T_CONSTANT_ENCAPSED_STRING","'base_totals'",1185],"]","[","]",["T_WHITESPACE"," ",1185],"=",["T_WHITESPACE"," ",1185],["T_STRING","max",1185],"(",["T_LNUMBER","0",1185],",",["T_WHITESPACE"," ",1185],["T_VARIABLE","$baseTaxSubtotal",1185],")",";",["T_WHITESPACE","\n        ",1185],["T_VARIABLE","$taxGroups",1186],"[",["T_VARIABLE","$rateKey",1186],"]","[",["T_CONSTANT_ENCAPSED_STRING","'tax'",1186],"]","[","]",["T_WHITESPACE"," ",1186],"=",["T_WHITESPACE"," ",1186],["T_STRING","max",1186],"(",["T_LNUMBER","0",1186],",",["T_WHITESPACE"," ",1186],["T_VARIABLE","$rowTax",1186],")",";",["T_WHITESPACE","\n        ",1186],["T_VARIABLE","$taxGroups",1187],"[",["T_VARIABLE","$rateKey",1187],"]","[",["T_CONSTANT_ENCAPSED_STRING","'base_tax'",1187],"]","[","]",["T_WHITESPACE"," ",1187],"=",["T_WHITESPACE"," ",1187],["T_STRING","max",1187],"(",["T_LNUMBER","0",1187],",",["T_WHITESPACE"," ",1187],["T_VARIABLE","$baseRowTax",1187],")",";",["T_WHITESPACE","\n        ",1187],["T_RETURN","return",1188],["T_WHITESPACE"," ",1188],["T_VARIABLE","$this",1188],";",["T_WHITESPACE","\n    ",1188],"}",["T_WHITESPACE","\n\n    ",1189],["T_DOC_COMMENT","\/**\n     * Calculates the weeeAmountInclTax for display purpose\n     *\n     * @param Mage_Sales_Model_Quote_Item_Abstract $item\n     * @param array $appliedRates\n     * @param bool $base\n     *\/",1191],["T_WHITESPACE","\n    ",1197],["T_PROTECTED","protected",1198],["T_WHITESPACE"," ",1198],["T_FUNCTION","function",1198],["T_WHITESPACE"," ",1198],["T_STRING","_calculateWeeeAmountInclTax",1198],"(",["T_VARIABLE","$item",1198],",",["T_WHITESPACE"," ",1198],["T_VARIABLE","$appliedRates",1198],",",["T_WHITESPACE"," ",1198],["T_VARIABLE","$base",1198],["T_WHITESPACE"," ",1198],"=",["T_WHITESPACE"," ",1198],["T_STRING","true",1198],")",["T_WHITESPACE","\n    ",1198],"{",["T_WHITESPACE","\n        ",1199],["T_FOREACH","foreach",1200],["T_WHITESPACE"," ",1200],"(",["T_VARIABLE","$this",1200],["T_OBJECT_OPERATOR","->",1200],["T_STRING","_weeeHelper",1200],["T_OBJECT_OPERATOR","->",1200],["T_STRING","getApplied",1200],"(",["T_VARIABLE","$item",1200],")",["T_WHITESPACE"," ",1200],["T_AS","as",1200],["T_WHITESPACE"," ",1200],["T_VARIABLE","$tax",1200],")",["T_WHITESPACE"," ",1200],"{",["T_WHITESPACE","\n            ",1200],["T_VARIABLE","$weeeAmountInclTax",1201],["T_WHITESPACE"," ",1201],"=",["T_WHITESPACE"," ",1201],["T_LNUMBER","0",1201],";",["T_WHITESPACE","\n            ",1201],["T_VARIABLE","$weeeAmountExclTax",1202],["T_WHITESPACE"," ",1202],"=",["T_WHITESPACE"," ",1202],["T_LNUMBER","0",1202],";",["T_WHITESPACE","\n\n            ",1202],["T_IF","if",1204],["T_WHITESPACE"," ",1204],"(",["T_VARIABLE","$base",1204],")",["T_WHITESPACE"," ",1204],"{",["T_WHITESPACE","\n                ",1204],["T_VARIABLE","$weeeAmountInclTax",1205],["T_WHITESPACE"," ",1205],"=",["T_WHITESPACE"," ",1205],["T_ISSET","isset",1205],"(",["T_VARIABLE","$tax",1205],"[",["T_CONSTANT_ENCAPSED_STRING","'base_amount_incl_tax'",1205],"]",")",["T_WHITESPACE"," ",1205],"?",["T_WHITESPACE"," ",1205],["T_VARIABLE","$tax",1205],"[",["T_CONSTANT_ENCAPSED_STRING","'base_amount_incl_tax'",1205],"]",["T_WHITESPACE"," ",1205],":",["T_WHITESPACE"," ",1205],["T_LNUMBER","0",1205],";",["T_WHITESPACE","\n                ",1205],["T_VARIABLE","$weeeAmountExclTax",1206],["T_WHITESPACE"," ",1206],"=",["T_WHITESPACE"," ",1206],["T_ISSET","isset",1206],"(",["T_VARIABLE","$tax",1206],"[",["T_CONSTANT_ENCAPSED_STRING","'base_amount'",1206],"]",")",["T_WHITESPACE"," ",1206],"?",["T_WHITESPACE"," ",1206],["T_VARIABLE","$tax",1206],"[",["T_CONSTANT_ENCAPSED_STRING","'base_amount'",1206],"]",["T_WHITESPACE"," ",1206],":",["T_WHITESPACE"," ",1206],["T_LNUMBER","0",1206],";",["T_WHITESPACE","\n                ",1206],["T_VARIABLE","$weeeRowAmountInclTax",1207],["T_WHITESPACE"," ",1207],"=",["T_WHITESPACE"," ",1207],["T_ISSET","isset",1207],"(",["T_VARIABLE","$tax",1207],"[",["T_CONSTANT_ENCAPSED_STRING","'base_row_amount_incl_tax'",1207],"]",")",["T_WHITESPACE"," ",1207],"?",["T_WHITESPACE"," ",1207],["T_VARIABLE","$tax",1207],"[",["T_CONSTANT_ENCAPSED_STRING","'base_row_amount_incl_tax'",1207],"]",["T_WHITESPACE"," ",1207],":",["T_WHITESPACE"," ",1207],["T_LNUMBER","0",1207],";",["T_WHITESPACE","\n                ",1207],["T_VARIABLE","$weeeRowAmountExclTax",1208],["T_WHITESPACE"," ",1208],"=",["T_WHITESPACE"," ",1208],["T_ISSET","isset",1208],"(",["T_VARIABLE","$tax",1208],"[",["T_CONSTANT_ENCAPSED_STRING","'base_row_amount'",1208],"]",")",["T_WHITESPACE"," ",1208],"?",["T_WHITESPACE"," ",1208],["T_VARIABLE","$tax",1208],"[",["T_CONSTANT_ENCAPSED_STRING","'base_row_amount'",1208],"]",["T_WHITESPACE"," ",1208],":",["T_WHITESPACE"," ",1208],["T_LNUMBER","0",1208],";",["T_WHITESPACE","\n            ",1208],"}",["T_WHITESPACE"," ",1209],["T_ELSE","else",1209],["T_WHITESPACE"," ",1209],"{",["T_WHITESPACE","\n                ",1209],["T_VARIABLE","$weeeAmountInclTax",1210],["T_WHITESPACE"," ",1210],"=",["T_WHITESPACE"," ",1210],["T_ISSET","isset",1210],"(",["T_VARIABLE","$tax",1210],"[",["T_CONSTANT_ENCAPSED_STRING","'amount_incl_tax'",1210],"]",")",["T_WHITESPACE"," ",1210],"?",["T_WHITESPACE"," ",1210],["T_VARIABLE","$tax",1210],"[",["T_CONSTANT_ENCAPSED_STRING","'amount_incl_tax'",1210],"]",["T_WHITESPACE"," ",1210],":",["T_WHITESPACE"," ",1210],["T_LNUMBER","0",1210],";",["T_WHITESPACE","\n                ",1210],["T_VARIABLE","$weeeAmountExclTax",1211],["T_WHITESPACE"," ",1211],"=",["T_WHITESPACE"," ",1211],["T_ISSET","isset",1211],"(",["T_VARIABLE","$tax",1211],"[",["T_CONSTANT_ENCAPSED_STRING","'amount'",1211],"]",")",["T_WHITESPACE"," ",1211],"?",["T_WHITESPACE"," ",1211],["T_VARIABLE","$tax",1211],"[",["T_CONSTANT_ENCAPSED_STRING","'amount'",1211],"]",["T_WHITESPACE"," ",1211],":",["T_WHITESPACE"," ",1211],["T_LNUMBER","0",1211],";",["T_WHITESPACE","\n                ",1211],["T_VARIABLE","$weeeRowAmountInclTax",1212],["T_WHITESPACE"," ",1212],"=",["T_WHITESPACE"," ",1212],["T_ISSET","isset",1212],"(",["T_VARIABLE","$tax",1212],"[",["T_CONSTANT_ENCAPSED_STRING","'row_amount_incl_tax'",1212],"]",")",["T_WHITESPACE"," ",1212],"?",["T_WHITESPACE"," ",1212],["T_VARIABLE","$tax",1212],"[",["T_CONSTANT_ENCAPSED_STRING","'row_amount_incl_tax'",1212],"]",["T_WHITESPACE"," ",1212],":",["T_WHITESPACE"," ",1212],["T_LNUMBER","0",1212],";",["T_WHITESPACE","\n                ",1212],["T_VARIABLE","$weeeRowAmountExclTax",1213],["T_WHITESPACE"," ",1213],"=",["T_WHITESPACE"," ",1213],["T_ISSET","isset",1213],"(",["T_VARIABLE","$tax",1213],"[",["T_CONSTANT_ENCAPSED_STRING","'row_amount'",1213],"]",")",["T_WHITESPACE"," ",1213],"?",["T_WHITESPACE"," ",1213],["T_VARIABLE","$tax",1213],"[",["T_CONSTANT_ENCAPSED_STRING","'row_amount'",1213],"]",["T_WHITESPACE"," ",1213],":",["T_WHITESPACE"," ",1213],["T_LNUMBER","0",1213],";",["T_WHITESPACE","\n            ",1213],"}",["T_WHITESPACE","\n\n            ",1214],["T_VARIABLE","$weeeTax",1216],["T_WHITESPACE"," ",1216],"=",["T_WHITESPACE"," ",1216],["T_ARRAY","array",1216],"(",")",";",["T_WHITESPACE","\n            ",1216],["T_VARIABLE","$weeeRowTax",1217],["T_WHITESPACE"," ",1217],"=",["T_WHITESPACE"," ",1217],["T_ARRAY","array",1217],"(",")",";",["T_WHITESPACE","\n            ",1217],["T_FOREACH","foreach",1218],["T_WHITESPACE"," ",1218],"(",["T_VARIABLE","$appliedRates",1218],["T_WHITESPACE"," ",1218],["T_AS","as",1218],["T_WHITESPACE"," ",1218],["T_VARIABLE","$appliedRate",1218],")",["T_WHITESPACE"," ",1218],"{",["T_WHITESPACE","\n                ",1218],["T_VARIABLE","$rate",1219],["T_WHITESPACE"," ",1219],"=",["T_WHITESPACE"," ",1219],["T_VARIABLE","$appliedRate",1219],"[",["T_CONSTANT_ENCAPSED_STRING","'percent'",1219],"]",";",["T_WHITESPACE","\n                ",1219],["T_VARIABLE","$weeeTax",1220],"[","]",["T_WHITESPACE"," ",1220],"=",["T_WHITESPACE"," ",1220],["T_VARIABLE","$this",1220],["T_OBJECT_OPERATOR","->",1220],["T_STRING","_getWeeeTax",1220],"(",["T_VARIABLE","$rate",1220],",",["T_WHITESPACE"," ",1220],["T_VARIABLE","$item",1220],",",["T_WHITESPACE"," ",1220],["T_LNUMBER","0",1220],",",["T_WHITESPACE"," ",1220],["T_VARIABLE","$weeeAmountInclTax",1220],",",["T_WHITESPACE"," ",1220],["T_VARIABLE","$weeeAmountExclTax",1220],")",";",["T_WHITESPACE","\n                ",1220],["T_VARIABLE","$weeeRowTax",1221],"[","]",["T_WHITESPACE"," ",1221],"=",["T_WHITESPACE"," ",1221],["T_VARIABLE","$this",1221],["T_OBJECT_OPERATOR","->",1221],["T_STRING","_getWeeeTax",1221],"(",["T_VARIABLE","$rate",1221],",",["T_WHITESPACE"," ",1221],["T_VARIABLE","$item",1221],",",["T_WHITESPACE"," ",1221],["T_LNUMBER","0",1221],",",["T_WHITESPACE"," ",1221],["T_VARIABLE","$weeeRowAmountInclTax",1221],",",["T_WHITESPACE"," ",1221],["T_VARIABLE","$weeeRowAmountExclTax",1221],")",";",["T_WHITESPACE","\n            ",1221],"}",["T_WHITESPACE","\n\n            ",1222],["T_COMMENT","\/\/We want to update the tax calculated on Weee to the Item with out discount for display purpose\n",1224],["T_WHITESPACE","            ",1225],["T_VARIABLE","$weeeAmountInclTax",1225],["T_WHITESPACE"," ",1225],"=",["T_WHITESPACE"," ",1225],["T_STRING","array_sum",1225],"(",["T_VARIABLE","$weeeTax",1225],")",["T_WHITESPACE"," ",1225],"+",["T_WHITESPACE"," ",1225],["T_VARIABLE","$weeeAmountExclTax",1225],";",["T_WHITESPACE","\n            ",1225],["T_VARIABLE","$weeeRowAmountInclTax",1226],["T_WHITESPACE"," ",1226],"=",["T_WHITESPACE"," ",1226],["T_STRING","array_sum",1226],"(",["T_VARIABLE","$weeeRowTax",1226],")",["T_WHITESPACE"," ",1226],"+",["T_WHITESPACE"," ",1226],["T_VARIABLE","$weeeRowAmountExclTax",1226],";",["T_WHITESPACE","\n            ",1226],["T_VARIABLE","$calculationMethod",1227],["T_WHITESPACE"," ",1227],"=",["T_WHITESPACE"," ",1227],["T_VARIABLE","$this",1227],["T_OBJECT_OPERATOR","->",1227],["T_STRING","_config",1227],["T_OBJECT_OPERATOR","->",1227],["T_STRING","getAlgorithm",1227],"(",["T_VARIABLE","$this",1227],["T_OBJECT_OPERATOR","->",1227],["T_STRING","_store",1227],")",";",["T_WHITESPACE","\n            ",1227],["T_IF","if",1228],["T_WHITESPACE"," ",1228],"(",["T_VARIABLE","$calculationMethod",1228],["T_WHITESPACE"," ",1228],["T_IS_EQUAL","==",1228],["T_WHITESPACE"," ",1228],["T_STRING","Mage_Tax_Model_Calculation",1228],["T_DOUBLE_COLON","::",1228],["T_STRING","CALC_UNIT_BASE",1228],")",["T_WHITESPACE"," ",1228],"{",["T_WHITESPACE","\n                ",1228],["T_VARIABLE","$weeeRowAmountInclTax",1229],["T_WHITESPACE"," ",1229],"=",["T_WHITESPACE"," ",1229],["T_VARIABLE","$this",1229],["T_OBJECT_OPERATOR","->",1229],["T_STRING","_calculator",1229],["T_OBJECT_OPERATOR","->",1229],["T_STRING","round",1229],"(",["T_VARIABLE","$weeeAmountInclTax",1229],["T_WHITESPACE"," ",1229],"*",["T_WHITESPACE"," ",1229],["T_VARIABLE","$item",1229],["T_OBJECT_OPERATOR","->",1229],["T_STRING","getQty",1229],"(",")",")",";",["T_WHITESPACE","\n            ",1229],"}",["T_WHITESPACE"," ",1230],["T_ELSE","else",1230],["T_WHITESPACE"," ",1230],"{",["T_WHITESPACE","\n                ",1230],["T_VARIABLE","$weeeAmountInclTax",1231],["T_WHITESPACE"," ",1231],"=",["T_WHITESPACE"," ",1231],["T_VARIABLE","$this",1231],["T_OBJECT_OPERATOR","->",1231],["T_STRING","_calculator",1231],["T_OBJECT_OPERATOR","->",1231],["T_STRING","round",1231],"(",["T_VARIABLE","$weeeRowAmountInclTax",1231],["T_WHITESPACE"," ",1231],"\/",["T_WHITESPACE"," ",1231],["T_VARIABLE","$item",1231],["T_OBJECT_OPERATOR","->",1231],["T_STRING","getQty",1231],"(",")",")",";",["T_WHITESPACE","\n            ",1231],"}",["T_WHITESPACE","\n            ",1232],["T_IF","if",1233],["T_WHITESPACE"," ",1233],"(",["T_VARIABLE","$base",1233],")",["T_WHITESPACE"," ",1233],"{",["T_WHITESPACE","\n                ",1233],["T_VARIABLE","$this",1234],["T_OBJECT_OPERATOR","->",1234],["T_STRING","_weeeHelper",1234],["T_OBJECT_OPERATOR","->",1234],["T_STRING","setWeeeTaxesAppliedProperty",1234],"(",["T_VARIABLE","$item",1234],",",["T_WHITESPACE"," ",1234],["T_VARIABLE","$tax",1234],"[",["T_CONSTANT_ENCAPSED_STRING","'title'",1234],"]",",",["T_WHITESPACE","\n                    ",1234],["T_CONSTANT_ENCAPSED_STRING","'base_amount_incl_tax'",1235],",",["T_WHITESPACE"," ",1235],["T_VARIABLE","$weeeAmountInclTax",1235],")",";",["T_WHITESPACE","\n                ",1235],["T_VARIABLE","$this",1236],["T_OBJECT_OPERATOR","->",1236],["T_STRING","_weeeHelper",1236],["T_OBJECT_OPERATOR","->",1236],["T_STRING","setWeeeTaxesAppliedProperty",1236],"(",["T_VARIABLE","$item",1236],",",["T_WHITESPACE"," ",1236],["T_VARIABLE","$tax",1236],"[",["T_CONSTANT_ENCAPSED_STRING","'title'",1236],"]",",",["T_WHITESPACE","\n                    ",1236],["T_CONSTANT_ENCAPSED_STRING","'base_row_amount_incl_tax'",1237],",",["T_WHITESPACE"," ",1237],["T_VARIABLE","$weeeRowAmountInclTax",1237],")",";",["T_WHITESPACE","\n            ",1237],"}",["T_WHITESPACE"," ",1238],["T_ELSE","else",1238],["T_WHITESPACE"," ",1238],"{",["T_WHITESPACE","\n                ",1238],["T_VARIABLE","$this",1239],["T_OBJECT_OPERATOR","->",1239],["T_STRING","_weeeHelper",1239],["T_OBJECT_OPERATOR","->",1239],["T_STRING","setWeeeTaxesAppliedProperty",1239],"(",["T_VARIABLE","$item",1239],",",["T_WHITESPACE"," ",1239],["T_VARIABLE","$tax",1239],"[",["T_CONSTANT_ENCAPSED_STRING","'title'",1239],"]",",",["T_WHITESPACE","\n                    ",1239],["T_CONSTANT_ENCAPSED_STRING","'amount_incl_tax'",1240],",",["T_WHITESPACE"," ",1240],["T_VARIABLE","$weeeAmountInclTax",1240],")",";",["T_WHITESPACE","\n                ",1240],["T_VARIABLE","$this",1241],["T_OBJECT_OPERATOR","->",1241],["T_STRING","_weeeHelper",1241],["T_OBJECT_OPERATOR","->",1241],["T_STRING","setWeeeTaxesAppliedProperty",1241],"(",["T_VARIABLE","$item",1241],",",["T_WHITESPACE"," ",1241],["T_VARIABLE","$tax",1241],"[",["T_CONSTANT_ENCAPSED_STRING","'title'",1241],"]",",",["T_WHITESPACE","\n                    ",1241],["T_CONSTANT_ENCAPSED_STRING","'row_amount_incl_tax'",1242],",",["T_WHITESPACE"," ",1242],["T_VARIABLE","$weeeRowAmountInclTax",1242],")",";",["T_WHITESPACE","\n            ",1242],"}",["T_WHITESPACE","\n        ",1243],"}",["T_WHITESPACE","\n        ",1244],["T_RETURN","return",1245],";",["T_WHITESPACE","\n    ",1245],"}",["T_WHITESPACE","\n\n    ",1246],["T_DOC_COMMENT","\/**\n     * Calculates the weee tax based on the customer tax rate and discount\n     *\n     * @param float $discountAmount\n     * @param Mage_Sales_Model_Quote_Item_Abstract $item\n     * @param float $rate\n     * @param bool $base\n     * @return float\n     *\/",1248],["T_WHITESPACE","\n    ",1256],["T_PROTECTED","protected",1257],["T_WHITESPACE"," ",1257],["T_FUNCTION","function",1257],["T_WHITESPACE"," ",1257],["T_STRING","_calculateWeeeTax",1257],"(",["T_VARIABLE","$discountAmount",1257],",",["T_WHITESPACE"," ",1257],["T_VARIABLE","$item",1257],",",["T_WHITESPACE"," ",1257],["T_VARIABLE","$rate",1257],",",["T_WHITESPACE"," ",1257],["T_VARIABLE","$base",1257],["T_WHITESPACE"," ",1257],"=",["T_WHITESPACE"," ",1257],["T_STRING","true",1257],")",["T_WHITESPACE","\n    ",1257],"{",["T_WHITESPACE","\n        ",1258],["T_VARIABLE","$totalWeeeAmountInclTax",1259],["T_WHITESPACE"," ",1259],"=",["T_WHITESPACE"," ",1259],["T_LNUMBER","0",1259],";",["T_WHITESPACE","\n        ",1259],["T_VARIABLE","$totalWeeeAmountExclTax",1260],["T_WHITESPACE"," ",1260],"=",["T_WHITESPACE"," ",1260],["T_LNUMBER","0",1260],";",["T_WHITESPACE","\n\n        ",1260],["T_FOREACH","foreach",1262],["T_WHITESPACE"," ",1262],"(",["T_VARIABLE","$this",1262],["T_OBJECT_OPERATOR","->",1262],["T_STRING","_weeeHelper",1262],["T_OBJECT_OPERATOR","->",1262],["T_STRING","getApplied",1262],"(",["T_VARIABLE","$item",1262],")",["T_WHITESPACE"," ",1262],["T_AS","as",1262],["T_WHITESPACE"," ",1262],["T_VARIABLE","$tax",1262],")",["T_WHITESPACE"," ",1262],"{",["T_WHITESPACE","\n            ",1262],["T_VARIABLE","$weeeAmountInclTax",1263],["T_WHITESPACE"," ",1263],"=",["T_WHITESPACE"," ",1263],["T_LNUMBER","0",1263],";",["T_WHITESPACE","\n            ",1263],["T_VARIABLE","$weeeAmountExclTax",1264],["T_WHITESPACE"," ",1264],"=",["T_WHITESPACE"," ",1264],["T_LNUMBER","0",1264],";",["T_WHITESPACE","\n\n            ",1264],["T_IF","if",1266],["T_WHITESPACE"," ",1266],"(",["T_VARIABLE","$base",1266],")",["T_WHITESPACE"," ",1266],"{",["T_WHITESPACE","\n                ",1266],["T_VARIABLE","$weeeAmountInclTax",1267],["T_WHITESPACE"," ",1267],"=",["T_WHITESPACE"," ",1267],["T_ISSET","isset",1267],"(",["T_VARIABLE","$tax",1267],"[",["T_CONSTANT_ENCAPSED_STRING","'base_amount_incl_tax'",1267],"]",")",["T_WHITESPACE"," ",1267],"?",["T_WHITESPACE"," ",1267],["T_VARIABLE","$tax",1267],"[",["T_CONSTANT_ENCAPSED_STRING","'base_amount_incl_tax'",1267],"]",["T_WHITESPACE"," ",1267],":",["T_WHITESPACE"," ",1267],["T_LNUMBER","0",1267],";",["T_WHITESPACE","\n                ",1267],["T_VARIABLE","$weeeAmountExclTax",1268],["T_WHITESPACE"," ",1268],"=",["T_WHITESPACE"," ",1268],["T_ISSET","isset",1268],"(",["T_VARIABLE","$tax",1268],"[",["T_CONSTANT_ENCAPSED_STRING","'base_amount'",1268],"]",")",["T_WHITESPACE"," ",1268],"?",["T_WHITESPACE"," ",1268],["T_VARIABLE","$tax",1268],"[",["T_CONSTANT_ENCAPSED_STRING","'base_amount'",1268],"]",["T_WHITESPACE"," ",1268],":",["T_WHITESPACE"," ",1268],["T_LNUMBER","0",1268],";",["T_WHITESPACE","\n            ",1268],"}",["T_WHITESPACE"," ",1269],["T_ELSE","else",1269],["T_WHITESPACE"," ",1269],"{",["T_WHITESPACE","\n                ",1269],["T_VARIABLE","$weeeAmountInclTax",1270],["T_WHITESPACE"," ",1270],"=",["T_WHITESPACE"," ",1270],["T_ISSET","isset",1270],"(",["T_VARIABLE","$tax",1270],"[",["T_CONSTANT_ENCAPSED_STRING","'amount_incl_tax'",1270],"]",")",["T_WHITESPACE"," ",1270],"?",["T_WHITESPACE"," ",1270],["T_VARIABLE","$tax",1270],"[",["T_CONSTANT_ENCAPSED_STRING","'amount_incl_tax'",1270],"]",["T_WHITESPACE"," ",1270],":",["T_WHITESPACE"," ",1270],["T_LNUMBER","0",1270],";",["T_WHITESPACE","\n                ",1270],["T_VARIABLE","$weeeAmountExclTax",1271],["T_WHITESPACE"," ",1271],"=",["T_WHITESPACE"," ",1271],["T_ISSET","isset",1271],"(",["T_VARIABLE","$tax",1271],"[",["T_CONSTANT_ENCAPSED_STRING","'amount'",1271],"]",")",["T_WHITESPACE"," ",1271],"?",["T_WHITESPACE"," ",1271],["T_VARIABLE","$tax",1271],"[",["T_CONSTANT_ENCAPSED_STRING","'amount'",1271],"]",["T_WHITESPACE"," ",1271],":",["T_WHITESPACE"," ",1271],["T_LNUMBER","0",1271],";",["T_WHITESPACE","\n            ",1271],"}",["T_WHITESPACE","\n\n            ",1272],["T_VARIABLE","$weeeTaxWithOutDiscount",1274],["T_WHITESPACE"," ",1274],"=",["T_WHITESPACE"," ",1274],["T_VARIABLE","$this",1274],["T_OBJECT_OPERATOR","->",1274],["T_STRING","_getWeeeTax",1274],"(",["T_VARIABLE","$rate",1274],",",["T_WHITESPACE"," ",1274],["T_VARIABLE","$item",1274],",",["T_WHITESPACE"," ",1274],["T_LNUMBER","0",1274],",",["T_WHITESPACE"," ",1274],["T_VARIABLE","$weeeAmountInclTax",1274],",",["T_WHITESPACE"," ",1274],["T_VARIABLE","$weeeAmountExclTax",1274],")",";",["T_WHITESPACE","\n\n            ",1274],["T_COMMENT","\/\/We want to update the tax calculated on Weee to the Item with out discount for display purpose\n",1276],["T_WHITESPACE","            ",1277],["T_VARIABLE","$weeeAmountInclTax",1277],["T_WHITESPACE"," ",1277],"=",["T_WHITESPACE"," ",1277],["T_VARIABLE","$weeeTaxWithOutDiscount",1277],["T_WHITESPACE"," ",1277],"+",["T_WHITESPACE"," ",1277],["T_VARIABLE","$weeeAmountExclTax",1277],";",["T_WHITESPACE","\n            ",1277],["T_IF","if",1278],["T_WHITESPACE"," ",1278],"(",["T_VARIABLE","$base",1278],")",["T_WHITESPACE"," ",1278],"{",["T_WHITESPACE","\n                ",1278],["T_VARIABLE","$this",1279],["T_OBJECT_OPERATOR","->",1279],["T_STRING","_weeeHelper",1279],["T_OBJECT_OPERATOR","->",1279],["T_STRING","setWeeeTaxesAppliedProperty",1279],"(",["T_VARIABLE","$item",1279],",",["T_WHITESPACE"," ",1279],["T_VARIABLE","$tax",1279],"[",["T_CONSTANT_ENCAPSED_STRING","'title'",1279],"]",",",["T_WHITESPACE","\n                    ",1279],["T_CONSTANT_ENCAPSED_STRING","'base_amount_incl_tax'",1280],",",["T_WHITESPACE"," ",1280],["T_VARIABLE","$weeeAmountInclTax",1280],")",";",["T_WHITESPACE","\n            ",1280],"}",["T_WHITESPACE"," ",1281],["T_ELSE","else",1281],["T_WHITESPACE"," ",1281],"{",["T_WHITESPACE","\n                ",1281],["T_VARIABLE","$this",1282],["T_OBJECT_OPERATOR","->",1282],["T_STRING","_weeeHelper",1282],["T_OBJECT_OPERATOR","->",1282],["T_STRING","setWeeeTaxesAppliedProperty",1282],"(",["T_VARIABLE","$item",1282],",",["T_WHITESPACE"," ",1282],["T_VARIABLE","$tax",1282],"[",["T_CONSTANT_ENCAPSED_STRING","'title'",1282],"]",",",["T_WHITESPACE","\n                    ",1282],["T_CONSTANT_ENCAPSED_STRING","'amount_incl_tax'",1283],",",["T_WHITESPACE"," ",1283],["T_VARIABLE","$weeeAmountInclTax",1283],")",";",["T_WHITESPACE","\n            ",1283],"}",["T_WHITESPACE","\n\n            ",1284],["T_VARIABLE","$totalWeeeAmountInclTax",1286],["T_WHITESPACE"," ",1286],["T_PLUS_EQUAL","+=",1286],["T_WHITESPACE"," ",1286],["T_VARIABLE","$weeeAmountInclTax",1286],";",["T_WHITESPACE","\n            ",1286],["T_VARIABLE","$totalWeeeAmountExclTax",1287],["T_WHITESPACE"," ",1287],["T_PLUS_EQUAL","+=",1287],["T_WHITESPACE"," ",1287],["T_VARIABLE","$weeeAmountExclTax",1287],";",["T_WHITESPACE","\n\n\n        ",1287],"}",["T_WHITESPACE","\n        ",1290],["T_RETURN","return",1291],["T_WHITESPACE"," ",1291],["T_VARIABLE","$this",1291],["T_OBJECT_OPERATOR","->",1291],["T_STRING","_getWeeeTax",1291],"(",["T_VARIABLE","$rate",1291],",",["T_WHITESPACE"," ",1291],["T_VARIABLE","$item",1291],",",["T_WHITESPACE"," ",1291],["T_VARIABLE","$discountAmount",1291],",",["T_WHITESPACE"," ",1291],["T_VARIABLE","$totalWeeeAmountInclTax",1291],",",["T_WHITESPACE"," ",1291],["T_VARIABLE","$totalWeeeAmountExclTax",1291],")",";",["T_WHITESPACE","\n    ",1291],"}",["T_WHITESPACE","\n\n\n    ",1292],["T_DOC_COMMENT","\/**\n     * Calculates and updates the wee tax based on the customer tax rate and discount for Row\n     *\n     * @param float $discountAmount\n     * @param Mage_Sales_Model_Quote_Item_Abstract $item\n     * @param float $rate\n     * @param bool $base\n     * @return int\n     *\/",1295],["T_WHITESPACE","\n    ",1303],["T_PROTECTED","protected",1304],["T_WHITESPACE"," ",1304],["T_FUNCTION","function",1304],["T_WHITESPACE"," ",1304],["T_STRING","_calculateRowWeeeTax",1304],"(",["T_VARIABLE","$discountAmount",1304],",",["T_WHITESPACE"," ",1304],["T_VARIABLE","$item",1304],",",["T_WHITESPACE"," ",1304],["T_VARIABLE","$rate",1304],",",["T_WHITESPACE"," ",1304],["T_VARIABLE","$base",1304],["T_WHITESPACE"," ",1304],"=",["T_WHITESPACE"," ",1304],["T_STRING","true",1304],")",["T_WHITESPACE","\n    ",1304],"{",["T_WHITESPACE","\n        ",1305],["T_COMMENT","\/\/We want to update the weee tax for the unit too. discount amount set on the item is by row\n",1306],["T_WHITESPACE","        ",1307],["T_VARIABLE","$discountAmountByUnit",1307],["T_WHITESPACE"," ",1307],"=",["T_WHITESPACE"," ",1307],["T_VARIABLE","$discountAmount",1307],["T_WHITESPACE"," ",1307],"\/",["T_WHITESPACE"," ",1307],"(",["T_VARIABLE","$item",1307],["T_OBJECT_OPERATOR","->",1307],["T_STRING","getTotalQty",1307],"(",")",["T_WHITESPACE"," ",1307],"?",["T_WHITESPACE"," ",1307],["T_VARIABLE","$item",1307],["T_OBJECT_OPERATOR","->",1307],["T_STRING","getTotalQty",1307],"(",")",["T_WHITESPACE"," ",1307],":",["T_WHITESPACE"," ",1307],["T_LNUMBER","1",1307],")",";",["T_WHITESPACE","\n        ",1307],["T_VARIABLE","$this",1308],["T_OBJECT_OPERATOR","->",1308],["T_STRING","_calculateWeeeTax",1308],"(",["T_VARIABLE","$discountAmountByUnit",1308],",",["T_WHITESPACE"," ",1308],["T_VARIABLE","$item",1308],",",["T_WHITESPACE"," ",1308],["T_VARIABLE","$rate",1308],",",["T_WHITESPACE"," ",1308],["T_VARIABLE","$base",1308],")",";",["T_WHITESPACE","\n\n\n        ",1308],["T_VARIABLE","$totalWeeeAmountInclTax",1311],["T_WHITESPACE"," ",1311],"=",["T_WHITESPACE"," ",1311],["T_LNUMBER","0",1311],";",["T_WHITESPACE","\n        ",1311],["T_VARIABLE","$totalWeeeAmountExclTax",1312],["T_WHITESPACE"," ",1312],"=",["T_WHITESPACE"," ",1312],["T_LNUMBER","0",1312],";",["T_WHITESPACE","\n\n        ",1312],["T_FOREACH","foreach",1314],["T_WHITESPACE"," ",1314],"(",["T_VARIABLE","$this",1314],["T_OBJECT_OPERATOR","->",1314],["T_STRING","_weeeHelper",1314],["T_OBJECT_OPERATOR","->",1314],["T_STRING","getApplied",1314],"(",["T_VARIABLE","$item",1314],")",["T_WHITESPACE"," ",1314],["T_AS","as",1314],["T_WHITESPACE"," ",1314],["T_VARIABLE","$tax",1314],")",["T_WHITESPACE"," ",1314],"{",["T_WHITESPACE","\n            ",1314],["T_VARIABLE","$weeeAmountInclTax",1315],["T_WHITESPACE"," ",1315],"=",["T_WHITESPACE"," ",1315],["T_LNUMBER","0",1315],";",["T_WHITESPACE","\n            ",1315],["T_VARIABLE","$weeeAmountExclTax",1316],["T_WHITESPACE"," ",1316],"=",["T_WHITESPACE"," ",1316],["T_LNUMBER","0",1316],";",["T_WHITESPACE","\n\n            ",1316],["T_IF","if",1318],["T_WHITESPACE"," ",1318],"(",["T_VARIABLE","$base",1318],")",["T_WHITESPACE"," ",1318],"{",["T_WHITESPACE","\n                ",1318],["T_VARIABLE","$weeeAmountInclTax",1319],["T_WHITESPACE"," ",1319],"=",["T_WHITESPACE"," ",1319],["T_ISSET","isset",1319],"(",["T_VARIABLE","$tax",1319],"[",["T_CONSTANT_ENCAPSED_STRING","'base_row_amount_incl_tax'",1319],"]",")",["T_WHITESPACE"," ",1319],"?",["T_WHITESPACE"," ",1319],["T_VARIABLE","$tax",1319],"[",["T_CONSTANT_ENCAPSED_STRING","'base_row_amount_incl_tax'",1319],"]",["T_WHITESPACE"," ",1319],":",["T_WHITESPACE"," ",1319],["T_LNUMBER","0",1319],";",["T_WHITESPACE","\n                ",1319],["T_VARIABLE","$weeeAmountExclTax",1320],["T_WHITESPACE"," ",1320],"=",["T_WHITESPACE"," ",1320],["T_ISSET","isset",1320],"(",["T_VARIABLE","$tax",1320],"[",["T_CONSTANT_ENCAPSED_STRING","'base_row_amount'",1320],"]",")",["T_WHITESPACE"," ",1320],"?",["T_WHITESPACE"," ",1320],["T_VARIABLE","$tax",1320],"[",["T_CONSTANT_ENCAPSED_STRING","'base_row_amount'",1320],"]",["T_WHITESPACE"," ",1320],":",["T_WHITESPACE"," ",1320],["T_LNUMBER","0",1320],";",["T_WHITESPACE","\n            ",1320],"}",["T_WHITESPACE"," ",1321],["T_ELSE","else",1321],["T_WHITESPACE"," ",1321],"{",["T_WHITESPACE","\n                ",1321],["T_VARIABLE","$weeeAmountInclTax",1322],["T_WHITESPACE"," ",1322],"=",["T_WHITESPACE"," ",1322],["T_ISSET","isset",1322],"(",["T_VARIABLE","$tax",1322],"[",["T_CONSTANT_ENCAPSED_STRING","'row_amount_incl_tax'",1322],"]",")",["T_WHITESPACE"," ",1322],"?",["T_WHITESPACE"," ",1322],["T_VARIABLE","$tax",1322],"[",["T_CONSTANT_ENCAPSED_STRING","'row_amount_incl_tax'",1322],"]",["T_WHITESPACE"," ",1322],":",["T_WHITESPACE"," ",1322],["T_LNUMBER","0",1322],";",["T_WHITESPACE","\n                ",1322],["T_VARIABLE","$weeeAmountExclTax",1323],["T_WHITESPACE"," ",1323],"=",["T_WHITESPACE"," ",1323],["T_ISSET","isset",1323],"(",["T_VARIABLE","$tax",1323],"[",["T_CONSTANT_ENCAPSED_STRING","'row_amount'",1323],"]",")",["T_WHITESPACE"," ",1323],"?",["T_WHITESPACE"," ",1323],["T_VARIABLE","$tax",1323],"[",["T_CONSTANT_ENCAPSED_STRING","'row_amount'",1323],"]",["T_WHITESPACE"," ",1323],":",["T_WHITESPACE"," ",1323],["T_LNUMBER","0",1323],";",["T_WHITESPACE","\n            ",1323],"}",["T_WHITESPACE","\n\n            ",1324],["T_VARIABLE","$weeeTaxWithOutDiscount",1326],["T_WHITESPACE"," ",1326],"=",["T_WHITESPACE"," ",1326],["T_VARIABLE","$this",1326],["T_OBJECT_OPERATOR","->",1326],["T_STRING","_getWeeeTax",1326],"(",["T_VARIABLE","$rate",1326],",",["T_WHITESPACE"," ",1326],["T_VARIABLE","$item",1326],",",["T_WHITESPACE"," ",1326],["T_LNUMBER","0",1326],",",["T_WHITESPACE"," ",1326],["T_VARIABLE","$weeeAmountInclTax",1326],",",["T_WHITESPACE"," ",1326],["T_VARIABLE","$weeeAmountExclTax",1326],")",";",["T_WHITESPACE","\n\n            ",1326],["T_COMMENT","\/\/We want to update the tax calculated on Weee to the Item without discount.\n",1328],["T_WHITESPACE","            ",1329],["T_COMMENT","\/\/We do not show the discount to the user.\n",1329],["T_WHITESPACE","            ",1330],["T_VARIABLE","$weeeAmountIncludingTax",1330],["T_WHITESPACE"," ",1330],"=",["T_WHITESPACE"," ",1330],["T_VARIABLE","$weeeTaxWithOutDiscount",1330],["T_WHITESPACE"," ",1330],"+",["T_WHITESPACE"," ",1330],["T_VARIABLE","$weeeAmountExclTax",1330],";",["T_WHITESPACE","\n            ",1330],["T_IF","if",1331],["T_WHITESPACE"," ",1331],"(",["T_VARIABLE","$base",1331],")",["T_WHITESPACE"," ",1331],"{",["T_WHITESPACE","\n                ",1331],["T_VARIABLE","$this",1332],["T_OBJECT_OPERATOR","->",1332],["T_STRING","_weeeHelper",1332],["T_OBJECT_OPERATOR","->",1332],["T_STRING","setWeeeTaxesAppliedProperty",1332],"(",["T_VARIABLE","$item",1332],",",["T_WHITESPACE"," ",1332],["T_VARIABLE","$tax",1332],"[",["T_CONSTANT_ENCAPSED_STRING","'title'",1332],"]",",",["T_WHITESPACE","\n                    ",1332],["T_CONSTANT_ENCAPSED_STRING","'base_row_amount_incl_tax'",1333],",",["T_WHITESPACE"," ",1333],["T_VARIABLE","$weeeAmountIncludingTax",1333],")",";",["T_WHITESPACE","\n            ",1333],"}",["T_WHITESPACE"," ",1334],["T_ELSE","else",1334],["T_WHITESPACE"," ",1334],"{",["T_WHITESPACE","\n                ",1334],["T_VARIABLE","$this",1335],["T_OBJECT_OPERATOR","->",1335],["T_STRING","_weeeHelper",1335],["T_OBJECT_OPERATOR","->",1335],["T_STRING","setWeeeTaxesAppliedProperty",1335],"(",["T_VARIABLE","$item",1335],",",["T_WHITESPACE"," ",1335],["T_VARIABLE","$tax",1335],"[",["T_CONSTANT_ENCAPSED_STRING","'title'",1335],"]",",",["T_WHITESPACE","\n                    ",1335],["T_CONSTANT_ENCAPSED_STRING","'row_amount_incl_tax'",1336],",",["T_WHITESPACE"," ",1336],["T_VARIABLE","$weeeAmountIncludingTax",1336],")",";",["T_WHITESPACE","\n            ",1336],"}",["T_WHITESPACE","\n            ",1337],["T_VARIABLE","$totalWeeeAmountInclTax",1338],["T_WHITESPACE"," ",1338],["T_PLUS_EQUAL","+=",1338],["T_WHITESPACE"," ",1338],["T_VARIABLE","$weeeAmountInclTax",1338],";",["T_WHITESPACE","\n            ",1338],["T_VARIABLE","$totalWeeeAmountExclTax",1339],["T_WHITESPACE"," ",1339],["T_PLUS_EQUAL","+=",1339],["T_WHITESPACE"," ",1339],["T_VARIABLE","$weeeAmountExclTax",1339],";",["T_WHITESPACE","\n        ",1339],"}",["T_WHITESPACE","\n        ",1340],["T_RETURN","return",1341],["T_WHITESPACE"," ",1341],["T_VARIABLE","$this",1341],["T_OBJECT_OPERATOR","->",1341],["T_STRING","_getWeeeTax",1341],"(",["T_VARIABLE","$rate",1341],",",["T_WHITESPACE"," ",1341],["T_VARIABLE","$item",1341],",",["T_WHITESPACE"," ",1341],["T_VARIABLE","$discountAmount",1341],",",["T_WHITESPACE"," ",1341],["T_VARIABLE","$totalWeeeAmountInclTax",1341],",",["T_WHITESPACE"," ",1341],["T_VARIABLE","$totalWeeeAmountExclTax",1341],")",";",["T_WHITESPACE","\n    ",1341],"}",["T_WHITESPACE","\n\n\n    ",1342],["T_DOC_COMMENT","\/**\n     * Calculate the Weee tax based on the discount and rate\n     *\n     * @param float $rate\n     * @param Mage_Sales_Model_Quote_Item_Abstract $item\n     * @param float $discountAmount\n     * @param float $weeeAmountIncludingTax\n     * @param float $weeeAmountExclTax\n     * @return mixed\n     *\/",1345],["T_WHITESPACE","\n    ",1354],["T_PRIVATE","private",1355],["T_WHITESPACE"," ",1355],["T_FUNCTION","function",1355],["T_WHITESPACE"," ",1355],["T_STRING","_getWeeeTax",1355],"(",["T_VARIABLE","$rate",1355],",",["T_WHITESPACE"," ",1355],["T_VARIABLE","$item",1355],",",["T_WHITESPACE"," ",1355],["T_VARIABLE","$discountAmount",1355],",",["T_WHITESPACE"," ",1355],["T_VARIABLE","$weeeAmountIncludingTax",1355],",",["T_WHITESPACE"," ",1355],["T_VARIABLE","$weeeAmountExclTax",1355],")",["T_WHITESPACE","\n    ",1355],"{",["T_WHITESPACE","\n        ",1356],["T_VARIABLE","$isWeeeTaxAlreadyIncluded",1357],["T_WHITESPACE"," ",1357],"=",["T_WHITESPACE"," ",1357],["T_VARIABLE","$this",1357],["T_OBJECT_OPERATOR","->",1357],["T_STRING","_weeeHelper",1357],["T_OBJECT_OPERATOR","->",1357],["T_STRING","isTaxIncluded",1357],"(",["T_VARIABLE","$this",1357],["T_OBJECT_OPERATOR","->",1357],["T_STRING","_store",1357],")",";",["T_WHITESPACE","\n\n        ",1357],["T_VARIABLE","$sameRateAsStore",1359],["T_WHITESPACE"," ",1359],"=",["T_WHITESPACE"," ",1359],["T_VARIABLE","$this",1359],["T_OBJECT_OPERATOR","->",1359],["T_STRING","_helper",1359],["T_OBJECT_OPERATOR","->",1359],["T_STRING","isCrossBorderTradeEnabled",1359],"(",["T_VARIABLE","$this",1359],["T_OBJECT_OPERATOR","->",1359],["T_STRING","_store",1359],")",["T_WHITESPACE"," ",1359],["T_BOOLEAN_OR","||",1359],["T_WHITESPACE","\n                ",1359],"(",["T_VARIABLE","$rate",1360],["T_WHITESPACE"," ",1360],["T_IS_EQUAL","==",1360],["T_WHITESPACE"," ",1360],["T_VARIABLE","$this",1360],["T_OBJECT_OPERATOR","->",1360],["T_STRING","_calculator",1360],["T_OBJECT_OPERATOR","->",1360],["T_STRING","getStoreRateForItem",1360],"(",["T_VARIABLE","$item",1360],")",")",";",["T_WHITESPACE","\n        ",1360],["T_IF","if",1361],["T_WHITESPACE"," ",1361],"(",["T_VARIABLE","$sameRateAsStore",1361],["T_WHITESPACE"," ",1361],["T_BOOLEAN_AND","&&",1361],["T_WHITESPACE"," ",1361],["T_VARIABLE","$isWeeeTaxAlreadyIncluded",1361],")",["T_WHITESPACE"," ",1361],"{",["T_WHITESPACE","\n            ",1361],["T_IF","if",1362],["T_WHITESPACE"," ",1362],"(","!",["T_VARIABLE","$discountAmount",1362],["T_WHITESPACE"," ",1362],["T_BOOLEAN_OR","||",1362],["T_WHITESPACE"," ",1362],["T_VARIABLE","$discountAmount",1362],["T_WHITESPACE"," ",1362],["T_IS_SMALLER_OR_EQUAL","<=",1362],["T_WHITESPACE"," ",1362],["T_LNUMBER","0",1362],")",["T_WHITESPACE"," ",1362],"{",["T_WHITESPACE","\n                ",1362],["T_COMMENT","\/\/We want to skip the re calculation and return the difference\n",1363],["T_WHITESPACE","                ",1364],["T_RETURN","return",1364],["T_WHITESPACE"," ",1364],["T_STRING","max",1364],"(",["T_VARIABLE","$weeeAmountIncludingTax",1364],["T_WHITESPACE"," ",1364],"-",["T_WHITESPACE"," ",1364],["T_VARIABLE","$weeeAmountExclTax",1364],",",["T_WHITESPACE"," ",1364],["T_LNUMBER","0",1364],")",";",["T_WHITESPACE","\n            ",1364],"}",["T_WHITESPACE"," ",1365],["T_ELSE","else",1365],["T_WHITESPACE"," ",1365],"{",["T_WHITESPACE","\n                ",1365],["T_RETURN","return",1366],["T_WHITESPACE"," ",1366],["T_VARIABLE","$this",1366],["T_OBJECT_OPERATOR","->",1366],["T_STRING","_calculator",1366],["T_OBJECT_OPERATOR","->",1366],["T_STRING","calcTaxAmount",1366],"(",["T_VARIABLE","$weeeAmountIncludingTax",1366],["T_WHITESPACE"," ",1366],"-",["T_WHITESPACE"," ",1366],["T_VARIABLE","$discountAmount",1366],",",["T_WHITESPACE"," ",1366],["T_VARIABLE","$rate",1366],",",["T_WHITESPACE"," ",1366],["T_STRING","true",1366],",",["T_WHITESPACE"," ",1366],["T_STRING","true",1366],")",";",["T_WHITESPACE","\n            ",1366],"}",["T_WHITESPACE","\n        ",1367],"}",["T_WHITESPACE","\n        ",1368],["T_VARIABLE","$discountAmount",1369],["T_WHITESPACE"," ",1369],"=",["T_WHITESPACE"," ",1369],"!",["T_VARIABLE","$discountAmount",1369],["T_WHITESPACE"," ",1369],"?",["T_WHITESPACE"," ",1369],["T_LNUMBER","0",1369],["T_WHITESPACE"," ",1369],":",["T_WHITESPACE"," ",1369],["T_VARIABLE","$discountAmount",1369],";",["T_WHITESPACE","\n\n        ",1369],["T_COMMENT","\/\/\/Regular case where weee does not have the tax and we want to calculate the tax\n",1371],["T_WHITESPACE","        ",1372],["T_RETURN","return",1372],["T_WHITESPACE"," ",1372],["T_VARIABLE","$this",1372],["T_OBJECT_OPERATOR","->",1372],["T_STRING","_calculator",1372],["T_OBJECT_OPERATOR","->",1372],["T_STRING","calcTaxAmount",1372],"(",["T_VARIABLE","$weeeAmountExclTax",1372],["T_WHITESPACE"," ",1372],"-",["T_WHITESPACE"," ",1372],["T_VARIABLE","$discountAmount",1372],",",["T_WHITESPACE"," ",1372],["T_VARIABLE","$rate",1372],",",["T_WHITESPACE"," ",1372],["T_STRING","false",1372],",",["T_WHITESPACE"," ",1372],["T_STRING","true",1372],")",";",["T_WHITESPACE","\n    ",1372],"}",["T_WHITESPACE","\n\n    ",1373],["T_DOC_COMMENT","\/**\n     * Round price based on previous rounding operation delta\n     *\n     * @param float $price\n     * @param string $rate\n     * @param bool $direction price including or excluding tax\n     * @param string $type\n     * @return float\n     *\/",1375],["T_WHITESPACE","\n    ",1383],["T_PROTECTED","protected",1384],["T_WHITESPACE"," ",1384],["T_FUNCTION","function",1384],["T_WHITESPACE"," ",1384],["T_STRING","_deltaRound",1384],"(",["T_VARIABLE","$price",1384],",",["T_WHITESPACE"," ",1384],["T_VARIABLE","$rate",1384],",",["T_WHITESPACE"," ",1384],["T_VARIABLE","$direction",1384],",",["T_WHITESPACE"," ",1384],["T_VARIABLE","$type",1384],["T_WHITESPACE"," ",1384],"=",["T_WHITESPACE"," ",1384],["T_CONSTANT_ENCAPSED_STRING","'regular'",1384],")",["T_WHITESPACE","\n    ",1384],"{",["T_WHITESPACE","\n        ",1385],["T_IF","if",1386],["T_WHITESPACE"," ",1386],"(",["T_VARIABLE","$price",1386],")",["T_WHITESPACE"," ",1386],"{",["T_WHITESPACE","\n            ",1386],["T_VARIABLE","$rate",1387],["T_WHITESPACE"," ",1387],"=",["T_WHITESPACE"," ",1387],["T_STRING_CAST","(string)",1387],["T_VARIABLE","$rate",1387],";",["T_WHITESPACE","\n            ",1387],["T_VARIABLE","$type",1388],["T_WHITESPACE"," ",1388],"=",["T_WHITESPACE"," ",1388],["T_VARIABLE","$type",1388],["T_WHITESPACE"," ",1388],".",["T_WHITESPACE"," ",1388],["T_VARIABLE","$direction",1388],";",["T_WHITESPACE","\n            ",1388],["T_COMMENT","\/\/ initialize the delta to a small number to avoid non-deterministic behavior with rounding of 0.5\n",1389],["T_WHITESPACE","            ",1390],["T_VARIABLE","$delta",1390],["T_WHITESPACE"," ",1390],"=",["T_WHITESPACE"," ",1390],["T_ISSET","isset",1390],"(",["T_VARIABLE","$this",1390],["T_OBJECT_OPERATOR","->",1390],["T_STRING","_roundingDeltas",1390],"[",["T_VARIABLE","$type",1390],"]","[",["T_VARIABLE","$rate",1390],"]",")",["T_WHITESPACE"," ",1390],"?",["T_WHITESPACE"," ",1390],["T_VARIABLE","$this",1390],["T_OBJECT_OPERATOR","->",1390],["T_STRING","_roundingDeltas",1390],"[",["T_VARIABLE","$type",1390],"]","[",["T_VARIABLE","$rate",1390],"]",["T_WHITESPACE"," ",1390],":",["T_WHITESPACE"," ",1390],["T_DNUMBER","0.000001",1390],";",["T_WHITESPACE","\n            ",1390],["T_VARIABLE","$price",1391],["T_WHITESPACE"," ",1391],["T_PLUS_EQUAL","+=",1391],["T_WHITESPACE"," ",1391],["T_VARIABLE","$delta",1391],";",["T_WHITESPACE","\n            ",1391],["T_VARIABLE","$this",1392],["T_OBJECT_OPERATOR","->",1392],["T_STRING","_roundingDeltas",1392],"[",["T_VARIABLE","$type",1392],"]","[",["T_VARIABLE","$rate",1392],"]",["T_WHITESPACE"," ",1392],"=",["T_WHITESPACE"," ",1392],["T_VARIABLE","$price",1392],["T_WHITESPACE"," ",1392],"-",["T_WHITESPACE"," ",1392],["T_VARIABLE","$this",1392],["T_OBJECT_OPERATOR","->",1392],["T_STRING","_calculator",1392],["T_OBJECT_OPERATOR","->",1392],["T_STRING","round",1392],"(",["T_VARIABLE","$price",1392],")",";",["T_WHITESPACE","\n            ",1392],["T_VARIABLE","$price",1393],["T_WHITESPACE"," ",1393],"=",["T_WHITESPACE"," ",1393],["T_VARIABLE","$this",1393],["T_OBJECT_OPERATOR","->",1393],["T_STRING","_calculator",1393],["T_OBJECT_OPERATOR","->",1393],["T_STRING","round",1393],"(",["T_VARIABLE","$price",1393],")",";",["T_WHITESPACE","\n        ",1393],"}",["T_WHITESPACE","\n        ",1394],["T_RETURN","return",1395],["T_WHITESPACE"," ",1395],["T_VARIABLE","$price",1395],";",["T_WHITESPACE","\n    ",1395],"}",["T_WHITESPACE","\n\n    ",1396],["T_DOC_COMMENT","\/**\n     * Recalculate parent item amounts base on children data\n     *\n     * @param   Mage_Sales_Model_Quote_Item_Abstract $item\n     * @return  Mage_Tax_Model_Sales_Total_Quote\n     *\/",1398],["T_WHITESPACE","\n    ",1403],["T_PROTECTED","protected",1404],["T_WHITESPACE"," ",1404],["T_FUNCTION","function",1404],["T_WHITESPACE"," ",1404],["T_STRING","_recalculateParent",1404],"(",["T_STRING","Mage_Sales_Model_Quote_Item_Abstract",1404],["T_WHITESPACE"," ",1404],["T_VARIABLE","$item",1404],")",["T_WHITESPACE","\n    ",1404],"{",["T_WHITESPACE","\n        ",1405],["T_VARIABLE","$rowTaxAmount",1406],["T_WHITESPACE"," ",1406],"=",["T_WHITESPACE"," ",1406],["T_LNUMBER","0",1406],";",["T_WHITESPACE","\n        ",1406],["T_VARIABLE","$baseRowTaxAmount",1407],["T_WHITESPACE"," ",1407],"=",["T_WHITESPACE"," ",1407],["T_LNUMBER","0",1407],";",["T_WHITESPACE","\n        ",1407],["T_FOREACH","foreach",1408],["T_WHITESPACE"," ",1408],"(",["T_VARIABLE","$item",1408],["T_OBJECT_OPERATOR","->",1408],["T_STRING","getChildren",1408],"(",")",["T_WHITESPACE"," ",1408],["T_AS","as",1408],["T_WHITESPACE"," ",1408],["T_VARIABLE","$child",1408],")",["T_WHITESPACE"," ",1408],"{",["T_WHITESPACE","\n            ",1408],["T_VARIABLE","$rowTaxAmount",1409],["T_WHITESPACE"," ",1409],["T_PLUS_EQUAL","+=",1409],["T_WHITESPACE"," ",1409],["T_VARIABLE","$child",1409],["T_OBJECT_OPERATOR","->",1409],["T_STRING","getTaxAmount",1409],"(",")",";",["T_WHITESPACE","\n            ",1409],["T_VARIABLE","$baseRowTaxAmount",1410],["T_WHITESPACE"," ",1410],["T_PLUS_EQUAL","+=",1410],["T_WHITESPACE"," ",1410],["T_VARIABLE","$child",1410],["T_OBJECT_OPERATOR","->",1410],["T_STRING","getBaseTaxAmount",1410],"(",")",";",["T_WHITESPACE","\n        ",1410],"}",["T_WHITESPACE","\n        ",1411],["T_VARIABLE","$item",1412],["T_OBJECT_OPERATOR","->",1412],["T_STRING","setTaxAmount",1412],"(",["T_VARIABLE","$rowTaxAmount",1412],")",";",["T_WHITESPACE","\n        ",1412],["T_VARIABLE","$item",1413],["T_OBJECT_OPERATOR","->",1413],["T_STRING","setBaseTaxAmount",1413],"(",["T_VARIABLE","$baseRowTaxAmount",1413],")",";",["T_WHITESPACE","\n        ",1413],["T_RETURN","return",1414],["T_WHITESPACE"," ",1414],["T_VARIABLE","$this",1414],";",["T_WHITESPACE","\n    ",1414],"}",["T_WHITESPACE","\n\n    ",1415],["T_DOC_COMMENT","\/**\n     * Collect applied tax rates information on address level\n     *\n     * @param   Mage_Sales_Model_Quote_Address $address\n     * @param   array $applied\n     * @param   float $amount\n     * @param   float $baseAmount\n     * @param   float $rate\n     *\/",1417],["T_WHITESPACE","\n    ",1425],["T_PROTECTED","protected",1426],["T_WHITESPACE"," ",1426],["T_FUNCTION","function",1426],["T_WHITESPACE"," ",1426],["T_STRING","_saveAppliedTaxes",1426],"(",["T_STRING","Mage_Sales_Model_Quote_Address",1426],["T_WHITESPACE"," ",1426],["T_VARIABLE","$address",1426],",",["T_WHITESPACE","\n                                         ",1426],["T_VARIABLE","$applied",1427],",",["T_WHITESPACE"," ",1427],["T_VARIABLE","$amount",1427],",",["T_WHITESPACE"," ",1427],["T_VARIABLE","$baseAmount",1427],",",["T_WHITESPACE"," ",1427],["T_VARIABLE","$rate",1427],")",["T_WHITESPACE","\n    ",1427],"{",["T_WHITESPACE","\n        ",1428],["T_VARIABLE","$previouslyAppliedTaxes",1429],["T_WHITESPACE"," ",1429],"=",["T_WHITESPACE"," ",1429],["T_VARIABLE","$address",1429],["T_OBJECT_OPERATOR","->",1429],["T_STRING","getAppliedTaxes",1429],"(",")",";",["T_WHITESPACE","\n        ",1429],["T_VARIABLE","$process",1430],["T_WHITESPACE"," ",1430],"=",["T_WHITESPACE"," ",1430],["T_STRING","count",1430],"(",["T_VARIABLE","$previouslyAppliedTaxes",1430],")",";",["T_WHITESPACE","\n\n        ",1430],["T_FOREACH","foreach",1432],["T_WHITESPACE"," ",1432],"(",["T_VARIABLE","$applied",1432],["T_WHITESPACE"," ",1432],["T_AS","as",1432],["T_WHITESPACE"," ",1432],["T_VARIABLE","$row",1432],")",["T_WHITESPACE"," ",1432],"{",["T_WHITESPACE","\n            ",1432],["T_IF","if",1433],["T_WHITESPACE"," ",1433],"(",["T_VARIABLE","$row",1433],"[",["T_CONSTANT_ENCAPSED_STRING","'percent'",1433],"]",["T_WHITESPACE"," ",1433],["T_IS_EQUAL","==",1433],["T_WHITESPACE"," ",1433],["T_LNUMBER","0",1433],")",["T_WHITESPACE"," ",1433],"{",["T_WHITESPACE","\n                ",1433],["T_CONTINUE","continue",1434],";",["T_WHITESPACE","\n            ",1434],"}",["T_WHITESPACE","\n            ",1435],["T_IF","if",1436],["T_WHITESPACE"," ",1436],"(","!",["T_ISSET","isset",1436],"(",["T_VARIABLE","$previouslyAppliedTaxes",1436],"[",["T_VARIABLE","$row",1436],"[",["T_CONSTANT_ENCAPSED_STRING","'id'",1436],"]","]",")",")",["T_WHITESPACE"," ",1436],"{",["T_WHITESPACE","\n                ",1436],["T_VARIABLE","$row",1437],"[",["T_CONSTANT_ENCAPSED_STRING","'process'",1437],"]",["T_WHITESPACE"," ",1437],"=",["T_WHITESPACE"," ",1437],["T_VARIABLE","$process",1437],";",["T_WHITESPACE","\n                ",1437],["T_VARIABLE","$row",1438],"[",["T_CONSTANT_ENCAPSED_STRING","'amount'",1438],"]",["T_WHITESPACE"," ",1438],"=",["T_WHITESPACE"," ",1438],["T_LNUMBER","0",1438],";",["T_WHITESPACE","\n                ",1438],["T_VARIABLE","$row",1439],"[",["T_CONSTANT_ENCAPSED_STRING","'base_amount'",1439],"]",["T_WHITESPACE"," ",1439],"=",["T_WHITESPACE"," ",1439],["T_LNUMBER","0",1439],";",["T_WHITESPACE","\n                ",1439],["T_VARIABLE","$previouslyAppliedTaxes",1440],"[",["T_VARIABLE","$row",1440],"[",["T_CONSTANT_ENCAPSED_STRING","'id'",1440],"]","]",["T_WHITESPACE"," ",1440],"=",["T_WHITESPACE"," ",1440],["T_VARIABLE","$row",1440],";",["T_WHITESPACE","\n            ",1440],"}",["T_WHITESPACE","\n\n            ",1441],["T_IF","if",1443],["T_WHITESPACE"," ",1443],"(","!",["T_STRING","is_null",1443],"(",["T_VARIABLE","$row",1443],"[",["T_CONSTANT_ENCAPSED_STRING","'percent'",1443],"]",")",")",["T_WHITESPACE"," ",1443],"{",["T_WHITESPACE","\n                ",1443],["T_VARIABLE","$row",1444],"[",["T_CONSTANT_ENCAPSED_STRING","'percent'",1444],"]",["T_WHITESPACE"," ",1444],"=",["T_WHITESPACE"," ",1444],["T_VARIABLE","$row",1444],"[",["T_CONSTANT_ENCAPSED_STRING","'percent'",1444],"]",["T_WHITESPACE"," ",1444],"?",["T_WHITESPACE"," ",1444],["T_VARIABLE","$row",1444],"[",["T_CONSTANT_ENCAPSED_STRING","'percent'",1444],"]",["T_WHITESPACE"," ",1444],":",["T_WHITESPACE"," ",1444],["T_LNUMBER","1",1444],";",["T_WHITESPACE","\n                ",1444],["T_VARIABLE","$rate",1445],["T_WHITESPACE"," ",1445],"=",["T_WHITESPACE"," ",1445],["T_VARIABLE","$rate",1445],["T_WHITESPACE"," ",1445],"?",["T_WHITESPACE"," ",1445],["T_VARIABLE","$rate",1445],["T_WHITESPACE"," ",1445],":",["T_WHITESPACE"," ",1445],["T_LNUMBER","1",1445],";",["T_WHITESPACE","\n\n                ",1445],["T_VARIABLE","$appliedAmount",1447],["T_WHITESPACE"," ",1447],"=",["T_WHITESPACE"," ",1447],["T_VARIABLE","$amount",1447],["T_WHITESPACE"," ",1447],"\/",["T_WHITESPACE"," ",1447],["T_VARIABLE","$rate",1447],["T_WHITESPACE"," ",1447],"*",["T_WHITESPACE"," ",1447],["T_VARIABLE","$row",1447],"[",["T_CONSTANT_ENCAPSED_STRING","'percent'",1447],"]",";",["T_WHITESPACE","\n                ",1447],["T_VARIABLE","$baseAppliedAmount",1448],["T_WHITESPACE"," ",1448],"=",["T_WHITESPACE"," ",1448],["T_VARIABLE","$baseAmount",1448],["T_WHITESPACE"," ",1448],"\/",["T_WHITESPACE"," ",1448],["T_VARIABLE","$rate",1448],["T_WHITESPACE"," ",1448],"*",["T_WHITESPACE"," ",1448],["T_VARIABLE","$row",1448],"[",["T_CONSTANT_ENCAPSED_STRING","'percent'",1448],"]",";",["T_WHITESPACE","\n            ",1448],"}",["T_WHITESPACE"," ",1449],["T_ELSE","else",1449],["T_WHITESPACE"," ",1449],"{",["T_WHITESPACE","\n                ",1449],["T_VARIABLE","$appliedAmount",1450],["T_WHITESPACE"," ",1450],"=",["T_WHITESPACE"," ",1450],["T_LNUMBER","0",1450],";",["T_WHITESPACE","\n                ",1450],["T_VARIABLE","$baseAppliedAmount",1451],["T_WHITESPACE"," ",1451],"=",["T_WHITESPACE"," ",1451],["T_LNUMBER","0",1451],";",["T_WHITESPACE","\n                ",1451],["T_FOREACH","foreach",1452],["T_WHITESPACE"," ",1452],"(",["T_VARIABLE","$row",1452],"[",["T_CONSTANT_ENCAPSED_STRING","'rates'",1452],"]",["T_WHITESPACE"," ",1452],["T_AS","as",1452],["T_WHITESPACE"," ",1452],["T_VARIABLE","$rate",1452],")",["T_WHITESPACE"," ",1452],"{",["T_WHITESPACE","\n                    ",1452],["T_VARIABLE","$appliedAmount",1453],["T_WHITESPACE"," ",1453],["T_PLUS_EQUAL","+=",1453],["T_WHITESPACE"," ",1453],["T_VARIABLE","$rate",1453],"[",["T_CONSTANT_ENCAPSED_STRING","'amount'",1453],"]",";",["T_WHITESPACE","\n                    ",1453],["T_VARIABLE","$baseAppliedAmount",1454],["T_WHITESPACE"," ",1454],["T_PLUS_EQUAL","+=",1454],["T_WHITESPACE"," ",1454],["T_VARIABLE","$rate",1454],"[",["T_CONSTANT_ENCAPSED_STRING","'base_amount'",1454],"]",";",["T_WHITESPACE","\n                ",1454],"}",["T_WHITESPACE","\n            ",1455],"}",["T_WHITESPACE","\n\n\n            ",1456],["T_IF","if",1459],["T_WHITESPACE"," ",1459],"(",["T_VARIABLE","$appliedAmount",1459],["T_WHITESPACE"," ",1459],["T_BOOLEAN_OR","||",1459],["T_WHITESPACE"," ",1459],["T_VARIABLE","$previouslyAppliedTaxes",1459],"[",["T_VARIABLE","$row",1459],"[",["T_CONSTANT_ENCAPSED_STRING","'id'",1459],"]","]","[",["T_CONSTANT_ENCAPSED_STRING","'amount'",1459],"]",")",["T_WHITESPACE"," ",1459],"{",["T_WHITESPACE","\n                ",1459],["T_VARIABLE","$previouslyAppliedTaxes",1460],"[",["T_VARIABLE","$row",1460],"[",["T_CONSTANT_ENCAPSED_STRING","'id'",1460],"]","]","[",["T_CONSTANT_ENCAPSED_STRING","'amount'",1460],"]",["T_WHITESPACE"," ",1460],["T_PLUS_EQUAL","+=",1460],["T_WHITESPACE"," ",1460],["T_VARIABLE","$appliedAmount",1460],";",["T_WHITESPACE","\n                ",1460],["T_VARIABLE","$previouslyAppliedTaxes",1461],"[",["T_VARIABLE","$row",1461],"[",["T_CONSTANT_ENCAPSED_STRING","'id'",1461],"]","]","[",["T_CONSTANT_ENCAPSED_STRING","'base_amount'",1461],"]",["T_WHITESPACE"," ",1461],["T_PLUS_EQUAL","+=",1461],["T_WHITESPACE"," ",1461],["T_VARIABLE","$baseAppliedAmount",1461],";",["T_WHITESPACE","\n            ",1461],"}",["T_WHITESPACE"," ",1462],["T_ELSE","else",1462],["T_WHITESPACE"," ",1462],"{",["T_WHITESPACE","\n                ",1462],["T_UNSET","unset",1463],"(",["T_VARIABLE","$previouslyAppliedTaxes",1463],"[",["T_VARIABLE","$row",1463],"[",["T_CONSTANT_ENCAPSED_STRING","'id'",1463],"]","]",")",";",["T_WHITESPACE","\n            ",1463],"}",["T_WHITESPACE","\n        ",1464],"}",["T_WHITESPACE","\n        ",1465],["T_VARIABLE","$address",1466],["T_OBJECT_OPERATOR","->",1466],["T_STRING","setAppliedTaxes",1466],"(",["T_VARIABLE","$previouslyAppliedTaxes",1466],")",";",["T_WHITESPACE","\n    ",1466],"}",["T_WHITESPACE","\n\n    ",1467],["T_DOC_COMMENT","\/**\n     * Add tax totals information to address object\n     *\n     * @param   Mage_Sales_Model_Quote_Address $address\n     * @return  Mage_Tax_Model_Sales_Total_Quote\n     *\/",1469],["T_WHITESPACE","\n    ",1474],["T_PUBLIC","public",1475],["T_WHITESPACE"," ",1475],["T_FUNCTION","function",1475],["T_WHITESPACE"," ",1475],["T_STRING","fetch",1475],"(",["T_STRING","Mage_Sales_Model_Quote_Address",1475],["T_WHITESPACE"," ",1475],["T_VARIABLE","$address",1475],")",["T_WHITESPACE","\n    ",1475],"{",["T_WHITESPACE","\n        ",1476],["T_VARIABLE","$applied",1477],["T_WHITESPACE"," ",1477],"=",["T_WHITESPACE"," ",1477],["T_VARIABLE","$address",1477],["T_OBJECT_OPERATOR","->",1477],["T_STRING","getAppliedTaxes",1477],"(",")",";",["T_WHITESPACE","\n        ",1477],["T_VARIABLE","$store",1478],["T_WHITESPACE"," ",1478],"=",["T_WHITESPACE"," ",1478],["T_VARIABLE","$address",1478],["T_OBJECT_OPERATOR","->",1478],["T_STRING","getQuote",1478],"(",")",["T_OBJECT_OPERATOR","->",1478],["T_STRING","getStore",1478],"(",")",";",["T_WHITESPACE","\n        ",1478],["T_VARIABLE","$amount",1479],["T_WHITESPACE"," ",1479],"=",["T_WHITESPACE"," ",1479],["T_VARIABLE","$address",1479],["T_OBJECT_OPERATOR","->",1479],["T_STRING","getTaxAmount",1479],"(",")",";",["T_WHITESPACE","\n\n        ",1479],["T_VARIABLE","$items",1481],["T_WHITESPACE"," ",1481],"=",["T_WHITESPACE"," ",1481],["T_VARIABLE","$this",1481],["T_OBJECT_OPERATOR","->",1481],["T_STRING","_getAddressItems",1481],"(",["T_VARIABLE","$address",1481],")",";",["T_WHITESPACE","\n        ",1481],["T_VARIABLE","$discountTaxCompensation",1482],["T_WHITESPACE"," ",1482],"=",["T_WHITESPACE"," ",1482],["T_LNUMBER","0",1482],";",["T_WHITESPACE","\n        ",1482],["T_FOREACH","foreach",1483],["T_WHITESPACE"," ",1483],"(",["T_VARIABLE","$items",1483],["T_WHITESPACE"," ",1483],["T_AS","as",1483],["T_WHITESPACE"," ",1483],["T_VARIABLE","$item",1483],")",["T_WHITESPACE"," ",1483],"{",["T_WHITESPACE","\n            ",1483],["T_VARIABLE","$discountTaxCompensation",1484],["T_WHITESPACE"," ",1484],["T_PLUS_EQUAL","+=",1484],["T_WHITESPACE"," ",1484],["T_VARIABLE","$item",1484],["T_OBJECT_OPERATOR","->",1484],["T_STRING","getDiscountTaxCompensation",1484],"(",")",";",["T_WHITESPACE","\n        ",1484],"}",["T_WHITESPACE","\n        ",1485],["T_VARIABLE","$taxAmount",1486],["T_WHITESPACE"," ",1486],"=",["T_WHITESPACE"," ",1486],["T_VARIABLE","$amount",1486],["T_WHITESPACE"," ",1486],"+",["T_WHITESPACE"," ",1486],["T_VARIABLE","$discountTaxCompensation",1486],";",["T_WHITESPACE","\n        ",1486],["T_COMMENT","\/*\n         * when weee discount is not included in extraTaxAmount, we need to add it to the total tax\n         *\/",1487],["T_WHITESPACE","\n        ",1489],["T_IF","if",1490],["T_WHITESPACE"," ",1490],"(",["T_VARIABLE","$this",1490],["T_OBJECT_OPERATOR","->",1490],["T_STRING","_weeeHelper",1490],["T_OBJECT_OPERATOR","->",1490],["T_STRING","isEnabled",1490],"(",")",")",["T_WHITESPACE"," ",1490],"{",["T_WHITESPACE","\n            ",1490],["T_IF","if",1491],["T_WHITESPACE"," ",1491],"(","!",["T_VARIABLE","$this",1491],["T_OBJECT_OPERATOR","->",1491],["T_STRING","_weeeHelper",1491],["T_OBJECT_OPERATOR","->",1491],["T_STRING","includeInSubtotal",1491],"(",")",")",["T_WHITESPACE"," ",1491],"{",["T_WHITESPACE","\n                ",1491],["T_VARIABLE","$taxAmount",1492],["T_WHITESPACE"," ",1492],["T_PLUS_EQUAL","+=",1492],["T_WHITESPACE"," ",1492],["T_VARIABLE","$address",1492],["T_OBJECT_OPERATOR","->",1492],["T_STRING","getWeeeDiscount",1492],"(",")",";",["T_WHITESPACE","\n            ",1492],"}",["T_WHITESPACE","\n        ",1493],"}",["T_WHITESPACE","\n\n        ",1494],["T_VARIABLE","$area",1496],["T_WHITESPACE"," ",1496],"=",["T_WHITESPACE"," ",1496],["T_STRING","null",1496],";",["T_WHITESPACE","\n        ",1496],["T_IF","if",1497],["T_WHITESPACE"," ",1497],"(",["T_VARIABLE","$this",1497],["T_OBJECT_OPERATOR","->",1497],["T_STRING","_config",1497],["T_OBJECT_OPERATOR","->",1497],["T_STRING","displayCartTaxWithGrandTotal",1497],"(",["T_VARIABLE","$store",1497],")",["T_WHITESPACE"," ",1497],["T_BOOLEAN_AND","&&",1497],["T_WHITESPACE"," ",1497],["T_VARIABLE","$address",1497],["T_OBJECT_OPERATOR","->",1497],["T_STRING","getGrandTotal",1497],"(",")",")",["T_WHITESPACE"," ",1497],"{",["T_WHITESPACE","\n            ",1497],["T_VARIABLE","$area",1498],["T_WHITESPACE"," ",1498],"=",["T_WHITESPACE"," ",1498],["T_CONSTANT_ENCAPSED_STRING","'taxes'",1498],";",["T_WHITESPACE","\n        ",1498],"}",["T_WHITESPACE","\n\n        ",1499],["T_IF","if",1501],["T_WHITESPACE"," ",1501],"(","(",["T_VARIABLE","$amount",1501],["T_WHITESPACE"," ",1501],["T_IS_NOT_EQUAL","!=",1501],["T_WHITESPACE"," ",1501],["T_LNUMBER","0",1501],")",["T_WHITESPACE"," ",1501],["T_BOOLEAN_OR","||",1501],["T_WHITESPACE"," ",1501],"(",["T_VARIABLE","$this",1501],["T_OBJECT_OPERATOR","->",1501],["T_STRING","_config",1501],["T_OBJECT_OPERATOR","->",1501],["T_STRING","displayCartZeroTax",1501],"(",["T_VARIABLE","$store",1501],")",")",")",["T_WHITESPACE"," ",1501],"{",["T_WHITESPACE","\n            ",1501],["T_VARIABLE","$address",1502],["T_OBJECT_OPERATOR","->",1502],["T_STRING","addTotal",1502],"(",["T_ARRAY","array",1502],"(",["T_WHITESPACE","\n                ",1502],["T_CONSTANT_ENCAPSED_STRING","'code'",1503],["T_WHITESPACE"," ",1503],["T_DOUBLE_ARROW","=>",1503],["T_WHITESPACE"," ",1503],["T_VARIABLE","$this",1503],["T_OBJECT_OPERATOR","->",1503],["T_STRING","getCode",1503],"(",")",",",["T_WHITESPACE","\n                ",1503],["T_CONSTANT_ENCAPSED_STRING","'title'",1504],["T_WHITESPACE"," ",1504],["T_DOUBLE_ARROW","=>",1504],["T_WHITESPACE"," ",1504],["T_STRING","Mage",1504],["T_DOUBLE_COLON","::",1504],["T_STRING","helper",1504],"(",["T_CONSTANT_ENCAPSED_STRING","'tax'",1504],")",["T_OBJECT_OPERATOR","->",1504],["T_STRING","__",1504],"(",["T_CONSTANT_ENCAPSED_STRING","'Tax'",1504],")",",",["T_WHITESPACE","\n                ",1504],["T_CONSTANT_ENCAPSED_STRING","'full_info'",1505],["T_WHITESPACE"," ",1505],["T_DOUBLE_ARROW","=>",1505],["T_WHITESPACE"," ",1505],["T_VARIABLE","$applied",1505],["T_WHITESPACE"," ",1505],"?",["T_WHITESPACE"," ",1505],["T_VARIABLE","$applied",1505],["T_WHITESPACE"," ",1505],":",["T_WHITESPACE"," ",1505],["T_ARRAY","array",1505],"(",")",",",["T_WHITESPACE","\n                ",1505],["T_CONSTANT_ENCAPSED_STRING","'value'",1506],["T_WHITESPACE"," ",1506],["T_DOUBLE_ARROW","=>",1506],["T_WHITESPACE"," ",1506],["T_VARIABLE","$amount",1506],",",["T_WHITESPACE","\n                ",1506],["T_CONSTANT_ENCAPSED_STRING","'area'",1507],["T_WHITESPACE"," ",1507],["T_DOUBLE_ARROW","=>",1507],["T_WHITESPACE"," ",1507],["T_VARIABLE","$area",1507],["T_WHITESPACE","\n            ",1507],")",")",";",["T_WHITESPACE","\n        ",1508],"}",["T_WHITESPACE","\n\n        ",1509],["T_VARIABLE","$store",1511],["T_WHITESPACE"," ",1511],"=",["T_WHITESPACE"," ",1511],["T_VARIABLE","$address",1511],["T_OBJECT_OPERATOR","->",1511],["T_STRING","getQuote",1511],"(",")",["T_OBJECT_OPERATOR","->",1511],["T_STRING","getStore",1511],"(",")",";",["T_WHITESPACE","\n        ",1511],["T_DOC_COMMENT","\/**\n         * Modify subtotal\n         *\/",1512],["T_WHITESPACE","\n        ",1514],["T_IF","if",1515],["T_WHITESPACE"," ",1515],"(",["T_VARIABLE","$this",1515],["T_OBJECT_OPERATOR","->",1515],["T_STRING","_config",1515],["T_OBJECT_OPERATOR","->",1515],["T_STRING","displayCartSubtotalBoth",1515],"(",["T_VARIABLE","$store",1515],")",["T_WHITESPACE"," ",1515],["T_BOOLEAN_OR","||",1515],["T_WHITESPACE"," ",1515],["T_VARIABLE","$this",1515],["T_OBJECT_OPERATOR","->",1515],["T_STRING","_config",1515],["T_OBJECT_OPERATOR","->",1515],["T_STRING","displayCartSubtotalInclTax",1515],"(",["T_VARIABLE","$store",1515],")",")",["T_WHITESPACE"," ",1515],"{",["T_WHITESPACE","\n            ",1515],["T_IF","if",1516],["T_WHITESPACE"," ",1516],"(",["T_VARIABLE","$address",1516],["T_OBJECT_OPERATOR","->",1516],["T_STRING","getSubtotalInclTax",1516],"(",")",["T_WHITESPACE"," ",1516],">",["T_WHITESPACE"," ",1516],["T_LNUMBER","0",1516],")",["T_WHITESPACE"," ",1516],"{",["T_WHITESPACE","\n                ",1516],["T_VARIABLE","$subtotalInclTax",1517],["T_WHITESPACE"," ",1517],"=",["T_WHITESPACE"," ",1517],["T_VARIABLE","$address",1517],["T_OBJECT_OPERATOR","->",1517],["T_STRING","getSubtotalInclTax",1517],"(",")",";",["T_WHITESPACE","\n            ",1517],"}",["T_WHITESPACE"," ",1518],["T_ELSE","else",1518],["T_WHITESPACE"," ",1518],"{",["T_WHITESPACE","\n                ",1518],["T_VARIABLE","$subtotalInclTax",1519],["T_WHITESPACE"," ",1519],"=",["T_WHITESPACE"," ",1519],["T_VARIABLE","$address",1519],["T_OBJECT_OPERATOR","->",1519],["T_STRING","getSubtotal",1519],"(",")",["T_WHITESPACE"," ",1519],"+",["T_WHITESPACE"," ",1519],["T_VARIABLE","$taxAmount",1519],["T_WHITESPACE"," ",1519],"-",["T_WHITESPACE"," ",1519],["T_VARIABLE","$address",1519],["T_OBJECT_OPERATOR","->",1519],["T_STRING","getShippingTaxAmount",1519],"(",")",";",["T_WHITESPACE","\n            ",1519],"}",["T_WHITESPACE","\n\n            ",1520],["T_VARIABLE","$address",1522],["T_OBJECT_OPERATOR","->",1522],["T_STRING","addTotal",1522],"(",["T_ARRAY","array",1522],"(",["T_WHITESPACE","\n                ",1522],["T_CONSTANT_ENCAPSED_STRING","'code'",1523],["T_WHITESPACE"," ",1523],["T_DOUBLE_ARROW","=>",1523],["T_WHITESPACE"," ",1523],["T_CONSTANT_ENCAPSED_STRING","'subtotal'",1523],",",["T_WHITESPACE","\n                ",1523],["T_CONSTANT_ENCAPSED_STRING","'title'",1524],["T_WHITESPACE"," ",1524],["T_DOUBLE_ARROW","=>",1524],["T_WHITESPACE"," ",1524],["T_STRING","Mage",1524],["T_DOUBLE_COLON","::",1524],["T_STRING","helper",1524],"(",["T_CONSTANT_ENCAPSED_STRING","'sales'",1524],")",["T_OBJECT_OPERATOR","->",1524],["T_STRING","__",1524],"(",["T_CONSTANT_ENCAPSED_STRING","'Subtotal'",1524],")",",",["T_WHITESPACE","\n                ",1524],["T_CONSTANT_ENCAPSED_STRING","'value'",1525],["T_WHITESPACE"," ",1525],["T_DOUBLE_ARROW","=>",1525],["T_WHITESPACE"," ",1525],["T_VARIABLE","$subtotalInclTax",1525],",",["T_WHITESPACE","\n                ",1525],["T_CONSTANT_ENCAPSED_STRING","'value_incl_tax'",1526],["T_WHITESPACE"," ",1526],["T_DOUBLE_ARROW","=>",1526],["T_WHITESPACE"," ",1526],["T_VARIABLE","$subtotalInclTax",1526],",",["T_WHITESPACE","\n                ",1526],["T_CONSTANT_ENCAPSED_STRING","'value_excl_tax'",1527],["T_WHITESPACE"," ",1527],["T_DOUBLE_ARROW","=>",1527],["T_WHITESPACE"," ",1527],["T_VARIABLE","$address",1527],["T_OBJECT_OPERATOR","->",1527],["T_STRING","getSubtotal",1527],"(",")",",",["T_WHITESPACE","\n            ",1527],")",")",";",["T_WHITESPACE","\n        ",1528],"}",["T_WHITESPACE","\n\n        ",1529],["T_RETURN","return",1531],["T_WHITESPACE"," ",1531],["T_VARIABLE","$this",1531],";",["T_WHITESPACE","\n    ",1531],"}",["T_WHITESPACE","\n\n    ",1532],["T_DOC_COMMENT","\/**\n     * Process model configuration array.\n     * This method can be used for changing totals collect sort order\n     *\n     * @param   array $config\n     * @param   store $store\n     * @return  array\n     *\/",1534],["T_WHITESPACE","\n    ",1541],["T_PUBLIC","public",1542],["T_WHITESPACE"," ",1542],["T_FUNCTION","function",1542],["T_WHITESPACE"," ",1542],["T_STRING","processConfigArray",1542],"(",["T_VARIABLE","$config",1542],",",["T_WHITESPACE"," ",1542],["T_VARIABLE","$store",1542],")",["T_WHITESPACE","\n    ",1542],"{",["T_WHITESPACE","\n        ",1543],["T_VARIABLE","$calculationSequence",1544],["T_WHITESPACE"," ",1544],"=",["T_WHITESPACE"," ",1544],["T_VARIABLE","$this",1544],["T_OBJECT_OPERATOR","->",1544],["T_STRING","_helper",1544],["T_OBJECT_OPERATOR","->",1544],["T_STRING","getCalculationSequence",1544],"(",["T_VARIABLE","$store",1544],")",";",["T_WHITESPACE","\n        ",1544],["T_SWITCH","switch",1545],["T_WHITESPACE"," ",1545],"(",["T_VARIABLE","$calculationSequence",1545],")",["T_WHITESPACE"," ",1545],"{",["T_WHITESPACE","\n            ",1545],["T_CASE","case",1546],["T_WHITESPACE"," ",1546],["T_STRING","Mage_Tax_Model_Calculation",1546],["T_DOUBLE_COLON","::",1546],["T_STRING","CALC_TAX_BEFORE_DISCOUNT_ON_INCL",1546],":",["T_WHITESPACE","\n                ",1546],["T_VARIABLE","$config",1547],"[",["T_CONSTANT_ENCAPSED_STRING","'before'",1547],"]","[","]",["T_WHITESPACE"," ",1547],"=",["T_WHITESPACE"," ",1547],["T_CONSTANT_ENCAPSED_STRING","'discount'",1547],";",["T_WHITESPACE","\n                ",1547],["T_BREAK","break",1548],";",["T_WHITESPACE","\n            ",1548],["T_DEFAULT","default",1549],":",["T_WHITESPACE","\n                ",1549],["T_VARIABLE","$config",1550],"[",["T_CONSTANT_ENCAPSED_STRING","'after'",1550],"]","[","]",["T_WHITESPACE"," ",1550],"=",["T_WHITESPACE"," ",1550],["T_CONSTANT_ENCAPSED_STRING","'discount'",1550],";",["T_WHITESPACE","\n                ",1550],["T_BREAK","break",1551],";",["T_WHITESPACE","\n        ",1551],"}",["T_WHITESPACE","\n        ",1552],["T_RETURN","return",1553],["T_WHITESPACE"," ",1553],["T_VARIABLE","$config",1553],";",["T_WHITESPACE","\n    ",1553],"}",["T_WHITESPACE","\n\n    ",1554],["T_DOC_COMMENT","\/**\n     * Get Tax label\n     *\n     * @return string\n     *\/",1556],["T_WHITESPACE","\n    ",1560],["T_PUBLIC","public",1561],["T_WHITESPACE"," ",1561],["T_FUNCTION","function",1561],["T_WHITESPACE"," ",1561],["T_STRING","getLabel",1561],"(",")",["T_WHITESPACE","\n    ",1561],"{",["T_WHITESPACE","\n        ",1562],["T_RETURN","return",1563],["T_WHITESPACE"," ",1563],["T_STRING","Mage",1563],["T_DOUBLE_COLON","::",1563],["T_STRING","helper",1563],"(",["T_CONSTANT_ENCAPSED_STRING","'tax'",1563],")",["T_OBJECT_OPERATOR","->",1563],["T_STRING","__",1563],"(",["T_CONSTANT_ENCAPSED_STRING","'Tax'",1563],")",";",["T_WHITESPACE","\n    ",1563],"}",["T_WHITESPACE","\n",1564],"}",["T_WHITESPACE","\n",1565]]