[["T_OPEN_TAG","<?php\n",1],["T_DOC_COMMENT","\/**\n * Magento\n *\n * NOTICE OF LICENSE\n *\n * This source file is subject to the Open Software License (OSL 3.0)\n * that is bundled with this package in the file LICENSE.txt.\n * It is also available through the world-wide-web at this URL:\n * http:\/\/opensource.org\/licenses\/osl-3.0.php\n * If you did not receive a copy of the license and are unable to\n * obtain it through the world-wide-web, please send an email\n * to license@magento.com so we can send you a copy immediately.\n *\n * DISCLAIMER\n *\n * Do not edit or add to this file if you wish to upgrade Magento to newer\n * versions in the future. If you wish to customize Magento for your\n * needs please refer to http:\/\/www.magento.com for more information.\n *\n * @category    Mage\n * @package     Mage_Tax\n * @copyright  Copyright (c) 2006-2016 X.commerce, Inc. and affiliates (http:\/\/www.magento.com)\n * @license    http:\/\/opensource.org\/licenses\/osl-3.0.php  Open Software License (OSL 3.0)\n *\/",2],["T_WHITESPACE","\n\n",25],["T_DOC_COMMENT","\/**\n * Tax Event Observer\n *\n * @author Magento Core Team <core@magentocommerce.com>\n *\/",27],["T_WHITESPACE","\n",31],["T_CLASS","class",32],["T_WHITESPACE"," ",32],["T_STRING","Mage_Tax_Model_Observer",32],["T_WHITESPACE","\n",32],"{",["T_WHITESPACE","\n    ",33],["T_DOC_COMMENT","\/**\n     * Put quote address tax information into order\n     *\n     * @param Varien_Event_Observer $observer\n     *\/",34],["T_WHITESPACE","\n    ",38],["T_PUBLIC","public",39],["T_WHITESPACE"," ",39],["T_FUNCTION","function",39],["T_WHITESPACE"," ",39],["T_STRING","salesEventConvertQuoteAddressToOrder",39],"(",["T_STRING","Varien_Event_Observer",39],["T_WHITESPACE"," ",39],["T_VARIABLE","$observer",39],")",["T_WHITESPACE","\n    ",39],"{",["T_WHITESPACE","\n        ",40],["T_VARIABLE","$address",41],["T_WHITESPACE"," ",41],"=",["T_WHITESPACE"," ",41],["T_VARIABLE","$observer",41],["T_OBJECT_OPERATOR","->",41],["T_STRING","getEvent",41],"(",")",["T_OBJECT_OPERATOR","->",41],["T_STRING","getAddress",41],"(",")",";",["T_WHITESPACE","\n        ",41],["T_VARIABLE","$order",42],["T_WHITESPACE"," ",42],"=",["T_WHITESPACE"," ",42],["T_VARIABLE","$observer",42],["T_OBJECT_OPERATOR","->",42],["T_STRING","getEvent",42],"(",")",["T_OBJECT_OPERATOR","->",42],["T_STRING","getOrder",42],"(",")",";",["T_WHITESPACE","\n\n        ",42],["T_VARIABLE","$taxes",44],["T_WHITESPACE"," ",44],"=",["T_WHITESPACE"," ",44],["T_VARIABLE","$address",44],["T_OBJECT_OPERATOR","->",44],["T_STRING","getAppliedTaxes",44],"(",")",";",["T_WHITESPACE","\n        ",44],["T_IF","if",45],["T_WHITESPACE"," ",45],"(",["T_STRING","is_array",45],"(",["T_VARIABLE","$taxes",45],")",")",["T_WHITESPACE"," ",45],"{",["T_WHITESPACE","\n            ",45],["T_IF","if",46],["T_WHITESPACE"," ",46],"(",["T_STRING","is_array",46],"(",["T_VARIABLE","$order",46],["T_OBJECT_OPERATOR","->",46],["T_STRING","getAppliedTaxes",46],"(",")",")",")",["T_WHITESPACE"," ",46],"{",["T_WHITESPACE","\n                ",46],["T_VARIABLE","$taxes",47],["T_WHITESPACE"," ",47],"=",["T_WHITESPACE"," ",47],["T_STRING","array_merge",47],"(",["T_VARIABLE","$order",47],["T_OBJECT_OPERATOR","->",47],["T_STRING","getAppliedTaxes",47],"(",")",",",["T_WHITESPACE"," ",47],["T_VARIABLE","$taxes",47],")",";",["T_WHITESPACE","\n            ",47],"}",["T_WHITESPACE","\n            ",48],["T_VARIABLE","$order",49],["T_OBJECT_OPERATOR","->",49],["T_STRING","setAppliedTaxes",49],"(",["T_VARIABLE","$taxes",49],")",";",["T_WHITESPACE","\n            ",49],["T_VARIABLE","$order",50],["T_OBJECT_OPERATOR","->",50],["T_STRING","setConvertingFromQuote",50],"(",["T_STRING","true",50],")",";",["T_WHITESPACE","\n        ",50],"}",["T_WHITESPACE","\n    ",51],"}",["T_WHITESPACE","\n\n    ",52],["T_DOC_COMMENT","\/**\n     * Save order tax information\n     *\n     * @param Varien_Event_Observer $observer\n     *\/",54],["T_WHITESPACE","\n    ",58],["T_PUBLIC","public",59],["T_WHITESPACE"," ",59],["T_FUNCTION","function",59],["T_WHITESPACE"," ",59],["T_STRING","salesEventOrderAfterSave",59],"(",["T_STRING","Varien_Event_Observer",59],["T_WHITESPACE"," ",59],["T_VARIABLE","$observer",59],")",["T_WHITESPACE","\n    ",59],"{",["T_WHITESPACE","\n        ",60],["T_VARIABLE","$order",61],["T_WHITESPACE"," ",61],"=",["T_WHITESPACE"," ",61],["T_VARIABLE","$observer",61],["T_OBJECT_OPERATOR","->",61],["T_STRING","getEvent",61],"(",")",["T_OBJECT_OPERATOR","->",61],["T_STRING","getOrder",61],"(",")",";",["T_WHITESPACE","\n\n        ",61],["T_IF","if",63],["T_WHITESPACE"," ",63],"(","!",["T_VARIABLE","$order",63],["T_OBJECT_OPERATOR","->",63],["T_STRING","getConvertingFromQuote",63],"(",")",["T_WHITESPACE"," ",63],["T_BOOLEAN_OR","||",63],["T_WHITESPACE"," ",63],["T_VARIABLE","$order",63],["T_OBJECT_OPERATOR","->",63],["T_STRING","getAppliedTaxIsSaved",63],"(",")",")",["T_WHITESPACE"," ",63],"{",["T_WHITESPACE","\n            ",63],["T_RETURN","return",64],";",["T_WHITESPACE","\n        ",64],"}",["T_WHITESPACE","\n\n        ",65],["T_VARIABLE","$getTaxesForItems",67],["T_WHITESPACE","   ",67],"=",["T_WHITESPACE"," ",67],["T_VARIABLE","$order",67],["T_OBJECT_OPERATOR","->",67],["T_STRING","getQuote",67],"(",")",["T_OBJECT_OPERATOR","->",67],["T_STRING","getTaxesForItems",67],"(",")",";",["T_WHITESPACE","\n        ",67],["T_VARIABLE","$taxes",68],["T_WHITESPACE","              ",68],"=",["T_WHITESPACE"," ",68],["T_VARIABLE","$order",68],["T_OBJECT_OPERATOR","->",68],["T_STRING","getAppliedTaxes",68],"(",")",";",["T_WHITESPACE","\n\n        ",68],["T_VARIABLE","$ratesIdQuoteItemId",70],["T_WHITESPACE"," ",70],"=",["T_WHITESPACE"," ",70],["T_ARRAY","array",70],"(",")",";",["T_WHITESPACE","\n        ",70],["T_IF","if",71],["T_WHITESPACE"," ",71],"(","!",["T_STRING","is_array",71],"(",["T_VARIABLE","$getTaxesForItems",71],")",")",["T_WHITESPACE"," ",71],"{",["T_WHITESPACE","\n            ",71],["T_VARIABLE","$getTaxesForItems",72],["T_WHITESPACE"," ",72],"=",["T_WHITESPACE"," ",72],["T_ARRAY","array",72],"(",")",";",["T_WHITESPACE","\n        ",72],"}",["T_WHITESPACE","\n        ",73],["T_FOREACH","foreach",74],["T_WHITESPACE"," ",74],"(",["T_VARIABLE","$getTaxesForItems",74],["T_WHITESPACE"," ",74],["T_AS","as",74],["T_WHITESPACE"," ",74],["T_VARIABLE","$quoteItemId",74],["T_WHITESPACE"," ",74],["T_DOUBLE_ARROW","=>",74],["T_WHITESPACE"," ",74],["T_VARIABLE","$taxesArray",74],")",["T_WHITESPACE"," ",74],"{",["T_WHITESPACE","\n            ",74],["T_FOREACH","foreach",75],["T_WHITESPACE"," ",75],"(",["T_VARIABLE","$taxesArray",75],["T_WHITESPACE"," ",75],["T_AS","as",75],["T_WHITESPACE"," ",75],["T_VARIABLE","$rates",75],")",["T_WHITESPACE"," ",75],"{",["T_WHITESPACE","\n                ",75],["T_IF","if",76],["T_WHITESPACE"," ",76],"(",["T_STRING","count",76],"(",["T_VARIABLE","$rates",76],"[",["T_CONSTANT_ENCAPSED_STRING","'rates'",76],"]",")",["T_WHITESPACE"," ",76],["T_IS_EQUAL","==",76],["T_WHITESPACE"," ",76],["T_LNUMBER","1",76],")",["T_WHITESPACE"," ",76],"{",["T_WHITESPACE","\n                    ",76],["T_VARIABLE","$ratesIdQuoteItemId",77],"[",["T_VARIABLE","$rates",77],"[",["T_CONSTANT_ENCAPSED_STRING","'id'",77],"]","]","[","]",["T_WHITESPACE"," ",77],"=",["T_WHITESPACE"," ",77],["T_ARRAY","array",77],"(",["T_WHITESPACE","\n                        ",77],["T_CONSTANT_ENCAPSED_STRING","'id'",78],["T_WHITESPACE","        ",78],["T_DOUBLE_ARROW","=>",78],["T_WHITESPACE"," ",78],["T_VARIABLE","$quoteItemId",78],",",["T_WHITESPACE","\n                        ",78],["T_CONSTANT_ENCAPSED_STRING","'percent'",79],["T_WHITESPACE","   ",79],["T_DOUBLE_ARROW","=>",79],["T_WHITESPACE"," ",79],["T_VARIABLE","$rates",79],"[",["T_CONSTANT_ENCAPSED_STRING","'percent'",79],"]",",",["T_WHITESPACE","\n                        ",79],["T_CONSTANT_ENCAPSED_STRING","'code'",80],["T_WHITESPACE","      ",80],["T_DOUBLE_ARROW","=>",80],["T_WHITESPACE"," ",80],["T_VARIABLE","$rates",80],"[",["T_CONSTANT_ENCAPSED_STRING","'rates'",80],"]","[",["T_LNUMBER","0",80],"]","[",["T_CONSTANT_ENCAPSED_STRING","'code'",80],"]",["T_WHITESPACE","\n                    ",80],")",";",["T_WHITESPACE","\n                ",81],"}",["T_WHITESPACE"," ",82],["T_ELSE","else",82],["T_WHITESPACE"," ",82],"{",["T_WHITESPACE","\n                    ",82],["T_VARIABLE","$percentDelta",83],["T_WHITESPACE","   ",83],"=",["T_WHITESPACE"," ",83],["T_VARIABLE","$rates",83],"[",["T_CONSTANT_ENCAPSED_STRING","'percent'",83],"]",";",["T_WHITESPACE","\n                    ",83],["T_VARIABLE","$percentSum",84],["T_WHITESPACE","     ",84],"=",["T_WHITESPACE"," ",84],["T_LNUMBER","0",84],";",["T_WHITESPACE","\n                    ",84],["T_FOREACH","foreach",85],["T_WHITESPACE"," ",85],"(",["T_VARIABLE","$rates",85],"[",["T_CONSTANT_ENCAPSED_STRING","'rates'",85],"]",["T_WHITESPACE"," ",85],["T_AS","as",85],["T_WHITESPACE"," ",85],["T_VARIABLE","$rate",85],")",["T_WHITESPACE"," ",85],"{",["T_WHITESPACE","\n                        ",85],["T_VARIABLE","$ratesIdQuoteItemId",86],"[",["T_VARIABLE","$rates",86],"[",["T_CONSTANT_ENCAPSED_STRING","'id'",86],"]","]","[","]",["T_WHITESPACE"," ",86],"=",["T_WHITESPACE"," ",86],["T_ARRAY","array",86],"(",["T_WHITESPACE","\n                            ",86],["T_CONSTANT_ENCAPSED_STRING","'id'",87],["T_WHITESPACE","        ",87],["T_DOUBLE_ARROW","=>",87],["T_WHITESPACE"," ",87],["T_VARIABLE","$quoteItemId",87],",",["T_WHITESPACE","\n                            ",87],["T_CONSTANT_ENCAPSED_STRING","'percent'",88],["T_WHITESPACE","   ",88],["T_DOUBLE_ARROW","=>",88],["T_WHITESPACE"," ",88],["T_VARIABLE","$rate",88],"[",["T_CONSTANT_ENCAPSED_STRING","'percent'",88],"]",",",["T_WHITESPACE","\n                            ",88],["T_CONSTANT_ENCAPSED_STRING","'code'",89],["T_WHITESPACE","      ",89],["T_DOUBLE_ARROW","=>",89],["T_WHITESPACE"," ",89],["T_VARIABLE","$rate",89],"[",["T_CONSTANT_ENCAPSED_STRING","'code'",89],"]",["T_WHITESPACE","\n                        ",89],")",";",["T_WHITESPACE","\n                        ",90],["T_VARIABLE","$percentSum",91],["T_WHITESPACE"," ",91],["T_PLUS_EQUAL","+=",91],["T_WHITESPACE"," ",91],["T_VARIABLE","$rate",91],"[",["T_CONSTANT_ENCAPSED_STRING","'percent'",91],"]",";",["T_WHITESPACE","\n                    ",91],"}",["T_WHITESPACE","\n\n                    ",92],["T_IF","if",94],["T_WHITESPACE"," ",94],"(",["T_VARIABLE","$percentDelta",94],["T_WHITESPACE"," ",94],["T_IS_NOT_EQUAL","!=",94],["T_WHITESPACE"," ",94],["T_VARIABLE","$percentSum",94],")",["T_WHITESPACE"," ",94],"{",["T_WHITESPACE","\n                        ",94],["T_VARIABLE","$delta",95],["T_WHITESPACE"," ",95],"=",["T_WHITESPACE"," ",95],["T_VARIABLE","$percentDelta",95],["T_WHITESPACE"," ",95],"-",["T_WHITESPACE"," ",95],["T_VARIABLE","$percentSum",95],";",["T_WHITESPACE","\n                        ",95],["T_FOREACH","foreach",96],["T_WHITESPACE"," ",96],"(",["T_VARIABLE","$ratesIdQuoteItemId",96],"[",["T_VARIABLE","$rates",96],"[",["T_CONSTANT_ENCAPSED_STRING","'id'",96],"]","]",["T_WHITESPACE"," ",96],["T_AS","as",96],["T_WHITESPACE"," ",96],"&",["T_VARIABLE","$rateTax",96],")",["T_WHITESPACE"," ",96],"{",["T_WHITESPACE","\n                            ",96],["T_IF","if",97],["T_WHITESPACE"," ",97],"(",["T_VARIABLE","$rateTax",97],"[",["T_CONSTANT_ENCAPSED_STRING","'id'",97],"]",["T_WHITESPACE"," ",97],["T_IS_EQUAL","==",97],["T_WHITESPACE"," ",97],["T_VARIABLE","$quoteItemId",97],")",["T_WHITESPACE"," ",97],"{",["T_WHITESPACE","\n                                ",97],["T_VARIABLE","$rateTax",98],"[",["T_CONSTANT_ENCAPSED_STRING","'percent'",98],"]",["T_WHITESPACE"," ",98],"=",["T_WHITESPACE"," ",98],"(","(",["T_VARIABLE","$rateTax",98],"[",["T_CONSTANT_ENCAPSED_STRING","'percent'",98],"]",["T_WHITESPACE"," ",98],"\/",["T_WHITESPACE"," ",98],["T_VARIABLE","$percentSum",98],")",["T_WHITESPACE"," ",98],"*",["T_WHITESPACE"," ",98],["T_VARIABLE","$delta",98],")",["T_WHITESPACE","\n                                        ",98],"+",["T_WHITESPACE"," ",99],["T_VARIABLE","$rateTax",99],"[",["T_CONSTANT_ENCAPSED_STRING","'percent'",99],"]",";",["T_WHITESPACE","\n                            ",99],"}",["T_WHITESPACE","\n                        ",100],"}",["T_WHITESPACE","\n                    ",101],"}",["T_WHITESPACE","\n                ",102],"}",["T_WHITESPACE","\n            ",103],"}",["T_WHITESPACE","\n        ",104],"}",["T_WHITESPACE","\n\n        ",105],["T_FOREACH","foreach",107],["T_WHITESPACE"," ",107],"(",["T_VARIABLE","$taxes",107],["T_WHITESPACE"," ",107],["T_AS","as",107],["T_WHITESPACE"," ",107],["T_VARIABLE","$id",107],["T_WHITESPACE"," ",107],["T_DOUBLE_ARROW","=>",107],["T_WHITESPACE"," ",107],["T_VARIABLE","$row",107],")",["T_WHITESPACE"," ",107],"{",["T_WHITESPACE","\n            ",107],["T_FOREACH","foreach",108],["T_WHITESPACE"," ",108],"(",["T_VARIABLE","$row",108],"[",["T_CONSTANT_ENCAPSED_STRING","'rates'",108],"]",["T_WHITESPACE"," ",108],["T_AS","as",108],["T_WHITESPACE"," ",108],["T_VARIABLE","$tax",108],")",["T_WHITESPACE"," ",108],"{",["T_WHITESPACE","\n                ",108],["T_IF","if",109],["T_WHITESPACE"," ",109],"(",["T_STRING","is_null",109],"(",["T_VARIABLE","$row",109],"[",["T_CONSTANT_ENCAPSED_STRING","'percent'",109],"]",")",")",["T_WHITESPACE"," ",109],"{",["T_WHITESPACE","\n                    ",109],["T_VARIABLE","$baseRealAmount",110],["T_WHITESPACE"," ",110],"=",["T_WHITESPACE"," ",110],["T_VARIABLE","$row",110],"[",["T_CONSTANT_ENCAPSED_STRING","'base_amount'",110],"]",";",["T_WHITESPACE","\n                ",110],"}",["T_WHITESPACE"," ",111],["T_ELSE","else",111],["T_WHITESPACE"," ",111],"{",["T_WHITESPACE","\n                    ",111],["T_IF","if",112],["T_WHITESPACE"," ",112],"(",["T_VARIABLE","$row",112],"[",["T_CONSTANT_ENCAPSED_STRING","'percent'",112],"]",["T_WHITESPACE"," ",112],["T_IS_EQUAL","==",112],["T_WHITESPACE"," ",112],["T_LNUMBER","0",112],["T_WHITESPACE"," ",112],["T_BOOLEAN_OR","||",112],["T_WHITESPACE"," ",112],["T_VARIABLE","$tax",112],"[",["T_CONSTANT_ENCAPSED_STRING","'percent'",112],"]",["T_WHITESPACE"," ",112],["T_IS_EQUAL","==",112],["T_WHITESPACE"," ",112],["T_LNUMBER","0",112],")",["T_WHITESPACE"," ",112],"{",["T_WHITESPACE","\n                        ",112],["T_CONTINUE","continue",113],";",["T_WHITESPACE","\n                    ",113],"}",["T_WHITESPACE","\n                    ",114],["T_VARIABLE","$baseRealAmount",115],["T_WHITESPACE"," ",115],"=",["T_WHITESPACE"," ",115],["T_VARIABLE","$row",115],"[",["T_CONSTANT_ENCAPSED_STRING","'base_amount'",115],"]",["T_WHITESPACE"," ",115],"\/",["T_WHITESPACE"," ",115],["T_VARIABLE","$row",115],"[",["T_CONSTANT_ENCAPSED_STRING","'percent'",115],"]",["T_WHITESPACE"," ",115],"*",["T_WHITESPACE"," ",115],["T_VARIABLE","$tax",115],"[",["T_CONSTANT_ENCAPSED_STRING","'percent'",115],"]",";",["T_WHITESPACE","\n                ",115],"}",["T_WHITESPACE","\n                ",116],["T_VARIABLE","$hidden",117],["T_WHITESPACE"," ",117],"=",["T_WHITESPACE"," ",117],"(",["T_ISSET","isset",117],"(",["T_VARIABLE","$row",117],"[",["T_CONSTANT_ENCAPSED_STRING","'hidden'",117],"]",")",["T_WHITESPACE"," ",117],"?",["T_WHITESPACE"," ",117],["T_VARIABLE","$row",117],"[",["T_CONSTANT_ENCAPSED_STRING","'hidden'",117],"]",["T_WHITESPACE"," ",117],":",["T_WHITESPACE"," ",117],["T_LNUMBER","0",117],")",";",["T_WHITESPACE","\n                ",117],["T_VARIABLE","$data",118],["T_WHITESPACE"," ",118],"=",["T_WHITESPACE"," ",118],["T_ARRAY","array",118],"(",["T_WHITESPACE","\n                    ",118],["T_CONSTANT_ENCAPSED_STRING","'order_id'",119],["T_WHITESPACE","          ",119],["T_DOUBLE_ARROW","=>",119],["T_WHITESPACE"," ",119],["T_VARIABLE","$order",119],["T_OBJECT_OPERATOR","->",119],["T_STRING","getId",119],"(",")",",",["T_WHITESPACE","\n                    ",119],["T_CONSTANT_ENCAPSED_STRING","'code'",120],["T_WHITESPACE","              ",120],["T_DOUBLE_ARROW","=>",120],["T_WHITESPACE"," ",120],["T_VARIABLE","$tax",120],"[",["T_CONSTANT_ENCAPSED_STRING","'code'",120],"]",",",["T_WHITESPACE","\n                    ",120],["T_CONSTANT_ENCAPSED_STRING","'title'",121],["T_WHITESPACE","             ",121],["T_DOUBLE_ARROW","=>",121],["T_WHITESPACE"," ",121],["T_VARIABLE","$tax",121],"[",["T_CONSTANT_ENCAPSED_STRING","'title'",121],"]",",",["T_WHITESPACE","\n                    ",121],["T_CONSTANT_ENCAPSED_STRING","'hidden'",122],["T_WHITESPACE","            ",122],["T_DOUBLE_ARROW","=>",122],["T_WHITESPACE"," ",122],["T_VARIABLE","$hidden",122],",",["T_WHITESPACE","\n                    ",122],["T_CONSTANT_ENCAPSED_STRING","'percent'",123],["T_WHITESPACE","           ",123],["T_DOUBLE_ARROW","=>",123],["T_WHITESPACE"," ",123],["T_VARIABLE","$tax",123],"[",["T_CONSTANT_ENCAPSED_STRING","'percent'",123],"]",",",["T_WHITESPACE","\n                    ",123],["T_CONSTANT_ENCAPSED_STRING","'priority'",124],["T_WHITESPACE","          ",124],["T_DOUBLE_ARROW","=>",124],["T_WHITESPACE"," ",124],["T_VARIABLE","$tax",124],"[",["T_CONSTANT_ENCAPSED_STRING","'priority'",124],"]",",",["T_WHITESPACE","\n                    ",124],["T_CONSTANT_ENCAPSED_STRING","'position'",125],["T_WHITESPACE","          ",125],["T_DOUBLE_ARROW","=>",125],["T_WHITESPACE"," ",125],["T_VARIABLE","$tax",125],"[",["T_CONSTANT_ENCAPSED_STRING","'position'",125],"]",",",["T_WHITESPACE","\n                    ",125],["T_CONSTANT_ENCAPSED_STRING","'amount'",126],["T_WHITESPACE","            ",126],["T_DOUBLE_ARROW","=>",126],["T_WHITESPACE"," ",126],["T_VARIABLE","$row",126],"[",["T_CONSTANT_ENCAPSED_STRING","'amount'",126],"]",",",["T_WHITESPACE","\n                    ",126],["T_CONSTANT_ENCAPSED_STRING","'base_amount'",127],["T_WHITESPACE","       ",127],["T_DOUBLE_ARROW","=>",127],["T_WHITESPACE"," ",127],["T_VARIABLE","$row",127],"[",["T_CONSTANT_ENCAPSED_STRING","'base_amount'",127],"]",",",["T_WHITESPACE","\n                    ",127],["T_CONSTANT_ENCAPSED_STRING","'process'",128],["T_WHITESPACE","           ",128],["T_DOUBLE_ARROW","=>",128],["T_WHITESPACE"," ",128],["T_VARIABLE","$row",128],"[",["T_CONSTANT_ENCAPSED_STRING","'process'",128],"]",",",["T_WHITESPACE","\n                    ",128],["T_CONSTANT_ENCAPSED_STRING","'base_real_amount'",129],["T_WHITESPACE","  ",129],["T_DOUBLE_ARROW","=>",129],["T_WHITESPACE"," ",129],["T_VARIABLE","$baseRealAmount",129],",",["T_WHITESPACE","\n                ",129],")",";",["T_WHITESPACE","\n\n                ",130],["T_VARIABLE","$result",132],["T_WHITESPACE"," ",132],"=",["T_WHITESPACE"," ",132],["T_STRING","Mage",132],["T_DOUBLE_COLON","::",132],["T_STRING","getModel",132],"(",["T_CONSTANT_ENCAPSED_STRING","'tax\/sales_order_tax'",132],")",["T_OBJECT_OPERATOR","->",132],["T_STRING","setData",132],"(",["T_VARIABLE","$data",132],")",["T_OBJECT_OPERATOR","->",132],["T_STRING","save",132],"(",")",";",["T_WHITESPACE","\n\n                ",132],["T_IF","if",134],["T_WHITESPACE"," ",134],"(",["T_ISSET","isset",134],"(",["T_VARIABLE","$ratesIdQuoteItemId",134],"[",["T_VARIABLE","$id",134],"]",")",")",["T_WHITESPACE"," ",134],"{",["T_WHITESPACE","\n                    ",134],["T_FOREACH","foreach",135],["T_WHITESPACE"," ",135],"(",["T_VARIABLE","$ratesIdQuoteItemId",135],"[",["T_VARIABLE","$id",135],"]",["T_WHITESPACE"," ",135],["T_AS","as",135],["T_WHITESPACE"," ",135],["T_VARIABLE","$quoteItemId",135],")",["T_WHITESPACE"," ",135],"{",["T_WHITESPACE","\n                        ",135],["T_IF","if",136],["T_WHITESPACE"," ",136],"(",["T_VARIABLE","$quoteItemId",136],"[",["T_CONSTANT_ENCAPSED_STRING","'code'",136],"]",["T_WHITESPACE"," ",136],["T_IS_EQUAL","==",136],["T_WHITESPACE"," ",136],["T_VARIABLE","$tax",136],"[",["T_CONSTANT_ENCAPSED_STRING","'code'",136],"]",")",["T_WHITESPACE"," ",136],"{",["T_WHITESPACE","\n                            ",136],["T_VARIABLE","$item",137],["T_WHITESPACE"," ",137],"=",["T_WHITESPACE"," ",137],["T_VARIABLE","$order",137],["T_OBJECT_OPERATOR","->",137],["T_STRING","getItemByQuoteItemId",137],"(",["T_VARIABLE","$quoteItemId",137],"[",["T_CONSTANT_ENCAPSED_STRING","'id'",137],"]",")",";",["T_WHITESPACE","\n                            ",137],["T_IF","if",138],["T_WHITESPACE"," ",138],"(",["T_VARIABLE","$item",138],")",["T_WHITESPACE"," ",138],"{",["T_WHITESPACE","\n                                ",138],["T_VARIABLE","$data",139],["T_WHITESPACE"," ",139],"=",["T_WHITESPACE"," ",139],["T_ARRAY","array",139],"(",["T_WHITESPACE","\n                                    ",139],["T_CONSTANT_ENCAPSED_STRING","'item_id'",140],["T_WHITESPACE","       ",140],["T_DOUBLE_ARROW","=>",140],["T_WHITESPACE"," ",140],["T_VARIABLE","$item",140],["T_OBJECT_OPERATOR","->",140],["T_STRING","getId",140],"(",")",",",["T_WHITESPACE","\n                                    ",140],["T_CONSTANT_ENCAPSED_STRING","'tax_id'",141],["T_WHITESPACE","        ",141],["T_DOUBLE_ARROW","=>",141],["T_WHITESPACE"," ",141],["T_VARIABLE","$result",141],["T_OBJECT_OPERATOR","->",141],["T_STRING","getTaxId",141],"(",")",",",["T_WHITESPACE","\n                                    ",141],["T_CONSTANT_ENCAPSED_STRING","'tax_percent'",142],["T_WHITESPACE","   ",142],["T_DOUBLE_ARROW","=>",142],["T_WHITESPACE"," ",142],["T_VARIABLE","$quoteItemId",142],"[",["T_CONSTANT_ENCAPSED_STRING","'percent'",142],"]",["T_WHITESPACE","\n                                ",142],")",";",["T_WHITESPACE","\n                                ",143],["T_STRING","Mage",144],["T_DOUBLE_COLON","::",144],["T_STRING","getModel",144],"(",["T_CONSTANT_ENCAPSED_STRING","'tax\/sales_order_tax_item'",144],")",["T_OBJECT_OPERATOR","->",144],["T_STRING","setData",144],"(",["T_VARIABLE","$data",144],")",["T_OBJECT_OPERATOR","->",144],["T_STRING","save",144],"(",")",";",["T_WHITESPACE","\n                            ",144],"}",["T_WHITESPACE","\n                        ",145],"}",["T_WHITESPACE","\n                    ",146],"}",["T_WHITESPACE","\n                ",147],"}",["T_WHITESPACE","\n            ",148],"}",["T_WHITESPACE","\n        ",149],"}",["T_WHITESPACE","\n\n        ",150],["T_VARIABLE","$order",152],["T_OBJECT_OPERATOR","->",152],["T_STRING","setAppliedTaxIsSaved",152],"(",["T_STRING","true",152],")",";",["T_WHITESPACE","\n    ",152],"}",["T_WHITESPACE","\n\n    ",153],["T_DOC_COMMENT","\/**\n     * Prepare select which is using to select index data for layered navigation\n     *\n     * @param   Varien_Event_Observer $observer\n     * @return  Mage_Tax_Model_Observer\n     *\/",155],["T_WHITESPACE","\n    ",160],["T_PUBLIC","public",161],["T_WHITESPACE"," ",161],["T_FUNCTION","function",161],["T_WHITESPACE"," ",161],["T_STRING","prepareCatalogIndexPriceSelect",161],"(",["T_STRING","Varien_Event_Observer",161],["T_WHITESPACE"," ",161],["T_VARIABLE","$observer",161],")",["T_WHITESPACE","\n    ",161],"{",["T_WHITESPACE","\n        ",162],["T_VARIABLE","$table",163],["T_WHITESPACE"," ",163],"=",["T_WHITESPACE"," ",163],["T_VARIABLE","$observer",163],["T_OBJECT_OPERATOR","->",163],["T_STRING","getEvent",163],"(",")",["T_OBJECT_OPERATOR","->",163],["T_STRING","getTable",163],"(",")",";",["T_WHITESPACE","\n        ",163],["T_VARIABLE","$response",164],["T_WHITESPACE"," ",164],"=",["T_WHITESPACE"," ",164],["T_VARIABLE","$observer",164],["T_OBJECT_OPERATOR","->",164],["T_STRING","getEvent",164],"(",")",["T_OBJECT_OPERATOR","->",164],["T_STRING","getResponseObject",164],"(",")",";",["T_WHITESPACE","\n        ",164],["T_VARIABLE","$select",165],["T_WHITESPACE"," ",165],"=",["T_WHITESPACE"," ",165],["T_VARIABLE","$observer",165],["T_OBJECT_OPERATOR","->",165],["T_STRING","getEvent",165],"(",")",["T_OBJECT_OPERATOR","->",165],["T_STRING","getSelect",165],"(",")",";",["T_WHITESPACE","\n        ",165],["T_VARIABLE","$storeId",166],["T_WHITESPACE"," ",166],"=",["T_WHITESPACE"," ",166],["T_VARIABLE","$observer",166],["T_OBJECT_OPERATOR","->",166],["T_STRING","getEvent",166],"(",")",["T_OBJECT_OPERATOR","->",166],["T_STRING","getStoreId",166],"(",")",";",["T_WHITESPACE","\n\n        ",166],["T_VARIABLE","$additionalCalculations",168],["T_WHITESPACE"," ",168],"=",["T_WHITESPACE"," ",168],["T_VARIABLE","$response",168],["T_OBJECT_OPERATOR","->",168],["T_STRING","getAdditionalCalculations",168],"(",")",";",["T_WHITESPACE","\n        ",168],["T_VARIABLE","$calculation",169],["T_WHITESPACE"," ",169],"=",["T_WHITESPACE"," ",169],["T_STRING","Mage",169],["T_DOUBLE_COLON","::",169],["T_STRING","helper",169],"(",["T_CONSTANT_ENCAPSED_STRING","'tax'",169],")",["T_OBJECT_OPERATOR","->",169],["T_STRING","getPriceTaxSql",169],"(",["T_WHITESPACE","\n            ",169],["T_VARIABLE","$table",170],["T_WHITESPACE"," ",170],".",["T_WHITESPACE"," ",170],["T_CONSTANT_ENCAPSED_STRING","'.min_price'",170],",",["T_WHITESPACE"," ",170],["T_VARIABLE","$table",170],".",["T_CONSTANT_ENCAPSED_STRING","'.tax_class_id'",170],["T_WHITESPACE","\n        ",170],")",";",["T_WHITESPACE","\n\n        ",171],["T_IF","if",173],["T_WHITESPACE"," ",173],"(","!",["T_EMPTY","empty",173],"(",["T_VARIABLE","$calculation",173],")",")",["T_WHITESPACE"," ",173],"{",["T_WHITESPACE","\n            ",173],["T_VARIABLE","$additionalCalculations",174],"[","]",["T_WHITESPACE"," ",174],"=",["T_WHITESPACE"," ",174],["T_VARIABLE","$calculation",174],";",["T_WHITESPACE","\n            ",174],["T_VARIABLE","$response",175],["T_OBJECT_OPERATOR","->",175],["T_STRING","setAdditionalCalculations",175],"(",["T_VARIABLE","$additionalCalculations",175],")",";",["T_WHITESPACE","\n            ",175],["T_DOC_COMMENT","\/**\n             * Tax class presented in price index table\n             *\/",176],["T_WHITESPACE","\n            ",178],["T_COMMENT","\/\/Mage::helper('tax')->joinTaxClass($select, $storeId, $table);\n",179],["T_WHITESPACE","        ",180],"}",["T_WHITESPACE","\n\n        ",180],["T_RETURN","return",182],["T_WHITESPACE"," ",182],["T_VARIABLE","$this",182],";",["T_WHITESPACE","\n    ",182],"}",["T_WHITESPACE","\n\n    ",183],["T_DOC_COMMENT","\/**\n     * Add tax percent values to product collection items\n     *\n     * @param   Varien_Event_Observer $observer\n     * @return  Mage_Tax_Model_Observer\n     *\/",185],["T_WHITESPACE","\n    ",190],["T_PUBLIC","public",191],["T_WHITESPACE"," ",191],["T_FUNCTION","function",191],["T_WHITESPACE"," ",191],["T_STRING","addTaxPercentToProductCollection",191],"(",["T_VARIABLE","$observer",191],")",["T_WHITESPACE","\n    ",191],"{",["T_WHITESPACE","\n        ",192],["T_VARIABLE","$helper",193],["T_WHITESPACE"," ",193],"=",["T_WHITESPACE"," ",193],["T_STRING","Mage",193],["T_DOUBLE_COLON","::",193],["T_STRING","helper",193],"(",["T_CONSTANT_ENCAPSED_STRING","'tax'",193],")",";",["T_WHITESPACE","\n        ",193],["T_VARIABLE","$collection",194],["T_WHITESPACE"," ",194],"=",["T_WHITESPACE"," ",194],["T_VARIABLE","$observer",194],["T_OBJECT_OPERATOR","->",194],["T_STRING","getEvent",194],"(",")",["T_OBJECT_OPERATOR","->",194],["T_STRING","getCollection",194],"(",")",";",["T_WHITESPACE","\n        ",194],["T_VARIABLE","$store",195],["T_WHITESPACE"," ",195],"=",["T_WHITESPACE"," ",195],["T_VARIABLE","$collection",195],["T_OBJECT_OPERATOR","->",195],["T_STRING","getStoreId",195],"(",")",";",["T_WHITESPACE","\n        ",195],["T_IF","if",196],["T_WHITESPACE"," ",196],"(","!",["T_VARIABLE","$helper",196],["T_OBJECT_OPERATOR","->",196],["T_STRING","needPriceConversion",196],"(",["T_VARIABLE","$store",196],")",")",["T_WHITESPACE"," ",196],"{",["T_WHITESPACE","\n            ",196],["T_RETURN","return",197],["T_WHITESPACE"," ",197],["T_VARIABLE","$this",197],";",["T_WHITESPACE","\n        ",197],"}",["T_WHITESPACE","\n\n        ",198],["T_IF","if",200],["T_WHITESPACE"," ",200],"(",["T_VARIABLE","$collection",200],["T_OBJECT_OPERATOR","->",200],["T_STRING","requireTaxPercent",200],"(",")",")",["T_WHITESPACE"," ",200],"{",["T_WHITESPACE","\n            ",200],["T_VARIABLE","$request",201],["T_WHITESPACE"," ",201],"=",["T_WHITESPACE"," ",201],["T_STRING","Mage",201],["T_DOUBLE_COLON","::",201],["T_STRING","getSingleton",201],"(",["T_CONSTANT_ENCAPSED_STRING","'tax\/calculation'",201],")",["T_OBJECT_OPERATOR","->",201],["T_STRING","getRateRequest",201],"(",")",";",["T_WHITESPACE","\n            ",201],["T_FOREACH","foreach",202],["T_WHITESPACE"," ",202],"(",["T_VARIABLE","$collection",202],["T_WHITESPACE"," ",202],["T_AS","as",202],["T_WHITESPACE"," ",202],["T_VARIABLE","$item",202],")",["T_WHITESPACE"," ",202],"{",["T_WHITESPACE","\n                ",202],["T_IF","if",203],["T_WHITESPACE"," ",203],"(",["T_STRING","null",203],["T_WHITESPACE"," ",203],["T_IS_IDENTICAL","===",203],["T_WHITESPACE"," ",203],["T_VARIABLE","$item",203],["T_OBJECT_OPERATOR","->",203],["T_STRING","getTaxClassId",203],"(",")",")",["T_WHITESPACE"," ",203],"{",["T_WHITESPACE","\n                    ",203],["T_VARIABLE","$item",204],["T_OBJECT_OPERATOR","->",204],["T_STRING","setTaxClassId",204],"(",["T_VARIABLE","$item",204],["T_OBJECT_OPERATOR","->",204],["T_STRING","getMinimalTaxClassId",204],"(",")",")",";",["T_WHITESPACE","\n                ",204],"}",["T_WHITESPACE","\n                ",205],["T_IF","if",206],["T_WHITESPACE"," ",206],"(","!",["T_ISSET","isset",206],"(",["T_VARIABLE","$classToRate",206],"[",["T_VARIABLE","$item",206],["T_OBJECT_OPERATOR","->",206],["T_STRING","getTaxClassId",206],"(",")","]",")",")",["T_WHITESPACE"," ",206],"{",["T_WHITESPACE","\n                    ",206],["T_VARIABLE","$request",207],["T_OBJECT_OPERATOR","->",207],["T_STRING","setProductClassId",207],"(",["T_VARIABLE","$item",207],["T_OBJECT_OPERATOR","->",207],["T_STRING","getTaxClassId",207],"(",")",")",";",["T_WHITESPACE","\n                    ",207],["T_VARIABLE","$classToRate",208],"[",["T_VARIABLE","$item",208],["T_OBJECT_OPERATOR","->",208],["T_STRING","getTaxClassId",208],"(",")","]",["T_WHITESPACE"," ",208],"=",["T_WHITESPACE"," ",208],["T_STRING","Mage",208],["T_DOUBLE_COLON","::",208],["T_STRING","getSingleton",208],"(",["T_CONSTANT_ENCAPSED_STRING","'tax\/calculation'",208],")",["T_OBJECT_OPERATOR","->",208],["T_STRING","getRate",208],"(",["T_VARIABLE","$request",208],")",";",["T_WHITESPACE","\n                ",208],"}",["T_WHITESPACE","\n                ",209],["T_VARIABLE","$item",210],["T_OBJECT_OPERATOR","->",210],["T_STRING","setTaxPercent",210],"(",["T_VARIABLE","$classToRate",210],"[",["T_VARIABLE","$item",210],["T_OBJECT_OPERATOR","->",210],["T_STRING","getTaxClassId",210],"(",")","]",")",";",["T_WHITESPACE","\n            ",210],"}",["T_WHITESPACE","\n\n        ",211],"}",["T_WHITESPACE","\n        ",213],["T_RETURN","return",214],["T_WHITESPACE"," ",214],["T_VARIABLE","$this",214],";",["T_WHITESPACE","\n    ",214],"}",["T_WHITESPACE","\n\n    ",215],["T_DOC_COMMENT","\/**\n     * Refresh sales tax report statistics for last day\n     *\n     * @param Mage_Cron_Model_Schedule $schedule\n     * @return Mage_Tax_Model_Observer\n     *\/",217],["T_WHITESPACE","\n    ",222],["T_PUBLIC","public",223],["T_WHITESPACE"," ",223],["T_FUNCTION","function",223],["T_WHITESPACE"," ",223],["T_STRING","aggregateSalesReportTaxData",223],"(",["T_VARIABLE","$schedule",223],")",["T_WHITESPACE","\n    ",223],"{",["T_WHITESPACE","\n        ",224],["T_STRING","Mage",225],["T_DOUBLE_COLON","::",225],["T_STRING","app",225],"(",")",["T_OBJECT_OPERATOR","->",225],["T_STRING","getLocale",225],"(",")",["T_OBJECT_OPERATOR","->",225],["T_STRING","emulate",225],"(",["T_LNUMBER","0",225],")",";",["T_WHITESPACE","\n        ",225],["T_VARIABLE","$currentDate",226],["T_WHITESPACE"," ",226],"=",["T_WHITESPACE"," ",226],["T_STRING","Mage",226],["T_DOUBLE_COLON","::",226],["T_STRING","app",226],"(",")",["T_OBJECT_OPERATOR","->",226],["T_STRING","getLocale",226],"(",")",["T_OBJECT_OPERATOR","->",226],["T_STRING","date",226],"(",")",";",["T_WHITESPACE","\n        ",226],["T_VARIABLE","$date",227],["T_WHITESPACE"," ",227],"=",["T_WHITESPACE"," ",227],["T_VARIABLE","$currentDate",227],["T_OBJECT_OPERATOR","->",227],["T_STRING","subHour",227],"(",["T_LNUMBER","25",227],")",";",["T_WHITESPACE","\n        ",227],["T_STRING","Mage",228],["T_DOUBLE_COLON","::",228],["T_STRING","getResourceModel",228],"(",["T_CONSTANT_ENCAPSED_STRING","'tax\/report_tax'",228],")",["T_OBJECT_OPERATOR","->",228],["T_STRING","aggregate",228],"(",["T_VARIABLE","$date",228],")",";",["T_WHITESPACE","\n        ",228],["T_STRING","Mage",229],["T_DOUBLE_COLON","::",229],["T_STRING","app",229],"(",")",["T_OBJECT_OPERATOR","->",229],["T_STRING","getLocale",229],"(",")",["T_OBJECT_OPERATOR","->",229],["T_STRING","revert",229],"(",")",";",["T_WHITESPACE","\n        ",229],["T_RETURN","return",230],["T_WHITESPACE"," ",230],["T_VARIABLE","$this",230],";",["T_WHITESPACE","\n    ",230],"}",["T_WHITESPACE","\n\n    ",231],["T_DOC_COMMENT","\/**\n     * Reset extra tax amounts on quote addresses before recollecting totals\n     *\n     * @param Varien_Event_Observer $observer\n     * @return Mage_Tax_Model_Observer\n     *\/",233],["T_WHITESPACE","\n    ",238],["T_PUBLIC","public",239],["T_WHITESPACE"," ",239],["T_FUNCTION","function",239],["T_WHITESPACE"," ",239],["T_STRING","quoteCollectTotalsBefore",239],"(",["T_STRING","Varien_Event_Observer",239],["T_WHITESPACE"," ",239],["T_VARIABLE","$observer",239],")",["T_WHITESPACE","\n    ",239],"{",["T_WHITESPACE","\n        ",240],["T_COMMENT","\/* @var $quote Mage_Sales_Model_Quote *\/",241],["T_WHITESPACE","\n        ",241],["T_VARIABLE","$quote",242],["T_WHITESPACE"," ",242],"=",["T_WHITESPACE"," ",242],["T_VARIABLE","$observer",242],["T_OBJECT_OPERATOR","->",242],["T_STRING","getEvent",242],"(",")",["T_OBJECT_OPERATOR","->",242],["T_STRING","getQuote",242],"(",")",";",["T_WHITESPACE","\n        ",242],["T_FOREACH","foreach",243],["T_WHITESPACE"," ",243],"(",["T_VARIABLE","$quote",243],["T_OBJECT_OPERATOR","->",243],["T_STRING","getAllAddresses",243],"(",")",["T_WHITESPACE"," ",243],["T_AS","as",243],["T_WHITESPACE"," ",243],["T_VARIABLE","$address",243],")",["T_WHITESPACE"," ",243],"{",["T_WHITESPACE","\n            ",243],["T_VARIABLE","$address",244],["T_OBJECT_OPERATOR","->",244],["T_STRING","setExtraTaxAmount",244],"(",["T_LNUMBER","0",244],")",";",["T_WHITESPACE","\n            ",244],["T_VARIABLE","$address",245],["T_OBJECT_OPERATOR","->",245],["T_STRING","setBaseExtraTaxAmount",245],"(",["T_LNUMBER","0",245],")",";",["T_WHITESPACE","\n        ",245],"}",["T_WHITESPACE","\n        ",246],["T_RETURN","return",247],["T_WHITESPACE"," ",247],["T_VARIABLE","$this",247],";",["T_WHITESPACE","\n    ",247],"}",["T_WHITESPACE","\n",248],"}",["T_WHITESPACE","\n",249]]