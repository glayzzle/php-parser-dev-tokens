[["T_OPEN_TAG","<?php\n",1],["T_DOC_COMMENT","\/**\n * Magento\n *\n * NOTICE OF LICENSE\n *\n * This source file is subject to the Open Software License (OSL 3.0)\n * that is bundled with this package in the file LICENSE.txt.\n * It is also available through the world-wide-web at this URL:\n * http:\/\/opensource.org\/licenses\/osl-3.0.php\n * If you did not receive a copy of the license and are unable to\n * obtain it through the world-wide-web, please send an email\n * to license@magento.com so we can send you a copy immediately.\n *\n * DISCLAIMER\n *\n * Do not edit or add to this file if you wish to upgrade Magento to newer\n * versions in the future. If you wish to customize Magento for your\n * needs please refer to http:\/\/www.magento.com for more information.\n *\n * @category    Mage\n * @package     Mage_Tax\n * @copyright  Copyright (c) 2006-2016 X.commerce, Inc. and affiliates (http:\/\/www.magento.com)\n * @license    http:\/\/opensource.org\/licenses\/osl-3.0.php  Open Software License (OSL 3.0)\n *\/",2],["T_WHITESPACE","\n\n",25],["T_DOC_COMMENT","\/**\n * Calculate items and address amounts including\/excluding tax\n *\/",27],["T_WHITESPACE","\n",29],["T_CLASS","class",30],["T_WHITESPACE"," ",30],["T_STRING","Mage_Tax_Model_Sales_Total_Quote_Subtotal",30],["T_WHITESPACE"," ",30],["T_EXTENDS","extends",30],["T_WHITESPACE"," ",30],["T_STRING","Mage_Sales_Model_Quote_Address_Total_Abstract",30],["T_WHITESPACE","\n",30],"{",["T_WHITESPACE","\n    ",31],["T_DOC_COMMENT","\/**\n     * Tax calculation model\n     *\n     * @var Mage_Tax_Model_Calculation\n     *\/",32],["T_WHITESPACE","\n    ",36],["T_PROTECTED","protected",37],["T_WHITESPACE"," ",37],["T_VARIABLE","$_calculator",37],["T_WHITESPACE"," ",37],"=",["T_WHITESPACE"," ",37],["T_STRING","null",37],";",["T_WHITESPACE","\n\n    ",37],["T_DOC_COMMENT","\/**\n     * Tax configuration object\n     *\n     * @var Mage_Tax_Model_Config\n     *\/",39],["T_WHITESPACE","\n    ",43],["T_PROTECTED","protected",44],["T_WHITESPACE"," ",44],["T_VARIABLE","$_config",44],["T_WHITESPACE"," ",44],"=",["T_WHITESPACE"," ",44],["T_STRING","null",44],";",["T_WHITESPACE","\n\n    ",44],["T_DOC_COMMENT","\/**\n     * Tax helper instance\n     *\n     * @var Mage_Tax_Helper_Data|null\n     *\/",46],["T_WHITESPACE","\n    ",50],["T_PROTECTED","protected",51],["T_WHITESPACE"," ",51],["T_VARIABLE","$_helper",51],["T_WHITESPACE"," ",51],"=",["T_WHITESPACE"," ",51],["T_STRING","null",51],";",["T_WHITESPACE","\n\n    ",51],["T_DOC_COMMENT","\/**\n     * Default value for subtotal that include taxes\n     *\n     * @var float\n     *\/",53],["T_WHITESPACE","\n    ",57],["T_PROTECTED","protected",58],["T_WHITESPACE"," ",58],["T_VARIABLE","$_subtotalInclTax",58],["T_WHITESPACE"," ",58],"=",["T_WHITESPACE"," ",58],["T_LNUMBER","0",58],";",["T_WHITESPACE","\n\n    ",58],["T_DOC_COMMENT","\/**\n     * Default value for base subtotal that include taxes\n     *\n     * @var float\n     *\/",60],["T_WHITESPACE","\n    ",64],["T_PROTECTED","protected",65],["T_WHITESPACE"," ",65],["T_VARIABLE","$_baseSubtotalInclTax",65],["T_WHITESPACE"," ",65],"=",["T_WHITESPACE"," ",65],["T_LNUMBER","0",65],";",["T_WHITESPACE","\n\n    ",65],["T_DOC_COMMENT","\/**\n     * Default value for subtotal\n     *\n     * @var float\n     *\/",67],["T_WHITESPACE","\n    ",71],["T_PROTECTED","protected",72],["T_WHITESPACE"," ",72],["T_VARIABLE","$_subtotal",72],["T_WHITESPACE"," ",72],"=",["T_WHITESPACE"," ",72],["T_LNUMBER","0",72],";",["T_WHITESPACE","\n\n    ",72],["T_DOC_COMMENT","\/**\n     * Default value for base subtotal\n     *\n     * @var float\n     *\/",74],["T_WHITESPACE","\n    ",78],["T_PROTECTED","protected",79],["T_WHITESPACE"," ",79],["T_VARIABLE","$_baseSubtotal",79],["T_WHITESPACE"," ",79],"=",["T_WHITESPACE"," ",79],["T_LNUMBER","0",79],";",["T_WHITESPACE","\n\n    ",79],["T_DOC_COMMENT","\/**\n     * Flag which is initialized when collect method is started and catalog prices include tax.\n     * Is used for checking if store tax and customer tax requests are similar\n     *\n     * @var bool\n     *\/",81],["T_WHITESPACE","\n    ",86],["T_PROTECTED","protected",87],["T_WHITESPACE"," ",87],["T_VARIABLE","$_areTaxRequestsSimilar",87],["T_WHITESPACE"," ",87],"=",["T_WHITESPACE"," ",87],["T_STRING","false",87],";",["T_WHITESPACE","\n\n    ",87],["T_DOC_COMMENT","\/**\n     * Request which can be used for tax rate calculation\n     *\n     * @var Varien_Object\n     *\/",89],["T_WHITESPACE","\n    ",93],["T_PROTECTED","protected",94],["T_WHITESPACE"," ",94],["T_VARIABLE","$_storeTaxRequest",94],["T_WHITESPACE"," ",94],"=",["T_WHITESPACE"," ",94],["T_STRING","null",94],";",["T_WHITESPACE","\n\n    ",94],["T_DOC_COMMENT","\/**\n     *  Quote store\n     *\n     * @var Mage_Core_Model_Store\n     *\/",96],["T_WHITESPACE","\n    ",100],["T_PROTECTED","protected",101],["T_WHITESPACE"," ",101],["T_VARIABLE","$_store",101],";",["T_WHITESPACE","\n\n    ",101],["T_DOC_COMMENT","\/**\n     * Rounding deltas for prices\n     *\n     * @var array\n     *\/",103],["T_WHITESPACE","\n    ",107],["T_PROTECTED","protected",108],["T_WHITESPACE"," ",108],["T_VARIABLE","$_roundingDeltas",108],["T_WHITESPACE"," ",108],"=",["T_WHITESPACE"," ",108],["T_ARRAY","array",108],"(",")",";",["T_WHITESPACE","\n\n    ",108],["T_DOC_COMMENT","\/**\n     * Class constructor\n     *\/",110],["T_WHITESPACE","\n    ",112],["T_PUBLIC","public",113],["T_WHITESPACE"," ",113],["T_FUNCTION","function",113],["T_WHITESPACE"," ",113],["T_STRING","__construct",113],"(",")",["T_WHITESPACE","\n    ",113],"{",["T_WHITESPACE","\n        ",114],["T_VARIABLE","$this",115],["T_OBJECT_OPERATOR","->",115],["T_STRING","setCode",115],"(",["T_CONSTANT_ENCAPSED_STRING","'tax_subtotal'",115],")",";",["T_WHITESPACE","\n        ",115],["T_VARIABLE","$this",116],["T_OBJECT_OPERATOR","->",116],["T_STRING","_helper",116],["T_WHITESPACE"," ",116],"=",["T_WHITESPACE"," ",116],["T_STRING","Mage",116],["T_DOUBLE_COLON","::",116],["T_STRING","helper",116],"(",["T_CONSTANT_ENCAPSED_STRING","'tax'",116],")",";",["T_WHITESPACE","\n        ",116],["T_VARIABLE","$this",117],["T_OBJECT_OPERATOR","->",117],["T_STRING","_calculator",117],["T_WHITESPACE"," ",117],"=",["T_WHITESPACE"," ",117],["T_STRING","Mage",117],["T_DOUBLE_COLON","::",117],["T_STRING","getSingleton",117],"(",["T_CONSTANT_ENCAPSED_STRING","'tax\/calculation'",117],")",";",["T_WHITESPACE","\n        ",117],["T_VARIABLE","$this",118],["T_OBJECT_OPERATOR","->",118],["T_STRING","_config",118],["T_WHITESPACE"," ",118],"=",["T_WHITESPACE"," ",118],["T_STRING","Mage",118],["T_DOUBLE_COLON","::",118],["T_STRING","getSingleton",118],"(",["T_CONSTANT_ENCAPSED_STRING","'tax\/config'",118],")",";",["T_WHITESPACE","\n    ",118],"}",["T_WHITESPACE","\n\n    ",119],["T_DOC_COMMENT","\/**\n     * Calculate item price including\/excluding tax, row total including\/excluding tax\n     * and subtotal including\/excluding tax.\n     * Determine discount price if needed\n     *\n     * @param   Mage_Sales_Model_Quote_Address $address\n     *\n     * @return  Mage_Tax_Model_Sales_Total_Quote_Subtotal\n     *\/",121],["T_WHITESPACE","\n    ",129],["T_PUBLIC","public",130],["T_WHITESPACE"," ",130],["T_FUNCTION","function",130],["T_WHITESPACE"," ",130],["T_STRING","collect",130],"(",["T_STRING","Mage_Sales_Model_Quote_Address",130],["T_WHITESPACE"," ",130],["T_VARIABLE","$address",130],")",["T_WHITESPACE","\n    ",130],"{",["T_WHITESPACE","\n        ",131],["T_VARIABLE","$this",132],["T_OBJECT_OPERATOR","->",132],["T_STRING","_store",132],["T_WHITESPACE"," ",132],"=",["T_WHITESPACE"," ",132],["T_VARIABLE","$address",132],["T_OBJECT_OPERATOR","->",132],["T_STRING","getQuote",132],"(",")",["T_OBJECT_OPERATOR","->",132],["T_STRING","getStore",132],"(",")",";",["T_WHITESPACE","\n        ",132],["T_VARIABLE","$this",133],["T_OBJECT_OPERATOR","->",133],["T_STRING","_address",133],["T_WHITESPACE"," ",133],"=",["T_WHITESPACE"," ",133],["T_VARIABLE","$address",133],";",["T_WHITESPACE","\n\n        ",133],["T_VARIABLE","$this",135],["T_OBJECT_OPERATOR","->",135],["T_STRING","_subtotalInclTax",135],["T_WHITESPACE"," ",135],"=",["T_WHITESPACE"," ",135],["T_LNUMBER","0",135],";",["T_WHITESPACE","\n        ",135],["T_VARIABLE","$this",136],["T_OBJECT_OPERATOR","->",136],["T_STRING","_baseSubtotalInclTax",136],["T_WHITESPACE"," ",136],"=",["T_WHITESPACE"," ",136],["T_LNUMBER","0",136],";",["T_WHITESPACE","\n        ",136],["T_VARIABLE","$this",137],["T_OBJECT_OPERATOR","->",137],["T_STRING","_subtotal",137],["T_WHITESPACE"," ",137],"=",["T_WHITESPACE"," ",137],["T_LNUMBER","0",137],";",["T_WHITESPACE","\n        ",137],["T_VARIABLE","$this",138],["T_OBJECT_OPERATOR","->",138],["T_STRING","_baseSubtotal",138],["T_WHITESPACE"," ",138],"=",["T_WHITESPACE"," ",138],["T_LNUMBER","0",138],";",["T_WHITESPACE","\n        ",138],["T_VARIABLE","$this",139],["T_OBJECT_OPERATOR","->",139],["T_STRING","_roundingDeltas",139],["T_WHITESPACE"," ",139],"=",["T_WHITESPACE"," ",139],["T_ARRAY","array",139],"(",")",";",["T_WHITESPACE","\n\n        ",139],["T_VARIABLE","$address",141],["T_OBJECT_OPERATOR","->",141],["T_STRING","setSubtotalInclTax",141],"(",["T_LNUMBER","0",141],")",";",["T_WHITESPACE","\n        ",141],["T_VARIABLE","$address",142],["T_OBJECT_OPERATOR","->",142],["T_STRING","setBaseSubtotalInclTax",142],"(",["T_LNUMBER","0",142],")",";",["T_WHITESPACE","\n        ",142],["T_VARIABLE","$address",143],["T_OBJECT_OPERATOR","->",143],["T_STRING","setTotalAmount",143],"(",["T_CONSTANT_ENCAPSED_STRING","'subtotal'",143],",",["T_WHITESPACE"," ",143],["T_LNUMBER","0",143],")",";",["T_WHITESPACE","\n        ",143],["T_VARIABLE","$address",144],["T_OBJECT_OPERATOR","->",144],["T_STRING","setBaseTotalAmount",144],"(",["T_CONSTANT_ENCAPSED_STRING","'subtotal'",144],",",["T_WHITESPACE"," ",144],["T_LNUMBER","0",144],")",";",["T_WHITESPACE","\n\n        ",144],["T_VARIABLE","$items",146],["T_WHITESPACE"," ",146],"=",["T_WHITESPACE"," ",146],["T_VARIABLE","$this",146],["T_OBJECT_OPERATOR","->",146],["T_STRING","_getAddressItems",146],"(",["T_VARIABLE","$address",146],")",";",["T_WHITESPACE","\n        ",146],["T_IF","if",147],["T_WHITESPACE"," ",147],"(","!",["T_VARIABLE","$items",147],")",["T_WHITESPACE"," ",147],"{",["T_WHITESPACE","\n            ",147],["T_RETURN","return",148],["T_WHITESPACE"," ",148],["T_VARIABLE","$this",148],";",["T_WHITESPACE","\n        ",148],"}",["T_WHITESPACE","\n\n        ",149],["T_VARIABLE","$addressRequest",151],["T_WHITESPACE"," ",151],"=",["T_WHITESPACE"," ",151],["T_VARIABLE","$this",151],["T_OBJECT_OPERATOR","->",151],["T_STRING","_getAddressTaxRequest",151],"(",["T_VARIABLE","$address",151],")",";",["T_WHITESPACE","\n        ",151],["T_VARIABLE","$storeRequest",152],["T_WHITESPACE"," ",152],"=",["T_WHITESPACE"," ",152],["T_VARIABLE","$this",152],["T_OBJECT_OPERATOR","->",152],["T_STRING","_getStoreTaxRequest",152],"(",["T_VARIABLE","$address",152],")",";",["T_WHITESPACE","\n        ",152],["T_VARIABLE","$this",153],["T_OBJECT_OPERATOR","->",153],["T_STRING","_calculator",153],["T_OBJECT_OPERATOR","->",153],["T_STRING","setCustomer",153],"(",["T_VARIABLE","$address",153],["T_OBJECT_OPERATOR","->",153],["T_STRING","getQuote",153],"(",")",["T_OBJECT_OPERATOR","->",153],["T_STRING","getCustomer",153],"(",")",")",";",["T_WHITESPACE","\n        ",153],["T_IF","if",154],["T_WHITESPACE"," ",154],"(",["T_VARIABLE","$this",154],["T_OBJECT_OPERATOR","->",154],["T_STRING","_config",154],["T_OBJECT_OPERATOR","->",154],["T_STRING","priceIncludesTax",154],"(",["T_VARIABLE","$this",154],["T_OBJECT_OPERATOR","->",154],["T_STRING","_store",154],")",")",["T_WHITESPACE"," ",154],"{",["T_WHITESPACE","\n            ",154],["T_VARIABLE","$classIds",155],["T_WHITESPACE"," ",155],"=",["T_WHITESPACE"," ",155],["T_ARRAY","array",155],"(",")",";",["T_WHITESPACE","\n            ",155],["T_FOREACH","foreach",156],["T_WHITESPACE"," ",156],"(",["T_VARIABLE","$items",156],["T_WHITESPACE"," ",156],["T_AS","as",156],["T_WHITESPACE"," ",156],["T_VARIABLE","$item",156],")",["T_WHITESPACE"," ",156],"{",["T_WHITESPACE","\n                ",156],["T_VARIABLE","$classIds",157],"[","]",["T_WHITESPACE"," ",157],"=",["T_WHITESPACE"," ",157],["T_VARIABLE","$item",157],["T_OBJECT_OPERATOR","->",157],["T_STRING","getProduct",157],"(",")",["T_OBJECT_OPERATOR","->",157],["T_STRING","getTaxClassId",157],"(",")",";",["T_WHITESPACE","\n                ",157],["T_IF","if",158],["T_WHITESPACE"," ",158],"(",["T_VARIABLE","$item",158],["T_OBJECT_OPERATOR","->",158],["T_STRING","getHasChildren",158],"(",")",")",["T_WHITESPACE"," ",158],"{",["T_WHITESPACE","\n                    ",158],["T_FOREACH","foreach",159],["T_WHITESPACE"," ",159],"(",["T_VARIABLE","$item",159],["T_OBJECT_OPERATOR","->",159],["T_STRING","getChildren",159],"(",")",["T_WHITESPACE"," ",159],["T_AS","as",159],["T_WHITESPACE"," ",159],["T_VARIABLE","$child",159],")",["T_WHITESPACE"," ",159],"{",["T_WHITESPACE","\n                        ",159],["T_VARIABLE","$classIds",160],"[","]",["T_WHITESPACE"," ",160],"=",["T_WHITESPACE"," ",160],["T_VARIABLE","$child",160],["T_OBJECT_OPERATOR","->",160],["T_STRING","getProduct",160],"(",")",["T_OBJECT_OPERATOR","->",160],["T_STRING","getTaxClassId",160],"(",")",";",["T_WHITESPACE","\n                    ",160],"}",["T_WHITESPACE","\n                ",161],"}",["T_WHITESPACE","\n            ",162],"}",["T_WHITESPACE","\n            ",163],["T_VARIABLE","$classIds",164],["T_WHITESPACE"," ",164],"=",["T_WHITESPACE"," ",164],["T_STRING","array_unique",164],"(",["T_VARIABLE","$classIds",164],")",";",["T_WHITESPACE","\n            ",164],["T_VARIABLE","$storeRequest",165],["T_OBJECT_OPERATOR","->",165],["T_STRING","setProductClassId",165],"(",["T_VARIABLE","$classIds",165],")",";",["T_WHITESPACE","\n            ",165],["T_VARIABLE","$addressRequest",166],["T_OBJECT_OPERATOR","->",166],["T_STRING","setProductClassId",166],"(",["T_VARIABLE","$classIds",166],")",";",["T_WHITESPACE","\n            ",166],["T_IF","if",167],["T_WHITESPACE"," ",167],"(",["T_VARIABLE","$this",167],["T_OBJECT_OPERATOR","->",167],["T_STRING","_helper",167],["T_OBJECT_OPERATOR","->",167],["T_STRING","isCrossBorderTradeEnabled",167],"(",["T_VARIABLE","$this",167],["T_OBJECT_OPERATOR","->",167],["T_STRING","_store",167],")",")",["T_WHITESPACE"," ",167],"{",["T_WHITESPACE","\n                ",167],["T_VARIABLE","$this",168],["T_OBJECT_OPERATOR","->",168],["T_STRING","_areTaxRequestsSimilar",168],["T_WHITESPACE"," ",168],"=",["T_WHITESPACE"," ",168],["T_STRING","true",168],";",["T_WHITESPACE","\n            ",168],"}",["T_WHITESPACE"," ",169],["T_ELSE","else",169],["T_WHITESPACE"," ",169],"{",["T_WHITESPACE","\n                ",169],["T_VARIABLE","$this",170],["T_OBJECT_OPERATOR","->",170],["T_STRING","_areTaxRequestsSimilar",170],["T_WHITESPACE"," ",170],"=",["T_WHITESPACE"," ",170],["T_VARIABLE","$this",170],["T_OBJECT_OPERATOR","->",170],["T_STRING","_calculator",170],["T_OBJECT_OPERATOR","->",170],["T_STRING","compareRequests",170],"(",["T_VARIABLE","$storeRequest",170],",",["T_WHITESPACE"," ",170],["T_VARIABLE","$addressRequest",170],")",";",["T_WHITESPACE","\n            ",170],"}",["T_WHITESPACE","\n        ",171],"}",["T_WHITESPACE","\n\n        ",172],["T_FOREACH","foreach",174],["T_WHITESPACE"," ",174],"(",["T_VARIABLE","$items",174],["T_WHITESPACE"," ",174],["T_AS","as",174],["T_WHITESPACE"," ",174],["T_VARIABLE","$item",174],")",["T_WHITESPACE"," ",174],"{",["T_WHITESPACE","\n            ",174],["T_IF","if",175],["T_WHITESPACE"," ",175],"(",["T_VARIABLE","$item",175],["T_OBJECT_OPERATOR","->",175],["T_STRING","getParentItem",175],"(",")",")",["T_WHITESPACE"," ",175],"{",["T_WHITESPACE","\n                ",175],["T_CONTINUE","continue",176],";",["T_WHITESPACE","\n            ",176],"}",["T_WHITESPACE","\n            ",177],["T_IF","if",178],["T_WHITESPACE"," ",178],"(",["T_VARIABLE","$item",178],["T_OBJECT_OPERATOR","->",178],["T_STRING","getHasChildren",178],"(",")",["T_WHITESPACE"," ",178],["T_BOOLEAN_AND","&&",178],["T_WHITESPACE"," ",178],["T_VARIABLE","$item",178],["T_OBJECT_OPERATOR","->",178],["T_STRING","isChildrenCalculated",178],"(",")",")",["T_WHITESPACE"," ",178],"{",["T_WHITESPACE","\n                ",178],["T_FOREACH","foreach",179],["T_WHITESPACE"," ",179],"(",["T_VARIABLE","$item",179],["T_OBJECT_OPERATOR","->",179],["T_STRING","getChildren",179],"(",")",["T_WHITESPACE"," ",179],["T_AS","as",179],["T_WHITESPACE"," ",179],["T_VARIABLE","$child",179],")",["T_WHITESPACE"," ",179],"{",["T_WHITESPACE","\n                    ",179],["T_VARIABLE","$this",180],["T_OBJECT_OPERATOR","->",180],["T_STRING","_processItem",180],"(",["T_VARIABLE","$child",180],",",["T_WHITESPACE"," ",180],["T_VARIABLE","$addressRequest",180],")",";",["T_WHITESPACE","\n                ",180],"}",["T_WHITESPACE","\n                ",181],["T_VARIABLE","$this",182],["T_OBJECT_OPERATOR","->",182],["T_STRING","_recalculateParent",182],"(",["T_VARIABLE","$item",182],")",";",["T_WHITESPACE","\n            ",182],"}",["T_WHITESPACE"," ",183],["T_ELSE","else",183],["T_WHITESPACE"," ",183],"{",["T_WHITESPACE","\n                ",183],["T_VARIABLE","$this",184],["T_OBJECT_OPERATOR","->",184],["T_STRING","_processItem",184],"(",["T_VARIABLE","$item",184],",",["T_WHITESPACE"," ",184],["T_VARIABLE","$addressRequest",184],")",";",["T_WHITESPACE","\n            ",184],"}",["T_WHITESPACE","\n            ",185],["T_VARIABLE","$this",186],["T_OBJECT_OPERATOR","->",186],["T_STRING","_addSubtotalAmount",186],"(",["T_VARIABLE","$address",186],",",["T_WHITESPACE"," ",186],["T_VARIABLE","$item",186],")",";",["T_WHITESPACE","\n        ",186],"}",["T_WHITESPACE","\n        ",187],["T_VARIABLE","$address",188],["T_OBJECT_OPERATOR","->",188],["T_STRING","setRoundingDeltas",188],"(",["T_VARIABLE","$this",188],["T_OBJECT_OPERATOR","->",188],["T_STRING","_roundingDeltas",188],")",";",["T_WHITESPACE","\n        ",188],["T_RETURN","return",189],["T_WHITESPACE"," ",189],["T_VARIABLE","$this",189],";",["T_WHITESPACE","\n    ",189],"}",["T_WHITESPACE","\n\n    ",190],["T_DOC_COMMENT","\/**\n     * Calculate item price and row total with configured rounding level\n     *\n     * @param Mage_Sales_Model_Quote_Item_Abstract $item\n     * @param Varien_Object $taxRequest\n     *\n     * @return Mage_Tax_Model_Sales_Total_Quote_Subtotal\n     *\/",192],["T_WHITESPACE","\n    ",199],["T_PROTECTED","protected",200],["T_WHITESPACE"," ",200],["T_FUNCTION","function",200],["T_WHITESPACE"," ",200],["T_STRING","_processItem",200],"(",["T_VARIABLE","$item",200],",",["T_WHITESPACE"," ",200],["T_VARIABLE","$taxRequest",200],")",["T_WHITESPACE","\n    ",200],"{",["T_WHITESPACE","\n        ",201],["T_SWITCH","switch",202],["T_WHITESPACE"," ",202],"(",["T_VARIABLE","$this",202],["T_OBJECT_OPERATOR","->",202],["T_STRING","_config",202],["T_OBJECT_OPERATOR","->",202],["T_STRING","getAlgorithm",202],"(",["T_VARIABLE","$this",202],["T_OBJECT_OPERATOR","->",202],["T_STRING","_store",202],")",")",["T_WHITESPACE"," ",202],"{",["T_WHITESPACE","\n            ",202],["T_CASE","case",203],["T_WHITESPACE"," ",203],["T_STRING","Mage_Tax_Model_Calculation",203],["T_DOUBLE_COLON","::",203],["T_STRING","CALC_UNIT_BASE",203],":",["T_WHITESPACE","\n                ",203],["T_VARIABLE","$this",204],["T_OBJECT_OPERATOR","->",204],["T_STRING","_unitBaseCalculation",204],"(",["T_VARIABLE","$item",204],",",["T_WHITESPACE"," ",204],["T_VARIABLE","$taxRequest",204],")",";",["T_WHITESPACE","\n                ",204],["T_BREAK","break",205],";",["T_WHITESPACE","\n            ",205],["T_CASE","case",206],["T_WHITESPACE"," ",206],["T_STRING","Mage_Tax_Model_Calculation",206],["T_DOUBLE_COLON","::",206],["T_STRING","CALC_ROW_BASE",206],":",["T_WHITESPACE","\n                ",206],["T_VARIABLE","$this",207],["T_OBJECT_OPERATOR","->",207],["T_STRING","_rowBaseCalculation",207],"(",["T_VARIABLE","$item",207],",",["T_WHITESPACE"," ",207],["T_VARIABLE","$taxRequest",207],")",";",["T_WHITESPACE","\n                ",207],["T_BREAK","break",208],";",["T_WHITESPACE","\n            ",208],["T_CASE","case",209],["T_WHITESPACE"," ",209],["T_STRING","Mage_Tax_Model_Calculation",209],["T_DOUBLE_COLON","::",209],["T_STRING","CALC_TOTAL_BASE",209],":",["T_WHITESPACE","\n                ",209],["T_VARIABLE","$this",210],["T_OBJECT_OPERATOR","->",210],["T_STRING","_totalBaseCalculation",210],"(",["T_VARIABLE","$item",210],",",["T_WHITESPACE"," ",210],["T_VARIABLE","$taxRequest",210],")",";",["T_WHITESPACE","\n                ",210],["T_BREAK","break",211],";",["T_WHITESPACE","\n            ",211],["T_DEFAULT","default",212],":",["T_WHITESPACE","\n                ",212],["T_BREAK","break",213],";",["T_WHITESPACE","\n        ",213],"}",["T_WHITESPACE","\n        ",214],["T_RETURN","return",215],["T_WHITESPACE"," ",215],["T_VARIABLE","$this",215],";",["T_WHITESPACE","\n    ",215],"}",["T_WHITESPACE","\n\n    ",216],["T_DOC_COMMENT","\/**\n     * Calculate item price and row total including\/excluding tax based on unit price rounding level\n     *\n     * @param Mage_Sales_Model_Quote_Item_Abstract $item\n     * @param Varien_Object $request\n     *\n     * @return Mage_Tax_Model_Sales_Total_Quote_Subtotal\n     *\/",218],["T_WHITESPACE","\n    ",225],["T_PROTECTED","protected",226],["T_WHITESPACE"," ",226],["T_FUNCTION","function",226],["T_WHITESPACE"," ",226],["T_STRING","_unitBaseCalculation",226],"(",["T_VARIABLE","$item",226],",",["T_WHITESPACE"," ",226],["T_VARIABLE","$request",226],")",["T_WHITESPACE","\n    ",226],"{",["T_WHITESPACE","\n        ",227],["T_VARIABLE","$request",228],["T_OBJECT_OPERATOR","->",228],["T_STRING","setProductClassId",228],"(",["T_VARIABLE","$item",228],["T_OBJECT_OPERATOR","->",228],["T_STRING","getProduct",228],"(",")",["T_OBJECT_OPERATOR","->",228],["T_STRING","getTaxClassId",228],"(",")",")",";",["T_WHITESPACE","\n        ",228],["T_VARIABLE","$rate",229],["T_WHITESPACE"," ",229],"=",["T_WHITESPACE"," ",229],["T_VARIABLE","$this",229],["T_OBJECT_OPERATOR","->",229],["T_STRING","_calculator",229],["T_OBJECT_OPERATOR","->",229],["T_STRING","getRate",229],"(",["T_VARIABLE","$request",229],")",";",["T_WHITESPACE","\n        ",229],["T_VARIABLE","$qty",230],["T_WHITESPACE"," ",230],"=",["T_WHITESPACE"," ",230],["T_VARIABLE","$item",230],["T_OBJECT_OPERATOR","->",230],["T_STRING","getTotalQty",230],"(",")",";",["T_WHITESPACE","\n\n        ",230],["T_VARIABLE","$price",232],["T_WHITESPACE"," ",232],"=",["T_WHITESPACE"," ",232],["T_VARIABLE","$taxPrice",232],["T_WHITESPACE"," ",232],"=",["T_WHITESPACE"," ",232],["T_VARIABLE","$this",232],["T_OBJECT_OPERATOR","->",232],["T_STRING","_calculator",232],["T_OBJECT_OPERATOR","->",232],["T_STRING","round",232],"(",["T_VARIABLE","$item",232],["T_OBJECT_OPERATOR","->",232],["T_STRING","getCalculationPriceOriginal",232],"(",")",")",";",["T_WHITESPACE","\n        ",232],["T_VARIABLE","$basePrice",233],["T_WHITESPACE"," ",233],"=",["T_WHITESPACE"," ",233],["T_VARIABLE","$baseTaxPrice",233],["T_WHITESPACE"," ",233],"=",["T_WHITESPACE"," ",233],["T_VARIABLE","$this",233],["T_OBJECT_OPERATOR","->",233],["T_STRING","_calculator",233],["T_OBJECT_OPERATOR","->",233],["T_STRING","round",233],"(",["T_VARIABLE","$item",233],["T_OBJECT_OPERATOR","->",233],["T_STRING","getBaseCalculationPriceOriginal",233],"(",")",")",";",["T_WHITESPACE","\n        ",233],["T_VARIABLE","$subtotal",234],["T_WHITESPACE"," ",234],"=",["T_WHITESPACE"," ",234],["T_VARIABLE","$taxSubtotal",234],["T_WHITESPACE"," ",234],"=",["T_WHITESPACE"," ",234],["T_VARIABLE","$this",234],["T_OBJECT_OPERATOR","->",234],["T_STRING","_calculator",234],["T_OBJECT_OPERATOR","->",234],["T_STRING","round",234],"(",["T_VARIABLE","$item",234],["T_OBJECT_OPERATOR","->",234],["T_STRING","getRowTotal",234],"(",")",")",";",["T_WHITESPACE","\n        ",234],["T_VARIABLE","$baseSubtotal",235],["T_WHITESPACE"," ",235],"=",["T_WHITESPACE"," ",235],["T_VARIABLE","$baseTaxSubtotal",235],["T_WHITESPACE"," ",235],"=",["T_WHITESPACE"," ",235],["T_VARIABLE","$this",235],["T_OBJECT_OPERATOR","->",235],["T_STRING","_calculator",235],["T_OBJECT_OPERATOR","->",235],["T_STRING","round",235],"(",["T_VARIABLE","$item",235],["T_OBJECT_OPERATOR","->",235],["T_STRING","getBaseRowTotal",235],"(",")",")",";",["T_WHITESPACE","\n\n        ",235],["T_COMMENT","\/\/ if we have a custom price, determine if tax should be based on the original price\n",237],["T_WHITESPACE","        ",238],["T_VARIABLE","$taxOnOrigPrice",238],["T_WHITESPACE"," ",238],"=",["T_WHITESPACE"," ",238],"!",["T_VARIABLE","$this",238],["T_OBJECT_OPERATOR","->",238],["T_STRING","_helper",238],["T_OBJECT_OPERATOR","->",238],["T_STRING","applyTaxOnCustomPrice",238],"(",["T_VARIABLE","$this",238],["T_OBJECT_OPERATOR","->",238],["T_STRING","_store",238],")",["T_WHITESPACE"," ",238],["T_BOOLEAN_AND","&&",238],["T_WHITESPACE"," ",238],["T_VARIABLE","$item",238],["T_OBJECT_OPERATOR","->",238],["T_STRING","hasCustomPrice",238],"(",")",";",["T_WHITESPACE","\n        ",238],["T_IF","if",239],["T_WHITESPACE"," ",239],"(",["T_VARIABLE","$taxOnOrigPrice",239],")",["T_WHITESPACE"," ",239],"{",["T_WHITESPACE","\n            ",239],["T_VARIABLE","$origPrice",240],["T_WHITESPACE"," ",240],"=",["T_WHITESPACE"," ",240],["T_VARIABLE","$item",240],["T_OBJECT_OPERATOR","->",240],["T_STRING","getOriginalPrice",240],"(",")",";",["T_WHITESPACE","\n            ",240],["T_VARIABLE","$baseOrigPrice",241],["T_WHITESPACE"," ",241],"=",["T_WHITESPACE"," ",241],["T_VARIABLE","$item",241],["T_OBJECT_OPERATOR","->",241],["T_STRING","getBaseOriginalPrice",241],"(",")",";",["T_WHITESPACE","\n        ",241],"}",["T_WHITESPACE","\n\n        ",242],["T_VARIABLE","$item",244],["T_OBJECT_OPERATOR","->",244],["T_STRING","setTaxPercent",244],"(",["T_VARIABLE","$rate",244],")",";",["T_WHITESPACE","\n        ",244],["T_IF","if",245],["T_WHITESPACE"," ",245],"(",["T_VARIABLE","$this",245],["T_OBJECT_OPERATOR","->",245],["T_STRING","_config",245],["T_OBJECT_OPERATOR","->",245],["T_STRING","priceIncludesTax",245],"(",["T_VARIABLE","$this",245],["T_OBJECT_OPERATOR","->",245],["T_STRING","_store",245],")",")",["T_WHITESPACE"," ",245],"{",["T_WHITESPACE","\n            ",245],["T_IF","if",246],["T_WHITESPACE"," ",246],"(",["T_VARIABLE","$this",246],["T_OBJECT_OPERATOR","->",246],["T_STRING","_sameRateAsStore",246],"(",["T_VARIABLE","$request",246],")",")",["T_WHITESPACE"," ",246],"{",["T_WHITESPACE","\n                ",246],["T_COMMENT","\/\/ determine which price to use when we calculate the tax\n",247],["T_WHITESPACE","                ",248],["T_IF","if",248],["T_WHITESPACE"," ",248],"(",["T_VARIABLE","$taxOnOrigPrice",248],")",["T_WHITESPACE"," ",248],"{",["T_WHITESPACE","\n                    ",248],["T_VARIABLE","$taxable",249],["T_WHITESPACE","        ",249],"=",["T_WHITESPACE"," ",249],["T_VARIABLE","$origPrice",249],";",["T_WHITESPACE","\n                    ",249],["T_VARIABLE","$baseTaxable",250],["T_WHITESPACE","    ",250],"=",["T_WHITESPACE"," ",250],["T_VARIABLE","$baseOrigPrice",250],";",["T_WHITESPACE","\n                ",250],"}",["T_WHITESPACE"," ",251],["T_ELSE","else",251],["T_WHITESPACE"," ",251],"{",["T_WHITESPACE","\n                    ",251],["T_VARIABLE","$taxable",252],["T_WHITESPACE","        ",252],"=",["T_WHITESPACE"," ",252],["T_VARIABLE","$price",252],";",["T_WHITESPACE","\n                    ",252],["T_VARIABLE","$baseTaxable",253],["T_WHITESPACE","    ",253],"=",["T_WHITESPACE"," ",253],["T_VARIABLE","$basePrice",253],";",["T_WHITESPACE","\n                ",253],"}",["T_WHITESPACE","\n                ",254],["T_VARIABLE","$tax",255],["T_WHITESPACE","             ",255],"=",["T_WHITESPACE"," ",255],["T_VARIABLE","$this",255],["T_OBJECT_OPERATOR","->",255],["T_STRING","_calculator",255],["T_OBJECT_OPERATOR","->",255],["T_STRING","calcTaxAmount",255],"(",["T_VARIABLE","$taxable",255],",",["T_WHITESPACE"," ",255],["T_VARIABLE","$rate",255],",",["T_WHITESPACE"," ",255],["T_STRING","true",255],")",";",["T_WHITESPACE","\n                ",255],["T_VARIABLE","$baseTax",256],["T_WHITESPACE","         ",256],"=",["T_WHITESPACE"," ",256],["T_VARIABLE","$this",256],["T_OBJECT_OPERATOR","->",256],["T_STRING","_calculator",256],["T_OBJECT_OPERATOR","->",256],["T_STRING","calcTaxAmount",256],"(",["T_VARIABLE","$baseTaxable",256],",",["T_WHITESPACE"," ",256],["T_VARIABLE","$rate",256],",",["T_WHITESPACE"," ",256],["T_STRING","true",256],")",";",["T_WHITESPACE","\n                ",256],["T_VARIABLE","$taxPrice",257],["T_WHITESPACE","        ",257],"=",["T_WHITESPACE"," ",257],["T_VARIABLE","$price",257],";",["T_WHITESPACE","\n                ",257],["T_VARIABLE","$baseTaxPrice",258],["T_WHITESPACE","    ",258],"=",["T_WHITESPACE"," ",258],["T_VARIABLE","$basePrice",258],";",["T_WHITESPACE","\n                ",258],["T_VARIABLE","$taxSubtotal",259],["T_WHITESPACE","     ",259],"=",["T_WHITESPACE"," ",259],["T_VARIABLE","$subtotal",259],";",["T_WHITESPACE","\n                ",259],["T_VARIABLE","$baseTaxSubtotal",260],["T_WHITESPACE"," ",260],"=",["T_WHITESPACE"," ",260],["T_VARIABLE","$baseSubtotal",260],";",["T_WHITESPACE","\n                ",260],["T_VARIABLE","$price",261],["T_WHITESPACE"," ",261],"=",["T_WHITESPACE"," ",261],["T_VARIABLE","$price",261],["T_WHITESPACE"," ",261],"-",["T_WHITESPACE"," ",261],["T_VARIABLE","$tax",261],";",["T_WHITESPACE","\n                ",261],["T_VARIABLE","$basePrice",262],["T_WHITESPACE"," ",262],"=",["T_WHITESPACE"," ",262],["T_VARIABLE","$basePrice",262],["T_WHITESPACE"," ",262],"-",["T_WHITESPACE"," ",262],["T_VARIABLE","$baseTax",262],";",["T_WHITESPACE","\n                ",262],["T_VARIABLE","$subtotal",263],["T_WHITESPACE"," ",263],"=",["T_WHITESPACE"," ",263],["T_VARIABLE","$price",263],["T_WHITESPACE"," ",263],"*",["T_WHITESPACE"," ",263],["T_VARIABLE","$qty",263],";",["T_WHITESPACE","\n                ",263],["T_VARIABLE","$baseSubtotal",264],["T_WHITESPACE"," ",264],"=",["T_WHITESPACE"," ",264],["T_VARIABLE","$basePrice",264],["T_WHITESPACE"," ",264],"*",["T_WHITESPACE"," ",264],["T_VARIABLE","$qty",264],";",["T_WHITESPACE","\n                ",264],["T_VARIABLE","$isPriceInclTax",265],["T_WHITESPACE","  ",265],"=",["T_WHITESPACE"," ",265],["T_STRING","true",265],";",["T_WHITESPACE","\n\n                ",265],["T_VARIABLE","$item",267],["T_OBJECT_OPERATOR","->",267],["T_STRING","setRowTax",267],"(",["T_VARIABLE","$tax",267],["T_WHITESPACE"," ",267],"*",["T_WHITESPACE"," ",267],["T_VARIABLE","$qty",267],")",";",["T_WHITESPACE","\n                ",267],["T_VARIABLE","$item",268],["T_OBJECT_OPERATOR","->",268],["T_STRING","setBaseRowTax",268],"(",["T_VARIABLE","$baseTax",268],["T_WHITESPACE"," ",268],"*",["T_WHITESPACE"," ",268],["T_VARIABLE","$qty",268],")",";",["T_WHITESPACE","\n\n            ",268],"}",["T_WHITESPACE"," ",270],["T_ELSE","else",270],["T_WHITESPACE"," ",270],"{",["T_WHITESPACE","\n                ",270],["T_VARIABLE","$storeRate",271],["T_WHITESPACE","       ",271],"=",["T_WHITESPACE"," ",271],["T_VARIABLE","$this",271],["T_OBJECT_OPERATOR","->",271],["T_STRING","_calculator",271],["T_OBJECT_OPERATOR","->",271],["T_STRING","getStoreRate",271],"(",["T_VARIABLE","$request",271],",",["T_WHITESPACE"," ",271],["T_VARIABLE","$this",271],["T_OBJECT_OPERATOR","->",271],["T_STRING","_store",271],")",";",["T_WHITESPACE","\n                ",271],["T_IF","if",272],["T_WHITESPACE"," ",272],"(",["T_VARIABLE","$taxOnOrigPrice",272],")",["T_WHITESPACE"," ",272],"{",["T_WHITESPACE","\n                    ",272],["T_COMMENT","\/\/ the merchant already provided a customer's price that includes tax\n",273],["T_WHITESPACE","                    ",274],["T_VARIABLE","$taxPrice",274],["T_WHITESPACE","     ",274],"=",["T_WHITESPACE"," ",274],["T_VARIABLE","$price",274],";",["T_WHITESPACE","\n                    ",274],["T_VARIABLE","$baseTaxPrice",275],["T_WHITESPACE"," ",275],"=",["T_WHITESPACE"," ",275],["T_VARIABLE","$basePrice",275],";",["T_WHITESPACE","\n                    ",275],["T_COMMENT","\/\/ determine which price to use when we calculate the tax\n",276],["T_WHITESPACE","                    ",277],["T_VARIABLE","$taxable",277],["T_WHITESPACE","      ",277],"=",["T_WHITESPACE"," ",277],["T_VARIABLE","$this",277],["T_OBJECT_OPERATOR","->",277],["T_STRING","_calculatePriceInclTax",277],"(",["T_VARIABLE","$origPrice",277],",",["T_WHITESPACE"," ",277],["T_VARIABLE","$storeRate",277],",",["T_WHITESPACE"," ",277],["T_VARIABLE","$rate",277],")",";",["T_WHITESPACE","\n                    ",277],["T_VARIABLE","$baseTaxable",278],["T_WHITESPACE","  ",278],"=",["T_WHITESPACE"," ",278],["T_VARIABLE","$this",278],["T_OBJECT_OPERATOR","->",278],["T_STRING","_calculatePriceInclTax",278],"(",["T_VARIABLE","$baseOrigPrice",278],",",["T_WHITESPACE"," ",278],["T_VARIABLE","$storeRate",278],",",["T_WHITESPACE"," ",278],["T_VARIABLE","$rate",278],")",";",["T_WHITESPACE","\n                ",278],"}",["T_WHITESPACE"," ",279],["T_ELSE","else",279],["T_WHITESPACE"," ",279],"{",["T_WHITESPACE","\n                    ",279],["T_COMMENT","\/\/ determine the customer's price that includes tax\n",280],["T_WHITESPACE","                    ",281],["T_VARIABLE","$taxPrice",281],["T_WHITESPACE","     ",281],"=",["T_WHITESPACE"," ",281],["T_VARIABLE","$this",281],["T_OBJECT_OPERATOR","->",281],["T_STRING","_calculatePriceInclTax",281],"(",["T_VARIABLE","$price",281],",",["T_WHITESPACE"," ",281],["T_VARIABLE","$storeRate",281],",",["T_WHITESPACE"," ",281],["T_VARIABLE","$rate",281],")",";",["T_WHITESPACE","\n                    ",281],["T_VARIABLE","$baseTaxPrice",282],["T_WHITESPACE"," ",282],"=",["T_WHITESPACE"," ",282],["T_VARIABLE","$this",282],["T_OBJECT_OPERATOR","->",282],["T_STRING","_calculatePriceInclTax",282],"(",["T_VARIABLE","$basePrice",282],",",["T_WHITESPACE"," ",282],["T_VARIABLE","$storeRate",282],",",["T_WHITESPACE"," ",282],["T_VARIABLE","$rate",282],")",";",["T_WHITESPACE","\n                    ",282],["T_COMMENT","\/\/ determine which price to use when we calculate the tax\n",283],["T_WHITESPACE","                    ",284],["T_VARIABLE","$taxable",284],["T_WHITESPACE","      ",284],"=",["T_WHITESPACE"," ",284],["T_VARIABLE","$taxPrice",284],";",["T_WHITESPACE","\n                    ",284],["T_VARIABLE","$baseTaxable",285],["T_WHITESPACE","  ",285],"=",["T_WHITESPACE"," ",285],["T_VARIABLE","$baseTaxPrice",285],";",["T_WHITESPACE","\n                ",285],"}",["T_WHITESPACE","\n                ",286],["T_COMMENT","\/\/ determine the customer's tax amount\n",287],["T_WHITESPACE","                ",288],["T_VARIABLE","$tax",288],["T_WHITESPACE","             ",288],"=",["T_WHITESPACE"," ",288],["T_VARIABLE","$this",288],["T_OBJECT_OPERATOR","->",288],["T_STRING","_calculator",288],["T_OBJECT_OPERATOR","->",288],["T_STRING","calcTaxAmount",288],"(",["T_VARIABLE","$taxable",288],",",["T_WHITESPACE"," ",288],["T_VARIABLE","$rate",288],",",["T_WHITESPACE"," ",288],["T_STRING","true",288],",",["T_WHITESPACE"," ",288],["T_STRING","true",288],")",";",["T_WHITESPACE","\n                ",288],["T_VARIABLE","$baseTax",289],["T_WHITESPACE","         ",289],"=",["T_WHITESPACE"," ",289],["T_VARIABLE","$this",289],["T_OBJECT_OPERATOR","->",289],["T_STRING","_calculator",289],["T_OBJECT_OPERATOR","->",289],["T_STRING","calcTaxAmount",289],"(",["T_VARIABLE","$baseTaxable",289],",",["T_WHITESPACE"," ",289],["T_VARIABLE","$rate",289],",",["T_WHITESPACE"," ",289],["T_STRING","true",289],",",["T_WHITESPACE"," ",289],["T_STRING","true",289],")",";",["T_WHITESPACE","\n                ",289],["T_COMMENT","\/\/ determine the customer's price without taxes\n",290],["T_WHITESPACE","                ",291],["T_VARIABLE","$price",291],["T_WHITESPACE"," ",291],"=",["T_WHITESPACE"," ",291],["T_VARIABLE","$taxPrice",291],["T_WHITESPACE"," ",291],"-",["T_WHITESPACE"," ",291],["T_VARIABLE","$tax",291],";",["T_WHITESPACE","\n                ",291],["T_VARIABLE","$basePrice",292],["T_WHITESPACE"," ",292],"=",["T_WHITESPACE"," ",292],["T_VARIABLE","$baseTaxPrice",292],["T_WHITESPACE"," ",292],"-",["T_WHITESPACE"," ",292],["T_VARIABLE","$baseTax",292],";",["T_WHITESPACE","\n                ",292],["T_COMMENT","\/\/ determine subtotal amounts\n",293],["T_WHITESPACE","                ",294],["T_VARIABLE","$taxSubtotal",294],["T_WHITESPACE"," ",294],"=",["T_WHITESPACE"," ",294],["T_VARIABLE","$taxPrice",294],["T_WHITESPACE"," ",294],"*",["T_WHITESPACE"," ",294],["T_VARIABLE","$qty",294],";",["T_WHITESPACE","\n                ",294],["T_VARIABLE","$baseTaxSubtotal",295],["T_WHITESPACE"," ",295],"=",["T_WHITESPACE"," ",295],["T_VARIABLE","$baseTaxPrice",295],["T_WHITESPACE"," ",295],"*",["T_WHITESPACE"," ",295],["T_VARIABLE","$qty",295],";",["T_WHITESPACE","\n                ",295],["T_VARIABLE","$subtotal",296],["T_WHITESPACE"," ",296],"=",["T_WHITESPACE"," ",296],["T_VARIABLE","$price",296],["T_WHITESPACE"," ",296],"*",["T_WHITESPACE"," ",296],["T_VARIABLE","$qty",296],";",["T_WHITESPACE","\n                ",296],["T_VARIABLE","$baseSubtotal",297],["T_WHITESPACE"," ",297],"=",["T_WHITESPACE"," ",297],["T_VARIABLE","$basePrice",297],["T_WHITESPACE"," ",297],"*",["T_WHITESPACE"," ",297],["T_VARIABLE","$qty",297],";",["T_WHITESPACE","\n                ",297],["T_VARIABLE","$isPriceInclTax",298],["T_WHITESPACE","  ",298],"=",["T_WHITESPACE"," ",298],["T_STRING","true",298],";",["T_WHITESPACE","\n\n                ",298],["T_VARIABLE","$item",300],["T_OBJECT_OPERATOR","->",300],["T_STRING","setRowTax",300],"(",["T_VARIABLE","$tax",300],["T_WHITESPACE"," ",300],"*",["T_WHITESPACE"," ",300],["T_VARIABLE","$qty",300],")",";",["T_WHITESPACE","\n                ",300],["T_VARIABLE","$item",301],["T_OBJECT_OPERATOR","->",301],["T_STRING","setBaseRowTax",301],"(",["T_VARIABLE","$baseTax",301],["T_WHITESPACE"," ",301],"*",["T_WHITESPACE"," ",301],["T_VARIABLE","$qty",301],")",";",["T_WHITESPACE","\n            ",301],"}",["T_WHITESPACE","\n        ",302],"}",["T_WHITESPACE"," ",303],["T_ELSE","else",303],["T_WHITESPACE"," ",303],"{",["T_WHITESPACE","\n            ",303],["T_COMMENT","\/\/ determine which price to use when we calculate the tax\n",304],["T_WHITESPACE","            ",305],["T_IF","if",305],["T_WHITESPACE"," ",305],"(",["T_VARIABLE","$taxOnOrigPrice",305],")",["T_WHITESPACE"," ",305],"{",["T_WHITESPACE","\n                ",305],["T_VARIABLE","$taxable",306],["T_WHITESPACE"," ",306],"=",["T_WHITESPACE"," ",306],["T_VARIABLE","$origPrice",306],";",["T_WHITESPACE","\n                ",306],["T_VARIABLE","$baseTaxable",307],["T_WHITESPACE"," ",307],"=",["T_WHITESPACE"," ",307],["T_VARIABLE","$baseOrigPrice",307],";",["T_WHITESPACE","\n            ",307],"}",["T_WHITESPACE"," ",308],["T_ELSE","else",308],["T_WHITESPACE"," ",308],"{",["T_WHITESPACE","\n                ",308],["T_VARIABLE","$taxable",309],["T_WHITESPACE"," ",309],"=",["T_WHITESPACE"," ",309],["T_VARIABLE","$price",309],";",["T_WHITESPACE","\n                ",309],["T_VARIABLE","$baseTaxable",310],["T_WHITESPACE"," ",310],"=",["T_WHITESPACE"," ",310],["T_VARIABLE","$basePrice",310],";",["T_WHITESPACE","\n            ",310],"}",["T_WHITESPACE","\n            ",311],["T_VARIABLE","$appliedRates",312],["T_WHITESPACE"," ",312],"=",["T_WHITESPACE"," ",312],["T_VARIABLE","$this",312],["T_OBJECT_OPERATOR","->",312],["T_STRING","_calculator",312],["T_OBJECT_OPERATOR","->",312],["T_STRING","getAppliedRates",312],"(",["T_VARIABLE","$request",312],")",";",["T_WHITESPACE","\n            ",312],["T_VARIABLE","$taxes",313],["T_WHITESPACE"," ",313],"=",["T_WHITESPACE"," ",313],["T_ARRAY","array",313],"(",")",";",["T_WHITESPACE","\n            ",313],["T_VARIABLE","$baseTaxes",314],["T_WHITESPACE"," ",314],"=",["T_WHITESPACE"," ",314],["T_ARRAY","array",314],"(",")",";",["T_WHITESPACE","\n            ",314],["T_FOREACH","foreach",315],["T_WHITESPACE"," ",315],"(",["T_VARIABLE","$appliedRates",315],["T_WHITESPACE"," ",315],["T_AS","as",315],["T_WHITESPACE"," ",315],["T_VARIABLE","$appliedRate",315],")",["T_WHITESPACE"," ",315],"{",["T_WHITESPACE","\n                ",315],["T_VARIABLE","$taxRate",316],["T_WHITESPACE"," ",316],"=",["T_WHITESPACE"," ",316],["T_VARIABLE","$appliedRate",316],"[",["T_CONSTANT_ENCAPSED_STRING","'percent'",316],"]",";",["T_WHITESPACE","\n                ",316],["T_VARIABLE","$taxes",317],"[","]",["T_WHITESPACE"," ",317],"=",["T_WHITESPACE"," ",317],["T_VARIABLE","$this",317],["T_OBJECT_OPERATOR","->",317],["T_STRING","_calculator",317],["T_OBJECT_OPERATOR","->",317],["T_STRING","calcTaxAmount",317],"(",["T_VARIABLE","$taxable",317],",",["T_WHITESPACE"," ",317],["T_VARIABLE","$taxRate",317],",",["T_WHITESPACE"," ",317],["T_STRING","false",317],")",";",["T_WHITESPACE","\n                ",317],["T_VARIABLE","$baseTaxes",318],"[","]",["T_WHITESPACE"," ",318],"=",["T_WHITESPACE"," ",318],["T_VARIABLE","$this",318],["T_OBJECT_OPERATOR","->",318],["T_STRING","_calculator",318],["T_OBJECT_OPERATOR","->",318],["T_STRING","calcTaxAmount",318],"(",["T_VARIABLE","$baseTaxable",318],",",["T_WHITESPACE"," ",318],["T_VARIABLE","$taxRate",318],",",["T_WHITESPACE"," ",318],["T_STRING","false",318],")",";",["T_WHITESPACE","\n            ",318],"}",["T_WHITESPACE","\n            ",319],["T_VARIABLE","$tax",320],["T_WHITESPACE","             ",320],"=",["T_WHITESPACE"," ",320],["T_STRING","array_sum",320],"(",["T_VARIABLE","$taxes",320],")",";",["T_WHITESPACE","\n            ",320],["T_VARIABLE","$baseTax",321],["T_WHITESPACE","         ",321],"=",["T_WHITESPACE"," ",321],["T_STRING","array_sum",321],"(",["T_VARIABLE","$baseTaxes",321],")",";",["T_WHITESPACE","\n            ",321],["T_VARIABLE","$taxPrice",322],["T_WHITESPACE","        ",322],"=",["T_WHITESPACE"," ",322],["T_VARIABLE","$price",322],["T_WHITESPACE"," ",322],"+",["T_WHITESPACE"," ",322],["T_VARIABLE","$tax",322],";",["T_WHITESPACE","\n            ",322],["T_VARIABLE","$baseTaxPrice",323],["T_WHITESPACE","    ",323],"=",["T_WHITESPACE"," ",323],["T_VARIABLE","$basePrice",323],["T_WHITESPACE"," ",323],"+",["T_WHITESPACE"," ",323],["T_VARIABLE","$baseTax",323],";",["T_WHITESPACE","\n            ",323],["T_VARIABLE","$taxSubtotal",324],["T_WHITESPACE","     ",324],"=",["T_WHITESPACE"," ",324],["T_VARIABLE","$taxPrice",324],["T_WHITESPACE"," ",324],"*",["T_WHITESPACE"," ",324],["T_VARIABLE","$qty",324],";",["T_WHITESPACE","\n            ",324],["T_VARIABLE","$baseTaxSubtotal",325],["T_WHITESPACE"," ",325],"=",["T_WHITESPACE"," ",325],["T_VARIABLE","$baseTaxPrice",325],["T_WHITESPACE"," ",325],"*",["T_WHITESPACE"," ",325],["T_VARIABLE","$qty",325],";",["T_WHITESPACE","\n            ",325],["T_VARIABLE","$isPriceInclTax",326],["T_WHITESPACE","  ",326],"=",["T_WHITESPACE"," ",326],["T_STRING","false",326],";",["T_WHITESPACE","\n        ",326],"}",["T_WHITESPACE","\n\n        ",327],["T_IF","if",329],["T_WHITESPACE"," ",329],"(",["T_VARIABLE","$item",329],["T_OBJECT_OPERATOR","->",329],["T_STRING","hasCustomPrice",329],"(",")",")",["T_WHITESPACE"," ",329],"{",["T_WHITESPACE","\n            ",329],["T_DOC_COMMENT","\/**\n             * Initialize item original price before declaring custom price\n             *\/",330],["T_WHITESPACE","\n            ",332],["T_VARIABLE","$item",333],["T_OBJECT_OPERATOR","->",333],["T_STRING","getOriginalPrice",333],"(",")",";",["T_WHITESPACE","\n            ",333],["T_VARIABLE","$item",334],["T_OBJECT_OPERATOR","->",334],["T_STRING","setCustomPrice",334],"(",["T_VARIABLE","$price",334],")",";",["T_WHITESPACE","\n            ",334],["T_VARIABLE","$item",335],["T_OBJECT_OPERATOR","->",335],["T_STRING","setBaseCustomPrice",335],"(",["T_VARIABLE","$basePrice",335],")",";",["T_WHITESPACE","\n        ",335],"}",["T_WHITESPACE","\n        ",336],["T_VARIABLE","$item",337],["T_OBJECT_OPERATOR","->",337],["T_STRING","setPrice",337],"(",["T_VARIABLE","$basePrice",337],")",";",["T_WHITESPACE","\n        ",337],["T_VARIABLE","$item",338],["T_OBJECT_OPERATOR","->",338],["T_STRING","setBasePrice",338],"(",["T_VARIABLE","$basePrice",338],")",";",["T_WHITESPACE","\n        ",338],["T_VARIABLE","$item",339],["T_OBJECT_OPERATOR","->",339],["T_STRING","setRowTotal",339],"(",["T_VARIABLE","$subtotal",339],")",";",["T_WHITESPACE","\n        ",339],["T_VARIABLE","$item",340],["T_OBJECT_OPERATOR","->",340],["T_STRING","setBaseRowTotal",340],"(",["T_VARIABLE","$baseSubtotal",340],")",";",["T_WHITESPACE","\n        ",340],["T_VARIABLE","$item",341],["T_OBJECT_OPERATOR","->",341],["T_STRING","setPriceInclTax",341],"(",["T_VARIABLE","$taxPrice",341],")",";",["T_WHITESPACE","\n        ",341],["T_VARIABLE","$item",342],["T_OBJECT_OPERATOR","->",342],["T_STRING","setBasePriceInclTax",342],"(",["T_VARIABLE","$baseTaxPrice",342],")",";",["T_WHITESPACE","\n        ",342],["T_VARIABLE","$item",343],["T_OBJECT_OPERATOR","->",343],["T_STRING","setRowTotalInclTax",343],"(",["T_VARIABLE","$taxSubtotal",343],")",";",["T_WHITESPACE","\n        ",343],["T_VARIABLE","$item",344],["T_OBJECT_OPERATOR","->",344],["T_STRING","setBaseRowTotalInclTax",344],"(",["T_VARIABLE","$baseTaxSubtotal",344],")",";",["T_WHITESPACE","\n        ",344],["T_VARIABLE","$item",345],["T_OBJECT_OPERATOR","->",345],["T_STRING","setTaxableAmount",345],"(",["T_VARIABLE","$taxable",345],")",";",["T_WHITESPACE","\n        ",345],["T_VARIABLE","$item",346],["T_OBJECT_OPERATOR","->",346],["T_STRING","setBaseTaxableAmount",346],"(",["T_VARIABLE","$baseTaxable",346],")",";",["T_WHITESPACE","\n        ",346],["T_VARIABLE","$item",347],["T_OBJECT_OPERATOR","->",347],["T_STRING","setIsPriceInclTax",347],"(",["T_VARIABLE","$isPriceInclTax",347],")",";",["T_WHITESPACE","\n        ",347],["T_IF","if",348],["T_WHITESPACE"," ",348],"(",["T_VARIABLE","$this",348],["T_OBJECT_OPERATOR","->",348],["T_STRING","_config",348],["T_OBJECT_OPERATOR","->",348],["T_STRING","discountTax",348],"(",["T_VARIABLE","$this",348],["T_OBJECT_OPERATOR","->",348],["T_STRING","_store",348],")",")",["T_WHITESPACE"," ",348],"{",["T_WHITESPACE","\n            ",348],["T_VARIABLE","$item",349],["T_OBJECT_OPERATOR","->",349],["T_STRING","setDiscountCalculationPrice",349],"(",["T_VARIABLE","$taxPrice",349],")",";",["T_WHITESPACE","\n            ",349],["T_VARIABLE","$item",350],["T_OBJECT_OPERATOR","->",350],["T_STRING","setBaseDiscountCalculationPrice",350],"(",["T_VARIABLE","$baseTaxPrice",350],")",";",["T_WHITESPACE","\n        ",350],"}",["T_WHITESPACE","\n        ",351],["T_RETURN","return",352],["T_WHITESPACE"," ",352],["T_VARIABLE","$this",352],";",["T_WHITESPACE","\n    ",352],"}",["T_WHITESPACE","\n\n    ",353],["T_DOC_COMMENT","\/**\n     * Calculate item price and row total including\/excluding tax based on row total price rounding level\n     *\n     * @param Mage_Sales_Model_Quote_Item_Abstract $item\n     * @param Varien_Object $request\n     *\n     * @return Mage_Tax_Model_Sales_Total_Quote_Subtotal\n     *\/",355],["T_WHITESPACE","\n    ",362],["T_PROTECTED","protected",363],["T_WHITESPACE"," ",363],["T_FUNCTION","function",363],["T_WHITESPACE"," ",363],["T_STRING","_rowBaseCalculation",363],"(",["T_VARIABLE","$item",363],",",["T_WHITESPACE"," ",363],["T_VARIABLE","$request",363],")",["T_WHITESPACE","\n    ",363],"{",["T_WHITESPACE","\n        ",364],["T_VARIABLE","$request",365],["T_OBJECT_OPERATOR","->",365],["T_STRING","setProductClassId",365],"(",["T_VARIABLE","$item",365],["T_OBJECT_OPERATOR","->",365],["T_STRING","getProduct",365],"(",")",["T_OBJECT_OPERATOR","->",365],["T_STRING","getTaxClassId",365],"(",")",")",";",["T_WHITESPACE","\n        ",365],["T_VARIABLE","$rate",366],["T_WHITESPACE"," ",366],"=",["T_WHITESPACE"," ",366],["T_VARIABLE","$this",366],["T_OBJECT_OPERATOR","->",366],["T_STRING","_calculator",366],["T_OBJECT_OPERATOR","->",366],["T_STRING","getRate",366],"(",["T_VARIABLE","$request",366],")",";",["T_WHITESPACE","\n        ",366],["T_VARIABLE","$qty",367],["T_WHITESPACE"," ",367],"=",["T_WHITESPACE"," ",367],["T_VARIABLE","$item",367],["T_OBJECT_OPERATOR","->",367],["T_STRING","getTotalQty",367],"(",")",";",["T_WHITESPACE","\n\n        ",367],["T_VARIABLE","$price",369],["T_WHITESPACE"," ",369],"=",["T_WHITESPACE"," ",369],["T_VARIABLE","$taxPrice",369],["T_WHITESPACE"," ",369],"=",["T_WHITESPACE"," ",369],["T_VARIABLE","$this",369],["T_OBJECT_OPERATOR","->",369],["T_STRING","_calculator",369],["T_OBJECT_OPERATOR","->",369],["T_STRING","round",369],"(",["T_VARIABLE","$item",369],["T_OBJECT_OPERATOR","->",369],["T_STRING","getCalculationPriceOriginal",369],"(",")",")",";",["T_WHITESPACE","\n        ",369],["T_VARIABLE","$basePrice",370],["T_WHITESPACE"," ",370],"=",["T_WHITESPACE"," ",370],["T_VARIABLE","$baseTaxPrice",370],["T_WHITESPACE"," ",370],"=",["T_WHITESPACE"," ",370],["T_VARIABLE","$this",370],["T_OBJECT_OPERATOR","->",370],["T_STRING","_calculator",370],["T_OBJECT_OPERATOR","->",370],["T_STRING","round",370],"(",["T_VARIABLE","$item",370],["T_OBJECT_OPERATOR","->",370],["T_STRING","getBaseCalculationPriceOriginal",370],"(",")",")",";",["T_WHITESPACE","\n        ",370],["T_VARIABLE","$subtotal",371],["T_WHITESPACE"," ",371],"=",["T_WHITESPACE"," ",371],["T_VARIABLE","$taxSubtotal",371],["T_WHITESPACE"," ",371],"=",["T_WHITESPACE"," ",371],["T_VARIABLE","$this",371],["T_OBJECT_OPERATOR","->",371],["T_STRING","_calculator",371],["T_OBJECT_OPERATOR","->",371],["T_STRING","round",371],"(",["T_VARIABLE","$item",371],["T_OBJECT_OPERATOR","->",371],["T_STRING","getRowTotal",371],"(",")",")",";",["T_WHITESPACE","\n        ",371],["T_VARIABLE","$baseSubtotal",372],["T_WHITESPACE"," ",372],"=",["T_WHITESPACE"," ",372],["T_VARIABLE","$baseTaxSubtotal",372],["T_WHITESPACE"," ",372],"=",["T_WHITESPACE"," ",372],["T_VARIABLE","$this",372],["T_OBJECT_OPERATOR","->",372],["T_STRING","_calculator",372],["T_OBJECT_OPERATOR","->",372],["T_STRING","round",372],"(",["T_VARIABLE","$item",372],["T_OBJECT_OPERATOR","->",372],["T_STRING","getBaseRowTotal",372],"(",")",")",";",["T_WHITESPACE","\n\n        ",372],["T_COMMENT","\/\/ if we have a custom price, determine if tax should be based on the original price\n",374],["T_WHITESPACE","        ",375],["T_VARIABLE","$taxOnOrigPrice",375],["T_WHITESPACE"," ",375],"=",["T_WHITESPACE"," ",375],"!",["T_VARIABLE","$this",375],["T_OBJECT_OPERATOR","->",375],["T_STRING","_helper",375],["T_OBJECT_OPERATOR","->",375],["T_STRING","applyTaxOnCustomPrice",375],"(",["T_VARIABLE","$this",375],["T_OBJECT_OPERATOR","->",375],["T_STRING","_store",375],")",["T_WHITESPACE"," ",375],["T_BOOLEAN_AND","&&",375],["T_WHITESPACE"," ",375],["T_VARIABLE","$item",375],["T_OBJECT_OPERATOR","->",375],["T_STRING","hasCustomPrice",375],"(",")",";",["T_WHITESPACE","\n        ",375],["T_IF","if",376],["T_WHITESPACE"," ",376],"(",["T_VARIABLE","$taxOnOrigPrice",376],")",["T_WHITESPACE"," ",376],"{",["T_WHITESPACE","\n            ",376],["T_VARIABLE","$origSubtotal",377],["T_WHITESPACE"," ",377],"=",["T_WHITESPACE"," ",377],["T_VARIABLE","$item",377],["T_OBJECT_OPERATOR","->",377],["T_STRING","getOriginalPrice",377],"(",")",["T_WHITESPACE"," ",377],"*",["T_WHITESPACE"," ",377],["T_VARIABLE","$qty",377],";",["T_WHITESPACE","\n            ",377],["T_VARIABLE","$baseOrigSubtotal",378],["T_WHITESPACE"," ",378],"=",["T_WHITESPACE"," ",378],["T_VARIABLE","$item",378],["T_OBJECT_OPERATOR","->",378],["T_STRING","getBaseOriginalPrice",378],"(",")",["T_WHITESPACE"," ",378],"*",["T_WHITESPACE"," ",378],["T_VARIABLE","$qty",378],";",["T_WHITESPACE","\n        ",378],"}",["T_WHITESPACE","\n\n        ",379],["T_VARIABLE","$item",381],["T_OBJECT_OPERATOR","->",381],["T_STRING","setTaxPercent",381],"(",["T_VARIABLE","$rate",381],")",";",["T_WHITESPACE","\n        ",381],["T_IF","if",382],["T_WHITESPACE"," ",382],"(",["T_VARIABLE","$this",382],["T_OBJECT_OPERATOR","->",382],["T_STRING","_config",382],["T_OBJECT_OPERATOR","->",382],["T_STRING","priceIncludesTax",382],"(",["T_VARIABLE","$this",382],["T_OBJECT_OPERATOR","->",382],["T_STRING","_store",382],")",")",["T_WHITESPACE"," ",382],"{",["T_WHITESPACE","\n            ",382],["T_IF","if",383],["T_WHITESPACE"," ",383],"(",["T_VARIABLE","$this",383],["T_OBJECT_OPERATOR","->",383],["T_STRING","_sameRateAsStore",383],"(",["T_VARIABLE","$request",383],")",")",["T_WHITESPACE"," ",383],"{",["T_WHITESPACE","\n                ",383],["T_COMMENT","\/\/ determine which price to use when we calculate the tax\n",384],["T_WHITESPACE","                ",385],["T_IF","if",385],["T_WHITESPACE"," ",385],"(",["T_VARIABLE","$taxOnOrigPrice",385],")",["T_WHITESPACE"," ",385],"{",["T_WHITESPACE","\n                    ",385],["T_VARIABLE","$taxable",386],["T_WHITESPACE","        ",386],"=",["T_WHITESPACE"," ",386],["T_VARIABLE","$origSubtotal",386],";",["T_WHITESPACE","\n                    ",386],["T_VARIABLE","$baseTaxable",387],["T_WHITESPACE","    ",387],"=",["T_WHITESPACE"," ",387],["T_VARIABLE","$baseOrigSubtotal",387],";",["T_WHITESPACE","\n                ",387],"}",["T_WHITESPACE"," ",388],["T_ELSE","else",388],["T_WHITESPACE"," ",388],"{",["T_WHITESPACE","\n                    ",388],["T_VARIABLE","$taxable",389],["T_WHITESPACE","        ",389],"=",["T_WHITESPACE"," ",389],["T_VARIABLE","$taxSubtotal",389],";",["T_WHITESPACE","\n                    ",389],["T_VARIABLE","$baseTaxable",390],["T_WHITESPACE","    ",390],"=",["T_WHITESPACE"," ",390],["T_VARIABLE","$baseTaxSubtotal",390],";",["T_WHITESPACE","\n                ",390],"}",["T_WHITESPACE","\n                ",391],["T_VARIABLE","$rowTax",392],["T_WHITESPACE","          ",392],"=",["T_WHITESPACE"," ",392],["T_VARIABLE","$this",392],["T_OBJECT_OPERATOR","->",392],["T_STRING","_calculator",392],["T_OBJECT_OPERATOR","->",392],["T_STRING","calcTaxAmount",392],"(",["T_VARIABLE","$taxable",392],",",["T_WHITESPACE"," ",392],["T_VARIABLE","$rate",392],",",["T_WHITESPACE"," ",392],["T_STRING","true",392],",",["T_WHITESPACE"," ",392],["T_STRING","true",392],")",";",["T_WHITESPACE","\n                ",392],["T_VARIABLE","$baseRowTax",393],["T_WHITESPACE","      ",393],"=",["T_WHITESPACE"," ",393],["T_VARIABLE","$this",393],["T_OBJECT_OPERATOR","->",393],["T_STRING","_calculator",393],["T_OBJECT_OPERATOR","->",393],["T_STRING","calcTaxAmount",393],"(",["T_VARIABLE","$baseTaxable",393],",",["T_WHITESPACE"," ",393],["T_VARIABLE","$rate",393],",",["T_WHITESPACE"," ",393],["T_STRING","true",393],",",["T_WHITESPACE"," ",393],["T_STRING","true",393],")",";",["T_WHITESPACE","\n                ",393],["T_VARIABLE","$taxPrice",394],["T_WHITESPACE","        ",394],"=",["T_WHITESPACE"," ",394],["T_VARIABLE","$price",394],";",["T_WHITESPACE","\n                ",394],["T_VARIABLE","$baseTaxPrice",395],["T_WHITESPACE","    ",395],"=",["T_WHITESPACE"," ",395],["T_VARIABLE","$basePrice",395],";",["T_WHITESPACE","\n                ",395],["T_VARIABLE","$taxSubtotal",396],["T_WHITESPACE","     ",396],"=",["T_WHITESPACE"," ",396],["T_VARIABLE","$subtotal",396],";",["T_WHITESPACE","\n                ",396],["T_VARIABLE","$baseTaxSubtotal",397],["T_WHITESPACE"," ",397],"=",["T_WHITESPACE"," ",397],["T_VARIABLE","$baseSubtotal",397],";",["T_WHITESPACE","\n                ",397],["T_VARIABLE","$subtotal",398],["T_WHITESPACE"," ",398],"=",["T_WHITESPACE"," ",398],["T_VARIABLE","$this",398],["T_OBJECT_OPERATOR","->",398],["T_STRING","_calculator",398],["T_OBJECT_OPERATOR","->",398],["T_STRING","round",398],"(",["T_VARIABLE","$subtotal",398],["T_WHITESPACE"," ",398],"-",["T_WHITESPACE"," ",398],["T_VARIABLE","$rowTax",398],")",";",["T_WHITESPACE","\n                ",398],["T_VARIABLE","$baseSubtotal",399],["T_WHITESPACE"," ",399],"=",["T_WHITESPACE"," ",399],["T_VARIABLE","$this",399],["T_OBJECT_OPERATOR","->",399],["T_STRING","_calculator",399],["T_OBJECT_OPERATOR","->",399],["T_STRING","round",399],"(",["T_VARIABLE","$baseSubtotal",399],["T_WHITESPACE"," ",399],"-",["T_WHITESPACE"," ",399],["T_VARIABLE","$baseRowTax",399],")",";",["T_WHITESPACE","\n                ",399],["T_VARIABLE","$price",400],["T_WHITESPACE"," ",400],"=",["T_WHITESPACE"," ",400],["T_VARIABLE","$this",400],["T_OBJECT_OPERATOR","->",400],["T_STRING","_calculator",400],["T_OBJECT_OPERATOR","->",400],["T_STRING","round",400],"(",["T_VARIABLE","$subtotal",400],["T_WHITESPACE"," ",400],"\/",["T_WHITESPACE"," ",400],["T_VARIABLE","$qty",400],")",";",["T_WHITESPACE","\n                ",400],["T_VARIABLE","$basePrice",401],["T_WHITESPACE"," ",401],"=",["T_WHITESPACE"," ",401],["T_VARIABLE","$this",401],["T_OBJECT_OPERATOR","->",401],["T_STRING","_calculator",401],["T_OBJECT_OPERATOR","->",401],["T_STRING","round",401],"(",["T_VARIABLE","$baseSubtotal",401],["T_WHITESPACE"," ",401],"\/",["T_WHITESPACE"," ",401],["T_VARIABLE","$qty",401],")",";",["T_WHITESPACE","\n                ",401],["T_VARIABLE","$isPriceInclTax",402],["T_WHITESPACE","  ",402],"=",["T_WHITESPACE"," ",402],["T_STRING","true",402],";",["T_WHITESPACE","\n\n                ",402],["T_VARIABLE","$item",404],["T_OBJECT_OPERATOR","->",404],["T_STRING","setRowTax",404],"(",["T_VARIABLE","$rowTax",404],")",";",["T_WHITESPACE","\n                ",404],["T_VARIABLE","$item",405],["T_OBJECT_OPERATOR","->",405],["T_STRING","setBaseRowTax",405],"(",["T_VARIABLE","$baseRowTax",405],")",";",["T_WHITESPACE","\n            ",405],"}",["T_WHITESPACE"," ",406],["T_ELSE","else",406],["T_WHITESPACE"," ",406],"{",["T_WHITESPACE","\n                ",406],["T_VARIABLE","$storeRate",407],["T_WHITESPACE","       ",407],"=",["T_WHITESPACE"," ",407],["T_VARIABLE","$this",407],["T_OBJECT_OPERATOR","->",407],["T_STRING","_calculator",407],["T_OBJECT_OPERATOR","->",407],["T_STRING","getStoreRate",407],"(",["T_VARIABLE","$request",407],",",["T_WHITESPACE"," ",407],["T_VARIABLE","$this",407],["T_OBJECT_OPERATOR","->",407],["T_STRING","_store",407],")",";",["T_WHITESPACE","\n                ",407],["T_IF","if",408],["T_WHITESPACE"," ",408],"(",["T_VARIABLE","$taxOnOrigPrice",408],")",["T_WHITESPACE"," ",408],"{",["T_WHITESPACE","\n                    ",408],["T_COMMENT","\/\/ the merchant already provided a customer's price that includes tax\n",409],["T_WHITESPACE","                    ",410],["T_VARIABLE","$taxPrice",410],["T_WHITESPACE","     ",410],"=",["T_WHITESPACE"," ",410],["T_VARIABLE","$price",410],";",["T_WHITESPACE","\n                    ",410],["T_VARIABLE","$baseTaxPrice",411],["T_WHITESPACE"," ",411],"=",["T_WHITESPACE"," ",411],["T_VARIABLE","$basePrice",411],";",["T_WHITESPACE","\n                    ",411],["T_COMMENT","\/\/ determine which price to use when we calculate the tax\n",412],["T_WHITESPACE","                    ",413],["T_VARIABLE","$taxable",413],["T_WHITESPACE","      ",413],"=",["T_WHITESPACE"," ",413],["T_VARIABLE","$this",413],["T_OBJECT_OPERATOR","->",413],["T_STRING","_calculatePriceInclTax",413],"(",["T_VARIABLE","$item",413],["T_OBJECT_OPERATOR","->",413],["T_STRING","getOriginalPrice",413],"(",")",",",["T_WHITESPACE"," ",413],["T_VARIABLE","$storeRate",413],",",["T_WHITESPACE"," ",413],["T_VARIABLE","$rate",413],")",";",["T_WHITESPACE","\n                    ",413],["T_VARIABLE","$baseTaxable",414],["T_WHITESPACE","  ",414],"=",["T_WHITESPACE"," ",414],["T_VARIABLE","$this",414],["T_OBJECT_OPERATOR","->",414],["T_STRING","_calculatePriceInclTax",414],"(",["T_VARIABLE","$item",414],["T_OBJECT_OPERATOR","->",414],["T_STRING","getBaseOriginalPrice",414],"(",")",",",["T_WHITESPACE"," ",414],["T_VARIABLE","$storeRate",414],",",["T_WHITESPACE"," ",414],["T_VARIABLE","$rate",414],")",";",["T_WHITESPACE","\n                ",414],"}",["T_WHITESPACE"," ",415],["T_ELSE","else",415],["T_WHITESPACE"," ",415],"{",["T_WHITESPACE","\n                    ",415],["T_COMMENT","\/\/ determine the customer's price that includes tax\n",416],["T_WHITESPACE","                    ",417],["T_VARIABLE","$taxPrice",417],["T_WHITESPACE","     ",417],"=",["T_WHITESPACE"," ",417],["T_VARIABLE","$this",417],["T_OBJECT_OPERATOR","->",417],["T_STRING","_calculatePriceInclTax",417],"(",["T_VARIABLE","$price",417],",",["T_WHITESPACE"," ",417],["T_VARIABLE","$storeRate",417],",",["T_WHITESPACE"," ",417],["T_VARIABLE","$rate",417],")",";",["T_WHITESPACE","\n                    ",417],["T_VARIABLE","$baseTaxPrice",418],["T_WHITESPACE"," ",418],"=",["T_WHITESPACE"," ",418],["T_VARIABLE","$this",418],["T_OBJECT_OPERATOR","->",418],["T_STRING","_calculatePriceInclTax",418],"(",["T_VARIABLE","$basePrice",418],",",["T_WHITESPACE"," ",418],["T_VARIABLE","$storeRate",418],",",["T_WHITESPACE"," ",418],["T_VARIABLE","$rate",418],")",";",["T_WHITESPACE","\n                    ",418],["T_COMMENT","\/\/ determine which price to use when we calculate the tax\n",419],["T_WHITESPACE","                    ",420],["T_VARIABLE","$taxable",420],["T_WHITESPACE","      ",420],"=",["T_WHITESPACE"," ",420],["T_VARIABLE","$taxPrice",420],";",["T_WHITESPACE","\n                    ",420],["T_VARIABLE","$baseTaxable",421],["T_WHITESPACE","  ",421],"=",["T_WHITESPACE"," ",421],["T_VARIABLE","$baseTaxPrice",421],";",["T_WHITESPACE","\n                ",421],"}",["T_WHITESPACE","\n                ",422],["T_COMMENT","\/\/ determine the customer's tax amount\n",423],["T_WHITESPACE","                ",424],["T_VARIABLE","$tax",424],["T_WHITESPACE","             ",424],"=",["T_WHITESPACE"," ",424],["T_VARIABLE","$this",424],["T_OBJECT_OPERATOR","->",424],["T_STRING","_calculator",424],["T_OBJECT_OPERATOR","->",424],["T_STRING","calcTaxAmount",424],"(",["T_VARIABLE","$taxable",424],",",["T_WHITESPACE"," ",424],["T_VARIABLE","$rate",424],",",["T_WHITESPACE"," ",424],["T_STRING","true",424],",",["T_WHITESPACE"," ",424],["T_STRING","true",424],")",";",["T_WHITESPACE","\n                ",424],["T_VARIABLE","$baseTax",425],["T_WHITESPACE","         ",425],"=",["T_WHITESPACE"," ",425],["T_VARIABLE","$this",425],["T_OBJECT_OPERATOR","->",425],["T_STRING","_calculator",425],["T_OBJECT_OPERATOR","->",425],["T_STRING","calcTaxAmount",425],"(",["T_VARIABLE","$baseTaxable",425],",",["T_WHITESPACE"," ",425],["T_VARIABLE","$rate",425],",",["T_WHITESPACE"," ",425],["T_STRING","true",425],",",["T_WHITESPACE"," ",425],["T_STRING","true",425],")",";",["T_WHITESPACE","\n                ",425],["T_COMMENT","\/\/ determine the customer's price without taxes\n",426],["T_WHITESPACE","                ",427],["T_VARIABLE","$price",427],["T_WHITESPACE"," ",427],"=",["T_WHITESPACE"," ",427],["T_VARIABLE","$taxPrice",427],["T_WHITESPACE"," ",427],"-",["T_WHITESPACE"," ",427],["T_VARIABLE","$tax",427],";",["T_WHITESPACE","\n                ",427],["T_VARIABLE","$basePrice",428],["T_WHITESPACE"," ",428],"=",["T_WHITESPACE"," ",428],["T_VARIABLE","$baseTaxPrice",428],["T_WHITESPACE"," ",428],"-",["T_WHITESPACE"," ",428],["T_VARIABLE","$baseTax",428],";",["T_WHITESPACE","\n                ",428],["T_COMMENT","\/\/ determine subtotal amounts\n",429],["T_WHITESPACE","                ",430],["T_VARIABLE","$taxable",430],["T_WHITESPACE","        ",430],["T_MUL_EQUAL","*=",430],["T_WHITESPACE"," ",430],["T_VARIABLE","$qty",430],";",["T_WHITESPACE","\n                ",430],["T_VARIABLE","$baseTaxable",431],["T_WHITESPACE","    ",431],["T_MUL_EQUAL","*=",431],["T_WHITESPACE"," ",431],["T_VARIABLE","$qty",431],";",["T_WHITESPACE","\n                ",431],["T_VARIABLE","$taxSubtotal",432],["T_WHITESPACE","     ",432],"=",["T_WHITESPACE"," ",432],["T_VARIABLE","$taxPrice",432],["T_WHITESPACE"," ",432],"*",["T_WHITESPACE"," ",432],["T_VARIABLE","$qty",432],";",["T_WHITESPACE","\n                ",432],["T_VARIABLE","$baseTaxSubtotal",433],["T_WHITESPACE"," ",433],"=",["T_WHITESPACE"," ",433],["T_VARIABLE","$baseTaxPrice",433],["T_WHITESPACE"," ",433],"*",["T_WHITESPACE"," ",433],["T_VARIABLE","$qty",433],";",["T_WHITESPACE","\n                ",433],["T_VARIABLE","$rowTax",434],["T_WHITESPACE","          ",434],"=",["T_WHITESPACE"," ",434],["T_VARIABLE","$this",434],["T_OBJECT_OPERATOR","->",434],["T_STRING","_calculator",434],["T_OBJECT_OPERATOR","->",434],["T_STRING","calcTaxAmount",434],"(",["T_VARIABLE","$taxable",434],",",["T_WHITESPACE"," ",434],["T_VARIABLE","$rate",434],",",["T_WHITESPACE"," ",434],["T_STRING","true",434],",",["T_WHITESPACE"," ",434],["T_STRING","true",434],")",";",["T_WHITESPACE","\n                ",434],["T_VARIABLE","$baseRowTax",435],["T_WHITESPACE","      ",435],"=",["T_WHITESPACE"," ",435],["T_VARIABLE","$this",435],["T_OBJECT_OPERATOR","->",435],["T_STRING","_calculator",435],["T_OBJECT_OPERATOR","->",435],["T_STRING","calcTaxAmount",435],"(",["T_VARIABLE","$baseTaxable",435],",",["T_WHITESPACE"," ",435],["T_VARIABLE","$rate",435],",",["T_WHITESPACE"," ",435],["T_STRING","true",435],",",["T_WHITESPACE"," ",435],["T_STRING","true",435],")",";",["T_WHITESPACE","\n                ",435],["T_VARIABLE","$subtotal",436],["T_WHITESPACE","        ",436],"=",["T_WHITESPACE"," ",436],["T_VARIABLE","$taxSubtotal",436],["T_WHITESPACE"," ",436],"-",["T_WHITESPACE"," ",436],["T_VARIABLE","$rowTax",436],";",["T_WHITESPACE","\n                ",436],["T_VARIABLE","$baseSubtotal",437],["T_WHITESPACE","    ",437],"=",["T_WHITESPACE"," ",437],["T_VARIABLE","$baseTaxSubtotal",437],["T_WHITESPACE"," ",437],"-",["T_WHITESPACE"," ",437],["T_VARIABLE","$baseRowTax",437],";",["T_WHITESPACE","\n                ",437],["T_VARIABLE","$isPriceInclTax",438],["T_WHITESPACE","  ",438],"=",["T_WHITESPACE"," ",438],["T_STRING","true",438],";",["T_WHITESPACE","\n\n                ",438],["T_VARIABLE","$item",440],["T_OBJECT_OPERATOR","->",440],["T_STRING","setRowTax",440],"(",["T_VARIABLE","$rowTax",440],")",";",["T_WHITESPACE","\n                ",440],["T_VARIABLE","$item",441],["T_OBJECT_OPERATOR","->",441],["T_STRING","setBaseRowTax",441],"(",["T_VARIABLE","$baseRowTax",441],")",";",["T_WHITESPACE","\n            ",441],"}",["T_WHITESPACE","\n        ",442],"}",["T_WHITESPACE"," ",443],["T_ELSE","else",443],["T_WHITESPACE"," ",443],"{",["T_WHITESPACE","\n            ",443],["T_COMMENT","\/\/ determine which price to use when we calculate the tax\n",444],["T_WHITESPACE","            ",445],["T_IF","if",445],["T_WHITESPACE"," ",445],"(",["T_VARIABLE","$taxOnOrigPrice",445],")",["T_WHITESPACE"," ",445],"{",["T_WHITESPACE","\n                ",445],["T_VARIABLE","$taxable",446],["T_WHITESPACE"," ",446],"=",["T_WHITESPACE"," ",446],["T_VARIABLE","$origSubtotal",446],";",["T_WHITESPACE","\n                ",446],["T_VARIABLE","$baseTaxable",447],["T_WHITESPACE"," ",447],"=",["T_WHITESPACE"," ",447],["T_VARIABLE","$baseOrigSubtotal",447],";",["T_WHITESPACE","\n            ",447],"}",["T_WHITESPACE"," ",448],["T_ELSE","else",448],["T_WHITESPACE"," ",448],"{",["T_WHITESPACE","\n                ",448],["T_VARIABLE","$taxable",449],["T_WHITESPACE"," ",449],"=",["T_WHITESPACE"," ",449],["T_VARIABLE","$subtotal",449],";",["T_WHITESPACE","\n                ",449],["T_VARIABLE","$baseTaxable",450],["T_WHITESPACE"," ",450],"=",["T_WHITESPACE"," ",450],["T_VARIABLE","$baseSubtotal",450],";",["T_WHITESPACE","\n            ",450],"}",["T_WHITESPACE","\n\n            ",451],["T_VARIABLE","$appliedRates",453],["T_WHITESPACE"," ",453],"=",["T_WHITESPACE"," ",453],["T_VARIABLE","$this",453],["T_OBJECT_OPERATOR","->",453],["T_STRING","_calculator",453],["T_OBJECT_OPERATOR","->",453],["T_STRING","getAppliedRates",453],"(",["T_VARIABLE","$request",453],")",";",["T_WHITESPACE","\n            ",453],["T_VARIABLE","$rowTaxes",454],["T_WHITESPACE"," ",454],"=",["T_WHITESPACE"," ",454],["T_ARRAY","array",454],"(",")",";",["T_WHITESPACE","\n            ",454],["T_VARIABLE","$baseRowTaxes",455],["T_WHITESPACE"," ",455],"=",["T_WHITESPACE"," ",455],["T_ARRAY","array",455],"(",")",";",["T_WHITESPACE","\n            ",455],["T_FOREACH","foreach",456],["T_WHITESPACE"," ",456],"(",["T_VARIABLE","$appliedRates",456],["T_WHITESPACE"," ",456],["T_AS","as",456],["T_WHITESPACE"," ",456],["T_VARIABLE","$appliedRate",456],")",["T_WHITESPACE"," ",456],"{",["T_WHITESPACE","\n                ",456],["T_VARIABLE","$taxRate",457],["T_WHITESPACE"," ",457],"=",["T_WHITESPACE"," ",457],["T_VARIABLE","$appliedRate",457],"[",["T_CONSTANT_ENCAPSED_STRING","'percent'",457],"]",";",["T_WHITESPACE","\n                ",457],["T_VARIABLE","$rowTaxes",458],"[","]",["T_WHITESPACE"," ",458],"=",["T_WHITESPACE"," ",458],["T_VARIABLE","$this",458],["T_OBJECT_OPERATOR","->",458],["T_STRING","_calculator",458],["T_OBJECT_OPERATOR","->",458],["T_STRING","calcTaxAmount",458],"(",["T_VARIABLE","$taxable",458],",",["T_WHITESPACE"," ",458],["T_VARIABLE","$taxRate",458],",",["T_WHITESPACE"," ",458],["T_STRING","false",458],",",["T_WHITESPACE"," ",458],["T_STRING","true",458],")",";",["T_WHITESPACE","\n                ",458],["T_VARIABLE","$baseRowTaxes",459],"[","]",["T_WHITESPACE"," ",459],"=",["T_WHITESPACE"," ",459],["T_VARIABLE","$this",459],["T_OBJECT_OPERATOR","->",459],["T_STRING","_calculator",459],["T_OBJECT_OPERATOR","->",459],["T_STRING","calcTaxAmount",459],"(",["T_VARIABLE","$baseTaxable",459],",",["T_WHITESPACE"," ",459],["T_VARIABLE","$taxRate",459],",",["T_WHITESPACE"," ",459],["T_STRING","false",459],",",["T_WHITESPACE"," ",459],["T_STRING","true",459],")",";",["T_WHITESPACE","\n            ",459],"}",["T_WHITESPACE","\n            ",460],["T_VARIABLE","$rowTax",461],["T_WHITESPACE","          ",461],"=",["T_WHITESPACE"," ",461],["T_STRING","array_sum",461],"(",["T_VARIABLE","$rowTaxes",461],")",";",["T_WHITESPACE","\n            ",461],["T_VARIABLE","$baseRowTax",462],["T_WHITESPACE","      ",462],"=",["T_WHITESPACE"," ",462],["T_STRING","array_sum",462],"(",["T_VARIABLE","$baseRowTaxes",462],")",";",["T_WHITESPACE","\n            ",462],["T_VARIABLE","$taxSubtotal",463],["T_WHITESPACE","     ",463],"=",["T_WHITESPACE"," ",463],["T_VARIABLE","$subtotal",463],["T_WHITESPACE"," ",463],"+",["T_WHITESPACE"," ",463],["T_VARIABLE","$rowTax",463],";",["T_WHITESPACE","\n            ",463],["T_VARIABLE","$baseTaxSubtotal",464],["T_WHITESPACE"," ",464],"=",["T_WHITESPACE"," ",464],["T_VARIABLE","$baseSubtotal",464],["T_WHITESPACE"," ",464],"+",["T_WHITESPACE"," ",464],["T_VARIABLE","$baseRowTax",464],";",["T_WHITESPACE","\n            ",464],["T_VARIABLE","$taxPrice",465],["T_WHITESPACE","        ",465],"=",["T_WHITESPACE"," ",465],["T_VARIABLE","$this",465],["T_OBJECT_OPERATOR","->",465],["T_STRING","_calculator",465],["T_OBJECT_OPERATOR","->",465],["T_STRING","round",465],"(",["T_VARIABLE","$taxSubtotal",465],"\/",["T_VARIABLE","$qty",465],")",";",["T_WHITESPACE","\n            ",465],["T_VARIABLE","$baseTaxPrice",466],["T_WHITESPACE","    ",466],"=",["T_WHITESPACE"," ",466],["T_VARIABLE","$this",466],["T_OBJECT_OPERATOR","->",466],["T_STRING","_calculator",466],["T_OBJECT_OPERATOR","->",466],["T_STRING","round",466],"(",["T_VARIABLE","$baseTaxSubtotal",466],"\/",["T_VARIABLE","$qty",466],")",";",["T_WHITESPACE","\n            ",466],["T_VARIABLE","$isPriceInclTax",467],["T_WHITESPACE","  ",467],"=",["T_WHITESPACE"," ",467],["T_STRING","false",467],";",["T_WHITESPACE","\n        ",467],"}",["T_WHITESPACE","\n\n        ",468],["T_IF","if",470],["T_WHITESPACE"," ",470],"(",["T_VARIABLE","$item",470],["T_OBJECT_OPERATOR","->",470],["T_STRING","hasCustomPrice",470],"(",")",")",["T_WHITESPACE"," ",470],"{",["T_WHITESPACE","\n            ",470],["T_DOC_COMMENT","\/**\n             * Initialize item original price before declaring custom price\n             *\/",471],["T_WHITESPACE","\n            ",473],["T_VARIABLE","$item",474],["T_OBJECT_OPERATOR","->",474],["T_STRING","getOriginalPrice",474],"(",")",";",["T_WHITESPACE","\n            ",474],["T_VARIABLE","$item",475],["T_OBJECT_OPERATOR","->",475],["T_STRING","setCustomPrice",475],"(",["T_VARIABLE","$price",475],")",";",["T_WHITESPACE","\n            ",475],["T_VARIABLE","$item",476],["T_OBJECT_OPERATOR","->",476],["T_STRING","setBaseCustomPrice",476],"(",["T_VARIABLE","$basePrice",476],")",";",["T_WHITESPACE","\n        ",476],"}",["T_WHITESPACE","\n        ",477],["T_VARIABLE","$item",478],["T_OBJECT_OPERATOR","->",478],["T_STRING","setPrice",478],"(",["T_VARIABLE","$basePrice",478],")",";",["T_WHITESPACE","\n        ",478],["T_VARIABLE","$item",479],["T_OBJECT_OPERATOR","->",479],["T_STRING","setBasePrice",479],"(",["T_VARIABLE","$basePrice",479],")",";",["T_WHITESPACE","\n        ",479],["T_VARIABLE","$item",480],["T_OBJECT_OPERATOR","->",480],["T_STRING","setRowTotal",480],"(",["T_VARIABLE","$subtotal",480],")",";",["T_WHITESPACE","\n        ",480],["T_VARIABLE","$item",481],["T_OBJECT_OPERATOR","->",481],["T_STRING","setBaseRowTotal",481],"(",["T_VARIABLE","$baseSubtotal",481],")",";",["T_WHITESPACE","\n        ",481],["T_VARIABLE","$item",482],["T_OBJECT_OPERATOR","->",482],["T_STRING","setPriceInclTax",482],"(",["T_VARIABLE","$taxPrice",482],")",";",["T_WHITESPACE","\n        ",482],["T_VARIABLE","$item",483],["T_OBJECT_OPERATOR","->",483],["T_STRING","setBasePriceInclTax",483],"(",["T_VARIABLE","$baseTaxPrice",483],")",";",["T_WHITESPACE","\n        ",483],["T_VARIABLE","$item",484],["T_OBJECT_OPERATOR","->",484],["T_STRING","setRowTotalInclTax",484],"(",["T_VARIABLE","$taxSubtotal",484],")",";",["T_WHITESPACE","\n        ",484],["T_VARIABLE","$item",485],["T_OBJECT_OPERATOR","->",485],["T_STRING","setBaseRowTotalInclTax",485],"(",["T_VARIABLE","$baseTaxSubtotal",485],")",";",["T_WHITESPACE","\n        ",485],["T_VARIABLE","$item",486],["T_OBJECT_OPERATOR","->",486],["T_STRING","setTaxableAmount",486],"(",["T_VARIABLE","$taxable",486],")",";",["T_WHITESPACE","\n        ",486],["T_VARIABLE","$item",487],["T_OBJECT_OPERATOR","->",487],["T_STRING","setBaseTaxableAmount",487],"(",["T_VARIABLE","$baseTaxable",487],")",";",["T_WHITESPACE","\n        ",487],["T_VARIABLE","$item",488],["T_OBJECT_OPERATOR","->",488],["T_STRING","setIsPriceInclTax",488],"(",["T_VARIABLE","$isPriceInclTax",488],")",";",["T_WHITESPACE","\n        ",488],["T_IF","if",489],["T_WHITESPACE"," ",489],"(",["T_VARIABLE","$this",489],["T_OBJECT_OPERATOR","->",489],["T_STRING","_config",489],["T_OBJECT_OPERATOR","->",489],["T_STRING","discountTax",489],"(",["T_VARIABLE","$this",489],["T_OBJECT_OPERATOR","->",489],["T_STRING","_store",489],")",")",["T_WHITESPACE"," ",489],"{",["T_WHITESPACE","\n            ",489],["T_VARIABLE","$item",490],["T_OBJECT_OPERATOR","->",490],["T_STRING","setDiscountCalculationPrice",490],"(",["T_VARIABLE","$taxSubtotal",490],["T_WHITESPACE"," ",490],"\/",["T_WHITESPACE"," ",490],["T_VARIABLE","$qty",490],")",";",["T_WHITESPACE","\n            ",490],["T_VARIABLE","$item",491],["T_OBJECT_OPERATOR","->",491],["T_STRING","setBaseDiscountCalculationPrice",491],"(",["T_VARIABLE","$baseTaxSubtotal",491],["T_WHITESPACE"," ",491],"\/",["T_WHITESPACE"," ",491],["T_VARIABLE","$qty",491],")",";",["T_WHITESPACE","\n        ",491],"}",["T_WHITESPACE"," ",492],["T_ELSEIF","elseif",492],["T_WHITESPACE"," ",492],"(",["T_VARIABLE","$isPriceInclTax",492],")",["T_WHITESPACE"," ",492],"{",["T_WHITESPACE","\n            ",492],["T_VARIABLE","$item",493],["T_OBJECT_OPERATOR","->",493],["T_STRING","setDiscountCalculationPrice",493],"(",["T_VARIABLE","$subtotal",493],["T_WHITESPACE"," ",493],"\/",["T_WHITESPACE"," ",493],["T_VARIABLE","$qty",493],")",";",["T_WHITESPACE","\n            ",493],["T_VARIABLE","$item",494],["T_OBJECT_OPERATOR","->",494],["T_STRING","setBaseDiscountCalculationPrice",494],"(",["T_VARIABLE","$baseSubtotal",494],["T_WHITESPACE"," ",494],"\/",["T_WHITESPACE"," ",494],["T_VARIABLE","$qty",494],")",";",["T_WHITESPACE","\n        ",494],"}",["T_WHITESPACE","\n\n        ",495],["T_RETURN","return",497],["T_WHITESPACE"," ",497],["T_VARIABLE","$this",497],";",["T_WHITESPACE","\n    ",497],"}",["T_WHITESPACE","\n\n    ",498],["T_DOC_COMMENT","\/**\n     * Calculate item price and row total including\/excluding tax based on total price rounding level\n     *\n     * @param Mage_Sales_Model_Quote_Item_Abstract $item\n     * @param Varien_Object $request\n     *\n     * @return Mage_Tax_Model_Sales_Total_Quote_Subtotal\n     *\/",500],["T_WHITESPACE","\n    ",507],["T_PROTECTED","protected",508],["T_WHITESPACE"," ",508],["T_FUNCTION","function",508],["T_WHITESPACE"," ",508],["T_STRING","_totalBaseCalculation",508],"(",["T_VARIABLE","$item",508],",",["T_WHITESPACE"," ",508],["T_VARIABLE","$request",508],")",["T_WHITESPACE","\n    ",508],"{",["T_WHITESPACE","\n        ",509],["T_VARIABLE","$calc",510],["T_WHITESPACE"," ",510],"=",["T_WHITESPACE"," ",510],["T_VARIABLE","$this",510],["T_OBJECT_OPERATOR","->",510],["T_STRING","_calculator",510],";",["T_WHITESPACE","\n        ",510],["T_VARIABLE","$request",511],["T_OBJECT_OPERATOR","->",511],["T_STRING","setProductClassId",511],"(",["T_VARIABLE","$item",511],["T_OBJECT_OPERATOR","->",511],["T_STRING","getProduct",511],"(",")",["T_OBJECT_OPERATOR","->",511],["T_STRING","getTaxClassId",511],"(",")",")",";",["T_WHITESPACE","\n        ",511],["T_VARIABLE","$rate",512],["T_WHITESPACE"," ",512],"=",["T_WHITESPACE"," ",512],["T_VARIABLE","$calc",512],["T_OBJECT_OPERATOR","->",512],["T_STRING","getRate",512],"(",["T_VARIABLE","$request",512],")",";",["T_WHITESPACE","\n        ",512],["T_VARIABLE","$qty",513],["T_WHITESPACE"," ",513],"=",["T_WHITESPACE"," ",513],["T_VARIABLE","$item",513],["T_OBJECT_OPERATOR","->",513],["T_STRING","getTotalQty",513],"(",")",";",["T_WHITESPACE","\n\n        ",513],["T_VARIABLE","$price",515],["T_WHITESPACE"," ",515],"=",["T_WHITESPACE"," ",515],["T_VARIABLE","$taxPrice",515],["T_WHITESPACE"," ",515],"=",["T_WHITESPACE"," ",515],["T_VARIABLE","$this",515],["T_OBJECT_OPERATOR","->",515],["T_STRING","_calculator",515],["T_OBJECT_OPERATOR","->",515],["T_STRING","round",515],"(",["T_VARIABLE","$item",515],["T_OBJECT_OPERATOR","->",515],["T_STRING","getCalculationPriceOriginal",515],"(",")",")",";",["T_WHITESPACE","\n        ",515],["T_VARIABLE","$basePrice",516],["T_WHITESPACE"," ",516],"=",["T_WHITESPACE"," ",516],["T_VARIABLE","$baseTaxPrice",516],["T_WHITESPACE"," ",516],"=",["T_WHITESPACE"," ",516],["T_VARIABLE","$this",516],["T_OBJECT_OPERATOR","->",516],["T_STRING","_calculator",516],["T_OBJECT_OPERATOR","->",516],["T_STRING","round",516],"(",["T_VARIABLE","$item",516],["T_OBJECT_OPERATOR","->",516],["T_STRING","getBaseCalculationPriceOriginal",516],"(",")",")",";",["T_WHITESPACE","\n        ",516],["T_VARIABLE","$subtotal",517],["T_WHITESPACE"," ",517],"=",["T_WHITESPACE"," ",517],["T_VARIABLE","$taxSubtotal",517],["T_WHITESPACE"," ",517],"=",["T_WHITESPACE"," ",517],["T_VARIABLE","$this",517],["T_OBJECT_OPERATOR","->",517],["T_STRING","_calculator",517],["T_OBJECT_OPERATOR","->",517],["T_STRING","round",517],"(",["T_VARIABLE","$item",517],["T_OBJECT_OPERATOR","->",517],["T_STRING","getRowTotal",517],"(",")",")",";",["T_WHITESPACE","\n        ",517],["T_VARIABLE","$baseSubtotal",518],["T_WHITESPACE"," ",518],"=",["T_WHITESPACE"," ",518],["T_VARIABLE","$baseTaxSubtotal",518],["T_WHITESPACE"," ",518],"=",["T_WHITESPACE"," ",518],["T_VARIABLE","$this",518],["T_OBJECT_OPERATOR","->",518],["T_STRING","_calculator",518],["T_OBJECT_OPERATOR","->",518],["T_STRING","round",518],"(",["T_VARIABLE","$item",518],["T_OBJECT_OPERATOR","->",518],["T_STRING","getBaseRowTotal",518],"(",")",")",";",["T_WHITESPACE","\n\n        ",518],["T_COMMENT","\/\/ if we have a custom price, determine if tax should be based on the original price\n",520],["T_WHITESPACE","        ",521],["T_VARIABLE","$taxOnOrigPrice",521],["T_WHITESPACE"," ",521],"=",["T_WHITESPACE"," ",521],"!",["T_VARIABLE","$this",521],["T_OBJECT_OPERATOR","->",521],["T_STRING","_helper",521],["T_OBJECT_OPERATOR","->",521],["T_STRING","applyTaxOnCustomPrice",521],"(",["T_VARIABLE","$this",521],["T_OBJECT_OPERATOR","->",521],["T_STRING","_store",521],")",["T_WHITESPACE"," ",521],["T_BOOLEAN_AND","&&",521],["T_WHITESPACE"," ",521],["T_VARIABLE","$item",521],["T_OBJECT_OPERATOR","->",521],["T_STRING","hasCustomPrice",521],"(",")",";",["T_WHITESPACE","\n        ",521],["T_IF","if",522],["T_WHITESPACE"," ",522],"(",["T_VARIABLE","$taxOnOrigPrice",522],")",["T_WHITESPACE"," ",522],"{",["T_WHITESPACE","\n            ",522],["T_VARIABLE","$origSubtotal",523],["T_WHITESPACE"," ",523],"=",["T_WHITESPACE"," ",523],["T_VARIABLE","$item",523],["T_OBJECT_OPERATOR","->",523],["T_STRING","getOriginalPrice",523],"(",")",["T_WHITESPACE"," ",523],"*",["T_WHITESPACE"," ",523],["T_VARIABLE","$qty",523],";",["T_WHITESPACE","\n            ",523],["T_VARIABLE","$baseOrigSubtotal",524],["T_WHITESPACE"," ",524],"=",["T_WHITESPACE"," ",524],["T_VARIABLE","$item",524],["T_OBJECT_OPERATOR","->",524],["T_STRING","getBaseOriginalPrice",524],"(",")",["T_WHITESPACE"," ",524],"*",["T_WHITESPACE"," ",524],["T_VARIABLE","$qty",524],";",["T_WHITESPACE","\n        ",524],"}",["T_WHITESPACE","\n\n        ",525],["T_VARIABLE","$item",527],["T_OBJECT_OPERATOR","->",527],["T_STRING","setTaxPercent",527],"(",["T_VARIABLE","$rate",527],")",";",["T_WHITESPACE","\n        ",527],["T_IF","if",528],["T_WHITESPACE"," ",528],"(",["T_VARIABLE","$this",528],["T_OBJECT_OPERATOR","->",528],["T_STRING","_config",528],["T_OBJECT_OPERATOR","->",528],["T_STRING","priceIncludesTax",528],"(",["T_VARIABLE","$this",528],["T_OBJECT_OPERATOR","->",528],["T_STRING","_store",528],")",")",["T_WHITESPACE"," ",528],"{",["T_WHITESPACE","\n            ",528],["T_IF","if",529],["T_WHITESPACE"," ",529],"(",["T_VARIABLE","$this",529],["T_OBJECT_OPERATOR","->",529],["T_STRING","_sameRateAsStore",529],"(",["T_VARIABLE","$request",529],")",")",["T_WHITESPACE"," ",529],"{",["T_WHITESPACE","\n                ",529],["T_COMMENT","\/\/ determine which price to use when we calculate the tax\n",530],["T_WHITESPACE","                ",531],["T_IF","if",531],["T_WHITESPACE"," ",531],"(",["T_VARIABLE","$taxOnOrigPrice",531],")",["T_WHITESPACE"," ",531],"{",["T_WHITESPACE","\n                    ",531],["T_VARIABLE","$taxable",532],["T_WHITESPACE"," ",532],"=",["T_WHITESPACE"," ",532],["T_VARIABLE","$origSubtotal",532],";",["T_WHITESPACE","\n                    ",532],["T_VARIABLE","$baseTaxable",533],["T_WHITESPACE"," ",533],"=",["T_WHITESPACE"," ",533],["T_VARIABLE","$baseOrigSubtotal",533],";",["T_WHITESPACE","\n                ",533],"}",["T_WHITESPACE"," ",534],["T_ELSE","else",534],["T_WHITESPACE"," ",534],"{",["T_WHITESPACE","\n                    ",534],["T_VARIABLE","$taxable",535],["T_WHITESPACE"," ",535],"=",["T_WHITESPACE"," ",535],["T_VARIABLE","$subtotal",535],";",["T_WHITESPACE","\n                    ",535],["T_VARIABLE","$baseTaxable",536],["T_WHITESPACE"," ",536],"=",["T_WHITESPACE"," ",536],["T_VARIABLE","$baseSubtotal",536],";",["T_WHITESPACE","\n                ",536],"}",["T_WHITESPACE","\n                ",537],["T_VARIABLE","$rowTaxExact",538],["T_WHITESPACE","     ",538],"=",["T_WHITESPACE"," ",538],["T_VARIABLE","$calc",538],["T_OBJECT_OPERATOR","->",538],["T_STRING","calcTaxAmount",538],"(",["T_VARIABLE","$taxable",538],",",["T_WHITESPACE"," ",538],["T_VARIABLE","$rate",538],",",["T_WHITESPACE"," ",538],["T_STRING","true",538],",",["T_WHITESPACE"," ",538],["T_STRING","false",538],")",";",["T_WHITESPACE","\n                ",538],["T_VARIABLE","$rowTax",539],["T_WHITESPACE","          ",539],"=",["T_WHITESPACE"," ",539],["T_VARIABLE","$this",539],["T_OBJECT_OPERATOR","->",539],["T_STRING","_deltaRound",539],"(",["T_VARIABLE","$rowTaxExact",539],",",["T_WHITESPACE"," ",539],["T_VARIABLE","$rate",539],",",["T_WHITESPACE"," ",539],["T_STRING","true",539],")",";",["T_WHITESPACE","\n                ",539],["T_VARIABLE","$baseRowTaxExact",540],["T_WHITESPACE"," ",540],"=",["T_WHITESPACE"," ",540],["T_VARIABLE","$calc",540],["T_OBJECT_OPERATOR","->",540],["T_STRING","calcTaxAmount",540],"(",["T_VARIABLE","$baseTaxable",540],",",["T_WHITESPACE"," ",540],["T_VARIABLE","$rate",540],",",["T_WHITESPACE"," ",540],["T_STRING","true",540],",",["T_WHITESPACE"," ",540],["T_STRING","false",540],")",";",["T_WHITESPACE","\n                ",540],["T_VARIABLE","$baseRowTax",541],["T_WHITESPACE","      ",541],"=",["T_WHITESPACE"," ",541],["T_VARIABLE","$this",541],["T_OBJECT_OPERATOR","->",541],["T_STRING","_deltaRound",541],"(",["T_VARIABLE","$baseRowTaxExact",541],",",["T_WHITESPACE"," ",541],["T_VARIABLE","$rate",541],",",["T_WHITESPACE"," ",541],["T_STRING","true",541],",",["T_WHITESPACE"," ",541],["T_CONSTANT_ENCAPSED_STRING","'base'",541],")",";",["T_WHITESPACE","\n\n                ",541],["T_VARIABLE","$taxPrice",543],["T_WHITESPACE","        ",543],"=",["T_WHITESPACE"," ",543],["T_VARIABLE","$price",543],";",["T_WHITESPACE","\n                ",543],["T_VARIABLE","$baseTaxPrice",544],["T_WHITESPACE","    ",544],"=",["T_WHITESPACE"," ",544],["T_VARIABLE","$basePrice",544],";",["T_WHITESPACE","\n                ",544],["T_VARIABLE","$taxSubtotal",545],["T_WHITESPACE"," ",545],"=",["T_WHITESPACE"," ",545],["T_VARIABLE","$subtotal",545],";",["T_WHITESPACE","\n                ",545],["T_VARIABLE","$baseTaxSubtotal",546],["T_WHITESPACE"," ",546],"=",["T_WHITESPACE"," ",546],["T_VARIABLE","$baseSubtotal",546],";",["T_WHITESPACE","\n\n                ",546],["T_VARIABLE","$subtotal",548],["T_WHITESPACE","          ",548],"=",["T_WHITESPACE"," ",548],["T_VARIABLE","$subtotal",548],["T_WHITESPACE"," ",548],"-",["T_WHITESPACE"," ",548],["T_VARIABLE","$rowTax",548],";",["T_WHITESPACE","\n                ",548],["T_VARIABLE","$baseSubtotal",549],["T_WHITESPACE","      ",549],"=",["T_WHITESPACE"," ",549],["T_VARIABLE","$baseSubtotal",549],["T_WHITESPACE"," ",549],"-",["T_WHITESPACE"," ",549],["T_VARIABLE","$baseRowTax",549],";",["T_WHITESPACE","\n\n                ",549],["T_VARIABLE","$price",551],["T_WHITESPACE"," ",551],"=",["T_WHITESPACE"," ",551],["T_VARIABLE","$calc",551],["T_OBJECT_OPERATOR","->",551],["T_STRING","round",551],"(",["T_VARIABLE","$subtotal",551],["T_WHITESPACE"," ",551],"\/",["T_WHITESPACE"," ",551],["T_VARIABLE","$qty",551],")",";",["T_WHITESPACE","\n                ",551],["T_VARIABLE","$basePrice",552],["T_WHITESPACE"," ",552],"=",["T_WHITESPACE"," ",552],["T_VARIABLE","$calc",552],["T_OBJECT_OPERATOR","->",552],["T_STRING","round",552],"(",["T_VARIABLE","$baseSubtotal",552],["T_WHITESPACE"," ",552],"\/",["T_WHITESPACE"," ",552],["T_VARIABLE","$qty",552],")",";",["T_WHITESPACE","\n\n                ",552],["T_VARIABLE","$isPriceInclTax",554],["T_WHITESPACE","  ",554],"=",["T_WHITESPACE"," ",554],["T_STRING","true",554],";",["T_WHITESPACE","\n\n                ",554],["T_COMMENT","\/\/Save the tax calculated\n",556],["T_WHITESPACE","                ",557],["T_VARIABLE","$item",557],["T_OBJECT_OPERATOR","->",557],["T_STRING","setRowTax",557],"(",["T_VARIABLE","$rowTax",557],")",";",["T_WHITESPACE","\n                ",557],["T_VARIABLE","$item",558],["T_OBJECT_OPERATOR","->",558],["T_STRING","setBaseRowTax",558],"(",["T_VARIABLE","$baseRowTax",558],")",";",["T_WHITESPACE","\n\n            ",558],"}",["T_WHITESPACE"," ",560],["T_ELSE","else",560],["T_WHITESPACE"," ",560],"{",["T_WHITESPACE","\n                ",560],["T_VARIABLE","$storeRate",561],["T_WHITESPACE"," ",561],"=",["T_WHITESPACE"," ",561],["T_VARIABLE","$calc",561],["T_OBJECT_OPERATOR","->",561],["T_STRING","getStoreRate",561],"(",["T_VARIABLE","$request",561],",",["T_WHITESPACE"," ",561],["T_VARIABLE","$this",561],["T_OBJECT_OPERATOR","->",561],["T_STRING","_store",561],")",";",["T_WHITESPACE","\n                ",561],["T_IF","if",562],["T_WHITESPACE"," ",562],"(",["T_VARIABLE","$taxOnOrigPrice",562],")",["T_WHITESPACE"," ",562],"{",["T_WHITESPACE","\n                    ",562],["T_COMMENT","\/\/ the merchant already provided a customer's price that includes tax\n",563],["T_WHITESPACE","                    ",564],["T_VARIABLE","$taxPrice",564],["T_WHITESPACE","     ",564],"=",["T_WHITESPACE"," ",564],["T_VARIABLE","$price",564],";",["T_WHITESPACE","\n                    ",564],["T_VARIABLE","$baseTaxPrice",565],["T_WHITESPACE"," ",565],"=",["T_WHITESPACE"," ",565],["T_VARIABLE","$basePrice",565],";",["T_WHITESPACE","\n                    ",565],["T_COMMENT","\/\/ determine which price to use when we calculate the tax\n",566],["T_WHITESPACE","                    ",567],["T_VARIABLE","$taxable",567],["T_WHITESPACE","      ",567],"=",["T_WHITESPACE"," ",567],["T_VARIABLE","$this",567],["T_OBJECT_OPERATOR","->",567],["T_STRING","_calculatePriceInclTax",567],"(",["T_VARIABLE","$item",567],["T_OBJECT_OPERATOR","->",567],["T_STRING","getOriginalPrice",567],"(",")",",",["T_WHITESPACE"," ",567],["T_VARIABLE","$storeRate",567],",",["T_WHITESPACE"," ",567],["T_VARIABLE","$rate",567],")",";",["T_WHITESPACE","\n                    ",567],["T_VARIABLE","$baseTaxable",568],["T_WHITESPACE","  ",568],"=",["T_WHITESPACE"," ",568],["T_VARIABLE","$this",568],["T_OBJECT_OPERATOR","->",568],["T_STRING","_calculatePriceInclTax",568],"(",["T_VARIABLE","$item",568],["T_OBJECT_OPERATOR","->",568],["T_STRING","getBaseOriginalPrice",568],"(",")",",",["T_WHITESPACE"," ",568],["T_VARIABLE","$storeRate",568],",",["T_WHITESPACE"," ",568],["T_VARIABLE","$rate",568],")",";",["T_WHITESPACE","\n                ",568],"}",["T_WHITESPACE"," ",569],["T_ELSE","else",569],["T_WHITESPACE"," ",569],"{",["T_WHITESPACE","\n                    ",569],["T_COMMENT","\/\/ determine the customer's price that includes tax\n",570],["T_WHITESPACE","                    ",571],["T_VARIABLE","$taxPrice",571],["T_WHITESPACE","     ",571],"=",["T_WHITESPACE"," ",571],["T_VARIABLE","$this",571],["T_OBJECT_OPERATOR","->",571],["T_STRING","_calculatePriceInclTax",571],"(",["T_VARIABLE","$price",571],",",["T_WHITESPACE"," ",571],["T_VARIABLE","$storeRate",571],",",["T_WHITESPACE"," ",571],["T_VARIABLE","$rate",571],")",";",["T_WHITESPACE","\n                    ",571],["T_VARIABLE","$baseTaxPrice",572],["T_WHITESPACE"," ",572],"=",["T_WHITESPACE"," ",572],["T_VARIABLE","$this",572],["T_OBJECT_OPERATOR","->",572],["T_STRING","_calculatePriceInclTax",572],"(",["T_VARIABLE","$basePrice",572],",",["T_WHITESPACE"," ",572],["T_VARIABLE","$storeRate",572],",",["T_WHITESPACE"," ",572],["T_VARIABLE","$rate",572],")",";",["T_WHITESPACE","\n                    ",572],["T_COMMENT","\/\/ determine which price to use when we calculate the tax\n",573],["T_WHITESPACE","                    ",574],["T_VARIABLE","$taxable",574],["T_WHITESPACE","      ",574],"=",["T_WHITESPACE"," ",574],["T_VARIABLE","$taxPrice",574],";",["T_WHITESPACE","\n                    ",574],["T_VARIABLE","$baseTaxable",575],["T_WHITESPACE","  ",575],"=",["T_WHITESPACE"," ",575],["T_VARIABLE","$baseTaxPrice",575],";",["T_WHITESPACE","\n                ",575],"}",["T_WHITESPACE","\n                ",576],["T_COMMENT","\/\/ determine the customer's tax amount based on the taxable price\n",577],["T_WHITESPACE","                ",578],["T_VARIABLE","$tax",578],["T_WHITESPACE","             ",578],"=",["T_WHITESPACE"," ",578],["T_VARIABLE","$this",578],["T_OBJECT_OPERATOR","->",578],["T_STRING","_calculator",578],["T_OBJECT_OPERATOR","->",578],["T_STRING","calcTaxAmount",578],"(",["T_VARIABLE","$taxable",578],",",["T_WHITESPACE"," ",578],["T_VARIABLE","$rate",578],",",["T_WHITESPACE"," ",578],["T_STRING","true",578],",",["T_WHITESPACE"," ",578],["T_STRING","true",578],")",";",["T_WHITESPACE","\n                ",578],["T_VARIABLE","$baseTax",579],["T_WHITESPACE","         ",579],"=",["T_WHITESPACE"," ",579],["T_VARIABLE","$this",579],["T_OBJECT_OPERATOR","->",579],["T_STRING","_calculator",579],["T_OBJECT_OPERATOR","->",579],["T_STRING","calcTaxAmount",579],"(",["T_VARIABLE","$baseTaxable",579],",",["T_WHITESPACE"," ",579],["T_VARIABLE","$rate",579],",",["T_WHITESPACE"," ",579],["T_STRING","true",579],",",["T_WHITESPACE"," ",579],["T_STRING","true",579],")",";",["T_WHITESPACE","\n                ",579],["T_COMMENT","\/\/ determine the customer's price without taxes\n",580],["T_WHITESPACE","                ",581],["T_VARIABLE","$price",581],["T_WHITESPACE"," ",581],"=",["T_WHITESPACE"," ",581],["T_VARIABLE","$taxPrice",581],["T_WHITESPACE"," ",581],"-",["T_WHITESPACE"," ",581],["T_VARIABLE","$tax",581],";",["T_WHITESPACE","\n                ",581],["T_VARIABLE","$basePrice",582],["T_WHITESPACE"," ",582],"=",["T_WHITESPACE"," ",582],["T_VARIABLE","$baseTaxPrice",582],["T_WHITESPACE"," ",582],"-",["T_WHITESPACE"," ",582],["T_VARIABLE","$baseTax",582],";",["T_WHITESPACE","\n                ",582],["T_COMMENT","\/\/ determine subtotal amounts\n",583],["T_WHITESPACE","                ",584],["T_VARIABLE","$taxable",584],["T_WHITESPACE","        ",584],["T_MUL_EQUAL","*=",584],["T_WHITESPACE"," ",584],["T_VARIABLE","$qty",584],";",["T_WHITESPACE","\n                ",584],["T_VARIABLE","$baseTaxable",585],["T_WHITESPACE","    ",585],["T_MUL_EQUAL","*=",585],["T_WHITESPACE"," ",585],["T_VARIABLE","$qty",585],";",["T_WHITESPACE","\n                ",585],["T_VARIABLE","$taxSubtotal",586],["T_WHITESPACE","     ",586],"=",["T_WHITESPACE"," ",586],["T_VARIABLE","$taxPrice",586],["T_WHITESPACE"," ",586],"*",["T_WHITESPACE"," ",586],["T_VARIABLE","$qty",586],";",["T_WHITESPACE","\n                ",586],["T_VARIABLE","$baseTaxSubtotal",587],["T_WHITESPACE"," ",587],"=",["T_WHITESPACE"," ",587],["T_VARIABLE","$baseTaxPrice",587],["T_WHITESPACE"," ",587],"*",["T_WHITESPACE"," ",587],["T_VARIABLE","$qty",587],";",["T_WHITESPACE","\n                ",587],["T_VARIABLE","$rowTax",588],["T_WHITESPACE"," ",588],"=",["T_WHITESPACE","\n                    ",588],["T_VARIABLE","$this",589],["T_OBJECT_OPERATOR","->",589],["T_STRING","_deltaRound",589],"(",["T_VARIABLE","$calc",589],["T_OBJECT_OPERATOR","->",589],["T_STRING","calcTaxAmount",589],"(",["T_VARIABLE","$taxable",589],",",["T_WHITESPACE"," ",589],["T_VARIABLE","$rate",589],",",["T_WHITESPACE"," ",589],["T_STRING","true",589],",",["T_WHITESPACE"," ",589],["T_STRING","false",589],")",",",["T_WHITESPACE"," ",589],["T_VARIABLE","$rate",589],",",["T_WHITESPACE"," ",589],["T_STRING","true",589],")",";",["T_WHITESPACE","\n                ",589],["T_VARIABLE","$baseRowTax",590],["T_WHITESPACE"," ",590],"=",["T_WHITESPACE","\n                    ",590],["T_VARIABLE","$this",591],["T_OBJECT_OPERATOR","->",591],["T_STRING","_deltaRound",591],"(",["T_VARIABLE","$calc",591],["T_OBJECT_OPERATOR","->",591],["T_STRING","calcTaxAmount",591],"(",["T_VARIABLE","$baseTaxable",591],",",["T_WHITESPACE"," ",591],["T_VARIABLE","$rate",591],",",["T_WHITESPACE"," ",591],["T_STRING","true",591],",",["T_WHITESPACE"," ",591],["T_STRING","false",591],")",",",["T_WHITESPACE"," ",591],["T_VARIABLE","$rate",591],",",["T_WHITESPACE"," ",591],["T_STRING","true",591],",",["T_WHITESPACE"," ",591],["T_CONSTANT_ENCAPSED_STRING","'base'",591],")",";",["T_WHITESPACE","\n                ",591],["T_VARIABLE","$subtotal",592],["T_WHITESPACE"," ",592],"=",["T_WHITESPACE"," ",592],["T_VARIABLE","$taxSubtotal",592],["T_WHITESPACE"," ",592],"-",["T_WHITESPACE"," ",592],["T_VARIABLE","$rowTax",592],";",["T_WHITESPACE","\n                ",592],["T_VARIABLE","$baseSubtotal",593],["T_WHITESPACE"," ",593],"=",["T_WHITESPACE"," ",593],["T_VARIABLE","$baseTaxSubtotal",593],["T_WHITESPACE"," ",593],"-",["T_WHITESPACE"," ",593],["T_VARIABLE","$baseRowTax",593],";",["T_WHITESPACE","\n                ",593],["T_VARIABLE","$isPriceInclTax",594],["T_WHITESPACE","  ",594],"=",["T_WHITESPACE"," ",594],["T_STRING","true",594],";",["T_WHITESPACE","\n\n                ",594],["T_VARIABLE","$item",596],["T_OBJECT_OPERATOR","->",596],["T_STRING","setRowTax",596],"(",["T_VARIABLE","$rowTax",596],")",";",["T_WHITESPACE","\n                ",596],["T_VARIABLE","$item",597],["T_OBJECT_OPERATOR","->",597],["T_STRING","setBaseRowTax",597],"(",["T_VARIABLE","$baseRowTax",597],")",";",["T_WHITESPACE","\n            ",597],"}",["T_WHITESPACE","\n        ",598],"}",["T_WHITESPACE"," ",599],["T_ELSE","else",599],["T_WHITESPACE"," ",599],"{",["T_WHITESPACE","\n            ",599],["T_COMMENT","\/\/ determine which price to use when we calculate the tax\n",600],["T_WHITESPACE","            ",601],["T_IF","if",601],["T_WHITESPACE"," ",601],"(",["T_VARIABLE","$taxOnOrigPrice",601],")",["T_WHITESPACE"," ",601],"{",["T_WHITESPACE","\n                ",601],["T_VARIABLE","$taxable",602],["T_WHITESPACE"," ",602],"=",["T_WHITESPACE"," ",602],["T_VARIABLE","$origSubtotal",602],";",["T_WHITESPACE","\n                ",602],["T_VARIABLE","$baseTaxable",603],["T_WHITESPACE"," ",603],"=",["T_WHITESPACE"," ",603],["T_VARIABLE","$baseOrigSubtotal",603],";",["T_WHITESPACE","\n            ",603],"}",["T_WHITESPACE"," ",604],["T_ELSE","else",604],["T_WHITESPACE"," ",604],"{",["T_WHITESPACE","\n                ",604],["T_VARIABLE","$taxable",605],["T_WHITESPACE"," ",605],"=",["T_WHITESPACE"," ",605],["T_VARIABLE","$subtotal",605],";",["T_WHITESPACE","\n                ",605],["T_VARIABLE","$baseTaxable",606],["T_WHITESPACE"," ",606],"=",["T_WHITESPACE"," ",606],["T_VARIABLE","$baseSubtotal",606],";",["T_WHITESPACE","\n            ",606],"}",["T_WHITESPACE","\n            ",607],["T_VARIABLE","$appliedRates",608],["T_WHITESPACE"," ",608],"=",["T_WHITESPACE"," ",608],["T_VARIABLE","$this",608],["T_OBJECT_OPERATOR","->",608],["T_STRING","_calculator",608],["T_OBJECT_OPERATOR","->",608],["T_STRING","getAppliedRates",608],"(",["T_VARIABLE","$request",608],")",";",["T_WHITESPACE","\n            ",608],["T_VARIABLE","$rowTaxes",609],["T_WHITESPACE"," ",609],"=",["T_WHITESPACE"," ",609],["T_ARRAY","array",609],"(",")",";",["T_WHITESPACE","\n            ",609],["T_VARIABLE","$baseRowTaxes",610],["T_WHITESPACE"," ",610],"=",["T_WHITESPACE"," ",610],["T_ARRAY","array",610],"(",")",";",["T_WHITESPACE","\n            ",610],["T_FOREACH","foreach",611],["T_WHITESPACE"," ",611],"(",["T_VARIABLE","$appliedRates",611],["T_WHITESPACE"," ",611],["T_AS","as",611],["T_WHITESPACE"," ",611],["T_VARIABLE","$appliedRate",611],")",["T_WHITESPACE"," ",611],"{",["T_WHITESPACE","\n                ",611],["T_VARIABLE","$taxId",612],["T_WHITESPACE"," ",612],"=",["T_WHITESPACE"," ",612],["T_VARIABLE","$appliedRate",612],"[",["T_CONSTANT_ENCAPSED_STRING","'id'",612],"]",";",["T_WHITESPACE","\n                ",612],["T_VARIABLE","$taxRate",613],["T_WHITESPACE"," ",613],"=",["T_WHITESPACE"," ",613],["T_VARIABLE","$appliedRate",613],"[",["T_CONSTANT_ENCAPSED_STRING","'percent'",613],"]",";",["T_WHITESPACE","\n                ",613],["T_VARIABLE","$rowTaxes",614],"[","]",["T_WHITESPACE"," ",614],"=",["T_WHITESPACE"," ",614],["T_VARIABLE","$this",614],["T_OBJECT_OPERATOR","->",614],["T_STRING","_deltaRound",614],"(",["T_VARIABLE","$calc",614],["T_OBJECT_OPERATOR","->",614],["T_STRING","calcTaxAmount",614],"(",["T_VARIABLE","$taxable",614],",",["T_WHITESPACE"," ",614],["T_VARIABLE","$taxRate",614],",",["T_WHITESPACE"," ",614],["T_STRING","false",614],",",["T_WHITESPACE"," ",614],["T_STRING","false",614],")",",",["T_WHITESPACE"," ",614],["T_VARIABLE","$taxId",614],",",["T_WHITESPACE"," ",614],["T_STRING","false",614],")",";",["T_WHITESPACE","\n                ",614],["T_VARIABLE","$baseRowTaxes",615],"[","]",["T_WHITESPACE"," ",615],"=",["T_WHITESPACE"," ",615],["T_VARIABLE","$this",615],["T_OBJECT_OPERATOR","->",615],["T_STRING","_deltaRound",615],"(",["T_WHITESPACE","\n                        ",615],["T_VARIABLE","$calc",616],["T_OBJECT_OPERATOR","->",616],["T_STRING","calcTaxAmount",616],"(",["T_VARIABLE","$baseTaxable",616],",",["T_WHITESPACE"," ",616],["T_VARIABLE","$taxRate",616],",",["T_WHITESPACE"," ",616],["T_STRING","false",616],",",["T_WHITESPACE"," ",616],["T_STRING","false",616],")",",",["T_WHITESPACE"," ",616],["T_VARIABLE","$taxId",616],",",["T_WHITESPACE"," ",616],["T_STRING","false",616],",",["T_WHITESPACE"," ",616],["T_CONSTANT_ENCAPSED_STRING","'base'",616],")",";",["T_WHITESPACE","\n\n            ",616],"}",["T_WHITESPACE","\n\n            ",618],["T_VARIABLE","$taxSubtotal",620],["T_WHITESPACE","     ",620],"=",["T_WHITESPACE"," ",620],["T_VARIABLE","$subtotal",620],["T_WHITESPACE"," ",620],"+",["T_WHITESPACE"," ",620],["T_STRING","array_sum",620],"(",["T_VARIABLE","$rowTaxes",620],")",";",["T_WHITESPACE","\n            ",620],["T_VARIABLE","$baseTaxSubtotal",621],["T_WHITESPACE"," ",621],"=",["T_WHITESPACE"," ",621],["T_VARIABLE","$baseSubtotal",621],["T_WHITESPACE"," ",621],"+",["T_WHITESPACE"," ",621],["T_STRING","array_sum",621],"(",["T_VARIABLE","$baseRowTaxes",621],")",";",["T_WHITESPACE","\n\n            ",621],["T_VARIABLE","$taxPrice",623],["T_WHITESPACE","        ",623],"=",["T_WHITESPACE"," ",623],["T_VARIABLE","$calc",623],["T_OBJECT_OPERATOR","->",623],["T_STRING","round",623],"(",["T_VARIABLE","$taxSubtotal",623],"\/",["T_VARIABLE","$qty",623],")",";",["T_WHITESPACE","\n            ",623],["T_VARIABLE","$baseTaxPrice",624],["T_WHITESPACE","    ",624],"=",["T_WHITESPACE"," ",624],["T_VARIABLE","$calc",624],["T_OBJECT_OPERATOR","->",624],["T_STRING","round",624],"(",["T_VARIABLE","$baseTaxSubtotal",624],"\/",["T_VARIABLE","$qty",624],")",";",["T_WHITESPACE","\n\n            ",624],["T_VARIABLE","$isPriceInclTax",626],["T_WHITESPACE"," ",626],"=",["T_WHITESPACE"," ",626],["T_STRING","false",626],";",["T_WHITESPACE","\n        ",626],"}",["T_WHITESPACE","\n\n        ",627],["T_IF","if",629],["T_WHITESPACE"," ",629],"(",["T_VARIABLE","$item",629],["T_OBJECT_OPERATOR","->",629],["T_STRING","hasCustomPrice",629],"(",")",")",["T_WHITESPACE"," ",629],"{",["T_WHITESPACE","\n            ",629],["T_DOC_COMMENT","\/**\n             * Initialize item original price before declaring custom price\n             *\/",630],["T_WHITESPACE","\n            ",632],["T_VARIABLE","$item",633],["T_OBJECT_OPERATOR","->",633],["T_STRING","getOriginalPrice",633],"(",")",";",["T_WHITESPACE","\n            ",633],["T_VARIABLE","$item",634],["T_OBJECT_OPERATOR","->",634],["T_STRING","setCustomPrice",634],"(",["T_VARIABLE","$price",634],")",";",["T_WHITESPACE","\n            ",634],["T_VARIABLE","$item",635],["T_OBJECT_OPERATOR","->",635],["T_STRING","setBaseCustomPrice",635],"(",["T_VARIABLE","$basePrice",635],")",";",["T_WHITESPACE","\n        ",635],"}",["T_WHITESPACE"," ",636],["T_ELSE","else",636],["T_WHITESPACE"," ",636],"{",["T_WHITESPACE","\n            ",636],["T_VARIABLE","$item",637],["T_OBJECT_OPERATOR","->",637],["T_STRING","setConvertedPrice",637],"(",["T_VARIABLE","$price",637],")",";",["T_WHITESPACE","\n        ",637],"}",["T_WHITESPACE","\n        ",638],["T_VARIABLE","$item",639],["T_OBJECT_OPERATOR","->",639],["T_STRING","setPrice",639],"(",["T_VARIABLE","$basePrice",639],")",";",["T_WHITESPACE","\n        ",639],["T_VARIABLE","$item",640],["T_OBJECT_OPERATOR","->",640],["T_STRING","setBasePrice",640],"(",["T_VARIABLE","$basePrice",640],")",";",["T_WHITESPACE","\n        ",640],["T_VARIABLE","$item",641],["T_OBJECT_OPERATOR","->",641],["T_STRING","setRowTotal",641],"(",["T_VARIABLE","$subtotal",641],")",";",["T_WHITESPACE","\n        ",641],["T_VARIABLE","$item",642],["T_OBJECT_OPERATOR","->",642],["T_STRING","setBaseRowTotal",642],"(",["T_VARIABLE","$baseSubtotal",642],")",";",["T_WHITESPACE","\n        ",642],["T_VARIABLE","$item",643],["T_OBJECT_OPERATOR","->",643],["T_STRING","setPriceInclTax",643],"(",["T_VARIABLE","$taxPrice",643],")",";",["T_WHITESPACE","\n        ",643],["T_VARIABLE","$item",644],["T_OBJECT_OPERATOR","->",644],["T_STRING","setBasePriceInclTax",644],"(",["T_VARIABLE","$baseTaxPrice",644],")",";",["T_WHITESPACE","\n        ",644],["T_VARIABLE","$item",645],["T_OBJECT_OPERATOR","->",645],["T_STRING","setRowTotalInclTax",645],"(",["T_VARIABLE","$taxSubtotal",645],")",";",["T_WHITESPACE","\n        ",645],["T_VARIABLE","$item",646],["T_OBJECT_OPERATOR","->",646],["T_STRING","setBaseRowTotalInclTax",646],"(",["T_VARIABLE","$baseTaxSubtotal",646],")",";",["T_WHITESPACE","\n        ",646],["T_VARIABLE","$item",647],["T_OBJECT_OPERATOR","->",647],["T_STRING","setTaxableAmount",647],"(",["T_VARIABLE","$taxable",647],")",";",["T_WHITESPACE","\n        ",647],["T_VARIABLE","$item",648],["T_OBJECT_OPERATOR","->",648],["T_STRING","setBaseTaxableAmount",648],"(",["T_VARIABLE","$baseTaxable",648],")",";",["T_WHITESPACE","\n        ",648],["T_VARIABLE","$item",649],["T_OBJECT_OPERATOR","->",649],["T_STRING","setIsPriceInclTax",649],"(",["T_VARIABLE","$isPriceInclTax",649],")",";",["T_WHITESPACE","\n        ",649],["T_IF","if",650],["T_WHITESPACE"," ",650],"(",["T_VARIABLE","$this",650],["T_OBJECT_OPERATOR","->",650],["T_STRING","_config",650],["T_OBJECT_OPERATOR","->",650],["T_STRING","discountTax",650],"(",["T_VARIABLE","$this",650],["T_OBJECT_OPERATOR","->",650],["T_STRING","_store",650],")",")",["T_WHITESPACE"," ",650],"{",["T_WHITESPACE","\n            ",650],["T_VARIABLE","$item",651],["T_OBJECT_OPERATOR","->",651],["T_STRING","setDiscountCalculationPrice",651],"(",["T_VARIABLE","$taxSubtotal",651],["T_WHITESPACE"," ",651],"\/",["T_WHITESPACE"," ",651],["T_VARIABLE","$qty",651],")",";",["T_WHITESPACE","\n            ",651],["T_VARIABLE","$item",652],["T_OBJECT_OPERATOR","->",652],["T_STRING","setBaseDiscountCalculationPrice",652],"(",["T_VARIABLE","$baseTaxSubtotal",652],["T_WHITESPACE"," ",652],"\/",["T_WHITESPACE"," ",652],["T_VARIABLE","$qty",652],")",";",["T_WHITESPACE","\n        ",652],"}",["T_WHITESPACE"," ",653],["T_ELSEIF","elseif",653],["T_WHITESPACE"," ",653],"(",["T_VARIABLE","$isPriceInclTax",653],")",["T_WHITESPACE"," ",653],"{",["T_WHITESPACE","\n            ",653],["T_VARIABLE","$item",654],["T_OBJECT_OPERATOR","->",654],["T_STRING","setDiscountCalculationPrice",654],"(",["T_VARIABLE","$subtotal",654],["T_WHITESPACE"," ",654],"\/",["T_WHITESPACE"," ",654],["T_VARIABLE","$qty",654],")",";",["T_WHITESPACE","\n            ",654],["T_VARIABLE","$item",655],["T_OBJECT_OPERATOR","->",655],["T_STRING","setBaseDiscountCalculationPrice",655],"(",["T_VARIABLE","$baseSubtotal",655],["T_WHITESPACE"," ",655],"\/",["T_WHITESPACE"," ",655],["T_VARIABLE","$qty",655],")",";",["T_WHITESPACE","\n        ",655],"}",["T_WHITESPACE","\n        ",656],["T_RETURN","return",657],["T_WHITESPACE"," ",657],["T_VARIABLE","$this",657],";",["T_WHITESPACE","\n    ",657],"}",["T_WHITESPACE","\n\n    ",658],["T_DOC_COMMENT","\/**\n     * Given a store price that includes tax at the store rate, this function will back out the store's tax, and add in\n     * the customer's tax.  Returns this new price which is the customer's price including tax.\n     *\n     * @param float $storePriceInclTax\n     * @param float $storeRate\n     * @param float $customerRate\n     *\n     * @return float\n     *\/",660],["T_WHITESPACE","\n    ",669],["T_PROTECTED","protected",670],["T_WHITESPACE"," ",670],["T_FUNCTION","function",670],["T_WHITESPACE"," ",670],["T_STRING","_calculatePriceInclTax",670],"(",["T_VARIABLE","$storePriceInclTax",670],",",["T_WHITESPACE"," ",670],["T_VARIABLE","$storeRate",670],",",["T_WHITESPACE"," ",670],["T_VARIABLE","$customerRate",670],")",["T_WHITESPACE","\n    ",670],"{",["T_WHITESPACE","\n        ",671],["T_VARIABLE","$storeTax",672],["T_WHITESPACE"," ",672],"=",["T_WHITESPACE"," ",672],["T_VARIABLE","$this",672],["T_OBJECT_OPERATOR","->",672],["T_STRING","_calculator",672],["T_OBJECT_OPERATOR","->",672],["T_STRING","calcTaxAmount",672],"(",["T_VARIABLE","$storePriceInclTax",672],",",["T_WHITESPACE"," ",672],["T_VARIABLE","$storeRate",672],",",["T_WHITESPACE"," ",672],["T_STRING","true",672],",",["T_WHITESPACE"," ",672],["T_STRING","false",672],")",";",["T_WHITESPACE","\n        ",672],["T_VARIABLE","$priceExclTax",673],["T_WHITESPACE"," ",673],"=",["T_WHITESPACE"," ",673],["T_VARIABLE","$storePriceInclTax",673],["T_WHITESPACE"," ",673],"-",["T_WHITESPACE"," ",673],["T_VARIABLE","$storeTax",673],";",["T_WHITESPACE","\n        ",673],["T_VARIABLE","$customerTax",674],["T_WHITESPACE"," ",674],"=",["T_WHITESPACE"," ",674],["T_VARIABLE","$this",674],["T_OBJECT_OPERATOR","->",674],["T_STRING","_calculator",674],["T_OBJECT_OPERATOR","->",674],["T_STRING","calcTaxAmount",674],"(",["T_VARIABLE","$priceExclTax",674],",",["T_WHITESPACE"," ",674],["T_VARIABLE","$customerRate",674],",",["T_WHITESPACE"," ",674],["T_STRING","false",674],",",["T_WHITESPACE"," ",674],["T_STRING","false",674],")",";",["T_WHITESPACE","\n        ",674],["T_VARIABLE","$customerPriceInclTax",675],["T_WHITESPACE"," ",675],"=",["T_WHITESPACE"," ",675],["T_VARIABLE","$this",675],["T_OBJECT_OPERATOR","->",675],["T_STRING","_calculator",675],["T_OBJECT_OPERATOR","->",675],["T_STRING","round",675],"(",["T_VARIABLE","$priceExclTax",675],["T_WHITESPACE"," ",675],"+",["T_WHITESPACE"," ",675],["T_VARIABLE","$customerTax",675],")",";",["T_WHITESPACE","\n        ",675],["T_RETURN","return",676],["T_WHITESPACE"," ",676],["T_VARIABLE","$customerPriceInclTax",676],";",["T_WHITESPACE","\n    ",676],"}",["T_WHITESPACE","\n\n    ",677],["T_DOC_COMMENT","\/**\n     * Checks whether request for an item has same rate as store one\n     * Used only after collect() started, as far as uses optimized $_areTaxRequestsSimilar property\n     * Used only in case of prices including tax\n     *\n     * @param Varien_Object $request\n     *\n     * @return bool\n     *\/",679],["T_WHITESPACE","\n    ",687],["T_PROTECTED","protected",688],["T_WHITESPACE"," ",688],["T_FUNCTION","function",688],["T_WHITESPACE"," ",688],["T_STRING","_sameRateAsStore",688],"(",["T_VARIABLE","$request",688],")",["T_WHITESPACE","\n    ",688],"{",["T_WHITESPACE","\n        ",689],["T_COMMENT","\/\/ Maybe we know that all requests for currently collected items have same rates\n",690],["T_WHITESPACE","        ",691],["T_IF","if",691],["T_WHITESPACE"," ",691],"(",["T_VARIABLE","$this",691],["T_OBJECT_OPERATOR","->",691],["T_STRING","_areTaxRequestsSimilar",691],")",["T_WHITESPACE"," ",691],"{",["T_WHITESPACE","\n            ",691],["T_RETURN","return",692],["T_WHITESPACE"," ",692],["T_STRING","true",692],";",["T_WHITESPACE","\n        ",692],"}",["T_WHITESPACE","\n\n        ",693],["T_COMMENT","\/\/ Check current request individually\n",695],["T_WHITESPACE","        ",696],["T_VARIABLE","$rate",696],["T_WHITESPACE"," ",696],"=",["T_WHITESPACE"," ",696],["T_VARIABLE","$this",696],["T_OBJECT_OPERATOR","->",696],["T_STRING","_calculator",696],["T_OBJECT_OPERATOR","->",696],["T_STRING","getRate",696],"(",["T_VARIABLE","$request",696],")",";",["T_WHITESPACE","\n        ",696],["T_VARIABLE","$storeRate",697],["T_WHITESPACE"," ",697],"=",["T_WHITESPACE"," ",697],["T_VARIABLE","$this",697],["T_OBJECT_OPERATOR","->",697],["T_STRING","_calculator",697],["T_OBJECT_OPERATOR","->",697],["T_STRING","getStoreRate",697],"(",["T_VARIABLE","$request",697],",",["T_WHITESPACE"," ",697],["T_VARIABLE","$this",697],["T_OBJECT_OPERATOR","->",697],["T_STRING","_store",697],")",";",["T_WHITESPACE","\n        ",697],["T_RETURN","return",698],["T_WHITESPACE"," ",698],["T_VARIABLE","$rate",698],["T_WHITESPACE"," ",698],["T_IS_EQUAL","==",698],["T_WHITESPACE"," ",698],["T_VARIABLE","$storeRate",698],";",["T_WHITESPACE","\n    ",698],"}",["T_WHITESPACE","\n\n    ",699],["T_DOC_COMMENT","\/**\n     * Round price based on previous rounding operation delta\n     *\n     * @param float $price\n     * @param string $rate\n     * @param bool $direction\n     * @param string $type\n     *\n     * @return float\n     *\/",701],["T_WHITESPACE","\n    ",710],["T_PROTECTED","protected",711],["T_WHITESPACE"," ",711],["T_FUNCTION","function",711],["T_WHITESPACE"," ",711],["T_STRING","_deltaRound",711],"(",["T_VARIABLE","$price",711],",",["T_WHITESPACE"," ",711],["T_VARIABLE","$rate",711],",",["T_WHITESPACE"," ",711],["T_VARIABLE","$direction",711],",",["T_WHITESPACE"," ",711],["T_VARIABLE","$type",711],["T_WHITESPACE"," ",711],"=",["T_WHITESPACE"," ",711],["T_CONSTANT_ENCAPSED_STRING","'regular'",711],")",["T_WHITESPACE","\n    ",711],"{",["T_WHITESPACE","\n        ",712],["T_IF","if",713],["T_WHITESPACE"," ",713],"(",["T_VARIABLE","$price",713],")",["T_WHITESPACE"," ",713],"{",["T_WHITESPACE","\n            ",713],["T_VARIABLE","$rate",714],["T_WHITESPACE"," ",714],"=",["T_WHITESPACE"," ",714],["T_STRING_CAST","(string)",714],["T_VARIABLE","$rate",714],";",["T_WHITESPACE","\n            ",714],["T_VARIABLE","$type",715],["T_WHITESPACE"," ",715],"=",["T_WHITESPACE"," ",715],["T_VARIABLE","$type",715],["T_WHITESPACE"," ",715],".",["T_WHITESPACE"," ",715],["T_VARIABLE","$direction",715],";",["T_WHITESPACE","\n            ",715],["T_COMMENT","\/\/ initialize the delta to a small number to avoid non-deterministic behavior with rounding of 0.5\n",716],["T_WHITESPACE","            ",717],["T_VARIABLE","$delta",717],["T_WHITESPACE"," ",717],"=",["T_WHITESPACE"," ",717],["T_ISSET","isset",717],"(",["T_VARIABLE","$this",717],["T_OBJECT_OPERATOR","->",717],["T_STRING","_roundingDeltas",717],"[",["T_VARIABLE","$type",717],"]","[",["T_VARIABLE","$rate",717],"]",")",["T_WHITESPACE"," ",717],"?",["T_WHITESPACE"," ",717],["T_VARIABLE","$this",717],["T_OBJECT_OPERATOR","->",717],["T_STRING","_roundingDeltas",717],"[",["T_VARIABLE","$type",717],"]","[",["T_VARIABLE","$rate",717],"]",["T_WHITESPACE"," ",717],":",["T_DNUMBER","0.000001",717],";",["T_WHITESPACE","\n            ",717],["T_VARIABLE","$price",718],["T_WHITESPACE"," ",718],["T_PLUS_EQUAL","+=",718],["T_WHITESPACE"," ",718],["T_VARIABLE","$delta",718],";",["T_WHITESPACE","\n            ",718],["T_VARIABLE","$this",719],["T_OBJECT_OPERATOR","->",719],["T_STRING","_roundingDeltas",719],"[",["T_VARIABLE","$type",719],"]","[",["T_VARIABLE","$rate",719],"]",["T_WHITESPACE"," ",719],"=",["T_WHITESPACE"," ",719],["T_VARIABLE","$price",719],["T_WHITESPACE"," ",719],"-",["T_WHITESPACE"," ",719],["T_VARIABLE","$this",719],["T_OBJECT_OPERATOR","->",719],["T_STRING","_calculator",719],["T_OBJECT_OPERATOR","->",719],["T_STRING","round",719],"(",["T_VARIABLE","$price",719],")",";",["T_WHITESPACE","\n            ",719],["T_VARIABLE","$price",720],["T_WHITESPACE"," ",720],"=",["T_WHITESPACE"," ",720],["T_VARIABLE","$this",720],["T_OBJECT_OPERATOR","->",720],["T_STRING","_calculator",720],["T_OBJECT_OPERATOR","->",720],["T_STRING","round",720],"(",["T_VARIABLE","$price",720],")",";",["T_WHITESPACE","\n        ",720],"}",["T_WHITESPACE","\n        ",721],["T_RETURN","return",722],["T_WHITESPACE"," ",722],["T_VARIABLE","$price",722],";",["T_WHITESPACE","\n    ",722],"}",["T_WHITESPACE","\n\n    ",723],["T_DOC_COMMENT","\/**\n     * Recalculate row information for item based on children calculation\n     *\n     * @param   Mage_Sales_Model_Quote_Item_Abstract $item\n     *\n     * @return  Mage_Tax_Model_Sales_Total_Quote_Subtotal\n     *\/",725],["T_WHITESPACE","\n    ",731],["T_PROTECTED","protected",732],["T_WHITESPACE"," ",732],["T_FUNCTION","function",732],["T_WHITESPACE"," ",732],["T_STRING","_recalculateParent",732],"(",["T_STRING","Mage_Sales_Model_Quote_Item_Abstract",732],["T_WHITESPACE"," ",732],["T_VARIABLE","$item",732],")",["T_WHITESPACE","\n    ",732],"{",["T_WHITESPACE","\n        ",733],["T_VARIABLE","$rowTotal",734],["T_WHITESPACE"," ",734],"=",["T_WHITESPACE"," ",734],["T_LNUMBER","0",734],";",["T_WHITESPACE","\n        ",734],["T_VARIABLE","$baseRowTotal",735],["T_WHITESPACE"," ",735],"=",["T_WHITESPACE"," ",735],["T_LNUMBER","0",735],";",["T_WHITESPACE","\n        ",735],["T_VARIABLE","$rowTotalInclTax",736],["T_WHITESPACE"," ",736],"=",["T_WHITESPACE"," ",736],["T_LNUMBER","0",736],";",["T_WHITESPACE","\n        ",736],["T_VARIABLE","$baseRowTotalInclTax",737],["T_WHITESPACE"," ",737],"=",["T_WHITESPACE"," ",737],["T_LNUMBER","0",737],";",["T_WHITESPACE","\n        ",737],["T_VARIABLE","$rowTax",738],["T_WHITESPACE"," ",738],"=",["T_WHITESPACE"," ",738],["T_LNUMBER","0",738],";",["T_WHITESPACE","\n        ",738],["T_VARIABLE","$baseRowTax",739],["T_WHITESPACE"," ",739],"=",["T_WHITESPACE"," ",739],["T_LNUMBER","0",739],";",["T_WHITESPACE","\n        ",739],["T_VARIABLE","$store",740],["T_WHITESPACE"," ",740],"=",["T_WHITESPACE"," ",740],["T_VARIABLE","$item",740],["T_OBJECT_OPERATOR","->",740],["T_STRING","getStore",740],"(",")",";",["T_WHITESPACE","\n        ",740],["T_VARIABLE","$qty",741],["T_WHITESPACE"," ",741],"=",["T_WHITESPACE"," ",741],["T_VARIABLE","$item",741],["T_OBJECT_OPERATOR","->",741],["T_STRING","getQty",741],"(",")",";",["T_WHITESPACE","\n\n        ",741],["T_FOREACH","foreach",743],["T_WHITESPACE"," ",743],"(",["T_VARIABLE","$item",743],["T_OBJECT_OPERATOR","->",743],["T_STRING","getChildren",743],"(",")",["T_WHITESPACE"," ",743],["T_AS","as",743],["T_WHITESPACE"," ",743],["T_VARIABLE","$child",743],")",["T_WHITESPACE"," ",743],"{",["T_WHITESPACE","\n            ",743],["T_VARIABLE","$rowTotal",744],["T_WHITESPACE"," ",744],["T_PLUS_EQUAL","+=",744],["T_WHITESPACE"," ",744],["T_VARIABLE","$child",744],["T_OBJECT_OPERATOR","->",744],["T_STRING","getRowTotal",744],"(",")",";",["T_WHITESPACE","\n            ",744],["T_VARIABLE","$baseRowTotal",745],["T_WHITESPACE"," ",745],["T_PLUS_EQUAL","+=",745],["T_WHITESPACE"," ",745],["T_VARIABLE","$child",745],["T_OBJECT_OPERATOR","->",745],["T_STRING","getBaseRowTotal",745],"(",")",";",["T_WHITESPACE","\n            ",745],["T_VARIABLE","$rowTotalInclTax",746],["T_WHITESPACE"," ",746],["T_PLUS_EQUAL","+=",746],["T_WHITESPACE"," ",746],["T_VARIABLE","$child",746],["T_OBJECT_OPERATOR","->",746],["T_STRING","getRowTotalInclTax",746],"(",")",";",["T_WHITESPACE","\n            ",746],["T_VARIABLE","$baseRowTotalInclTax",747],["T_WHITESPACE"," ",747],["T_PLUS_EQUAL","+=",747],["T_WHITESPACE"," ",747],["T_VARIABLE","$child",747],["T_OBJECT_OPERATOR","->",747],["T_STRING","getBaseRowTotalInclTax",747],"(",")",";",["T_WHITESPACE","\n            ",747],["T_VARIABLE","$rowTax",748],["T_WHITESPACE"," ",748],["T_PLUS_EQUAL","+=",748],["T_WHITESPACE"," ",748],["T_VARIABLE","$child",748],["T_OBJECT_OPERATOR","->",748],["T_STRING","getRowTax",748],"(",")",";",["T_WHITESPACE","\n            ",748],["T_VARIABLE","$baseRowTax",749],["T_WHITESPACE"," ",749],["T_PLUS_EQUAL","+=",749],["T_WHITESPACE"," ",749],["T_VARIABLE","$child",749],["T_OBJECT_OPERATOR","->",749],["T_STRING","getBaseRowTax",749],"(",")",";",["T_WHITESPACE","\n        ",749],"}",["T_WHITESPACE","\n\n        ",750],["T_VARIABLE","$item",752],["T_OBJECT_OPERATOR","->",752],["T_STRING","setConvertedPrice",752],"(",["T_VARIABLE","$store",752],["T_OBJECT_OPERATOR","->",752],["T_STRING","roundPrice",752],"(",["T_VARIABLE","$rowTotal",752],")",["T_WHITESPACE"," ",752],"\/",["T_WHITESPACE"," ",752],["T_VARIABLE","$qty",752],")",";",["T_WHITESPACE","\n        ",752],["T_VARIABLE","$item",753],["T_OBJECT_OPERATOR","->",753],["T_STRING","setPrice",753],"(",["T_VARIABLE","$store",753],["T_OBJECT_OPERATOR","->",753],["T_STRING","roundPrice",753],"(",["T_VARIABLE","$baseRowTotal",753],")",["T_WHITESPACE"," ",753],"\/",["T_WHITESPACE"," ",753],["T_VARIABLE","$qty",753],")",";",["T_WHITESPACE","\n        ",753],["T_VARIABLE","$item",754],["T_OBJECT_OPERATOR","->",754],["T_STRING","setRowTotal",754],"(",["T_VARIABLE","$rowTotal",754],")",";",["T_WHITESPACE","\n        ",754],["T_VARIABLE","$item",755],["T_OBJECT_OPERATOR","->",755],["T_STRING","setBaseRowTotal",755],"(",["T_VARIABLE","$baseRowTotal",755],")",";",["T_WHITESPACE","\n        ",755],["T_VARIABLE","$item",756],["T_OBJECT_OPERATOR","->",756],["T_STRING","setPriceInclTax",756],"(",["T_VARIABLE","$store",756],["T_OBJECT_OPERATOR","->",756],["T_STRING","roundPrice",756],"(",["T_VARIABLE","$rowTotalInclTax",756],")",["T_WHITESPACE"," ",756],"\/",["T_WHITESPACE"," ",756],["T_VARIABLE","$qty",756],")",";",["T_WHITESPACE","\n        ",756],["T_VARIABLE","$item",757],["T_OBJECT_OPERATOR","->",757],["T_STRING","setBasePriceInclTax",757],"(",["T_VARIABLE","$store",757],["T_OBJECT_OPERATOR","->",757],["T_STRING","roundPrice",757],"(",["T_VARIABLE","$baseRowTotalInclTax",757],")",["T_WHITESPACE"," ",757],"\/",["T_WHITESPACE"," ",757],["T_VARIABLE","$qty",757],")",";",["T_WHITESPACE","\n        ",757],["T_VARIABLE","$item",758],["T_OBJECT_OPERATOR","->",758],["T_STRING","setRowTotalInclTax",758],"(",["T_VARIABLE","$rowTotalInclTax",758],")",";",["T_WHITESPACE","\n        ",758],["T_VARIABLE","$item",759],["T_OBJECT_OPERATOR","->",759],["T_STRING","setBaseRowTotalInclTax",759],"(",["T_VARIABLE","$baseRowTotalInclTax",759],")",";",["T_WHITESPACE","\n        ",759],["T_VARIABLE","$item",760],["T_OBJECT_OPERATOR","->",760],["T_STRING","setRowTax",760],"(",["T_VARIABLE","$rowTax",760],")",";",["T_WHITESPACE","\n        ",760],["T_VARIABLE","$item",761],["T_OBJECT_OPERATOR","->",761],["T_STRING","setBaseRowTax",761],"(",["T_VARIABLE","$baseRowTax",761],")",";",["T_WHITESPACE","\n        ",761],["T_RETURN","return",762],["T_WHITESPACE"," ",762],["T_VARIABLE","$this",762],";",["T_WHITESPACE","\n    ",762],"}",["T_WHITESPACE","\n\n    ",763],["T_DOC_COMMENT","\/**\n     * Get request for fetching store tax rate\n     *\n     * @param   Mage_Sales_Model_Quote_Address $address\n     *\n     * @return  Varien_Object\n     *\/",765],["T_WHITESPACE","\n    ",771],["T_PROTECTED","protected",772],["T_WHITESPACE"," ",772],["T_FUNCTION","function",772],["T_WHITESPACE"," ",772],["T_STRING","_getStoreTaxRequest",772],"(",["T_VARIABLE","$address",772],")",["T_WHITESPACE","\n    ",772],"{",["T_WHITESPACE","\n        ",773],["T_IF","if",774],["T_WHITESPACE"," ",774],"(",["T_STRING","is_null",774],"(",["T_VARIABLE","$this",774],["T_OBJECT_OPERATOR","->",774],["T_STRING","_storeTaxRequest",774],")",")",["T_WHITESPACE"," ",774],"{",["T_WHITESPACE","\n            ",774],["T_VARIABLE","$this",775],["T_OBJECT_OPERATOR","->",775],["T_STRING","_storeTaxRequest",775],["T_WHITESPACE"," ",775],"=",["T_WHITESPACE"," ",775],["T_VARIABLE","$this",775],["T_OBJECT_OPERATOR","->",775],["T_STRING","_calculator",775],["T_OBJECT_OPERATOR","->",775],["T_STRING","getRateOriginRequest",775],"(",["T_VARIABLE","$address",775],["T_OBJECT_OPERATOR","->",775],["T_STRING","getQuote",775],"(",")",["T_OBJECT_OPERATOR","->",775],["T_STRING","getStore",775],"(",")",")",";",["T_WHITESPACE","\n        ",775],"}",["T_WHITESPACE","\n        ",776],["T_RETURN","return",777],["T_WHITESPACE"," ",777],["T_VARIABLE","$this",777],["T_OBJECT_OPERATOR","->",777],["T_STRING","_storeTaxRequest",777],";",["T_WHITESPACE","\n    ",777],"}",["T_WHITESPACE","\n\n    ",778],["T_DOC_COMMENT","\/**\n     * Get request for fetching address tax rate\n     *\n     * @param   Mage_Sales_Model_Quote_Address $address\n     *\n     * @return  Varien_Object\n     *\/",780],["T_WHITESPACE","\n    ",786],["T_PROTECTED","protected",787],["T_WHITESPACE"," ",787],["T_FUNCTION","function",787],["T_WHITESPACE"," ",787],["T_STRING","_getAddressTaxRequest",787],"(",["T_VARIABLE","$address",787],")",["T_WHITESPACE","\n    ",787],"{",["T_WHITESPACE","\n        ",788],["T_VARIABLE","$addressTaxRequest",789],["T_WHITESPACE"," ",789],"=",["T_WHITESPACE"," ",789],["T_VARIABLE","$this",789],["T_OBJECT_OPERATOR","->",789],["T_STRING","_calculator",789],["T_OBJECT_OPERATOR","->",789],["T_STRING","getRateRequest",789],"(",["T_WHITESPACE","\n            ",789],["T_VARIABLE","$address",790],",",["T_WHITESPACE","\n            ",790],["T_VARIABLE","$address",791],["T_OBJECT_OPERATOR","->",791],["T_STRING","getQuote",791],"(",")",["T_OBJECT_OPERATOR","->",791],["T_STRING","getBillingAddress",791],"(",")",",",["T_WHITESPACE","\n            ",791],["T_VARIABLE","$address",792],["T_OBJECT_OPERATOR","->",792],["T_STRING","getQuote",792],"(",")",["T_OBJECT_OPERATOR","->",792],["T_STRING","getCustomerTaxClassId",792],"(",")",",",["T_WHITESPACE","\n            ",792],["T_VARIABLE","$address",793],["T_OBJECT_OPERATOR","->",793],["T_STRING","getQuote",793],"(",")",["T_OBJECT_OPERATOR","->",793],["T_STRING","getStore",793],"(",")",["T_WHITESPACE","\n        ",793],")",";",["T_WHITESPACE","\n        ",794],["T_RETURN","return",795],["T_WHITESPACE"," ",795],["T_VARIABLE","$addressTaxRequest",795],";",["T_WHITESPACE","\n    ",795],"}",["T_WHITESPACE","\n\n    ",796],["T_DOC_COMMENT","\/**\n     * Add row total item amount to subtotal\n     *\n     * @param   Mage_Sales_Model_Quote_Address $address\n     * @param   Mage_Sales_Model_Quote_Item_Abstract $item\n     *\n     * @return  Mage_Tax_Model_Sales_Total_Quote_Subtotal\n     *\/",798],["T_WHITESPACE","\n    ",805],["T_PROTECTED","protected",806],["T_WHITESPACE"," ",806],["T_FUNCTION","function",806],["T_WHITESPACE"," ",806],["T_STRING","_addSubtotalAmount",806],"(",["T_STRING","Mage_Sales_Model_Quote_Address",806],["T_WHITESPACE"," ",806],["T_VARIABLE","$address",806],",",["T_WHITESPACE"," ",806],["T_VARIABLE","$item",806],")",["T_WHITESPACE","\n    ",806],"{",["T_WHITESPACE","\n        ",807],["T_IF","if",808],["T_WHITESPACE"," ",808],"(",["T_VARIABLE","$this",808],["T_OBJECT_OPERATOR","->",808],["T_STRING","_config",808],["T_OBJECT_OPERATOR","->",808],["T_STRING","priceIncludesTax",808],"(",["T_VARIABLE","$this",808],["T_OBJECT_OPERATOR","->",808],["T_STRING","_store",808],")",")",["T_WHITESPACE"," ",808],"{",["T_WHITESPACE","\n            ",808],["T_VARIABLE","$subTotal",809],["T_WHITESPACE"," ",809],"=",["T_WHITESPACE"," ",809],["T_VARIABLE","$item",809],["T_OBJECT_OPERATOR","->",809],["T_STRING","getRowTotalInclTax",809],"(",")",["T_WHITESPACE"," ",809],"-",["T_WHITESPACE"," ",809],["T_VARIABLE","$item",809],["T_OBJECT_OPERATOR","->",809],["T_STRING","getRowTax",809],"(",")",";",["T_WHITESPACE","\n            ",809],["T_VARIABLE","$baseSubTotal",810],["T_WHITESPACE"," ",810],"=",["T_WHITESPACE"," ",810],["T_VARIABLE","$item",810],["T_OBJECT_OPERATOR","->",810],["T_STRING","getBaseRowTotalInclTax",810],"(",")",["T_WHITESPACE"," ",810],"-",["T_WHITESPACE"," ",810],["T_VARIABLE","$item",810],["T_OBJECT_OPERATOR","->",810],["T_STRING","getBaseRowTax",810],"(",")",";",["T_WHITESPACE","\n            ",810],["T_VARIABLE","$address",811],["T_OBJECT_OPERATOR","->",811],["T_STRING","setTotalAmount",811],"(",["T_CONSTANT_ENCAPSED_STRING","'subtotal'",811],",",["T_WHITESPACE"," ",811],["T_VARIABLE","$address",811],["T_OBJECT_OPERATOR","->",811],["T_STRING","getTotalAmount",811],"(",["T_CONSTANT_ENCAPSED_STRING","'subtotal'",811],")",["T_WHITESPACE"," ",811],"+",["T_WHITESPACE"," ",811],["T_VARIABLE","$subTotal",811],")",";",["T_WHITESPACE","\n            ",811],["T_VARIABLE","$address",812],["T_OBJECT_OPERATOR","->",812],["T_STRING","setBaseTotalAmount",812],"(",["T_CONSTANT_ENCAPSED_STRING","'subtotal'",812],",",["T_WHITESPACE"," ",812],["T_VARIABLE","$address",812],["T_OBJECT_OPERATOR","->",812],["T_STRING","getBaseTotalAmount",812],"(",["T_CONSTANT_ENCAPSED_STRING","'subtotal'",812],")",["T_WHITESPACE"," ",812],"+",["T_WHITESPACE"," ",812],["T_VARIABLE","$baseSubTotal",812],")",";",["T_WHITESPACE","\n        ",812],"}",["T_WHITESPACE"," ",813],["T_ELSE","else",813],["T_WHITESPACE"," ",813],"{",["T_WHITESPACE","\n            ",813],["T_VARIABLE","$address",814],["T_OBJECT_OPERATOR","->",814],["T_STRING","setTotalAmount",814],"(",["T_CONSTANT_ENCAPSED_STRING","'subtotal'",814],",",["T_WHITESPACE","\n                ",814],["T_VARIABLE","$address",815],["T_OBJECT_OPERATOR","->",815],["T_STRING","getTotalAmount",815],"(",["T_CONSTANT_ENCAPSED_STRING","'subtotal'",815],")",["T_WHITESPACE"," ",815],"+",["T_WHITESPACE"," ",815],["T_VARIABLE","$item",815],["T_OBJECT_OPERATOR","->",815],["T_STRING","getRowTotal",815],"(",")",["T_WHITESPACE","\n            ",815],")",";",["T_WHITESPACE","\n            ",816],["T_VARIABLE","$address",817],["T_OBJECT_OPERATOR","->",817],["T_STRING","setBaseTotalAmount",817],"(",["T_CONSTANT_ENCAPSED_STRING","'subtotal'",817],",",["T_WHITESPACE","\n                ",817],["T_VARIABLE","$address",818],["T_OBJECT_OPERATOR","->",818],["T_STRING","getBaseTotalAmount",818],"(",["T_CONSTANT_ENCAPSED_STRING","'subtotal'",818],")",["T_WHITESPACE"," ",818],"+",["T_WHITESPACE"," ",818],["T_VARIABLE","$item",818],["T_OBJECT_OPERATOR","->",818],["T_STRING","getBaseRowTotal",818],"(",")",")",";",["T_WHITESPACE","\n        ",818],"}",["T_WHITESPACE","\n        ",819],["T_VARIABLE","$address",820],["T_OBJECT_OPERATOR","->",820],["T_STRING","setSubtotalInclTax",820],"(",["T_VARIABLE","$address",820],["T_OBJECT_OPERATOR","->",820],["T_STRING","getSubtotalInclTax",820],"(",")",["T_WHITESPACE"," ",820],"+",["T_WHITESPACE"," ",820],["T_VARIABLE","$item",820],["T_OBJECT_OPERATOR","->",820],["T_STRING","getRowTotalInclTax",820],"(",")",")",";",["T_WHITESPACE","\n        ",820],["T_VARIABLE","$address",821],["T_OBJECT_OPERATOR","->",821],["T_STRING","setBaseSubtotalInclTax",821],"(",["T_VARIABLE","$address",821],["T_OBJECT_OPERATOR","->",821],["T_STRING","getBaseSubtotalInclTax",821],"(",")",["T_WHITESPACE"," ",821],"+",["T_WHITESPACE"," ",821],["T_VARIABLE","$item",821],["T_OBJECT_OPERATOR","->",821],["T_STRING","getBaseRowTotalInclTax",821],"(",")",")",";",["T_WHITESPACE","\n        ",821],["T_RETURN","return",822],["T_WHITESPACE"," ",822],["T_VARIABLE","$this",822],";",["T_WHITESPACE","\n    ",822],"}",["T_WHITESPACE","\n\n    ",823],["T_DOC_COMMENT","\/**\n     * Unset item prices\/totals with price include tax.\n     * Operation is necessary for reset item state in case if configuration was changed\n     *\n     * @deprecated after 1.4.1\n     *\n     * @param   Mage_Sales_Model_Quote_Item_Abstract $item\n     *\n     * @return  Mage_Tax_Model_Sales_Total_Quote_Subtotal\n     *\/",825],["T_WHITESPACE","\n    ",834],["T_PROTECTED","protected",835],["T_WHITESPACE"," ",835],["T_FUNCTION","function",835],["T_WHITESPACE"," ",835],["T_STRING","_resetItemPriceInclTax",835],"(",["T_STRING","Mage_Sales_Model_Quote_Item_Abstract",835],["T_WHITESPACE"," ",835],["T_VARIABLE","$item",835],")",["T_WHITESPACE","\n    ",835],"{",["T_WHITESPACE","\n",836],["T_COMMENT","\/\/        $item->setPriceInclTax(null);\n",837],["T_COMMENT","\/\/        $item->setBasePriceInclTax(null);\n",838],["T_COMMENT","\/\/        $item->setRowTotalInclTax(null);\n",839],["T_COMMENT","\/\/        $item->setBaseRowTotalInclTax(null);\n",840],["T_WHITESPACE","        ",841],["T_RETURN","return",841],["T_WHITESPACE"," ",841],["T_VARIABLE","$this",841],";",["T_WHITESPACE","\n    ",841],"}",["T_WHITESPACE","\n\n    ",842],["T_DOC_COMMENT","\/**\n     *\n     * @deprecated after 1.4.0.1\n     *\n     * @param   Mage_Sales_Model_Quote_Address $address\n     *\n     * @return  Mage_Tax_Model_Sales_Total_Quote_Subtotal\n     *\/",844],["T_WHITESPACE","\n    ",851],["T_PROTECTED","protected",852],["T_WHITESPACE"," ",852],["T_FUNCTION","function",852],["T_WHITESPACE"," ",852],["T_STRING","_processShippingAmount",852],"(",["T_VARIABLE","$address",852],")",["T_WHITESPACE","\n    ",852],"{",["T_WHITESPACE","\n        ",853],["T_RETURN","return",854],["T_WHITESPACE"," ",854],["T_VARIABLE","$this",854],";",["T_WHITESPACE","\n    ",854],"}",["T_WHITESPACE","\n\n    ",855],["T_DOC_COMMENT","\/**\n     * Recollect item price and row total using after taxes subtract.\n     * Declare item price including tax attributes\n     *\n     * @deprecated after 1.4.1\n     *\n     * @param   Mage_Sales_Model_Quote_Address $address\n     * @param   Mage_Sales_Model_Quote_Item_Abstract $item\n     *\n     * @return  Mage_Tax_Model_Sales_Total_Quote_Subtotal\n     *\/",857],["T_WHITESPACE","\n    ",867],["T_PROTECTED","protected",868],["T_WHITESPACE"," ",868],["T_FUNCTION","function",868],["T_WHITESPACE"," ",868],["T_STRING","_recollectItem",868],"(",["T_VARIABLE","$address",868],",",["T_WHITESPACE"," ",868],["T_STRING","Mage_Sales_Model_Quote_Item_Abstract",868],["T_WHITESPACE"," ",868],["T_VARIABLE","$item",868],")",["T_WHITESPACE","\n    ",868],"{",["T_WHITESPACE","\n        ",869],["T_VARIABLE","$store",870],["T_WHITESPACE"," ",870],"=",["T_WHITESPACE"," ",870],["T_VARIABLE","$address",870],["T_OBJECT_OPERATOR","->",870],["T_STRING","getQuote",870],"(",")",["T_OBJECT_OPERATOR","->",870],["T_STRING","getStore",870],"(",")",";",["T_WHITESPACE","\n        ",870],["T_VARIABLE","$request",871],["T_WHITESPACE"," ",871],"=",["T_WHITESPACE"," ",871],["T_VARIABLE","$this",871],["T_OBJECT_OPERATOR","->",871],["T_STRING","_getStoreTaxRequest",871],"(",["T_VARIABLE","$address",871],")",";",["T_WHITESPACE","\n        ",871],["T_VARIABLE","$request",872],["T_OBJECT_OPERATOR","->",872],["T_STRING","setProductClassId",872],"(",["T_VARIABLE","$item",872],["T_OBJECT_OPERATOR","->",872],["T_STRING","getProduct",872],"(",")",["T_OBJECT_OPERATOR","->",872],["T_STRING","getTaxClassId",872],"(",")",")",";",["T_WHITESPACE","\n        ",872],["T_VARIABLE","$rate",873],["T_WHITESPACE"," ",873],"=",["T_WHITESPACE"," ",873],["T_VARIABLE","$this",873],["T_OBJECT_OPERATOR","->",873],["T_STRING","_calculator",873],["T_OBJECT_OPERATOR","->",873],["T_STRING","getRate",873],"(",["T_VARIABLE","$request",873],")",";",["T_WHITESPACE","\n        ",873],["T_VARIABLE","$qty",874],["T_WHITESPACE"," ",874],"=",["T_WHITESPACE"," ",874],["T_VARIABLE","$item",874],["T_OBJECT_OPERATOR","->",874],["T_STRING","getTotalQty",874],"(",")",";",["T_WHITESPACE","\n\n        ",874],["T_VARIABLE","$price",876],["T_WHITESPACE"," ",876],"=",["T_WHITESPACE"," ",876],["T_VARIABLE","$taxPrice",876],["T_WHITESPACE"," ",876],"=",["T_WHITESPACE"," ",876],["T_VARIABLE","$item",876],["T_OBJECT_OPERATOR","->",876],["T_STRING","getCalculationPriceOriginal",876],"(",")",";",["T_WHITESPACE","\n        ",876],["T_VARIABLE","$basePrice",877],["T_WHITESPACE"," ",877],"=",["T_WHITESPACE"," ",877],["T_VARIABLE","$baseTaxPrice",877],["T_WHITESPACE"," ",877],"=",["T_WHITESPACE"," ",877],["T_VARIABLE","$item",877],["T_OBJECT_OPERATOR","->",877],["T_STRING","getBaseCalculationPriceOriginal",877],"(",")",";",["T_WHITESPACE","\n        ",877],["T_VARIABLE","$subtotal",878],["T_WHITESPACE"," ",878],"=",["T_WHITESPACE"," ",878],["T_VARIABLE","$taxSubtotal",878],["T_WHITESPACE"," ",878],"=",["T_WHITESPACE"," ",878],["T_VARIABLE","$item",878],["T_OBJECT_OPERATOR","->",878],["T_STRING","getRowTotal",878],"(",")",";",["T_WHITESPACE","\n        ",878],["T_VARIABLE","$baseSubtotal",879],["T_WHITESPACE"," ",879],"=",["T_WHITESPACE"," ",879],["T_VARIABLE","$baseTaxSubtotal",879],["T_WHITESPACE"," ",879],"=",["T_WHITESPACE"," ",879],["T_VARIABLE","$item",879],["T_OBJECT_OPERATOR","->",879],["T_STRING","getBaseRowTotal",879],"(",")",";",["T_WHITESPACE","\n\n        ",879],["T_IF","if",881],["T_WHITESPACE"," ",881],"(",["T_VARIABLE","$this",881],["T_OBJECT_OPERATOR","->",881],["T_STRING","_config",881],["T_OBJECT_OPERATOR","->",881],["T_STRING","discountTax",881],"(",["T_VARIABLE","$store",881],")",")",["T_WHITESPACE"," ",881],"{",["T_WHITESPACE","\n            ",881],["T_VARIABLE","$item",882],["T_OBJECT_OPERATOR","->",882],["T_STRING","setDiscountCalculationPrice",882],"(",["T_VARIABLE","$price",882],")",";",["T_WHITESPACE","\n            ",882],["T_VARIABLE","$item",883],["T_OBJECT_OPERATOR","->",883],["T_STRING","setBaseDiscountCalculationPrice",883],"(",["T_VARIABLE","$basePrice",883],")",";",["T_WHITESPACE","\n        ",883],"}",["T_WHITESPACE","\n\n        ",884],["T_DOC_COMMENT","\/**\n         * Use original price for tax calculation\n         *\/",886],["T_WHITESPACE","\n        ",888],["T_IF","if",889],["T_WHITESPACE"," ",889],"(",["T_VARIABLE","$item",889],["T_OBJECT_OPERATOR","->",889],["T_STRING","hasCustomPrice",889],"(",")",["T_WHITESPACE"," ",889],["T_BOOLEAN_AND","&&",889],["T_WHITESPACE"," ",889],"!",["T_VARIABLE","$this",889],["T_OBJECT_OPERATOR","->",889],["T_STRING","_helper",889],["T_OBJECT_OPERATOR","->",889],["T_STRING","applyTaxOnCustomPrice",889],"(",["T_VARIABLE","$store",889],")",")",["T_WHITESPACE"," ",889],"{",["T_WHITESPACE","\n            ",889],["T_VARIABLE","$taxPrice",890],["T_WHITESPACE"," ",890],"=",["T_WHITESPACE"," ",890],["T_VARIABLE","$item",890],["T_OBJECT_OPERATOR","->",890],["T_STRING","getOriginalPrice",890],"(",")",";",["T_WHITESPACE","\n            ",890],["T_VARIABLE","$baseTaxPrice",891],["T_WHITESPACE"," ",891],"=",["T_WHITESPACE"," ",891],["T_VARIABLE","$item",891],["T_OBJECT_OPERATOR","->",891],["T_STRING","getBaseOriginalPrice",891],"(",")",";",["T_WHITESPACE","\n            ",891],["T_VARIABLE","$taxSubtotal",892],["T_WHITESPACE"," ",892],"=",["T_WHITESPACE"," ",892],["T_VARIABLE","$taxPrice",892],["T_WHITESPACE"," ",892],"*",["T_WHITESPACE"," ",892],["T_VARIABLE","$qty",892],";",["T_WHITESPACE","\n            ",892],["T_VARIABLE","$baseTaxSubtotal",893],["T_WHITESPACE"," ",893],"=",["T_WHITESPACE"," ",893],["T_VARIABLE","$baseTaxPrice",893],["T_WHITESPACE"," ",893],"*",["T_WHITESPACE"," ",893],["T_VARIABLE","$qty",893],";",["T_WHITESPACE","\n        ",893],"}",["T_WHITESPACE","\n\n        ",894],["T_IF","if",896],["T_WHITESPACE"," ",896],"(",["T_VARIABLE","$this",896],["T_OBJECT_OPERATOR","->",896],["T_STRING","_areTaxRequestsSimilar",896],")",["T_WHITESPACE"," ",896],"{",["T_WHITESPACE","\n            ",896],["T_VARIABLE","$item",897],["T_OBJECT_OPERATOR","->",897],["T_STRING","setRowTotalInclTax",897],"(",["T_VARIABLE","$subtotal",897],")",";",["T_WHITESPACE","\n            ",897],["T_VARIABLE","$item",898],["T_OBJECT_OPERATOR","->",898],["T_STRING","setBaseRowTotalInclTax",898],"(",["T_VARIABLE","$baseSubtotal",898],")",";",["T_WHITESPACE","\n            ",898],["T_VARIABLE","$item",899],["T_OBJECT_OPERATOR","->",899],["T_STRING","setPriceInclTax",899],"(",["T_VARIABLE","$price",899],")",";",["T_WHITESPACE","\n            ",899],["T_VARIABLE","$item",900],["T_OBJECT_OPERATOR","->",900],["T_STRING","setBasePriceInclTax",900],"(",["T_VARIABLE","$basePrice",900],")",";",["T_WHITESPACE","\n\n            ",900],["T_VARIABLE","$item",902],["T_OBJECT_OPERATOR","->",902],["T_STRING","setTaxCalcPrice",902],"(",["T_VARIABLE","$taxPrice",902],")",";",["T_WHITESPACE","\n            ",902],["T_VARIABLE","$item",903],["T_OBJECT_OPERATOR","->",903],["T_STRING","setBaseTaxCalcPrice",903],"(",["T_VARIABLE","$baseTaxPrice",903],")",";",["T_WHITESPACE","\n            ",903],["T_VARIABLE","$item",904],["T_OBJECT_OPERATOR","->",904],["T_STRING","setTaxCalcRowTotal",904],"(",["T_VARIABLE","$taxSubtotal",904],")",";",["T_WHITESPACE","\n            ",904],["T_VARIABLE","$item",905],["T_OBJECT_OPERATOR","->",905],["T_STRING","setBaseTaxCalcRowTotal",905],"(",["T_VARIABLE","$baseTaxSubtotal",905],")",";",["T_WHITESPACE","\n        ",905],"}",["T_WHITESPACE","\n\n        ",906],["T_VARIABLE","$this",908],["T_OBJECT_OPERATOR","->",908],["T_STRING","_subtotalInclTax",908],["T_WHITESPACE"," ",908],["T_PLUS_EQUAL","+=",908],["T_WHITESPACE"," ",908],["T_VARIABLE","$subtotal",908],";",["T_WHITESPACE","\n        ",908],["T_VARIABLE","$this",909],["T_OBJECT_OPERATOR","->",909],["T_STRING","_baseSubtotalInclTax",909],["T_WHITESPACE"," ",909],["T_PLUS_EQUAL","+=",909],["T_WHITESPACE"," ",909],["T_VARIABLE","$baseSubtotal",909],";",["T_WHITESPACE","\n\n        ",909],["T_IF","if",911],["T_WHITESPACE"," ",911],"(",["T_VARIABLE","$this",911],["T_OBJECT_OPERATOR","->",911],["T_STRING","_config",911],["T_OBJECT_OPERATOR","->",911],["T_STRING","getAlgorithm",911],"(",["T_VARIABLE","$store",911],")",["T_WHITESPACE"," ",911],["T_IS_EQUAL","==",911],["T_WHITESPACE"," ",911],["T_STRING","Mage_Tax_Model_Calculation",911],["T_DOUBLE_COLON","::",911],["T_STRING","CALC_UNIT_BASE",911],")",["T_WHITESPACE"," ",911],"{",["T_WHITESPACE","\n            ",911],["T_VARIABLE","$taxAmount",912],["T_WHITESPACE"," ",912],"=",["T_WHITESPACE"," ",912],["T_VARIABLE","$this",912],["T_OBJECT_OPERATOR","->",912],["T_STRING","_calculator",912],["T_OBJECT_OPERATOR","->",912],["T_STRING","calcTaxAmount",912],"(",["T_VARIABLE","$taxPrice",912],",",["T_WHITESPACE"," ",912],["T_VARIABLE","$rate",912],",",["T_WHITESPACE"," ",912],["T_STRING","true",912],")",";",["T_WHITESPACE","\n            ",912],["T_VARIABLE","$baseTaxAmount",913],["T_WHITESPACE"," ",913],"=",["T_WHITESPACE"," ",913],["T_VARIABLE","$this",913],["T_OBJECT_OPERATOR","->",913],["T_STRING","_calculator",913],["T_OBJECT_OPERATOR","->",913],["T_STRING","calcTaxAmount",913],"(",["T_VARIABLE","$baseTaxPrice",913],",",["T_WHITESPACE"," ",913],["T_VARIABLE","$rate",913],",",["T_WHITESPACE"," ",913],["T_STRING","true",913],")",";",["T_WHITESPACE","\n            ",913],["T_VARIABLE","$unitPrice",914],["T_WHITESPACE"," ",914],"=",["T_WHITESPACE"," ",914],["T_VARIABLE","$this",914],["T_OBJECT_OPERATOR","->",914],["T_STRING","_calculator",914],["T_OBJECT_OPERATOR","->",914],["T_STRING","round",914],"(",["T_VARIABLE","$price",914],["T_WHITESPACE"," ",914],"-",["T_WHITESPACE"," ",914],["T_VARIABLE","$taxAmount",914],")",";",["T_WHITESPACE","\n            ",914],["T_VARIABLE","$baseUnitPrice",915],["T_WHITESPACE"," ",915],"=",["T_WHITESPACE"," ",915],["T_VARIABLE","$this",915],["T_OBJECT_OPERATOR","->",915],["T_STRING","_calculator",915],["T_OBJECT_OPERATOR","->",915],["T_STRING","round",915],"(",["T_VARIABLE","$basePrice",915],["T_WHITESPACE"," ",915],"-",["T_WHITESPACE"," ",915],["T_VARIABLE","$baseTaxAmount",915],")",";",["T_WHITESPACE","\n            ",915],["T_VARIABLE","$subtotal",916],["T_WHITESPACE"," ",916],"=",["T_WHITESPACE"," ",916],["T_VARIABLE","$this",916],["T_OBJECT_OPERATOR","->",916],["T_STRING","_calculator",916],["T_OBJECT_OPERATOR","->",916],["T_STRING","round",916],"(",["T_VARIABLE","$unitPrice",916],["T_WHITESPACE"," ",916],"*",["T_WHITESPACE"," ",916],["T_VARIABLE","$qty",916],")",";",["T_WHITESPACE","\n            ",916],["T_VARIABLE","$baseSubtotal",917],["T_WHITESPACE"," ",917],"=",["T_WHITESPACE"," ",917],["T_VARIABLE","$this",917],["T_OBJECT_OPERATOR","->",917],["T_STRING","_calculator",917],["T_OBJECT_OPERATOR","->",917],["T_STRING","round",917],"(",["T_VARIABLE","$baseUnitPrice",917],["T_WHITESPACE"," ",917],"*",["T_WHITESPACE"," ",917],["T_VARIABLE","$qty",917],")",";",["T_WHITESPACE","\n        ",917],"}",["T_WHITESPACE"," ",918],["T_ELSE","else",918],["T_WHITESPACE"," ",918],"{",["T_WHITESPACE","\n            ",918],["T_VARIABLE","$taxAmount",919],["T_WHITESPACE"," ",919],"=",["T_WHITESPACE"," ",919],["T_VARIABLE","$this",919],["T_OBJECT_OPERATOR","->",919],["T_STRING","_calculator",919],["T_OBJECT_OPERATOR","->",919],["T_STRING","calcTaxAmount",919],"(",["T_VARIABLE","$taxSubtotal",919],",",["T_WHITESPACE"," ",919],["T_VARIABLE","$rate",919],",",["T_WHITESPACE"," ",919],["T_STRING","true",919],",",["T_WHITESPACE"," ",919],["T_STRING","false",919],")",";",["T_WHITESPACE","\n            ",919],["T_VARIABLE","$baseTaxAmount",920],["T_WHITESPACE"," ",920],"=",["T_WHITESPACE"," ",920],["T_VARIABLE","$this",920],["T_OBJECT_OPERATOR","->",920],["T_STRING","_calculator",920],["T_OBJECT_OPERATOR","->",920],["T_STRING","calcTaxAmount",920],"(",["T_VARIABLE","$baseTaxSubtotal",920],",",["T_WHITESPACE"," ",920],["T_VARIABLE","$rate",920],",",["T_WHITESPACE"," ",920],["T_STRING","true",920],",",["T_WHITESPACE"," ",920],["T_STRING","false",920],")",";",["T_WHITESPACE","\n            ",920],["T_VARIABLE","$unitPrice",921],["T_WHITESPACE"," ",921],"=",["T_WHITESPACE"," ",921],"(",["T_VARIABLE","$subtotal",921],["T_WHITESPACE"," ",921],"-",["T_WHITESPACE"," ",921],["T_VARIABLE","$taxAmount",921],")",["T_WHITESPACE"," ",921],"\/",["T_WHITESPACE"," ",921],["T_VARIABLE","$qty",921],";",["T_WHITESPACE","\n            ",921],["T_VARIABLE","$baseUnitPrice",922],["T_WHITESPACE"," ",922],"=",["T_WHITESPACE"," ",922],"(",["T_VARIABLE","$baseSubtotal",922],["T_WHITESPACE"," ",922],"-",["T_WHITESPACE"," ",922],["T_VARIABLE","$baseTaxAmount",922],")",["T_WHITESPACE"," ",922],"\/",["T_WHITESPACE"," ",922],["T_VARIABLE","$qty",922],";",["T_WHITESPACE","\n            ",922],["T_VARIABLE","$subtotal",923],["T_WHITESPACE"," ",923],"=",["T_WHITESPACE"," ",923],["T_VARIABLE","$this",923],["T_OBJECT_OPERATOR","->",923],["T_STRING","_calculator",923],["T_OBJECT_OPERATOR","->",923],["T_STRING","round",923],"(","(",["T_VARIABLE","$subtotal",923],["T_WHITESPACE"," ",923],"-",["T_WHITESPACE"," ",923],["T_VARIABLE","$taxAmount",923],")",")",";",["T_WHITESPACE","\n            ",923],["T_VARIABLE","$baseSubtotal",924],["T_WHITESPACE"," ",924],"=",["T_WHITESPACE"," ",924],["T_VARIABLE","$this",924],["T_OBJECT_OPERATOR","->",924],["T_STRING","_calculator",924],["T_OBJECT_OPERATOR","->",924],["T_STRING","round",924],"(","(",["T_VARIABLE","$baseSubtotal",924],["T_WHITESPACE"," ",924],"-",["T_WHITESPACE"," ",924],["T_VARIABLE","$baseTaxAmount",924],")",")",";",["T_WHITESPACE","\n        ",924],"}",["T_WHITESPACE","\n\n        ",925],["T_IF","if",927],["T_WHITESPACE"," ",927],"(",["T_VARIABLE","$item",927],["T_OBJECT_OPERATOR","->",927],["T_STRING","hasCustomPrice",927],"(",")",")",["T_WHITESPACE"," ",927],"{",["T_WHITESPACE","\n            ",927],["T_VARIABLE","$item",928],["T_OBJECT_OPERATOR","->",928],["T_STRING","setCustomPrice",928],"(",["T_VARIABLE","$unitPrice",928],")",";",["T_WHITESPACE","\n            ",928],["T_VARIABLE","$item",929],["T_OBJECT_OPERATOR","->",929],["T_STRING","setBaseCustomPrice",929],"(",["T_VARIABLE","$baseUnitPrice",929],")",";",["T_WHITESPACE","\n        ",929],"}",["T_WHITESPACE","\n        ",930],["T_VARIABLE","$item",931],["T_OBJECT_OPERATOR","->",931],["T_STRING","setPrice",931],"(",["T_VARIABLE","$baseUnitPrice",931],")",";",["T_WHITESPACE","\n        ",931],["T_VARIABLE","$item",932],["T_OBJECT_OPERATOR","->",932],["T_STRING","setOriginalPrice",932],"(",["T_VARIABLE","$unitPrice",932],")",";",["T_WHITESPACE","\n        ",932],["T_VARIABLE","$item",933],["T_OBJECT_OPERATOR","->",933],["T_STRING","setBasePrice",933],"(",["T_VARIABLE","$baseUnitPrice",933],")",";",["T_WHITESPACE","\n        ",933],["T_VARIABLE","$item",934],["T_OBJECT_OPERATOR","->",934],["T_STRING","setRowTotal",934],"(",["T_VARIABLE","$subtotal",934],")",";",["T_WHITESPACE","\n        ",934],["T_VARIABLE","$item",935],["T_OBJECT_OPERATOR","->",935],["T_STRING","setBaseRowTotal",935],"(",["T_VARIABLE","$baseSubtotal",935],")",";",["T_WHITESPACE","\n        ",935],["T_RETURN","return",936],["T_WHITESPACE"," ",936],["T_VARIABLE","$this",936],";",["T_WHITESPACE","\n    ",936],"}",["T_WHITESPACE","\n\n    ",937],["T_DOC_COMMENT","\/**\n     * Check if we need subtract store tax amount from item prices\n     *\n     * @deprecated after 1.4.1\n     *\n     * @param Mage_Sales_Model_Quote_Address $address\n     *\n     * @return bool\n     *\/",939],["T_WHITESPACE","\n    ",947],["T_PROTECTED","protected",948],["T_WHITESPACE"," ",948],["T_FUNCTION","function",948],["T_WHITESPACE"," ",948],["T_STRING","_needSubtractTax",948],"(",["T_VARIABLE","$address",948],")",["T_WHITESPACE","\n    ",948],"{",["T_WHITESPACE","\n        ",949],["T_VARIABLE","$store",950],["T_WHITESPACE"," ",950],"=",["T_WHITESPACE"," ",950],["T_VARIABLE","$address",950],["T_OBJECT_OPERATOR","->",950],["T_STRING","getQuote",950],"(",")",["T_OBJECT_OPERATOR","->",950],["T_STRING","getStore",950],"(",")",";",["T_WHITESPACE","\n        ",950],["T_IF","if",951],["T_WHITESPACE"," ",951],"(",["T_VARIABLE","$this",951],["T_OBJECT_OPERATOR","->",951],["T_STRING","_config",951],["T_OBJECT_OPERATOR","->",951],["T_STRING","priceIncludesTax",951],"(",["T_VARIABLE","$store",951],")",["T_WHITESPACE"," ",951],["T_BOOLEAN_OR","||",951],["T_WHITESPACE"," ",951],["T_VARIABLE","$this",951],["T_OBJECT_OPERATOR","->",951],["T_STRING","_config",951],["T_OBJECT_OPERATOR","->",951],["T_STRING","getNeedUsePriceExcludeTax",951],"(",")",")",["T_WHITESPACE"," ",951],"{",["T_WHITESPACE","\n            ",951],["T_RETURN","return",952],["T_WHITESPACE"," ",952],["T_STRING","true",952],";",["T_WHITESPACE","\n        ",952],"}",["T_WHITESPACE","\n        ",953],["T_RETURN","return",954],["T_WHITESPACE"," ",954],["T_STRING","false",954],";",["T_WHITESPACE","\n    ",954],"}",["T_WHITESPACE","\n\n    ",955],["T_DOC_COMMENT","\/**\n     * Subtract shipping tax\n     *\n     * @deprecated after 1.4.0.1\n     *\n     * @param Mage_Sales_Model_Quote_Address $address\n     *\n     * @return bool\n     *\/",957],["T_WHITESPACE","\n    ",965],["T_PROTECTED","protected",966],["T_WHITESPACE"," ",966],["T_FUNCTION","function",966],["T_WHITESPACE"," ",966],["T_STRING","_needSubtractShippingTax",966],"(",["T_VARIABLE","$address",966],")",["T_WHITESPACE","\n    ",966],"{",["T_WHITESPACE","\n        ",967],["T_VARIABLE","$store",968],["T_WHITESPACE"," ",968],"=",["T_WHITESPACE"," ",968],["T_VARIABLE","$address",968],["T_OBJECT_OPERATOR","->",968],["T_STRING","getQuote",968],"(",")",["T_OBJECT_OPERATOR","->",968],["T_STRING","getStore",968],"(",")",";",["T_WHITESPACE","\n        ",968],["T_IF","if",969],["T_WHITESPACE"," ",969],"(",["T_VARIABLE","$this",969],["T_OBJECT_OPERATOR","->",969],["T_STRING","_config",969],["T_OBJECT_OPERATOR","->",969],["T_STRING","shippingPriceIncludesTax",969],"(",["T_VARIABLE","$store",969],")",["T_WHITESPACE"," ",969],["T_BOOLEAN_OR","||",969],["T_WHITESPACE"," ",969],["T_VARIABLE","$this",969],["T_OBJECT_OPERATOR","->",969],["T_STRING","_config",969],["T_OBJECT_OPERATOR","->",969],["T_STRING","getNeedUseShippingExcludeTax",969],"(",")",")",["T_WHITESPACE"," ",969],"{",["T_WHITESPACE","\n            ",969],["T_RETURN","return",970],["T_WHITESPACE"," ",970],["T_STRING","true",970],";",["T_WHITESPACE","\n        ",970],"}",["T_WHITESPACE","\n        ",971],["T_RETURN","return",972],["T_WHITESPACE"," ",972],["T_STRING","false",972],";",["T_WHITESPACE","\n    ",972],"}",["T_WHITESPACE","\n",973],"}",["T_WHITESPACE","\n\n",974]]