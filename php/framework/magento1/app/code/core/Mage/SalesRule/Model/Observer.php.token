[["T_OPEN_TAG","<?php\n",1],["T_DOC_COMMENT","\/**\n * Magento\n *\n * NOTICE OF LICENSE\n *\n * This source file is subject to the Open Software License (OSL 3.0)\n * that is bundled with this package in the file LICENSE.txt.\n * It is also available through the world-wide-web at this URL:\n * http:\/\/opensource.org\/licenses\/osl-3.0.php\n * If you did not receive a copy of the license and are unable to\n * obtain it through the world-wide-web, please send an email\n * to license@magento.com so we can send you a copy immediately.\n *\n * DISCLAIMER\n *\n * Do not edit or add to this file if you wish to upgrade Magento to newer\n * versions in the future. If you wish to customize Magento for your\n * needs please refer to http:\/\/www.magento.com for more information.\n *\n * @category    Mage\n * @package     Mage_SalesRule\n * @copyright  Copyright (c) 2006-2016 X.commerce, Inc. and affiliates (http:\/\/www.magento.com)\n * @license    http:\/\/opensource.org\/licenses\/osl-3.0.php  Open Software License (OSL 3.0)\n *\/",2],["T_WHITESPACE","\n\n",25],["T_DOC_COMMENT","\/**\n * SalesRule Model Observer\n *\n * @category    Mage\n * @package     Mage_SalesRule\n * @author      Magento Core Team <core@magentocommerce.com>\n *\/",27],["T_WHITESPACE","\n",33],["T_CLASS","class",34],["T_WHITESPACE"," ",34],["T_STRING","Mage_SalesRule_Model_Observer",34],["T_WHITESPACE","\n",34],"{",["T_WHITESPACE","\n\n    ",35],["T_DOC_COMMENT","\/**\n     * Sales Rule Validator\n     *\n     * @var Mage_SalesRule_Model_Validator\n     *\/",37],["T_WHITESPACE","\n    ",41],["T_PROTECTED","protected",42],["T_WHITESPACE"," ",42],["T_VARIABLE","$_validator",42],";",["T_WHITESPACE","\n\n    ",42],["T_DOC_COMMENT","\/**\n     * Get quote item validator\/processor object\n     *\n     * @deprecated\n     * @param   Varien_Event $event\n     * @return  Mage_SalesRule_Model_Validator\n     *\/",44],["T_WHITESPACE","\n    ",50],["T_PUBLIC","public",51],["T_WHITESPACE"," ",51],["T_FUNCTION","function",51],["T_WHITESPACE"," ",51],["T_STRING","getValidator",51],"(",["T_VARIABLE","$event",51],")",["T_WHITESPACE","\n    ",51],"{",["T_WHITESPACE","\n        ",52],["T_IF","if",53],["T_WHITESPACE"," ",53],"(","!",["T_VARIABLE","$this",53],["T_OBJECT_OPERATOR","->",53],["T_STRING","_validator",53],")",["T_WHITESPACE"," ",53],"{",["T_WHITESPACE","\n            ",53],["T_VARIABLE","$this",54],["T_OBJECT_OPERATOR","->",54],["T_STRING","_validator",54],["T_WHITESPACE"," ",54],"=",["T_WHITESPACE"," ",54],["T_STRING","Mage",54],["T_DOUBLE_COLON","::",54],["T_STRING","getModel",54],"(",["T_CONSTANT_ENCAPSED_STRING","'salesrule\/validator'",54],")",["T_WHITESPACE","\n                ",54],["T_OBJECT_OPERATOR","->",55],["T_STRING","init",55],"(",["T_VARIABLE","$event",55],["T_OBJECT_OPERATOR","->",55],["T_STRING","getWebsiteId",55],"(",")",",",["T_WHITESPACE"," ",55],["T_VARIABLE","$event",55],["T_OBJECT_OPERATOR","->",55],["T_STRING","getCustomerGroupId",55],"(",")",",",["T_WHITESPACE"," ",55],["T_VARIABLE","$event",55],["T_OBJECT_OPERATOR","->",55],["T_STRING","getCouponCode",55],"(",")",")",";",["T_WHITESPACE","\n        ",55],"}",["T_WHITESPACE","\n        ",56],["T_RETURN","return",57],["T_WHITESPACE"," ",57],["T_VARIABLE","$this",57],["T_OBJECT_OPERATOR","->",57],["T_STRING","_validator",57],";",["T_WHITESPACE","\n    ",57],"}",["T_WHITESPACE","\n\n    ",58],["T_DOC_COMMENT","\/**\n     * Process quote item (apply discount to item)\n     *\n     * @deprecated process call movet to total model\n     * @param Varien_Event_Observer $observer\n     *\/",60],["T_WHITESPACE","\n    ",65],["T_PUBLIC","public",66],["T_WHITESPACE"," ",66],["T_FUNCTION","function",66],["T_WHITESPACE"," ",66],["T_STRING","sales_quote_address_discount_item",66],"(",["T_VARIABLE","$observer",66],")",["T_WHITESPACE","\n    ",66],"{",["T_WHITESPACE","\n        ",67],["T_VARIABLE","$this",68],["T_OBJECT_OPERATOR","->",68],["T_STRING","getValidator",68],"(",["T_VARIABLE","$observer",68],["T_OBJECT_OPERATOR","->",68],["T_STRING","getEvent",68],"(",")",")",["T_WHITESPACE","\n            ",68],["T_OBJECT_OPERATOR","->",69],["T_STRING","process",69],"(",["T_VARIABLE","$observer",69],["T_OBJECT_OPERATOR","->",69],["T_STRING","getEvent",69],"(",")",["T_OBJECT_OPERATOR","->",69],["T_STRING","getItem",69],"(",")",")",";",["T_WHITESPACE","\n    ",69],"}",["T_WHITESPACE","\n\n    ",70],["T_DOC_COMMENT","\/**\n     * Registered callback: called after an order is placed\n     *\n     * @param Varien_Event_Observer $observer\n     *\/",72],["T_WHITESPACE","\n    ",76],["T_PUBLIC","public",77],["T_WHITESPACE"," ",77],["T_FUNCTION","function",77],["T_WHITESPACE"," ",77],["T_STRING","sales_order_afterPlace",77],"(",["T_VARIABLE","$observer",77],")",["T_WHITESPACE","\n    ",77],"{",["T_WHITESPACE","\n        ",78],["T_VARIABLE","$order",79],["T_WHITESPACE"," ",79],"=",["T_WHITESPACE"," ",79],["T_VARIABLE","$observer",79],["T_OBJECT_OPERATOR","->",79],["T_STRING","getEvent",79],"(",")",["T_OBJECT_OPERATOR","->",79],["T_STRING","getOrder",79],"(",")",";",["T_WHITESPACE","\n\n        ",79],["T_IF","if",81],["T_WHITESPACE"," ",81],"(","!",["T_VARIABLE","$order",81],")",["T_WHITESPACE"," ",81],"{",["T_WHITESPACE","\n            ",81],["T_RETURN","return",82],["T_WHITESPACE"," ",82],["T_VARIABLE","$this",82],";",["T_WHITESPACE","\n        ",82],"}",["T_WHITESPACE","\n\n        ",83],["T_COMMENT","\/\/ lookup rule ids\n",85],["T_WHITESPACE","        ",86],["T_VARIABLE","$ruleIds",86],["T_WHITESPACE"," ",86],"=",["T_WHITESPACE"," ",86],["T_STRING","explode",86],"(",["T_CONSTANT_ENCAPSED_STRING","','",86],",",["T_WHITESPACE"," ",86],["T_VARIABLE","$order",86],["T_OBJECT_OPERATOR","->",86],["T_STRING","getAppliedRuleIds",86],"(",")",")",";",["T_WHITESPACE","\n        ",86],["T_VARIABLE","$ruleIds",87],["T_WHITESPACE"," ",87],"=",["T_WHITESPACE"," ",87],["T_STRING","array_unique",87],"(",["T_VARIABLE","$ruleIds",87],")",";",["T_WHITESPACE","\n\n        ",87],["T_VARIABLE","$ruleCustomer",89],["T_WHITESPACE"," ",89],"=",["T_WHITESPACE"," ",89],["T_STRING","null",89],";",["T_WHITESPACE","\n        ",89],["T_VARIABLE","$customerId",90],["T_WHITESPACE"," ",90],"=",["T_WHITESPACE"," ",90],["T_VARIABLE","$order",90],["T_OBJECT_OPERATOR","->",90],["T_STRING","getCustomerId",90],"(",")",";",["T_WHITESPACE","\n\n        ",90],["T_COMMENT","\/\/ use each rule (and apply to customer, if applicable)\n",92],["T_WHITESPACE","        ",93],["T_IF","if",93],["T_WHITESPACE"," ",93],"(",["T_VARIABLE","$order",93],["T_OBJECT_OPERATOR","->",93],["T_STRING","getDiscountAmount",93],"(",")",["T_WHITESPACE"," ",93],["T_IS_NOT_EQUAL","!=",93],["T_WHITESPACE"," ",93],["T_LNUMBER","0",93],")",["T_WHITESPACE"," ",93],"{",["T_WHITESPACE","\n            ",93],["T_FOREACH","foreach",94],["T_WHITESPACE"," ",94],"(",["T_VARIABLE","$ruleIds",94],["T_WHITESPACE"," ",94],["T_AS","as",94],["T_WHITESPACE"," ",94],["T_VARIABLE","$ruleId",94],")",["T_WHITESPACE"," ",94],"{",["T_WHITESPACE","\n                ",94],["T_IF","if",95],["T_WHITESPACE"," ",95],"(","!",["T_VARIABLE","$ruleId",95],")",["T_WHITESPACE"," ",95],"{",["T_WHITESPACE","\n                    ",95],["T_CONTINUE","continue",96],";",["T_WHITESPACE","\n                ",96],"}",["T_WHITESPACE","\n                ",97],["T_VARIABLE","$rule",98],["T_WHITESPACE"," ",98],"=",["T_WHITESPACE"," ",98],["T_STRING","Mage",98],["T_DOUBLE_COLON","::",98],["T_STRING","getModel",98],"(",["T_CONSTANT_ENCAPSED_STRING","'salesrule\/rule'",98],")",";",["T_WHITESPACE","\n                ",98],["T_VARIABLE","$rule",99],["T_OBJECT_OPERATOR","->",99],["T_STRING","load",99],"(",["T_VARIABLE","$ruleId",99],")",";",["T_WHITESPACE","\n                ",99],["T_IF","if",100],["T_WHITESPACE"," ",100],"(",["T_VARIABLE","$rule",100],["T_OBJECT_OPERATOR","->",100],["T_STRING","getId",100],"(",")",")",["T_WHITESPACE"," ",100],"{",["T_WHITESPACE","\n                    ",100],["T_VARIABLE","$rule",101],["T_OBJECT_OPERATOR","->",101],["T_STRING","setTimesUsed",101],"(",["T_VARIABLE","$rule",101],["T_OBJECT_OPERATOR","->",101],["T_STRING","getTimesUsed",101],"(",")",["T_WHITESPACE"," ",101],"+",["T_WHITESPACE"," ",101],["T_LNUMBER","1",101],")",";",["T_WHITESPACE","\n                    ",101],["T_VARIABLE","$rule",102],["T_OBJECT_OPERATOR","->",102],["T_STRING","save",102],"(",")",";",["T_WHITESPACE","\n\n                    ",102],["T_IF","if",104],["T_WHITESPACE"," ",104],"(",["T_VARIABLE","$customerId",104],")",["T_WHITESPACE"," ",104],"{",["T_WHITESPACE","\n                        ",104],["T_VARIABLE","$ruleCustomer",105],["T_WHITESPACE"," ",105],"=",["T_WHITESPACE"," ",105],["T_STRING","Mage",105],["T_DOUBLE_COLON","::",105],["T_STRING","getModel",105],"(",["T_CONSTANT_ENCAPSED_STRING","'salesrule\/rule_customer'",105],")",";",["T_WHITESPACE","\n                        ",105],["T_VARIABLE","$ruleCustomer",106],["T_OBJECT_OPERATOR","->",106],["T_STRING","loadByCustomerRule",106],"(",["T_VARIABLE","$customerId",106],",",["T_WHITESPACE"," ",106],["T_VARIABLE","$ruleId",106],")",";",["T_WHITESPACE","\n\n                        ",106],["T_IF","if",108],["T_WHITESPACE"," ",108],"(",["T_VARIABLE","$ruleCustomer",108],["T_OBJECT_OPERATOR","->",108],["T_STRING","getId",108],"(",")",")",["T_WHITESPACE"," ",108],"{",["T_WHITESPACE","\n                            ",108],["T_VARIABLE","$ruleCustomer",109],["T_OBJECT_OPERATOR","->",109],["T_STRING","setTimesUsed",109],"(",["T_VARIABLE","$ruleCustomer",109],["T_OBJECT_OPERATOR","->",109],["T_STRING","getTimesUsed",109],"(",")",["T_WHITESPACE"," ",109],"+",["T_WHITESPACE"," ",109],["T_LNUMBER","1",109],")",";",["T_WHITESPACE","\n                        ",109],"}",["T_WHITESPACE","\n                        ",110],["T_ELSE","else",111],["T_WHITESPACE"," ",111],"{",["T_WHITESPACE","\n                            ",111],["T_VARIABLE","$ruleCustomer",112],["T_WHITESPACE","\n                            ",112],["T_OBJECT_OPERATOR","->",113],["T_STRING","setCustomerId",113],"(",["T_VARIABLE","$customerId",113],")",["T_WHITESPACE","\n                            ",113],["T_OBJECT_OPERATOR","->",114],["T_STRING","setRuleId",114],"(",["T_VARIABLE","$ruleId",114],")",["T_WHITESPACE","\n                            ",114],["T_OBJECT_OPERATOR","->",115],["T_STRING","setTimesUsed",115],"(",["T_LNUMBER","1",115],")",";",["T_WHITESPACE","\n                        ",115],"}",["T_WHITESPACE","\n                        ",116],["T_VARIABLE","$ruleCustomer",117],["T_OBJECT_OPERATOR","->",117],["T_STRING","save",117],"(",")",";",["T_WHITESPACE","\n                    ",117],"}",["T_WHITESPACE","\n                ",118],"}",["T_WHITESPACE","\n            ",119],"}",["T_WHITESPACE","\n            ",120],["T_VARIABLE","$coupon",121],["T_WHITESPACE"," ",121],"=",["T_WHITESPACE"," ",121],["T_STRING","Mage",121],["T_DOUBLE_COLON","::",121],["T_STRING","getModel",121],"(",["T_CONSTANT_ENCAPSED_STRING","'salesrule\/coupon'",121],")",";",["T_WHITESPACE","\n            ",121],["T_DOC_COMMENT","\/** @var Mage_SalesRule_Model_Coupon *\/",122],["T_WHITESPACE","\n            ",122],["T_VARIABLE","$coupon",123],["T_OBJECT_OPERATOR","->",123],["T_STRING","load",123],"(",["T_VARIABLE","$order",123],["T_OBJECT_OPERATOR","->",123],["T_STRING","getCouponCode",123],"(",")",",",["T_WHITESPACE"," ",123],["T_CONSTANT_ENCAPSED_STRING","'code'",123],")",";",["T_WHITESPACE","\n            ",123],["T_IF","if",124],["T_WHITESPACE"," ",124],"(",["T_VARIABLE","$coupon",124],["T_OBJECT_OPERATOR","->",124],["T_STRING","getId",124],"(",")",")",["T_WHITESPACE"," ",124],"{",["T_WHITESPACE","\n                ",124],["T_VARIABLE","$coupon",125],["T_OBJECT_OPERATOR","->",125],["T_STRING","setTimesUsed",125],"(",["T_VARIABLE","$coupon",125],["T_OBJECT_OPERATOR","->",125],["T_STRING","getTimesUsed",125],"(",")",["T_WHITESPACE"," ",125],"+",["T_WHITESPACE"," ",125],["T_LNUMBER","1",125],")",";",["T_WHITESPACE","\n                ",125],["T_VARIABLE","$coupon",126],["T_OBJECT_OPERATOR","->",126],["T_STRING","save",126],"(",")",";",["T_WHITESPACE","\n                ",126],["T_IF","if",127],["T_WHITESPACE"," ",127],"(",["T_VARIABLE","$customerId",127],")",["T_WHITESPACE"," ",127],"{",["T_WHITESPACE","\n                    ",127],["T_VARIABLE","$couponUsage",128],["T_WHITESPACE"," ",128],"=",["T_WHITESPACE"," ",128],["T_STRING","Mage",128],["T_DOUBLE_COLON","::",128],["T_STRING","getResourceModel",128],"(",["T_CONSTANT_ENCAPSED_STRING","'salesrule\/coupon_usage'",128],")",";",["T_WHITESPACE","\n                    ",128],["T_VARIABLE","$couponUsage",129],["T_OBJECT_OPERATOR","->",129],["T_STRING","updateCustomerCouponTimesUsed",129],"(",["T_VARIABLE","$customerId",129],",",["T_WHITESPACE"," ",129],["T_VARIABLE","$coupon",129],["T_OBJECT_OPERATOR","->",129],["T_STRING","getId",129],"(",")",")",";",["T_WHITESPACE","\n                ",129],"}",["T_WHITESPACE","\n            ",130],"}",["T_WHITESPACE","\n        ",131],"}",["T_WHITESPACE","\n    ",132],"}",["T_WHITESPACE","\n\n    ",133],["T_DOC_COMMENT","\/**\n     * Refresh sales coupons report statistics for last day\n     *\n     * @param Mage_Cron_Model_Schedule $schedule\n     * @return Mage_SalesRule_Model_Observer\n     *\/",135],["T_WHITESPACE","\n    ",140],["T_PUBLIC","public",141],["T_WHITESPACE"," ",141],["T_FUNCTION","function",141],["T_WHITESPACE"," ",141],["T_STRING","aggregateSalesReportCouponsData",141],"(",["T_VARIABLE","$schedule",141],")",["T_WHITESPACE","\n    ",141],"{",["T_WHITESPACE","\n        ",142],["T_STRING","Mage",143],["T_DOUBLE_COLON","::",143],["T_STRING","app",143],"(",")",["T_OBJECT_OPERATOR","->",143],["T_STRING","getLocale",143],"(",")",["T_OBJECT_OPERATOR","->",143],["T_STRING","emulate",143],"(",["T_LNUMBER","0",143],")",";",["T_WHITESPACE","\n        ",143],["T_VARIABLE","$currentDate",144],["T_WHITESPACE"," ",144],"=",["T_WHITESPACE"," ",144],["T_STRING","Mage",144],["T_DOUBLE_COLON","::",144],["T_STRING","app",144],"(",")",["T_OBJECT_OPERATOR","->",144],["T_STRING","getLocale",144],"(",")",["T_OBJECT_OPERATOR","->",144],["T_STRING","date",144],"(",")",";",["T_WHITESPACE","\n        ",144],["T_VARIABLE","$date",145],["T_WHITESPACE"," ",145],"=",["T_WHITESPACE"," ",145],["T_VARIABLE","$currentDate",145],["T_OBJECT_OPERATOR","->",145],["T_STRING","subHour",145],"(",["T_LNUMBER","25",145],")",";",["T_WHITESPACE","\n        ",145],["T_STRING","Mage",146],["T_DOUBLE_COLON","::",146],["T_STRING","getResourceModel",146],"(",["T_CONSTANT_ENCAPSED_STRING","'salesrule\/report_rule'",146],")",["T_OBJECT_OPERATOR","->",146],["T_STRING","aggregate",146],"(",["T_VARIABLE","$date",146],")",";",["T_WHITESPACE","\n        ",146],["T_STRING","Mage",147],["T_DOUBLE_COLON","::",147],["T_STRING","app",147],"(",")",["T_OBJECT_OPERATOR","->",147],["T_STRING","getLocale",147],"(",")",["T_OBJECT_OPERATOR","->",147],["T_STRING","revert",147],"(",")",";",["T_WHITESPACE","\n        ",147],["T_RETURN","return",148],["T_WHITESPACE"," ",148],["T_VARIABLE","$this",148],";",["T_WHITESPACE","\n    ",148],"}",["T_WHITESPACE","\n\n    ",149],["T_DOC_COMMENT","\/**\n     * Check rules that contains affected attribute\n     * If rules were found they will be set to inactive and notice will be add to admin session\n     *\n     * @param string $attributeCode\n     * @return Mage_SalesRule_Model_Observer\n     *\/",151],["T_WHITESPACE","\n    ",157],["T_PROTECTED","protected",158],["T_WHITESPACE"," ",158],["T_FUNCTION","function",158],["T_WHITESPACE"," ",158],["T_STRING","_checkSalesRulesAvailability",158],"(",["T_VARIABLE","$attributeCode",158],")",["T_WHITESPACE","\n    ",158],"{",["T_WHITESPACE","\n        ",159],["T_COMMENT","\/* @var $collection Mage_SalesRule_Model_Mysql4_Rule_Collection *\/",160],["T_WHITESPACE","\n        ",160],["T_VARIABLE","$collection",161],["T_WHITESPACE"," ",161],"=",["T_WHITESPACE"," ",161],["T_STRING","Mage",161],["T_DOUBLE_COLON","::",161],["T_STRING","getResourceModel",161],"(",["T_CONSTANT_ENCAPSED_STRING","'salesrule\/rule_collection'",161],")",["T_WHITESPACE","\n            ",161],["T_OBJECT_OPERATOR","->",162],["T_STRING","addAttributeInConditionFilter",162],"(",["T_VARIABLE","$attributeCode",162],")",";",["T_WHITESPACE","\n\n        ",162],["T_VARIABLE","$disabledRulesCount",164],["T_WHITESPACE"," ",164],"=",["T_WHITESPACE"," ",164],["T_LNUMBER","0",164],";",["T_WHITESPACE","\n        ",164],["T_FOREACH","foreach",165],["T_WHITESPACE"," ",165],"(",["T_VARIABLE","$collection",165],["T_WHITESPACE"," ",165],["T_AS","as",165],["T_WHITESPACE"," ",165],["T_VARIABLE","$rule",165],")",["T_WHITESPACE"," ",165],"{",["T_WHITESPACE","\n            ",165],["T_COMMENT","\/* @var $rule Mage_SalesRule_Model_Rule *\/",166],["T_WHITESPACE","\n            ",166],["T_VARIABLE","$rule",167],["T_OBJECT_OPERATOR","->",167],["T_STRING","setIsActive",167],"(",["T_LNUMBER","0",167],")",";",["T_WHITESPACE","\n            ",167],["T_COMMENT","\/* @var $rule->getConditions() Mage_SalesRule_Model_Rule_Condition_Combine *\/",168],["T_WHITESPACE","\n            ",168],["T_VARIABLE","$this",169],["T_OBJECT_OPERATOR","->",169],["T_STRING","_removeAttributeFromConditions",169],"(",["T_VARIABLE","$rule",169],["T_OBJECT_OPERATOR","->",169],["T_STRING","getConditions",169],"(",")",",",["T_WHITESPACE"," ",169],["T_VARIABLE","$attributeCode",169],")",";",["T_WHITESPACE","\n            ",169],["T_VARIABLE","$this",170],["T_OBJECT_OPERATOR","->",170],["T_STRING","_removeAttributeFromConditions",170],"(",["T_VARIABLE","$rule",170],["T_OBJECT_OPERATOR","->",170],["T_STRING","getActions",170],"(",")",",",["T_WHITESPACE"," ",170],["T_VARIABLE","$attributeCode",170],")",";",["T_WHITESPACE","\n            ",170],["T_VARIABLE","$rule",171],["T_OBJECT_OPERATOR","->",171],["T_STRING","save",171],"(",")",";",["T_WHITESPACE","\n\n            ",171],["T_VARIABLE","$disabledRulesCount",173],["T_INC","++",173],";",["T_WHITESPACE","\n        ",173],"}",["T_WHITESPACE","\n\n        ",174],["T_IF","if",176],["T_WHITESPACE"," ",176],"(",["T_VARIABLE","$disabledRulesCount",176],")",["T_WHITESPACE"," ",176],"{",["T_WHITESPACE","\n            ",176],["T_STRING","Mage",177],["T_DOUBLE_COLON","::",177],["T_STRING","getSingleton",177],"(",["T_CONSTANT_ENCAPSED_STRING","'adminhtml\/session'",177],")",["T_OBJECT_OPERATOR","->",177],["T_STRING","addWarning",177],"(",["T_WHITESPACE","\n                ",177],["T_STRING","Mage",178],["T_DOUBLE_COLON","::",178],["T_STRING","helper",178],"(",["T_CONSTANT_ENCAPSED_STRING","'salesrule'",178],")",["T_OBJECT_OPERATOR","->",178],["T_STRING","__",178],"(",["T_CONSTANT_ENCAPSED_STRING","'%d Shopping Cart Price Rules based on \"%s\" attribute have been disabled.'",178],",",["T_WHITESPACE"," ",178],["T_VARIABLE","$disabledRulesCount",178],",",["T_WHITESPACE"," ",178],["T_VARIABLE","$attributeCode",178],")",")",";",["T_WHITESPACE","\n        ",178],"}",["T_WHITESPACE","\n\n        ",179],["T_RETURN","return",181],["T_WHITESPACE"," ",181],["T_VARIABLE","$this",181],";",["T_WHITESPACE","\n    ",181],"}",["T_WHITESPACE","\n\n    ",182],["T_DOC_COMMENT","\/**\n     * Remove catalog attribute condition by attribute code from rule conditions\n     *\n     * @param Mage_Rule_Model_Condition_Combine $combine\n     * @param string $attributeCode\n     *\/",184],["T_WHITESPACE","\n    ",189],["T_PROTECTED","protected",190],["T_WHITESPACE"," ",190],["T_FUNCTION","function",190],["T_WHITESPACE"," ",190],["T_STRING","_removeAttributeFromConditions",190],"(",["T_VARIABLE","$combine",190],",",["T_WHITESPACE"," ",190],["T_VARIABLE","$attributeCode",190],")",["T_WHITESPACE","\n    ",190],"{",["T_WHITESPACE","\n        ",191],["T_VARIABLE","$conditions",192],["T_WHITESPACE"," ",192],"=",["T_WHITESPACE"," ",192],["T_VARIABLE","$combine",192],["T_OBJECT_OPERATOR","->",192],["T_STRING","getConditions",192],"(",")",";",["T_WHITESPACE","\n        ",192],["T_FOREACH","foreach",193],["T_WHITESPACE"," ",193],"(",["T_VARIABLE","$conditions",193],["T_WHITESPACE"," ",193],["T_AS","as",193],["T_WHITESPACE"," ",193],["T_VARIABLE","$conditionId",193],["T_WHITESPACE"," ",193],["T_DOUBLE_ARROW","=>",193],["T_WHITESPACE"," ",193],["T_VARIABLE","$condition",193],")",["T_WHITESPACE"," ",193],"{",["T_WHITESPACE","\n            ",193],["T_IF","if",194],["T_WHITESPACE"," ",194],"(",["T_VARIABLE","$condition",194],["T_WHITESPACE"," ",194],["T_INSTANCEOF","instanceof",194],["T_WHITESPACE"," ",194],["T_STRING","Mage_Rule_Model_Condition_Combine",194],")",["T_WHITESPACE"," ",194],"{",["T_WHITESPACE","\n                ",194],["T_VARIABLE","$this",195],["T_OBJECT_OPERATOR","->",195],["T_STRING","_removeAttributeFromConditions",195],"(",["T_VARIABLE","$condition",195],",",["T_WHITESPACE"," ",195],["T_VARIABLE","$attributeCode",195],")",";",["T_WHITESPACE","\n            ",195],"}",["T_WHITESPACE","\n            ",196],["T_IF","if",197],["T_WHITESPACE"," ",197],"(",["T_VARIABLE","$condition",197],["T_WHITESPACE"," ",197],["T_INSTANCEOF","instanceof",197],["T_WHITESPACE"," ",197],["T_STRING","Mage_SalesRule_Model_Rule_Condition_Product",197],")",["T_WHITESPACE"," ",197],"{",["T_WHITESPACE","\n                ",197],["T_IF","if",198],["T_WHITESPACE"," ",198],"(",["T_VARIABLE","$condition",198],["T_OBJECT_OPERATOR","->",198],["T_STRING","getAttribute",198],"(",")",["T_WHITESPACE"," ",198],["T_IS_EQUAL","==",198],["T_WHITESPACE"," ",198],["T_VARIABLE","$attributeCode",198],")",["T_WHITESPACE"," ",198],"{",["T_WHITESPACE","\n                    ",198],["T_UNSET","unset",199],"(",["T_VARIABLE","$conditions",199],"[",["T_VARIABLE","$conditionId",199],"]",")",";",["T_WHITESPACE","\n                ",199],"}",["T_WHITESPACE","\n            ",200],"}",["T_WHITESPACE","\n        ",201],"}",["T_WHITESPACE","\n        ",202],["T_VARIABLE","$combine",203],["T_OBJECT_OPERATOR","->",203],["T_STRING","setConditions",203],"(",["T_VARIABLE","$conditions",203],")",";",["T_WHITESPACE","\n    ",203],"}",["T_WHITESPACE","\n\n    ",204],["T_DOC_COMMENT","\/**\n     * After save attribute if it is not used for promo rules already check rules for containing this attribute\n     *\n     * @param Varien_Event_Observer $observer\n     * @return Mage_SalesRule_Model_Observer\n     *\/",206],["T_WHITESPACE","\n    ",211],["T_PUBLIC","public",212],["T_WHITESPACE"," ",212],["T_FUNCTION","function",212],["T_WHITESPACE"," ",212],["T_STRING","catalogAttributeSaveAfter",212],"(",["T_STRING","Varien_Event_Observer",212],["T_WHITESPACE"," ",212],["T_VARIABLE","$observer",212],")",["T_WHITESPACE","\n    ",212],"{",["T_WHITESPACE","\n        ",213],["T_VARIABLE","$attribute",214],["T_WHITESPACE"," ",214],"=",["T_WHITESPACE"," ",214],["T_VARIABLE","$observer",214],["T_OBJECT_OPERATOR","->",214],["T_STRING","getEvent",214],"(",")",["T_OBJECT_OPERATOR","->",214],["T_STRING","getAttribute",214],"(",")",";",["T_WHITESPACE","\n        ",214],["T_IF","if",215],["T_WHITESPACE"," ",215],"(",["T_VARIABLE","$attribute",215],["T_OBJECT_OPERATOR","->",215],["T_STRING","dataHasChangedFor",215],"(",["T_CONSTANT_ENCAPSED_STRING","'is_used_for_promo_rules'",215],")",["T_WHITESPACE"," ",215],["T_BOOLEAN_AND","&&",215],["T_WHITESPACE"," ",215],"!",["T_VARIABLE","$attribute",215],["T_OBJECT_OPERATOR","->",215],["T_STRING","getIsUsedForPromoRules",215],"(",")",")",["T_WHITESPACE"," ",215],"{",["T_WHITESPACE","\n            ",215],["T_VARIABLE","$this",216],["T_OBJECT_OPERATOR","->",216],["T_STRING","_checkSalesRulesAvailability",216],"(",["T_VARIABLE","$attribute",216],["T_OBJECT_OPERATOR","->",216],["T_STRING","getAttributeCode",216],"(",")",")",";",["T_WHITESPACE","\n        ",216],"}",["T_WHITESPACE","\n\n        ",217],["T_RETURN","return",219],["T_WHITESPACE"," ",219],["T_VARIABLE","$this",219],";",["T_WHITESPACE","\n    ",219],"}",["T_WHITESPACE","\n\n    ",220],["T_DOC_COMMENT","\/**\n     * After delete attribute check rules that contains deleted attribute\n     * If rules was found they will seted to inactive and added notice to admin session\n     *\n     * @param Varien_Event_Observer $observer\n     * @return Mage_SalesRule_Model_Observer\n     *\/",222],["T_WHITESPACE","\n    ",228],["T_PUBLIC","public",229],["T_WHITESPACE"," ",229],["T_FUNCTION","function",229],["T_WHITESPACE"," ",229],["T_STRING","catalogAttributeDeleteAfter",229],"(",["T_STRING","Varien_Event_Observer",229],["T_WHITESPACE"," ",229],["T_VARIABLE","$observer",229],")",["T_WHITESPACE","\n    ",229],"{",["T_WHITESPACE","\n        ",230],["T_VARIABLE","$attribute",231],["T_WHITESPACE"," ",231],"=",["T_WHITESPACE"," ",231],["T_VARIABLE","$observer",231],["T_OBJECT_OPERATOR","->",231],["T_STRING","getEvent",231],"(",")",["T_OBJECT_OPERATOR","->",231],["T_STRING","getAttribute",231],"(",")",";",["T_WHITESPACE","\n        ",231],["T_IF","if",232],["T_WHITESPACE"," ",232],"(",["T_VARIABLE","$attribute",232],["T_OBJECT_OPERATOR","->",232],["T_STRING","getIsUsedForPromoRules",232],"(",")",")",["T_WHITESPACE"," ",232],"{",["T_WHITESPACE","\n            ",232],["T_VARIABLE","$this",233],["T_OBJECT_OPERATOR","->",233],["T_STRING","_checkSalesRulesAvailability",233],"(",["T_VARIABLE","$attribute",233],["T_OBJECT_OPERATOR","->",233],["T_STRING","getAttributeCode",233],"(",")",")",";",["T_WHITESPACE","\n        ",233],"}",["T_WHITESPACE","\n\n        ",234],["T_RETURN","return",236],["T_WHITESPACE"," ",236],["T_VARIABLE","$this",236],";",["T_WHITESPACE","\n    ",236],"}",["T_WHITESPACE","\n\n    ",237],["T_DOC_COMMENT","\/**\n     * Append sales rule product attributes to select by quote item collection\n     *\n     * @param Varien_Event_Observer $observer\n     * @return Mage_SalesRule_Model_Observer\n     *\/",239],["T_WHITESPACE","\n    ",244],["T_PUBLIC","public",245],["T_WHITESPACE"," ",245],["T_FUNCTION","function",245],["T_WHITESPACE"," ",245],["T_STRING","addProductAttributes",245],"(",["T_STRING","Varien_Event_Observer",245],["T_WHITESPACE"," ",245],["T_VARIABLE","$observer",245],")",["T_WHITESPACE","\n    ",245],"{",["T_WHITESPACE","\n        ",246],["T_COMMENT","\/\/ @var Varien_Object\n",247],["T_WHITESPACE","        ",248],["T_VARIABLE","$attributesTransfer",248],["T_WHITESPACE"," ",248],"=",["T_WHITESPACE"," ",248],["T_VARIABLE","$observer",248],["T_OBJECT_OPERATOR","->",248],["T_STRING","getEvent",248],"(",")",["T_OBJECT_OPERATOR","->",248],["T_STRING","getAttributes",248],"(",")",";",["T_WHITESPACE","\n\n        ",248],["T_VARIABLE","$attributes",250],["T_WHITESPACE"," ",250],"=",["T_WHITESPACE"," ",250],["T_STRING","Mage",250],["T_DOUBLE_COLON","::",250],["T_STRING","getResourceModel",250],"(",["T_CONSTANT_ENCAPSED_STRING","'salesrule\/rule'",250],")",["T_WHITESPACE","\n            ",250],["T_OBJECT_OPERATOR","->",251],["T_STRING","getActiveAttributes",251],"(",["T_WHITESPACE","\n                ",251],["T_STRING","Mage",252],["T_DOUBLE_COLON","::",252],["T_STRING","app",252],"(",")",["T_OBJECT_OPERATOR","->",252],["T_STRING","getWebsite",252],"(",")",["T_OBJECT_OPERATOR","->",252],["T_STRING","getId",252],"(",")",",",["T_WHITESPACE","\n                ",252],["T_STRING","Mage",253],["T_DOUBLE_COLON","::",253],["T_STRING","getSingleton",253],"(",["T_CONSTANT_ENCAPSED_STRING","'customer\/session'",253],")",["T_OBJECT_OPERATOR","->",253],["T_STRING","getCustomer",253],"(",")",["T_OBJECT_OPERATOR","->",253],["T_STRING","getGroupId",253],"(",")",["T_WHITESPACE","\n            ",253],")",";",["T_WHITESPACE","\n        ",254],["T_VARIABLE","$result",255],["T_WHITESPACE"," ",255],"=",["T_WHITESPACE"," ",255],["T_ARRAY","array",255],"(",")",";",["T_WHITESPACE","\n        ",255],["T_FOREACH","foreach",256],["T_WHITESPACE"," ",256],"(",["T_VARIABLE","$attributes",256],["T_WHITESPACE"," ",256],["T_AS","as",256],["T_WHITESPACE"," ",256],["T_VARIABLE","$attribute",256],")",["T_WHITESPACE"," ",256],"{",["T_WHITESPACE","\n            ",256],["T_VARIABLE","$result",257],"[",["T_VARIABLE","$attribute",257],"[",["T_CONSTANT_ENCAPSED_STRING","'attribute_code'",257],"]","]",["T_WHITESPACE"," ",257],"=",["T_WHITESPACE"," ",257],["T_STRING","true",257],";",["T_WHITESPACE","\n        ",257],"}",["T_WHITESPACE","\n        ",258],["T_VARIABLE","$attributesTransfer",259],["T_OBJECT_OPERATOR","->",259],["T_STRING","addData",259],"(",["T_VARIABLE","$result",259],")",";",["T_WHITESPACE","\n        ",259],["T_RETURN","return",260],["T_WHITESPACE"," ",260],["T_VARIABLE","$this",260],";",["T_WHITESPACE","\n    ",260],"}",["T_WHITESPACE","\n\n    ",261],["T_DOC_COMMENT","\/**\n     * Add coupon's rule name to order data\n     *\n     * @param Varien_Event_Observer $observer\n     * @return Mage_SalesRule_Model_Observer\n     *\/",263],["T_WHITESPACE","\n    ",268],["T_PUBLIC","public",269],["T_WHITESPACE"," ",269],["T_FUNCTION","function",269],["T_WHITESPACE"," ",269],["T_STRING","addSalesRuleNameToOrder",269],"(",["T_VARIABLE","$observer",269],")",["T_WHITESPACE","\n    ",269],"{",["T_WHITESPACE","\n        ",270],["T_VARIABLE","$order",271],["T_WHITESPACE"," ",271],"=",["T_WHITESPACE"," ",271],["T_VARIABLE","$observer",271],["T_OBJECT_OPERATOR","->",271],["T_STRING","getOrder",271],"(",")",";",["T_WHITESPACE","\n        ",271],["T_VARIABLE","$couponCode",272],["T_WHITESPACE"," ",272],"=",["T_WHITESPACE"," ",272],["T_VARIABLE","$order",272],["T_OBJECT_OPERATOR","->",272],["T_STRING","getCouponCode",272],"(",")",";",["T_WHITESPACE","\n\n        ",272],["T_IF","if",274],["T_WHITESPACE"," ",274],"(",["T_EMPTY","empty",274],"(",["T_VARIABLE","$couponCode",274],")",")",["T_WHITESPACE"," ",274],"{",["T_WHITESPACE","\n            ",274],["T_RETURN","return",275],["T_WHITESPACE"," ",275],["T_VARIABLE","$this",275],";",["T_WHITESPACE","\n        ",275],"}",["T_WHITESPACE","\n\n        ",276],["T_DOC_COMMENT","\/**\n         * @var Mage_SalesRule_Model_Coupon $couponModel\n         *\/",278],["T_WHITESPACE","\n        ",280],["T_VARIABLE","$couponModel",281],["T_WHITESPACE"," ",281],"=",["T_WHITESPACE"," ",281],["T_STRING","Mage",281],["T_DOUBLE_COLON","::",281],["T_STRING","getModel",281],"(",["T_CONSTANT_ENCAPSED_STRING","'salesrule\/coupon'",281],")",";",["T_WHITESPACE","\n        ",281],["T_VARIABLE","$couponModel",282],["T_OBJECT_OPERATOR","->",282],["T_STRING","loadByCode",282],"(",["T_VARIABLE","$couponCode",282],")",";",["T_WHITESPACE","\n\n        ",282],["T_VARIABLE","$ruleId",284],["T_WHITESPACE"," ",284],"=",["T_WHITESPACE"," ",284],["T_VARIABLE","$couponModel",284],["T_OBJECT_OPERATOR","->",284],["T_STRING","getRuleId",284],"(",")",";",["T_WHITESPACE","\n\n        ",284],["T_IF","if",286],["T_WHITESPACE"," ",286],"(",["T_EMPTY","empty",286],"(",["T_VARIABLE","$ruleId",286],")",")",["T_WHITESPACE"," ",286],"{",["T_WHITESPACE","\n            ",286],["T_RETURN","return",287],["T_WHITESPACE"," ",287],["T_VARIABLE","$this",287],";",["T_WHITESPACE","\n        ",287],"}",["T_WHITESPACE","\n\n        ",288],["T_DOC_COMMENT","\/**\n         * @var Mage_SalesRule_Model_Rule $ruleModel\n         *\/",290],["T_WHITESPACE","\n        ",292],["T_VARIABLE","$ruleModel",293],["T_WHITESPACE"," ",293],"=",["T_WHITESPACE"," ",293],["T_STRING","Mage",293],["T_DOUBLE_COLON","::",293],["T_STRING","getModel",293],"(",["T_CONSTANT_ENCAPSED_STRING","'salesrule\/rule'",293],")",";",["T_WHITESPACE","\n        ",293],["T_VARIABLE","$ruleModel",294],["T_OBJECT_OPERATOR","->",294],["T_STRING","load",294],"(",["T_VARIABLE","$ruleId",294],")",";",["T_WHITESPACE","\n\n        ",294],["T_VARIABLE","$order",296],["T_OBJECT_OPERATOR","->",296],["T_STRING","setCouponRuleName",296],"(",["T_VARIABLE","$ruleModel",296],["T_OBJECT_OPERATOR","->",296],["T_STRING","getName",296],"(",")",")",";",["T_WHITESPACE","\n\n        ",296],["T_RETURN","return",298],["T_WHITESPACE"," ",298],["T_VARIABLE","$this",298],";",["T_WHITESPACE","\n    ",298],"}",["T_WHITESPACE","\n",299],"}",["T_WHITESPACE","\n\n",300]]