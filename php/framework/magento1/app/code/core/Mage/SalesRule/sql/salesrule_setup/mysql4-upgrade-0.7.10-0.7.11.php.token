[["T_OPEN_TAG","<?php\n",1],["T_DOC_COMMENT","\/**\n * Magento\n *\n * NOTICE OF LICENSE\n *\n * This source file is subject to the Open Software License (OSL 3.0)\n * that is bundled with this package in the file LICENSE.txt.\n * It is also available through the world-wide-web at this URL:\n * http:\/\/opensource.org\/licenses\/osl-3.0.php\n * If you did not receive a copy of the license and are unable to\n * obtain it through the world-wide-web, please send an email\n * to license@magento.com so we can send you a copy immediately.\n *\n * DISCLAIMER\n *\n * Do not edit or add to this file if you wish to upgrade Magento to newer\n * versions in the future. If you wish to customize Magento for your\n * needs please refer to http:\/\/www.magento.com for more information.\n *\n * @category    Mage\n * @package     Mage_SalesRule\n * @copyright  Copyright (c) 2006-2016 X.commerce, Inc. and affiliates (http:\/\/www.magento.com)\n * @license    http:\/\/opensource.org\/licenses\/osl-3.0.php  Open Software License (OSL 3.0)\n *\/",2],["T_WHITESPACE","\n\n",25],["T_VARIABLE","$installer",27],["T_WHITESPACE"," ",27],"=",["T_WHITESPACE"," ",27],["T_VARIABLE","$this",27],";",["T_WHITESPACE","\n",27],["T_COMMENT","\/* @var $installer Mage_Sales_Model_Mysql4_Setup *\/",28],["T_WHITESPACE","\n",28],["T_VARIABLE","$installer",29],["T_OBJECT_OPERATOR","->",29],["T_STRING","startSetup",29],"(",")",";",["T_WHITESPACE","\n\n\n",29],["T_COMMENT","\/*\n * @deprecated since 1.4 Sales no more eav, moving attributes from eav to flat table,\n *             already done in sales upgrade\n *\n\n$orderEntityType = $installer->getEntityType('order');\n$orderEntityTypeId = $orderEntityType['entity_type_id'];\n\n\n$attribute = $installer->getAttribute($orderEntityTypeId, 'coupon_code');\n\n$installer->getConnection()->addColumn($this->getTable('sales\/order'), $attribute['attribute_code'], \"varchar(255) NULL DEFAULT NULL\");\n\ntry {\n    $installer->getConnection()->beginTransaction();\n\n    $installer->run(\"\n        UPDATE {$this->getTable('sales\/order')} AS o, {$this->getTable('sales\/order')}_varchar AS od\n        SET o.{$attribute['attribute_code']} = od.value\n        WHERE od.entity_id = o.entity_id\n            AND od.attribute_id = {$attribute['attribute_id']}\n            AND od.entity_type_id = {$orderEntityTypeId}\n    \");\n\n    $installer->run(\"\n        DELETE FROM {$this->getTable('sales\/order')}_{$attribute['backend_type']}\n        WHERE attribute_id = {$attribute['attribute_id']}\n            AND entity_type_id = {$orderEntityTypeId}\n    \");\n\n    $installer->updateAttribute($orderEntityTypeId, $attribute['attribute_code'], array('backend_type' => 'static'));\n\n    $installer->getConnection()->commit();\n\n} catch (Exception $e) {\n    $installer->getConnection()->rollback();\n    $installer->getConnection()->dropColumn($this->getTable('sales\/order'), $attribute['attribute_code']);\n    throw $e;\n}\n*\/",32],["T_WHITESPACE","\n\n",71],["T_VARIABLE","$installer",73],["T_OBJECT_OPERATOR","->",73],["T_STRING","run",73],"(","\"",["T_ENCAPSED_AND_WHITESPACE","\n    CREATE TABLE `",73],["T_CURLY_OPEN","{",74],["T_VARIABLE","$installer",74],["T_OBJECT_OPERATOR","->",74],["T_STRING","getTable",74],"(",["T_CONSTANT_ENCAPSED_STRING","'salesrule\/coupon_aggregated'",74],")","}",["T_ENCAPSED_AND_WHITESPACE","` (\n        `id`                        int(11) unsigned NOT NULL auto_increment,\n        `period`                    date NOT NULL DEFAULT '0000-00-00',\n        `store_id`                  smallint(5) unsigned NULL DEFAULT NULL,\n        `order_status`              varchar(50) NOT NULL default '',\n        `coupon_code`               varchar(50) NOT NULL default '',\n        `coupon_uses`               int(11) NOT NULL DEFAULT '0',\n        `subtotal_amount`           decimal(12,4) NOT NULL DEFAULT '0',\n        `discount_amount`           decimal(12,4) NOT NULL DEFAULT '0',\n        `total_amount`              decimal(12,4) NOT NULL DEFAULT '0',\n        PRIMARY KEY (`id`),\n        UNIQUE KEY `UNQ_COUPON_AGGREGATED_PSOC` (`period`,`store_id`, `order_status`, `coupon_code`),\n        KEY `IDX_STORE_ID` (`store_id`)\n    ) ENGINE=InnoDB DEFAULT CHARSET=utf8;\n\n    CREATE TABLE `",74],["T_CURLY_OPEN","{",89],["T_VARIABLE","$installer",89],["T_OBJECT_OPERATOR","->",89],["T_STRING","getTable",89],"(",["T_CONSTANT_ENCAPSED_STRING","'salesrule\/coupon_aggregated_order'",89],")","}",["T_ENCAPSED_AND_WHITESPACE","` (\n        `id`                        int(11) unsigned NOT NULL auto_increment,\n        `period`                    date NOT NULL DEFAULT '0000-00-00',\n        `store_id`                  smallint(5) unsigned NULL DEFAULT NULL,\n        `order_status`              varchar(50) NOT NULL default '',\n        `coupon_code`               varchar(50) NOT NULL default '',\n        `coupon_uses`               int(11) NOT NULL DEFAULT '0',\n        `subtotal_amount`           decimal(12,4) NOT NULL DEFAULT '0',\n        `discount_amount`           decimal(12,4) NOT NULL DEFAULT '0',\n        `total_amount`              decimal(12,4) NOT NULL DEFAULT '0',\n        PRIMARY KEY (`id`),\n        UNIQUE KEY `UNQ_COUPON_AGGREGATED_ORDER_PSOC` (`period`,`store_id`, `order_status`,`coupon_code`),\n        KEY `IDX_STORE_ID` (`store_id`)\n  ) ENGINE=InnoDB DEFAULT CHARSET=utf8;\n",89],"\"",")",";",["T_WHITESPACE","\n\n",103],["T_VARIABLE","$installer",105],["T_OBJECT_OPERATOR","->",105],["T_STRING","getConnection",105],"(",")",["T_OBJECT_OPERATOR","->",105],["T_STRING","addConstraint",105],"(",["T_WHITESPACE","\n    ",105],["T_CONSTANT_ENCAPSED_STRING","'FK_SALESTRULE_COUPON_AGGREGATED_ORDER_STORE'",106],",",["T_WHITESPACE","\n    ",106],["T_VARIABLE","$this",107],["T_OBJECT_OPERATOR","->",107],["T_STRING","getTable",107],"(",["T_CONSTANT_ENCAPSED_STRING","'salesrule\/coupon_aggregated_order'",107],")",",",["T_WHITESPACE","\n    ",107],["T_CONSTANT_ENCAPSED_STRING","'store_id'",108],",",["T_WHITESPACE","\n    ",108],["T_VARIABLE","$this",109],["T_OBJECT_OPERATOR","->",109],["T_STRING","getTable",109],"(",["T_CONSTANT_ENCAPSED_STRING","'core_store'",109],")",",",["T_WHITESPACE","\n    ",109],["T_CONSTANT_ENCAPSED_STRING","'store_id'",110],["T_WHITESPACE","\n",110],")",";",["T_WHITESPACE","\n\n",111],["T_VARIABLE","$installer",113],["T_OBJECT_OPERATOR","->",113],["T_STRING","getConnection",113],"(",")",["T_OBJECT_OPERATOR","->",113],["T_STRING","addConstraint",113],"(",["T_WHITESPACE","\n    ",113],["T_CONSTANT_ENCAPSED_STRING","'FK_SALESTRULE_COUPON_AGGREGATED_STORE'",114],",",["T_WHITESPACE","\n    ",114],["T_VARIABLE","$this",115],["T_OBJECT_OPERATOR","->",115],["T_STRING","getTable",115],"(",["T_CONSTANT_ENCAPSED_STRING","'salesrule\/coupon_aggregated'",115],")",",",["T_WHITESPACE","\n    ",115],["T_CONSTANT_ENCAPSED_STRING","'store_id'",116],",",["T_WHITESPACE","\n    ",116],["T_VARIABLE","$this",117],["T_OBJECT_OPERATOR","->",117],["T_STRING","getTable",117],"(",["T_CONSTANT_ENCAPSED_STRING","'core_store'",117],")",",",["T_WHITESPACE","\n    ",117],["T_CONSTANT_ENCAPSED_STRING","'store_id'",118],["T_WHITESPACE","\n",118],")",";",["T_WHITESPACE","\n\n",119],["T_VARIABLE","$installer",121],["T_OBJECT_OPERATOR","->",121],["T_STRING","endSetup",121],"(",")",";",["T_WHITESPACE","\n",121]]