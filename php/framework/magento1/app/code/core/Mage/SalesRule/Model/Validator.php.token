[["T_OPEN_TAG","<?php\n",1],["T_DOC_COMMENT","\/**\n * Magento\n *\n * NOTICE OF LICENSE\n *\n * This source file is subject to the Open Software License (OSL 3.0)\n * that is bundled with this package in the file LICENSE.txt.\n * It is also available through the world-wide-web at this URL:\n * http:\/\/opensource.org\/licenses\/osl-3.0.php\n * If you did not receive a copy of the license and are unable to\n * obtain it through the world-wide-web, please send an email\n * to license@magento.com so we can send you a copy immediately.\n *\n * DISCLAIMER\n *\n * Do not edit or add to this file if you wish to upgrade Magento to newer\n * versions in the future. If you wish to customize Magento for your\n * needs please refer to http:\/\/www.magento.com for more information.\n *\n * @category    Mage\n * @package     Mage_SalesRule\n * @copyright  Copyright (c) 2006-2016 X.commerce, Inc. and affiliates (http:\/\/www.magento.com)\n * @license    http:\/\/opensource.org\/licenses\/osl-3.0.php  Open Software License (OSL 3.0)\n *\/",2],["T_WHITESPACE","\n\n\n",25],["T_DOC_COMMENT","\/**\n * SalesRule Validator Model\n *\n * Allows dispatching before and after events for each controller action\n *\n * @category   Mage\n * @package    Mage_SalesRule\n * @author     Magento Core Team <core@magentocommerce.com>\n *\/",28],["T_WHITESPACE","\n",36],["T_CLASS","class",37],["T_WHITESPACE"," ",37],["T_STRING","Mage_SalesRule_Model_Validator",37],["T_WHITESPACE"," ",37],["T_EXTENDS","extends",37],["T_WHITESPACE"," ",37],["T_STRING","Mage_Core_Model_Abstract",37],["T_WHITESPACE","\n",37],"{",["T_WHITESPACE","\n    ",38],["T_DOC_COMMENT","\/**\n     * Rule source collection\n     *\n     * @var Mage_SalesRule_Model_Mysql4_Rule_Collection\n     *\/",39],["T_WHITESPACE","\n    ",43],["T_PROTECTED","protected",44],["T_WHITESPACE"," ",44],["T_VARIABLE","$_rules",44],";",["T_WHITESPACE","\n\n    ",44],["T_DOC_COMMENT","\/**\n     * Rounding deltas\n     *\n     * @var array\n     *\/",46],["T_WHITESPACE","\n    ",50],["T_PROTECTED","protected",51],["T_WHITESPACE"," ",51],["T_VARIABLE","$_roundingDeltas",51],["T_WHITESPACE"," ",51],"=",["T_WHITESPACE"," ",51],["T_ARRAY","array",51],"(",")",";",["T_WHITESPACE","\n\n    ",51],["T_DOC_COMMENT","\/**\n     * Base rounding deltas\n     *\n     * @var array\n     *\/",53],["T_WHITESPACE","\n    ",57],["T_PROTECTED","protected",58],["T_WHITESPACE"," ",58],["T_VARIABLE","$_baseRoundingDeltas",58],["T_WHITESPACE"," ",58],"=",["T_WHITESPACE"," ",58],["T_ARRAY","array",58],"(",")",";",["T_WHITESPACE","\n\n    ",58],["T_DOC_COMMENT","\/**\n     * Quote address\n     *\n     * @var null|Mage_Sales_Model_Quote_Address\n     *\/",60],["T_WHITESPACE","\n    ",64],["T_PROTECTED","protected",65],["T_WHITESPACE"," ",65],["T_VARIABLE","$_address",65],["T_WHITESPACE"," ",65],"=",["T_WHITESPACE"," ",65],["T_STRING","null",65],";",["T_WHITESPACE","\n\n    ",65],["T_DOC_COMMENT","\/**\n     * Defines if method Mage_SalesRule_Model_Validator::process() was already called\n     * Used for clearing applied rule ids in Quote and in Address\n     *\n     * @deprecated since 1.4.2.0\n     * @var bool\n     *\/",67],["T_WHITESPACE","\n    ",73],["T_PROTECTED","protected",74],["T_WHITESPACE"," ",74],["T_VARIABLE","$_isFirstTimeProcessRun",74],["T_WHITESPACE"," ",74],"=",["T_WHITESPACE"," ",74],["T_STRING","false",74],";",["T_WHITESPACE","\n\n    ",74],["T_DOC_COMMENT","\/**\n     * Defines if method Mage_SalesRule_Model_Validator::reset() wasn't called\n     * Used for clearing applied rule ids in Quote and in Address\n     *\n     * @var bool\n     *\/",76],["T_WHITESPACE","\n    ",81],["T_PROTECTED","protected",82],["T_WHITESPACE"," ",82],["T_VARIABLE","$_isFirstTimeResetRun",82],["T_WHITESPACE"," ",82],"=",["T_WHITESPACE"," ",82],["T_STRING","true",82],";",["T_WHITESPACE","\n\n    ",82],["T_DOC_COMMENT","\/**\n     * Information about item totals for rules.\n     * @var array\n     *\/",84],["T_WHITESPACE","\n    ",87],["T_PROTECTED","protected",88],["T_WHITESPACE"," ",88],["T_VARIABLE","$_rulesItemTotals",88],["T_WHITESPACE"," ",88],"=",["T_WHITESPACE"," ",88],["T_ARRAY","array",88],"(",")",";",["T_WHITESPACE","\n\n    ",88],["T_DOC_COMMENT","\/**\n     * Store information about addresses which cart fixed rule applied for\n     *\n     * @var array\n     *\/",90],["T_WHITESPACE","\n    ",94],["T_PROTECTED","protected",95],["T_WHITESPACE"," ",95],["T_VARIABLE","$_cartFixedRuleUsedForAddress",95],["T_WHITESPACE"," ",95],"=",["T_WHITESPACE"," ",95],["T_ARRAY","array",95],"(",")",";",["T_WHITESPACE","\n\n    ",95],["T_DOC_COMMENT","\/**\n     * Defines if rule with stop further rules is already applied\n     *\n     * @var bool\n     *\/",97],["T_WHITESPACE","\n    ",101],["T_PROTECTED","protected",102],["T_WHITESPACE"," ",102],["T_VARIABLE","$_stopFurtherRules",102],["T_WHITESPACE"," ",102],"=",["T_WHITESPACE"," ",102],["T_STRING","false",102],";",["T_WHITESPACE","\n\n    ",102],["T_DOC_COMMENT","\/**\n     * Init validator\n     * Init process load collection of rules for specific website,\n     * customer group and coupon code\n     *\n     * @param   int $websiteId\n     * @param   int $customerGroupId\n     * @param   string $couponCode\n     * @return  Mage_SalesRule_Model_Validator\n     *\/",104],["T_WHITESPACE","\n    ",113],["T_PUBLIC","public",114],["T_WHITESPACE"," ",114],["T_FUNCTION","function",114],["T_WHITESPACE"," ",114],["T_STRING","init",114],"(",["T_VARIABLE","$websiteId",114],",",["T_WHITESPACE"," ",114],["T_VARIABLE","$customerGroupId",114],",",["T_WHITESPACE"," ",114],["T_VARIABLE","$couponCode",114],")",["T_WHITESPACE","\n    ",114],"{",["T_WHITESPACE","\n        ",115],["T_VARIABLE","$this",116],["T_OBJECT_OPERATOR","->",116],["T_STRING","setWebsiteId",116],"(",["T_VARIABLE","$websiteId",116],")",["T_WHITESPACE","\n            ",116],["T_OBJECT_OPERATOR","->",117],["T_STRING","setCustomerGroupId",117],"(",["T_VARIABLE","$customerGroupId",117],")",["T_WHITESPACE","\n            ",117],["T_OBJECT_OPERATOR","->",118],["T_STRING","setCouponCode",118],"(",["T_VARIABLE","$couponCode",118],")",";",["T_WHITESPACE","\n\n        ",118],["T_VARIABLE","$key",120],["T_WHITESPACE"," ",120],"=",["T_WHITESPACE"," ",120],["T_VARIABLE","$websiteId",120],["T_WHITESPACE"," ",120],".",["T_WHITESPACE"," ",120],["T_CONSTANT_ENCAPSED_STRING","'_'",120],["T_WHITESPACE"," ",120],".",["T_WHITESPACE"," ",120],["T_VARIABLE","$customerGroupId",120],["T_WHITESPACE"," ",120],".",["T_WHITESPACE"," ",120],["T_CONSTANT_ENCAPSED_STRING","'_'",120],["T_WHITESPACE"," ",120],".",["T_WHITESPACE"," ",120],["T_VARIABLE","$couponCode",120],";",["T_WHITESPACE","\n        ",120],["T_IF","if",121],["T_WHITESPACE"," ",121],"(","!",["T_ISSET","isset",121],"(",["T_VARIABLE","$this",121],["T_OBJECT_OPERATOR","->",121],["T_STRING","_rules",121],"[",["T_VARIABLE","$key",121],"]",")",")",["T_WHITESPACE"," ",121],"{",["T_WHITESPACE","\n            ",121],["T_VARIABLE","$this",122],["T_OBJECT_OPERATOR","->",122],["T_STRING","_rules",122],"[",["T_VARIABLE","$key",122],"]",["T_WHITESPACE"," ",122],"=",["T_WHITESPACE"," ",122],["T_STRING","Mage",122],["T_DOUBLE_COLON","::",122],["T_STRING","getResourceModel",122],"(",["T_CONSTANT_ENCAPSED_STRING","'salesrule\/rule_collection'",122],")",["T_WHITESPACE","\n                ",122],["T_OBJECT_OPERATOR","->",123],["T_STRING","setValidationFilter",123],"(",["T_VARIABLE","$websiteId",123],",",["T_WHITESPACE"," ",123],["T_VARIABLE","$customerGroupId",123],",",["T_WHITESPACE"," ",123],["T_VARIABLE","$couponCode",123],")",["T_WHITESPACE","\n                ",123],["T_OBJECT_OPERATOR","->",124],["T_STRING","load",124],"(",")",";",["T_WHITESPACE","\n        ",124],"}",["T_WHITESPACE","\n        ",125],["T_RETURN","return",126],["T_WHITESPACE"," ",126],["T_VARIABLE","$this",126],";",["T_WHITESPACE","\n    ",126],"}",["T_WHITESPACE","\n\n    ",127],["T_DOC_COMMENT","\/**\n     * Get rules collection for current object state\n     *\n     * @return Mage_SalesRule_Model_Mysql4_Rule_Collection\n     *\/",129],["T_WHITESPACE","\n    ",133],["T_PROTECTED","protected",134],["T_WHITESPACE"," ",134],["T_FUNCTION","function",134],["T_WHITESPACE"," ",134],["T_STRING","_getRules",134],"(",")",["T_WHITESPACE","\n    ",134],"{",["T_WHITESPACE","\n        ",135],["T_VARIABLE","$key",136],["T_WHITESPACE"," ",136],"=",["T_WHITESPACE"," ",136],["T_VARIABLE","$this",136],["T_OBJECT_OPERATOR","->",136],["T_STRING","getWebsiteId",136],"(",")",["T_WHITESPACE"," ",136],".",["T_WHITESPACE"," ",136],["T_CONSTANT_ENCAPSED_STRING","'_'",136],["T_WHITESPACE"," ",136],".",["T_WHITESPACE"," ",136],["T_VARIABLE","$this",136],["T_OBJECT_OPERATOR","->",136],["T_STRING","getCustomerGroupId",136],"(",")",["T_WHITESPACE"," ",136],".",["T_WHITESPACE"," ",136],["T_CONSTANT_ENCAPSED_STRING","'_'",136],["T_WHITESPACE"," ",136],".",["T_WHITESPACE"," ",136],["T_VARIABLE","$this",136],["T_OBJECT_OPERATOR","->",136],["T_STRING","getCouponCode",136],"(",")",";",["T_WHITESPACE","\n        ",136],["T_RETURN","return",137],["T_WHITESPACE"," ",137],["T_VARIABLE","$this",137],["T_OBJECT_OPERATOR","->",137],["T_STRING","_rules",137],"[",["T_VARIABLE","$key",137],"]",";",["T_WHITESPACE","\n    ",137],"}",["T_WHITESPACE","\n\n    ",138],["T_DOC_COMMENT","\/**\n     * Get address object which can be used for discount calculation\n     *\n     * @param   Mage_Sales_Model_Quote_Item_Abstract $item\n     * @return  Mage_Sales_Model_Quote_Address\n     *\/",140],["T_WHITESPACE","\n    ",145],["T_PROTECTED","protected",146],["T_WHITESPACE"," ",146],["T_FUNCTION","function",146],["T_WHITESPACE"," ",146],["T_STRING","_getAddress",146],"(",["T_STRING","Mage_Sales_Model_Quote_Item_Abstract",146],["T_WHITESPACE"," ",146],["T_VARIABLE","$item",146],")",["T_WHITESPACE","\n    ",146],"{",["T_WHITESPACE","\n        ",147],["T_IF","if",148],["T_WHITESPACE"," ",148],"(",["T_VARIABLE","$item",148],["T_WHITESPACE"," ",148],["T_INSTANCEOF","instanceof",148],["T_WHITESPACE"," ",148],["T_STRING","Mage_Sales_Model_Quote_Address_Item",148],")",["T_WHITESPACE"," ",148],"{",["T_WHITESPACE","\n            ",148],["T_VARIABLE","$address",149],["T_WHITESPACE"," ",149],"=",["T_WHITESPACE"," ",149],["T_VARIABLE","$item",149],["T_OBJECT_OPERATOR","->",149],["T_STRING","getAddress",149],"(",")",";",["T_WHITESPACE","\n        ",149],"}",["T_WHITESPACE"," ",150],["T_ELSEIF","elseif",150],["T_WHITESPACE"," ",150],"(",["T_VARIABLE","$this",150],["T_OBJECT_OPERATOR","->",150],["T_STRING","_address",150],")",["T_WHITESPACE"," ",150],"{",["T_WHITESPACE","\n            ",150],["T_VARIABLE","$address",151],["T_WHITESPACE"," ",151],"=",["T_WHITESPACE"," ",151],["T_VARIABLE","$this",151],["T_OBJECT_OPERATOR","->",151],["T_STRING","_address",151],";",["T_WHITESPACE","\n        ",151],"}",["T_WHITESPACE"," ",152],["T_ELSEIF","elseif",152],["T_WHITESPACE"," ",152],"(",["T_VARIABLE","$item",152],["T_OBJECT_OPERATOR","->",152],["T_STRING","getQuote",152],"(",")",["T_OBJECT_OPERATOR","->",152],["T_STRING","getItemVirtualQty",152],"(",")",["T_WHITESPACE"," ",152],">",["T_WHITESPACE"," ",152],["T_LNUMBER","0",152],")",["T_WHITESPACE"," ",152],"{",["T_WHITESPACE","\n            ",152],["T_VARIABLE","$address",153],["T_WHITESPACE"," ",153],"=",["T_WHITESPACE"," ",153],["T_VARIABLE","$item",153],["T_OBJECT_OPERATOR","->",153],["T_STRING","getQuote",153],"(",")",["T_OBJECT_OPERATOR","->",153],["T_STRING","getBillingAddress",153],"(",")",";",["T_WHITESPACE","\n        ",153],"}",["T_WHITESPACE"," ",154],["T_ELSE","else",154],["T_WHITESPACE"," ",154],"{",["T_WHITESPACE","\n            ",154],["T_VARIABLE","$address",155],["T_WHITESPACE"," ",155],"=",["T_WHITESPACE"," ",155],["T_VARIABLE","$item",155],["T_OBJECT_OPERATOR","->",155],["T_STRING","getQuote",155],"(",")",["T_OBJECT_OPERATOR","->",155],["T_STRING","getShippingAddress",155],"(",")",";",["T_WHITESPACE","\n        ",155],"}",["T_WHITESPACE","\n        ",156],["T_RETURN","return",157],["T_WHITESPACE"," ",157],["T_VARIABLE","$address",157],";",["T_WHITESPACE","\n    ",157],"}",["T_WHITESPACE","\n\n    ",158],["T_DOC_COMMENT","\/**\n     * Check if rule can be applied for specific address\/quote\/customer\n     *\n     * @param   Mage_SalesRule_Model_Rule $rule\n     * @param   Mage_Sales_Model_Quote_Address $address\n     * @return  bool\n     *\/",160],["T_WHITESPACE","\n    ",166],["T_PROTECTED","protected",167],["T_WHITESPACE"," ",167],["T_FUNCTION","function",167],["T_WHITESPACE"," ",167],["T_STRING","_canProcessRule",167],"(",["T_VARIABLE","$rule",167],",",["T_WHITESPACE"," ",167],["T_VARIABLE","$address",167],")",["T_WHITESPACE","\n    ",167],"{",["T_WHITESPACE","\n        ",168],["T_IF","if",169],["T_WHITESPACE"," ",169],"(",["T_VARIABLE","$rule",169],["T_OBJECT_OPERATOR","->",169],["T_STRING","hasIsValidForAddress",169],"(",["T_VARIABLE","$address",169],")",["T_WHITESPACE"," ",169],["T_BOOLEAN_AND","&&",169],["T_WHITESPACE"," ",169],"!",["T_VARIABLE","$address",169],["T_OBJECT_OPERATOR","->",169],["T_STRING","isObjectNew",169],"(",")",")",["T_WHITESPACE"," ",169],"{",["T_WHITESPACE","\n            ",169],["T_RETURN","return",170],["T_WHITESPACE"," ",170],["T_VARIABLE","$rule",170],["T_OBJECT_OPERATOR","->",170],["T_STRING","getIsValidForAddress",170],"(",["T_VARIABLE","$address",170],")",";",["T_WHITESPACE","\n        ",170],"}",["T_WHITESPACE","\n\n        ",171],["T_DOC_COMMENT","\/**\n         * check per coupon usage limit\n         *\/",173],["T_WHITESPACE","\n        ",175],["T_IF","if",176],["T_WHITESPACE"," ",176],"(",["T_VARIABLE","$rule",176],["T_OBJECT_OPERATOR","->",176],["T_STRING","getCouponType",176],"(",")",["T_WHITESPACE"," ",176],["T_IS_NOT_EQUAL","!=",176],["T_WHITESPACE"," ",176],["T_STRING","Mage_SalesRule_Model_Rule",176],["T_DOUBLE_COLON","::",176],["T_STRING","COUPON_TYPE_NO_COUPON",176],")",["T_WHITESPACE"," ",176],"{",["T_WHITESPACE","\n            ",176],["T_VARIABLE","$couponCode",177],["T_WHITESPACE"," ",177],"=",["T_WHITESPACE"," ",177],["T_VARIABLE","$address",177],["T_OBJECT_OPERATOR","->",177],["T_STRING","getQuote",177],"(",")",["T_OBJECT_OPERATOR","->",177],["T_STRING","getCouponCode",177],"(",")",";",["T_WHITESPACE","\n            ",177],["T_IF","if",178],["T_WHITESPACE"," ",178],"(",["T_STRING","strlen",178],"(",["T_VARIABLE","$couponCode",178],")",")",["T_WHITESPACE"," ",178],"{",["T_WHITESPACE","\n                ",178],["T_VARIABLE","$coupon",179],["T_WHITESPACE"," ",179],"=",["T_WHITESPACE"," ",179],["T_STRING","Mage",179],["T_DOUBLE_COLON","::",179],["T_STRING","getModel",179],"(",["T_CONSTANT_ENCAPSED_STRING","'salesrule\/coupon'",179],")",";",["T_WHITESPACE","\n                ",179],["T_VARIABLE","$coupon",180],["T_OBJECT_OPERATOR","->",180],["T_STRING","load",180],"(",["T_VARIABLE","$couponCode",180],",",["T_WHITESPACE"," ",180],["T_CONSTANT_ENCAPSED_STRING","'code'",180],")",";",["T_WHITESPACE","\n                ",180],["T_IF","if",181],["T_WHITESPACE"," ",181],"(",["T_VARIABLE","$coupon",181],["T_OBJECT_OPERATOR","->",181],["T_STRING","getId",181],"(",")",")",["T_WHITESPACE"," ",181],"{",["T_WHITESPACE","\n                    ",181],["T_COMMENT","\/\/ check entire usage limit\n",182],["T_WHITESPACE","                    ",183],["T_IF","if",183],["T_WHITESPACE"," ",183],"(",["T_VARIABLE","$coupon",183],["T_OBJECT_OPERATOR","->",183],["T_STRING","getUsageLimit",183],"(",")",["T_WHITESPACE"," ",183],["T_BOOLEAN_AND","&&",183],["T_WHITESPACE"," ",183],["T_VARIABLE","$coupon",183],["T_OBJECT_OPERATOR","->",183],["T_STRING","getTimesUsed",183],"(",")",["T_WHITESPACE"," ",183],["T_IS_GREATER_OR_EQUAL",">=",183],["T_WHITESPACE"," ",183],["T_VARIABLE","$coupon",183],["T_OBJECT_OPERATOR","->",183],["T_STRING","getUsageLimit",183],"(",")",")",["T_WHITESPACE"," ",183],"{",["T_WHITESPACE","\n                        ",183],["T_VARIABLE","$rule",184],["T_OBJECT_OPERATOR","->",184],["T_STRING","setIsValidForAddress",184],"(",["T_VARIABLE","$address",184],",",["T_WHITESPACE"," ",184],["T_STRING","false",184],")",";",["T_WHITESPACE","\n                        ",184],["T_RETURN","return",185],["T_WHITESPACE"," ",185],["T_STRING","false",185],";",["T_WHITESPACE","\n                    ",185],"}",["T_WHITESPACE","\n                    ",186],["T_COMMENT","\/\/ check per customer usage limit\n",187],["T_WHITESPACE","                    ",188],["T_VARIABLE","$customerId",188],["T_WHITESPACE"," ",188],"=",["T_WHITESPACE"," ",188],["T_VARIABLE","$address",188],["T_OBJECT_OPERATOR","->",188],["T_STRING","getQuote",188],"(",")",["T_OBJECT_OPERATOR","->",188],["T_STRING","getCustomerId",188],"(",")",";",["T_WHITESPACE","\n                    ",188],["T_IF","if",189],["T_WHITESPACE"," ",189],"(",["T_VARIABLE","$customerId",189],["T_WHITESPACE"," ",189],["T_BOOLEAN_AND","&&",189],["T_WHITESPACE"," ",189],["T_VARIABLE","$coupon",189],["T_OBJECT_OPERATOR","->",189],["T_STRING","getUsagePerCustomer",189],"(",")",")",["T_WHITESPACE"," ",189],"{",["T_WHITESPACE","\n                        ",189],["T_VARIABLE","$couponUsage",190],["T_WHITESPACE"," ",190],"=",["T_WHITESPACE"," ",190],["T_NEW","new",190],["T_WHITESPACE"," ",190],["T_STRING","Varien_Object",190],"(",")",";",["T_WHITESPACE","\n                        ",190],["T_STRING","Mage",191],["T_DOUBLE_COLON","::",191],["T_STRING","getResourceModel",191],"(",["T_CONSTANT_ENCAPSED_STRING","'salesrule\/coupon_usage'",191],")",["T_OBJECT_OPERATOR","->",191],["T_STRING","loadByCustomerCoupon",191],"(",["T_WHITESPACE","\n                            ",191],["T_VARIABLE","$couponUsage",192],",",["T_WHITESPACE"," ",192],["T_VARIABLE","$customerId",192],",",["T_WHITESPACE"," ",192],["T_VARIABLE","$coupon",192],["T_OBJECT_OPERATOR","->",192],["T_STRING","getId",192],"(",")",")",";",["T_WHITESPACE","\n                        ",192],["T_IF","if",193],["T_WHITESPACE"," ",193],"(",["T_VARIABLE","$couponUsage",193],["T_OBJECT_OPERATOR","->",193],["T_STRING","getCouponId",193],"(",")",["T_WHITESPACE"," ",193],["T_BOOLEAN_AND","&&",193],["T_WHITESPACE","\n                            ",193],["T_VARIABLE","$couponUsage",194],["T_OBJECT_OPERATOR","->",194],["T_STRING","getTimesUsed",194],"(",")",["T_WHITESPACE"," ",194],["T_IS_GREATER_OR_EQUAL",">=",194],["T_WHITESPACE"," ",194],["T_VARIABLE","$coupon",194],["T_OBJECT_OPERATOR","->",194],["T_STRING","getUsagePerCustomer",194],"(",")",["T_WHITESPACE","\n                        ",194],")",["T_WHITESPACE"," ",195],"{",["T_WHITESPACE","\n                            ",195],["T_VARIABLE","$rule",196],["T_OBJECT_OPERATOR","->",196],["T_STRING","setIsValidForAddress",196],"(",["T_VARIABLE","$address",196],",",["T_WHITESPACE"," ",196],["T_STRING","false",196],")",";",["T_WHITESPACE","\n                            ",196],["T_RETURN","return",197],["T_WHITESPACE"," ",197],["T_STRING","false",197],";",["T_WHITESPACE","\n                        ",197],"}",["T_WHITESPACE","\n                    ",198],"}",["T_WHITESPACE","\n                ",199],"}",["T_WHITESPACE","\n            ",200],"}",["T_WHITESPACE","\n        ",201],"}",["T_WHITESPACE","\n\n        ",202],["T_DOC_COMMENT","\/**\n         * check per rule usage limit\n         *\/",204],["T_WHITESPACE","\n        ",206],["T_VARIABLE","$ruleId",207],["T_WHITESPACE"," ",207],"=",["T_WHITESPACE"," ",207],["T_VARIABLE","$rule",207],["T_OBJECT_OPERATOR","->",207],["T_STRING","getId",207],"(",")",";",["T_WHITESPACE","\n        ",207],["T_IF","if",208],["T_WHITESPACE"," ",208],"(",["T_VARIABLE","$ruleId",208],["T_WHITESPACE"," ",208],["T_BOOLEAN_AND","&&",208],["T_WHITESPACE"," ",208],["T_VARIABLE","$rule",208],["T_OBJECT_OPERATOR","->",208],["T_STRING","getUsesPerCustomer",208],"(",")",")",["T_WHITESPACE"," ",208],"{",["T_WHITESPACE","\n            ",208],["T_VARIABLE","$customerId",209],["T_WHITESPACE","     ",209],"=",["T_WHITESPACE"," ",209],["T_VARIABLE","$address",209],["T_OBJECT_OPERATOR","->",209],["T_STRING","getQuote",209],"(",")",["T_OBJECT_OPERATOR","->",209],["T_STRING","getCustomerId",209],"(",")",";",["T_WHITESPACE","\n            ",209],["T_VARIABLE","$ruleCustomer",210],["T_WHITESPACE","   ",210],"=",["T_WHITESPACE"," ",210],["T_STRING","Mage",210],["T_DOUBLE_COLON","::",210],["T_STRING","getModel",210],"(",["T_CONSTANT_ENCAPSED_STRING","'salesrule\/rule_customer'",210],")",";",["T_WHITESPACE","\n            ",210],["T_VARIABLE","$ruleCustomer",211],["T_OBJECT_OPERATOR","->",211],["T_STRING","loadByCustomerRule",211],"(",["T_VARIABLE","$customerId",211],",",["T_WHITESPACE"," ",211],["T_VARIABLE","$ruleId",211],")",";",["T_WHITESPACE","\n            ",211],["T_IF","if",212],["T_WHITESPACE"," ",212],"(",["T_VARIABLE","$ruleCustomer",212],["T_OBJECT_OPERATOR","->",212],["T_STRING","getId",212],"(",")",")",["T_WHITESPACE"," ",212],"{",["T_WHITESPACE","\n                ",212],["T_IF","if",213],["T_WHITESPACE"," ",213],"(",["T_VARIABLE","$ruleCustomer",213],["T_OBJECT_OPERATOR","->",213],["T_STRING","getTimesUsed",213],"(",")",["T_WHITESPACE"," ",213],["T_IS_GREATER_OR_EQUAL",">=",213],["T_WHITESPACE"," ",213],["T_VARIABLE","$rule",213],["T_OBJECT_OPERATOR","->",213],["T_STRING","getUsesPerCustomer",213],"(",")",")",["T_WHITESPACE"," ",213],"{",["T_WHITESPACE","\n                    ",213],["T_VARIABLE","$rule",214],["T_OBJECT_OPERATOR","->",214],["T_STRING","setIsValidForAddress",214],"(",["T_VARIABLE","$address",214],",",["T_WHITESPACE"," ",214],["T_STRING","false",214],")",";",["T_WHITESPACE","\n                    ",214],["T_RETURN","return",215],["T_WHITESPACE"," ",215],["T_STRING","false",215],";",["T_WHITESPACE","\n                ",215],"}",["T_WHITESPACE","\n            ",216],"}",["T_WHITESPACE","\n        ",217],"}",["T_WHITESPACE","\n        ",218],["T_VARIABLE","$rule",219],["T_OBJECT_OPERATOR","->",219],["T_STRING","afterLoad",219],"(",")",";",["T_WHITESPACE","\n        ",219],["T_DOC_COMMENT","\/**\n         * quote does not meet rule's conditions\n         *\/",220],["T_WHITESPACE","\n        ",222],["T_IF","if",223],["T_WHITESPACE"," ",223],"(","!",["T_VARIABLE","$rule",223],["T_OBJECT_OPERATOR","->",223],["T_STRING","validate",223],"(",["T_VARIABLE","$address",223],")",")",["T_WHITESPACE"," ",223],"{",["T_WHITESPACE","\n            ",223],["T_VARIABLE","$rule",224],["T_OBJECT_OPERATOR","->",224],["T_STRING","setIsValidForAddress",224],"(",["T_VARIABLE","$address",224],",",["T_WHITESPACE"," ",224],["T_STRING","false",224],")",";",["T_WHITESPACE","\n            ",224],["T_RETURN","return",225],["T_WHITESPACE"," ",225],["T_STRING","false",225],";",["T_WHITESPACE","\n        ",225],"}",["T_WHITESPACE","\n        ",226],["T_DOC_COMMENT","\/**\n         * passed all validations, remember to be valid\n         *\/",227],["T_WHITESPACE","\n        ",229],["T_VARIABLE","$rule",230],["T_OBJECT_OPERATOR","->",230],["T_STRING","setIsValidForAddress",230],"(",["T_VARIABLE","$address",230],",",["T_WHITESPACE"," ",230],["T_STRING","true",230],")",";",["T_WHITESPACE","\n        ",230],["T_RETURN","return",231],["T_WHITESPACE"," ",231],["T_STRING","true",231],";",["T_WHITESPACE","\n    ",231],"}",["T_WHITESPACE","\n\n    ",232],["T_DOC_COMMENT","\/**\n     * Quote item free shipping ability check\n     * This process not affect information about applied rules, coupon code etc.\n     * This information will be added during discount amounts processing\n     *\n     * @param   Mage_Sales_Model_Quote_Item_Abstract $item\n     * @return  Mage_SalesRule_Model_Validator\n     *\/",234],["T_WHITESPACE","\n    ",241],["T_PUBLIC","public",242],["T_WHITESPACE"," ",242],["T_FUNCTION","function",242],["T_WHITESPACE"," ",242],["T_STRING","processFreeShipping",242],"(",["T_STRING","Mage_Sales_Model_Quote_Item_Abstract",242],["T_WHITESPACE"," ",242],["T_VARIABLE","$item",242],")",["T_WHITESPACE","\n    ",242],"{",["T_WHITESPACE","\n        ",243],["T_VARIABLE","$address",244],["T_WHITESPACE"," ",244],"=",["T_WHITESPACE"," ",244],["T_VARIABLE","$this",244],["T_OBJECT_OPERATOR","->",244],["T_STRING","_getAddress",244],"(",["T_VARIABLE","$item",244],")",";",["T_WHITESPACE","\n        ",244],["T_VARIABLE","$item",245],["T_OBJECT_OPERATOR","->",245],["T_STRING","setFreeShipping",245],"(",["T_STRING","false",245],")",";",["T_WHITESPACE","\n\n        ",245],["T_FOREACH","foreach",247],["T_WHITESPACE"," ",247],"(",["T_VARIABLE","$this",247],["T_OBJECT_OPERATOR","->",247],["T_STRING","_getRules",247],"(",")",["T_WHITESPACE"," ",247],["T_AS","as",247],["T_WHITESPACE"," ",247],["T_VARIABLE","$rule",247],")",["T_WHITESPACE"," ",247],"{",["T_WHITESPACE","\n            ",247],["T_COMMENT","\/* @var $rule Mage_SalesRule_Model_Rule *\/",248],["T_WHITESPACE","\n            ",248],["T_IF","if",249],["T_WHITESPACE"," ",249],"(","!",["T_VARIABLE","$this",249],["T_OBJECT_OPERATOR","->",249],["T_STRING","_canProcessRule",249],"(",["T_VARIABLE","$rule",249],",",["T_WHITESPACE"," ",249],["T_VARIABLE","$address",249],")",")",["T_WHITESPACE"," ",249],"{",["T_WHITESPACE","\n                ",249],["T_CONTINUE","continue",250],";",["T_WHITESPACE","\n            ",250],"}",["T_WHITESPACE","\n\n            ",251],["T_IF","if",253],["T_WHITESPACE"," ",253],"(","!",["T_VARIABLE","$rule",253],["T_OBJECT_OPERATOR","->",253],["T_STRING","getActions",253],"(",")",["T_OBJECT_OPERATOR","->",253],["T_STRING","validate",253],"(",["T_VARIABLE","$item",253],")",")",["T_WHITESPACE"," ",253],"{",["T_WHITESPACE","\n                ",253],["T_CONTINUE","continue",254],";",["T_WHITESPACE","\n            ",254],"}",["T_WHITESPACE","\n\n            ",255],["T_SWITCH","switch",257],["T_WHITESPACE"," ",257],"(",["T_VARIABLE","$rule",257],["T_OBJECT_OPERATOR","->",257],["T_STRING","getSimpleFreeShipping",257],"(",")",")",["T_WHITESPACE"," ",257],"{",["T_WHITESPACE","\n                ",257],["T_CASE","case",258],["T_WHITESPACE"," ",258],["T_STRING","Mage_SalesRule_Model_Rule",258],["T_DOUBLE_COLON","::",258],["T_STRING","FREE_SHIPPING_ITEM",258],":",["T_WHITESPACE","\n                    ",258],["T_VARIABLE","$item",259],["T_OBJECT_OPERATOR","->",259],["T_STRING","setFreeShipping",259],"(",["T_VARIABLE","$rule",259],["T_OBJECT_OPERATOR","->",259],["T_STRING","getDiscountQty",259],"(",")",["T_WHITESPACE"," ",259],"?",["T_WHITESPACE"," ",259],["T_VARIABLE","$rule",259],["T_OBJECT_OPERATOR","->",259],["T_STRING","getDiscountQty",259],"(",")",["T_WHITESPACE"," ",259],":",["T_WHITESPACE"," ",259],["T_STRING","true",259],")",";",["T_WHITESPACE","\n                    ",259],["T_BREAK","break",260],";",["T_WHITESPACE","\n\n                ",260],["T_CASE","case",262],["T_WHITESPACE"," ",262],["T_STRING","Mage_SalesRule_Model_Rule",262],["T_DOUBLE_COLON","::",262],["T_STRING","FREE_SHIPPING_ADDRESS",262],":",["T_WHITESPACE","\n                    ",262],["T_VARIABLE","$address",263],["T_OBJECT_OPERATOR","->",263],["T_STRING","setFreeShipping",263],"(",["T_STRING","true",263],")",";",["T_WHITESPACE","\n                    ",263],["T_BREAK","break",264],";",["T_WHITESPACE","\n            ",264],"}",["T_WHITESPACE","\n            ",265],["T_IF","if",266],["T_WHITESPACE"," ",266],"(",["T_VARIABLE","$rule",266],["T_OBJECT_OPERATOR","->",266],["T_STRING","getStopRulesProcessing",266],"(",")",")",["T_WHITESPACE"," ",266],"{",["T_WHITESPACE","\n                ",266],["T_BREAK","break",267],";",["T_WHITESPACE","\n            ",267],"}",["T_WHITESPACE","\n        ",268],"}",["T_WHITESPACE","\n        ",269],["T_RETURN","return",270],["T_WHITESPACE"," ",270],["T_VARIABLE","$this",270],";",["T_WHITESPACE","\n    ",270],"}",["T_WHITESPACE","\n\n    ",271],["T_DOC_COMMENT","\/**\n     * Reset quote and address applied rules\n     *\n     * @param Mage_Sales_Model_Quote_Address $address\n     * @return Mage_SalesRule_Model_Validator\n     *\/",273],["T_WHITESPACE","\n    ",278],["T_PUBLIC","public",279],["T_WHITESPACE"," ",279],["T_FUNCTION","function",279],["T_WHITESPACE"," ",279],["T_STRING","reset",279],"(",["T_STRING","Mage_Sales_Model_Quote_Address",279],["T_WHITESPACE"," ",279],["T_VARIABLE","$address",279],")",["T_WHITESPACE","\n    ",279],"{",["T_WHITESPACE","\n        ",280],["T_IF","if",281],["T_WHITESPACE"," ",281],"(",["T_VARIABLE","$this",281],["T_OBJECT_OPERATOR","->",281],["T_STRING","_isFirstTimeResetRun",281],")",["T_WHITESPACE"," ",281],"{",["T_WHITESPACE","\n            ",281],["T_VARIABLE","$address",282],["T_OBJECT_OPERATOR","->",282],["T_STRING","setAppliedRuleIds",282],"(",["T_CONSTANT_ENCAPSED_STRING","''",282],")",";",["T_WHITESPACE","\n            ",282],["T_VARIABLE","$address",283],["T_OBJECT_OPERATOR","->",283],["T_STRING","getQuote",283],"(",")",["T_OBJECT_OPERATOR","->",283],["T_STRING","setAppliedRuleIds",283],"(",["T_CONSTANT_ENCAPSED_STRING","''",283],")",";",["T_WHITESPACE","\n            ",283],["T_VARIABLE","$this",284],["T_OBJECT_OPERATOR","->",284],["T_STRING","_isFirstTimeResetRun",284],["T_WHITESPACE"," ",284],"=",["T_WHITESPACE"," ",284],["T_STRING","false",284],";",["T_WHITESPACE","\n        ",284],"}",["T_WHITESPACE","\n        ",285],["T_VARIABLE","$this",286],["T_OBJECT_OPERATOR","->",286],["T_STRING","_address",286],["T_WHITESPACE"," ",286],"=",["T_WHITESPACE"," ",286],["T_VARIABLE","$address",286],";",["T_WHITESPACE","\n\n        ",286],["T_RETURN","return",288],["T_WHITESPACE"," ",288],["T_VARIABLE","$this",288],";",["T_WHITESPACE","\n    ",288],"}",["T_WHITESPACE","\n\n    ",289],["T_DOC_COMMENT","\/**\n     * Quote item discount calculation process\n     *\n     * @param   Mage_Sales_Model_Quote_Item_Abstract $item\n     * @return  Mage_SalesRule_Model_Validator\n     *\/",291],["T_WHITESPACE","\n    ",296],["T_PUBLIC","public",297],["T_WHITESPACE"," ",297],["T_FUNCTION","function",297],["T_WHITESPACE"," ",297],["T_STRING","process",297],"(",["T_STRING","Mage_Sales_Model_Quote_Item_Abstract",297],["T_WHITESPACE"," ",297],["T_VARIABLE","$item",297],")",["T_WHITESPACE","\n    ",297],"{",["T_WHITESPACE","\n        ",298],["T_VARIABLE","$item",299],["T_OBJECT_OPERATOR","->",299],["T_STRING","setDiscountAmount",299],"(",["T_LNUMBER","0",299],")",";",["T_WHITESPACE","\n        ",299],["T_VARIABLE","$item",300],["T_OBJECT_OPERATOR","->",300],["T_STRING","setBaseDiscountAmount",300],"(",["T_LNUMBER","0",300],")",";",["T_WHITESPACE","\n        ",300],["T_VARIABLE","$item",301],["T_OBJECT_OPERATOR","->",301],["T_STRING","setDiscountPercent",301],"(",["T_LNUMBER","0",301],")",";",["T_WHITESPACE","\n        ",301],["T_VARIABLE","$quote",302],["T_WHITESPACE","      ",302],"=",["T_WHITESPACE"," ",302],["T_VARIABLE","$item",302],["T_OBJECT_OPERATOR","->",302],["T_STRING","getQuote",302],"(",")",";",["T_WHITESPACE","\n        ",302],["T_VARIABLE","$address",303],["T_WHITESPACE","    ",303],"=",["T_WHITESPACE"," ",303],["T_VARIABLE","$this",303],["T_OBJECT_OPERATOR","->",303],["T_STRING","_getAddress",303],"(",["T_VARIABLE","$item",303],")",";",["T_WHITESPACE","\n\n        ",303],["T_VARIABLE","$itemPrice",305],["T_WHITESPACE","              ",305],"=",["T_WHITESPACE"," ",305],["T_VARIABLE","$this",305],["T_OBJECT_OPERATOR","->",305],["T_STRING","_getItemPrice",305],"(",["T_VARIABLE","$item",305],")",";",["T_WHITESPACE","\n        ",305],["T_VARIABLE","$baseItemPrice",306],["T_WHITESPACE","          ",306],"=",["T_WHITESPACE"," ",306],["T_VARIABLE","$this",306],["T_OBJECT_OPERATOR","->",306],["T_STRING","_getItemBasePrice",306],"(",["T_VARIABLE","$item",306],")",";",["T_WHITESPACE","\n        ",306],["T_VARIABLE","$itemOriginalPrice",307],["T_WHITESPACE","      ",307],"=",["T_WHITESPACE"," ",307],["T_VARIABLE","$this",307],["T_OBJECT_OPERATOR","->",307],["T_STRING","_getItemOriginalPrice",307],"(",["T_VARIABLE","$item",307],")",";",["T_WHITESPACE","\n        ",307],["T_VARIABLE","$baseItemOriginalPrice",308],["T_WHITESPACE","  ",308],"=",["T_WHITESPACE"," ",308],["T_VARIABLE","$this",308],["T_OBJECT_OPERATOR","->",308],["T_STRING","_getItemBaseOriginalPrice",308],"(",["T_VARIABLE","$item",308],")",";",["T_WHITESPACE","\n\n        ",308],["T_IF","if",310],["T_WHITESPACE"," ",310],"(",["T_VARIABLE","$itemPrice",310],["T_WHITESPACE"," ",310],"<",["T_WHITESPACE"," ",310],["T_LNUMBER","0",310],")",["T_WHITESPACE"," ",310],"{",["T_WHITESPACE","\n            ",310],["T_RETURN","return",311],["T_WHITESPACE"," ",311],["T_VARIABLE","$this",311],";",["T_WHITESPACE","\n        ",311],"}",["T_WHITESPACE","\n\n        ",312],["T_VARIABLE","$appliedRuleIds",314],["T_WHITESPACE"," ",314],"=",["T_WHITESPACE"," ",314],["T_ARRAY","array",314],"(",")",";",["T_WHITESPACE","\n        ",314],["T_VARIABLE","$this",315],["T_OBJECT_OPERATOR","->",315],["T_STRING","_stopFurtherRules",315],["T_WHITESPACE"," ",315],"=",["T_WHITESPACE"," ",315],["T_STRING","false",315],";",["T_WHITESPACE","\n        ",315],["T_FOREACH","foreach",316],["T_WHITESPACE"," ",316],"(",["T_VARIABLE","$this",316],["T_OBJECT_OPERATOR","->",316],["T_STRING","_getRules",316],"(",")",["T_WHITESPACE"," ",316],["T_AS","as",316],["T_WHITESPACE"," ",316],["T_VARIABLE","$rule",316],")",["T_WHITESPACE"," ",316],"{",["T_WHITESPACE","\n\n            ",316],["T_COMMENT","\/* @var $rule Mage_SalesRule_Model_Rule *\/",318],["T_WHITESPACE","\n            ",318],["T_IF","if",319],["T_WHITESPACE"," ",319],"(","!",["T_VARIABLE","$this",319],["T_OBJECT_OPERATOR","->",319],["T_STRING","_canProcessRule",319],"(",["T_VARIABLE","$rule",319],",",["T_WHITESPACE"," ",319],["T_VARIABLE","$address",319],")",")",["T_WHITESPACE"," ",319],"{",["T_WHITESPACE","\n                ",319],["T_CONTINUE","continue",320],";",["T_WHITESPACE","\n            ",320],"}",["T_WHITESPACE","\n\n            ",321],["T_IF","if",323],["T_WHITESPACE"," ",323],"(","!",["T_VARIABLE","$rule",323],["T_OBJECT_OPERATOR","->",323],["T_STRING","getActions",323],"(",")",["T_OBJECT_OPERATOR","->",323],["T_STRING","validate",323],"(",["T_VARIABLE","$item",323],")",")",["T_WHITESPACE"," ",323],"{",["T_WHITESPACE","\n                ",323],["T_CONTINUE","continue",324],";",["T_WHITESPACE","\n            ",324],"}",["T_WHITESPACE","\n\n            ",325],["T_VARIABLE","$qty",327],["T_WHITESPACE"," ",327],"=",["T_WHITESPACE"," ",327],["T_VARIABLE","$this",327],["T_OBJECT_OPERATOR","->",327],["T_STRING","_getItemQty",327],"(",["T_VARIABLE","$item",327],",",["T_WHITESPACE"," ",327],["T_VARIABLE","$rule",327],")",";",["T_WHITESPACE","\n            ",327],["T_VARIABLE","$rulePercent",328],["T_WHITESPACE"," ",328],"=",["T_WHITESPACE"," ",328],["T_STRING","min",328],"(",["T_LNUMBER","100",328],",",["T_WHITESPACE"," ",328],["T_VARIABLE","$rule",328],["T_OBJECT_OPERATOR","->",328],["T_STRING","getDiscountAmount",328],"(",")",")",";",["T_WHITESPACE","\n\n            ",328],["T_VARIABLE","$discountAmount",330],["T_WHITESPACE"," ",330],"=",["T_WHITESPACE"," ",330],["T_LNUMBER","0",330],";",["T_WHITESPACE","\n            ",330],["T_VARIABLE","$baseDiscountAmount",331],["T_WHITESPACE"," ",331],"=",["T_WHITESPACE"," ",331],["T_LNUMBER","0",331],";",["T_WHITESPACE","\n            ",331],["T_COMMENT","\/\/discount for original price\n",332],["T_WHITESPACE","            ",333],["T_VARIABLE","$originalDiscountAmount",333],["T_WHITESPACE"," ",333],"=",["T_WHITESPACE"," ",333],["T_LNUMBER","0",333],";",["T_WHITESPACE","\n            ",333],["T_VARIABLE","$baseOriginalDiscountAmount",334],["T_WHITESPACE"," ",334],"=",["T_WHITESPACE"," ",334],["T_LNUMBER","0",334],";",["T_WHITESPACE","\n\n            ",334],["T_SWITCH","switch",336],["T_WHITESPACE"," ",336],"(",["T_VARIABLE","$rule",336],["T_OBJECT_OPERATOR","->",336],["T_STRING","getSimpleAction",336],"(",")",")",["T_WHITESPACE"," ",336],"{",["T_WHITESPACE","\n                ",336],["T_CASE","case",337],["T_WHITESPACE"," ",337],["T_STRING","Mage_SalesRule_Model_Rule",337],["T_DOUBLE_COLON","::",337],["T_STRING","TO_PERCENT_ACTION",337],":",["T_WHITESPACE","\n                    ",337],["T_VARIABLE","$rulePercent",338],["T_WHITESPACE"," ",338],"=",["T_WHITESPACE"," ",338],["T_STRING","max",338],"(",["T_LNUMBER","0",338],",",["T_WHITESPACE"," ",338],["T_LNUMBER","100",338],"-",["T_VARIABLE","$rule",338],["T_OBJECT_OPERATOR","->",338],["T_STRING","getDiscountAmount",338],"(",")",")",";",["T_WHITESPACE","\n                ",338],["T_COMMENT","\/\/no break;\n",339],["T_WHITESPACE","                ",340],["T_CASE","case",340],["T_WHITESPACE"," ",340],["T_STRING","Mage_SalesRule_Model_Rule",340],["T_DOUBLE_COLON","::",340],["T_STRING","BY_PERCENT_ACTION",340],":",["T_WHITESPACE","\n                    ",340],["T_VARIABLE","$step",341],["T_WHITESPACE"," ",341],"=",["T_WHITESPACE"," ",341],["T_VARIABLE","$rule",341],["T_OBJECT_OPERATOR","->",341],["T_STRING","getDiscountStep",341],"(",")",";",["T_WHITESPACE","\n                    ",341],["T_IF","if",342],["T_WHITESPACE"," ",342],"(",["T_VARIABLE","$step",342],")",["T_WHITESPACE"," ",342],"{",["T_WHITESPACE","\n                        ",342],["T_VARIABLE","$qty",343],["T_WHITESPACE"," ",343],"=",["T_WHITESPACE"," ",343],["T_STRING","floor",343],"(",["T_VARIABLE","$qty",343],"\/",["T_VARIABLE","$step",343],")","*",["T_VARIABLE","$step",343],";",["T_WHITESPACE","\n                    ",343],"}",["T_WHITESPACE","\n                    ",344],["T_VARIABLE","$_rulePct",345],["T_WHITESPACE"," ",345],"=",["T_WHITESPACE"," ",345],["T_VARIABLE","$rulePercent",345],"\/",["T_LNUMBER","100",345],";",["T_WHITESPACE","\n                    ",345],["T_VARIABLE","$discountAmount",346],["T_WHITESPACE","    ",346],"=",["T_WHITESPACE"," ",346],"(",["T_VARIABLE","$qty",346],["T_WHITESPACE"," ",346],"*",["T_WHITESPACE"," ",346],["T_VARIABLE","$itemPrice",346],["T_WHITESPACE"," ",346],"-",["T_WHITESPACE"," ",346],["T_VARIABLE","$item",346],["T_OBJECT_OPERATOR","->",346],["T_STRING","getDiscountAmount",346],"(",")",")",["T_WHITESPACE"," ",346],"*",["T_WHITESPACE"," ",346],["T_VARIABLE","$_rulePct",346],";",["T_WHITESPACE","\n                    ",346],["T_VARIABLE","$baseDiscountAmount",347],["T_WHITESPACE"," ",347],"=",["T_WHITESPACE"," ",347],"(",["T_VARIABLE","$qty",347],["T_WHITESPACE"," ",347],"*",["T_WHITESPACE"," ",347],["T_VARIABLE","$baseItemPrice",347],["T_WHITESPACE"," ",347],"-",["T_WHITESPACE"," ",347],["T_VARIABLE","$item",347],["T_OBJECT_OPERATOR","->",347],["T_STRING","getBaseDiscountAmount",347],"(",")",")",["T_WHITESPACE"," ",347],"*",["T_WHITESPACE"," ",347],["T_VARIABLE","$_rulePct",347],";",["T_WHITESPACE","\n                    ",347],["T_COMMENT","\/\/get discount for original price\n",348],["T_WHITESPACE","                    ",349],["T_VARIABLE","$originalDiscountAmount",349],["T_WHITESPACE","    ",349],"=",["T_WHITESPACE"," ",349],"(",["T_VARIABLE","$qty",349],["T_WHITESPACE"," ",349],"*",["T_WHITESPACE"," ",349],["T_VARIABLE","$itemOriginalPrice",349],["T_WHITESPACE"," ",349],"-",["T_WHITESPACE"," ",349],["T_VARIABLE","$item",349],["T_OBJECT_OPERATOR","->",349],["T_STRING","getDiscountAmount",349],"(",")",")",["T_WHITESPACE"," ",349],"*",["T_WHITESPACE"," ",349],["T_VARIABLE","$_rulePct",349],";",["T_WHITESPACE","\n                    ",349],["T_VARIABLE","$baseOriginalDiscountAmount",350],["T_WHITESPACE"," ",350],"=",["T_WHITESPACE","\n                        ",350],"(",["T_VARIABLE","$qty",351],["T_WHITESPACE"," ",351],"*",["T_WHITESPACE"," ",351],["T_VARIABLE","$baseItemOriginalPrice",351],["T_WHITESPACE"," ",351],"-",["T_WHITESPACE"," ",351],["T_VARIABLE","$item",351],["T_OBJECT_OPERATOR","->",351],["T_STRING","getDiscountAmount",351],"(",")",")",["T_WHITESPACE"," ",351],"*",["T_WHITESPACE"," ",351],["T_VARIABLE","$_rulePct",351],";",["T_WHITESPACE","\n\n                    ",351],["T_IF","if",353],["T_WHITESPACE"," ",353],"(","!",["T_VARIABLE","$rule",353],["T_OBJECT_OPERATOR","->",353],["T_STRING","getDiscountQty",353],"(",")",["T_WHITESPACE"," ",353],["T_BOOLEAN_OR","||",353],["T_WHITESPACE"," ",353],["T_VARIABLE","$rule",353],["T_OBJECT_OPERATOR","->",353],["T_STRING","getDiscountQty",353],"(",")",">",["T_VARIABLE","$qty",353],")",["T_WHITESPACE"," ",353],"{",["T_WHITESPACE","\n                        ",353],["T_VARIABLE","$discountPercent",354],["T_WHITESPACE"," ",354],"=",["T_WHITESPACE"," ",354],["T_STRING","min",354],"(",["T_LNUMBER","100",354],",",["T_WHITESPACE"," ",354],["T_VARIABLE","$item",354],["T_OBJECT_OPERATOR","->",354],["T_STRING","getDiscountPercent",354],"(",")","+",["T_VARIABLE","$rulePercent",354],")",";",["T_WHITESPACE","\n                        ",354],["T_VARIABLE","$item",355],["T_OBJECT_OPERATOR","->",355],["T_STRING","setDiscountPercent",355],"(",["T_VARIABLE","$discountPercent",355],")",";",["T_WHITESPACE","\n                    ",355],"}",["T_WHITESPACE","\n                    ",356],["T_BREAK","break",357],";",["T_WHITESPACE","\n                ",357],["T_CASE","case",358],["T_WHITESPACE"," ",358],["T_STRING","Mage_SalesRule_Model_Rule",358],["T_DOUBLE_COLON","::",358],["T_STRING","TO_FIXED_ACTION",358],":",["T_WHITESPACE","\n                    ",358],["T_VARIABLE","$quoteAmount",359],["T_WHITESPACE"," ",359],"=",["T_WHITESPACE"," ",359],["T_VARIABLE","$quote",359],["T_OBJECT_OPERATOR","->",359],["T_STRING","getStore",359],"(",")",["T_OBJECT_OPERATOR","->",359],["T_STRING","convertPrice",359],"(",["T_VARIABLE","$rule",359],["T_OBJECT_OPERATOR","->",359],["T_STRING","getDiscountAmount",359],"(",")",")",";",["T_WHITESPACE","\n                    ",359],["T_VARIABLE","$discountAmount",360],["T_WHITESPACE","    ",360],"=",["T_WHITESPACE"," ",360],["T_VARIABLE","$qty",360],["T_WHITESPACE"," ",360],"*",["T_WHITESPACE"," ",360],"(",["T_VARIABLE","$itemPrice",360],"-",["T_VARIABLE","$quoteAmount",360],")",";",["T_WHITESPACE","\n                    ",360],["T_VARIABLE","$baseDiscountAmount",361],["T_WHITESPACE"," ",361],"=",["T_WHITESPACE"," ",361],["T_VARIABLE","$qty",361],["T_WHITESPACE"," ",361],"*",["T_WHITESPACE"," ",361],"(",["T_VARIABLE","$baseItemPrice",361],"-",["T_VARIABLE","$rule",361],["T_OBJECT_OPERATOR","->",361],["T_STRING","getDiscountAmount",361],"(",")",")",";",["T_WHITESPACE","\n                    ",361],["T_COMMENT","\/\/get discount for original price\n",362],["T_WHITESPACE","                    ",363],["T_VARIABLE","$originalDiscountAmount",363],["T_WHITESPACE","    ",363],"=",["T_WHITESPACE"," ",363],["T_VARIABLE","$qty",363],["T_WHITESPACE"," ",363],"*",["T_WHITESPACE"," ",363],"(",["T_VARIABLE","$itemOriginalPrice",363],"-",["T_VARIABLE","$quoteAmount",363],")",";",["T_WHITESPACE","\n                    ",363],["T_VARIABLE","$baseOriginalDiscountAmount",364],["T_WHITESPACE"," ",364],"=",["T_WHITESPACE"," ",364],["T_VARIABLE","$qty",364],["T_WHITESPACE"," ",364],"*",["T_WHITESPACE"," ",364],"(",["T_VARIABLE","$baseItemOriginalPrice",364],"-",["T_VARIABLE","$rule",364],["T_OBJECT_OPERATOR","->",364],["T_STRING","getDiscountAmount",364],"(",")",")",";",["T_WHITESPACE","\n                    ",364],["T_BREAK","break",365],";",["T_WHITESPACE","\n\n                ",365],["T_CASE","case",367],["T_WHITESPACE"," ",367],["T_STRING","Mage_SalesRule_Model_Rule",367],["T_DOUBLE_COLON","::",367],["T_STRING","BY_FIXED_ACTION",367],":",["T_WHITESPACE","\n                    ",367],["T_VARIABLE","$step",368],["T_WHITESPACE"," ",368],"=",["T_WHITESPACE"," ",368],["T_VARIABLE","$rule",368],["T_OBJECT_OPERATOR","->",368],["T_STRING","getDiscountStep",368],"(",")",";",["T_WHITESPACE","\n                    ",368],["T_IF","if",369],["T_WHITESPACE"," ",369],"(",["T_VARIABLE","$step",369],")",["T_WHITESPACE"," ",369],"{",["T_WHITESPACE","\n                        ",369],["T_VARIABLE","$qty",370],["T_WHITESPACE"," ",370],"=",["T_WHITESPACE"," ",370],["T_STRING","floor",370],"(",["T_VARIABLE","$qty",370],"\/",["T_VARIABLE","$step",370],")","*",["T_VARIABLE","$step",370],";",["T_WHITESPACE","\n                    ",370],"}",["T_WHITESPACE","\n                    ",371],["T_VARIABLE","$quoteAmount",372],["T_WHITESPACE","        ",372],"=",["T_WHITESPACE"," ",372],["T_VARIABLE","$quote",372],["T_OBJECT_OPERATOR","->",372],["T_STRING","getStore",372],"(",")",["T_OBJECT_OPERATOR","->",372],["T_STRING","convertPrice",372],"(",["T_VARIABLE","$rule",372],["T_OBJECT_OPERATOR","->",372],["T_STRING","getDiscountAmount",372],"(",")",")",";",["T_WHITESPACE","\n                    ",372],["T_VARIABLE","$discountAmount",373],["T_WHITESPACE","     ",373],"=",["T_WHITESPACE"," ",373],["T_VARIABLE","$qty",373],["T_WHITESPACE"," ",373],"*",["T_WHITESPACE"," ",373],["T_VARIABLE","$quoteAmount",373],";",["T_WHITESPACE","\n                    ",373],["T_VARIABLE","$baseDiscountAmount",374],["T_WHITESPACE"," ",374],"=",["T_WHITESPACE"," ",374],["T_VARIABLE","$qty",374],["T_WHITESPACE"," ",374],"*",["T_WHITESPACE"," ",374],["T_VARIABLE","$rule",374],["T_OBJECT_OPERATOR","->",374],["T_STRING","getDiscountAmount",374],"(",")",";",["T_WHITESPACE","\n                    ",374],["T_BREAK","break",375],";",["T_WHITESPACE","\n\n                ",375],["T_CASE","case",377],["T_WHITESPACE"," ",377],["T_STRING","Mage_SalesRule_Model_Rule",377],["T_DOUBLE_COLON","::",377],["T_STRING","CART_FIXED_ACTION",377],":",["T_WHITESPACE","\n                    ",377],["T_IF","if",378],["T_WHITESPACE"," ",378],"(",["T_EMPTY","empty",378],"(",["T_VARIABLE","$this",378],["T_OBJECT_OPERATOR","->",378],["T_STRING","_rulesItemTotals",378],"[",["T_VARIABLE","$rule",378],["T_OBJECT_OPERATOR","->",378],["T_STRING","getId",378],"(",")","]",")",")",["T_WHITESPACE"," ",378],"{",["T_WHITESPACE","\n                        ",378],["T_STRING","Mage",379],["T_DOUBLE_COLON","::",379],["T_STRING","throwException",379],"(",["T_STRING","Mage",379],["T_DOUBLE_COLON","::",379],["T_STRING","helper",379],"(",["T_CONSTANT_ENCAPSED_STRING","'salesrule'",379],")",["T_OBJECT_OPERATOR","->",379],["T_STRING","__",379],"(",["T_CONSTANT_ENCAPSED_STRING","'Item totals are not set for rule.'",379],")",")",";",["T_WHITESPACE","\n                    ",379],"}",["T_WHITESPACE","\n\n                    ",380],["T_DOC_COMMENT","\/**\n                     * prevent applying whole cart discount for every shipping order, but only for first order\n                     *\/",382],["T_WHITESPACE","\n                    ",384],["T_IF","if",385],["T_WHITESPACE"," ",385],"(",["T_VARIABLE","$quote",385],["T_OBJECT_OPERATOR","->",385],["T_STRING","getIsMultiShipping",385],"(",")",")",["T_WHITESPACE"," ",385],"{",["T_WHITESPACE","\n                        ",385],["T_VARIABLE","$usedForAddressId",386],["T_WHITESPACE"," ",386],"=",["T_WHITESPACE"," ",386],["T_VARIABLE","$this",386],["T_OBJECT_OPERATOR","->",386],["T_STRING","getCartFixedRuleUsedForAddress",386],"(",["T_VARIABLE","$rule",386],["T_OBJECT_OPERATOR","->",386],["T_STRING","getId",386],"(",")",")",";",["T_WHITESPACE","\n                        ",386],["T_IF","if",387],["T_WHITESPACE"," ",387],"(",["T_VARIABLE","$usedForAddressId",387],["T_WHITESPACE"," ",387],["T_BOOLEAN_AND","&&",387],["T_WHITESPACE"," ",387],["T_VARIABLE","$usedForAddressId",387],["T_WHITESPACE"," ",387],["T_IS_NOT_EQUAL","!=",387],["T_WHITESPACE"," ",387],["T_VARIABLE","$address",387],["T_OBJECT_OPERATOR","->",387],["T_STRING","getId",387],"(",")",")",["T_WHITESPACE"," ",387],"{",["T_WHITESPACE","\n                            ",387],["T_BREAK","break",388],";",["T_WHITESPACE","\n                        ",388],"}",["T_WHITESPACE"," ",389],["T_ELSE","else",389],["T_WHITESPACE"," ",389],"{",["T_WHITESPACE","\n                            ",389],["T_VARIABLE","$this",390],["T_OBJECT_OPERATOR","->",390],["T_STRING","setCartFixedRuleUsedForAddress",390],"(",["T_VARIABLE","$rule",390],["T_OBJECT_OPERATOR","->",390],["T_STRING","getId",390],"(",")",",",["T_WHITESPACE"," ",390],["T_VARIABLE","$address",390],["T_OBJECT_OPERATOR","->",390],["T_STRING","getId",390],"(",")",")",";",["T_WHITESPACE","\n                        ",390],"}",["T_WHITESPACE","\n                    ",391],"}",["T_WHITESPACE","\n                    ",392],["T_VARIABLE","$cartRules",393],["T_WHITESPACE"," ",393],"=",["T_WHITESPACE"," ",393],["T_VARIABLE","$address",393],["T_OBJECT_OPERATOR","->",393],["T_STRING","getCartFixedRules",393],"(",")",";",["T_WHITESPACE","\n                    ",393],["T_IF","if",394],["T_WHITESPACE"," ",394],"(","!",["T_ISSET","isset",394],"(",["T_VARIABLE","$cartRules",394],"[",["T_VARIABLE","$rule",394],["T_OBJECT_OPERATOR","->",394],["T_STRING","getId",394],"(",")","]",")",")",["T_WHITESPACE"," ",394],"{",["T_WHITESPACE","\n                        ",394],["T_VARIABLE","$cartRules",395],"[",["T_VARIABLE","$rule",395],["T_OBJECT_OPERATOR","->",395],["T_STRING","getId",395],"(",")","]",["T_WHITESPACE"," ",395],"=",["T_WHITESPACE"," ",395],["T_VARIABLE","$rule",395],["T_OBJECT_OPERATOR","->",395],["T_STRING","getDiscountAmount",395],"(",")",";",["T_WHITESPACE","\n                    ",395],"}",["T_WHITESPACE","\n\n                    ",396],["T_IF","if",398],["T_WHITESPACE"," ",398],"(",["T_VARIABLE","$cartRules",398],"[",["T_VARIABLE","$rule",398],["T_OBJECT_OPERATOR","->",398],["T_STRING","getId",398],"(",")","]",["T_WHITESPACE"," ",398],">",["T_WHITESPACE"," ",398],["T_LNUMBER","0",398],")",["T_WHITESPACE"," ",398],"{",["T_WHITESPACE","\n                        ",398],["T_IF","if",399],["T_WHITESPACE"," ",399],"(",["T_VARIABLE","$this",399],["T_OBJECT_OPERATOR","->",399],["T_STRING","_rulesItemTotals",399],"[",["T_VARIABLE","$rule",399],["T_OBJECT_OPERATOR","->",399],["T_STRING","getId",399],"(",")","]","[",["T_CONSTANT_ENCAPSED_STRING","'items_count'",399],"]",["T_WHITESPACE"," ",399],["T_IS_SMALLER_OR_EQUAL","<=",399],["T_WHITESPACE"," ",399],["T_LNUMBER","1",399],")",["T_WHITESPACE"," ",399],"{",["T_WHITESPACE","\n                            ",399],["T_VARIABLE","$quoteAmount",400],["T_WHITESPACE"," ",400],"=",["T_WHITESPACE"," ",400],["T_VARIABLE","$quote",400],["T_OBJECT_OPERATOR","->",400],["T_STRING","getStore",400],"(",")",["T_OBJECT_OPERATOR","->",400],["T_STRING","convertPrice",400],"(",["T_VARIABLE","$cartRules",400],"[",["T_VARIABLE","$rule",400],["T_OBJECT_OPERATOR","->",400],["T_STRING","getId",400],"(",")","]",")",";",["T_WHITESPACE","\n                            ",400],["T_VARIABLE","$baseDiscountAmount",401],["T_WHITESPACE"," ",401],"=",["T_WHITESPACE"," ",401],["T_STRING","min",401],"(",["T_VARIABLE","$baseItemPrice",401],["T_WHITESPACE"," ",401],"*",["T_WHITESPACE"," ",401],["T_VARIABLE","$qty",401],",",["T_WHITESPACE"," ",401],["T_VARIABLE","$cartRules",401],"[",["T_VARIABLE","$rule",401],["T_OBJECT_OPERATOR","->",401],["T_STRING","getId",401],"(",")","]",")",";",["T_WHITESPACE","\n                        ",401],"}",["T_WHITESPACE"," ",402],["T_ELSE","else",402],["T_WHITESPACE"," ",402],"{",["T_WHITESPACE","\n                            ",402],["T_VARIABLE","$discountRate",403],["T_WHITESPACE"," ",403],"=",["T_WHITESPACE"," ",403],["T_VARIABLE","$baseItemPrice",403],["T_WHITESPACE"," ",403],"*",["T_WHITESPACE"," ",403],["T_VARIABLE","$qty",403],["T_WHITESPACE"," ",403],"\/",["T_WHITESPACE","\n                                ",403],["T_VARIABLE","$this",404],["T_OBJECT_OPERATOR","->",404],["T_STRING","_rulesItemTotals",404],"[",["T_VARIABLE","$rule",404],["T_OBJECT_OPERATOR","->",404],["T_STRING","getId",404],"(",")","]","[",["T_CONSTANT_ENCAPSED_STRING","'base_items_price'",404],"]",";",["T_WHITESPACE","\n                            ",404],["T_VARIABLE","$maximumItemDiscount",405],["T_WHITESPACE"," ",405],"=",["T_WHITESPACE"," ",405],["T_VARIABLE","$rule",405],["T_OBJECT_OPERATOR","->",405],["T_STRING","getDiscountAmount",405],"(",")",["T_WHITESPACE"," ",405],"*",["T_WHITESPACE"," ",405],["T_VARIABLE","$discountRate",405],";",["T_WHITESPACE","\n                            ",405],["T_VARIABLE","$quoteAmount",406],["T_WHITESPACE"," ",406],"=",["T_WHITESPACE"," ",406],["T_VARIABLE","$quote",406],["T_OBJECT_OPERATOR","->",406],["T_STRING","getStore",406],"(",")",["T_OBJECT_OPERATOR","->",406],["T_STRING","convertPrice",406],"(",["T_VARIABLE","$maximumItemDiscount",406],")",";",["T_WHITESPACE","\n\n                            ",406],["T_VARIABLE","$baseDiscountAmount",408],["T_WHITESPACE"," ",408],"=",["T_WHITESPACE"," ",408],["T_STRING","min",408],"(",["T_VARIABLE","$baseItemPrice",408],["T_WHITESPACE"," ",408],"*",["T_WHITESPACE"," ",408],["T_VARIABLE","$qty",408],",",["T_WHITESPACE"," ",408],["T_VARIABLE","$maximumItemDiscount",408],")",";",["T_WHITESPACE","\n                            ",408],["T_VARIABLE","$this",409],["T_OBJECT_OPERATOR","->",409],["T_STRING","_rulesItemTotals",409],"[",["T_VARIABLE","$rule",409],["T_OBJECT_OPERATOR","->",409],["T_STRING","getId",409],"(",")","]","[",["T_CONSTANT_ENCAPSED_STRING","'items_count'",409],"]",["T_DEC","--",409],";",["T_WHITESPACE","\n                        ",409],"}",["T_WHITESPACE","\n\n                        ",410],["T_VARIABLE","$discountAmount",412],["T_WHITESPACE"," ",412],"=",["T_WHITESPACE"," ",412],["T_STRING","min",412],"(",["T_VARIABLE","$itemPrice",412],["T_WHITESPACE"," ",412],"*",["T_WHITESPACE"," ",412],["T_VARIABLE","$qty",412],",",["T_WHITESPACE"," ",412],["T_VARIABLE","$quoteAmount",412],")",";",["T_WHITESPACE","\n                        ",412],["T_VARIABLE","$discountAmount",413],["T_WHITESPACE"," ",413],"=",["T_WHITESPACE"," ",413],["T_VARIABLE","$quote",413],["T_OBJECT_OPERATOR","->",413],["T_STRING","getStore",413],"(",")",["T_OBJECT_OPERATOR","->",413],["T_STRING","roundPrice",413],"(",["T_VARIABLE","$discountAmount",413],")",";",["T_WHITESPACE","\n                        ",413],["T_VARIABLE","$baseDiscountAmount",414],["T_WHITESPACE"," ",414],"=",["T_WHITESPACE"," ",414],["T_VARIABLE","$quote",414],["T_OBJECT_OPERATOR","->",414],["T_STRING","getStore",414],"(",")",["T_OBJECT_OPERATOR","->",414],["T_STRING","roundPrice",414],"(",["T_VARIABLE","$baseDiscountAmount",414],")",";",["T_WHITESPACE","\n\n                        ",414],["T_COMMENT","\/\/get discount for original price\n",416],["T_WHITESPACE","                        ",417],["T_VARIABLE","$originalDiscountAmount",417],["T_WHITESPACE"," ",417],"=",["T_WHITESPACE"," ",417],["T_STRING","min",417],"(",["T_VARIABLE","$itemOriginalPrice",417],["T_WHITESPACE"," ",417],"*",["T_WHITESPACE"," ",417],["T_VARIABLE","$qty",417],",",["T_WHITESPACE"," ",417],["T_VARIABLE","$quoteAmount",417],")",";",["T_WHITESPACE","\n                        ",417],["T_VARIABLE","$baseOriginalDiscountAmount",418],["T_WHITESPACE"," ",418],"=",["T_WHITESPACE"," ",418],["T_VARIABLE","$quote",418],["T_OBJECT_OPERATOR","->",418],["T_STRING","getStore",418],"(",")",["T_OBJECT_OPERATOR","->",418],["T_STRING","roundPrice",418],"(",["T_VARIABLE","$baseItemOriginalPrice",418],")",";",["T_WHITESPACE","\n\n                        ",418],["T_VARIABLE","$cartRules",420],"[",["T_VARIABLE","$rule",420],["T_OBJECT_OPERATOR","->",420],["T_STRING","getId",420],"(",")","]",["T_WHITESPACE"," ",420],["T_MINUS_EQUAL","-=",420],["T_WHITESPACE"," ",420],["T_VARIABLE","$baseDiscountAmount",420],";",["T_WHITESPACE","\n                    ",420],"}",["T_WHITESPACE","\n                    ",421],["T_VARIABLE","$address",422],["T_OBJECT_OPERATOR","->",422],["T_STRING","setCartFixedRules",422],"(",["T_VARIABLE","$cartRules",422],")",";",["T_WHITESPACE","\n\n                    ",422],["T_BREAK","break",424],";",["T_WHITESPACE","\n\n                ",424],["T_CASE","case",426],["T_WHITESPACE"," ",426],["T_STRING","Mage_SalesRule_Model_Rule",426],["T_DOUBLE_COLON","::",426],["T_STRING","BUY_X_GET_Y_ACTION",426],":",["T_WHITESPACE","\n                    ",426],["T_VARIABLE","$x",427],["T_WHITESPACE"," ",427],"=",["T_WHITESPACE"," ",427],["T_VARIABLE","$rule",427],["T_OBJECT_OPERATOR","->",427],["T_STRING","getDiscountStep",427],"(",")",";",["T_WHITESPACE","\n                    ",427],["T_VARIABLE","$y",428],["T_WHITESPACE"," ",428],"=",["T_WHITESPACE"," ",428],["T_VARIABLE","$rule",428],["T_OBJECT_OPERATOR","->",428],["T_STRING","getDiscountAmount",428],"(",")",";",["T_WHITESPACE","\n                    ",428],["T_IF","if",429],["T_WHITESPACE"," ",429],"(","!",["T_VARIABLE","$x",429],["T_WHITESPACE"," ",429],["T_BOOLEAN_OR","||",429],["T_WHITESPACE"," ",429],["T_VARIABLE","$y",429],["T_WHITESPACE"," ",429],">",["T_WHITESPACE"," ",429],["T_VARIABLE","$x",429],")",["T_WHITESPACE"," ",429],"{",["T_WHITESPACE","\n                        ",429],["T_BREAK","break",430],";",["T_WHITESPACE","\n                    ",430],"}",["T_WHITESPACE","\n                    ",431],["T_VARIABLE","$buyAndDiscountQty",432],["T_WHITESPACE"," ",432],"=",["T_WHITESPACE"," ",432],["T_VARIABLE","$x",432],["T_WHITESPACE"," ",432],"+",["T_WHITESPACE"," ",432],["T_VARIABLE","$y",432],";",["T_WHITESPACE","\n\n                    ",432],["T_VARIABLE","$fullRuleQtyPeriod",434],["T_WHITESPACE"," ",434],"=",["T_WHITESPACE"," ",434],["T_STRING","floor",434],"(",["T_VARIABLE","$qty",434],["T_WHITESPACE"," ",434],"\/",["T_WHITESPACE"," ",434],["T_VARIABLE","$buyAndDiscountQty",434],")",";",["T_WHITESPACE","\n                    ",434],["T_VARIABLE","$freeQty",435],["T_WHITESPACE","  ",435],"=",["T_WHITESPACE"," ",435],["T_VARIABLE","$qty",435],["T_WHITESPACE"," ",435],"-",["T_WHITESPACE"," ",435],["T_VARIABLE","$fullRuleQtyPeriod",435],["T_WHITESPACE"," ",435],"*",["T_WHITESPACE"," ",435],["T_VARIABLE","$buyAndDiscountQty",435],";",["T_WHITESPACE","\n\n                    ",435],["T_VARIABLE","$discountQty",437],["T_WHITESPACE"," ",437],"=",["T_WHITESPACE"," ",437],["T_VARIABLE","$fullRuleQtyPeriod",437],["T_WHITESPACE"," ",437],"*",["T_WHITESPACE"," ",437],["T_VARIABLE","$y",437],";",["T_WHITESPACE","\n                    ",437],["T_IF","if",438],["T_WHITESPACE"," ",438],"(",["T_VARIABLE","$freeQty",438],["T_WHITESPACE"," ",438],">",["T_WHITESPACE"," ",438],["T_VARIABLE","$x",438],")",["T_WHITESPACE"," ",438],"{",["T_WHITESPACE","\n                        ",438],["T_VARIABLE","$discountQty",439],["T_WHITESPACE"," ",439],["T_PLUS_EQUAL","+=",439],["T_WHITESPACE"," ",439],["T_VARIABLE","$freeQty",439],["T_WHITESPACE"," ",439],"-",["T_WHITESPACE"," ",439],["T_VARIABLE","$x",439],";",["T_WHITESPACE","\n                    ",439],"}",["T_WHITESPACE","\n\n                    ",440],["T_VARIABLE","$discountAmount",442],["T_WHITESPACE","    ",442],"=",["T_WHITESPACE"," ",442],["T_VARIABLE","$discountQty",442],["T_WHITESPACE"," ",442],"*",["T_WHITESPACE"," ",442],["T_VARIABLE","$itemPrice",442],";",["T_WHITESPACE","\n                    ",442],["T_VARIABLE","$baseDiscountAmount",443],["T_WHITESPACE"," ",443],"=",["T_WHITESPACE"," ",443],["T_VARIABLE","$discountQty",443],["T_WHITESPACE"," ",443],"*",["T_WHITESPACE"," ",443],["T_VARIABLE","$baseItemPrice",443],";",["T_WHITESPACE","\n                    ",443],["T_COMMENT","\/\/get discount for original price\n",444],["T_WHITESPACE","                    ",445],["T_VARIABLE","$originalDiscountAmount",445],["T_WHITESPACE","    ",445],"=",["T_WHITESPACE"," ",445],["T_VARIABLE","$discountQty",445],["T_WHITESPACE"," ",445],"*",["T_WHITESPACE"," ",445],["T_VARIABLE","$itemOriginalPrice",445],";",["T_WHITESPACE","\n                    ",445],["T_VARIABLE","$baseOriginalDiscountAmount",446],["T_WHITESPACE"," ",446],"=",["T_WHITESPACE"," ",446],["T_VARIABLE","$discountQty",446],["T_WHITESPACE"," ",446],"*",["T_WHITESPACE"," ",446],["T_VARIABLE","$baseItemOriginalPrice",446],";",["T_WHITESPACE","\n                    ",446],["T_BREAK","break",447],";",["T_WHITESPACE","\n            ",447],"}",["T_WHITESPACE","\n\n            ",448],["T_VARIABLE","$result",450],["T_WHITESPACE"," ",450],"=",["T_WHITESPACE"," ",450],["T_NEW","new",450],["T_WHITESPACE"," ",450],["T_STRING","Varien_Object",450],"(",["T_ARRAY","array",450],"(",["T_WHITESPACE","\n                ",450],["T_CONSTANT_ENCAPSED_STRING","'discount_amount'",451],["T_WHITESPACE","      ",451],["T_DOUBLE_ARROW","=>",451],["T_WHITESPACE"," ",451],["T_VARIABLE","$discountAmount",451],",",["T_WHITESPACE","\n                ",451],["T_CONSTANT_ENCAPSED_STRING","'base_discount_amount'",452],["T_WHITESPACE"," ",452],["T_DOUBLE_ARROW","=>",452],["T_WHITESPACE"," ",452],["T_VARIABLE","$baseDiscountAmount",452],",",["T_WHITESPACE","\n            ",452],")",")",";",["T_WHITESPACE","\n            ",453],["T_STRING","Mage",454],["T_DOUBLE_COLON","::",454],["T_STRING","dispatchEvent",454],"(",["T_CONSTANT_ENCAPSED_STRING","'salesrule_validator_process'",454],",",["T_WHITESPACE"," ",454],["T_ARRAY","array",454],"(",["T_WHITESPACE","\n                ",454],["T_CONSTANT_ENCAPSED_STRING","'rule'",455],["T_WHITESPACE","    ",455],["T_DOUBLE_ARROW","=>",455],["T_WHITESPACE"," ",455],["T_VARIABLE","$rule",455],",",["T_WHITESPACE","\n                ",455],["T_CONSTANT_ENCAPSED_STRING","'item'",456],["T_WHITESPACE","    ",456],["T_DOUBLE_ARROW","=>",456],["T_WHITESPACE"," ",456],["T_VARIABLE","$item",456],",",["T_WHITESPACE","\n                ",456],["T_CONSTANT_ENCAPSED_STRING","'address'",457],["T_WHITESPACE"," ",457],["T_DOUBLE_ARROW","=>",457],["T_WHITESPACE"," ",457],["T_VARIABLE","$address",457],",",["T_WHITESPACE","\n                ",457],["T_CONSTANT_ENCAPSED_STRING","'quote'",458],["T_WHITESPACE","   ",458],["T_DOUBLE_ARROW","=>",458],["T_WHITESPACE"," ",458],["T_VARIABLE","$quote",458],",",["T_WHITESPACE","\n                ",458],["T_CONSTANT_ENCAPSED_STRING","'qty'",459],["T_WHITESPACE","     ",459],["T_DOUBLE_ARROW","=>",459],["T_WHITESPACE"," ",459],["T_VARIABLE","$qty",459],",",["T_WHITESPACE","\n                ",459],["T_CONSTANT_ENCAPSED_STRING","'result'",460],["T_WHITESPACE","  ",460],["T_DOUBLE_ARROW","=>",460],["T_WHITESPACE"," ",460],["T_VARIABLE","$result",460],",",["T_WHITESPACE","\n            ",460],")",")",";",["T_WHITESPACE","\n\n            ",461],["T_VARIABLE","$discountAmount",463],["T_WHITESPACE"," ",463],"=",["T_WHITESPACE"," ",463],["T_VARIABLE","$result",463],["T_OBJECT_OPERATOR","->",463],["T_STRING","getDiscountAmount",463],"(",")",";",["T_WHITESPACE","\n            ",463],["T_VARIABLE","$baseDiscountAmount",464],["T_WHITESPACE"," ",464],"=",["T_WHITESPACE"," ",464],["T_VARIABLE","$result",464],["T_OBJECT_OPERATOR","->",464],["T_STRING","getBaseDiscountAmount",464],"(",")",";",["T_WHITESPACE","\n\n            ",464],["T_VARIABLE","$percentKey",466],["T_WHITESPACE"," ",466],"=",["T_WHITESPACE"," ",466],["T_VARIABLE","$item",466],["T_OBJECT_OPERATOR","->",466],["T_STRING","getDiscountPercent",466],"(",")",";",["T_WHITESPACE","\n            ",466],["T_DOC_COMMENT","\/**\n             * Process \"delta\" rounding\n             *\/",467],["T_WHITESPACE","\n            ",469],["T_IF","if",470],["T_WHITESPACE"," ",470],"(",["T_VARIABLE","$percentKey",470],")",["T_WHITESPACE"," ",470],"{",["T_WHITESPACE","\n                ",470],["T_VARIABLE","$delta",471],["T_WHITESPACE","      ",471],"=",["T_WHITESPACE"," ",471],["T_ISSET","isset",471],"(",["T_VARIABLE","$this",471],["T_OBJECT_OPERATOR","->",471],["T_STRING","_roundingDeltas",471],"[",["T_VARIABLE","$percentKey",471],"]",")",["T_WHITESPACE"," ",471],"?",["T_WHITESPACE"," ",471],["T_VARIABLE","$this",471],["T_OBJECT_OPERATOR","->",471],["T_STRING","_roundingDeltas",471],"[",["T_VARIABLE","$percentKey",471],"]",["T_WHITESPACE"," ",471],":",["T_WHITESPACE"," ",471],["T_LNUMBER","0",471],";",["T_WHITESPACE","\n                ",471],["T_VARIABLE","$baseDelta",472],["T_WHITESPACE","  ",472],"=",["T_WHITESPACE"," ",472],["T_ISSET","isset",472],"(",["T_VARIABLE","$this",472],["T_OBJECT_OPERATOR","->",472],["T_STRING","_baseRoundingDeltas",472],"[",["T_VARIABLE","$percentKey",472],"]",")",["T_WHITESPACE","\n                    ",472],"?",["T_WHITESPACE"," ",473],["T_VARIABLE","$this",473],["T_OBJECT_OPERATOR","->",473],["T_STRING","_baseRoundingDeltas",473],"[",["T_VARIABLE","$percentKey",473],"]",["T_WHITESPACE","\n                    ",473],":",["T_WHITESPACE"," ",474],["T_LNUMBER","0",474],";",["T_WHITESPACE","\n                ",474],["T_VARIABLE","$discountAmount",475],["T_WHITESPACE"," ",475],["T_PLUS_EQUAL","+=",475],["T_WHITESPACE"," ",475],["T_VARIABLE","$delta",475],";",["T_WHITESPACE","\n                ",475],["T_VARIABLE","$baseDiscountAmount",476],["T_WHITESPACE"," ",476],["T_PLUS_EQUAL","+=",476],["T_WHITESPACE"," ",476],["T_VARIABLE","$baseDelta",476],";",["T_WHITESPACE","\n\n                ",476],["T_VARIABLE","$this",478],["T_OBJECT_OPERATOR","->",478],["T_STRING","_roundingDeltas",478],"[",["T_VARIABLE","$percentKey",478],"]",["T_WHITESPACE","     ",478],"=",["T_WHITESPACE"," ",478],["T_VARIABLE","$discountAmount",478],["T_WHITESPACE"," ",478],"-",["T_WHITESPACE","\n                    ",478],["T_VARIABLE","$quote",479],["T_OBJECT_OPERATOR","->",479],["T_STRING","getStore",479],"(",")",["T_OBJECT_OPERATOR","->",479],["T_STRING","roundPrice",479],"(",["T_VARIABLE","$discountAmount",479],")",";",["T_WHITESPACE","\n                ",479],["T_VARIABLE","$this",480],["T_OBJECT_OPERATOR","->",480],["T_STRING","_baseRoundingDeltas",480],"[",["T_VARIABLE","$percentKey",480],"]",["T_WHITESPACE"," ",480],"=",["T_WHITESPACE"," ",480],["T_VARIABLE","$baseDiscountAmount",480],["T_WHITESPACE"," ",480],"-",["T_WHITESPACE","\n                    ",480],["T_VARIABLE","$quote",481],["T_OBJECT_OPERATOR","->",481],["T_STRING","getStore",481],"(",")",["T_OBJECT_OPERATOR","->",481],["T_STRING","roundPrice",481],"(",["T_VARIABLE","$baseDiscountAmount",481],")",";",["T_WHITESPACE","\n                ",481],["T_VARIABLE","$discountAmount",482],["T_WHITESPACE"," ",482],"=",["T_WHITESPACE"," ",482],["T_VARIABLE","$quote",482],["T_OBJECT_OPERATOR","->",482],["T_STRING","getStore",482],"(",")",["T_OBJECT_OPERATOR","->",482],["T_STRING","roundPrice",482],"(",["T_VARIABLE","$discountAmount",482],")",";",["T_WHITESPACE","\n                ",482],["T_VARIABLE","$baseDiscountAmount",483],["T_WHITESPACE"," ",483],"=",["T_WHITESPACE"," ",483],["T_VARIABLE","$quote",483],["T_OBJECT_OPERATOR","->",483],["T_STRING","getStore",483],"(",")",["T_OBJECT_OPERATOR","->",483],["T_STRING","roundPrice",483],"(",["T_VARIABLE","$baseDiscountAmount",483],")",";",["T_WHITESPACE","\n            ",483],"}",["T_WHITESPACE"," ",484],["T_ELSE","else",484],["T_WHITESPACE"," ",484],"{",["T_WHITESPACE","\n                ",484],["T_VARIABLE","$discountAmount",485],["T_WHITESPACE","     ",485],"=",["T_WHITESPACE"," ",485],["T_VARIABLE","$quote",485],["T_OBJECT_OPERATOR","->",485],["T_STRING","getStore",485],"(",")",["T_OBJECT_OPERATOR","->",485],["T_STRING","roundPrice",485],"(",["T_VARIABLE","$discountAmount",485],")",";",["T_WHITESPACE","\n                ",485],["T_VARIABLE","$baseDiscountAmount",486],["T_WHITESPACE"," ",486],"=",["T_WHITESPACE"," ",486],["T_VARIABLE","$quote",486],["T_OBJECT_OPERATOR","->",486],["T_STRING","getStore",486],"(",")",["T_OBJECT_OPERATOR","->",486],["T_STRING","roundPrice",486],"(",["T_VARIABLE","$baseDiscountAmount",486],")",";",["T_WHITESPACE","\n            ",486],"}",["T_WHITESPACE","\n\n            ",487],["T_DOC_COMMENT","\/**\n             * We can't use row total here because row total not include tax\n             * Discount can be applied on price included tax\n             *\/",489],["T_WHITESPACE","\n\n            ",492],["T_VARIABLE","$itemDiscountAmount",494],["T_WHITESPACE"," ",494],"=",["T_WHITESPACE"," ",494],["T_VARIABLE","$item",494],["T_OBJECT_OPERATOR","->",494],["T_STRING","getDiscountAmount",494],"(",")",";",["T_WHITESPACE","\n            ",494],["T_VARIABLE","$itemBaseDiscountAmount",495],["T_WHITESPACE"," ",495],"=",["T_WHITESPACE"," ",495],["T_VARIABLE","$item",495],["T_OBJECT_OPERATOR","->",495],["T_STRING","getBaseDiscountAmount",495],"(",")",";",["T_WHITESPACE","\n\n            ",495],["T_VARIABLE","$discountAmount",497],["T_WHITESPACE","     ",497],"=",["T_WHITESPACE"," ",497],["T_STRING","min",497],"(",["T_VARIABLE","$itemDiscountAmount",497],["T_WHITESPACE"," ",497],"+",["T_WHITESPACE"," ",497],["T_VARIABLE","$discountAmount",497],",",["T_WHITESPACE"," ",497],["T_VARIABLE","$itemPrice",497],["T_WHITESPACE"," ",497],"*",["T_WHITESPACE"," ",497],["T_VARIABLE","$qty",497],")",";",["T_WHITESPACE","\n            ",497],["T_VARIABLE","$baseDiscountAmount",498],["T_WHITESPACE"," ",498],"=",["T_WHITESPACE"," ",498],["T_STRING","min",498],"(",["T_VARIABLE","$itemBaseDiscountAmount",498],["T_WHITESPACE"," ",498],"+",["T_WHITESPACE"," ",498],["T_VARIABLE","$baseDiscountAmount",498],",",["T_WHITESPACE"," ",498],["T_VARIABLE","$baseItemPrice",498],["T_WHITESPACE"," ",498],"*",["T_WHITESPACE"," ",498],["T_VARIABLE","$qty",498],")",";",["T_WHITESPACE","\n\n            ",498],["T_VARIABLE","$item",500],["T_OBJECT_OPERATOR","->",500],["T_STRING","setDiscountAmount",500],"(",["T_VARIABLE","$discountAmount",500],")",";",["T_WHITESPACE","\n            ",500],["T_VARIABLE","$item",501],["T_OBJECT_OPERATOR","->",501],["T_STRING","setBaseDiscountAmount",501],"(",["T_VARIABLE","$baseDiscountAmount",501],")",";",["T_WHITESPACE","\n\n            ",501],["T_VARIABLE","$item",503],["T_OBJECT_OPERATOR","->",503],["T_STRING","setOriginalDiscountAmount",503],"(",["T_VARIABLE","$originalDiscountAmount",503],")",";",["T_WHITESPACE","\n            ",503],["T_VARIABLE","$item",504],["T_OBJECT_OPERATOR","->",504],["T_STRING","setBaseOriginalDiscountAmount",504],"(",["T_VARIABLE","$baseOriginalDiscountAmount",504],")",";",["T_WHITESPACE","\n\n            ",504],["T_VARIABLE","$appliedRuleIds",506],"[",["T_VARIABLE","$rule",506],["T_OBJECT_OPERATOR","->",506],["T_STRING","getRuleId",506],"(",")","]",["T_WHITESPACE"," ",506],"=",["T_WHITESPACE"," ",506],["T_VARIABLE","$rule",506],["T_OBJECT_OPERATOR","->",506],["T_STRING","getRuleId",506],"(",")",";",["T_WHITESPACE","\n\n            ",506],["T_VARIABLE","$this",508],["T_OBJECT_OPERATOR","->",508],["T_STRING","_maintainAddressCouponCode",508],"(",["T_VARIABLE","$address",508],",",["T_WHITESPACE"," ",508],["T_VARIABLE","$rule",508],")",";",["T_WHITESPACE","\n            ",508],["T_VARIABLE","$this",509],["T_OBJECT_OPERATOR","->",509],["T_STRING","_addDiscountDescription",509],"(",["T_VARIABLE","$address",509],",",["T_WHITESPACE"," ",509],["T_VARIABLE","$rule",509],")",";",["T_WHITESPACE","\n\n            ",509],["T_IF","if",511],["T_WHITESPACE"," ",511],"(",["T_VARIABLE","$rule",511],["T_OBJECT_OPERATOR","->",511],["T_STRING","getStopRulesProcessing",511],"(",")",")",["T_WHITESPACE"," ",511],"{",["T_WHITESPACE","\n                ",511],["T_VARIABLE","$this",512],["T_OBJECT_OPERATOR","->",512],["T_STRING","_stopFurtherRules",512],["T_WHITESPACE"," ",512],"=",["T_WHITESPACE"," ",512],["T_STRING","true",512],";",["T_WHITESPACE","\n                ",512],["T_BREAK","break",513],";",["T_WHITESPACE","\n            ",513],"}",["T_WHITESPACE","\n        ",514],"}",["T_WHITESPACE","\n\n        ",515],["T_VARIABLE","$item",517],["T_OBJECT_OPERATOR","->",517],["T_STRING","setAppliedRuleIds",517],"(",["T_STRING","join",517],"(",["T_CONSTANT_ENCAPSED_STRING","','",517],",",["T_VARIABLE","$appliedRuleIds",517],")",")",";",["T_WHITESPACE","\n        ",517],["T_VARIABLE","$address",518],["T_OBJECT_OPERATOR","->",518],["T_STRING","setAppliedRuleIds",518],"(",["T_VARIABLE","$this",518],["T_OBJECT_OPERATOR","->",518],["T_STRING","mergeIds",518],"(",["T_VARIABLE","$address",518],["T_OBJECT_OPERATOR","->",518],["T_STRING","getAppliedRuleIds",518],"(",")",",",["T_WHITESPACE"," ",518],["T_VARIABLE","$appliedRuleIds",518],")",")",";",["T_WHITESPACE","\n        ",518],["T_VARIABLE","$quote",519],["T_OBJECT_OPERATOR","->",519],["T_STRING","setAppliedRuleIds",519],"(",["T_VARIABLE","$this",519],["T_OBJECT_OPERATOR","->",519],["T_STRING","mergeIds",519],"(",["T_VARIABLE","$quote",519],["T_OBJECT_OPERATOR","->",519],["T_STRING","getAppliedRuleIds",519],"(",")",",",["T_WHITESPACE"," ",519],["T_VARIABLE","$appliedRuleIds",519],")",")",";",["T_WHITESPACE","\n\n        ",519],["T_RETURN","return",521],["T_WHITESPACE"," ",521],["T_VARIABLE","$this",521],";",["T_WHITESPACE","\n    ",521],"}",["T_WHITESPACE","\n\n    ",522],["T_DOC_COMMENT","\/**\n     * Apply discount amount to FPT\n     *\n     * @param Mage_Sales_Model_Quote_Address $address\n     * @param array $items\n     * @return Mage_SalesRule_Model_Validator\n     *\/",524],["T_WHITESPACE","\n    ",530],["T_PUBLIC","public",531],["T_WHITESPACE"," ",531],["T_FUNCTION","function",531],["T_WHITESPACE"," ",531],["T_STRING","processWeeeAmount",531],"(",["T_STRING","Mage_Sales_Model_Quote_Address",531],["T_WHITESPACE"," ",531],["T_VARIABLE","$address",531],",",["T_WHITESPACE"," ",531],["T_VARIABLE","$items",531],")",["T_WHITESPACE","\n    ",531],"{",["T_WHITESPACE","\n        ",532],["T_VARIABLE","$quote",533],["T_WHITESPACE"," ",533],"=",["T_WHITESPACE"," ",533],["T_VARIABLE","$address",533],["T_OBJECT_OPERATOR","->",533],["T_STRING","getQuote",533],"(",")",";",["T_WHITESPACE","\n        ",533],["T_VARIABLE","$store",534],["T_WHITESPACE"," ",534],"=",["T_WHITESPACE"," ",534],["T_VARIABLE","$quote",534],["T_OBJECT_OPERATOR","->",534],["T_STRING","getStore",534],"(",")",";",["T_WHITESPACE","\n\n        ",534],["T_IF","if",536],["T_WHITESPACE"," ",536],"(","!",["T_VARIABLE","$this",536],["T_OBJECT_OPERATOR","->",536],["T_STRING","_getHelper",536],"(",["T_CONSTANT_ENCAPSED_STRING","'weee'",536],")",["T_OBJECT_OPERATOR","->",536],["T_STRING","isEnabled",536],"(",")",["T_WHITESPACE"," ",536],["T_BOOLEAN_OR","||",536],["T_WHITESPACE"," ",536],"!",["T_VARIABLE","$this",536],["T_OBJECT_OPERATOR","->",536],["T_STRING","_getHelper",536],"(",["T_CONSTANT_ENCAPSED_STRING","'weee'",536],")",["T_OBJECT_OPERATOR","->",536],["T_STRING","isDiscounted",536],"(",")",")",["T_WHITESPACE"," ",536],"{",["T_WHITESPACE","\n            ",536],["T_RETURN","return",537],["T_WHITESPACE"," ",537],["T_VARIABLE","$this",537],";",["T_WHITESPACE","\n        ",537],"}",["T_WHITESPACE","\n\n        ",538],["T_DOC_COMMENT","\/**\n         *   for calculating weee tax discount\n         *\/",540],["T_WHITESPACE","\n        ",542],["T_VARIABLE","$config",543],["T_WHITESPACE"," ",543],"=",["T_WHITESPACE"," ",543],["T_VARIABLE","$this",543],["T_OBJECT_OPERATOR","->",543],["T_STRING","_getSingleton",543],"(",["T_CONSTANT_ENCAPSED_STRING","'tax\/config'",543],")",";",["T_WHITESPACE","\n        ",543],["T_VARIABLE","$calculator",544],["T_WHITESPACE"," ",544],"=",["T_WHITESPACE"," ",544],["T_VARIABLE","$this",544],["T_OBJECT_OPERATOR","->",544],["T_STRING","_getSingleton",544],"(",["T_CONSTANT_ENCAPSED_STRING","'tax\/calculation'",544],")",";",["T_WHITESPACE","\n        ",544],["T_VARIABLE","$request",545],["T_WHITESPACE"," ",545],"=",["T_WHITESPACE"," ",545],["T_VARIABLE","$calculator",545],["T_OBJECT_OPERATOR","->",545],["T_STRING","getRateRequest",545],"(",["T_WHITESPACE","\n            ",545],["T_VARIABLE","$address",546],",",["T_WHITESPACE","\n            ",546],["T_VARIABLE","$quote",547],["T_OBJECT_OPERATOR","->",547],["T_STRING","getBillingAddress",547],"(",")",",",["T_WHITESPACE","\n            ",547],["T_VARIABLE","$quote",548],["T_OBJECT_OPERATOR","->",548],["T_STRING","getCustomerTaxClassId",548],"(",")",",",["T_WHITESPACE","\n            ",548],["T_VARIABLE","$store",549],["T_WHITESPACE","\n        ",549],")",";",["T_WHITESPACE","\n\n        ",550],["T_VARIABLE","$applyTaxAfterDiscount",552],["T_WHITESPACE"," ",552],"=",["T_WHITESPACE"," ",552],["T_VARIABLE","$config",552],["T_OBJECT_OPERATOR","->",552],["T_STRING","applyTaxAfterDiscount",552],"(",")",";",["T_WHITESPACE","\n        ",552],["T_VARIABLE","$discountTax",553],["T_WHITESPACE"," ",553],"=",["T_WHITESPACE"," ",553],["T_VARIABLE","$config",553],["T_OBJECT_OPERATOR","->",553],["T_STRING","discountTax",553],"(",")",";",["T_WHITESPACE","\n        ",553],["T_VARIABLE","$includeInSubtotal",554],["T_WHITESPACE"," ",554],"=",["T_WHITESPACE"," ",554],["T_VARIABLE","$this",554],["T_OBJECT_OPERATOR","->",554],["T_STRING","_getHelper",554],"(",["T_CONSTANT_ENCAPSED_STRING","'weee'",554],")",["T_OBJECT_OPERATOR","->",554],["T_STRING","includeInSubtotal",554],"(",")",";",["T_WHITESPACE","\n\n        ",554],["T_FOREACH","foreach",556],["T_WHITESPACE"," ",556],"(",["T_VARIABLE","$this",556],["T_OBJECT_OPERATOR","->",556],["T_STRING","_getRules",556],"(",")",["T_WHITESPACE"," ",556],["T_AS","as",556],["T_WHITESPACE"," ",556],["T_VARIABLE","$rule",556],")",["T_WHITESPACE"," ",556],"{",["T_WHITESPACE","\n            ",556],["T_COMMENT","\/* @var $rule Mage_SalesRule_Model_Rule *\/",557],["T_WHITESPACE","\n            ",557],["T_VARIABLE","$rulePercent",558],["T_WHITESPACE"," ",558],"=",["T_WHITESPACE"," ",558],["T_STRING","min",558],"(",["T_LNUMBER","100",558],",",["T_WHITESPACE"," ",558],["T_VARIABLE","$rule",558],["T_OBJECT_OPERATOR","->",558],["T_STRING","getDiscountAmount",558],"(",")",")",";",["T_WHITESPACE","\n            ",558],["T_SWITCH","switch",559],["T_WHITESPACE"," ",559],"(",["T_VARIABLE","$rule",559],["T_OBJECT_OPERATOR","->",559],["T_STRING","getSimpleAction",559],"(",")",")",["T_WHITESPACE"," ",559],"{",["T_WHITESPACE","\n                ",559],["T_CASE","case",560],["T_WHITESPACE"," ",560],["T_STRING","Mage_SalesRule_Model_Rule",560],["T_DOUBLE_COLON","::",560],["T_STRING","TO_PERCENT_ACTION",560],":",["T_WHITESPACE","\n                    ",560],["T_VARIABLE","$rulePercent",561],["T_WHITESPACE"," ",561],"=",["T_WHITESPACE"," ",561],["T_STRING","max",561],"(",["T_LNUMBER","0",561],",",["T_WHITESPACE"," ",561],["T_LNUMBER","100",561],["T_WHITESPACE"," ",561],"-",["T_WHITESPACE"," ",561],["T_VARIABLE","$rule",561],["T_OBJECT_OPERATOR","->",561],["T_STRING","getDiscountAmount",561],"(",")",")",";",["T_WHITESPACE","\n                ",561],["T_CASE","case",562],["T_WHITESPACE"," ",562],["T_STRING","Mage_SalesRule_Model_Rule",562],["T_DOUBLE_COLON","::",562],["T_STRING","BY_PERCENT_ACTION",562],":",["T_WHITESPACE","\n                    ",562],["T_FOREACH","foreach",563],["T_WHITESPACE"," ",563],"(",["T_VARIABLE","$items",563],["T_WHITESPACE"," ",563],["T_AS","as",563],["T_WHITESPACE"," ",563],["T_VARIABLE","$item",563],")",["T_WHITESPACE"," ",563],"{",["T_WHITESPACE","\n\n                        ",563],["T_VARIABLE","$weeeTaxAppliedAmounts",565],["T_WHITESPACE"," ",565],"=",["T_WHITESPACE"," ",565],["T_VARIABLE","$this",565],["T_OBJECT_OPERATOR","->",565],["T_STRING","_getHelper",565],"(",["T_CONSTANT_ENCAPSED_STRING","'weee'",565],")",["T_OBJECT_OPERATOR","->",565],["T_STRING","getApplied",565],"(",["T_VARIABLE","$item",565],")",";",["T_WHITESPACE","\n\n                        ",565],["T_COMMENT","\/\/Total weee discount for the item\n",567],["T_WHITESPACE","                        ",568],["T_VARIABLE","$totalWeeeDiscount",568],["T_WHITESPACE"," ",568],"=",["T_WHITESPACE"," ",568],["T_LNUMBER","0",568],";",["T_WHITESPACE","\n                        ",568],["T_VARIABLE","$totalBaseWeeeDiscount",569],["T_WHITESPACE"," ",569],"=",["T_WHITESPACE"," ",569],["T_LNUMBER","0",569],";",["T_WHITESPACE","\n\n                        ",569],["T_FOREACH","foreach",571],["T_WHITESPACE"," ",571],"(",["T_VARIABLE","$weeeTaxAppliedAmounts",571],["T_WHITESPACE"," ",571],["T_AS","as",571],["T_WHITESPACE"," ",571],["T_VARIABLE","$weeeTaxAppliedAmount",571],")",["T_WHITESPACE"," ",571],"{",["T_WHITESPACE","\n\n                            ",571],["T_COMMENT","\/* we get the discount by row since we dont need to display the individual amounts *\/",573],["T_WHITESPACE","\n                            ",573],["T_VARIABLE","$weeeTaxAppliedRowAmount",574],["T_WHITESPACE"," ",574],"=",["T_WHITESPACE"," ",574],["T_VARIABLE","$weeeTaxAppliedAmount",574],"[",["T_CONSTANT_ENCAPSED_STRING","'row_amount'",574],"]",";",["T_WHITESPACE","\n                            ",574],["T_VARIABLE","$baseWeeeTaxAppliedRowAmount",575],["T_WHITESPACE"," ",575],"=",["T_WHITESPACE"," ",575],["T_VARIABLE","$weeeTaxAppliedAmount",575],"[",["T_CONSTANT_ENCAPSED_STRING","'base_row_amount'",575],"]",";",["T_WHITESPACE","\n                            ",575],["T_VARIABLE","$request",576],["T_OBJECT_OPERATOR","->",576],["T_STRING","setProductClassId",576],"(",["T_VARIABLE","$item",576],["T_OBJECT_OPERATOR","->",576],["T_STRING","getProduct",576],"(",")",["T_OBJECT_OPERATOR","->",576],["T_STRING","getTaxClassId",576],"(",")",")",";",["T_WHITESPACE","\n                            ",576],["T_VARIABLE","$rate",577],["T_WHITESPACE"," ",577],"=",["T_WHITESPACE"," ",577],["T_VARIABLE","$calculator",577],["T_OBJECT_OPERATOR","->",577],["T_STRING","getRate",577],"(",["T_VARIABLE","$request",577],")",";",["T_WHITESPACE","\n\n                            ",577],["T_COMMENT","\/*\n                             * calculate weee discount\n                             *\/",579],["T_WHITESPACE","\n                            ",581],["T_VARIABLE","$weeeDiscount",582],["T_WHITESPACE"," ",582],"=",["T_WHITESPACE"," ",582],["T_LNUMBER","0",582],";",["T_WHITESPACE","\n                            ",582],["T_VARIABLE","$baseWeeeDiscount",583],["T_WHITESPACE"," ",583],"=",["T_WHITESPACE"," ",583],["T_LNUMBER","0",583],";",["T_WHITESPACE","\n\n                            ",583],["T_IF","if",585],["T_WHITESPACE"," ",585],"(",["T_VARIABLE","$this",585],["T_OBJECT_OPERATOR","->",585],["T_STRING","_getHelper",585],"(",["T_CONSTANT_ENCAPSED_STRING","'weee'",585],")",["T_OBJECT_OPERATOR","->",585],["T_STRING","isTaxable",585],"(",")",")",["T_WHITESPACE"," ",585],"{",["T_WHITESPACE","\n                                ",585],["T_IF","if",586],["T_WHITESPACE"," ",586],"(",["T_VARIABLE","$applyTaxAfterDiscount",586],")",["T_WHITESPACE"," ",586],"{",["T_WHITESPACE","\n                                    ",586],["T_IF","if",587],["T_WHITESPACE"," ",587],"(",["T_VARIABLE","$discountTax",587],")",["T_WHITESPACE"," ",587],"{",["T_WHITESPACE","\n                                        ",587],["T_VARIABLE","$weeeTax",588],["T_WHITESPACE"," ",588],"=",["T_WHITESPACE"," ",588],["T_VARIABLE","$weeeTaxAppliedRowAmount",588],["T_WHITESPACE"," ",588],"*",["T_WHITESPACE"," ",588],["T_VARIABLE","$rate",588],["T_WHITESPACE"," ",588],"\/",["T_WHITESPACE"," ",588],["T_LNUMBER","100",588],";",["T_WHITESPACE","\n                                        ",588],["T_VARIABLE","$baseWeeeTax",589],["T_WHITESPACE"," ",589],"=",["T_WHITESPACE"," ",589],["T_VARIABLE","$baseWeeeTaxAppliedRowAmount",589],["T_WHITESPACE"," ",589],"*",["T_WHITESPACE"," ",589],["T_VARIABLE","$rate",589],["T_WHITESPACE"," ",589],"\/",["T_WHITESPACE"," ",589],["T_LNUMBER","100",589],";",["T_WHITESPACE","\n                                        ",589],["T_VARIABLE","$weeeDiscount",590],["T_WHITESPACE"," ",590],"=",["T_WHITESPACE"," ",590],"(",["T_VARIABLE","$weeeTaxAppliedRowAmount",590],["T_WHITESPACE"," ",590],"+",["T_WHITESPACE"," ",590],["T_VARIABLE","$weeeTax",590],")",["T_WHITESPACE"," ",590],"*",["T_WHITESPACE"," ",590],["T_VARIABLE","$rulePercent",590],["T_WHITESPACE"," ",590],"\/",["T_WHITESPACE"," ",590],["T_LNUMBER","100",590],";",["T_WHITESPACE","\n                                        ",590],["T_VARIABLE","$baseWeeeDiscount",591],["T_WHITESPACE"," ",591],"=",["T_WHITESPACE"," ",591],"(",["T_VARIABLE","$baseWeeeTaxAppliedRowAmount",591],["T_WHITESPACE"," ",591],"+",["T_WHITESPACE"," ",591],["T_VARIABLE","$baseWeeeTax",591],")",["T_WHITESPACE","\n                                            ",591],"*",["T_WHITESPACE"," ",592],["T_VARIABLE","$rulePercent",592],["T_WHITESPACE"," ",592],"\/",["T_WHITESPACE"," ",592],["T_LNUMBER","100",592],";",["T_WHITESPACE","\n                                    ",592],"}",["T_WHITESPACE"," ",593],["T_ELSE","else",593],["T_WHITESPACE"," ",593],"{",["T_WHITESPACE","\n                                        ",593],["T_VARIABLE","$weeeDiscount",594],["T_WHITESPACE"," ",594],"=",["T_WHITESPACE"," ",594],["T_VARIABLE","$weeeTaxAppliedRowAmount",594],["T_WHITESPACE"," ",594],"*",["T_WHITESPACE"," ",594],["T_VARIABLE","$rulePercent",594],["T_WHITESPACE"," ",594],"\/",["T_WHITESPACE"," ",594],["T_LNUMBER","100",594],";",["T_WHITESPACE","\n                                        ",594],["T_VARIABLE","$baseWeeeDiscount",595],["T_WHITESPACE"," ",595],"=",["T_WHITESPACE"," ",595],["T_VARIABLE","$baseWeeeTaxAppliedRowAmount",595],["T_WHITESPACE"," ",595],"*",["T_WHITESPACE"," ",595],["T_VARIABLE","$rulePercent",595],["T_WHITESPACE"," ",595],"\/",["T_WHITESPACE"," ",595],["T_LNUMBER","100",595],";",["T_WHITESPACE","\n                                    ",595],"}",["T_WHITESPACE","\n                                ",596],"}",["T_WHITESPACE"," ",597],["T_ELSE","else",597],["T_WHITESPACE"," ",597],"{",["T_WHITESPACE","\n                                    ",597],["T_IF","if",598],["T_WHITESPACE"," ",598],"(",["T_VARIABLE","$discountTax",598],")",["T_WHITESPACE"," ",598],"{",["T_WHITESPACE","\n                                        ",598],["T_VARIABLE","$weeeTax",599],["T_WHITESPACE"," ",599],"=",["T_WHITESPACE"," ",599],["T_VARIABLE","$weeeTaxAppliedRowAmount",599],["T_WHITESPACE"," ",599],"*",["T_WHITESPACE"," ",599],["T_VARIABLE","$rate",599],["T_WHITESPACE"," ",599],"\/",["T_WHITESPACE"," ",599],["T_LNUMBER","100",599],";",["T_WHITESPACE","\n                                        ",599],["T_VARIABLE","$baseWeeeTax",600],["T_WHITESPACE"," ",600],"=",["T_WHITESPACE"," ",600],["T_VARIABLE","$baseWeeeTaxAppliedRowAmount",600],["T_WHITESPACE"," ",600],"*",["T_WHITESPACE"," ",600],["T_VARIABLE","$rate",600],["T_WHITESPACE"," ",600],"\/",["T_WHITESPACE"," ",600],["T_LNUMBER","100",600],";",["T_WHITESPACE","\n                                        ",600],["T_VARIABLE","$weeeDiscount",601],["T_WHITESPACE"," ",601],"=",["T_WHITESPACE"," ",601],"(",["T_VARIABLE","$weeeTaxAppliedRowAmount",601],["T_WHITESPACE"," ",601],"+",["T_WHITESPACE"," ",601],["T_VARIABLE","$weeeTax",601],")",["T_WHITESPACE"," ",601],"*",["T_WHITESPACE"," ",601],["T_VARIABLE","$rulePercent",601],["T_WHITESPACE"," ",601],"\/",["T_WHITESPACE"," ",601],["T_LNUMBER","100",601],";",["T_WHITESPACE","\n                                        ",601],["T_VARIABLE","$baseWeeeDiscount",602],["T_WHITESPACE"," ",602],"=",["T_WHITESPACE"," ",602],"(",["T_VARIABLE","$baseWeeeTaxAppliedRowAmount",602],["T_WHITESPACE"," ",602],"+",["T_WHITESPACE"," ",602],["T_VARIABLE","$baseWeeeTax",602],")",["T_WHITESPACE","\n                                            ",602],"*",["T_WHITESPACE"," ",603],["T_VARIABLE","$rulePercent",603],["T_WHITESPACE"," ",603],"\/",["T_WHITESPACE"," ",603],["T_LNUMBER","100",603],";",["T_WHITESPACE","\n                                    ",603],"}",["T_WHITESPACE"," ",604],["T_ELSE","else",604],["T_WHITESPACE"," ",604],"{",["T_WHITESPACE","\n                                        ",604],["T_VARIABLE","$weeeDiscount",605],["T_WHITESPACE"," ",605],"=",["T_WHITESPACE"," ",605],["T_VARIABLE","$weeeTaxAppliedRowAmount",605],["T_WHITESPACE"," ",605],"*",["T_WHITESPACE"," ",605],["T_VARIABLE","$rulePercent",605],["T_WHITESPACE"," ",605],"\/",["T_WHITESPACE"," ",605],["T_LNUMBER","100",605],";",["T_WHITESPACE","\n                                        ",605],["T_VARIABLE","$baseWeeeDiscount",606],["T_WHITESPACE"," ",606],"=",["T_WHITESPACE"," ",606],["T_VARIABLE","$baseWeeeTaxAppliedRowAmount",606],["T_WHITESPACE"," ",606],"*",["T_WHITESPACE"," ",606],["T_VARIABLE","$rulePercent",606],["T_WHITESPACE"," ",606],"\/",["T_WHITESPACE"," ",606],["T_LNUMBER","100",606],";",["T_WHITESPACE","\n                                    ",606],"}",["T_WHITESPACE","\n                                ",607],"}",["T_WHITESPACE","\n                            ",608],"}",["T_WHITESPACE"," ",609],["T_ELSE","else",609],["T_WHITESPACE"," ",609],"{",["T_WHITESPACE","\n                                ",609],["T_COMMENT","\/\/ weee is not taxable\n",610],["T_WHITESPACE","                                ",611],["T_VARIABLE","$weeeDiscount",611],["T_WHITESPACE"," ",611],"=",["T_WHITESPACE"," ",611],["T_VARIABLE","$weeeTaxAppliedRowAmount",611],["T_WHITESPACE"," ",611],"*",["T_WHITESPACE"," ",611],["T_VARIABLE","$rulePercent",611],["T_WHITESPACE"," ",611],"\/",["T_WHITESPACE"," ",611],["T_LNUMBER","100",611],";",["T_WHITESPACE","\n                                ",611],["T_VARIABLE","$baseWeeeDiscount",612],["T_WHITESPACE"," ",612],"=",["T_WHITESPACE"," ",612],["T_VARIABLE","$baseWeeeTaxAppliedRowAmount",612],["T_WHITESPACE"," ",612],"*",["T_WHITESPACE"," ",612],["T_VARIABLE","$rulePercent",612],["T_WHITESPACE"," ",612],"\/",["T_WHITESPACE"," ",612],["T_LNUMBER","100",612],";",["T_WHITESPACE","\n                            ",612],"}",["T_WHITESPACE","\n\n                            ",613],["T_IF","if",615],["T_WHITESPACE"," ",615],"(","!",["T_VARIABLE","$includeInSubtotal",615],")",["T_WHITESPACE"," ",615],"{",["T_WHITESPACE","\n                                ",615],["T_VARIABLE","$this",616],["T_OBJECT_OPERATOR","->",616],["T_STRING","_getHelper",616],"(",["T_CONSTANT_ENCAPSED_STRING","'weee'",616],")",["T_OBJECT_OPERATOR","->",616],["T_STRING","setWeeeTaxesAppliedProperty",616],"(",["T_WHITESPACE","\n                                    ",616],["T_VARIABLE","$item",617],",",["T_WHITESPACE"," ",617],["T_VARIABLE","$weeeTaxAppliedAmount",617],"[",["T_CONSTANT_ENCAPSED_STRING","'title'",617],"]",",",["T_WHITESPACE"," ",617],["T_CONSTANT_ENCAPSED_STRING","'weee_discount'",617],",",["T_WHITESPACE"," ",617],["T_VARIABLE","$weeeDiscount",617],")",";",["T_WHITESPACE","\n                                ",617],["T_VARIABLE","$this",618],["T_OBJECT_OPERATOR","->",618],["T_STRING","_getHelper",618],"(",["T_CONSTANT_ENCAPSED_STRING","'weee'",618],")",["T_OBJECT_OPERATOR","->",618],["T_STRING","setWeeeTaxesAppliedProperty",618],"(",["T_WHITESPACE","\n                                    ",618],["T_VARIABLE","$item",619],",",["T_WHITESPACE"," ",619],["T_VARIABLE","$weeeTaxAppliedAmount",619],"[",["T_CONSTANT_ENCAPSED_STRING","'title'",619],"]",",",["T_WHITESPACE"," ",619],["T_CONSTANT_ENCAPSED_STRING","'base_weee_discount'",619],",",["T_WHITESPACE"," ",619],["T_VARIABLE","$baseWeeeDiscount",619],")",";",["T_WHITESPACE","\n                            ",619],"}",["T_WHITESPACE","\n\n                            ",620],["T_COMMENT","\/\/Record the total weee discount\n",622],["T_WHITESPACE","                            ",623],["T_VARIABLE","$totalBaseWeeeDiscount",623],["T_WHITESPACE"," ",623],["T_PLUS_EQUAL","+=",623],["T_WHITESPACE"," ",623],["T_VARIABLE","$baseWeeeDiscount",623],";",["T_WHITESPACE","\n                            ",623],["T_VARIABLE","$totalWeeeDiscount",624],["T_WHITESPACE"," ",624],["T_PLUS_EQUAL","+=",624],["T_WHITESPACE"," ",624],["T_VARIABLE","$weeeDiscount",624],";",["T_WHITESPACE","\n                        ",624],"}",["T_WHITESPACE","\n\n                        ",625],["T_IF","if",627],["T_WHITESPACE"," ",627],"(","!",["T_VARIABLE","$totalBaseWeeeDiscount",627],["T_WHITESPACE"," ",627],["T_BOOLEAN_AND","&&",627],["T_WHITESPACE"," ",627],"!",["T_VARIABLE","$totalWeeeDiscount",627],")",["T_WHITESPACE"," ",627],"{",["T_WHITESPACE","\n                            ",627],["T_COMMENT","\/\/skip further processing if there is no weee discount associated with the item\n",628],["T_WHITESPACE","                            ",629],["T_CONTINUE","continue",629],";",["T_WHITESPACE","\n                        ",629],"}",["T_WHITESPACE","\n\n                        ",630],["T_VARIABLE","$discountPercentage",632],["T_WHITESPACE"," ",632],"=",["T_WHITESPACE"," ",632],["T_VARIABLE","$item",632],["T_OBJECT_OPERATOR","->",632],["T_STRING","getDiscountPercent",632],"(",")",";",["T_WHITESPACE","\n\n                        ",632],["T_VARIABLE","$totalWeeeDiscount",634],["T_WHITESPACE"," ",634],"=",["T_WHITESPACE"," ",634],["T_VARIABLE","$this",634],["T_OBJECT_OPERATOR","->",634],["T_STRING","_roundWithDeltas",634],"(",["T_VARIABLE","$discountPercentage",634],",",["T_WHITESPACE","\n                            ",634],["T_VARIABLE","$totalWeeeDiscount",635],",",["T_WHITESPACE"," ",635],["T_VARIABLE","$quote",635],["T_OBJECT_OPERATOR","->",635],["T_STRING","getStore",635],"(",")",")",";",["T_WHITESPACE","\n                        ",635],["T_VARIABLE","$totalBaseWeeeDiscount",636],["T_WHITESPACE"," ",636],"=",["T_WHITESPACE"," ",636],["T_VARIABLE","$this",636],["T_OBJECT_OPERATOR","->",636],["T_STRING","_roundWithDeltasForBase",636],"(",["T_VARIABLE","$discountPercentage",636],",",["T_WHITESPACE","\n                            ",636],["T_VARIABLE","$totalBaseWeeeDiscount",637],",",["T_WHITESPACE"," ",637],["T_VARIABLE","$quote",637],["T_OBJECT_OPERATOR","->",637],["T_STRING","getStore",637],"(",")",")",";",["T_WHITESPACE","\n\n                        ",637],["T_VARIABLE","$item",639],["T_OBJECT_OPERATOR","->",639],["T_STRING","setWeeeDiscount",639],"(",["T_VARIABLE","$totalWeeeDiscount",639],")",";",["T_WHITESPACE","\n                        ",639],["T_VARIABLE","$item",640],["T_OBJECT_OPERATOR","->",640],["T_STRING","setBaseWeeeDiscount",640],"(",["T_VARIABLE","$totalBaseWeeeDiscount",640],")",";",["T_WHITESPACE","\n\n                        ",640],["T_COMMENT","\/\/Set the total discount replicated on all weee attributes.\n",642],["T_WHITESPACE","                        ",643],["T_COMMENT","\/\/we need to do this as the mage_sales_order_item does not store the weee discount\n",643],["T_WHITESPACE","                        ",644],["T_COMMENT","\/\/We need to store this as we want to keep the rounded amounts\n",644],["T_WHITESPACE","                        ",645],["T_IF","if",645],["T_WHITESPACE"," ",645],"(","!",["T_VARIABLE","$includeInSubtotal",645],")",["T_WHITESPACE"," ",645],"{",["T_WHITESPACE","\n                            ",645],["T_VARIABLE","$this",646],["T_OBJECT_OPERATOR","->",646],["T_STRING","_getHelper",646],"(",["T_CONSTANT_ENCAPSED_STRING","'weee'",646],")",["T_OBJECT_OPERATOR","->",646],["T_STRING","setWeeeTaxesAppliedProperty",646],"(",["T_WHITESPACE","\n                                ",646],["T_VARIABLE","$item",647],",",["T_WHITESPACE"," ",647],["T_STRING","null",647],",",["T_WHITESPACE"," ",647],["T_CONSTANT_ENCAPSED_STRING","'total_base_weee_discount'",647],",",["T_WHITESPACE"," ",647],["T_VARIABLE","$totalBaseWeeeDiscount",647],")",";",["T_WHITESPACE","\n                            ",647],["T_VARIABLE","$this",648],["T_OBJECT_OPERATOR","->",648],["T_STRING","_getHelper",648],"(",["T_CONSTANT_ENCAPSED_STRING","'weee'",648],")",["T_OBJECT_OPERATOR","->",648],["T_STRING","setWeeeTaxesAppliedProperty",648],"(",["T_WHITESPACE","\n                                ",648],["T_VARIABLE","$item",649],",",["T_WHITESPACE"," ",649],["T_STRING","null",649],",",["T_WHITESPACE"," ",649],["T_CONSTANT_ENCAPSED_STRING","'total_weee_discount'",649],",",["T_WHITESPACE"," ",649],["T_VARIABLE","$totalWeeeDiscount",649],")",";",["T_WHITESPACE","\n                        ",649],"}",["T_WHITESPACE","\n\n                        ",650],["T_IF","if",652],["T_WHITESPACE"," ",652],"(",["T_VARIABLE","$includeInSubtotal",652],")",["T_WHITESPACE"," ",652],"{",["T_WHITESPACE","\n                            ",652],["T_VARIABLE","$item",653],["T_OBJECT_OPERATOR","->",653],["T_STRING","setDiscountAmount",653],"(",["T_VARIABLE","$item",653],["T_OBJECT_OPERATOR","->",653],["T_STRING","getDiscountAmount",653],"(",")",["T_WHITESPACE"," ",653],"+",["T_WHITESPACE"," ",653],["T_VARIABLE","$totalWeeeDiscount",653],")",";",["T_WHITESPACE","\n                            ",653],["T_VARIABLE","$item",654],["T_OBJECT_OPERATOR","->",654],["T_STRING","setBaseDiscountAmount",654],"(",["T_VARIABLE","$item",654],["T_OBJECT_OPERATOR","->",654],["T_STRING","getBaseDiscountAmount",654],"(",")",["T_WHITESPACE"," ",654],"+",["T_WHITESPACE"," ",654],["T_VARIABLE","$totalBaseWeeeDiscount",654],")",";",["T_WHITESPACE","\n                            ",654],["T_VARIABLE","$address",655],["T_OBJECT_OPERATOR","->",655],["T_STRING","addTotalAmount",655],"(",["T_CONSTANT_ENCAPSED_STRING","'discount'",655],",",["T_WHITESPACE"," ",655],"-",["T_VARIABLE","$totalWeeeDiscount",655],")",";",["T_WHITESPACE","\n                            ",655],["T_VARIABLE","$address",656],["T_OBJECT_OPERATOR","->",656],["T_STRING","addBaseTotalAmount",656],"(",["T_CONSTANT_ENCAPSED_STRING","'discount'",656],",",["T_WHITESPACE"," ",656],"-",["T_VARIABLE","$totalBaseWeeeDiscount",656],")",";",["T_WHITESPACE","\n                        ",656],"}",["T_WHITESPACE"," ",657],["T_ELSE","else",657],["T_WHITESPACE"," ",657],"{",["T_WHITESPACE","\n                            ",657],["T_IF","if",658],["T_WHITESPACE"," ",658],"(",["T_VARIABLE","$applyTaxAfterDiscount",658],")",["T_WHITESPACE"," ",658],"{",["T_WHITESPACE","\n                                ",658],["T_VARIABLE","$address",659],["T_OBJECT_OPERATOR","->",659],["T_STRING","setExtraTaxAmount",659],"(",["T_VARIABLE","$address",659],["T_OBJECT_OPERATOR","->",659],["T_STRING","getExtraTaxAmount",659],"(",")",["T_WHITESPACE"," ",659],"-",["T_WHITESPACE"," ",659],["T_VARIABLE","$totalWeeeDiscount",659],")",";",["T_WHITESPACE","\n                                ",659],["T_VARIABLE","$address",660],["T_OBJECT_OPERATOR","->",660],["T_STRING","setBaseExtraTaxAmount",660],"(",["T_WHITESPACE","\n                                    ",660],["T_VARIABLE","$address",661],["T_OBJECT_OPERATOR","->",661],["T_STRING","getBaseExtraTaxAmount",661],"(",")",["T_WHITESPACE"," ",661],"-",["T_WHITESPACE"," ",661],["T_VARIABLE","$totalBaseWeeeDiscount",661],")",";",["T_WHITESPACE","\n                                ",661],["T_VARIABLE","$address",662],["T_OBJECT_OPERATOR","->",662],["T_STRING","setWeeeDiscount",662],"(",["T_VARIABLE","$address",662],["T_OBJECT_OPERATOR","->",662],["T_STRING","getWeeeDiscount",662],"(",")",["T_WHITESPACE"," ",662],"+",["T_WHITESPACE"," ",662],["T_VARIABLE","$totalWeeeDiscount",662],")",";",["T_WHITESPACE","\n                                ",662],["T_VARIABLE","$address",663],["T_OBJECT_OPERATOR","->",663],["T_STRING","setBaseWeeeDiscount",663],"(",["T_VARIABLE","$address",663],["T_OBJECT_OPERATOR","->",663],["T_STRING","getBaseWeeeDiscount",663],"(",")",["T_WHITESPACE"," ",663],"+",["T_WHITESPACE"," ",663],["T_VARIABLE","$totalBaseWeeeDiscount",663],")",";",["T_WHITESPACE","\n                            ",663],"}",["T_WHITESPACE"," ",664],["T_ELSE","else",664],["T_WHITESPACE"," ",664],"{",["T_WHITESPACE","\n                                ",664],["T_COMMENT","\/\/tax has already been calculated, we need to remove weeeDiscount from total tax\n",665],["T_WHITESPACE","                                ",666],["T_VARIABLE","$address",666],["T_OBJECT_OPERATOR","->",666],["T_STRING","setExtraTaxAmount",666],"(",["T_VARIABLE","$address",666],["T_OBJECT_OPERATOR","->",666],["T_STRING","getExtraTaxAmount",666],"(",")",["T_WHITESPACE"," ",666],"-",["T_WHITESPACE"," ",666],["T_VARIABLE","$totalWeeeDiscount",666],")",";",["T_WHITESPACE","\n                                ",666],["T_VARIABLE","$address",667],["T_OBJECT_OPERATOR","->",667],["T_STRING","setBaseExtraTaxAmount",667],"(",["T_WHITESPACE","\n                                    ",667],["T_VARIABLE","$address",668],["T_OBJECT_OPERATOR","->",668],["T_STRING","getBaseExtraTaxAmount",668],"(",")",["T_WHITESPACE"," ",668],"-",["T_WHITESPACE"," ",668],["T_VARIABLE","$totalBaseWeeeDiscount",668],")",";",["T_WHITESPACE","\n                                ",668],["T_VARIABLE","$address",669],["T_OBJECT_OPERATOR","->",669],["T_STRING","addTotalAmount",669],"(",["T_CONSTANT_ENCAPSED_STRING","'tax'",669],",",["T_WHITESPACE"," ",669],"-",["T_VARIABLE","$totalWeeeDiscount",669],")",";",["T_WHITESPACE","\n                                ",669],["T_VARIABLE","$address",670],["T_OBJECT_OPERATOR","->",670],["T_STRING","addBaseTotalAmount",670],"(",["T_CONSTANT_ENCAPSED_STRING","'tax'",670],",",["T_WHITESPACE"," ",670],"-",["T_VARIABLE","$totalBaseWeeeDiscount",670],")",";",["T_WHITESPACE","\n                                ",670],["T_VARIABLE","$address",671],["T_OBJECT_OPERATOR","->",671],["T_STRING","setWeeeDiscount",671],"(",["T_VARIABLE","$address",671],["T_OBJECT_OPERATOR","->",671],["T_STRING","getWeeeDiscount",671],"(",")",["T_WHITESPACE"," ",671],"+",["T_WHITESPACE"," ",671],["T_VARIABLE","$totalWeeeDiscount",671],")",";",["T_WHITESPACE","\n                                ",671],["T_VARIABLE","$address",672],["T_OBJECT_OPERATOR","->",672],["T_STRING","setBaseWeeeDiscount",672],"(",["T_VARIABLE","$address",672],["T_OBJECT_OPERATOR","->",672],["T_STRING","getBaseWeeeDiscount",672],"(",")",["T_WHITESPACE"," ",672],"+",["T_WHITESPACE"," ",672],["T_VARIABLE","$totalBaseWeeeDiscount",672],")",";",["T_WHITESPACE","\n                            ",672],"}",["T_WHITESPACE","\n                        ",673],"}",["T_WHITESPACE","\n\n                        ",674],["T_BREAK","break",676],";",["T_WHITESPACE","\n                    ",676],"}",["T_WHITESPACE","\n            ",677],"}",["T_WHITESPACE","\n        ",678],"}",["T_WHITESPACE","\n        ",679],["T_RETURN","return",680],["T_WHITESPACE"," ",680],["T_VARIABLE","$this",680],";",["T_WHITESPACE","\n    ",680],"}",["T_WHITESPACE","\n\n    ",681],["T_DOC_COMMENT","\/**\n     * Round the amount with deltas collected\n     *\n     * @param string $key\n     * @param float $amount\n     * @param Mage_Core_Model_Store $store\n     * @return float\n     *\/",683],["T_WHITESPACE","\n    ",690],["T_PROTECTED","protected",691],["T_WHITESPACE"," ",691],["T_FUNCTION","function",691],["T_WHITESPACE"," ",691],["T_STRING","_roundWithDeltas",691],"(",["T_VARIABLE","$key",691],",",["T_WHITESPACE"," ",691],["T_VARIABLE","$amount",691],",",["T_WHITESPACE"," ",691],["T_VARIABLE","$store",691],")",["T_WHITESPACE","\n    ",691],"{",["T_WHITESPACE","\n        ",692],["T_VARIABLE","$delta",693],["T_WHITESPACE"," ",693],"=",["T_WHITESPACE"," ",693],["T_ISSET","isset",693],"(",["T_VARIABLE","$this",693],["T_OBJECT_OPERATOR","->",693],["T_STRING","_roundingDeltas",693],"[",["T_VARIABLE","$key",693],"]",")",["T_WHITESPACE"," ",693],"?",["T_WHITESPACE","\n            ",693],["T_VARIABLE","$this",694],["T_OBJECT_OPERATOR","->",694],["T_STRING","_roundingDeltas",694],"[",["T_VARIABLE","$key",694],"]",["T_WHITESPACE"," ",694],":",["T_WHITESPACE"," ",694],["T_LNUMBER","0",694],";",["T_WHITESPACE","\n        ",694],["T_VARIABLE","$this",695],["T_OBJECT_OPERATOR","->",695],["T_STRING","_roundingDeltas",695],"[",["T_VARIABLE","$key",695],"]",["T_WHITESPACE"," ",695],"=",["T_WHITESPACE"," ",695],["T_VARIABLE","$store",695],["T_OBJECT_OPERATOR","->",695],["T_STRING","roundPrice",695],"(",["T_VARIABLE","$amount",695],["T_WHITESPACE"," ",695],"+",["T_WHITESPACE"," ",695],["T_VARIABLE","$delta",695],")",["T_WHITESPACE","\n            ",695],"-",["T_WHITESPACE"," ",696],["T_VARIABLE","$amount",696],";",["T_WHITESPACE","\n        ",696],["T_RETURN","return",697],["T_WHITESPACE"," ",697],["T_VARIABLE","$store",697],["T_OBJECT_OPERATOR","->",697],["T_STRING","roundPrice",697],"(",["T_VARIABLE","$amount",697],["T_WHITESPACE"," ",697],"+",["T_WHITESPACE"," ",697],["T_VARIABLE","$delta",697],")",";",["T_WHITESPACE","\n    ",697],"}",["T_WHITESPACE","\n\n    ",698],["T_DOC_COMMENT","\/**\n     * Round the amount with deltas collected\n     *\n     * @param string $key\n     * @param float $amount\n     * @param Mage_Core_Model_Store $store\n     * @return float\n     *\/",700],["T_WHITESPACE","\n    ",707],["T_PROTECTED","protected",708],["T_WHITESPACE"," ",708],["T_FUNCTION","function",708],["T_WHITESPACE"," ",708],["T_STRING","_roundWithDeltasForBase",708],"(",["T_VARIABLE","$key",708],",",["T_WHITESPACE"," ",708],["T_VARIABLE","$amount",708],",",["T_WHITESPACE"," ",708],["T_VARIABLE","$store",708],")",["T_WHITESPACE","\n    ",708],"{",["T_WHITESPACE","\n        ",709],["T_VARIABLE","$delta",710],["T_WHITESPACE"," ",710],"=",["T_WHITESPACE"," ",710],["T_ISSET","isset",710],"(",["T_VARIABLE","$this",710],["T_OBJECT_OPERATOR","->",710],["T_STRING","_baseRoundingDeltas",710],"[",["T_VARIABLE","$key",710],"]",")",["T_WHITESPACE"," ",710],"?",["T_WHITESPACE","\n            ",710],["T_VARIABLE","$this",711],["T_OBJECT_OPERATOR","->",711],["T_STRING","_roundingDeltas",711],"[",["T_VARIABLE","$key",711],"]",["T_WHITESPACE"," ",711],":",["T_WHITESPACE"," ",711],["T_LNUMBER","0",711],";",["T_WHITESPACE","\n        ",711],["T_VARIABLE","$this",712],["T_OBJECT_OPERATOR","->",712],["T_STRING","_baseRoundingDeltas",712],"[",["T_VARIABLE","$key",712],"]",["T_WHITESPACE"," ",712],"=",["T_WHITESPACE"," ",712],["T_VARIABLE","$store",712],["T_OBJECT_OPERATOR","->",712],["T_STRING","roundPrice",712],"(",["T_VARIABLE","$amount",712],["T_WHITESPACE"," ",712],"+",["T_WHITESPACE"," ",712],["T_VARIABLE","$delta",712],")",["T_WHITESPACE","\n            ",712],"-",["T_WHITESPACE"," ",713],["T_VARIABLE","$amount",713],";",["T_WHITESPACE","\n        ",713],["T_RETURN","return",714],["T_WHITESPACE"," ",714],["T_VARIABLE","$store",714],["T_OBJECT_OPERATOR","->",714],["T_STRING","roundPrice",714],"(",["T_VARIABLE","$amount",714],["T_WHITESPACE"," ",714],"+",["T_WHITESPACE"," ",714],["T_VARIABLE","$delta",714],")",";",["T_WHITESPACE","\n    ",714],"}",["T_WHITESPACE","\n\n    ",715],["T_DOC_COMMENT","\/**\n     * Apply discounts to shipping amount\n     *\n     * @param   Mage_Sales_Model_Quote_Address $address\n     * @return  Mage_SalesRule_Model_Validator\n     *\/",717],["T_WHITESPACE","\n    ",722],["T_PUBLIC","public",723],["T_WHITESPACE"," ",723],["T_FUNCTION","function",723],["T_WHITESPACE"," ",723],["T_STRING","processShippingAmount",723],"(",["T_STRING","Mage_Sales_Model_Quote_Address",723],["T_WHITESPACE"," ",723],["T_VARIABLE","$address",723],")",["T_WHITESPACE","\n    ",723],"{",["T_WHITESPACE","\n        ",724],["T_VARIABLE","$shippingAmount",725],["T_WHITESPACE"," ",725],"=",["T_WHITESPACE"," ",725],["T_VARIABLE","$address",725],["T_OBJECT_OPERATOR","->",725],["T_STRING","getShippingAmountForDiscount",725],"(",")",";",["T_WHITESPACE","\n        ",725],["T_IF","if",726],["T_WHITESPACE"," ",726],"(",["T_VARIABLE","$shippingAmount",726],["T_WHITESPACE"," ",726],["T_IS_NOT_IDENTICAL","!==",726],["T_WHITESPACE"," ",726],["T_STRING","null",726],")",["T_WHITESPACE"," ",726],"{",["T_WHITESPACE","\n            ",726],["T_VARIABLE","$baseShippingAmount",727],["T_WHITESPACE"," ",727],"=",["T_WHITESPACE"," ",727],["T_VARIABLE","$address",727],["T_OBJECT_OPERATOR","->",727],["T_STRING","getBaseShippingAmountForDiscount",727],"(",")",";",["T_WHITESPACE","\n        ",727],"}",["T_WHITESPACE"," ",728],["T_ELSE","else",728],["T_WHITESPACE"," ",728],"{",["T_WHITESPACE","\n            ",728],["T_VARIABLE","$shippingAmount",729],["T_WHITESPACE","     ",729],"=",["T_WHITESPACE"," ",729],["T_VARIABLE","$address",729],["T_OBJECT_OPERATOR","->",729],["T_STRING","getShippingAmount",729],"(",")",";",["T_WHITESPACE","\n            ",729],["T_VARIABLE","$baseShippingAmount",730],["T_WHITESPACE"," ",730],"=",["T_WHITESPACE"," ",730],["T_VARIABLE","$address",730],["T_OBJECT_OPERATOR","->",730],["T_STRING","getBaseShippingAmount",730],"(",")",";",["T_WHITESPACE","\n        ",730],"}",["T_WHITESPACE","\n        ",731],["T_VARIABLE","$quote",732],["T_WHITESPACE","              ",732],"=",["T_WHITESPACE"," ",732],["T_VARIABLE","$address",732],["T_OBJECT_OPERATOR","->",732],["T_STRING","getQuote",732],"(",")",";",["T_WHITESPACE","\n        ",732],["T_VARIABLE","$appliedRuleIds",733],["T_WHITESPACE"," ",733],"=",["T_WHITESPACE"," ",733],["T_ARRAY","array",733],"(",")",";",["T_WHITESPACE","\n        ",733],["T_FOREACH","foreach",734],["T_WHITESPACE"," ",734],"(",["T_VARIABLE","$this",734],["T_OBJECT_OPERATOR","->",734],["T_STRING","_getRules",734],"(",")",["T_WHITESPACE"," ",734],["T_AS","as",734],["T_WHITESPACE"," ",734],["T_VARIABLE","$rule",734],")",["T_WHITESPACE"," ",734],"{",["T_WHITESPACE","\n            ",734],["T_COMMENT","\/* @var $rule Mage_SalesRule_Model_Rule *\/",735],["T_WHITESPACE","\n            ",735],["T_IF","if",736],["T_WHITESPACE"," ",736],"(","!",["T_VARIABLE","$rule",736],["T_OBJECT_OPERATOR","->",736],["T_STRING","getApplyToShipping",736],"(",")",["T_WHITESPACE"," ",736],["T_BOOLEAN_OR","||",736],["T_WHITESPACE"," ",736],"!",["T_VARIABLE","$this",736],["T_OBJECT_OPERATOR","->",736],["T_STRING","_canProcessRule",736],"(",["T_VARIABLE","$rule",736],",",["T_WHITESPACE"," ",736],["T_VARIABLE","$address",736],")",")",["T_WHITESPACE"," ",736],"{",["T_WHITESPACE","\n                ",736],["T_CONTINUE","continue",737],";",["T_WHITESPACE","\n            ",737],"}",["T_WHITESPACE","\n\n            ",738],["T_VARIABLE","$discountAmount",740],["T_WHITESPACE"," ",740],"=",["T_WHITESPACE"," ",740],["T_LNUMBER","0",740],";",["T_WHITESPACE","\n            ",740],["T_VARIABLE","$baseDiscountAmount",741],["T_WHITESPACE"," ",741],"=",["T_WHITESPACE"," ",741],["T_LNUMBER","0",741],";",["T_WHITESPACE","\n            ",741],["T_VARIABLE","$rulePercent",742],["T_WHITESPACE"," ",742],"=",["T_WHITESPACE"," ",742],["T_STRING","min",742],"(",["T_LNUMBER","100",742],",",["T_WHITESPACE"," ",742],["T_VARIABLE","$rule",742],["T_OBJECT_OPERATOR","->",742],["T_STRING","getDiscountAmount",742],"(",")",")",";",["T_WHITESPACE","\n            ",742],["T_SWITCH","switch",743],["T_WHITESPACE"," ",743],"(",["T_VARIABLE","$rule",743],["T_OBJECT_OPERATOR","->",743],["T_STRING","getSimpleAction",743],"(",")",")",["T_WHITESPACE"," ",743],"{",["T_WHITESPACE","\n                ",743],["T_CASE","case",744],["T_WHITESPACE"," ",744],["T_STRING","Mage_SalesRule_Model_Rule",744],["T_DOUBLE_COLON","::",744],["T_STRING","TO_PERCENT_ACTION",744],":",["T_WHITESPACE","\n                    ",744],["T_VARIABLE","$rulePercent",745],["T_WHITESPACE"," ",745],"=",["T_WHITESPACE"," ",745],["T_STRING","max",745],"(",["T_LNUMBER","0",745],",",["T_WHITESPACE"," ",745],["T_LNUMBER","100",745],"-",["T_VARIABLE","$rule",745],["T_OBJECT_OPERATOR","->",745],["T_STRING","getDiscountAmount",745],"(",")",")",";",["T_WHITESPACE","\n                ",745],["T_CASE","case",746],["T_WHITESPACE"," ",746],["T_STRING","Mage_SalesRule_Model_Rule",746],["T_DOUBLE_COLON","::",746],["T_STRING","BY_PERCENT_ACTION",746],":",["T_WHITESPACE","\n                    ",746],["T_VARIABLE","$discountAmount",747],["T_WHITESPACE","    ",747],"=",["T_WHITESPACE"," ",747],"(",["T_VARIABLE","$shippingAmount",747],["T_WHITESPACE"," ",747],"-",["T_WHITESPACE"," ",747],["T_VARIABLE","$address",747],["T_OBJECT_OPERATOR","->",747],["T_STRING","getShippingDiscountAmount",747],"(",")",")",["T_WHITESPACE"," ",747],"*",["T_WHITESPACE"," ",747],["T_VARIABLE","$rulePercent",747],"\/",["T_LNUMBER","100",747],";",["T_WHITESPACE","\n                    ",747],["T_VARIABLE","$baseDiscountAmount",748],["T_WHITESPACE"," ",748],"=",["T_WHITESPACE"," ",748],"(",["T_VARIABLE","$baseShippingAmount",748],["T_WHITESPACE"," ",748],"-",["T_WHITESPACE","\n                        ",748],["T_VARIABLE","$address",749],["T_OBJECT_OPERATOR","->",749],["T_STRING","getBaseShippingDiscountAmount",749],"(",")",")",["T_WHITESPACE"," ",749],"*",["T_WHITESPACE"," ",749],["T_VARIABLE","$rulePercent",749],"\/",["T_LNUMBER","100",749],";",["T_WHITESPACE","\n                    ",749],["T_VARIABLE","$discountPercent",750],["T_WHITESPACE"," ",750],"=",["T_WHITESPACE"," ",750],["T_STRING","min",750],"(",["T_LNUMBER","100",750],",",["T_WHITESPACE"," ",750],["T_VARIABLE","$address",750],["T_OBJECT_OPERATOR","->",750],["T_STRING","getShippingDiscountPercent",750],"(",")","+",["T_VARIABLE","$rulePercent",750],")",";",["T_WHITESPACE","\n                    ",750],["T_VARIABLE","$address",751],["T_OBJECT_OPERATOR","->",751],["T_STRING","setShippingDiscountPercent",751],"(",["T_VARIABLE","$discountPercent",751],")",";",["T_WHITESPACE","\n                    ",751],["T_BREAK","break",752],";",["T_WHITESPACE","\n                ",752],["T_CASE","case",753],["T_WHITESPACE"," ",753],["T_STRING","Mage_SalesRule_Model_Rule",753],["T_DOUBLE_COLON","::",753],["T_STRING","TO_FIXED_ACTION",753],":",["T_WHITESPACE","\n                    ",753],["T_VARIABLE","$quoteAmount",754],["T_WHITESPACE"," ",754],"=",["T_WHITESPACE"," ",754],["T_VARIABLE","$quote",754],["T_OBJECT_OPERATOR","->",754],["T_STRING","getStore",754],"(",")",["T_OBJECT_OPERATOR","->",754],["T_STRING","convertPrice",754],"(",["T_VARIABLE","$rule",754],["T_OBJECT_OPERATOR","->",754],["T_STRING","getDiscountAmount",754],"(",")",")",";",["T_WHITESPACE","\n                    ",754],["T_VARIABLE","$discountAmount",755],["T_WHITESPACE","    ",755],"=",["T_WHITESPACE"," ",755],["T_VARIABLE","$shippingAmount",755],"-",["T_VARIABLE","$quoteAmount",755],";",["T_WHITESPACE","\n                    ",755],["T_VARIABLE","$baseDiscountAmount",756],["T_WHITESPACE"," ",756],"=",["T_WHITESPACE"," ",756],["T_VARIABLE","$baseShippingAmount",756],"-",["T_VARIABLE","$rule",756],["T_OBJECT_OPERATOR","->",756],["T_STRING","getDiscountAmount",756],"(",")",";",["T_WHITESPACE","\n                    ",756],["T_BREAK","break",757],";",["T_WHITESPACE","\n                ",757],["T_CASE","case",758],["T_WHITESPACE"," ",758],["T_STRING","Mage_SalesRule_Model_Rule",758],["T_DOUBLE_COLON","::",758],["T_STRING","BY_FIXED_ACTION",758],":",["T_WHITESPACE","\n                    ",758],["T_VARIABLE","$quoteAmount",759],["T_WHITESPACE","        ",759],"=",["T_WHITESPACE"," ",759],["T_VARIABLE","$quote",759],["T_OBJECT_OPERATOR","->",759],["T_STRING","getStore",759],"(",")",["T_OBJECT_OPERATOR","->",759],["T_STRING","convertPrice",759],"(",["T_VARIABLE","$rule",759],["T_OBJECT_OPERATOR","->",759],["T_STRING","getDiscountAmount",759],"(",")",")",";",["T_WHITESPACE","\n                    ",759],["T_VARIABLE","$discountAmount",760],["T_WHITESPACE","     ",760],"=",["T_WHITESPACE"," ",760],["T_VARIABLE","$quoteAmount",760],";",["T_WHITESPACE","\n                    ",760],["T_VARIABLE","$baseDiscountAmount",761],["T_WHITESPACE"," ",761],"=",["T_WHITESPACE"," ",761],["T_VARIABLE","$rule",761],["T_OBJECT_OPERATOR","->",761],["T_STRING","getDiscountAmount",761],"(",")",";",["T_WHITESPACE","\n                    ",761],["T_BREAK","break",762],";",["T_WHITESPACE","\n                ",762],["T_CASE","case",763],["T_WHITESPACE"," ",763],["T_STRING","Mage_SalesRule_Model_Rule",763],["T_DOUBLE_COLON","::",763],["T_STRING","CART_FIXED_ACTION",763],":",["T_WHITESPACE","\n                    ",763],["T_VARIABLE","$cartRules",764],["T_WHITESPACE"," ",764],"=",["T_WHITESPACE"," ",764],["T_VARIABLE","$address",764],["T_OBJECT_OPERATOR","->",764],["T_STRING","getCartFixedRules",764],"(",")",";",["T_WHITESPACE","\n                    ",764],["T_IF","if",765],["T_WHITESPACE"," ",765],"(","!",["T_ISSET","isset",765],"(",["T_VARIABLE","$cartRules",765],"[",["T_VARIABLE","$rule",765],["T_OBJECT_OPERATOR","->",765],["T_STRING","getId",765],"(",")","]",")",")",["T_WHITESPACE"," ",765],"{",["T_WHITESPACE","\n                        ",765],["T_VARIABLE","$cartRules",766],"[",["T_VARIABLE","$rule",766],["T_OBJECT_OPERATOR","->",766],["T_STRING","getId",766],"(",")","]",["T_WHITESPACE"," ",766],"=",["T_WHITESPACE"," ",766],["T_VARIABLE","$rule",766],["T_OBJECT_OPERATOR","->",766],["T_STRING","getDiscountAmount",766],"(",")",";",["T_WHITESPACE","\n                    ",766],"}",["T_WHITESPACE","\n                    ",767],["T_IF","if",768],["T_WHITESPACE"," ",768],"(",["T_VARIABLE","$cartRules",768],"[",["T_VARIABLE","$rule",768],["T_OBJECT_OPERATOR","->",768],["T_STRING","getId",768],"(",")","]",["T_WHITESPACE"," ",768],">",["T_WHITESPACE"," ",768],["T_LNUMBER","0",768],")",["T_WHITESPACE"," ",768],"{",["T_WHITESPACE","\n                        ",768],["T_VARIABLE","$quoteAmount",769],["T_WHITESPACE","        ",769],"=",["T_WHITESPACE"," ",769],["T_VARIABLE","$quote",769],["T_OBJECT_OPERATOR","->",769],["T_STRING","getStore",769],"(",")",["T_OBJECT_OPERATOR","->",769],["T_STRING","convertPrice",769],"(",["T_VARIABLE","$cartRules",769],"[",["T_VARIABLE","$rule",769],["T_OBJECT_OPERATOR","->",769],["T_STRING","getId",769],"(",")","]",")",";",["T_WHITESPACE","\n                        ",769],["T_VARIABLE","$discountAmount",770],["T_WHITESPACE","     ",770],"=",["T_WHITESPACE"," ",770],["T_STRING","min",770],"(",["T_WHITESPACE","\n                            ",770],["T_VARIABLE","$shippingAmount",771],"-",["T_VARIABLE","$address",771],["T_OBJECT_OPERATOR","->",771],["T_STRING","getShippingDiscountAmount",771],"(",")",",",["T_WHITESPACE","\n                            ",771],["T_VARIABLE","$quoteAmount",772],["T_WHITESPACE","\n                        ",772],")",";",["T_WHITESPACE","\n                        ",773],["T_VARIABLE","$baseDiscountAmount",774],["T_WHITESPACE"," ",774],"=",["T_WHITESPACE"," ",774],["T_STRING","min",774],"(",["T_WHITESPACE","\n                            ",774],["T_VARIABLE","$baseShippingAmount",775],"-",["T_VARIABLE","$address",775],["T_OBJECT_OPERATOR","->",775],["T_STRING","getBaseShippingDiscountAmount",775],"(",")",",",["T_WHITESPACE","\n                            ",775],["T_VARIABLE","$cartRules",776],"[",["T_VARIABLE","$rule",776],["T_OBJECT_OPERATOR","->",776],["T_STRING","getId",776],"(",")","]",["T_WHITESPACE","\n                        ",776],")",";",["T_WHITESPACE","\n                        ",777],["T_VARIABLE","$cartRules",778],"[",["T_VARIABLE","$rule",778],["T_OBJECT_OPERATOR","->",778],["T_STRING","getId",778],"(",")","]",["T_WHITESPACE"," ",778],["T_MINUS_EQUAL","-=",778],["T_WHITESPACE"," ",778],["T_VARIABLE","$baseDiscountAmount",778],";",["T_WHITESPACE","\n                    ",778],"}",["T_WHITESPACE","\n\n                    ",779],["T_VARIABLE","$address",781],["T_OBJECT_OPERATOR","->",781],["T_STRING","setCartFixedRules",781],"(",["T_VARIABLE","$cartRules",781],")",";",["T_WHITESPACE","\n                    ",781],["T_BREAK","break",782],";",["T_WHITESPACE","\n            ",782],"}",["T_WHITESPACE","\n\n            ",783],["T_VARIABLE","$discountAmount",785],["T_WHITESPACE","     ",785],"=",["T_WHITESPACE"," ",785],["T_STRING","min",785],"(",["T_VARIABLE","$address",785],["T_OBJECT_OPERATOR","->",785],["T_STRING","getShippingDiscountAmount",785],"(",")","+",["T_VARIABLE","$discountAmount",785],",",["T_WHITESPACE"," ",785],["T_VARIABLE","$shippingAmount",785],")",";",["T_WHITESPACE","\n            ",785],["T_VARIABLE","$baseDiscountAmount",786],["T_WHITESPACE"," ",786],"=",["T_WHITESPACE"," ",786],["T_STRING","min",786],"(",["T_WHITESPACE","\n                ",786],["T_VARIABLE","$address",787],["T_OBJECT_OPERATOR","->",787],["T_STRING","getBaseShippingDiscountAmount",787],"(",")","+",["T_VARIABLE","$baseDiscountAmount",787],",",["T_WHITESPACE","\n                ",787],["T_VARIABLE","$baseShippingAmount",788],["T_WHITESPACE","\n            ",788],")",";",["T_WHITESPACE","\n            ",789],["T_VARIABLE","$address",790],["T_OBJECT_OPERATOR","->",790],["T_STRING","setShippingDiscountAmount",790],"(",["T_VARIABLE","$discountAmount",790],")",";",["T_WHITESPACE","\n            ",790],["T_VARIABLE","$address",791],["T_OBJECT_OPERATOR","->",791],["T_STRING","setBaseShippingDiscountAmount",791],"(",["T_VARIABLE","$baseDiscountAmount",791],")",";",["T_WHITESPACE","\n            ",791],["T_VARIABLE","$appliedRuleIds",792],"[",["T_VARIABLE","$rule",792],["T_OBJECT_OPERATOR","->",792],["T_STRING","getRuleId",792],"(",")","]",["T_WHITESPACE"," ",792],"=",["T_WHITESPACE"," ",792],["T_VARIABLE","$rule",792],["T_OBJECT_OPERATOR","->",792],["T_STRING","getRuleId",792],"(",")",";",["T_WHITESPACE","\n\n            ",792],["T_VARIABLE","$this",794],["T_OBJECT_OPERATOR","->",794],["T_STRING","_maintainAddressCouponCode",794],"(",["T_VARIABLE","$address",794],",",["T_WHITESPACE"," ",794],["T_VARIABLE","$rule",794],")",";",["T_WHITESPACE","\n            ",794],["T_VARIABLE","$this",795],["T_OBJECT_OPERATOR","->",795],["T_STRING","_addDiscountDescription",795],"(",["T_VARIABLE","$address",795],",",["T_WHITESPACE"," ",795],["T_VARIABLE","$rule",795],")",";",["T_WHITESPACE","\n            ",795],["T_IF","if",796],["T_WHITESPACE"," ",796],"(",["T_VARIABLE","$rule",796],["T_OBJECT_OPERATOR","->",796],["T_STRING","getStopRulesProcessing",796],"(",")",")",["T_WHITESPACE"," ",796],"{",["T_WHITESPACE","\n                ",796],["T_BREAK","break",797],";",["T_WHITESPACE","\n            ",797],"}",["T_WHITESPACE","\n        ",798],"}",["T_WHITESPACE","\n\n        ",799],["T_VARIABLE","$address",801],["T_OBJECT_OPERATOR","->",801],["T_STRING","setAppliedRuleIds",801],"(",["T_VARIABLE","$this",801],["T_OBJECT_OPERATOR","->",801],["T_STRING","mergeIds",801],"(",["T_VARIABLE","$address",801],["T_OBJECT_OPERATOR","->",801],["T_STRING","getAppliedRuleIds",801],"(",")",",",["T_WHITESPACE"," ",801],["T_VARIABLE","$appliedRuleIds",801],")",")",";",["T_WHITESPACE","\n        ",801],["T_VARIABLE","$quote",802],["T_OBJECT_OPERATOR","->",802],["T_STRING","setAppliedRuleIds",802],"(",["T_VARIABLE","$this",802],["T_OBJECT_OPERATOR","->",802],["T_STRING","mergeIds",802],"(",["T_VARIABLE","$quote",802],["T_OBJECT_OPERATOR","->",802],["T_STRING","getAppliedRuleIds",802],"(",")",",",["T_WHITESPACE"," ",802],["T_VARIABLE","$appliedRuleIds",802],")",")",";",["T_WHITESPACE","\n\n        ",802],["T_RETURN","return",804],["T_WHITESPACE"," ",804],["T_VARIABLE","$this",804],";",["T_WHITESPACE","\n    ",804],"}",["T_WHITESPACE","\n\n    ",805],["T_DOC_COMMENT","\/**\n     * Merge two sets of ids\n     *\n     * @param array|string $a1\n     * @param array|string $a2\n     * @param bool $asString\n     * @return array\n     *\/",807],["T_WHITESPACE","\n    ",814],["T_PUBLIC","public",815],["T_WHITESPACE"," ",815],["T_FUNCTION","function",815],["T_WHITESPACE"," ",815],["T_STRING","mergeIds",815],"(",["T_VARIABLE","$a1",815],",",["T_WHITESPACE"," ",815],["T_VARIABLE","$a2",815],",",["T_WHITESPACE"," ",815],["T_VARIABLE","$asString",815],["T_WHITESPACE"," ",815],"=",["T_WHITESPACE"," ",815],["T_STRING","true",815],")",["T_WHITESPACE","\n    ",815],"{",["T_WHITESPACE","\n        ",816],["T_IF","if",817],["T_WHITESPACE"," ",817],"(","!",["T_STRING","is_array",817],"(",["T_VARIABLE","$a1",817],")",")",["T_WHITESPACE"," ",817],"{",["T_WHITESPACE","\n            ",817],["T_VARIABLE","$a1",818],["T_WHITESPACE"," ",818],"=",["T_WHITESPACE"," ",818],["T_EMPTY","empty",818],"(",["T_VARIABLE","$a1",818],")",["T_WHITESPACE"," ",818],"?",["T_WHITESPACE"," ",818],["T_ARRAY","array",818],"(",")",["T_WHITESPACE"," ",818],":",["T_WHITESPACE"," ",818],["T_STRING","explode",818],"(",["T_CONSTANT_ENCAPSED_STRING","','",818],",",["T_WHITESPACE"," ",818],["T_VARIABLE","$a1",818],")",";",["T_WHITESPACE","\n        ",818],"}",["T_WHITESPACE","\n        ",819],["T_IF","if",820],["T_WHITESPACE"," ",820],"(","!",["T_STRING","is_array",820],"(",["T_VARIABLE","$a2",820],")",")",["T_WHITESPACE"," ",820],"{",["T_WHITESPACE","\n            ",820],["T_VARIABLE","$a2",821],["T_WHITESPACE"," ",821],"=",["T_WHITESPACE"," ",821],["T_EMPTY","empty",821],"(",["T_VARIABLE","$a2",821],")",["T_WHITESPACE"," ",821],"?",["T_WHITESPACE"," ",821],["T_ARRAY","array",821],"(",")",["T_WHITESPACE"," ",821],":",["T_WHITESPACE"," ",821],["T_STRING","explode",821],"(",["T_CONSTANT_ENCAPSED_STRING","','",821],",",["T_WHITESPACE"," ",821],["T_VARIABLE","$a2",821],")",";",["T_WHITESPACE","\n        ",821],"}",["T_WHITESPACE","\n        ",822],["T_VARIABLE","$a",823],["T_WHITESPACE"," ",823],"=",["T_WHITESPACE"," ",823],["T_STRING","array_unique",823],"(",["T_STRING","array_merge",823],"(",["T_VARIABLE","$a1",823],",",["T_WHITESPACE"," ",823],["T_VARIABLE","$a2",823],")",")",";",["T_WHITESPACE","\n        ",823],["T_IF","if",824],["T_WHITESPACE"," ",824],"(",["T_VARIABLE","$asString",824],")",["T_WHITESPACE"," ",824],"{",["T_WHITESPACE","\n            ",824],["T_VARIABLE","$a",825],["T_WHITESPACE"," ",825],"=",["T_WHITESPACE"," ",825],["T_STRING","implode",825],"(",["T_CONSTANT_ENCAPSED_STRING","','",825],",",["T_WHITESPACE"," ",825],["T_VARIABLE","$a",825],")",";",["T_WHITESPACE","\n        ",825],"}",["T_WHITESPACE","\n        ",826],["T_RETURN","return",827],["T_WHITESPACE"," ",827],["T_VARIABLE","$a",827],";",["T_WHITESPACE","\n    ",827],"}",["T_WHITESPACE","\n\n    ",828],["T_DOC_COMMENT","\/**\n     * Set information about usage cart fixed rule by quote address\n     *\n     * @param int $ruleId\n     * @param int $itemId\n     * @return void\n     *\/",830],["T_WHITESPACE","\n    ",836],["T_PUBLIC","public",837],["T_WHITESPACE"," ",837],["T_FUNCTION","function",837],["T_WHITESPACE"," ",837],["T_STRING","setCartFixedRuleUsedForAddress",837],"(",["T_VARIABLE","$ruleId",837],",",["T_WHITESPACE"," ",837],["T_VARIABLE","$itemId",837],")",["T_WHITESPACE","\n    ",837],"{",["T_WHITESPACE","\n        ",838],["T_VARIABLE","$this",839],["T_OBJECT_OPERATOR","->",839],["T_STRING","_cartFixedRuleUsedForAddress",839],"[",["T_VARIABLE","$ruleId",839],"]",["T_WHITESPACE"," ",839],"=",["T_WHITESPACE"," ",839],["T_VARIABLE","$itemId",839],";",["T_WHITESPACE","\n    ",839],"}",["T_WHITESPACE","\n\n    ",840],["T_DOC_COMMENT","\/**\n     * Retrieve information about usage cart fixed rule by quote address\n     *\n     * @param int $ruleId\n     * @return int|null\n     *\/",842],["T_WHITESPACE","\n    ",847],["T_PUBLIC","public",848],["T_WHITESPACE"," ",848],["T_FUNCTION","function",848],["T_WHITESPACE"," ",848],["T_STRING","getCartFixedRuleUsedForAddress",848],"(",["T_VARIABLE","$ruleId",848],")",["T_WHITESPACE","\n    ",848],"{",["T_WHITESPACE","\n        ",849],["T_IF","if",850],["T_WHITESPACE"," ",850],"(",["T_ISSET","isset",850],"(",["T_VARIABLE","$this",850],["T_OBJECT_OPERATOR","->",850],["T_STRING","_cartFixedRuleUsedForAddress",850],"[",["T_VARIABLE","$ruleId",850],"]",")",")",["T_WHITESPACE"," ",850],"{",["T_WHITESPACE","\n            ",850],["T_RETURN","return",851],["T_WHITESPACE"," ",851],["T_VARIABLE","$this",851],["T_OBJECT_OPERATOR","->",851],["T_STRING","_cartFixedRuleUsedForAddress",851],"[",["T_VARIABLE","$ruleId",851],"]",";",["T_WHITESPACE","\n        ",851],"}",["T_WHITESPACE","\n        ",852],["T_RETURN","return",853],["T_WHITESPACE"," ",853],["T_STRING","null",853],";",["T_WHITESPACE","\n    ",853],"}",["T_WHITESPACE","\n\n    ",854],["T_DOC_COMMENT","\/**\n     * Calculate quote totals for each rule and save results\n     *\n     * @param mixed $items\n     * @param Mage_Sales_Model_Quote_Address $address\n     * @return Mage_SalesRule_Model_Validator\n     *\/",856],["T_WHITESPACE","\n    ",862],["T_PUBLIC","public",863],["T_WHITESPACE"," ",863],["T_FUNCTION","function",863],["T_WHITESPACE"," ",863],["T_STRING","initTotals",863],"(",["T_VARIABLE","$items",863],",",["T_WHITESPACE"," ",863],["T_STRING","Mage_Sales_Model_Quote_Address",863],["T_WHITESPACE"," ",863],["T_VARIABLE","$address",863],")",["T_WHITESPACE","\n    ",863],"{",["T_WHITESPACE","\n        ",864],["T_VARIABLE","$address",865],["T_OBJECT_OPERATOR","->",865],["T_STRING","setCartFixedRules",865],"(",["T_ARRAY","array",865],"(",")",")",";",["T_WHITESPACE","\n\n        ",865],["T_IF","if",867],["T_WHITESPACE"," ",867],"(","!",["T_VARIABLE","$items",867],")",["T_WHITESPACE"," ",867],"{",["T_WHITESPACE","\n            ",867],["T_RETURN","return",868],["T_WHITESPACE"," ",868],["T_VARIABLE","$this",868],";",["T_WHITESPACE","\n        ",868],"}",["T_WHITESPACE","\n\n        ",869],["T_FOREACH","foreach",871],["T_WHITESPACE"," ",871],"(",["T_VARIABLE","$this",871],["T_OBJECT_OPERATOR","->",871],["T_STRING","_getRules",871],"(",")",["T_WHITESPACE"," ",871],["T_AS","as",871],["T_WHITESPACE"," ",871],["T_VARIABLE","$rule",871],")",["T_WHITESPACE"," ",871],"{",["T_WHITESPACE","\n            ",871],["T_IF","if",872],["T_WHITESPACE"," ",872],"(",["T_STRING","Mage_SalesRule_Model_Rule",872],["T_DOUBLE_COLON","::",872],["T_STRING","CART_FIXED_ACTION",872],["T_WHITESPACE"," ",872],["T_IS_EQUAL","==",872],["T_WHITESPACE"," ",872],["T_VARIABLE","$rule",872],["T_OBJECT_OPERATOR","->",872],["T_STRING","getSimpleAction",872],"(",")",["T_WHITESPACE","\n                ",872],["T_BOOLEAN_AND","&&",873],["T_WHITESPACE"," ",873],["T_VARIABLE","$this",873],["T_OBJECT_OPERATOR","->",873],["T_STRING","_canProcessRule",873],"(",["T_VARIABLE","$rule",873],",",["T_WHITESPACE"," ",873],["T_VARIABLE","$address",873],")",")",["T_WHITESPACE"," ",873],"{",["T_WHITESPACE","\n\n                ",873],["T_VARIABLE","$ruleTotalItemsPrice",875],["T_WHITESPACE"," ",875],"=",["T_WHITESPACE"," ",875],["T_LNUMBER","0",875],";",["T_WHITESPACE","\n                ",875],["T_VARIABLE","$ruleTotalBaseItemsPrice",876],["T_WHITESPACE"," ",876],"=",["T_WHITESPACE"," ",876],["T_LNUMBER","0",876],";",["T_WHITESPACE","\n                ",876],["T_VARIABLE","$validItemsCount",877],["T_WHITESPACE"," ",877],"=",["T_WHITESPACE"," ",877],["T_LNUMBER","0",877],";",["T_WHITESPACE","\n\n                ",877],["T_FOREACH","foreach",879],["T_WHITESPACE"," ",879],"(",["T_VARIABLE","$items",879],["T_WHITESPACE"," ",879],["T_AS","as",879],["T_WHITESPACE"," ",879],["T_VARIABLE","$item",879],")",["T_WHITESPACE"," ",879],"{",["T_WHITESPACE","\n                    ",879],["T_COMMENT","\/\/Skipping child items to avoid double calculations\n",880],["T_WHITESPACE","                    ",881],["T_IF","if",881],["T_WHITESPACE"," ",881],"(",["T_VARIABLE","$item",881],["T_OBJECT_OPERATOR","->",881],["T_STRING","getParentItemId",881],"(",")",")",["T_WHITESPACE"," ",881],"{",["T_WHITESPACE","\n                        ",881],["T_CONTINUE","continue",882],";",["T_WHITESPACE","\n                    ",882],"}",["T_WHITESPACE","\n                    ",883],["T_IF","if",884],["T_WHITESPACE"," ",884],"(","!",["T_VARIABLE","$rule",884],["T_OBJECT_OPERATOR","->",884],["T_STRING","getActions",884],"(",")",["T_OBJECT_OPERATOR","->",884],["T_STRING","validate",884],"(",["T_VARIABLE","$item",884],")",")",["T_WHITESPACE"," ",884],"{",["T_WHITESPACE","\n                        ",884],["T_CONTINUE","continue",885],";",["T_WHITESPACE","\n                    ",885],"}",["T_WHITESPACE","\n                    ",886],["T_VARIABLE","$qty",887],["T_WHITESPACE"," ",887],"=",["T_WHITESPACE"," ",887],["T_VARIABLE","$this",887],["T_OBJECT_OPERATOR","->",887],["T_STRING","_getItemQty",887],"(",["T_VARIABLE","$item",887],",",["T_WHITESPACE"," ",887],["T_VARIABLE","$rule",887],")",";",["T_WHITESPACE","\n                    ",887],["T_VARIABLE","$ruleTotalItemsPrice",888],["T_WHITESPACE"," ",888],["T_PLUS_EQUAL","+=",888],["T_WHITESPACE"," ",888],["T_VARIABLE","$this",888],["T_OBJECT_OPERATOR","->",888],["T_STRING","_getItemPrice",888],"(",["T_VARIABLE","$item",888],")",["T_WHITESPACE"," ",888],"*",["T_WHITESPACE"," ",888],["T_VARIABLE","$qty",888],";",["T_WHITESPACE","\n                    ",888],["T_VARIABLE","$ruleTotalBaseItemsPrice",889],["T_WHITESPACE"," ",889],["T_PLUS_EQUAL","+=",889],["T_WHITESPACE"," ",889],["T_VARIABLE","$this",889],["T_OBJECT_OPERATOR","->",889],["T_STRING","_getItemBasePrice",889],"(",["T_VARIABLE","$item",889],")",["T_WHITESPACE"," ",889],"*",["T_WHITESPACE"," ",889],["T_VARIABLE","$qty",889],";",["T_WHITESPACE","\n                    ",889],["T_VARIABLE","$validItemsCount",890],["T_INC","++",890],";",["T_WHITESPACE","\n                ",890],"}",["T_WHITESPACE","\n\n                ",891],["T_VARIABLE","$this",893],["T_OBJECT_OPERATOR","->",893],["T_STRING","_rulesItemTotals",893],"[",["T_VARIABLE","$rule",893],["T_OBJECT_OPERATOR","->",893],["T_STRING","getId",893],"(",")","]",["T_WHITESPACE"," ",893],"=",["T_WHITESPACE"," ",893],["T_ARRAY","array",893],"(",["T_WHITESPACE","\n                    ",893],["T_CONSTANT_ENCAPSED_STRING","'items_price'",894],["T_WHITESPACE"," ",894],["T_DOUBLE_ARROW","=>",894],["T_WHITESPACE"," ",894],["T_VARIABLE","$ruleTotalItemsPrice",894],",",["T_WHITESPACE","\n                    ",894],["T_CONSTANT_ENCAPSED_STRING","'base_items_price'",895],["T_WHITESPACE"," ",895],["T_DOUBLE_ARROW","=>",895],["T_WHITESPACE"," ",895],["T_VARIABLE","$ruleTotalBaseItemsPrice",895],",",["T_WHITESPACE","\n                    ",895],["T_CONSTANT_ENCAPSED_STRING","'items_count'",896],["T_WHITESPACE"," ",896],["T_DOUBLE_ARROW","=>",896],["T_WHITESPACE"," ",896],["T_VARIABLE","$validItemsCount",896],",",["T_WHITESPACE","\n                ",896],")",";",["T_WHITESPACE","\n            ",897],"}",["T_WHITESPACE","\n        ",898],"}",["T_WHITESPACE","\n        ",899],["T_VARIABLE","$this",900],["T_OBJECT_OPERATOR","->",900],["T_STRING","_stopFurtherRules",900],["T_WHITESPACE"," ",900],"=",["T_WHITESPACE"," ",900],["T_STRING","false",900],";",["T_WHITESPACE","\n        ",900],["T_RETURN","return",901],["T_WHITESPACE"," ",901],["T_VARIABLE","$this",901],";",["T_WHITESPACE","\n    ",901],"}",["T_WHITESPACE","\n\n    ",902],["T_DOC_COMMENT","\/**\n     * Set coupon code to address if $rule contains validated coupon\n     *\n     * @param  Mage_Sales_Model_Quote_Address $address\n     * @param  Mage_SalesRule_Model_Rule $rule\n     *\n     * @return Mage_SalesRule_Model_Validator\n     *\/",904],["T_WHITESPACE","\n    ",911],["T_PROTECTED","protected",912],["T_WHITESPACE"," ",912],["T_FUNCTION","function",912],["T_WHITESPACE"," ",912],["T_STRING","_maintainAddressCouponCode",912],"(",["T_VARIABLE","$address",912],",",["T_WHITESPACE"," ",912],["T_VARIABLE","$rule",912],")",["T_WHITESPACE","\n    ",912],"{",["T_WHITESPACE","\n        ",913],["T_COMMENT","\/*\n        Rule is a part of rules collection, which includes only rules with 'No Coupon' type or with validated coupon.\n        As a result, if rule uses coupon code(s) ('Specific' or 'Auto' Coupon Type), it always contains validated\n        coupon\n        *\/",914],["T_WHITESPACE","\n        ",918],["T_IF","if",919],["T_WHITESPACE"," ",919],"(",["T_VARIABLE","$rule",919],["T_OBJECT_OPERATOR","->",919],["T_STRING","getCouponType",919],"(",")",["T_WHITESPACE"," ",919],["T_IS_NOT_EQUAL","!=",919],["T_WHITESPACE"," ",919],["T_STRING","Mage_SalesRule_Model_Rule",919],["T_DOUBLE_COLON","::",919],["T_STRING","COUPON_TYPE_NO_COUPON",919],")",["T_WHITESPACE"," ",919],"{",["T_WHITESPACE","\n            ",919],["T_VARIABLE","$address",920],["T_OBJECT_OPERATOR","->",920],["T_STRING","setCouponCode",920],"(",["T_VARIABLE","$this",920],["T_OBJECT_OPERATOR","->",920],["T_STRING","getCouponCode",920],"(",")",")",";",["T_WHITESPACE","\n        ",920],"}",["T_WHITESPACE","\n\n        ",921],["T_RETURN","return",923],["T_WHITESPACE"," ",923],["T_VARIABLE","$this",923],";",["T_WHITESPACE","\n    ",923],"}",["T_WHITESPACE","\n\n    ",924],["T_DOC_COMMENT","\/**\n     * Add rule discount description label to address object\n     *\n     * @param   Mage_Sales_Model_Quote_Address $address\n     * @param   Mage_SalesRule_Model_Rule $rule\n     * @return  Mage_SalesRule_Model_Validator\n     *\/",926],["T_WHITESPACE","\n    ",932],["T_PROTECTED","protected",933],["T_WHITESPACE"," ",933],["T_FUNCTION","function",933],["T_WHITESPACE"," ",933],["T_STRING","_addDiscountDescription",933],"(",["T_VARIABLE","$address",933],",",["T_WHITESPACE"," ",933],["T_VARIABLE","$rule",933],")",["T_WHITESPACE","\n    ",933],"{",["T_WHITESPACE","\n        ",934],["T_VARIABLE","$description",935],["T_WHITESPACE"," ",935],"=",["T_WHITESPACE"," ",935],["T_VARIABLE","$address",935],["T_OBJECT_OPERATOR","->",935],["T_STRING","getDiscountDescriptionArray",935],"(",")",";",["T_WHITESPACE","\n        ",935],["T_VARIABLE","$ruleLabel",936],["T_WHITESPACE"," ",936],"=",["T_WHITESPACE"," ",936],["T_VARIABLE","$rule",936],["T_OBJECT_OPERATOR","->",936],["T_STRING","getStoreLabel",936],"(",["T_VARIABLE","$address",936],["T_OBJECT_OPERATOR","->",936],["T_STRING","getQuote",936],"(",")",["T_OBJECT_OPERATOR","->",936],["T_STRING","getStore",936],"(",")",")",";",["T_WHITESPACE","\n        ",936],["T_VARIABLE","$label",937],["T_WHITESPACE"," ",937],"=",["T_WHITESPACE"," ",937],["T_CONSTANT_ENCAPSED_STRING","''",937],";",["T_WHITESPACE","\n        ",937],["T_IF","if",938],["T_WHITESPACE"," ",938],"(",["T_VARIABLE","$ruleLabel",938],")",["T_WHITESPACE"," ",938],"{",["T_WHITESPACE","\n            ",938],["T_VARIABLE","$label",939],["T_WHITESPACE"," ",939],"=",["T_WHITESPACE"," ",939],["T_VARIABLE","$ruleLabel",939],";",["T_WHITESPACE","\n        ",939],"}",["T_WHITESPACE"," ",940],["T_ELSE","else",940],["T_WHITESPACE"," ",940],["T_IF","if",940],["T_WHITESPACE"," ",940],"(",["T_STRING","strlen",940],"(",["T_VARIABLE","$address",940],["T_OBJECT_OPERATOR","->",940],["T_STRING","getCouponCode",940],"(",")",")",")",["T_WHITESPACE"," ",940],"{",["T_WHITESPACE","\n            ",940],["T_VARIABLE","$label",941],["T_WHITESPACE"," ",941],"=",["T_WHITESPACE"," ",941],["T_VARIABLE","$address",941],["T_OBJECT_OPERATOR","->",941],["T_STRING","getCouponCode",941],"(",")",";",["T_WHITESPACE","\n        ",941],"}",["T_WHITESPACE","\n\n        ",942],["T_IF","if",944],["T_WHITESPACE"," ",944],"(",["T_STRING","strlen",944],"(",["T_VARIABLE","$label",944],")",")",["T_WHITESPACE"," ",944],"{",["T_WHITESPACE","\n            ",944],["T_VARIABLE","$description",945],"[",["T_VARIABLE","$rule",945],["T_OBJECT_OPERATOR","->",945],["T_STRING","getId",945],"(",")","]",["T_WHITESPACE"," ",945],"=",["T_WHITESPACE"," ",945],["T_VARIABLE","$label",945],";",["T_WHITESPACE","\n        ",945],"}",["T_WHITESPACE","\n\n        ",946],["T_VARIABLE","$address",948],["T_OBJECT_OPERATOR","->",948],["T_STRING","setDiscountDescriptionArray",948],"(",["T_VARIABLE","$description",948],")",";",["T_WHITESPACE","\n\n        ",948],["T_RETURN","return",950],["T_WHITESPACE"," ",950],["T_VARIABLE","$this",950],";",["T_WHITESPACE","\n    ",950],"}",["T_WHITESPACE","\n\n    ",951],["T_DOC_COMMENT","\/**\n     * Return item price\n     *\n     * @param Mage_Sales_Model_Quote_Item_Abstract $item\n     * @return float\n     *\/",953],["T_WHITESPACE","\n    ",958],["T_PROTECTED","protected",959],["T_WHITESPACE"," ",959],["T_FUNCTION","function",959],["T_WHITESPACE"," ",959],["T_STRING","_getItemPrice",959],"(",["T_VARIABLE","$item",959],")",["T_WHITESPACE","\n    ",959],"{",["T_WHITESPACE","\n        ",960],["T_VARIABLE","$price",961],["T_WHITESPACE"," ",961],"=",["T_WHITESPACE"," ",961],["T_VARIABLE","$item",961],["T_OBJECT_OPERATOR","->",961],["T_STRING","getDiscountCalculationPrice",961],"(",")",";",["T_WHITESPACE","\n        ",961],["T_VARIABLE","$calcPrice",962],["T_WHITESPACE"," ",962],"=",["T_WHITESPACE"," ",962],["T_VARIABLE","$item",962],["T_OBJECT_OPERATOR","->",962],["T_STRING","getCalculationPrice",962],"(",")",";",["T_WHITESPACE","\n        ",962],["T_RETURN","return",963],["T_WHITESPACE"," ",963],"(",["T_VARIABLE","$price",963],["T_WHITESPACE"," ",963],["T_IS_NOT_IDENTICAL","!==",963],["T_WHITESPACE"," ",963],["T_STRING","null",963],")",["T_WHITESPACE"," ",963],"?",["T_WHITESPACE"," ",963],["T_VARIABLE","$price",963],["T_WHITESPACE"," ",963],":",["T_WHITESPACE"," ",963],["T_VARIABLE","$calcPrice",963],";",["T_WHITESPACE","\n    ",963],"}",["T_WHITESPACE","\n\n    ",964],["T_DOC_COMMENT","\/**\n     * Return item original price\n     *\n     * @param Mage_Sales_Model_Quote_Item_Abstract $item\n     * @return float\n     *\/",966],["T_WHITESPACE","\n    ",971],["T_PROTECTED","protected",972],["T_WHITESPACE"," ",972],["T_FUNCTION","function",972],["T_WHITESPACE"," ",972],["T_STRING","_getItemOriginalPrice",972],"(",["T_VARIABLE","$item",972],")",["T_WHITESPACE","\n    ",972],"{",["T_WHITESPACE","\n        ",973],["T_RETURN","return",974],["T_WHITESPACE"," ",974],["T_STRING","Mage",974],["T_DOUBLE_COLON","::",974],["T_STRING","helper",974],"(",["T_CONSTANT_ENCAPSED_STRING","'tax'",974],")",["T_OBJECT_OPERATOR","->",974],["T_STRING","getPrice",974],"(",["T_VARIABLE","$item",974],",",["T_WHITESPACE"," ",974],["T_VARIABLE","$item",974],["T_OBJECT_OPERATOR","->",974],["T_STRING","getOriginalPrice",974],"(",")",",",["T_WHITESPACE"," ",974],["T_STRING","true",974],")",";",["T_WHITESPACE","\n    ",974],"}",["T_WHITESPACE","\n\n    ",975],["T_DOC_COMMENT","\/**\n     * Return item base price\n     *\n     * @param Mage_Sales_Model_Quote_Item_Abstract $item\n     * @return float\n     *\/",977],["T_WHITESPACE","\n    ",982],["T_PROTECTED","protected",983],["T_WHITESPACE"," ",983],["T_FUNCTION","function",983],["T_WHITESPACE"," ",983],["T_STRING","_getItemBasePrice",983],"(",["T_VARIABLE","$item",983],")",["T_WHITESPACE","\n    ",983],"{",["T_WHITESPACE","\n        ",984],["T_VARIABLE","$price",985],["T_WHITESPACE"," ",985],"=",["T_WHITESPACE"," ",985],["T_VARIABLE","$item",985],["T_OBJECT_OPERATOR","->",985],["T_STRING","getDiscountCalculationPrice",985],"(",")",";",["T_WHITESPACE","\n        ",985],["T_RETURN","return",986],["T_WHITESPACE"," ",986],"(",["T_VARIABLE","$price",986],["T_WHITESPACE"," ",986],["T_IS_NOT_IDENTICAL","!==",986],["T_WHITESPACE"," ",986],["T_STRING","null",986],")",["T_WHITESPACE"," ",986],"?",["T_WHITESPACE"," ",986],["T_VARIABLE","$item",986],["T_OBJECT_OPERATOR","->",986],["T_STRING","getBaseDiscountCalculationPrice",986],"(",")",["T_WHITESPACE"," ",986],":",["T_WHITESPACE"," ",986],["T_VARIABLE","$item",986],["T_OBJECT_OPERATOR","->",986],["T_STRING","getBaseCalculationPrice",986],"(",")",";",["T_WHITESPACE","\n    ",986],"}",["T_WHITESPACE","\n\n    ",987],["T_DOC_COMMENT","\/**\n     * Return item base original price\n     *\n     * @param Mage_Sales_Model_Quote_Item_Abstract $item\n     * @return float\n     *\/",989],["T_WHITESPACE","\n    ",994],["T_PROTECTED","protected",995],["T_WHITESPACE"," ",995],["T_FUNCTION","function",995],["T_WHITESPACE"," ",995],["T_STRING","_getItemBaseOriginalPrice",995],"(",["T_VARIABLE","$item",995],")",["T_WHITESPACE","\n    ",995],"{",["T_WHITESPACE","\n        ",996],["T_RETURN","return",997],["T_WHITESPACE"," ",997],["T_STRING","Mage",997],["T_DOUBLE_COLON","::",997],["T_STRING","helper",997],"(",["T_CONSTANT_ENCAPSED_STRING","'tax'",997],")",["T_OBJECT_OPERATOR","->",997],["T_STRING","getPrice",997],"(",["T_VARIABLE","$item",997],",",["T_WHITESPACE"," ",997],["T_VARIABLE","$item",997],["T_OBJECT_OPERATOR","->",997],["T_STRING","getBaseOriginalPrice",997],"(",")",",",["T_WHITESPACE"," ",997],["T_STRING","true",997],")",";",["T_WHITESPACE","\n    ",997],"}",["T_WHITESPACE","\n\n    ",998],["T_DOC_COMMENT","\/**\n     * Return discount item qty\n     *\n     * @param Mage_Sales_Model_Quote_Item_Abstract $item\n     * @param Mage_SalesRule_Model_Rule $rule\n     * @return int\n     *\/",1000],["T_WHITESPACE","\n    ",1006],["T_PROTECTED","protected",1007],["T_WHITESPACE"," ",1007],["T_FUNCTION","function",1007],["T_WHITESPACE"," ",1007],["T_STRING","_getItemQty",1007],"(",["T_VARIABLE","$item",1007],",",["T_WHITESPACE"," ",1007],["T_VARIABLE","$rule",1007],")",["T_WHITESPACE","\n    ",1007],"{",["T_WHITESPACE","\n        ",1008],["T_VARIABLE","$qty",1009],["T_WHITESPACE"," ",1009],"=",["T_WHITESPACE"," ",1009],["T_VARIABLE","$item",1009],["T_OBJECT_OPERATOR","->",1009],["T_STRING","getTotalQty",1009],"(",")",";",["T_WHITESPACE","\n        ",1009],["T_RETURN","return",1010],["T_WHITESPACE"," ",1010],["T_VARIABLE","$rule",1010],["T_OBJECT_OPERATOR","->",1010],["T_STRING","getDiscountQty",1010],"(",")",["T_WHITESPACE"," ",1010],"?",["T_WHITESPACE"," ",1010],["T_STRING","min",1010],"(",["T_VARIABLE","$qty",1010],",",["T_WHITESPACE"," ",1010],["T_VARIABLE","$rule",1010],["T_OBJECT_OPERATOR","->",1010],["T_STRING","getDiscountQty",1010],"(",")",")",["T_WHITESPACE"," ",1010],":",["T_WHITESPACE"," ",1010],["T_VARIABLE","$qty",1010],";",["T_WHITESPACE","\n    ",1010],"}",["T_WHITESPACE","\n\n    ",1011],["T_DOC_COMMENT","\/**\n     * Convert address discount description array to string\n     *\n     * @param Mage_Sales_Model_Quote_Address $address\n     * @param string $separator\n     * @return Mage_SalesRule_Model_Validator\n     *\/",1013],["T_WHITESPACE","\n    ",1019],["T_PUBLIC","public",1020],["T_WHITESPACE"," ",1020],["T_FUNCTION","function",1020],["T_WHITESPACE"," ",1020],["T_STRING","prepareDescription",1020],"(",["T_VARIABLE","$address",1020],",",["T_WHITESPACE"," ",1020],["T_VARIABLE","$separator",1020],["T_WHITESPACE"," ",1020],"=",["T_WHITESPACE"," ",1020],["T_CONSTANT_ENCAPSED_STRING","', '",1020],")",["T_WHITESPACE","\n    ",1020],"{",["T_WHITESPACE","\n        ",1021],["T_VARIABLE","$descriptionArray",1022],["T_WHITESPACE"," ",1022],"=",["T_WHITESPACE"," ",1022],["T_VARIABLE","$address",1022],["T_OBJECT_OPERATOR","->",1022],["T_STRING","getDiscountDescriptionArray",1022],"(",")",";",["T_WHITESPACE","\n        ",1022],["T_DOC_COMMENT","\/** @see Mage_SalesRule_Model_Validator::_getAddress *\/",1023],["T_WHITESPACE","\n        ",1023],["T_IF","if",1024],["T_WHITESPACE"," ",1024],"(","!",["T_VARIABLE","$descriptionArray",1024],["T_WHITESPACE"," ",1024],["T_BOOLEAN_AND","&&",1024],["T_WHITESPACE"," ",1024],["T_VARIABLE","$address",1024],["T_OBJECT_OPERATOR","->",1024],["T_STRING","getQuote",1024],"(",")",["T_OBJECT_OPERATOR","->",1024],["T_STRING","getItemVirtualQty",1024],"(",")",["T_WHITESPACE"," ",1024],">",["T_WHITESPACE"," ",1024],["T_LNUMBER","0",1024],")",["T_WHITESPACE"," ",1024],"{",["T_WHITESPACE","\n            ",1024],["T_VARIABLE","$descriptionArray",1025],["T_WHITESPACE"," ",1025],"=",["T_WHITESPACE"," ",1025],["T_VARIABLE","$address",1025],["T_OBJECT_OPERATOR","->",1025],["T_STRING","getQuote",1025],"(",")",["T_OBJECT_OPERATOR","->",1025],["T_STRING","getBillingAddress",1025],"(",")",["T_OBJECT_OPERATOR","->",1025],["T_STRING","getDiscountDescriptionArray",1025],"(",")",";",["T_WHITESPACE","\n        ",1025],"}",["T_WHITESPACE","\n\n        ",1026],["T_VARIABLE","$description",1028],["T_WHITESPACE"," ",1028],"=",["T_WHITESPACE"," ",1028],["T_VARIABLE","$descriptionArray",1028],["T_WHITESPACE"," ",1028],["T_BOOLEAN_AND","&&",1028],["T_WHITESPACE"," ",1028],["T_STRING","is_array",1028],"(",["T_VARIABLE","$descriptionArray",1028],")",["T_WHITESPACE","\n            ",1028],"?",["T_WHITESPACE"," ",1029],["T_STRING","implode",1029],"(",["T_VARIABLE","$separator",1029],",",["T_WHITESPACE"," ",1029],["T_STRING","array_unique",1029],"(",["T_VARIABLE","$descriptionArray",1029],")",")",["T_WHITESPACE","\n            ",1029],":",["T_WHITESPACE","  ",1030],["T_CONSTANT_ENCAPSED_STRING","''",1030],";",["T_WHITESPACE","\n\n        ",1030],["T_VARIABLE","$address",1032],["T_OBJECT_OPERATOR","->",1032],["T_STRING","setDiscountDescription",1032],"(",["T_VARIABLE","$description",1032],")",";",["T_WHITESPACE","\n        ",1032],["T_RETURN","return",1033],["T_WHITESPACE"," ",1033],["T_VARIABLE","$this",1033],";",["T_WHITESPACE","\n    ",1033],"}",["T_WHITESPACE","\n\n    ",1034],["T_DOC_COMMENT","\/**\n     * wrap Mage::getSingleton\n     *\n     * @param string $name\n     * @return mixed\n     *\/",1036],["T_WHITESPACE","\n    ",1041],["T_PROTECTED","protected",1042],["T_WHITESPACE","  ",1042],["T_FUNCTION","function",1042],["T_WHITESPACE"," ",1042],["T_STRING","_getSingleton",1042],"(",["T_VARIABLE","$name",1042],")",["T_WHITESPACE"," ",1042],"{",["T_WHITESPACE","\n        ",1042],["T_RETURN","return",1043],["T_WHITESPACE"," ",1043],["T_STRING","Mage",1043],["T_DOUBLE_COLON","::",1043],["T_STRING","getSingleton",1043],"(",["T_VARIABLE","$name",1043],")",";",["T_WHITESPACE","\n    ",1043],"}",["T_WHITESPACE","\n\n    ",1044],["T_DOC_COMMENT","\/**\n     * wrap Mage::helper\n     *\n     * @param string $name\n     * @return Mage_Weee_Helper_Data\n     *\/",1046],["T_WHITESPACE","\n    ",1051],["T_PROTECTED","protected",1052],["T_WHITESPACE"," ",1052],["T_FUNCTION","function",1052],["T_WHITESPACE"," ",1052],["T_STRING","_getHelper",1052],"(",["T_VARIABLE","$name",1052],")",["T_WHITESPACE"," ",1052],"{",["T_WHITESPACE","\n        ",1052],["T_RETURN","return",1053],["T_WHITESPACE"," ",1053],["T_STRING","Mage",1053],["T_DOUBLE_COLON","::",1053],["T_STRING","helper",1053],"(",["T_VARIABLE","$name",1053],")",";",["T_WHITESPACE","\n    ",1053],"}",["T_WHITESPACE","\n\n    ",1054],["T_DOC_COMMENT","\/**\n     * Return items list sorted by possibility to apply prioritized rules\n     *\n     * @param array $items\n     * @return array $items\n     *\/",1056],["T_WHITESPACE","\n    ",1061],["T_PUBLIC","public",1062],["T_WHITESPACE"," ",1062],["T_FUNCTION","function",1062],["T_WHITESPACE"," ",1062],["T_STRING","sortItemsByPriority",1062],"(",["T_VARIABLE","$items",1062],")",["T_WHITESPACE","\n    ",1062],"{",["T_WHITESPACE","\n        ",1063],["T_VARIABLE","$itemsSorted",1064],["T_WHITESPACE"," ",1064],"=",["T_WHITESPACE"," ",1064],["T_ARRAY","array",1064],"(",")",";",["T_WHITESPACE","\n        ",1064],["T_FOREACH","foreach",1065],["T_WHITESPACE"," ",1065],"(",["T_VARIABLE","$this",1065],["T_OBJECT_OPERATOR","->",1065],["T_STRING","_getRules",1065],"(",")",["T_WHITESPACE"," ",1065],["T_AS","as",1065],["T_WHITESPACE"," ",1065],["T_VARIABLE","$rule",1065],")",["T_WHITESPACE"," ",1065],"{",["T_WHITESPACE","\n            ",1065],["T_FOREACH","foreach",1066],["T_WHITESPACE"," ",1066],"(",["T_VARIABLE","$items",1066],["T_WHITESPACE"," ",1066],["T_AS","as",1066],["T_WHITESPACE"," ",1066],["T_VARIABLE","$itemKey",1066],["T_WHITESPACE"," ",1066],["T_DOUBLE_ARROW","=>",1066],["T_WHITESPACE"," ",1066],["T_VARIABLE","$itemValue",1066],")",["T_WHITESPACE"," ",1066],"{",["T_WHITESPACE","\n                ",1066],["T_IF","if",1067],["T_WHITESPACE"," ",1067],"(",["T_VARIABLE","$rule",1067],["T_OBJECT_OPERATOR","->",1067],["T_STRING","getActions",1067],"(",")",["T_OBJECT_OPERATOR","->",1067],["T_STRING","validate",1067],"(",["T_VARIABLE","$itemValue",1067],")",")",["T_WHITESPACE"," ",1067],"{",["T_WHITESPACE","\n                    ",1067],["T_UNSET","unset",1068],"(",["T_VARIABLE","$items",1068],"[",["T_VARIABLE","$itemKey",1068],"]",")",";",["T_WHITESPACE","\n                    ",1068],["T_STRING","array_push",1069],"(",["T_VARIABLE","$itemsSorted",1069],",",["T_WHITESPACE"," ",1069],["T_VARIABLE","$itemValue",1069],")",";",["T_WHITESPACE","\n                ",1069],"}",["T_WHITESPACE","\n            ",1070],"}",["T_WHITESPACE","\n        ",1071],"}",["T_WHITESPACE","\n        ",1072],["T_IF","if",1073],["T_WHITESPACE"," ",1073],"(","!",["T_EMPTY","empty",1073],"(",["T_VARIABLE","$itemsSorted",1073],")",")",["T_WHITESPACE"," ",1073],"{",["T_WHITESPACE","\n            ",1073],["T_VARIABLE","$items",1074],["T_WHITESPACE"," ",1074],"=",["T_WHITESPACE"," ",1074],["T_STRING","array_merge",1074],"(",["T_VARIABLE","$itemsSorted",1074],",",["T_WHITESPACE"," ",1074],["T_VARIABLE","$items",1074],")",";",["T_WHITESPACE","\n        ",1074],"}",["T_WHITESPACE","\n        ",1075],["T_RETURN","return",1076],["T_WHITESPACE"," ",1076],["T_VARIABLE","$items",1076],";",["T_WHITESPACE","\n    ",1076],"}",["T_WHITESPACE","\n",1077],"}",["T_WHITESPACE","\n",1078]]