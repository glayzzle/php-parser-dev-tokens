[["T_OPEN_TAG","<?php\n",1],["T_DOC_COMMENT","\/**\n * Magento\n *\n * NOTICE OF LICENSE\n *\n * This source file is subject to the Open Software License (OSL 3.0)\n * that is bundled with this package in the file LICENSE.txt.\n * It is also available through the world-wide-web at this URL:\n * http:\/\/opensource.org\/licenses\/osl-3.0.php\n * If you did not receive a copy of the license and are unable to\n * obtain it through the world-wide-web, please send an email\n * to license@magento.com so we can send you a copy immediately.\n *\n * DISCLAIMER\n *\n * Do not edit or add to this file if you wish to upgrade Magento to newer\n * versions in the future. If you wish to customize Magento for your\n * needs please refer to http:\/\/www.magento.com for more information.\n *\n * @category    Mage\n * @package     Mage_Paypal\n * @copyright  Copyright (c) 2006-2016 X.commerce, Inc. and affiliates (http:\/\/www.magento.com)\n * @license    http:\/\/opensource.org\/licenses\/osl-3.0.php  Open Software License (OSL 3.0)\n *\/",2],["T_WHITESPACE","\n\n",25],["T_DOC_COMMENT","\/**\n * PayPal Website Payments Pro implementation for payment method instaces\n * This model was created because right now PayPal Direct and PayPal Express payment methods cannot have same abstract\n *\/",27],["T_WHITESPACE","\n",30],["T_CLASS","class",31],["T_WHITESPACE"," ",31],["T_STRING","Mage_Paypal_Model_Pro",31],["T_WHITESPACE","\n",31],"{",["T_WHITESPACE","\n    ",32],["T_DOC_COMMENT","\/**\n     * Possible payment review actions (for FMF only)\n     *\n     * @var string\n     *\/",33],["T_WHITESPACE","\n    ",37],["T_CONST","const",38],["T_WHITESPACE"," ",38],["T_STRING","PAYMENT_REVIEW_ACCEPT",38],["T_WHITESPACE"," ",38],"=",["T_WHITESPACE"," ",38],["T_CONSTANT_ENCAPSED_STRING","'accept'",38],";",["T_WHITESPACE","\n    ",38],["T_CONST","const",39],["T_WHITESPACE"," ",39],["T_STRING","PAYMENT_REVIEW_DENY",39],["T_WHITESPACE"," ",39],"=",["T_WHITESPACE"," ",39],["T_CONSTANT_ENCAPSED_STRING","'deny'",39],";",["T_WHITESPACE","\n\n    ",39],["T_DOC_COMMENT","\/**\n     * Config instance\n     *\n     * @var Mage_Paypal_Model_Config\n     *\/",41],["T_WHITESPACE","\n    ",45],["T_PROTECTED","protected",46],["T_WHITESPACE"," ",46],["T_VARIABLE","$_config",46],["T_WHITESPACE"," ",46],"=",["T_WHITESPACE"," ",46],["T_STRING","null",46],";",["T_WHITESPACE","\n\n    ",46],["T_DOC_COMMENT","\/**\n     * API instance\n     *\n     * @var Mage_Paypal_Model_Api_Nvp\n     *\/",48],["T_WHITESPACE","\n    ",52],["T_PROTECTED","protected",53],["T_WHITESPACE"," ",53],["T_VARIABLE","$_api",53],["T_WHITESPACE"," ",53],"=",["T_WHITESPACE"," ",53],["T_STRING","null",53],";",["T_WHITESPACE","\n\n    ",53],["T_DOC_COMMENT","\/**\n     * PayPal info object\n     *\n     * @var Mage_Paypal_Model_Info\n     *\/",55],["T_WHITESPACE","\n    ",59],["T_PROTECTED","protected",60],["T_WHITESPACE"," ",60],["T_VARIABLE","$_infoInstance",60],["T_WHITESPACE"," ",60],"=",["T_WHITESPACE"," ",60],["T_STRING","null",60],";",["T_WHITESPACE","\n\n    ",60],["T_DOC_COMMENT","\/**\n     * API model type\n     *\n     * @var string\n     *\/",62],["T_WHITESPACE","\n    ",66],["T_PROTECTED","protected",67],["T_WHITESPACE"," ",67],["T_VARIABLE","$_apiType",67],["T_WHITESPACE"," ",67],"=",["T_WHITESPACE"," ",67],["T_CONSTANT_ENCAPSED_STRING","'paypal\/api_nvp'",67],";",["T_WHITESPACE","\n\n    ",67],["T_DOC_COMMENT","\/**\n     * Config model type\n     *\n     * @var string\n     *\/",69],["T_WHITESPACE","\n    ",73],["T_PROTECTED","protected",74],["T_WHITESPACE"," ",74],["T_VARIABLE","$_configType",74],["T_WHITESPACE"," ",74],"=",["T_WHITESPACE"," ",74],["T_CONSTANT_ENCAPSED_STRING","'paypal\/config'",74],";",["T_WHITESPACE","\n\n    ",74],["T_DOC_COMMENT","\/**\n     * Payment method code setter. Also instantiates\/updates config\n     *\n     * @param string $code\n     * @param int|null $storeId\n     *\/",76],["T_WHITESPACE","\n    ",81],["T_PUBLIC","public",82],["T_WHITESPACE"," ",82],["T_FUNCTION","function",82],["T_WHITESPACE"," ",82],["T_STRING","setMethod",82],"(",["T_VARIABLE","$code",82],",",["T_WHITESPACE"," ",82],["T_VARIABLE","$storeId",82],["T_WHITESPACE"," ",82],"=",["T_WHITESPACE"," ",82],["T_STRING","null",82],")",["T_WHITESPACE","\n    ",82],"{",["T_WHITESPACE","\n        ",83],["T_IF","if",84],["T_WHITESPACE"," ",84],"(",["T_STRING","null",84],["T_WHITESPACE"," ",84],["T_IS_IDENTICAL","===",84],["T_WHITESPACE"," ",84],["T_VARIABLE","$this",84],["T_OBJECT_OPERATOR","->",84],["T_STRING","_config",84],")",["T_WHITESPACE"," ",84],"{",["T_WHITESPACE","\n            ",84],["T_VARIABLE","$params",85],["T_WHITESPACE"," ",85],"=",["T_WHITESPACE"," ",85],["T_ARRAY","array",85],"(",["T_VARIABLE","$code",85],")",";",["T_WHITESPACE","\n            ",85],["T_IF","if",86],["T_WHITESPACE"," ",86],"(",["T_STRING","null",86],["T_WHITESPACE"," ",86],["T_IS_NOT_IDENTICAL","!==",86],["T_WHITESPACE"," ",86],["T_VARIABLE","$storeId",86],")",["T_WHITESPACE"," ",86],"{",["T_WHITESPACE","\n                ",86],["T_VARIABLE","$params",87],"[","]",["T_WHITESPACE"," ",87],"=",["T_WHITESPACE"," ",87],["T_VARIABLE","$storeId",87],";",["T_WHITESPACE","\n            ",87],"}",["T_WHITESPACE","\n            ",88],["T_VARIABLE","$this",89],["T_OBJECT_OPERATOR","->",89],["T_STRING","_config",89],["T_WHITESPACE"," ",89],"=",["T_WHITESPACE"," ",89],["T_STRING","Mage",89],["T_DOUBLE_COLON","::",89],["T_STRING","getModel",89],"(",["T_VARIABLE","$this",89],["T_OBJECT_OPERATOR","->",89],["T_STRING","_configType",89],",",["T_WHITESPACE"," ",89],["T_VARIABLE","$params",89],")",";",["T_WHITESPACE","\n        ",89],"}",["T_WHITESPACE"," ",90],["T_ELSE","else",90],["T_WHITESPACE"," ",90],"{",["T_WHITESPACE","\n            ",90],["T_VARIABLE","$this",91],["T_OBJECT_OPERATOR","->",91],["T_STRING","_config",91],["T_OBJECT_OPERATOR","->",91],["T_STRING","setMethod",91],"(",["T_VARIABLE","$code",91],")",";",["T_WHITESPACE","\n            ",91],["T_IF","if",92],["T_WHITESPACE"," ",92],"(",["T_STRING","null",92],["T_WHITESPACE"," ",92],["T_IS_NOT_IDENTICAL","!==",92],["T_WHITESPACE"," ",92],["T_VARIABLE","$storeId",92],")",["T_WHITESPACE"," ",92],"{",["T_WHITESPACE","\n                ",92],["T_VARIABLE","$this",93],["T_OBJECT_OPERATOR","->",93],["T_STRING","_config",93],["T_OBJECT_OPERATOR","->",93],["T_STRING","setStoreId",93],"(",["T_VARIABLE","$storeId",93],")",";",["T_WHITESPACE","\n            ",93],"}",["T_WHITESPACE","\n        ",94],"}",["T_WHITESPACE","\n        ",95],["T_RETURN","return",96],["T_WHITESPACE"," ",96],["T_VARIABLE","$this",96],";",["T_WHITESPACE","\n    ",96],"}",["T_WHITESPACE","\n\n    ",97],["T_DOC_COMMENT","\/**\n     * Config instance setter\n     *\n     * @param Mage_Paypal_Model_Config $instace\n     * @param int $storeId\n     *\/",99],["T_WHITESPACE","\n    ",104],["T_PUBLIC","public",105],["T_WHITESPACE"," ",105],["T_FUNCTION","function",105],["T_WHITESPACE"," ",105],["T_STRING","setConfig",105],"(",["T_STRING","Mage_Paypal_Model_Config",105],["T_WHITESPACE"," ",105],["T_VARIABLE","$instace",105],",",["T_WHITESPACE"," ",105],["T_VARIABLE","$storeId",105],["T_WHITESPACE"," ",105],"=",["T_WHITESPACE"," ",105],["T_STRING","null",105],")",["T_WHITESPACE","\n    ",105],"{",["T_WHITESPACE","\n        ",106],["T_VARIABLE","$this",107],["T_OBJECT_OPERATOR","->",107],["T_STRING","_config",107],["T_WHITESPACE"," ",107],"=",["T_WHITESPACE"," ",107],["T_VARIABLE","$instace",107],";",["T_WHITESPACE","\n        ",107],["T_IF","if",108],["T_WHITESPACE"," ",108],"(",["T_STRING","null",108],["T_WHITESPACE"," ",108],["T_IS_NOT_IDENTICAL","!==",108],["T_WHITESPACE"," ",108],["T_VARIABLE","$storeId",108],")",["T_WHITESPACE"," ",108],"{",["T_WHITESPACE","\n            ",108],["T_VARIABLE","$this",109],["T_OBJECT_OPERATOR","->",109],["T_STRING","_config",109],["T_OBJECT_OPERATOR","->",109],["T_STRING","setStoreId",109],"(",["T_VARIABLE","$storeId",109],")",";",["T_WHITESPACE","\n        ",109],"}",["T_WHITESPACE","\n        ",110],["T_RETURN","return",111],["T_WHITESPACE"," ",111],["T_VARIABLE","$this",111],";",["T_WHITESPACE","\n    ",111],"}",["T_WHITESPACE","\n\n    ",112],["T_DOC_COMMENT","\/**\n     * Config instance getter\n     *\n     * @return Mage_Paypal_Model_Config\n     *\/",114],["T_WHITESPACE","\n    ",118],["T_PUBLIC","public",119],["T_WHITESPACE"," ",119],["T_FUNCTION","function",119],["T_WHITESPACE"," ",119],["T_STRING","getConfig",119],"(",")",["T_WHITESPACE","\n    ",119],"{",["T_WHITESPACE","\n        ",120],["T_RETURN","return",121],["T_WHITESPACE"," ",121],["T_VARIABLE","$this",121],["T_OBJECT_OPERATOR","->",121],["T_STRING","_config",121],";",["T_WHITESPACE","\n    ",121],"}",["T_WHITESPACE","\n\n    ",122],["T_DOC_COMMENT","\/**\n     * API instance getter\n     * Sets current store id to current config instance and passes it to API\n     *\n     * @return Mage_Paypal_Model_Api_Nvp\n     *\/",124],["T_WHITESPACE","\n    ",129],["T_PUBLIC","public",130],["T_WHITESPACE"," ",130],["T_FUNCTION","function",130],["T_WHITESPACE"," ",130],["T_STRING","getApi",130],"(",")",["T_WHITESPACE","\n    ",130],"{",["T_WHITESPACE","\n        ",131],["T_IF","if",132],["T_WHITESPACE"," ",132],"(",["T_STRING","null",132],["T_WHITESPACE"," ",132],["T_IS_IDENTICAL","===",132],["T_WHITESPACE"," ",132],["T_VARIABLE","$this",132],["T_OBJECT_OPERATOR","->",132],["T_STRING","_api",132],")",["T_WHITESPACE"," ",132],"{",["T_WHITESPACE","\n            ",132],["T_VARIABLE","$this",133],["T_OBJECT_OPERATOR","->",133],["T_STRING","_api",133],["T_WHITESPACE"," ",133],"=",["T_WHITESPACE"," ",133],["T_STRING","Mage",133],["T_DOUBLE_COLON","::",133],["T_STRING","getModel",133],"(",["T_VARIABLE","$this",133],["T_OBJECT_OPERATOR","->",133],["T_STRING","_apiType",133],")",";",["T_WHITESPACE","\n        ",133],"}",["T_WHITESPACE","\n        ",134],["T_VARIABLE","$this",135],["T_OBJECT_OPERATOR","->",135],["T_STRING","_api",135],["T_OBJECT_OPERATOR","->",135],["T_STRING","setConfigObject",135],"(",["T_VARIABLE","$this",135],["T_OBJECT_OPERATOR","->",135],["T_STRING","_config",135],")",";",["T_WHITESPACE","\n        ",135],["T_RETURN","return",136],["T_WHITESPACE"," ",136],["T_VARIABLE","$this",136],["T_OBJECT_OPERATOR","->",136],["T_STRING","_api",136],";",["T_WHITESPACE","\n    ",136],"}",["T_WHITESPACE","\n\n    ",137],["T_DOC_COMMENT","\/**\n     * Destroy existing NVP Api object\n     *\n     * @return Mage_Paypal_Model_Pro\n     *\/",139],["T_WHITESPACE","\n    ",143],["T_PUBLIC","public",144],["T_WHITESPACE"," ",144],["T_FUNCTION","function",144],["T_WHITESPACE"," ",144],["T_STRING","resetApi",144],"(",")",["T_WHITESPACE","\n    ",144],"{",["T_WHITESPACE","\n        ",145],["T_VARIABLE","$this",146],["T_OBJECT_OPERATOR","->",146],["T_STRING","_api",146],["T_WHITESPACE"," ",146],"=",["T_WHITESPACE"," ",146],["T_STRING","null",146],";",["T_WHITESPACE","\n\n        ",146],["T_RETURN","return",148],["T_WHITESPACE"," ",148],["T_VARIABLE","$this",148],";",["T_WHITESPACE","\n    ",148],"}",["T_WHITESPACE","\n\n    ",149],["T_DOC_COMMENT","\/**\n     * Instantiate and return info model\n     *\n     * @return Mage_Paypal_Model_Info\n     *\/",151],["T_WHITESPACE","\n    ",155],["T_PUBLIC","public",156],["T_WHITESPACE"," ",156],["T_FUNCTION","function",156],["T_WHITESPACE"," ",156],["T_STRING","getInfo",156],"(",")",["T_WHITESPACE","\n    ",156],"{",["T_WHITESPACE","\n        ",157],["T_IF","if",158],["T_WHITESPACE"," ",158],"(",["T_STRING","null",158],["T_WHITESPACE"," ",158],["T_IS_IDENTICAL","===",158],["T_WHITESPACE"," ",158],["T_VARIABLE","$this",158],["T_OBJECT_OPERATOR","->",158],["T_STRING","_infoInstance",158],")",["T_WHITESPACE"," ",158],"{",["T_WHITESPACE","\n            ",158],["T_VARIABLE","$this",159],["T_OBJECT_OPERATOR","->",159],["T_STRING","_infoInstance",159],["T_WHITESPACE"," ",159],"=",["T_WHITESPACE"," ",159],["T_STRING","Mage",159],["T_DOUBLE_COLON","::",159],["T_STRING","getModel",159],"(",["T_CONSTANT_ENCAPSED_STRING","'paypal\/info'",159],")",";",["T_WHITESPACE","\n        ",159],"}",["T_WHITESPACE","\n        ",160],["T_RETURN","return",161],["T_WHITESPACE"," ",161],["T_VARIABLE","$this",161],["T_OBJECT_OPERATOR","->",161],["T_STRING","_infoInstance",161],";",["T_WHITESPACE","\n    ",161],"}",["T_WHITESPACE","\n\n    ",162],["T_DOC_COMMENT","\/**\n     * Transfer transaction\/payment information from API instance to order payment\n     *\n     * @param Mage_Paypal_Model_Api_Abstract $from\n     * @param Mage_Payment_Model_Info $to\n     * @return Mage_Paypal_Model_Pro\n     *\/",164],["T_WHITESPACE","\n    ",170],["T_PUBLIC","public",171],["T_WHITESPACE"," ",171],["T_FUNCTION","function",171],["T_WHITESPACE"," ",171],["T_STRING","importPaymentInfo",171],"(",["T_STRING","Varien_Object",171],["T_WHITESPACE"," ",171],["T_VARIABLE","$from",171],",",["T_WHITESPACE"," ",171],["T_STRING","Mage_Payment_Model_Info",171],["T_WHITESPACE"," ",171],["T_VARIABLE","$to",171],")",["T_WHITESPACE","\n    ",171],"{",["T_WHITESPACE","\n        ",172],["T_COMMENT","\/\/ update PayPal-specific payment information in the payment object\n",173],["T_WHITESPACE","        ",174],["T_VARIABLE","$this",174],["T_OBJECT_OPERATOR","->",174],["T_STRING","getInfo",174],"(",")",["T_OBJECT_OPERATOR","->",174],["T_STRING","importToPayment",174],"(",["T_VARIABLE","$from",174],",",["T_WHITESPACE"," ",174],["T_VARIABLE","$to",174],")",";",["T_WHITESPACE","\n\n        ",174],["T_DOC_COMMENT","\/**\n         * Detect payment review and\/or frauds\n         * PayPal pro API returns fraud results only in the payment call response\n         *\/",176],["T_WHITESPACE","\n        ",179],["T_IF","if",180],["T_WHITESPACE"," ",180],"(",["T_VARIABLE","$from",180],["T_OBJECT_OPERATOR","->",180],["T_STRING","getDataUsingMethod",180],"(",["T_STRING","Mage_Paypal_Model_Info",180],["T_DOUBLE_COLON","::",180],["T_STRING","IS_FRAUD",180],")",")",["T_WHITESPACE"," ",180],"{",["T_WHITESPACE","\n            ",180],["T_VARIABLE","$to",181],["T_OBJECT_OPERATOR","->",181],["T_STRING","setIsTransactionPending",181],"(",["T_STRING","true",181],")",";",["T_WHITESPACE","\n            ",181],["T_VARIABLE","$to",182],["T_OBJECT_OPERATOR","->",182],["T_STRING","setIsFraudDetected",182],"(",["T_STRING","true",182],")",";",["T_WHITESPACE","\n        ",182],"}",["T_WHITESPACE"," ",183],["T_ELSEIF","elseif",183],["T_WHITESPACE"," ",183],"(",["T_VARIABLE","$this",183],["T_OBJECT_OPERATOR","->",183],["T_STRING","getInfo",183],"(",")",["T_OBJECT_OPERATOR","->",183],["T_STRING","isPaymentReviewRequired",183],"(",["T_VARIABLE","$to",183],")",")",["T_WHITESPACE"," ",183],"{",["T_WHITESPACE","\n            ",183],["T_VARIABLE","$to",184],["T_OBJECT_OPERATOR","->",184],["T_STRING","setIsTransactionPending",184],"(",["T_STRING","true",184],")",";",["T_WHITESPACE","\n        ",184],"}",["T_WHITESPACE","\n\n        ",185],["T_COMMENT","\/\/ give generic info about transaction state\n",187],["T_WHITESPACE","        ",188],["T_IF","if",188],["T_WHITESPACE"," ",188],"(",["T_VARIABLE","$this",188],["T_OBJECT_OPERATOR","->",188],["T_STRING","getInfo",188],"(",")",["T_OBJECT_OPERATOR","->",188],["T_STRING","isPaymentSuccessful",188],"(",["T_VARIABLE","$to",188],")",")",["T_WHITESPACE"," ",188],"{",["T_WHITESPACE","\n            ",188],["T_VARIABLE","$to",189],["T_OBJECT_OPERATOR","->",189],["T_STRING","setIsTransactionApproved",189],"(",["T_STRING","true",189],")",";",["T_WHITESPACE","\n        ",189],"}",["T_WHITESPACE"," ",190],["T_ELSEIF","elseif",190],["T_WHITESPACE"," ",190],"(",["T_VARIABLE","$this",190],["T_OBJECT_OPERATOR","->",190],["T_STRING","getInfo",190],"(",")",["T_OBJECT_OPERATOR","->",190],["T_STRING","isPaymentFailed",190],"(",["T_VARIABLE","$to",190],")",")",["T_WHITESPACE"," ",190],"{",["T_WHITESPACE","\n            ",190],["T_VARIABLE","$to",191],["T_OBJECT_OPERATOR","->",191],["T_STRING","setIsTransactionDenied",191],"(",["T_STRING","true",191],")",";",["T_WHITESPACE","\n        ",191],"}",["T_WHITESPACE","\n\n        ",192],["T_RETURN","return",194],["T_WHITESPACE"," ",194],["T_VARIABLE","$this",194],";",["T_WHITESPACE","\n    ",194],"}",["T_WHITESPACE","\n\n    ",195],["T_DOC_COMMENT","\/**\n     * Void transaction\n     *\n     * @param Varien_Object $payment\n     *\/",197],["T_WHITESPACE","\n    ",201],["T_PUBLIC","public",202],["T_WHITESPACE"," ",202],["T_FUNCTION","function",202],["T_WHITESPACE"," ",202],["T_STRING","void",202],"(",["T_STRING","Varien_Object",202],["T_WHITESPACE"," ",202],["T_VARIABLE","$payment",202],")",["T_WHITESPACE","\n    ",202],"{",["T_WHITESPACE","\n        ",203],["T_IF","if",204],["T_WHITESPACE"," ",204],"(",["T_VARIABLE","$authTransactionId",204],["T_WHITESPACE"," ",204],"=",["T_WHITESPACE"," ",204],["T_VARIABLE","$this",204],["T_OBJECT_OPERATOR","->",204],["T_STRING","_getParentTransactionId",204],"(",["T_VARIABLE","$payment",204],")",")",["T_WHITESPACE"," ",204],"{",["T_WHITESPACE","\n            ",204],["T_VARIABLE","$api",205],["T_WHITESPACE"," ",205],"=",["T_WHITESPACE"," ",205],["T_VARIABLE","$this",205],["T_OBJECT_OPERATOR","->",205],["T_STRING","getApi",205],"(",")",";",["T_WHITESPACE","\n            ",205],["T_VARIABLE","$api",206],["T_OBJECT_OPERATOR","->",206],["T_STRING","setPayment",206],"(",["T_VARIABLE","$payment",206],")",["T_OBJECT_OPERATOR","->",206],["T_STRING","setAuthorizationId",206],"(",["T_VARIABLE","$authTransactionId",206],")",["T_OBJECT_OPERATOR","->",206],["T_STRING","callDoVoid",206],"(",")",";",["T_WHITESPACE","\n            ",206],["T_VARIABLE","$this",207],["T_OBJECT_OPERATOR","->",207],["T_STRING","importPaymentInfo",207],"(",["T_VARIABLE","$api",207],",",["T_WHITESPACE"," ",207],["T_VARIABLE","$payment",207],")",";",["T_WHITESPACE","\n        ",207],"}",["T_WHITESPACE"," ",208],["T_ELSE","else",208],["T_WHITESPACE"," ",208],"{",["T_WHITESPACE","\n            ",208],["T_STRING","Mage",209],["T_DOUBLE_COLON","::",209],["T_STRING","throwException",209],"(",["T_STRING","Mage",209],["T_DOUBLE_COLON","::",209],["T_STRING","helper",209],"(",["T_CONSTANT_ENCAPSED_STRING","'paypal'",209],")",["T_OBJECT_OPERATOR","->",209],["T_STRING","__",209],"(",["T_CONSTANT_ENCAPSED_STRING","'Authorization transaction is required to void.'",209],")",")",";",["T_WHITESPACE","\n        ",209],"}",["T_WHITESPACE","\n    ",210],"}",["T_WHITESPACE","\n\n    ",211],["T_DOC_COMMENT","\/**\n     * Attempt to capture payment\n     * Will return false if the payment is not supposed to be captured\n     *\n     * @param Varien_Object $payment\n     * @param float $amount\n     * @return false|null\n     *\/",213],["T_WHITESPACE","\n    ",220],["T_PUBLIC","public",221],["T_WHITESPACE"," ",221],["T_FUNCTION","function",221],["T_WHITESPACE"," ",221],["T_STRING","capture",221],"(",["T_STRING","Varien_Object",221],["T_WHITESPACE"," ",221],["T_VARIABLE","$payment",221],",",["T_WHITESPACE"," ",221],["T_VARIABLE","$amount",221],")",["T_WHITESPACE","\n    ",221],"{",["T_WHITESPACE","\n        ",222],["T_VARIABLE","$authTransactionId",223],["T_WHITESPACE"," ",223],"=",["T_WHITESPACE"," ",223],["T_VARIABLE","$this",223],["T_OBJECT_OPERATOR","->",223],["T_STRING","_getParentTransactionId",223],"(",["T_VARIABLE","$payment",223],")",";",["T_WHITESPACE","\n        ",223],["T_IF","if",224],["T_WHITESPACE"," ",224],"(","!",["T_VARIABLE","$authTransactionId",224],")",["T_WHITESPACE"," ",224],"{",["T_WHITESPACE","\n            ",224],["T_RETURN","return",225],["T_WHITESPACE"," ",225],["T_STRING","false",225],";",["T_WHITESPACE","\n        ",225],"}",["T_WHITESPACE","\n        ",226],["T_VARIABLE","$api",227],["T_WHITESPACE"," ",227],"=",["T_WHITESPACE"," ",227],["T_VARIABLE","$this",227],["T_OBJECT_OPERATOR","->",227],["T_STRING","getApi",227],"(",")",["T_WHITESPACE","\n            ",227],["T_OBJECT_OPERATOR","->",228],["T_STRING","setAuthorizationId",228],"(",["T_VARIABLE","$authTransactionId",228],")",["T_WHITESPACE","\n            ",228],["T_OBJECT_OPERATOR","->",229],["T_STRING","setIsCaptureComplete",229],"(",["T_VARIABLE","$payment",229],["T_OBJECT_OPERATOR","->",229],["T_STRING","getShouldCloseParentTransaction",229],"(",")",")",["T_WHITESPACE","\n            ",229],["T_OBJECT_OPERATOR","->",230],["T_STRING","setAmount",230],"(",["T_VARIABLE","$amount",230],")",["T_WHITESPACE","\n            ",230],["T_OBJECT_OPERATOR","->",231],["T_STRING","setCurrencyCode",231],"(",["T_VARIABLE","$payment",231],["T_OBJECT_OPERATOR","->",231],["T_STRING","getOrder",231],"(",")",["T_OBJECT_OPERATOR","->",231],["T_STRING","getBaseCurrencyCode",231],"(",")",")",["T_WHITESPACE","\n            ",231],["T_OBJECT_OPERATOR","->",232],["T_STRING","setInvNum",232],"(",["T_VARIABLE","$payment",232],["T_OBJECT_OPERATOR","->",232],["T_STRING","getOrder",232],"(",")",["T_OBJECT_OPERATOR","->",232],["T_STRING","getIncrementId",232],"(",")",")",["T_WHITESPACE","\n            ",232],["T_COMMENT","\/\/ TODO: pass 'NOTE' to API\n",233],["T_WHITESPACE","        ",234],";",["T_WHITESPACE","\n\n        ",234],["T_VARIABLE","$api",236],["T_OBJECT_OPERATOR","->",236],["T_STRING","callDoCapture",236],"(",")",";",["T_WHITESPACE","\n        ",236],["T_VARIABLE","$this",237],["T_OBJECT_OPERATOR","->",237],["T_STRING","_importCaptureResultToPayment",237],"(",["T_VARIABLE","$api",237],",",["T_WHITESPACE"," ",237],["T_VARIABLE","$payment",237],")",";",["T_WHITESPACE","\n    ",237],"}",["T_WHITESPACE","\n\n    ",238],["T_DOC_COMMENT","\/**\n     * Refund a capture transaction\n     *\n     * @param Varien_Object $payment\n     * @param float $amount\n     *\/",240],["T_WHITESPACE","\n    ",245],["T_PUBLIC","public",246],["T_WHITESPACE"," ",246],["T_FUNCTION","function",246],["T_WHITESPACE"," ",246],["T_STRING","refund",246],"(",["T_STRING","Varien_Object",246],["T_WHITESPACE"," ",246],["T_VARIABLE","$payment",246],",",["T_WHITESPACE"," ",246],["T_VARIABLE","$amount",246],")",["T_WHITESPACE","\n    ",246],"{",["T_WHITESPACE","\n        ",247],["T_VARIABLE","$captureTxnId",248],["T_WHITESPACE"," ",248],"=",["T_WHITESPACE"," ",248],["T_VARIABLE","$this",248],["T_OBJECT_OPERATOR","->",248],["T_STRING","_getParentTransactionId",248],"(",["T_VARIABLE","$payment",248],")",";",["T_WHITESPACE","\n        ",248],["T_IF","if",249],["T_WHITESPACE"," ",249],"(",["T_VARIABLE","$captureTxnId",249],")",["T_WHITESPACE"," ",249],"{",["T_WHITESPACE","\n            ",249],["T_VARIABLE","$api",250],["T_WHITESPACE"," ",250],"=",["T_WHITESPACE"," ",250],["T_VARIABLE","$this",250],["T_OBJECT_OPERATOR","->",250],["T_STRING","getApi",250],"(",")",";",["T_WHITESPACE","\n            ",250],["T_VARIABLE","$order",251],["T_WHITESPACE"," ",251],"=",["T_WHITESPACE"," ",251],["T_VARIABLE","$payment",251],["T_OBJECT_OPERATOR","->",251],["T_STRING","getOrder",251],"(",")",";",["T_WHITESPACE","\n            ",251],["T_VARIABLE","$api",252],["T_OBJECT_OPERATOR","->",252],["T_STRING","setPayment",252],"(",["T_VARIABLE","$payment",252],")",["T_WHITESPACE","\n                ",252],["T_OBJECT_OPERATOR","->",253],["T_STRING","setTransactionId",253],"(",["T_VARIABLE","$captureTxnId",253],")",["T_WHITESPACE","\n                ",253],["T_OBJECT_OPERATOR","->",254],["T_STRING","setAmount",254],"(",["T_VARIABLE","$amount",254],")",["T_WHITESPACE","\n                ",254],["T_OBJECT_OPERATOR","->",255],["T_STRING","setCurrencyCode",255],"(",["T_VARIABLE","$order",255],["T_OBJECT_OPERATOR","->",255],["T_STRING","getBaseCurrencyCode",255],"(",")",")",["T_WHITESPACE","\n            ",255],";",["T_WHITESPACE","\n            ",256],["T_VARIABLE","$canRefundMore",257],["T_WHITESPACE"," ",257],"=",["T_WHITESPACE"," ",257],["T_VARIABLE","$payment",257],["T_OBJECT_OPERATOR","->",257],["T_STRING","getCreditmemo",257],"(",")",["T_OBJECT_OPERATOR","->",257],["T_STRING","getInvoice",257],"(",")",["T_OBJECT_OPERATOR","->",257],["T_STRING","canRefund",257],"(",")",";",["T_WHITESPACE","\n            ",257],["T_VARIABLE","$isFullRefund",258],["T_WHITESPACE"," ",258],"=",["T_WHITESPACE"," ",258],"!",["T_VARIABLE","$canRefundMore",258],["T_WHITESPACE","\n                ",258],["T_BOOLEAN_AND","&&",259],["T_WHITESPACE"," ",259],"(",["T_LNUMBER","0",259],["T_WHITESPACE"," ",259],["T_IS_EQUAL","==",259],["T_WHITESPACE"," ",259],"(",["T_DOUBLE_CAST","(float)",259],["T_VARIABLE","$order",259],["T_OBJECT_OPERATOR","->",259],["T_STRING","getBaseTotalOnlineRefunded",259],"(",")",["T_WHITESPACE"," ",259],"+",["T_WHITESPACE"," ",259],["T_DOUBLE_CAST","(float)",259],["T_VARIABLE","$order",259],["T_OBJECT_OPERATOR","->",259],["T_STRING","getBaseTotalOfflineRefunded",259],"(",")",")",")",";",["T_WHITESPACE","\n            ",259],["T_VARIABLE","$api",260],["T_OBJECT_OPERATOR","->",260],["T_STRING","setRefundType",260],"(",["T_VARIABLE","$isFullRefund",260],["T_WHITESPACE"," ",260],"?",["T_WHITESPACE"," ",260],["T_STRING","Mage_Paypal_Model_Config",260],["T_DOUBLE_COLON","::",260],["T_STRING","REFUND_TYPE_FULL",260],["T_WHITESPACE","\n                ",260],":",["T_WHITESPACE"," ",261],["T_STRING","Mage_Paypal_Model_Config",261],["T_DOUBLE_COLON","::",261],["T_STRING","REFUND_TYPE_PARTIAL",261],["T_WHITESPACE","\n            ",261],")",";",["T_WHITESPACE","\n            ",262],["T_VARIABLE","$api",263],["T_OBJECT_OPERATOR","->",263],["T_STRING","callRefundTransaction",263],"(",")",";",["T_WHITESPACE","\n            ",263],["T_VARIABLE","$this",264],["T_OBJECT_OPERATOR","->",264],["T_STRING","_importRefundResultToPayment",264],"(",["T_VARIABLE","$api",264],",",["T_WHITESPACE"," ",264],["T_VARIABLE","$payment",264],",",["T_WHITESPACE"," ",264],["T_VARIABLE","$canRefundMore",264],")",";",["T_WHITESPACE","\n        ",264],"}",["T_WHITESPACE"," ",265],["T_ELSE","else",265],["T_WHITESPACE"," ",265],"{",["T_WHITESPACE","\n            ",265],["T_STRING","Mage",266],["T_DOUBLE_COLON","::",266],["T_STRING","throwException",266],"(",["T_STRING","Mage",266],["T_DOUBLE_COLON","::",266],["T_STRING","helper",266],"(",["T_CONSTANT_ENCAPSED_STRING","'paypal'",266],")",["T_OBJECT_OPERATOR","->",266],["T_STRING","__",266],"(",["T_CONSTANT_ENCAPSED_STRING","'Impossible to issue a refund transaction because the capture transaction does not exist.'",266],")",")",";",["T_WHITESPACE","\n        ",266],"}",["T_WHITESPACE","\n    ",267],"}",["T_WHITESPACE","\n\n    ",268],["T_DOC_COMMENT","\/**\n     * Cancel payment\n     *\n     * @param Varien_Object $payment\n     *\/",270],["T_WHITESPACE","\n    ",274],["T_PUBLIC","public",275],["T_WHITESPACE"," ",275],["T_FUNCTION","function",275],["T_WHITESPACE"," ",275],["T_STRING","cancel",275],"(",["T_STRING","Varien_Object",275],["T_WHITESPACE"," ",275],["T_VARIABLE","$payment",275],")",["T_WHITESPACE","\n    ",275],"{",["T_WHITESPACE","\n        ",276],["T_IF","if",277],["T_WHITESPACE"," ",277],"(","!",["T_VARIABLE","$payment",277],["T_OBJECT_OPERATOR","->",277],["T_STRING","getOrder",277],"(",")",["T_OBJECT_OPERATOR","->",277],["T_STRING","getInvoiceCollection",277],"(",")",["T_OBJECT_OPERATOR","->",277],["T_STRING","count",277],"(",")",")",["T_WHITESPACE"," ",277],"{",["T_WHITESPACE","\n            ",277],["T_VARIABLE","$this",278],["T_OBJECT_OPERATOR","->",278],["T_STRING","void",278],"(",["T_VARIABLE","$payment",278],")",";",["T_WHITESPACE","\n        ",278],"}",["T_WHITESPACE","\n    ",279],"}",["T_WHITESPACE","\n\n    ",280],["T_DOC_COMMENT","\/**\n     *\n     * @param Mage_Sales_Model_Order_Payment $payment\n     * @return bool\n     *\/",282],["T_WHITESPACE","\n    ",286],["T_PUBLIC","public",287],["T_WHITESPACE"," ",287],["T_FUNCTION","function",287],["T_WHITESPACE"," ",287],["T_STRING","canReviewPayment",287],"(",["T_STRING","Mage_Payment_Model_Info",287],["T_WHITESPACE"," ",287],["T_VARIABLE","$payment",287],")",["T_WHITESPACE","\n    ",287],"{",["T_WHITESPACE","\n        ",288],["T_RETURN","return",289],["T_WHITESPACE"," ",289],["T_STRING","Mage_Paypal_Model_Info",289],["T_DOUBLE_COLON","::",289],["T_STRING","isPaymentReviewRequired",289],"(",["T_VARIABLE","$payment",289],")",";",["T_WHITESPACE","\n    ",289],"}",["T_WHITESPACE","\n\n    ",290],["T_DOC_COMMENT","\/**\n     * Perform the payment review\n     *\n     * @param Mage_Payment_Model_Info $payment\n     * @param string $action\n     * @return bool\n     *\/",292],["T_WHITESPACE","\n    ",298],["T_PUBLIC","public",299],["T_WHITESPACE"," ",299],["T_FUNCTION","function",299],["T_WHITESPACE"," ",299],["T_STRING","reviewPayment",299],"(",["T_STRING","Mage_Payment_Model_Info",299],["T_WHITESPACE"," ",299],["T_VARIABLE","$payment",299],",",["T_WHITESPACE"," ",299],["T_VARIABLE","$action",299],")",["T_WHITESPACE","\n    ",299],"{",["T_WHITESPACE","\n        ",300],["T_VARIABLE","$api",301],["T_WHITESPACE"," ",301],"=",["T_WHITESPACE"," ",301],["T_VARIABLE","$this",301],["T_OBJECT_OPERATOR","->",301],["T_STRING","getApi",301],"(",")",["T_OBJECT_OPERATOR","->",301],["T_STRING","setTransactionId",301],"(",["T_VARIABLE","$payment",301],["T_OBJECT_OPERATOR","->",301],["T_STRING","getLastTransId",301],"(",")",")",";",["T_WHITESPACE","\n\n        ",301],["T_COMMENT","\/\/ check whether the review is still needed\n",303],["T_WHITESPACE","        ",304],["T_VARIABLE","$api",304],["T_OBJECT_OPERATOR","->",304],["T_STRING","callGetTransactionDetails",304],"(",")",";",["T_WHITESPACE","\n        ",304],["T_VARIABLE","$this",305],["T_OBJECT_OPERATOR","->",305],["T_STRING","importPaymentInfo",305],"(",["T_VARIABLE","$api",305],",",["T_WHITESPACE"," ",305],["T_VARIABLE","$payment",305],")",";",["T_WHITESPACE","\n        ",305],["T_IF","if",306],["T_WHITESPACE"," ",306],"(","!",["T_VARIABLE","$this",306],["T_OBJECT_OPERATOR","->",306],["T_STRING","getInfo",306],"(",")",["T_OBJECT_OPERATOR","->",306],["T_STRING","isPaymentReviewRequired",306],"(",["T_VARIABLE","$payment",306],")",")",["T_WHITESPACE"," ",306],"{",["T_WHITESPACE","\n            ",306],["T_RETURN","return",307],["T_WHITESPACE"," ",307],["T_STRING","false",307],";",["T_WHITESPACE","\n        ",307],"}",["T_WHITESPACE","\n\n        ",308],["T_COMMENT","\/\/ perform the review action\n",310],["T_WHITESPACE","        ",311],["T_VARIABLE","$api",311],["T_OBJECT_OPERATOR","->",311],["T_STRING","setAction",311],"(",["T_VARIABLE","$action",311],")",["T_OBJECT_OPERATOR","->",311],["T_STRING","callManagePendingTransactionStatus",311],"(",")",";",["T_WHITESPACE","\n        ",311],["T_VARIABLE","$api",312],["T_OBJECT_OPERATOR","->",312],["T_STRING","callGetTransactionDetails",312],"(",")",";",["T_WHITESPACE","\n        ",312],["T_VARIABLE","$this",313],["T_OBJECT_OPERATOR","->",313],["T_STRING","importPaymentInfo",313],"(",["T_VARIABLE","$api",313],",",["T_WHITESPACE"," ",313],["T_VARIABLE","$payment",313],")",";",["T_WHITESPACE","\n        ",313],["T_RETURN","return",314],["T_WHITESPACE"," ",314],["T_STRING","true",314],";",["T_WHITESPACE","\n    ",314],"}",["T_WHITESPACE","\n\n    ",315],["T_DOC_COMMENT","\/**\n     * Fetch transaction details info\n     *\n     * @param Mage_Payment_Model_Info $payment\n     * @param string $transactionId\n     * @return array\n     *\/",317],["T_WHITESPACE","\n    ",323],["T_PUBLIC","public",324],["T_WHITESPACE"," ",324],["T_FUNCTION","function",324],["T_WHITESPACE"," ",324],["T_STRING","fetchTransactionInfo",324],"(",["T_STRING","Mage_Payment_Model_Info",324],["T_WHITESPACE"," ",324],["T_VARIABLE","$payment",324],",",["T_WHITESPACE"," ",324],["T_VARIABLE","$transactionId",324],")",["T_WHITESPACE","\n    ",324],"{",["T_WHITESPACE","\n        ",325],["T_VARIABLE","$api",326],["T_WHITESPACE"," ",326],"=",["T_WHITESPACE"," ",326],["T_VARIABLE","$this",326],["T_OBJECT_OPERATOR","->",326],["T_STRING","getApi",326],"(",")",["T_WHITESPACE","\n            ",326],["T_OBJECT_OPERATOR","->",327],["T_STRING","setTransactionId",327],"(",["T_VARIABLE","$transactionId",327],")",["T_WHITESPACE","\n            ",327],["T_OBJECT_OPERATOR","->",328],["T_STRING","setRawResponseNeeded",328],"(",["T_STRING","true",328],")",";",["T_WHITESPACE","\n        ",328],["T_VARIABLE","$api",329],["T_OBJECT_OPERATOR","->",329],["T_STRING","callGetTransactionDetails",329],"(",")",";",["T_WHITESPACE","\n        ",329],["T_VARIABLE","$this",330],["T_OBJECT_OPERATOR","->",330],["T_STRING","importPaymentInfo",330],"(",["T_VARIABLE","$api",330],",",["T_WHITESPACE"," ",330],["T_VARIABLE","$payment",330],")",";",["T_WHITESPACE","\n        ",330],["T_VARIABLE","$data",331],["T_WHITESPACE"," ",331],"=",["T_WHITESPACE"," ",331],["T_VARIABLE","$api",331],["T_OBJECT_OPERATOR","->",331],["T_STRING","getRawSuccessResponseData",331],"(",")",";",["T_WHITESPACE","\n        ",331],["T_RETURN","return",332],["T_WHITESPACE"," ",332],"(",["T_VARIABLE","$data",332],")",["T_WHITESPACE"," ",332],"?",["T_WHITESPACE"," ",332],["T_VARIABLE","$data",332],["T_WHITESPACE"," ",332],":",["T_WHITESPACE"," ",332],["T_ARRAY","array",332],"(",")",";",["T_WHITESPACE","\n    ",332],"}",["T_WHITESPACE","\n\n    ",333],["T_DOC_COMMENT","\/**\n     * Validate RP data\n     *\n     * @param Mage_Payment_Model_Recurring_Profile $profile\n     * @throws Mage_Core_Exception\n     *\/",335],["T_WHITESPACE","\n    ",340],["T_PUBLIC","public",341],["T_WHITESPACE"," ",341],["T_FUNCTION","function",341],["T_WHITESPACE"," ",341],["T_STRING","validateRecurringProfile",341],"(",["T_STRING","Mage_Payment_Model_Recurring_Profile",341],["T_WHITESPACE"," ",341],["T_VARIABLE","$profile",341],")",["T_WHITESPACE","\n    ",341],"{",["T_WHITESPACE","\n        ",342],["T_VARIABLE","$errors",343],["T_WHITESPACE"," ",343],"=",["T_WHITESPACE"," ",343],["T_ARRAY","array",343],"(",")",";",["T_WHITESPACE","\n        ",343],["T_IF","if",344],["T_WHITESPACE"," ",344],"(",["T_STRING","strlen",344],"(",["T_VARIABLE","$profile",344],["T_OBJECT_OPERATOR","->",344],["T_STRING","getSubscriberName",344],"(",")",")",["T_WHITESPACE"," ",344],">",["T_WHITESPACE"," ",344],["T_LNUMBER","32",344],")",["T_WHITESPACE"," ",344],"{",["T_WHITESPACE"," ",344],["T_COMMENT","\/\/ up to 32 single-byte chars\n",344],["T_WHITESPACE","            ",345],["T_VARIABLE","$errors",345],"[","]",["T_WHITESPACE"," ",345],"=",["T_WHITESPACE"," ",345],["T_STRING","Mage",345],["T_DOUBLE_COLON","::",345],["T_STRING","helper",345],"(",["T_CONSTANT_ENCAPSED_STRING","'paypal'",345],")",["T_OBJECT_OPERATOR","->",345],["T_STRING","__",345],"(",["T_CONSTANT_ENCAPSED_STRING","'Subscriber name is too long.'",345],")",";",["T_WHITESPACE","\n        ",345],"}",["T_WHITESPACE","\n        ",346],["T_VARIABLE","$refId",347],["T_WHITESPACE"," ",347],"=",["T_WHITESPACE"," ",347],["T_VARIABLE","$profile",347],["T_OBJECT_OPERATOR","->",347],["T_STRING","getInternalReferenceId",347],"(",")",";",["T_WHITESPACE"," ",347],["T_COMMENT","\/\/ up to 127 single-byte alphanumeric\n",347],["T_WHITESPACE","        ",348],["T_IF","if",348],["T_WHITESPACE"," ",348],"(",["T_STRING","strlen",348],"(",["T_VARIABLE","$refId",348],")",["T_WHITESPACE"," ",348],">",["T_WHITESPACE"," ",348],["T_LNUMBER","127",348],")",["T_WHITESPACE"," ",348],"{",["T_WHITESPACE"," ",348],["T_COMMENT","\/\/  || !preg_match('\/^[a-z\\d\\s]+$\/i', $refId)\n",348],["T_WHITESPACE","            ",349],["T_VARIABLE","$errors",349],"[","]",["T_WHITESPACE"," ",349],"=",["T_WHITESPACE"," ",349],["T_STRING","Mage",349],["T_DOUBLE_COLON","::",349],["T_STRING","helper",349],"(",["T_CONSTANT_ENCAPSED_STRING","'paypal'",349],")",["T_OBJECT_OPERATOR","->",349],["T_STRING","__",349],"(",["T_CONSTANT_ENCAPSED_STRING","'Merchant reference ID format is not supported.'",349],")",";",["T_WHITESPACE","\n        ",349],"}",["T_WHITESPACE","\n        ",350],["T_VARIABLE","$scheduleDescr",351],["T_WHITESPACE"," ",351],"=",["T_WHITESPACE"," ",351],["T_VARIABLE","$profile",351],["T_OBJECT_OPERATOR","->",351],["T_STRING","getScheduleDescription",351],"(",")",";",["T_WHITESPACE"," ",351],["T_COMMENT","\/\/ up to 127 single-byte alphanumeric\n",351],["T_WHITESPACE","        ",352],["T_IF","if",352],["T_WHITESPACE"," ",352],"(",["T_STRING","strlen",352],"(",["T_VARIABLE","$refId",352],")",["T_WHITESPACE"," ",352],">",["T_WHITESPACE"," ",352],["T_LNUMBER","127",352],")",["T_WHITESPACE"," ",352],"{",["T_WHITESPACE"," ",352],["T_COMMENT","\/\/  || !preg_match('\/^[a-z\\d\\s]+$\/i', $scheduleDescr)\n",352],["T_WHITESPACE","            ",353],["T_VARIABLE","$errors",353],"[","]",["T_WHITESPACE"," ",353],"=",["T_WHITESPACE"," ",353],["T_STRING","Mage",353],["T_DOUBLE_COLON","::",353],["T_STRING","helper",353],"(",["T_CONSTANT_ENCAPSED_STRING","'paypal'",353],")",["T_OBJECT_OPERATOR","->",353],["T_STRING","__",353],"(",["T_CONSTANT_ENCAPSED_STRING","'Schedule description is too long.'",353],")",";",["T_WHITESPACE","\n        ",353],"}",["T_WHITESPACE","\n        ",354],["T_IF","if",355],["T_WHITESPACE"," ",355],"(",["T_VARIABLE","$errors",355],")",["T_WHITESPACE"," ",355],"{",["T_WHITESPACE","\n            ",355],["T_STRING","Mage",356],["T_DOUBLE_COLON","::",356],["T_STRING","throwException",356],"(",["T_STRING","implode",356],"(",["T_CONSTANT_ENCAPSED_STRING","' '",356],",",["T_WHITESPACE"," ",356],["T_VARIABLE","$errors",356],")",")",";",["T_WHITESPACE","\n        ",356],"}",["T_WHITESPACE","\n    ",357],"}",["T_WHITESPACE","\n\n    ",358],["T_DOC_COMMENT","\/**\n     * Submit RP to the gateway\n     *\n     * @param Mage_Payment_Model_Recurring_Profile $profile\n     * @param Mage_Payment_Model_Info $paymentInfo\n     * @throws Mage_Core_Exception\n     *\/",360],["T_WHITESPACE","\n    ",366],["T_PUBLIC","public",367],["T_WHITESPACE"," ",367],["T_FUNCTION","function",367],["T_WHITESPACE"," ",367],["T_STRING","submitRecurringProfile",367],"(",["T_STRING","Mage_Payment_Model_Recurring_Profile",367],["T_WHITESPACE"," ",367],["T_VARIABLE","$profile",367],",",["T_WHITESPACE","\n        ",367],["T_STRING","Mage_Payment_Model_Info",368],["T_WHITESPACE"," ",368],["T_VARIABLE","$paymentInfo",368],["T_WHITESPACE","\n    ",368],")",["T_WHITESPACE"," ",369],"{",["T_WHITESPACE","\n        ",369],["T_VARIABLE","$api",370],["T_WHITESPACE"," ",370],"=",["T_WHITESPACE"," ",370],["T_VARIABLE","$this",370],["T_OBJECT_OPERATOR","->",370],["T_STRING","getApi",370],"(",")",";",["T_WHITESPACE","\n        ",370],["T_STRING","Varien_Object_Mapper",371],["T_DOUBLE_COLON","::",371],["T_STRING","accumulateByMap",371],"(",["T_VARIABLE","$profile",371],",",["T_WHITESPACE"," ",371],["T_VARIABLE","$api",371],",",["T_WHITESPACE"," ",371],["T_ARRAY","array",371],"(",["T_WHITESPACE","\n            ",371],["T_CONSTANT_ENCAPSED_STRING","'token'",372],",",["T_WHITESPACE"," ",372],["T_COMMENT","\/\/ EC fields\n",372],["T_WHITESPACE","            ",373],["T_COMMENT","\/\/ TODO: DP fields\n",373],["T_WHITESPACE","            ",374],["T_COMMENT","\/\/ profile fields\n",374],["T_WHITESPACE","            ",375],["T_CONSTANT_ENCAPSED_STRING","'subscriber_name'",375],",",["T_WHITESPACE"," ",375],["T_CONSTANT_ENCAPSED_STRING","'start_datetime'",375],",",["T_WHITESPACE"," ",375],["T_CONSTANT_ENCAPSED_STRING","'internal_reference_id'",375],",",["T_WHITESPACE"," ",375],["T_CONSTANT_ENCAPSED_STRING","'schedule_description'",375],",",["T_WHITESPACE","\n            ",375],["T_CONSTANT_ENCAPSED_STRING","'suspension_threshold'",376],",",["T_WHITESPACE"," ",376],["T_CONSTANT_ENCAPSED_STRING","'bill_failed_later'",376],",",["T_WHITESPACE"," ",376],["T_CONSTANT_ENCAPSED_STRING","'period_unit'",376],",",["T_WHITESPACE"," ",376],["T_CONSTANT_ENCAPSED_STRING","'period_frequency'",376],",",["T_WHITESPACE"," ",376],["T_CONSTANT_ENCAPSED_STRING","'period_max_cycles'",376],",",["T_WHITESPACE","\n            ",376],["T_CONSTANT_ENCAPSED_STRING","'billing_amount'",377],["T_WHITESPACE"," ",377],["T_DOUBLE_ARROW","=>",377],["T_WHITESPACE"," ",377],["T_CONSTANT_ENCAPSED_STRING","'amount'",377],",",["T_WHITESPACE"," ",377],["T_CONSTANT_ENCAPSED_STRING","'trial_period_unit'",377],",",["T_WHITESPACE"," ",377],["T_CONSTANT_ENCAPSED_STRING","'trial_period_frequency'",377],",",["T_WHITESPACE"," ",377],["T_CONSTANT_ENCAPSED_STRING","'trial_period_max_cycles'",377],",",["T_WHITESPACE","\n            ",377],["T_CONSTANT_ENCAPSED_STRING","'trial_billing_amount'",378],",",["T_WHITESPACE"," ",378],["T_CONSTANT_ENCAPSED_STRING","'currency_code'",378],",",["T_WHITESPACE"," ",378],["T_CONSTANT_ENCAPSED_STRING","'shipping_amount'",378],",",["T_WHITESPACE"," ",378],["T_CONSTANT_ENCAPSED_STRING","'tax_amount'",378],",",["T_WHITESPACE"," ",378],["T_CONSTANT_ENCAPSED_STRING","'init_amount'",378],",",["T_WHITESPACE"," ",378],["T_CONSTANT_ENCAPSED_STRING","'init_may_fail'",378],",",["T_WHITESPACE","\n        ",378],")",")",";",["T_WHITESPACE","\n        ",379],["T_VARIABLE","$api",380],["T_OBJECT_OPERATOR","->",380],["T_STRING","callCreateRecurringPaymentsProfile",380],"(",")",";",["T_WHITESPACE","\n        ",380],["T_VARIABLE","$profile",381],["T_OBJECT_OPERATOR","->",381],["T_STRING","setReferenceId",381],"(",["T_VARIABLE","$api",381],["T_OBJECT_OPERATOR","->",381],["T_STRING","getRecurringProfileId",381],"(",")",")",";",["T_WHITESPACE","\n        ",381],["T_IF","if",382],["T_WHITESPACE"," ",382],"(",["T_VARIABLE","$api",382],["T_OBJECT_OPERATOR","->",382],["T_STRING","getIsProfileActive",382],"(",")",")",["T_WHITESPACE"," ",382],"{",["T_WHITESPACE","\n            ",382],["T_VARIABLE","$profile",383],["T_OBJECT_OPERATOR","->",383],["T_STRING","setState",383],"(",["T_STRING","Mage_Sales_Model_Recurring_Profile",383],["T_DOUBLE_COLON","::",383],["T_STRING","STATE_ACTIVE",383],")",";",["T_WHITESPACE","\n        ",383],"}",["T_WHITESPACE"," ",384],["T_ELSEIF","elseif",384],["T_WHITESPACE"," ",384],"(",["T_VARIABLE","$api",384],["T_OBJECT_OPERATOR","->",384],["T_STRING","getIsProfilePending",384],"(",")",")",["T_WHITESPACE"," ",384],"{",["T_WHITESPACE","\n            ",384],["T_VARIABLE","$profile",385],["T_OBJECT_OPERATOR","->",385],["T_STRING","setState",385],"(",["T_STRING","Mage_Sales_Model_Recurring_Profile",385],["T_DOUBLE_COLON","::",385],["T_STRING","STATE_PENDING",385],")",";",["T_WHITESPACE","\n        ",385],"}",["T_WHITESPACE","\n    ",386],"}",["T_WHITESPACE","\n\n    ",387],["T_DOC_COMMENT","\/**\n     * Fetch RP details\n     *\n     * @param string $referenceId\n     * @param Varien_Object $result\n     *\/",389],["T_WHITESPACE","\n    ",394],["T_PUBLIC","public",395],["T_WHITESPACE"," ",395],["T_FUNCTION","function",395],["T_WHITESPACE"," ",395],["T_STRING","getRecurringProfileDetails",395],"(",["T_VARIABLE","$referenceId",395],",",["T_WHITESPACE"," ",395],["T_STRING","Varien_Object",395],["T_WHITESPACE"," ",395],["T_VARIABLE","$result",395],")",["T_WHITESPACE","\n    ",395],"{",["T_WHITESPACE","\n        ",396],["T_VARIABLE","$api",397],["T_WHITESPACE"," ",397],"=",["T_WHITESPACE"," ",397],["T_VARIABLE","$this",397],["T_OBJECT_OPERATOR","->",397],["T_STRING","getApi",397],"(",")",";",["T_WHITESPACE","\n        ",397],["T_VARIABLE","$api",398],["T_OBJECT_OPERATOR","->",398],["T_STRING","setRecurringProfileId",398],"(",["T_VARIABLE","$referenceId",398],")",["T_WHITESPACE","\n            ",398],["T_OBJECT_OPERATOR","->",399],["T_STRING","callGetRecurringPaymentsProfileDetails",399],"(",["T_VARIABLE","$result",399],")",["T_WHITESPACE","\n        ",399],";",["T_WHITESPACE","\n    ",400],"}",["T_WHITESPACE","\n\n    ",401],["T_DOC_COMMENT","\/**\n     * Update RP data\n     *\n     * @param Mage_Payment_Model_Recurring_Profile $profile\n     *\/",403],["T_WHITESPACE","\n    ",407],["T_PUBLIC","public",408],["T_WHITESPACE"," ",408],["T_FUNCTION","function",408],["T_WHITESPACE"," ",408],["T_STRING","updateRecurringProfile",408],"(",["T_STRING","Mage_Payment_Model_Recurring_Profile",408],["T_WHITESPACE"," ",408],["T_VARIABLE","$profile",408],")",["T_WHITESPACE","\n    ",408],"{",["T_WHITESPACE","\n\n    ",409],"}",["T_WHITESPACE","\n\n    ",411],["T_DOC_COMMENT","\/**\n     * Manage status\n     *\n     * @param Mage_Payment_Model_Recurring_Profile $profile\n     *\/",413],["T_WHITESPACE","\n    ",417],["T_PUBLIC","public",418],["T_WHITESPACE"," ",418],["T_FUNCTION","function",418],["T_WHITESPACE"," ",418],["T_STRING","updateRecurringProfileStatus",418],"(",["T_STRING","Mage_Payment_Model_Recurring_Profile",418],["T_WHITESPACE"," ",418],["T_VARIABLE","$profile",418],")",["T_WHITESPACE","\n    ",418],"{",["T_WHITESPACE","\n        ",419],["T_VARIABLE","$api",420],["T_WHITESPACE"," ",420],"=",["T_WHITESPACE"," ",420],["T_VARIABLE","$this",420],["T_OBJECT_OPERATOR","->",420],["T_STRING","getApi",420],"(",")",";",["T_WHITESPACE","\n        ",420],["T_VARIABLE","$action",421],["T_WHITESPACE"," ",421],"=",["T_WHITESPACE"," ",421],["T_STRING","null",421],";",["T_WHITESPACE","\n        ",421],["T_SWITCH","switch",422],["T_WHITESPACE"," ",422],"(",["T_VARIABLE","$profile",422],["T_OBJECT_OPERATOR","->",422],["T_STRING","getNewState",422],"(",")",")",["T_WHITESPACE"," ",422],"{",["T_WHITESPACE","\n            ",422],["T_CASE","case",423],["T_WHITESPACE"," ",423],["T_STRING","Mage_Sales_Model_Recurring_Profile",423],["T_DOUBLE_COLON","::",423],["T_STRING","STATE_CANCELED",423],":",["T_WHITESPACE"," ",423],["T_VARIABLE","$action",423],["T_WHITESPACE"," ",423],"=",["T_WHITESPACE"," ",423],["T_CONSTANT_ENCAPSED_STRING","'cancel'",423],";",["T_WHITESPACE"," ",423],["T_BREAK","break",423],";",["T_WHITESPACE","\n            ",423],["T_CASE","case",424],["T_WHITESPACE"," ",424],["T_STRING","Mage_Sales_Model_Recurring_Profile",424],["T_DOUBLE_COLON","::",424],["T_STRING","STATE_SUSPENDED",424],":",["T_WHITESPACE"," ",424],["T_VARIABLE","$action",424],["T_WHITESPACE"," ",424],"=",["T_WHITESPACE"," ",424],["T_CONSTANT_ENCAPSED_STRING","'suspend'",424],";",["T_WHITESPACE"," ",424],["T_BREAK","break",424],";",["T_WHITESPACE","\n            ",424],["T_CASE","case",425],["T_WHITESPACE"," ",425],["T_STRING","Mage_Sales_Model_Recurring_Profile",425],["T_DOUBLE_COLON","::",425],["T_STRING","STATE_ACTIVE",425],":",["T_WHITESPACE"," ",425],["T_VARIABLE","$action",425],["T_WHITESPACE"," ",425],"=",["T_WHITESPACE"," ",425],["T_CONSTANT_ENCAPSED_STRING","'activate'",425],";",["T_WHITESPACE"," ",425],["T_BREAK","break",425],";",["T_WHITESPACE","\n        ",425],"}",["T_WHITESPACE","\n        ",426],["T_VARIABLE","$state",427],["T_WHITESPACE"," ",427],"=",["T_WHITESPACE"," ",427],["T_VARIABLE","$profile",427],["T_OBJECT_OPERATOR","->",427],["T_STRING","getState",427],"(",")",";",["T_WHITESPACE","\n        ",427],["T_VARIABLE","$api",428],["T_OBJECT_OPERATOR","->",428],["T_STRING","setRecurringProfileId",428],"(",["T_VARIABLE","$profile",428],["T_OBJECT_OPERATOR","->",428],["T_STRING","getReferenceId",428],"(",")",")",["T_WHITESPACE","\n            ",428],["T_OBJECT_OPERATOR","->",429],["T_STRING","setIsAlreadyCanceled",429],"(",["T_VARIABLE","$state",429],["T_WHITESPACE"," ",429],["T_IS_EQUAL","==",429],["T_WHITESPACE"," ",429],["T_STRING","Mage_Sales_Model_Recurring_Profile",429],["T_DOUBLE_COLON","::",429],["T_STRING","STATE_CANCELED",429],")",["T_WHITESPACE","\n            ",429],["T_OBJECT_OPERATOR","->",430],["T_STRING","setIsAlreadySuspended",430],"(",["T_VARIABLE","$state",430],["T_WHITESPACE"," ",430],["T_IS_EQUAL","==",430],["T_WHITESPACE"," ",430],["T_STRING","Mage_Sales_Model_Recurring_Profile",430],["T_DOUBLE_COLON","::",430],["T_STRING","STATE_SUSPENDED",430],")",["T_WHITESPACE","\n            ",430],["T_OBJECT_OPERATOR","->",431],["T_STRING","setIsAlreadyActive",431],"(",["T_VARIABLE","$state",431],["T_WHITESPACE"," ",431],["T_IS_EQUAL","==",431],["T_WHITESPACE"," ",431],["T_STRING","Mage_Sales_Model_Recurring_Profile",431],["T_DOUBLE_COLON","::",431],["T_STRING","STATE_ACTIVE",431],")",["T_WHITESPACE","\n            ",431],["T_OBJECT_OPERATOR","->",432],["T_STRING","setAction",432],"(",["T_VARIABLE","$action",432],")",["T_WHITESPACE","\n            ",432],["T_OBJECT_OPERATOR","->",433],["T_STRING","callManageRecurringPaymentsProfileStatus",433],"(",")",["T_WHITESPACE","\n        ",433],";",["T_WHITESPACE","\n    ",434],"}",["T_WHITESPACE","\n\n    ",435],["T_DOC_COMMENT","\/**\n     * Import capture results to payment\n     *\n     * @param Mage_Paypal_Model_Api_Nvp\n     * @param Mage_Sales_Model_Order_Payment\n     *\/",437],["T_WHITESPACE","\n    ",442],["T_PROTECTED","protected",443],["T_WHITESPACE"," ",443],["T_FUNCTION","function",443],["T_WHITESPACE"," ",443],["T_STRING","_importCaptureResultToPayment",443],"(",["T_VARIABLE","$api",443],",",["T_WHITESPACE"," ",443],["T_VARIABLE","$payment",443],")",["T_WHITESPACE","\n    ",443],"{",["T_WHITESPACE","\n        ",444],["T_VARIABLE","$payment",445],["T_OBJECT_OPERATOR","->",445],["T_STRING","setTransactionId",445],"(",["T_VARIABLE","$api",445],["T_OBJECT_OPERATOR","->",445],["T_STRING","getTransactionId",445],"(",")",")",["T_OBJECT_OPERATOR","->",445],["T_STRING","setIsTransactionClosed",445],"(",["T_STRING","false",445],")",";",["T_WHITESPACE","\n        ",445],["T_VARIABLE","$this",446],["T_OBJECT_OPERATOR","->",446],["T_STRING","importPaymentInfo",446],"(",["T_VARIABLE","$api",446],",",["T_WHITESPACE"," ",446],["T_VARIABLE","$payment",446],")",";",["T_WHITESPACE","\n    ",446],"}",["T_WHITESPACE","\n\n    ",447],["T_DOC_COMMENT","\/**\n     * Import refund results to payment\n     *\n     * @param Mage_Paypal_Model_Api_Nvp\n     * @param Mage_Sales_Model_Order_Payment\n     * @param bool $canRefundMore\n     *\/",449],["T_WHITESPACE","\n    ",455],["T_PROTECTED","protected",456],["T_WHITESPACE"," ",456],["T_FUNCTION","function",456],["T_WHITESPACE"," ",456],["T_STRING","_importRefundResultToPayment",456],"(",["T_VARIABLE","$api",456],",",["T_WHITESPACE"," ",456],["T_VARIABLE","$payment",456],",",["T_WHITESPACE"," ",456],["T_VARIABLE","$canRefundMore",456],")",["T_WHITESPACE","\n    ",456],"{",["T_WHITESPACE","\n        ",457],["T_VARIABLE","$payment",458],["T_OBJECT_OPERATOR","->",458],["T_STRING","setTransactionId",458],"(",["T_VARIABLE","$api",458],["T_OBJECT_OPERATOR","->",458],["T_STRING","getRefundTransactionId",458],"(",")",")",["T_WHITESPACE","\n                ",458],["T_OBJECT_OPERATOR","->",459],["T_STRING","setIsTransactionClosed",459],"(",["T_LNUMBER","1",459],")",["T_WHITESPACE"," ",459],["T_COMMENT","\/\/ refund initiated by merchant\n",459],["T_WHITESPACE","                ",460],["T_OBJECT_OPERATOR","->",460],["T_STRING","setShouldCloseParentTransaction",460],"(","!",["T_VARIABLE","$canRefundMore",460],")",["T_WHITESPACE","\n            ",460],";",["T_WHITESPACE","\n        ",461],["T_VARIABLE","$this",462],["T_OBJECT_OPERATOR","->",462],["T_STRING","importPaymentInfo",462],"(",["T_VARIABLE","$api",462],",",["T_WHITESPACE"," ",462],["T_VARIABLE","$payment",462],")",";",["T_WHITESPACE","\n    ",462],"}",["T_WHITESPACE","\n\n    ",463],["T_DOC_COMMENT","\/**\n     * Parent transaction id getter\n     *\n     * @param Varien_Object $payment\n     * @return string\n     *\/",465],["T_WHITESPACE","\n    ",470],["T_PROTECTED","protected",471],["T_WHITESPACE"," ",471],["T_FUNCTION","function",471],["T_WHITESPACE"," ",471],["T_STRING","_getParentTransactionId",471],"(",["T_STRING","Varien_Object",471],["T_WHITESPACE"," ",471],["T_VARIABLE","$payment",471],")",["T_WHITESPACE","\n    ",471],"{",["T_WHITESPACE","\n        ",472],["T_RETURN","return",473],["T_WHITESPACE"," ",473],["T_VARIABLE","$payment",473],["T_OBJECT_OPERATOR","->",473],["T_STRING","getParentTransactionId",473],"(",")",["T_WHITESPACE"," ",473],"?",["T_WHITESPACE"," ",473],["T_VARIABLE","$payment",473],["T_OBJECT_OPERATOR","->",473],["T_STRING","getParentTransactionId",473],"(",")",["T_WHITESPACE"," ",473],":",["T_WHITESPACE"," ",473],["T_VARIABLE","$payment",473],["T_OBJECT_OPERATOR","->",473],["T_STRING","getLastTransId",473],"(",")",";",["T_WHITESPACE","\n    ",473],"}",["T_WHITESPACE","\n",474],"}",["T_WHITESPACE","\n",475]]