[["T_OPEN_TAG","<?php\n",1],["T_DOC_COMMENT","\/**\n * Magento\n *\n * NOTICE OF LICENSE\n *\n * This source file is subject to the Open Software License (OSL 3.0)\n * that is bundled with this package in the file LICENSE.txt.\n * It is also available through the world-wide-web at this URL:\n * http:\/\/opensource.org\/licenses\/osl-3.0.php\n * If you did not receive a copy of the license and are unable to\n * obtain it through the world-wide-web, please send an email\n * to license@magento.com so we can send you a copy immediately.\n *\n * DISCLAIMER\n *\n * Do not edit or add to this file if you wish to upgrade Magento to newer\n * versions in the future. If you wish to customize Magento for your\n * needs please refer to http:\/\/www.magento.com for more information.\n *\n * @category    Mage\n * @package     Mage_Sales\n * @copyright  Copyright (c) 2006-2016 X.commerce, Inc. and affiliates (http:\/\/www.magento.com)\n * @license    http:\/\/opensource.org\/licenses\/osl-3.0.php  Open Software License (OSL 3.0)\n *\/",2],["T_WHITESPACE","\n\n",25],["T_DOC_COMMENT","\/**\n * Order payment information\n *\n * @method Mage_Sales_Model_Resource_Order_Payment _getResource()\n * @method Mage_Sales_Model_Resource_Order_Payment getResource()\n * @method int getParentId()\n * @method Mage_Sales_Model_Order_Payment setParentId(int $value)\n * @method float getBaseShippingCaptured()\n * @method Mage_Sales_Model_Order_Payment setBaseShippingCaptured(float $value)\n * @method float getShippingCaptured()\n * @method Mage_Sales_Model_Order_Payment setShippingCaptured(float $value)\n * @method float getAmountRefunded()\n * @method Mage_Sales_Model_Order_Payment setAmountRefunded(float $value)\n * @method float getBaseAmountPaid()\n * @method Mage_Sales_Model_Order_Payment setBaseAmountPaid(float $value)\n * @method float getAmountCanceled()\n * @method Mage_Sales_Model_Order_Payment setAmountCanceled(float $value)\n * @method float getBaseAmountAuthorized()\n * @method Mage_Sales_Model_Order_Payment setBaseAmountAuthorized(float $value)\n * @method float getBaseAmountPaidOnline()\n * @method Mage_Sales_Model_Order_Payment setBaseAmountPaidOnline(float $value)\n * @method float getBaseAmountRefundedOnline()\n * @method Mage_Sales_Model_Order_Payment setBaseAmountRefundedOnline(float $value)\n * @method float getBaseShippingAmount()\n * @method Mage_Sales_Model_Order_Payment setBaseShippingAmount(float $value)\n * @method float getShippingAmount()\n * @method Mage_Sales_Model_Order_Payment setShippingAmount(float $value)\n * @method float getAmountPaid()\n * @method Mage_Sales_Model_Order_Payment setAmountPaid(float $value)\n * @method float getAmountAuthorized()\n * @method Mage_Sales_Model_Order_Payment setAmountAuthorized(float $value)\n * @method float getBaseAmountOrdered()\n * @method Mage_Sales_Model_Order_Payment setBaseAmountOrdered(float $value)\n * @method float getBaseShippingRefunded()\n * @method Mage_Sales_Model_Order_Payment setBaseShippingRefunded(float $value)\n * @method float getShippingRefunded()\n * @method Mage_Sales_Model_Order_Payment setShippingRefunded(float $value)\n * @method float getBaseAmountRefunded()\n * @method Mage_Sales_Model_Order_Payment setBaseAmountRefunded(float $value)\n * @method float getAmountOrdered()\n * @method Mage_Sales_Model_Order_Payment setAmountOrdered(float $value)\n * @method float getBaseAmountCanceled()\n * @method Mage_Sales_Model_Order_Payment setBaseAmountCanceled(float $value)\n * @method int getIdealTransactionChecked()\n * @method Mage_Sales_Model_Order_Payment setIdealTransactionChecked(int $value)\n * @method int getQuotePaymentId()\n * @method Mage_Sales_Model_Order_Payment setQuotePaymentId(int $value)\n * @method string getAdditionalData()\n * @method Mage_Sales_Model_Order_Payment setAdditionalData(string $value)\n * @method string getCcExpMonth()\n * @method Mage_Sales_Model_Order_Payment setCcExpMonth(string $value)\n * @method string getCcSsStartYear()\n * @method Mage_Sales_Model_Order_Payment setCcSsStartYear(string $value)\n * @method string getEcheckBankName()\n * @method Mage_Sales_Model_Order_Payment setEcheckBankName(string $value)\n * @method string getMethod()\n * @method Mage_Sales_Model_Order_Payment setMethod(string $value)\n * @method string getCcDebugRequestBody()\n * @method Mage_Sales_Model_Order_Payment setCcDebugRequestBody(string $value)\n * @method string getCcSecureVerify()\n * @method Mage_Sales_Model_Order_Payment setCcSecureVerify(string $value)\n * @method string getCybersourceToken()\n * @method Mage_Sales_Model_Order_Payment setCybersourceToken(string $value)\n * @method string getIdealIssuerTitle()\n * @method Mage_Sales_Model_Order_Payment setIdealIssuerTitle(string $value)\n * @method string getProtectionEligibility()\n * @method Mage_Sales_Model_Order_Payment setProtectionEligibility(string $value)\n * @method string getCcApproval()\n * @method Mage_Sales_Model_Order_Payment setCcApproval(string $value)\n * @method string getCcLast4()\n * @method Mage_Sales_Model_Order_Payment setCcLast4(string $value)\n * @method string getCcStatusDescription()\n * @method Mage_Sales_Model_Order_Payment setCcStatusDescription(string $value)\n * @method string getEcheckType()\n * @method Mage_Sales_Model_Order_Payment setEcheckType(string $value)\n * @method string getPayboxQuestionNumber()\n * @method Mage_Sales_Model_Order_Payment setPayboxQuestionNumber(string $value)\n * @method string getCcDebugResponseSerialized()\n * @method Mage_Sales_Model_Order_Payment setCcDebugResponseSerialized(string $value)\n * @method string getCcSsStartMonth()\n * @method Mage_Sales_Model_Order_Payment setCcSsStartMonth(string $value)\n * @method string getEcheckAccountType()\n * @method Mage_Sales_Model_Order_Payment setEcheckAccountType(string $value)\n * @method string getLastTransId()\n * @method Mage_Sales_Model_Order_Payment setLastTransId(string $value)\n * @method string getCcCidStatus()\n * @method Mage_Sales_Model_Order_Payment setCcCidStatus(string $value)\n * @method string getCcOwner()\n * @method Mage_Sales_Model_Order_Payment setCcOwner(string $value)\n * @method string getCcType()\n * @method Mage_Sales_Model_Order_Payment setCcType(string $value)\n * @method string getIdealIssuerId()\n * @method Mage_Sales_Model_Order_Payment setIdealIssuerId(string $value)\n * @method string getPoNumber()\n * @method Mage_Sales_Model_Order_Payment setPoNumber(string $value)\n * @method string getCcExpYear()\n * @method Mage_Sales_Model_Order_Payment setCcExpYear(string $value)\n * @method string getCcStatus()\n * @method Mage_Sales_Model_Order_Payment setCcStatus(string $value)\n * @method string getEcheckRoutingNumber()\n * @method Mage_Sales_Model_Order_Payment setEcheckRoutingNumber(string $value)\n * @method string getAccountStatus()\n * @method Mage_Sales_Model_Order_Payment setAccountStatus(string $value)\n * @method string getAnetTransMethod()\n * @method Mage_Sales_Model_Order_Payment setAnetTransMethod(string $value)\n * @method string getCcDebugResponseBody()\n * @method Mage_Sales_Model_Order_Payment setCcDebugResponseBody(string $value)\n * @method string getCcSsIssue()\n * @method Mage_Sales_Model_Order_Payment setCcSsIssue(string $value)\n * @method string getEcheckAccountName()\n * @method Mage_Sales_Model_Order_Payment setEcheckAccountName(string $value)\n * @method string getCcAvsStatus()\n * @method Mage_Sales_Model_Order_Payment setCcAvsStatus(string $value)\n * @method string getCcNumberEnc()\n * @method Mage_Sales_Model_Order_Payment setCcNumberEnc(string $value)\n * @method string getCcTransId()\n * @method Mage_Sales_Model_Order_Payment setCcTransId(string $value)\n * @method string getFlo2cashAccountId()\n * @method Mage_Sales_Model_Order_Payment setFlo2cashAccountId(string $value)\n * @method string getPayboxRequestNumber()\n * @method Mage_Sales_Model_Order_Payment setPayboxRequestNumber(string $value)\n * @method string getAddressStatus()\n * @method Mage_Sales_Model_Order_Payment setAddressStatus(string $value)\n *\n * @category    Mage\n * @package     Mage_Sales\n * @author      Magento Core Team <core@magentocommerce.com>\n *\/",27],["T_WHITESPACE","\n",154],["T_CLASS","class",155],["T_WHITESPACE"," ",155],["T_STRING","Mage_Sales_Model_Order_Payment",155],["T_WHITESPACE"," ",155],["T_EXTENDS","extends",155],["T_WHITESPACE"," ",155],["T_STRING","Mage_Payment_Model_Info",155],["T_WHITESPACE","\n",155],"{",["T_WHITESPACE","\n    ",156],["T_DOC_COMMENT","\/**\n     * Actions for payment when it triggered review state:\n     *\n     * Accept action\n     *\/",157],["T_WHITESPACE","\n    ",161],["T_CONST","const",162],["T_WHITESPACE"," ",162],["T_STRING","REVIEW_ACTION_ACCEPT",162],["T_WHITESPACE"," ",162],"=",["T_WHITESPACE"," ",162],["T_CONSTANT_ENCAPSED_STRING","'accept'",162],";",["T_WHITESPACE","\n\n    ",162],["T_DOC_COMMENT","\/**\n     * Deny action\n     *\/",164],["T_WHITESPACE","\n    ",166],["T_CONST","const",167],["T_WHITESPACE"," ",167],["T_STRING","REVIEW_ACTION_DENY",167],["T_WHITESPACE","   ",167],"=",["T_WHITESPACE"," ",167],["T_CONSTANT_ENCAPSED_STRING","'deny'",167],";",["T_WHITESPACE","\n\n    ",167],["T_DOC_COMMENT","\/**\n     * Update action\n     *\/",169],["T_WHITESPACE","\n    ",171],["T_CONST","const",172],["T_WHITESPACE"," ",172],["T_STRING","REVIEW_ACTION_UPDATE",172],["T_WHITESPACE"," ",172],"=",["T_WHITESPACE"," ",172],["T_CONSTANT_ENCAPSED_STRING","'update'",172],";",["T_WHITESPACE","\n\n    ",172],["T_DOC_COMMENT","\/**\n     * Order model object\n     *\n     * @var Mage_Sales_Model_Order\n     *\/",174],["T_WHITESPACE","\n    ",178],["T_PROTECTED","protected",179],["T_WHITESPACE"," ",179],["T_VARIABLE","$_order",179],";",["T_WHITESPACE","\n\n    ",179],["T_DOC_COMMENT","\/**\n     * Billing agreement instance that may be created during payment processing\n     *\n     * @var Mage_Sales_Model_Billing_Agreement\n     *\/",181],["T_WHITESPACE","\n    ",185],["T_PROTECTED","protected",186],["T_WHITESPACE"," ",186],["T_VARIABLE","$_billingAgreement",186],["T_WHITESPACE"," ",186],"=",["T_WHITESPACE"," ",186],["T_STRING","null",186],";",["T_WHITESPACE","\n\n    ",186],["T_DOC_COMMENT","\/**\n     * Whether can void\n     * @var string\n     *\/",188],["T_WHITESPACE","\n    ",191],["T_PROTECTED","protected",192],["T_WHITESPACE"," ",192],["T_VARIABLE","$_canVoidLookup",192],["T_WHITESPACE"," ",192],"=",["T_WHITESPACE"," ",192],["T_STRING","null",192],";",["T_WHITESPACE","\n\n    ",192],["T_DOC_COMMENT","\/**\n     * Transactions registry to spare resource calls\n     * array(txn_id => sales\/order_payment_transaction)\n     * @var array\n     *\/",194],["T_WHITESPACE","\n    ",198],["T_PROTECTED","protected",199],["T_WHITESPACE"," ",199],["T_VARIABLE","$_transactionsLookup",199],["T_WHITESPACE"," ",199],"=",["T_WHITESPACE"," ",199],["T_ARRAY","array",199],"(",")",";",["T_WHITESPACE","\n\n    ",199],["T_DOC_COMMENT","\/**\n     * Event prefix\n     *\n     * @var string\n     *\/",201],["T_WHITESPACE","\n    ",205],["T_PROTECTED","protected",206],["T_WHITESPACE"," ",206],["T_VARIABLE","$_eventPrefix",206],["T_WHITESPACE"," ",206],"=",["T_WHITESPACE"," ",206],["T_CONSTANT_ENCAPSED_STRING","'sales_order_payment'",206],";",["T_WHITESPACE","\n\n    ",206],["T_DOC_COMMENT","\/**\n     * Event object\n     *\n     * @var string\n     *\/",208],["T_WHITESPACE","\n    ",212],["T_PROTECTED","protected",213],["T_WHITESPACE"," ",213],["T_VARIABLE","$_eventObject",213],["T_WHITESPACE"," ",213],"=",["T_WHITESPACE"," ",213],["T_CONSTANT_ENCAPSED_STRING","'payment'",213],";",["T_WHITESPACE","\n\n    ",213],["T_DOC_COMMENT","\/**\n     * Transaction addditional information container\n     *\n     * @var array\n     *\/",215],["T_WHITESPACE","\n    ",219],["T_PROTECTED","protected",220],["T_WHITESPACE"," ",220],["T_VARIABLE","$_transactionAdditionalInfo",220],["T_WHITESPACE"," ",220],"=",["T_WHITESPACE"," ",220],["T_ARRAY","array",220],"(",")",";",["T_WHITESPACE","\n\n    ",220],["T_DOC_COMMENT","\/**\n     * Initialize resource model\n     *\/",222],["T_WHITESPACE","\n    ",224],["T_PROTECTED","protected",225],["T_WHITESPACE"," ",225],["T_FUNCTION","function",225],["T_WHITESPACE"," ",225],["T_STRING","_construct",225],"(",")",["T_WHITESPACE","\n    ",225],"{",["T_WHITESPACE","\n        ",226],["T_VARIABLE","$this",227],["T_OBJECT_OPERATOR","->",227],["T_STRING","_init",227],"(",["T_CONSTANT_ENCAPSED_STRING","'sales\/order_payment'",227],")",";",["T_WHITESPACE","\n    ",227],"}",["T_WHITESPACE","\n\n    ",228],["T_DOC_COMMENT","\/**\n     * Declare order model object\n     *\n     * @param   Mage_Sales_Model_Order $order\n     * @return  Mage_Sales_Model_Order_Payment\n     *\/",230],["T_WHITESPACE","\n    ",235],["T_PUBLIC","public",236],["T_WHITESPACE"," ",236],["T_FUNCTION","function",236],["T_WHITESPACE"," ",236],["T_STRING","setOrder",236],"(",["T_STRING","Mage_Sales_Model_Order",236],["T_WHITESPACE"," ",236],["T_VARIABLE","$order",236],")",["T_WHITESPACE","\n    ",236],"{",["T_WHITESPACE","\n        ",237],["T_VARIABLE","$this",238],["T_OBJECT_OPERATOR","->",238],["T_STRING","_order",238],["T_WHITESPACE"," ",238],"=",["T_WHITESPACE"," ",238],["T_VARIABLE","$order",238],";",["T_WHITESPACE","\n        ",238],["T_RETURN","return",239],["T_WHITESPACE"," ",239],["T_VARIABLE","$this",239],";",["T_WHITESPACE","\n    ",239],"}",["T_WHITESPACE","\n\n    ",240],["T_DOC_COMMENT","\/**\n     * Retrieve order model object\n     *\n     * @return Mage_Sales_Model_Order\n     *\/",242],["T_WHITESPACE","\n    ",246],["T_PUBLIC","public",247],["T_WHITESPACE"," ",247],["T_FUNCTION","function",247],["T_WHITESPACE"," ",247],["T_STRING","getOrder",247],"(",")",["T_WHITESPACE","\n    ",247],"{",["T_WHITESPACE","\n        ",248],["T_RETURN","return",249],["T_WHITESPACE"," ",249],["T_VARIABLE","$this",249],["T_OBJECT_OPERATOR","->",249],["T_STRING","_order",249],";",["T_WHITESPACE","\n    ",249],"}",["T_WHITESPACE","\n\n    ",250],["T_DOC_COMMENT","\/**\n     * Check order payment capture action availability\n     *\n     * @return bool\n     *\/",252],["T_WHITESPACE","\n    ",256],["T_PUBLIC","public",257],["T_WHITESPACE"," ",257],["T_FUNCTION","function",257],["T_WHITESPACE"," ",257],["T_STRING","canCapture",257],"(",")",["T_WHITESPACE","\n    ",257],"{",["T_WHITESPACE","\n        ",258],["T_IF","if",259],["T_WHITESPACE"," ",259],"(","!",["T_VARIABLE","$this",259],["T_OBJECT_OPERATOR","->",259],["T_STRING","getMethodInstance",259],"(",")",["T_OBJECT_OPERATOR","->",259],["T_STRING","canCapture",259],"(",")",")",["T_WHITESPACE"," ",259],"{",["T_WHITESPACE","\n            ",259],["T_RETURN","return",260],["T_WHITESPACE"," ",260],["T_STRING","false",260],";",["T_WHITESPACE","\n        ",260],"}",["T_WHITESPACE","\n        ",261],["T_COMMENT","\/\/ Check Authoriztion transaction state\n",262],["T_WHITESPACE","        ",263],["T_VARIABLE","$authTransaction",263],["T_WHITESPACE"," ",263],"=",["T_WHITESPACE"," ",263],["T_VARIABLE","$this",263],["T_OBJECT_OPERATOR","->",263],["T_STRING","getAuthorizationTransaction",263],"(",")",";",["T_WHITESPACE","\n        ",263],["T_IF","if",264],["T_WHITESPACE"," ",264],"(",["T_VARIABLE","$authTransaction",264],["T_WHITESPACE"," ",264],["T_BOOLEAN_AND","&&",264],["T_WHITESPACE"," ",264],["T_VARIABLE","$authTransaction",264],["T_OBJECT_OPERATOR","->",264],["T_STRING","getIsClosed",264],"(",")",")",["T_WHITESPACE"," ",264],"{",["T_WHITESPACE","\n            ",264],["T_VARIABLE","$orderTransaction",265],["T_WHITESPACE"," ",265],"=",["T_WHITESPACE"," ",265],["T_VARIABLE","$this",265],["T_OBJECT_OPERATOR","->",265],["T_STRING","_lookupTransaction",265],"(",["T_STRING","null",265],",",["T_WHITESPACE"," ",265],["T_STRING","Mage_Sales_Model_Order_Payment_Transaction",265],["T_DOUBLE_COLON","::",265],["T_STRING","TYPE_ORDER",265],")",";",["T_WHITESPACE","\n            ",265],["T_IF","if",266],["T_WHITESPACE"," ",266],"(","!",["T_VARIABLE","$orderTransaction",266],")",["T_WHITESPACE"," ",266],"{",["T_WHITESPACE","\n                ",266],["T_RETURN","return",267],["T_WHITESPACE"," ",267],["T_STRING","false",267],";",["T_WHITESPACE","\n            ",267],"}",["T_WHITESPACE","\n        ",268],"}",["T_WHITESPACE","\n        ",269],["T_RETURN","return",270],["T_WHITESPACE"," ",270],["T_STRING","true",270],";",["T_WHITESPACE","\n    ",270],"}",["T_WHITESPACE","\n\n    ",271],["T_DOC_COMMENT","\/**\n     * Check whether refund could be done\n     *\n     * @return bool\n     *\/",273],["T_WHITESPACE","\n    ",277],["T_PUBLIC","public",278],["T_WHITESPACE"," ",278],["T_FUNCTION","function",278],["T_WHITESPACE"," ",278],["T_STRING","canRefund",278],"(",")",["T_WHITESPACE","\n    ",278],"{",["T_WHITESPACE","\n        ",279],["T_RETURN","return",280],["T_WHITESPACE"," ",280],["T_VARIABLE","$this",280],["T_OBJECT_OPERATOR","->",280],["T_STRING","getMethodInstance",280],"(",")",["T_OBJECT_OPERATOR","->",280],["T_STRING","canRefund",280],"(",")",";",["T_WHITESPACE","\n    ",280],"}",["T_WHITESPACE","\n\n    ",281],["T_DOC_COMMENT","\/**\n     * Check whether partial refund could be done\n     *\n     * @return bool\n     *\/",283],["T_WHITESPACE","\n    ",287],["T_PUBLIC","public",288],["T_WHITESPACE"," ",288],["T_FUNCTION","function",288],["T_WHITESPACE"," ",288],["T_STRING","canRefundPartialPerInvoice",288],"(",")",["T_WHITESPACE","\n    ",288],"{",["T_WHITESPACE","\n        ",289],["T_RETURN","return",290],["T_WHITESPACE"," ",290],["T_VARIABLE","$this",290],["T_OBJECT_OPERATOR","->",290],["T_STRING","getMethodInstance",290],"(",")",["T_OBJECT_OPERATOR","->",290],["T_STRING","canRefundPartialPerInvoice",290],"(",")",";",["T_WHITESPACE","\n    ",290],"}",["T_WHITESPACE","\n\n    ",291],["T_DOC_COMMENT","\/**\n     * Check whether partial capture could be done\n     *\n     * @return bool\n     *\/",293],["T_WHITESPACE","\n    ",297],["T_PUBLIC","public",298],["T_WHITESPACE"," ",298],["T_FUNCTION","function",298],["T_WHITESPACE"," ",298],["T_STRING","canCapturePartial",298],"(",")",["T_WHITESPACE","\n    ",298],"{",["T_WHITESPACE","\n        ",299],["T_RETURN","return",300],["T_WHITESPACE"," ",300],["T_VARIABLE","$this",300],["T_OBJECT_OPERATOR","->",300],["T_STRING","getMethodInstance",300],"(",")",["T_OBJECT_OPERATOR","->",300],["T_STRING","canCapturePartial",300],"(",")",";",["T_WHITESPACE","\n    ",300],"}",["T_WHITESPACE","\n\n    ",301],["T_DOC_COMMENT","\/**\n     * Authorize or authorize and capture payment on gateway, if applicable\n     * This method is supposed to be called only when order is placed\n     *\n     * @return Mage_Sales_Model_Order_Payment\n     *\/",303],["T_WHITESPACE","\n    ",308],["T_PUBLIC","public",309],["T_WHITESPACE"," ",309],["T_FUNCTION","function",309],["T_WHITESPACE"," ",309],["T_STRING","place",309],"(",")",["T_WHITESPACE","\n    ",309],"{",["T_WHITESPACE","\n        ",310],["T_STRING","Mage",311],["T_DOUBLE_COLON","::",311],["T_STRING","dispatchEvent",311],"(",["T_CONSTANT_ENCAPSED_STRING","'sales_order_payment_place_start'",311],",",["T_WHITESPACE"," ",311],["T_ARRAY","array",311],"(",["T_CONSTANT_ENCAPSED_STRING","'payment'",311],["T_WHITESPACE"," ",311],["T_DOUBLE_ARROW","=>",311],["T_WHITESPACE"," ",311],["T_VARIABLE","$this",311],")",")",";",["T_WHITESPACE","\n        ",311],["T_VARIABLE","$order",312],["T_WHITESPACE"," ",312],"=",["T_WHITESPACE"," ",312],["T_VARIABLE","$this",312],["T_OBJECT_OPERATOR","->",312],["T_STRING","getOrder",312],"(",")",";",["T_WHITESPACE","\n\n        ",312],["T_VARIABLE","$this",314],["T_OBJECT_OPERATOR","->",314],["T_STRING","setAmountOrdered",314],"(",["T_VARIABLE","$order",314],["T_OBJECT_OPERATOR","->",314],["T_STRING","getTotalDue",314],"(",")",")",";",["T_WHITESPACE","\n        ",314],["T_VARIABLE","$this",315],["T_OBJECT_OPERATOR","->",315],["T_STRING","setBaseAmountOrdered",315],"(",["T_VARIABLE","$order",315],["T_OBJECT_OPERATOR","->",315],["T_STRING","getBaseTotalDue",315],"(",")",")",";",["T_WHITESPACE","\n        ",315],["T_VARIABLE","$this",316],["T_OBJECT_OPERATOR","->",316],["T_STRING","setShippingAmount",316],"(",["T_VARIABLE","$order",316],["T_OBJECT_OPERATOR","->",316],["T_STRING","getShippingAmount",316],"(",")",")",";",["T_WHITESPACE","\n        ",316],["T_VARIABLE","$this",317],["T_OBJECT_OPERATOR","->",317],["T_STRING","setBaseShippingAmount",317],"(",["T_VARIABLE","$order",317],["T_OBJECT_OPERATOR","->",317],["T_STRING","getBaseShippingAmount",317],"(",")",")",";",["T_WHITESPACE","\n\n        ",317],["T_VARIABLE","$methodInstance",319],["T_WHITESPACE"," ",319],"=",["T_WHITESPACE"," ",319],["T_VARIABLE","$this",319],["T_OBJECT_OPERATOR","->",319],["T_STRING","getMethodInstance",319],"(",")",";",["T_WHITESPACE","\n        ",319],["T_VARIABLE","$methodInstance",320],["T_OBJECT_OPERATOR","->",320],["T_STRING","setStore",320],"(",["T_VARIABLE","$order",320],["T_OBJECT_OPERATOR","->",320],["T_STRING","getStoreId",320],"(",")",")",";",["T_WHITESPACE","\n        ",320],["T_VARIABLE","$orderState",321],["T_WHITESPACE"," ",321],"=",["T_WHITESPACE"," ",321],["T_STRING","Mage_Sales_Model_Order",321],["T_DOUBLE_COLON","::",321],["T_STRING","STATE_NEW",321],";",["T_WHITESPACE","\n        ",321],["T_VARIABLE","$stateObject",322],["T_WHITESPACE"," ",322],"=",["T_WHITESPACE"," ",322],["T_NEW","new",322],["T_WHITESPACE"," ",322],["T_STRING","Varien_Object",322],"(",")",";",["T_WHITESPACE","\n\n        ",322],["T_DOC_COMMENT","\/**\n         * Do order payment validation on payment method level\n         *\/",324],["T_WHITESPACE","\n        ",326],["T_VARIABLE","$methodInstance",327],["T_OBJECT_OPERATOR","->",327],["T_STRING","validate",327],"(",")",";",["T_WHITESPACE","\n        ",327],["T_VARIABLE","$action",328],["T_WHITESPACE"," ",328],"=",["T_WHITESPACE"," ",328],["T_VARIABLE","$methodInstance",328],["T_OBJECT_OPERATOR","->",328],["T_STRING","getConfigPaymentAction",328],"(",")",";",["T_WHITESPACE","\n        ",328],["T_IF","if",329],["T_WHITESPACE"," ",329],"(",["T_VARIABLE","$action",329],")",["T_WHITESPACE"," ",329],"{",["T_WHITESPACE","\n            ",329],["T_IF","if",330],["T_WHITESPACE"," ",330],"(",["T_VARIABLE","$methodInstance",330],["T_OBJECT_OPERATOR","->",330],["T_STRING","isInitializeNeeded",330],"(",")",")",["T_WHITESPACE"," ",330],"{",["T_WHITESPACE","\n                ",330],["T_DOC_COMMENT","\/**\n                 * For method initialization we have to use original config value for payment action\n                 *\/",331],["T_WHITESPACE","\n                ",333],["T_VARIABLE","$methodInstance",334],["T_OBJECT_OPERATOR","->",334],["T_STRING","initialize",334],"(",["T_VARIABLE","$methodInstance",334],["T_OBJECT_OPERATOR","->",334],["T_STRING","getConfigData",334],"(",["T_CONSTANT_ENCAPSED_STRING","'payment_action'",334],")",",",["T_WHITESPACE"," ",334],["T_VARIABLE","$stateObject",334],")",";",["T_WHITESPACE","\n            ",334],"}",["T_WHITESPACE"," ",335],["T_ELSE","else",335],["T_WHITESPACE"," ",335],"{",["T_WHITESPACE","\n                ",335],["T_VARIABLE","$orderState",336],["T_WHITESPACE"," ",336],"=",["T_WHITESPACE"," ",336],["T_STRING","Mage_Sales_Model_Order",336],["T_DOUBLE_COLON","::",336],["T_STRING","STATE_PROCESSING",336],";",["T_WHITESPACE","\n                ",336],["T_SWITCH","switch",337],["T_WHITESPACE"," ",337],"(",["T_VARIABLE","$action",337],")",["T_WHITESPACE"," ",337],"{",["T_WHITESPACE","\n                    ",337],["T_CASE","case",338],["T_WHITESPACE"," ",338],["T_STRING","Mage_Payment_Model_Method_Abstract",338],["T_DOUBLE_COLON","::",338],["T_STRING","ACTION_ORDER",338],":",["T_WHITESPACE","\n                        ",338],["T_VARIABLE","$this",339],["T_OBJECT_OPERATOR","->",339],["T_STRING","_order",339],"(",["T_VARIABLE","$order",339],["T_OBJECT_OPERATOR","->",339],["T_STRING","getBaseTotalDue",339],"(",")",")",";",["T_WHITESPACE","\n                        ",339],["T_BREAK","break",340],";",["T_WHITESPACE","\n                    ",340],["T_CASE","case",341],["T_WHITESPACE"," ",341],["T_STRING","Mage_Payment_Model_Method_Abstract",341],["T_DOUBLE_COLON","::",341],["T_STRING","ACTION_AUTHORIZE",341],":",["T_WHITESPACE","\n                        ",341],["T_VARIABLE","$this",342],["T_OBJECT_OPERATOR","->",342],["T_STRING","_authorize",342],"(",["T_STRING","true",342],",",["T_WHITESPACE"," ",342],["T_VARIABLE","$order",342],["T_OBJECT_OPERATOR","->",342],["T_STRING","getBaseTotalDue",342],"(",")",")",";",["T_WHITESPACE"," ",342],["T_COMMENT","\/\/ base amount will be set inside\n",342],["T_WHITESPACE","                        ",343],["T_VARIABLE","$this",343],["T_OBJECT_OPERATOR","->",343],["T_STRING","setAmountAuthorized",343],"(",["T_VARIABLE","$order",343],["T_OBJECT_OPERATOR","->",343],["T_STRING","getTotalDue",343],"(",")",")",";",["T_WHITESPACE","\n                        ",343],["T_BREAK","break",344],";",["T_WHITESPACE","\n                    ",344],["T_CASE","case",345],["T_WHITESPACE"," ",345],["T_STRING","Mage_Payment_Model_Method_Abstract",345],["T_DOUBLE_COLON","::",345],["T_STRING","ACTION_AUTHORIZE_CAPTURE",345],":",["T_WHITESPACE","\n                        ",345],["T_VARIABLE","$this",346],["T_OBJECT_OPERATOR","->",346],["T_STRING","setAmountAuthorized",346],"(",["T_VARIABLE","$order",346],["T_OBJECT_OPERATOR","->",346],["T_STRING","getTotalDue",346],"(",")",")",";",["T_WHITESPACE","\n                        ",346],["T_VARIABLE","$this",347],["T_OBJECT_OPERATOR","->",347],["T_STRING","setBaseAmountAuthorized",347],"(",["T_VARIABLE","$order",347],["T_OBJECT_OPERATOR","->",347],["T_STRING","getBaseTotalDue",347],"(",")",")",";",["T_WHITESPACE","\n                        ",347],["T_VARIABLE","$this",348],["T_OBJECT_OPERATOR","->",348],["T_STRING","capture",348],"(",["T_STRING","null",348],")",";",["T_WHITESPACE","\n                        ",348],["T_BREAK","break",349],";",["T_WHITESPACE","\n                    ",349],["T_DEFAULT","default",350],":",["T_WHITESPACE","\n                        ",350],["T_BREAK","break",351],";",["T_WHITESPACE","\n                ",351],"}",["T_WHITESPACE","\n            ",352],"}",["T_WHITESPACE","\n        ",353],"}",["T_WHITESPACE","\n\n        ",354],["T_VARIABLE","$this",356],["T_OBJECT_OPERATOR","->",356],["T_STRING","_createBillingAgreement",356],"(",")",";",["T_WHITESPACE","\n\n        ",356],["T_VARIABLE","$orderIsNotified",358],["T_WHITESPACE"," ",358],"=",["T_WHITESPACE"," ",358],["T_STRING","null",358],";",["T_WHITESPACE","\n        ",358],["T_IF","if",359],["T_WHITESPACE"," ",359],"(",["T_VARIABLE","$stateObject",359],["T_OBJECT_OPERATOR","->",359],["T_STRING","getState",359],"(",")",["T_WHITESPACE"," ",359],["T_BOOLEAN_AND","&&",359],["T_WHITESPACE"," ",359],["T_VARIABLE","$stateObject",359],["T_OBJECT_OPERATOR","->",359],["T_STRING","getStatus",359],"(",")",")",["T_WHITESPACE"," ",359],"{",["T_WHITESPACE","\n            ",359],["T_VARIABLE","$orderState",360],["T_WHITESPACE","      ",360],"=",["T_WHITESPACE"," ",360],["T_VARIABLE","$stateObject",360],["T_OBJECT_OPERATOR","->",360],["T_STRING","getState",360],"(",")",";",["T_WHITESPACE","\n            ",360],["T_VARIABLE","$orderStatus",361],["T_WHITESPACE","     ",361],"=",["T_WHITESPACE"," ",361],["T_VARIABLE","$stateObject",361],["T_OBJECT_OPERATOR","->",361],["T_STRING","getStatus",361],"(",")",";",["T_WHITESPACE","\n            ",361],["T_VARIABLE","$orderIsNotified",362],["T_WHITESPACE"," ",362],"=",["T_WHITESPACE"," ",362],["T_VARIABLE","$stateObject",362],["T_OBJECT_OPERATOR","->",362],["T_STRING","getIsNotified",362],"(",")",";",["T_WHITESPACE","\n        ",362],"}",["T_WHITESPACE"," ",363],["T_ELSE","else",363],["T_WHITESPACE"," ",363],"{",["T_WHITESPACE","\n            ",363],["T_VARIABLE","$orderStatus",364],["T_WHITESPACE"," ",364],"=",["T_WHITESPACE"," ",364],["T_VARIABLE","$methodInstance",364],["T_OBJECT_OPERATOR","->",364],["T_STRING","getConfigData",364],"(",["T_CONSTANT_ENCAPSED_STRING","'order_status'",364],")",";",["T_WHITESPACE","\n            ",364],["T_IF","if",365],["T_WHITESPACE"," ",365],"(","!",["T_VARIABLE","$orderStatus",365],")",["T_WHITESPACE"," ",365],"{",["T_WHITESPACE","\n                ",365],["T_VARIABLE","$orderStatus",366],["T_WHITESPACE"," ",366],"=",["T_WHITESPACE"," ",366],["T_VARIABLE","$order",366],["T_OBJECT_OPERATOR","->",366],["T_STRING","getConfig",366],"(",")",["T_OBJECT_OPERATOR","->",366],["T_STRING","getStateDefaultStatus",366],"(",["T_VARIABLE","$orderState",366],")",";",["T_WHITESPACE","\n            ",366],"}",["T_WHITESPACE"," ",367],["T_ELSE","else",367],["T_WHITESPACE"," ",367],"{",["T_WHITESPACE","\n                ",367],["T_COMMENT","\/\/ check if $orderStatus has assigned a state\n",368],["T_WHITESPACE","                ",369],["T_VARIABLE","$states",369],["T_WHITESPACE"," ",369],"=",["T_WHITESPACE"," ",369],["T_VARIABLE","$order",369],["T_OBJECT_OPERATOR","->",369],["T_STRING","getConfig",369],"(",")",["T_OBJECT_OPERATOR","->",369],["T_STRING","getStatusStates",369],"(",["T_VARIABLE","$orderStatus",369],")",";",["T_WHITESPACE","\n                ",369],["T_IF","if",370],["T_WHITESPACE"," ",370],"(",["T_STRING","count",370],"(",["T_VARIABLE","$states",370],")",["T_WHITESPACE"," ",370],["T_IS_EQUAL","==",370],["T_WHITESPACE"," ",370],["T_LNUMBER","0",370],")",["T_WHITESPACE"," ",370],"{",["T_WHITESPACE","\n                    ",370],["T_VARIABLE","$orderStatus",371],["T_WHITESPACE"," ",371],"=",["T_WHITESPACE"," ",371],["T_VARIABLE","$order",371],["T_OBJECT_OPERATOR","->",371],["T_STRING","getConfig",371],"(",")",["T_OBJECT_OPERATOR","->",371],["T_STRING","getStateDefaultStatus",371],"(",["T_VARIABLE","$orderState",371],")",";",["T_WHITESPACE","\n                ",371],"}",["T_WHITESPACE","\n            ",372],"}",["T_WHITESPACE","\n        ",373],"}",["T_WHITESPACE","\n        ",374],["T_VARIABLE","$isCustomerNotified",375],["T_WHITESPACE"," ",375],"=",["T_WHITESPACE"," ",375],"(",["T_STRING","null",375],["T_WHITESPACE"," ",375],["T_IS_NOT_IDENTICAL","!==",375],["T_WHITESPACE"," ",375],["T_VARIABLE","$orderIsNotified",375],")",["T_WHITESPACE"," ",375],"?",["T_WHITESPACE"," ",375],["T_VARIABLE","$orderIsNotified",375],["T_WHITESPACE"," ",375],":",["T_WHITESPACE"," ",375],["T_VARIABLE","$order",375],["T_OBJECT_OPERATOR","->",375],["T_STRING","getCustomerNoteNotify",375],"(",")",";",["T_WHITESPACE","\n        ",375],["T_VARIABLE","$message",376],["T_WHITESPACE"," ",376],"=",["T_WHITESPACE"," ",376],["T_VARIABLE","$order",376],["T_OBJECT_OPERATOR","->",376],["T_STRING","getCustomerNote",376],"(",")",";",["T_WHITESPACE","\n\n        ",376],["T_COMMENT","\/\/ add message if order was put into review during authorization or capture\n",378],["T_WHITESPACE","        ",379],["T_IF","if",379],["T_WHITESPACE"," ",379],"(",["T_VARIABLE","$order",379],["T_OBJECT_OPERATOR","->",379],["T_STRING","getState",379],"(",")",["T_WHITESPACE"," ",379],["T_IS_EQUAL","==",379],["T_WHITESPACE"," ",379],["T_STRING","Mage_Sales_Model_Order",379],["T_DOUBLE_COLON","::",379],["T_STRING","STATE_PAYMENT_REVIEW",379],")",["T_WHITESPACE"," ",379],"{",["T_WHITESPACE","\n            ",379],["T_IF","if",380],["T_WHITESPACE"," ",380],"(",["T_VARIABLE","$message",380],")",["T_WHITESPACE"," ",380],"{",["T_WHITESPACE","\n                ",380],["T_VARIABLE","$order",381],["T_OBJECT_OPERATOR","->",381],["T_STRING","addStatusToHistory",381],"(",["T_VARIABLE","$order",381],["T_OBJECT_OPERATOR","->",381],["T_STRING","getStatus",381],"(",")",",",["T_WHITESPACE"," ",381],["T_VARIABLE","$message",381],",",["T_WHITESPACE"," ",381],["T_VARIABLE","$isCustomerNotified",381],")",";",["T_WHITESPACE","\n            ",381],"}",["T_WHITESPACE","\n        ",382],"}",["T_WHITESPACE"," ",383],["T_ELSEIF","elseif",383],["T_WHITESPACE"," ",383],"(",["T_VARIABLE","$order",383],["T_OBJECT_OPERATOR","->",383],["T_STRING","getState",383],"(",")",["T_WHITESPACE"," ",383],["T_BOOLEAN_AND","&&",383],["T_WHITESPACE"," ",383],"(",["T_VARIABLE","$orderStatus",383],["T_WHITESPACE"," ",383],["T_IS_NOT_IDENTICAL","!==",383],["T_WHITESPACE"," ",383],["T_VARIABLE","$order",383],["T_OBJECT_OPERATOR","->",383],["T_STRING","getStatus",383],"(",")",["T_WHITESPACE"," ",383],["T_BOOLEAN_OR","||",383],["T_WHITESPACE"," ",383],["T_VARIABLE","$message",383],")",")",["T_WHITESPACE"," ",383],"{",["T_WHITESPACE","\n            ",383],["T_COMMENT","\/\/ add message to history if order state already declared\n",384],["T_WHITESPACE","            ",385],["T_VARIABLE","$order",385],["T_OBJECT_OPERATOR","->",385],["T_STRING","setState",385],"(",["T_VARIABLE","$orderState",385],",",["T_WHITESPACE"," ",385],["T_VARIABLE","$orderStatus",385],",",["T_WHITESPACE"," ",385],["T_VARIABLE","$message",385],",",["T_WHITESPACE"," ",385],["T_VARIABLE","$isCustomerNotified",385],")",";",["T_WHITESPACE","\n        ",385],"}",["T_WHITESPACE"," ",386],["T_ELSEIF","elseif",386],["T_WHITESPACE"," ",386],"(","(",["T_VARIABLE","$order",386],["T_OBJECT_OPERATOR","->",386],["T_STRING","getState",386],"(",")",["T_WHITESPACE"," ",386],["T_IS_NOT_EQUAL","!=",386],["T_WHITESPACE"," ",386],["T_VARIABLE","$orderState",386],")",["T_WHITESPACE"," ",386],["T_BOOLEAN_OR","||",386],["T_WHITESPACE"," ",386],"(",["T_VARIABLE","$order",386],["T_OBJECT_OPERATOR","->",386],["T_STRING","getStatus",386],"(",")",["T_WHITESPACE"," ",386],["T_IS_NOT_EQUAL","!=",386],["T_WHITESPACE"," ",386],["T_VARIABLE","$orderStatus",386],")",["T_WHITESPACE"," ",386],["T_BOOLEAN_OR","||",386],["T_WHITESPACE"," ",386],["T_VARIABLE","$message",386],")",["T_WHITESPACE"," ",386],"{",["T_WHITESPACE","\n            ",386],["T_COMMENT","\/\/ set order state\n",387],["T_WHITESPACE","            ",388],["T_VARIABLE","$order",388],["T_OBJECT_OPERATOR","->",388],["T_STRING","setState",388],"(",["T_VARIABLE","$orderState",388],",",["T_WHITESPACE"," ",388],["T_VARIABLE","$orderStatus",388],",",["T_WHITESPACE"," ",388],["T_VARIABLE","$message",388],",",["T_WHITESPACE"," ",388],["T_VARIABLE","$isCustomerNotified",388],")",";",["T_WHITESPACE","\n        ",388],"}",["T_WHITESPACE","\n\n        ",389],["T_STRING","Mage",391],["T_DOUBLE_COLON","::",391],["T_STRING","dispatchEvent",391],"(",["T_CONSTANT_ENCAPSED_STRING","'sales_order_payment_place_end'",391],",",["T_WHITESPACE"," ",391],["T_ARRAY","array",391],"(",["T_CONSTANT_ENCAPSED_STRING","'payment'",391],["T_WHITESPACE"," ",391],["T_DOUBLE_ARROW","=>",391],["T_WHITESPACE"," ",391],["T_VARIABLE","$this",391],")",")",";",["T_WHITESPACE","\n\n        ",391],["T_RETURN","return",393],["T_WHITESPACE"," ",393],["T_VARIABLE","$this",393],";",["T_WHITESPACE","\n    ",393],"}",["T_WHITESPACE","\n\n    ",394],["T_DOC_COMMENT","\/**\n     * Capture the payment online\n     * Requires an invoice. If there is no invoice specified, will automatically prepare an invoice for order\n     * Updates transactions hierarchy, if required\n     * Updates payment totals, updates order status and adds proper comments\n     *\n     * TODO: eliminate logic duplication with registerCaptureNotification()\n     *\n     * @return Mage_Sales_Model_Order_Payment\n     * @throws Mage_Core_Exception\n     *\/",396],["T_WHITESPACE","\n    ",406],["T_PUBLIC","public",407],["T_WHITESPACE"," ",407],["T_FUNCTION","function",407],["T_WHITESPACE"," ",407],["T_STRING","capture",407],"(",["T_VARIABLE","$invoice",407],")",["T_WHITESPACE","\n    ",407],"{",["T_WHITESPACE","\n        ",408],["T_IF","if",409],["T_WHITESPACE"," ",409],"(",["T_STRING","is_null",409],"(",["T_VARIABLE","$invoice",409],")",")",["T_WHITESPACE"," ",409],"{",["T_WHITESPACE","\n            ",409],["T_VARIABLE","$invoice",410],["T_WHITESPACE"," ",410],"=",["T_WHITESPACE"," ",410],["T_VARIABLE","$this",410],["T_OBJECT_OPERATOR","->",410],["T_STRING","_invoice",410],"(",")",";",["T_WHITESPACE","\n            ",410],["T_VARIABLE","$this",411],["T_OBJECT_OPERATOR","->",411],["T_STRING","setCreatedInvoice",411],"(",["T_VARIABLE","$invoice",411],")",";",["T_WHITESPACE","\n            ",411],["T_RETURN","return",412],["T_WHITESPACE"," ",412],["T_VARIABLE","$this",412],";",["T_WHITESPACE"," ",412],["T_COMMENT","\/\/ @see Mage_Sales_Model_Order_Invoice::capture()\n",412],["T_WHITESPACE","        ",413],"}",["T_WHITESPACE","\n        ",413],["T_VARIABLE","$amountToCapture",414],["T_WHITESPACE"," ",414],"=",["T_WHITESPACE"," ",414],["T_VARIABLE","$this",414],["T_OBJECT_OPERATOR","->",414],["T_STRING","_formatAmount",414],"(",["T_VARIABLE","$invoice",414],["T_OBJECT_OPERATOR","->",414],["T_STRING","getBaseGrandTotal",414],"(",")",")",";",["T_WHITESPACE","\n        ",414],["T_VARIABLE","$order",415],["T_WHITESPACE"," ",415],"=",["T_WHITESPACE"," ",415],["T_VARIABLE","$this",415],["T_OBJECT_OPERATOR","->",415],["T_STRING","getOrder",415],"(",")",";",["T_WHITESPACE","\n\n        ",415],["T_COMMENT","\/\/ prepare parent transaction and its amount\n",417],["T_WHITESPACE","        ",418],["T_VARIABLE","$paidWorkaround",418],["T_WHITESPACE"," ",418],"=",["T_WHITESPACE"," ",418],["T_LNUMBER","0",418],";",["T_WHITESPACE","\n        ",418],["T_IF","if",419],["T_WHITESPACE"," ",419],"(","!",["T_VARIABLE","$invoice",419],["T_OBJECT_OPERATOR","->",419],["T_STRING","wasPayCalled",419],"(",")",")",["T_WHITESPACE"," ",419],"{",["T_WHITESPACE","\n            ",419],["T_VARIABLE","$paidWorkaround",420],["T_WHITESPACE"," ",420],"=",["T_WHITESPACE"," ",420],["T_DOUBLE_CAST","(float)",420],["T_VARIABLE","$amountToCapture",420],";",["T_WHITESPACE","\n        ",420],"}",["T_WHITESPACE","\n        ",421],["T_VARIABLE","$this",422],["T_OBJECT_OPERATOR","->",422],["T_STRING","_isCaptureFinal",422],"(",["T_VARIABLE","$paidWorkaround",422],")",";",["T_WHITESPACE","\n\n        ",422],["T_VARIABLE","$this",424],["T_OBJECT_OPERATOR","->",424],["T_STRING","_generateTransactionId",424],"(",["T_WHITESPACE","\n            ",424],["T_STRING","Mage_Sales_Model_Order_Payment_Transaction",425],["T_DOUBLE_COLON","::",425],["T_STRING","TYPE_CAPTURE",425],",",["T_WHITESPACE","\n            ",425],["T_VARIABLE","$this",426],["T_OBJECT_OPERATOR","->",426],["T_STRING","getAuthorizationTransaction",426],"(",")",["T_WHITESPACE","\n        ",426],")",";",["T_WHITESPACE","\n\n        ",427],["T_STRING","Mage",429],["T_DOUBLE_COLON","::",429],["T_STRING","dispatchEvent",429],"(",["T_CONSTANT_ENCAPSED_STRING","'sales_order_payment_capture'",429],",",["T_WHITESPACE"," ",429],["T_ARRAY","array",429],"(",["T_CONSTANT_ENCAPSED_STRING","'payment'",429],["T_WHITESPACE"," ",429],["T_DOUBLE_ARROW","=>",429],["T_WHITESPACE"," ",429],["T_VARIABLE","$this",429],",",["T_WHITESPACE"," ",429],["T_CONSTANT_ENCAPSED_STRING","'invoice'",429],["T_WHITESPACE"," ",429],["T_DOUBLE_ARROW","=>",429],["T_WHITESPACE"," ",429],["T_VARIABLE","$invoice",429],")",")",";",["T_WHITESPACE","\n\n        ",429],["T_DOC_COMMENT","\/**\n         * Fetch an update about existing transaction. It can determine whether the transaction can be paid\n         * Capture attempt will happen only when invoice is not yet paid and the transaction can be paid\n         *\/",431],["T_WHITESPACE","\n        ",434],["T_IF","if",435],["T_WHITESPACE"," ",435],"(",["T_VARIABLE","$invoice",435],["T_OBJECT_OPERATOR","->",435],["T_STRING","getTransactionId",435],"(",")",")",["T_WHITESPACE"," ",435],"{",["T_WHITESPACE","\n            ",435],["T_VARIABLE","$this",436],["T_OBJECT_OPERATOR","->",436],["T_STRING","getMethodInstance",436],"(",")",["T_WHITESPACE","\n                ",436],["T_OBJECT_OPERATOR","->",437],["T_STRING","setStore",437],"(",["T_VARIABLE","$order",437],["T_OBJECT_OPERATOR","->",437],["T_STRING","getStoreId",437],"(",")",")",["T_WHITESPACE","\n                ",437],["T_OBJECT_OPERATOR","->",438],["T_STRING","fetchTransactionInfo",438],"(",["T_VARIABLE","$this",438],",",["T_WHITESPACE"," ",438],["T_VARIABLE","$invoice",438],["T_OBJECT_OPERATOR","->",438],["T_STRING","getTransactionId",438],"(",")",")",";",["T_WHITESPACE","\n        ",438],"}",["T_WHITESPACE","\n        ",439],["T_VARIABLE","$status",440],["T_WHITESPACE"," ",440],"=",["T_WHITESPACE"," ",440],["T_STRING","true",440],";",["T_WHITESPACE","\n        ",440],["T_IF","if",441],["T_WHITESPACE"," ",441],"(","!",["T_VARIABLE","$invoice",441],["T_OBJECT_OPERATOR","->",441],["T_STRING","getIsPaid",441],"(",")",["T_WHITESPACE"," ",441],["T_BOOLEAN_AND","&&",441],["T_WHITESPACE"," ",441],"!",["T_VARIABLE","$this",441],["T_OBJECT_OPERATOR","->",441],["T_STRING","getIsTransactionPending",441],"(",")",")",["T_WHITESPACE"," ",441],"{",["T_WHITESPACE","\n            ",441],["T_COMMENT","\/\/ attempt to capture: this can trigger \"is_transaction_pending\"\n",442],["T_WHITESPACE","            ",443],["T_VARIABLE","$this",443],["T_OBJECT_OPERATOR","->",443],["T_STRING","getMethodInstance",443],"(",")",["T_OBJECT_OPERATOR","->",443],["T_STRING","setStore",443],"(",["T_VARIABLE","$order",443],["T_OBJECT_OPERATOR","->",443],["T_STRING","getStoreId",443],"(",")",")",["T_OBJECT_OPERATOR","->",443],["T_STRING","capture",443],"(",["T_VARIABLE","$this",443],",",["T_WHITESPACE"," ",443],["T_VARIABLE","$amountToCapture",443],")",";",["T_WHITESPACE","\n\n            ",443],["T_VARIABLE","$transaction",445],["T_WHITESPACE"," ",445],"=",["T_WHITESPACE"," ",445],["T_VARIABLE","$this",445],["T_OBJECT_OPERATOR","->",445],["T_STRING","_addTransaction",445],"(",["T_WHITESPACE","\n                ",445],["T_STRING","Mage_Sales_Model_Order_Payment_Transaction",446],["T_DOUBLE_COLON","::",446],["T_STRING","TYPE_CAPTURE",446],",",["T_WHITESPACE","\n                ",446],["T_VARIABLE","$invoice",447],",",["T_WHITESPACE","\n                ",447],["T_STRING","true",448],["T_WHITESPACE","\n            ",448],")",";",["T_WHITESPACE","\n\n            ",449],["T_IF","if",451],["T_WHITESPACE"," ",451],"(",["T_VARIABLE","$this",451],["T_OBJECT_OPERATOR","->",451],["T_STRING","getIsTransactionPending",451],"(",")",")",["T_WHITESPACE"," ",451],"{",["T_WHITESPACE","\n                ",451],["T_VARIABLE","$message",452],["T_WHITESPACE"," ",452],"=",["T_WHITESPACE"," ",452],["T_STRING","Mage",452],["T_DOUBLE_COLON","::",452],["T_STRING","helper",452],"(",["T_CONSTANT_ENCAPSED_STRING","'sales'",452],")",["T_OBJECT_OPERATOR","->",452],["T_STRING","__",452],"(",["T_CONSTANT_ENCAPSED_STRING","'Capturing amount of %s is pending approval on gateway.'",452],",",["T_WHITESPACE"," ",452],["T_VARIABLE","$this",452],["T_OBJECT_OPERATOR","->",452],["T_STRING","_formatPrice",452],"(",["T_VARIABLE","$amountToCapture",452],")",")",";",["T_WHITESPACE","\n                ",452],["T_VARIABLE","$state",453],["T_WHITESPACE"," ",453],"=",["T_WHITESPACE"," ",453],["T_STRING","Mage_Sales_Model_Order",453],["T_DOUBLE_COLON","::",453],["T_STRING","STATE_PAYMENT_REVIEW",453],";",["T_WHITESPACE","\n                ",453],["T_IF","if",454],["T_WHITESPACE"," ",454],"(",["T_VARIABLE","$this",454],["T_OBJECT_OPERATOR","->",454],["T_STRING","getIsFraudDetected",454],"(",")",")",["T_WHITESPACE"," ",454],"{",["T_WHITESPACE","\n                    ",454],["T_VARIABLE","$status",455],["T_WHITESPACE"," ",455],"=",["T_WHITESPACE"," ",455],["T_STRING","Mage_Sales_Model_Order",455],["T_DOUBLE_COLON","::",455],["T_STRING","STATUS_FRAUD",455],";",["T_WHITESPACE","\n                ",455],"}",["T_WHITESPACE","\n                ",456],["T_VARIABLE","$invoice",457],["T_OBJECT_OPERATOR","->",457],["T_STRING","setIsPaid",457],"(",["T_STRING","false",457],")",";",["T_WHITESPACE","\n            ",457],"}",["T_WHITESPACE"," ",458],["T_ELSE","else",458],["T_WHITESPACE"," ",458],"{",["T_WHITESPACE"," ",458],["T_COMMENT","\/\/ normal online capture: invoice is marked as \"paid\"\n",458],["T_WHITESPACE","                ",459],["T_VARIABLE","$message",459],["T_WHITESPACE"," ",459],"=",["T_WHITESPACE"," ",459],["T_STRING","Mage",459],["T_DOUBLE_COLON","::",459],["T_STRING","helper",459],"(",["T_CONSTANT_ENCAPSED_STRING","'sales'",459],")",["T_OBJECT_OPERATOR","->",459],["T_STRING","__",459],"(",["T_CONSTANT_ENCAPSED_STRING","'Captured amount of %s online.'",459],",",["T_WHITESPACE"," ",459],["T_VARIABLE","$this",459],["T_OBJECT_OPERATOR","->",459],["T_STRING","_formatPrice",459],"(",["T_VARIABLE","$amountToCapture",459],")",")",";",["T_WHITESPACE","\n                ",459],["T_VARIABLE","$state",460],["T_WHITESPACE"," ",460],"=",["T_WHITESPACE"," ",460],["T_STRING","Mage_Sales_Model_Order",460],["T_DOUBLE_COLON","::",460],["T_STRING","STATE_PROCESSING",460],";",["T_WHITESPACE","\n                ",460],["T_VARIABLE","$invoice",461],["T_OBJECT_OPERATOR","->",461],["T_STRING","setIsPaid",461],"(",["T_STRING","true",461],")",";",["T_WHITESPACE","\n                ",461],["T_VARIABLE","$this",462],["T_OBJECT_OPERATOR","->",462],["T_STRING","_updateTotals",462],"(",["T_ARRAY","array",462],"(",["T_CONSTANT_ENCAPSED_STRING","'base_amount_paid_online'",462],["T_WHITESPACE"," ",462],["T_DOUBLE_ARROW","=>",462],["T_WHITESPACE"," ",462],["T_VARIABLE","$amountToCapture",462],")",")",";",["T_WHITESPACE","\n            ",462],"}",["T_WHITESPACE","\n            ",463],["T_IF","if",464],["T_WHITESPACE"," ",464],"(",["T_VARIABLE","$order",464],["T_OBJECT_OPERATOR","->",464],["T_STRING","isNominal",464],"(",")",")",["T_WHITESPACE"," ",464],"{",["T_WHITESPACE","\n                ",464],["T_VARIABLE","$message",465],["T_WHITESPACE"," ",465],"=",["T_WHITESPACE"," ",465],["T_VARIABLE","$this",465],["T_OBJECT_OPERATOR","->",465],["T_STRING","_prependMessage",465],"(",["T_STRING","Mage",465],["T_DOUBLE_COLON","::",465],["T_STRING","helper",465],"(",["T_CONSTANT_ENCAPSED_STRING","'sales'",465],")",["T_OBJECT_OPERATOR","->",465],["T_STRING","__",465],"(",["T_CONSTANT_ENCAPSED_STRING","'Nominal order registered.'",465],")",")",";",["T_WHITESPACE","\n            ",465],"}",["T_WHITESPACE"," ",466],["T_ELSE","else",466],["T_WHITESPACE"," ",466],"{",["T_WHITESPACE","\n                ",466],["T_VARIABLE","$message",467],["T_WHITESPACE"," ",467],"=",["T_WHITESPACE"," ",467],["T_VARIABLE","$this",467],["T_OBJECT_OPERATOR","->",467],["T_STRING","_prependMessage",467],"(",["T_VARIABLE","$message",467],")",";",["T_WHITESPACE","\n                ",467],["T_VARIABLE","$message",468],["T_WHITESPACE"," ",468],"=",["T_WHITESPACE"," ",468],["T_VARIABLE","$this",468],["T_OBJECT_OPERATOR","->",468],["T_STRING","_appendTransactionToMessage",468],"(",["T_VARIABLE","$transaction",468],",",["T_WHITESPACE"," ",468],["T_VARIABLE","$message",468],")",";",["T_WHITESPACE","\n            ",468],"}",["T_WHITESPACE","\n            ",469],["T_VARIABLE","$order",470],["T_OBJECT_OPERATOR","->",470],["T_STRING","setState",470],"(",["T_VARIABLE","$state",470],",",["T_WHITESPACE"," ",470],["T_VARIABLE","$status",470],",",["T_WHITESPACE"," ",470],["T_VARIABLE","$message",470],")",";",["T_WHITESPACE","\n            ",470],["T_VARIABLE","$this",471],["T_OBJECT_OPERATOR","->",471],["T_STRING","getMethodInstance",471],"(",")",["T_OBJECT_OPERATOR","->",471],["T_STRING","processInvoice",471],"(",["T_VARIABLE","$invoice",471],",",["T_WHITESPACE"," ",471],["T_VARIABLE","$this",471],")",";",["T_WHITESPACE"," ",471],["T_COMMENT","\/\/ should be deprecated\n",471],["T_WHITESPACE","            ",472],["T_RETURN","return",472],["T_WHITESPACE"," ",472],["T_VARIABLE","$this",472],";",["T_WHITESPACE","\n        ",472],"}",["T_WHITESPACE","\n        ",473],["T_STRING","Mage",474],["T_DOUBLE_COLON","::",474],["T_STRING","throwException",474],"(",["T_WHITESPACE","\n            ",474],["T_STRING","Mage",475],["T_DOUBLE_COLON","::",475],["T_STRING","helper",475],"(",["T_CONSTANT_ENCAPSED_STRING","'sales'",475],")",["T_OBJECT_OPERATOR","->",475],["T_STRING","__",475],"(",["T_CONSTANT_ENCAPSED_STRING","'The transaction \"%s\" cannot be captured yet.'",475],",",["T_WHITESPACE"," ",475],["T_VARIABLE","$invoice",475],["T_OBJECT_OPERATOR","->",475],["T_STRING","getTransactionId",475],"(",")",")",["T_WHITESPACE","\n        ",475],")",";",["T_WHITESPACE","\n    ",476],"}",["T_WHITESPACE","\n\n    ",477],["T_DOC_COMMENT","\/**\n     * Process a capture notification from a payment gateway for specified amount\n     * Creates an invoice automatically if the amount covers the order base grand total completely\n     * Updates transactions hierarchy, if required\n     * Prevents transaction double processing\n     * Updates payment totals, updates order status and adds proper comments\n     *\n     * TODO: eliminate logic duplication with capture()\n     *\n     * @param float $amount\n     * @param bool $skipFraudDetection\n     * @return Mage_Sales_Model_Order_Payment\n     *\/",479],["T_WHITESPACE","\n    ",491],["T_PUBLIC","public",492],["T_WHITESPACE"," ",492],["T_FUNCTION","function",492],["T_WHITESPACE"," ",492],["T_STRING","registerCaptureNotification",492],"(",["T_VARIABLE","$amount",492],",",["T_WHITESPACE"," ",492],["T_VARIABLE","$skipFraudDetection",492],["T_WHITESPACE"," ",492],"=",["T_WHITESPACE"," ",492],["T_STRING","false",492],")",["T_WHITESPACE","\n    ",492],"{",["T_WHITESPACE","\n        ",493],["T_VARIABLE","$this",494],["T_OBJECT_OPERATOR","->",494],["T_STRING","_generateTransactionId",494],"(",["T_STRING","Mage_Sales_Model_Order_Payment_Transaction",494],["T_DOUBLE_COLON","::",494],["T_STRING","TYPE_CAPTURE",494],",",["T_WHITESPACE","\n            ",494],["T_VARIABLE","$this",495],["T_OBJECT_OPERATOR","->",495],["T_STRING","getAuthorizationTransaction",495],"(",")",["T_WHITESPACE","\n        ",495],")",";",["T_WHITESPACE","\n\n        ",496],["T_VARIABLE","$order",498],["T_WHITESPACE","   ",498],"=",["T_WHITESPACE"," ",498],["T_VARIABLE","$this",498],["T_OBJECT_OPERATOR","->",498],["T_STRING","getOrder",498],"(",")",";",["T_WHITESPACE","\n        ",498],["T_VARIABLE","$amount",499],["T_WHITESPACE","  ",499],"=",["T_WHITESPACE"," ",499],["T_DOUBLE_CAST","(float)",499],["T_VARIABLE","$amount",499],";",["T_WHITESPACE","\n        ",499],["T_VARIABLE","$invoice",500],["T_WHITESPACE"," ",500],"=",["T_WHITESPACE"," ",500],["T_VARIABLE","$this",500],["T_OBJECT_OPERATOR","->",500],["T_STRING","_getInvoiceForTransactionId",500],"(",["T_VARIABLE","$this",500],["T_OBJECT_OPERATOR","->",500],["T_STRING","getTransactionId",500],"(",")",")",";",["T_WHITESPACE","\n\n        ",500],["T_COMMENT","\/\/ register new capture\n",502],["T_WHITESPACE","        ",503],["T_IF","if",503],["T_WHITESPACE"," ",503],"(","!",["T_VARIABLE","$invoice",503],")",["T_WHITESPACE"," ",503],"{",["T_WHITESPACE","\n            ",503],["T_VARIABLE","$isSameCurrency",504],["T_WHITESPACE"," ",504],"=",["T_WHITESPACE"," ",504],["T_VARIABLE","$this",504],["T_OBJECT_OPERATOR","->",504],["T_STRING","_isSameCurrency",504],"(",")",";",["T_WHITESPACE","\n            ",504],["T_IF","if",505],["T_WHITESPACE"," ",505],"(",["T_VARIABLE","$isSameCurrency",505],["T_WHITESPACE"," ",505],["T_BOOLEAN_AND","&&",505],["T_WHITESPACE"," ",505],["T_VARIABLE","$this",505],["T_OBJECT_OPERATOR","->",505],["T_STRING","_isCaptureFinal",505],"(",["T_VARIABLE","$amount",505],")",")",["T_WHITESPACE"," ",505],"{",["T_WHITESPACE","\n                ",505],["T_VARIABLE","$invoice",506],["T_WHITESPACE"," ",506],"=",["T_WHITESPACE"," ",506],["T_VARIABLE","$order",506],["T_OBJECT_OPERATOR","->",506],["T_STRING","prepareInvoice",506],"(",")",["T_OBJECT_OPERATOR","->",506],["T_STRING","register",506],"(",")",";",["T_WHITESPACE","\n                ",506],["T_VARIABLE","$order",507],["T_OBJECT_OPERATOR","->",507],["T_STRING","addRelatedObject",507],"(",["T_VARIABLE","$invoice",507],")",";",["T_WHITESPACE","\n                ",507],["T_VARIABLE","$this",508],["T_OBJECT_OPERATOR","->",508],["T_STRING","setCreatedInvoice",508],"(",["T_VARIABLE","$invoice",508],")",";",["T_WHITESPACE","\n            ",508],"}",["T_WHITESPACE"," ",509],["T_ELSE","else",509],["T_WHITESPACE"," ",509],"{",["T_WHITESPACE","\n                ",509],["T_IF","if",510],["T_WHITESPACE"," ",510],"(","!",["T_VARIABLE","$skipFraudDetection",510],["T_WHITESPACE"," ",510],["T_BOOLEAN_OR","||",510],["T_WHITESPACE"," ",510],"!",["T_VARIABLE","$isSameCurrency",510],")",["T_WHITESPACE"," ",510],"{",["T_WHITESPACE","\n                    ",510],["T_VARIABLE","$this",511],["T_OBJECT_OPERATOR","->",511],["T_STRING","setIsFraudDetected",511],"(",["T_STRING","true",511],")",";",["T_WHITESPACE","\n                ",511],"}",["T_WHITESPACE","\n                ",512],["T_VARIABLE","$this",513],["T_OBJECT_OPERATOR","->",513],["T_STRING","_updateTotals",513],"(",["T_ARRAY","array",513],"(",["T_CONSTANT_ENCAPSED_STRING","'base_amount_paid_online'",513],["T_WHITESPACE"," ",513],["T_DOUBLE_ARROW","=>",513],["T_WHITESPACE"," ",513],["T_VARIABLE","$amount",513],")",")",";",["T_WHITESPACE","\n            ",513],"}",["T_WHITESPACE","\n        ",514],"}",["T_WHITESPACE","\n\n        ",515],["T_VARIABLE","$status",517],["T_WHITESPACE"," ",517],"=",["T_WHITESPACE"," ",517],["T_STRING","true",517],";",["T_WHITESPACE","\n        ",517],["T_IF","if",518],["T_WHITESPACE"," ",518],"(",["T_VARIABLE","$this",518],["T_OBJECT_OPERATOR","->",518],["T_STRING","getIsTransactionPending",518],"(",")",")",["T_WHITESPACE"," ",518],"{",["T_WHITESPACE","\n            ",518],["T_VARIABLE","$message",519],["T_WHITESPACE"," ",519],"=",["T_WHITESPACE"," ",519],["T_STRING","Mage",519],["T_DOUBLE_COLON","::",519],["T_STRING","helper",519],"(",["T_CONSTANT_ENCAPSED_STRING","'sales'",519],")",["T_OBJECT_OPERATOR","->",519],["T_STRING","__",519],"(",["T_CONSTANT_ENCAPSED_STRING","'Capturing amount of %s is pending approval on gateway.'",519],",",["T_WHITESPACE"," ",519],["T_VARIABLE","$this",519],["T_OBJECT_OPERATOR","->",519],["T_STRING","_formatPrice",519],"(",["T_VARIABLE","$amount",519],")",")",";",["T_WHITESPACE","\n            ",519],["T_VARIABLE","$state",520],["T_WHITESPACE"," ",520],"=",["T_WHITESPACE"," ",520],["T_STRING","Mage_Sales_Model_Order",520],["T_DOUBLE_COLON","::",520],["T_STRING","STATE_PAYMENT_REVIEW",520],";",["T_WHITESPACE","\n            ",520],["T_IF","if",521],["T_WHITESPACE"," ",521],"(",["T_VARIABLE","$this",521],["T_OBJECT_OPERATOR","->",521],["T_STRING","getIsFraudDetected",521],"(",")",")",["T_WHITESPACE"," ",521],"{",["T_WHITESPACE","\n                ",521],["T_VARIABLE","$message",522],["T_WHITESPACE"," ",522],"=",["T_WHITESPACE"," ",522],["T_STRING","Mage",522],["T_DOUBLE_COLON","::",522],["T_STRING","helper",522],"(",["T_CONSTANT_ENCAPSED_STRING","'sales'",522],")",["T_OBJECT_OPERATOR","->",522],["T_STRING","__",522],"(",["T_CONSTANT_ENCAPSED_STRING","'Order is suspended as its capture amount %s is suspected to be fraudulent.'",522],",",["T_WHITESPACE"," ",522],["T_VARIABLE","$this",522],["T_OBJECT_OPERATOR","->",522],["T_STRING","_formatPrice",522],"(",["T_VARIABLE","$amount",522],",",["T_WHITESPACE"," ",522],["T_VARIABLE","$this",522],["T_OBJECT_OPERATOR","->",522],["T_STRING","getCurrencyCode",522],"(",")",")",")",";",["T_WHITESPACE","\n                ",522],["T_VARIABLE","$status",523],["T_WHITESPACE"," ",523],"=",["T_WHITESPACE"," ",523],["T_STRING","Mage_Sales_Model_Order",523],["T_DOUBLE_COLON","::",523],["T_STRING","STATUS_FRAUD",523],";",["T_WHITESPACE","\n            ",523],"}",["T_WHITESPACE","\n        ",524],"}",["T_WHITESPACE"," ",525],["T_ELSE","else",525],["T_WHITESPACE"," ",525],"{",["T_WHITESPACE","\n            ",525],["T_VARIABLE","$message",526],["T_WHITESPACE"," ",526],"=",["T_WHITESPACE"," ",526],["T_STRING","Mage",526],["T_DOUBLE_COLON","::",526],["T_STRING","helper",526],"(",["T_CONSTANT_ENCAPSED_STRING","'sales'",526],")",["T_OBJECT_OPERATOR","->",526],["T_STRING","__",526],"(",["T_CONSTANT_ENCAPSED_STRING","'Registered notification about captured amount of %s.'",526],",",["T_WHITESPACE"," ",526],["T_VARIABLE","$this",526],["T_OBJECT_OPERATOR","->",526],["T_STRING","_formatPrice",526],"(",["T_VARIABLE","$amount",526],")",")",";",["T_WHITESPACE","\n            ",526],["T_VARIABLE","$state",527],["T_WHITESPACE"," ",527],"=",["T_WHITESPACE"," ",527],["T_STRING","Mage_Sales_Model_Order",527],["T_DOUBLE_COLON","::",527],["T_STRING","STATE_PROCESSING",527],";",["T_WHITESPACE","\n            ",527],["T_IF","if",528],["T_WHITESPACE"," ",528],"(",["T_VARIABLE","$this",528],["T_OBJECT_OPERATOR","->",528],["T_STRING","getIsFraudDetected",528],"(",")",")",["T_WHITESPACE"," ",528],"{",["T_WHITESPACE","\n                ",528],["T_VARIABLE","$state",529],["T_WHITESPACE"," ",529],"=",["T_WHITESPACE"," ",529],["T_STRING","Mage_Sales_Model_Order",529],["T_DOUBLE_COLON","::",529],["T_STRING","STATE_PAYMENT_REVIEW",529],";",["T_WHITESPACE","\n                ",529],["T_VARIABLE","$message",530],["T_WHITESPACE"," ",530],"=",["T_WHITESPACE"," ",530],["T_STRING","Mage",530],["T_DOUBLE_COLON","::",530],["T_STRING","helper",530],"(",["T_CONSTANT_ENCAPSED_STRING","'sales'",530],")",["T_OBJECT_OPERATOR","->",530],["T_STRING","__",530],"(",["T_CONSTANT_ENCAPSED_STRING","'Order is suspended as its capture amount %s is suspected to be fraudulent.'",530],",",["T_WHITESPACE"," ",530],["T_VARIABLE","$this",530],["T_OBJECT_OPERATOR","->",530],["T_STRING","_formatPrice",530],"(",["T_VARIABLE","$amount",530],",",["T_WHITESPACE"," ",530],["T_VARIABLE","$this",530],["T_OBJECT_OPERATOR","->",530],["T_STRING","getCurrencyCode",530],"(",")",")",")",";",["T_WHITESPACE","\n                ",530],["T_VARIABLE","$status",531],["T_WHITESPACE"," ",531],"=",["T_WHITESPACE"," ",531],["T_STRING","Mage_Sales_Model_Order",531],["T_DOUBLE_COLON","::",531],["T_STRING","STATUS_FRAUD",531],";",["T_WHITESPACE","\n            ",531],"}",["T_WHITESPACE","\n            ",532],["T_COMMENT","\/\/ register capture for an existing invoice\n",533],["T_WHITESPACE","            ",534],["T_IF","if",534],["T_WHITESPACE"," ",534],"(",["T_VARIABLE","$invoice",534],["T_WHITESPACE"," ",534],["T_BOOLEAN_AND","&&",534],["T_WHITESPACE"," ",534],["T_STRING","Mage_Sales_Model_Order_Invoice",534],["T_DOUBLE_COLON","::",534],["T_STRING","STATE_OPEN",534],["T_WHITESPACE"," ",534],["T_IS_EQUAL","==",534],["T_WHITESPACE"," ",534],["T_VARIABLE","$invoice",534],["T_OBJECT_OPERATOR","->",534],["T_STRING","getState",534],"(",")",")",["T_WHITESPACE"," ",534],"{",["T_WHITESPACE","\n                ",534],["T_VARIABLE","$invoice",535],["T_OBJECT_OPERATOR","->",535],["T_STRING","pay",535],"(",")",";",["T_WHITESPACE","\n                ",535],["T_VARIABLE","$this",536],["T_OBJECT_OPERATOR","->",536],["T_STRING","_updateTotals",536],"(",["T_ARRAY","array",536],"(",["T_CONSTANT_ENCAPSED_STRING","'base_amount_paid_online'",536],["T_WHITESPACE"," ",536],["T_DOUBLE_ARROW","=>",536],["T_WHITESPACE"," ",536],["T_VARIABLE","$amount",536],")",")",";",["T_WHITESPACE","\n                ",536],["T_VARIABLE","$order",537],["T_OBJECT_OPERATOR","->",537],["T_STRING","addRelatedObject",537],"(",["T_VARIABLE","$invoice",537],")",";",["T_WHITESPACE","\n            ",537],"}",["T_WHITESPACE","\n        ",538],"}",["T_WHITESPACE","\n\n        ",539],["T_VARIABLE","$transaction",541],["T_WHITESPACE"," ",541],"=",["T_WHITESPACE"," ",541],["T_VARIABLE","$this",541],["T_OBJECT_OPERATOR","->",541],["T_STRING","_addTransaction",541],"(",["T_STRING","Mage_Sales_Model_Order_Payment_Transaction",541],["T_DOUBLE_COLON","::",541],["T_STRING","TYPE_CAPTURE",541],",",["T_WHITESPACE"," ",541],["T_VARIABLE","$invoice",541],",",["T_WHITESPACE"," ",541],["T_STRING","true",541],")",";",["T_WHITESPACE","\n        ",541],["T_VARIABLE","$message",542],["T_WHITESPACE"," ",542],"=",["T_WHITESPACE"," ",542],["T_VARIABLE","$this",542],["T_OBJECT_OPERATOR","->",542],["T_STRING","_prependMessage",542],"(",["T_VARIABLE","$message",542],")",";",["T_WHITESPACE","\n        ",542],["T_VARIABLE","$message",543],["T_WHITESPACE"," ",543],"=",["T_WHITESPACE"," ",543],["T_VARIABLE","$this",543],["T_OBJECT_OPERATOR","->",543],["T_STRING","_appendTransactionToMessage",543],"(",["T_VARIABLE","$transaction",543],",",["T_WHITESPACE"," ",543],["T_VARIABLE","$message",543],")",";",["T_WHITESPACE","\n        ",543],["T_VARIABLE","$order",544],["T_OBJECT_OPERATOR","->",544],["T_STRING","setState",544],"(",["T_VARIABLE","$state",544],",",["T_WHITESPACE"," ",544],["T_VARIABLE","$status",544],",",["T_WHITESPACE"," ",544],["T_VARIABLE","$message",544],")",";",["T_WHITESPACE","\n        ",544],["T_RETURN","return",545],["T_WHITESPACE"," ",545],["T_VARIABLE","$this",545],";",["T_WHITESPACE","\n    ",545],"}",["T_WHITESPACE","\n\n    ",546],["T_DOC_COMMENT","\/**\n     * Process authorization notification\n     *\n     * @see self::_authorize()\n     * @param float $amount\n     * @return Mage_Sales_Model_Order_Payment\n     *\/",548],["T_WHITESPACE","\n    ",554],["T_PUBLIC","public",555],["T_WHITESPACE"," ",555],["T_FUNCTION","function",555],["T_WHITESPACE"," ",555],["T_STRING","registerAuthorizationNotification",555],"(",["T_VARIABLE","$amount",555],")",["T_WHITESPACE","\n    ",555],"{",["T_WHITESPACE","\n        ",556],["T_RETURN","return",557],["T_WHITESPACE"," ",557],"(",["T_VARIABLE","$this",557],["T_OBJECT_OPERATOR","->",557],["T_STRING","_isTransactionExists",557],"(",")",")",["T_WHITESPACE"," ",557],"?",["T_WHITESPACE"," ",557],["T_VARIABLE","$this",557],["T_WHITESPACE"," ",557],":",["T_WHITESPACE"," ",557],["T_VARIABLE","$this",557],["T_OBJECT_OPERATOR","->",557],["T_STRING","_authorize",557],"(",["T_STRING","false",557],",",["T_WHITESPACE"," ",557],["T_VARIABLE","$amount",557],")",";",["T_WHITESPACE","\n    ",557],"}",["T_WHITESPACE","\n\n    ",558],["T_DOC_COMMENT","\/**\n     * Register payment fact: update self totals from the invoice\n     *\n     * @param Mage_Sales_Model_Order_Invoice $invoice\n     * @return Mage_Sales_Model_Order_Payment\n     *\/",560],["T_WHITESPACE","\n    ",565],["T_PUBLIC","public",566],["T_WHITESPACE"," ",566],["T_FUNCTION","function",566],["T_WHITESPACE"," ",566],["T_STRING","pay",566],"(",["T_VARIABLE","$invoice",566],")",["T_WHITESPACE","\n    ",566],"{",["T_WHITESPACE","\n        ",567],["T_VARIABLE","$this",568],["T_OBJECT_OPERATOR","->",568],["T_STRING","_updateTotals",568],"(",["T_ARRAY","array",568],"(",["T_WHITESPACE","\n            ",568],["T_CONSTANT_ENCAPSED_STRING","'amount_paid'",569],["T_WHITESPACE"," ",569],["T_DOUBLE_ARROW","=>",569],["T_WHITESPACE"," ",569],["T_VARIABLE","$invoice",569],["T_OBJECT_OPERATOR","->",569],["T_STRING","getGrandTotal",569],"(",")",",",["T_WHITESPACE","\n            ",569],["T_CONSTANT_ENCAPSED_STRING","'base_amount_paid'",570],["T_WHITESPACE"," ",570],["T_DOUBLE_ARROW","=>",570],["T_WHITESPACE"," ",570],["T_VARIABLE","$invoice",570],["T_OBJECT_OPERATOR","->",570],["T_STRING","getBaseGrandTotal",570],"(",")",",",["T_WHITESPACE","\n            ",570],["T_CONSTANT_ENCAPSED_STRING","'shipping_captured'",571],["T_WHITESPACE"," ",571],["T_DOUBLE_ARROW","=>",571],["T_WHITESPACE"," ",571],["T_VARIABLE","$invoice",571],["T_OBJECT_OPERATOR","->",571],["T_STRING","getShippingAmount",571],"(",")",",",["T_WHITESPACE","\n            ",571],["T_CONSTANT_ENCAPSED_STRING","'base_shipping_captured'",572],["T_WHITESPACE"," ",572],["T_DOUBLE_ARROW","=>",572],["T_WHITESPACE"," ",572],["T_VARIABLE","$invoice",572],["T_OBJECT_OPERATOR","->",572],["T_STRING","getBaseShippingAmount",572],"(",")",",",["T_WHITESPACE","\n        ",572],")",")",";",["T_WHITESPACE","\n        ",573],["T_STRING","Mage",574],["T_DOUBLE_COLON","::",574],["T_STRING","dispatchEvent",574],"(",["T_CONSTANT_ENCAPSED_STRING","'sales_order_payment_pay'",574],",",["T_WHITESPACE"," ",574],["T_ARRAY","array",574],"(",["T_CONSTANT_ENCAPSED_STRING","'payment'",574],["T_WHITESPACE"," ",574],["T_DOUBLE_ARROW","=>",574],["T_WHITESPACE"," ",574],["T_VARIABLE","$this",574],",",["T_WHITESPACE"," ",574],["T_CONSTANT_ENCAPSED_STRING","'invoice'",574],["T_WHITESPACE"," ",574],["T_DOUBLE_ARROW","=>",574],["T_WHITESPACE"," ",574],["T_VARIABLE","$invoice",574],")",")",";",["T_WHITESPACE","\n        ",574],["T_RETURN","return",575],["T_WHITESPACE"," ",575],["T_VARIABLE","$this",575],";",["T_WHITESPACE","\n    ",575],"}",["T_WHITESPACE","\n\n    ",576],["T_DOC_COMMENT","\/**\n     * Cancel specified invoice: update self totals from it\n     *\n     * @param Mage_Sales_Model_Order_Invoice $invoice\n     * @return Mage_Sales_Model_Order_Payment\n     *\/",578],["T_WHITESPACE","\n    ",583],["T_PUBLIC","public",584],["T_WHITESPACE"," ",584],["T_FUNCTION","function",584],["T_WHITESPACE"," ",584],["T_STRING","cancelInvoice",584],"(",["T_VARIABLE","$invoice",584],")",["T_WHITESPACE","\n    ",584],"{",["T_WHITESPACE","\n        ",585],["T_VARIABLE","$this",586],["T_OBJECT_OPERATOR","->",586],["T_STRING","_updateTotals",586],"(",["T_ARRAY","array",586],"(",["T_WHITESPACE","\n            ",586],["T_CONSTANT_ENCAPSED_STRING","'amount_paid'",587],["T_WHITESPACE"," ",587],["T_DOUBLE_ARROW","=>",587],["T_WHITESPACE"," ",587],"-",["T_LNUMBER","1",587],["T_WHITESPACE"," ",587],"*",["T_WHITESPACE"," ",587],["T_VARIABLE","$invoice",587],["T_OBJECT_OPERATOR","->",587],["T_STRING","getGrandTotal",587],"(",")",",",["T_WHITESPACE","\n            ",587],["T_CONSTANT_ENCAPSED_STRING","'base_amount_paid'",588],["T_WHITESPACE"," ",588],["T_DOUBLE_ARROW","=>",588],["T_WHITESPACE"," ",588],"-",["T_LNUMBER","1",588],["T_WHITESPACE"," ",588],"*",["T_WHITESPACE"," ",588],["T_VARIABLE","$invoice",588],["T_OBJECT_OPERATOR","->",588],["T_STRING","getBaseGrandTotal",588],"(",")",",",["T_WHITESPACE","\n            ",588],["T_CONSTANT_ENCAPSED_STRING","'shipping_captured'",589],["T_WHITESPACE"," ",589],["T_DOUBLE_ARROW","=>",589],["T_WHITESPACE"," ",589],"-",["T_LNUMBER","1",589],["T_WHITESPACE"," ",589],"*",["T_WHITESPACE"," ",589],["T_VARIABLE","$invoice",589],["T_OBJECT_OPERATOR","->",589],["T_STRING","getShippingAmount",589],"(",")",",",["T_WHITESPACE","\n            ",589],["T_CONSTANT_ENCAPSED_STRING","'base_shipping_captured'",590],["T_WHITESPACE"," ",590],["T_DOUBLE_ARROW","=>",590],["T_WHITESPACE"," ",590],"-",["T_LNUMBER","1",590],["T_WHITESPACE"," ",590],"*",["T_WHITESPACE"," ",590],["T_VARIABLE","$invoice",590],["T_OBJECT_OPERATOR","->",590],["T_STRING","getBaseShippingAmount",590],"(",")",",",["T_WHITESPACE","\n        ",590],")",")",";",["T_WHITESPACE","\n        ",591],["T_STRING","Mage",592],["T_DOUBLE_COLON","::",592],["T_STRING","dispatchEvent",592],"(",["T_CONSTANT_ENCAPSED_STRING","'sales_order_payment_cancel_invoice'",592],",",["T_WHITESPACE"," ",592],["T_ARRAY","array",592],"(",["T_CONSTANT_ENCAPSED_STRING","'payment'",592],["T_WHITESPACE"," ",592],["T_DOUBLE_ARROW","=>",592],["T_WHITESPACE"," ",592],["T_VARIABLE","$this",592],",",["T_WHITESPACE"," ",592],["T_CONSTANT_ENCAPSED_STRING","'invoice'",592],["T_WHITESPACE"," ",592],["T_DOUBLE_ARROW","=>",592],["T_WHITESPACE"," ",592],["T_VARIABLE","$invoice",592],")",")",";",["T_WHITESPACE","\n        ",592],["T_RETURN","return",593],["T_WHITESPACE"," ",593],["T_VARIABLE","$this",593],";",["T_WHITESPACE","\n    ",593],"}",["T_WHITESPACE","\n\n    ",594],["T_DOC_COMMENT","\/**\n     * Create new invoice with maximum qty for invoice for each item\n     * register this invoice and capture\n     *\n     * @return Mage_Sales_Model_Order_Invoice\n     *\/",596],["T_WHITESPACE","\n    ",601],["T_PROTECTED","protected",602],["T_WHITESPACE"," ",602],["T_FUNCTION","function",602],["T_WHITESPACE"," ",602],["T_STRING","_invoice",602],"(",")",["T_WHITESPACE","\n    ",602],"{",["T_WHITESPACE","\n        ",603],["T_VARIABLE","$invoice",604],["T_WHITESPACE"," ",604],"=",["T_WHITESPACE"," ",604],["T_VARIABLE","$this",604],["T_OBJECT_OPERATOR","->",604],["T_STRING","getOrder",604],"(",")",["T_OBJECT_OPERATOR","->",604],["T_STRING","prepareInvoice",604],"(",")",";",["T_WHITESPACE","\n\n        ",604],["T_VARIABLE","$invoice",606],["T_OBJECT_OPERATOR","->",606],["T_STRING","register",606],"(",")",";",["T_WHITESPACE","\n        ",606],["T_IF","if",607],["T_WHITESPACE"," ",607],"(",["T_VARIABLE","$this",607],["T_OBJECT_OPERATOR","->",607],["T_STRING","getMethodInstance",607],"(",")",["T_OBJECT_OPERATOR","->",607],["T_STRING","canCapture",607],"(",")",")",["T_WHITESPACE"," ",607],"{",["T_WHITESPACE","\n            ",607],["T_VARIABLE","$invoice",608],["T_OBJECT_OPERATOR","->",608],["T_STRING","capture",608],"(",")",";",["T_WHITESPACE","\n        ",608],"}",["T_WHITESPACE","\n\n        ",609],["T_VARIABLE","$this",611],["T_OBJECT_OPERATOR","->",611],["T_STRING","getOrder",611],"(",")",["T_OBJECT_OPERATOR","->",611],["T_STRING","addRelatedObject",611],"(",["T_VARIABLE","$invoice",611],")",";",["T_WHITESPACE","\n        ",611],["T_RETURN","return",612],["T_WHITESPACE"," ",612],["T_VARIABLE","$invoice",612],";",["T_WHITESPACE","\n    ",612],"}",["T_WHITESPACE","\n\n    ",613],["T_DOC_COMMENT","\/**\n     * Check order payment void availability\n     *\n     * @return bool\n     *\/",615],["T_WHITESPACE","\n    ",619],["T_PUBLIC","public",620],["T_WHITESPACE"," ",620],["T_FUNCTION","function",620],["T_WHITESPACE"," ",620],["T_STRING","canVoid",620],"(",["T_STRING","Varien_Object",620],["T_WHITESPACE"," ",620],["T_VARIABLE","$document",620],")",["T_WHITESPACE","\n    ",620],"{",["T_WHITESPACE","\n        ",621],["T_IF","if",622],["T_WHITESPACE"," ",622],"(",["T_STRING","null",622],["T_WHITESPACE"," ",622],["T_IS_IDENTICAL","===",622],["T_WHITESPACE"," ",622],["T_VARIABLE","$this",622],["T_OBJECT_OPERATOR","->",622],["T_STRING","_canVoidLookup",622],")",["T_WHITESPACE"," ",622],"{",["T_WHITESPACE","\n            ",622],["T_VARIABLE","$this",623],["T_OBJECT_OPERATOR","->",623],["T_STRING","_canVoidLookup",623],["T_WHITESPACE"," ",623],"=",["T_WHITESPACE"," ",623],["T_BOOL_CAST","(bool)",623],["T_VARIABLE","$this",623],["T_OBJECT_OPERATOR","->",623],["T_STRING","getMethodInstance",623],"(",")",["T_OBJECT_OPERATOR","->",623],["T_STRING","canVoid",623],"(",["T_VARIABLE","$document",623],")",";",["T_WHITESPACE","\n            ",623],["T_IF","if",624],["T_WHITESPACE"," ",624],"(",["T_VARIABLE","$this",624],["T_OBJECT_OPERATOR","->",624],["T_STRING","_canVoidLookup",624],")",["T_WHITESPACE"," ",624],"{",["T_WHITESPACE","\n                ",624],["T_VARIABLE","$authTransaction",625],["T_WHITESPACE"," ",625],"=",["T_WHITESPACE"," ",625],["T_VARIABLE","$this",625],["T_OBJECT_OPERATOR","->",625],["T_STRING","getAuthorizationTransaction",625],"(",")",";",["T_WHITESPACE","\n                ",625],["T_VARIABLE","$this",626],["T_OBJECT_OPERATOR","->",626],["T_STRING","_canVoidLookup",626],["T_WHITESPACE"," ",626],"=",["T_WHITESPACE"," ",626],["T_BOOL_CAST","(bool)",626],["T_VARIABLE","$authTransaction",626],["T_WHITESPACE"," ",626],["T_BOOLEAN_AND","&&",626],["T_WHITESPACE"," ",626],"!",["T_INT_CAST","(int)",626],["T_VARIABLE","$authTransaction",626],["T_OBJECT_OPERATOR","->",626],["T_STRING","getIsClosed",626],"(",")",";",["T_WHITESPACE","\n            ",626],"}",["T_WHITESPACE","\n        ",627],"}",["T_WHITESPACE","\n        ",628],["T_RETURN","return",629],["T_WHITESPACE"," ",629],["T_VARIABLE","$this",629],["T_OBJECT_OPERATOR","->",629],["T_STRING","_canVoidLookup",629],";",["T_WHITESPACE","\n    ",629],"}",["T_WHITESPACE","\n\n    ",630],["T_DOC_COMMENT","\/**\n     * Void payment online\n     *\n     * @see self::_void()\n     * @param Varien_Object $document\n     * @return Mage_Sales_Model_Order_Payment\n     *\/",632],["T_WHITESPACE","\n    ",638],["T_PUBLIC","public",639],["T_WHITESPACE"," ",639],["T_FUNCTION","function",639],["T_WHITESPACE"," ",639],["T_STRING","void",639],"(",["T_STRING","Varien_Object",639],["T_WHITESPACE"," ",639],["T_VARIABLE","$document",639],")",["T_WHITESPACE","\n    ",639],"{",["T_WHITESPACE","\n        ",640],["T_VARIABLE","$this",641],["T_OBJECT_OPERATOR","->",641],["T_STRING","_void",641],"(",["T_STRING","true",641],")",";",["T_WHITESPACE","\n        ",641],["T_STRING","Mage",642],["T_DOUBLE_COLON","::",642],["T_STRING","dispatchEvent",642],"(",["T_CONSTANT_ENCAPSED_STRING","'sales_order_payment_void'",642],",",["T_WHITESPACE"," ",642],["T_ARRAY","array",642],"(",["T_CONSTANT_ENCAPSED_STRING","'payment'",642],["T_WHITESPACE"," ",642],["T_DOUBLE_ARROW","=>",642],["T_WHITESPACE"," ",642],["T_VARIABLE","$this",642],",",["T_WHITESPACE"," ",642],["T_CONSTANT_ENCAPSED_STRING","'invoice'",642],["T_WHITESPACE"," ",642],["T_DOUBLE_ARROW","=>",642],["T_WHITESPACE"," ",642],["T_VARIABLE","$document",642],")",")",";",["T_WHITESPACE","\n        ",642],["T_RETURN","return",643],["T_WHITESPACE"," ",643],["T_VARIABLE","$this",643],";",["T_WHITESPACE","\n    ",643],"}",["T_WHITESPACE","\n\n    ",644],["T_DOC_COMMENT","\/**\n     * Process void notification\n     *\n     * @see self::_void()\n     * @param float $amount\n     * @return Mage_Sales_Model_Payment\n     *\/",646],["T_WHITESPACE","\n    ",652],["T_PUBLIC","public",653],["T_WHITESPACE"," ",653],["T_FUNCTION","function",653],["T_WHITESPACE"," ",653],["T_STRING","registerVoidNotification",653],"(",["T_VARIABLE","$amount",653],["T_WHITESPACE"," ",653],"=",["T_WHITESPACE"," ",653],["T_STRING","null",653],")",["T_WHITESPACE","\n    ",653],"{",["T_WHITESPACE","\n        ",654],["T_IF","if",655],["T_WHITESPACE"," ",655],"(","!",["T_VARIABLE","$this",655],["T_OBJECT_OPERATOR","->",655],["T_STRING","hasMessage",655],"(",")",")",["T_WHITESPACE"," ",655],"{",["T_WHITESPACE","\n            ",655],["T_VARIABLE","$this",656],["T_OBJECT_OPERATOR","->",656],["T_STRING","setMessage",656],"(",["T_STRING","Mage",656],["T_DOUBLE_COLON","::",656],["T_STRING","helper",656],"(",["T_CONSTANT_ENCAPSED_STRING","'sales'",656],")",["T_OBJECT_OPERATOR","->",656],["T_STRING","__",656],"(",["T_CONSTANT_ENCAPSED_STRING","'Registered a Void notification.'",656],")",")",";",["T_WHITESPACE","\n        ",656],"}",["T_WHITESPACE","\n        ",657],["T_RETURN","return",658],["T_WHITESPACE"," ",658],["T_VARIABLE","$this",658],["T_OBJECT_OPERATOR","->",658],["T_STRING","_void",658],"(",["T_STRING","false",658],",",["T_WHITESPACE"," ",658],["T_VARIABLE","$amount",658],")",";",["T_WHITESPACE","\n    ",658],"}",["T_WHITESPACE","\n\n    ",659],["T_DOC_COMMENT","\/**\n     * Refund payment online or offline, depending on whether there is invoice set in the creditmemo instance\n     * Updates transactions hierarchy, if required\n     * Updates payment totals, updates order status and adds proper comments\n     *\n     * @param Mage_Sales_Model_Order_Creditmemo $creditmemo\n     * @return Mage_Sales_Model_Order_Payment\n     *\/",661],["T_WHITESPACE","\n    ",668],["T_PUBLIC","public",669],["T_WHITESPACE"," ",669],["T_FUNCTION","function",669],["T_WHITESPACE"," ",669],["T_STRING","refund",669],"(",["T_VARIABLE","$creditmemo",669],")",["T_WHITESPACE","\n    ",669],"{",["T_WHITESPACE","\n        ",670],["T_VARIABLE","$baseAmountToRefund",671],["T_WHITESPACE"," ",671],"=",["T_WHITESPACE"," ",671],["T_VARIABLE","$this",671],["T_OBJECT_OPERATOR","->",671],["T_STRING","_formatAmount",671],"(",["T_VARIABLE","$creditmemo",671],["T_OBJECT_OPERATOR","->",671],["T_STRING","getBaseGrandTotal",671],"(",")",")",";",["T_WHITESPACE","\n        ",671],["T_VARIABLE","$order",672],["T_WHITESPACE"," ",672],"=",["T_WHITESPACE"," ",672],["T_VARIABLE","$this",672],["T_OBJECT_OPERATOR","->",672],["T_STRING","getOrder",672],"(",")",";",["T_WHITESPACE","\n\n        ",672],["T_VARIABLE","$this",674],["T_OBJECT_OPERATOR","->",674],["T_STRING","_generateTransactionId",674],"(",["T_STRING","Mage_Sales_Model_Order_Payment_Transaction",674],["T_DOUBLE_COLON","::",674],["T_STRING","TYPE_REFUND",674],")",";",["T_WHITESPACE","\n\n        ",674],["T_COMMENT","\/\/ call refund from gateway if required\n",676],["T_WHITESPACE","        ",677],["T_VARIABLE","$isOnline",677],["T_WHITESPACE"," ",677],"=",["T_WHITESPACE"," ",677],["T_STRING","false",677],";",["T_WHITESPACE","\n        ",677],["T_VARIABLE","$gateway",678],["T_WHITESPACE"," ",678],"=",["T_WHITESPACE"," ",678],["T_VARIABLE","$this",678],["T_OBJECT_OPERATOR","->",678],["T_STRING","getMethodInstance",678],"(",")",";",["T_WHITESPACE","\n        ",678],["T_VARIABLE","$invoice",679],["T_WHITESPACE"," ",679],"=",["T_WHITESPACE"," ",679],["T_STRING","null",679],";",["T_WHITESPACE","\n        ",679],["T_IF","if",680],["T_WHITESPACE"," ",680],"(",["T_VARIABLE","$gateway",680],["T_OBJECT_OPERATOR","->",680],["T_STRING","canRefund",680],"(",")",["T_WHITESPACE"," ",680],["T_BOOLEAN_AND","&&",680],["T_WHITESPACE"," ",680],["T_VARIABLE","$creditmemo",680],["T_OBJECT_OPERATOR","->",680],["T_STRING","getDoTransaction",680],"(",")",")",["T_WHITESPACE"," ",680],"{",["T_WHITESPACE","\n            ",680],["T_VARIABLE","$this",681],["T_OBJECT_OPERATOR","->",681],["T_STRING","setCreditmemo",681],"(",["T_VARIABLE","$creditmemo",681],")",";",["T_WHITESPACE","\n            ",681],["T_VARIABLE","$invoice",682],["T_WHITESPACE"," ",682],"=",["T_WHITESPACE"," ",682],["T_VARIABLE","$creditmemo",682],["T_OBJECT_OPERATOR","->",682],["T_STRING","getInvoice",682],"(",")",";",["T_WHITESPACE","\n            ",682],["T_IF","if",683],["T_WHITESPACE"," ",683],"(",["T_VARIABLE","$invoice",683],")",["T_WHITESPACE"," ",683],"{",["T_WHITESPACE","\n                ",683],["T_VARIABLE","$isOnline",684],["T_WHITESPACE"," ",684],"=",["T_WHITESPACE"," ",684],["T_STRING","true",684],";",["T_WHITESPACE","\n                ",684],["T_VARIABLE","$captureTxn",685],["T_WHITESPACE"," ",685],"=",["T_WHITESPACE"," ",685],["T_VARIABLE","$this",685],["T_OBJECT_OPERATOR","->",685],["T_STRING","_lookupTransaction",685],"(",["T_VARIABLE","$invoice",685],["T_OBJECT_OPERATOR","->",685],["T_STRING","getTransactionId",685],"(",")",")",";",["T_WHITESPACE","\n                ",685],["T_IF","if",686],["T_WHITESPACE"," ",686],"(",["T_VARIABLE","$captureTxn",686],")",["T_WHITESPACE"," ",686],"{",["T_WHITESPACE","\n                    ",686],["T_VARIABLE","$this",687],["T_OBJECT_OPERATOR","->",687],["T_STRING","setParentTransactionId",687],"(",["T_VARIABLE","$captureTxn",687],["T_OBJECT_OPERATOR","->",687],["T_STRING","getTxnId",687],"(",")",")",";",["T_WHITESPACE","\n                ",687],"}",["T_WHITESPACE","\n                ",688],["T_VARIABLE","$this",689],["T_OBJECT_OPERATOR","->",689],["T_STRING","setShouldCloseParentTransaction",689],"(",["T_STRING","true",689],")",";",["T_WHITESPACE"," ",689],["T_COMMENT","\/\/ TODO: implement multiple refunds per capture\n",689],["T_WHITESPACE","                ",690],["T_TRY","try",690],["T_WHITESPACE"," ",690],"{",["T_WHITESPACE","\n                    ",690],["T_VARIABLE","$gateway",691],["T_OBJECT_OPERATOR","->",691],["T_STRING","setStore",691],"(",["T_VARIABLE","$this",691],["T_OBJECT_OPERATOR","->",691],["T_STRING","getOrder",691],"(",")",["T_OBJECT_OPERATOR","->",691],["T_STRING","getStoreId",691],"(",")",")",["T_WHITESPACE","\n                        ",691],["T_OBJECT_OPERATOR","->",692],["T_STRING","processBeforeRefund",692],"(",["T_VARIABLE","$invoice",692],",",["T_WHITESPACE"," ",692],["T_VARIABLE","$this",692],")",["T_WHITESPACE","\n                        ",692],["T_OBJECT_OPERATOR","->",693],["T_STRING","refund",693],"(",["T_VARIABLE","$this",693],",",["T_WHITESPACE"," ",693],["T_VARIABLE","$baseAmountToRefund",693],")",["T_WHITESPACE","\n                        ",693],["T_OBJECT_OPERATOR","->",694],["T_STRING","processCreditmemo",694],"(",["T_VARIABLE","$creditmemo",694],",",["T_WHITESPACE"," ",694],["T_VARIABLE","$this",694],")",["T_WHITESPACE","\n                    ",694],";",["T_WHITESPACE","\n                ",695],"}",["T_WHITESPACE"," ",696],["T_CATCH","catch",696],["T_WHITESPACE"," ",696],"(",["T_STRING","Mage_Core_Exception",696],["T_WHITESPACE"," ",696],["T_VARIABLE","$e",696],")",["T_WHITESPACE"," ",696],"{",["T_WHITESPACE","\n                    ",696],["T_IF","if",697],["T_WHITESPACE"," ",697],"(","!",["T_VARIABLE","$captureTxn",697],")",["T_WHITESPACE"," ",697],"{",["T_WHITESPACE","\n                        ",697],["T_VARIABLE","$e",698],["T_OBJECT_OPERATOR","->",698],["T_STRING","setMessage",698],"(",["T_CONSTANT_ENCAPSED_STRING","' '",698],["T_WHITESPACE"," ",698],".",["T_WHITESPACE"," ",698],["T_STRING","Mage",698],["T_DOUBLE_COLON","::",698],["T_STRING","helper",698],"(",["T_CONSTANT_ENCAPSED_STRING","'sales'",698],")",["T_OBJECT_OPERATOR","->",698],["T_STRING","__",698],"(",["T_CONSTANT_ENCAPSED_STRING","'If the invoice was created offline, try creating an offline creditmemo.'",698],")",",",["T_WHITESPACE"," ",698],["T_STRING","true",698],")",";",["T_WHITESPACE","\n                    ",698],"}",["T_WHITESPACE","\n                    ",699],["T_THROW","throw",700],["T_WHITESPACE"," ",700],["T_VARIABLE","$e",700],";",["T_WHITESPACE","\n                ",700],"}",["T_WHITESPACE","\n            ",701],"}",["T_WHITESPACE","\n        ",702],"}",["T_WHITESPACE","\n\n        ",703],["T_COMMENT","\/\/ update self totals from creditmemo\n",705],["T_WHITESPACE","        ",706],["T_VARIABLE","$this",706],["T_OBJECT_OPERATOR","->",706],["T_STRING","_updateTotals",706],"(",["T_ARRAY","array",706],"(",["T_WHITESPACE","\n            ",706],["T_CONSTANT_ENCAPSED_STRING","'amount_refunded'",707],["T_WHITESPACE"," ",707],["T_DOUBLE_ARROW","=>",707],["T_WHITESPACE"," ",707],["T_VARIABLE","$creditmemo",707],["T_OBJECT_OPERATOR","->",707],["T_STRING","getGrandTotal",707],"(",")",",",["T_WHITESPACE","\n            ",707],["T_CONSTANT_ENCAPSED_STRING","'base_amount_refunded'",708],["T_WHITESPACE"," ",708],["T_DOUBLE_ARROW","=>",708],["T_WHITESPACE"," ",708],["T_VARIABLE","$baseAmountToRefund",708],",",["T_WHITESPACE","\n            ",708],["T_CONSTANT_ENCAPSED_STRING","'base_amount_refunded_online'",709],["T_WHITESPACE"," ",709],["T_DOUBLE_ARROW","=>",709],["T_WHITESPACE"," ",709],["T_VARIABLE","$isOnline",709],["T_WHITESPACE"," ",709],"?",["T_WHITESPACE"," ",709],["T_VARIABLE","$baseAmountToRefund",709],["T_WHITESPACE"," ",709],":",["T_WHITESPACE"," ",709],["T_STRING","null",709],",",["T_WHITESPACE","\n            ",709],["T_CONSTANT_ENCAPSED_STRING","'shipping_refunded'",710],["T_WHITESPACE"," ",710],["T_DOUBLE_ARROW","=>",710],["T_WHITESPACE"," ",710],["T_VARIABLE","$creditmemo",710],["T_OBJECT_OPERATOR","->",710],["T_STRING","getShippingAmount",710],"(",")",",",["T_WHITESPACE","\n            ",710],["T_CONSTANT_ENCAPSED_STRING","'base_shipping_refunded'",711],["T_WHITESPACE"," ",711],["T_DOUBLE_ARROW","=>",711],["T_WHITESPACE"," ",711],["T_VARIABLE","$creditmemo",711],["T_OBJECT_OPERATOR","->",711],["T_STRING","getBaseShippingAmount",711],"(",")",",",["T_WHITESPACE","\n        ",711],")",")",";",["T_WHITESPACE","\n\n        ",712],["T_COMMENT","\/\/ update transactions and order state\n",714],["T_WHITESPACE","        ",715],["T_VARIABLE","$transaction",715],["T_WHITESPACE"," ",715],"=",["T_WHITESPACE"," ",715],["T_VARIABLE","$this",715],["T_OBJECT_OPERATOR","->",715],["T_STRING","_addTransaction",715],"(",["T_WHITESPACE","\n            ",715],["T_STRING","Mage_Sales_Model_Order_Payment_Transaction",716],["T_DOUBLE_COLON","::",716],["T_STRING","TYPE_REFUND",716],",",["T_WHITESPACE","\n            ",716],["T_VARIABLE","$creditmemo",717],",",["T_WHITESPACE","\n            ",717],["T_VARIABLE","$isOnline",718],["T_WHITESPACE","\n        ",718],")",";",["T_WHITESPACE","\n        ",719],["T_IF","if",720],["T_WHITESPACE"," ",720],"(",["T_VARIABLE","$invoice",720],")",["T_WHITESPACE"," ",720],"{",["T_WHITESPACE","\n            ",720],["T_VARIABLE","$message",721],["T_WHITESPACE"," ",721],"=",["T_WHITESPACE"," ",721],["T_STRING","Mage",721],["T_DOUBLE_COLON","::",721],["T_STRING","helper",721],"(",["T_CONSTANT_ENCAPSED_STRING","'sales'",721],")",["T_OBJECT_OPERATOR","->",721],["T_STRING","__",721],"(",["T_CONSTANT_ENCAPSED_STRING","'Refunded amount of %s online.'",721],",",["T_WHITESPACE"," ",721],["T_VARIABLE","$this",721],["T_OBJECT_OPERATOR","->",721],["T_STRING","_formatPrice",721],"(",["T_VARIABLE","$baseAmountToRefund",721],")",")",";",["T_WHITESPACE","\n        ",721],"}",["T_WHITESPACE"," ",722],["T_ELSE","else",722],["T_WHITESPACE"," ",722],"{",["T_WHITESPACE","\n            ",722],["T_VARIABLE","$message",723],["T_WHITESPACE"," ",723],"=",["T_WHITESPACE"," ",723],["T_VARIABLE","$this",723],["T_OBJECT_OPERATOR","->",723],["T_STRING","hasMessage",723],"(",")",["T_WHITESPACE"," ",723],"?",["T_WHITESPACE"," ",723],["T_VARIABLE","$this",723],["T_OBJECT_OPERATOR","->",723],["T_STRING","getMessage",723],"(",")",["T_WHITESPACE","\n                ",723],":",["T_WHITESPACE"," ",724],["T_STRING","Mage",724],["T_DOUBLE_COLON","::",724],["T_STRING","helper",724],"(",["T_CONSTANT_ENCAPSED_STRING","'sales'",724],")",["T_OBJECT_OPERATOR","->",724],["T_STRING","__",724],"(",["T_CONSTANT_ENCAPSED_STRING","'Refunded amount of %s offline.'",724],",",["T_WHITESPACE"," ",724],["T_VARIABLE","$this",724],["T_OBJECT_OPERATOR","->",724],["T_STRING","_formatPrice",724],"(",["T_VARIABLE","$baseAmountToRefund",724],")",")",";",["T_WHITESPACE","\n        ",724],"}",["T_WHITESPACE","\n        ",725],["T_VARIABLE","$message",726],["T_WHITESPACE"," ",726],"=",["T_WHITESPACE"," ",726],["T_VARIABLE","$message",726],["T_WHITESPACE"," ",726],"=",["T_WHITESPACE"," ",726],["T_VARIABLE","$this",726],["T_OBJECT_OPERATOR","->",726],["T_STRING","_prependMessage",726],"(",["T_VARIABLE","$message",726],")",";",["T_WHITESPACE","\n        ",726],["T_VARIABLE","$message",727],["T_WHITESPACE"," ",727],"=",["T_WHITESPACE"," ",727],["T_VARIABLE","$this",727],["T_OBJECT_OPERATOR","->",727],["T_STRING","_appendTransactionToMessage",727],"(",["T_VARIABLE","$transaction",727],",",["T_WHITESPACE"," ",727],["T_VARIABLE","$message",727],")",";",["T_WHITESPACE","\n        ",727],["T_VARIABLE","$order",728],["T_OBJECT_OPERATOR","->",728],["T_STRING","setState",728],"(",["T_STRING","Mage_Sales_Model_Order",728],["T_DOUBLE_COLON","::",728],["T_STRING","STATE_PROCESSING",728],",",["T_WHITESPACE"," ",728],["T_STRING","true",728],",",["T_WHITESPACE"," ",728],["T_VARIABLE","$message",728],")",";",["T_WHITESPACE","\n\n        ",728],["T_STRING","Mage",730],["T_DOUBLE_COLON","::",730],["T_STRING","dispatchEvent",730],"(",["T_CONSTANT_ENCAPSED_STRING","'sales_order_payment_refund'",730],",",["T_WHITESPACE"," ",730],["T_ARRAY","array",730],"(",["T_CONSTANT_ENCAPSED_STRING","'payment'",730],["T_WHITESPACE"," ",730],["T_DOUBLE_ARROW","=>",730],["T_WHITESPACE"," ",730],["T_VARIABLE","$this",730],",",["T_WHITESPACE"," ",730],["T_CONSTANT_ENCAPSED_STRING","'creditmemo'",730],["T_WHITESPACE"," ",730],["T_DOUBLE_ARROW","=>",730],["T_WHITESPACE"," ",730],["T_VARIABLE","$creditmemo",730],")",")",";",["T_WHITESPACE","\n        ",730],["T_RETURN","return",731],["T_WHITESPACE"," ",731],["T_VARIABLE","$this",731],";",["T_WHITESPACE","\n    ",731],"}",["T_WHITESPACE","\n\n    ",732],["T_DOC_COMMENT","\/**\n     * Process payment refund notification\n     * Updates transactions hierarchy, if required\n     * Prevents transaction double processing\n     * Updates payment totals, updates order status and adds proper comments\n     * TODO: potentially a full capture can be refunded. In this case if there was only one invoice for that transaction\n     *       then we should create a creditmemo from invoice and also refund it offline\n     * TODO: implement logic of chargebacks reimbursements (via negative amount)\n     *\n     * @param float $amount\n     * @return Mage_Sales_Model_Order_Payment\n     *\/",734],["T_WHITESPACE","\n    ",745],["T_PUBLIC","public",746],["T_WHITESPACE"," ",746],["T_FUNCTION","function",746],["T_WHITESPACE"," ",746],["T_STRING","registerRefundNotification",746],"(",["T_VARIABLE","$amount",746],")",["T_WHITESPACE","\n    ",746],"{",["T_WHITESPACE","\n        ",747],["T_VARIABLE","$notificationAmount",748],["T_WHITESPACE"," ",748],"=",["T_WHITESPACE"," ",748],["T_VARIABLE","$amount",748],";",["T_WHITESPACE","\n        ",748],["T_VARIABLE","$this",749],["T_OBJECT_OPERATOR","->",749],["T_STRING","_generateTransactionId",749],"(",["T_STRING","Mage_Sales_Model_Order_Payment_Transaction",749],["T_DOUBLE_COLON","::",749],["T_STRING","TYPE_REFUND",749],",",["T_WHITESPACE","\n            ",749],["T_VARIABLE","$this",750],["T_OBJECT_OPERATOR","->",750],["T_STRING","_lookupTransaction",750],"(",["T_VARIABLE","$this",750],["T_OBJECT_OPERATOR","->",750],["T_STRING","getParentTransactionId",750],"(",")",")",["T_WHITESPACE","\n        ",750],")",";",["T_WHITESPACE","\n        ",751],["T_IF","if",752],["T_WHITESPACE"," ",752],"(",["T_VARIABLE","$this",752],["T_OBJECT_OPERATOR","->",752],["T_STRING","_isTransactionExists",752],"(",")",")",["T_WHITESPACE"," ",752],"{",["T_WHITESPACE","\n            ",752],["T_RETURN","return",753],["T_WHITESPACE"," ",753],["T_VARIABLE","$this",753],";",["T_WHITESPACE","\n        ",753],"}",["T_WHITESPACE","\n        ",754],["T_VARIABLE","$order",755],["T_WHITESPACE"," ",755],"=",["T_WHITESPACE"," ",755],["T_VARIABLE","$this",755],["T_OBJECT_OPERATOR","->",755],["T_STRING","getOrder",755],"(",")",";",["T_WHITESPACE","\n        ",755],["T_VARIABLE","$invoice",756],["T_WHITESPACE"," ",756],"=",["T_WHITESPACE"," ",756],["T_VARIABLE","$this",756],["T_OBJECT_OPERATOR","->",756],["T_STRING","_getInvoiceForTransactionId",756],"(",["T_VARIABLE","$this",756],["T_OBJECT_OPERATOR","->",756],["T_STRING","getParentTransactionId",756],"(",")",")",";",["T_WHITESPACE","\n\n        ",756],["T_IF","if",758],["T_WHITESPACE"," ",758],"(",["T_VARIABLE","$invoice",758],")",["T_WHITESPACE"," ",758],"{",["T_WHITESPACE","\n            ",758],["T_VARIABLE","$baseGrandTotal",759],["T_WHITESPACE"," ",759],"=",["T_WHITESPACE"," ",759],["T_VARIABLE","$invoice",759],["T_OBJECT_OPERATOR","->",759],["T_STRING","getBaseGrandTotal",759],"(",")",";",["T_WHITESPACE","\n            ",759],["T_VARIABLE","$amountRefundLeft",760],["T_WHITESPACE"," ",760],"=",["T_WHITESPACE"," ",760],["T_VARIABLE","$baseGrandTotal",760],["T_WHITESPACE"," ",760],"-",["T_WHITESPACE"," ",760],["T_VARIABLE","$invoice",760],["T_OBJECT_OPERATOR","->",760],["T_STRING","getBaseTotalRefunded",760],"(",")",";",["T_WHITESPACE","\n        ",760],"}",["T_WHITESPACE"," ",761],["T_ELSE","else",761],["T_WHITESPACE"," ",761],"{",["T_WHITESPACE","\n            ",761],["T_VARIABLE","$baseGrandTotal",762],["T_WHITESPACE"," ",762],"=",["T_WHITESPACE"," ",762],["T_VARIABLE","$order",762],["T_OBJECT_OPERATOR","->",762],["T_STRING","getBaseGrandTotal",762],"(",")",";",["T_WHITESPACE","\n            ",762],["T_VARIABLE","$amountRefundLeft",763],["T_WHITESPACE"," ",763],"=",["T_WHITESPACE"," ",763],["T_VARIABLE","$baseGrandTotal",763],["T_WHITESPACE"," ",763],"-",["T_WHITESPACE"," ",763],["T_VARIABLE","$order",763],["T_OBJECT_OPERATOR","->",763],["T_STRING","getBaseTotalRefunded",763],"(",")",";",["T_WHITESPACE","\n        ",763],"}",["T_WHITESPACE","\n\n        ",764],["T_IF","if",766],["T_WHITESPACE"," ",766],"(",["T_VARIABLE","$amountRefundLeft",766],["T_WHITESPACE"," ",766],"<",["T_WHITESPACE"," ",766],["T_VARIABLE","$amount",766],")",["T_WHITESPACE"," ",766],"{",["T_WHITESPACE","\n            ",766],["T_VARIABLE","$amount",767],["T_WHITESPACE"," ",767],"=",["T_WHITESPACE"," ",767],["T_VARIABLE","$amountRefundLeft",767],";",["T_WHITESPACE","\n        ",767],"}",["T_WHITESPACE","\n\n        ",768],["T_IF","if",770],["T_WHITESPACE"," ",770],"(",["T_VARIABLE","$amount",770],["T_WHITESPACE"," ",770],["T_IS_NOT_EQUAL","!=",770],["T_WHITESPACE"," ",770],["T_VARIABLE","$baseGrandTotal",770],")",["T_WHITESPACE"," ",770],"{",["T_WHITESPACE","\n            ",770],["T_VARIABLE","$transaction",771],["T_WHITESPACE"," ",771],"=",["T_WHITESPACE"," ",771],["T_NEW","new",771],["T_WHITESPACE"," ",771],["T_STRING","Varien_Object",771],"(",["T_ARRAY","array",771],"(",["T_CONSTANT_ENCAPSED_STRING","'txn_id'",771],["T_WHITESPACE"," ",771],["T_DOUBLE_ARROW","=>",771],["T_WHITESPACE"," ",771],["T_VARIABLE","$this",771],["T_OBJECT_OPERATOR","->",771],["T_STRING","getTransactionId",771],"(",")",")",")",";",["T_WHITESPACE","\n            ",771],["T_STRING","Mage",772],["T_DOUBLE_COLON","::",772],["T_STRING","dispatchEvent",772],"(",["T_CONSTANT_ENCAPSED_STRING","'sales_html_txn_id'",772],",",["T_WHITESPACE"," ",772],["T_ARRAY","array",772],"(",["T_CONSTANT_ENCAPSED_STRING","'transaction'",772],["T_WHITESPACE"," ",772],["T_DOUBLE_ARROW","=>",772],["T_WHITESPACE"," ",772],["T_VARIABLE","$transaction",772],",",["T_WHITESPACE"," ",772],["T_CONSTANT_ENCAPSED_STRING","'payment'",772],["T_WHITESPACE"," ",772],["T_DOUBLE_ARROW","=>",772],["T_WHITESPACE"," ",772],["T_VARIABLE","$this",772],")",")",";",["T_WHITESPACE","\n            ",772],["T_VARIABLE","$transactionId",773],["T_WHITESPACE"," ",773],"=",["T_WHITESPACE"," ",773],["T_VARIABLE","$transaction",773],["T_OBJECT_OPERATOR","->",773],["T_STRING","getHtmlTxnId",773],"(",")",["T_WHITESPACE"," ",773],"?",["T_WHITESPACE"," ",773],["T_VARIABLE","$transaction",773],["T_OBJECT_OPERATOR","->",773],["T_STRING","getHtmlTxnId",773],"(",")",["T_WHITESPACE"," ",773],":",["T_WHITESPACE"," ",773],["T_VARIABLE","$transaction",773],["T_OBJECT_OPERATOR","->",773],["T_STRING","getTxnId",773],"(",")",";",["T_WHITESPACE","\n            ",773],["T_VARIABLE","$order",774],["T_OBJECT_OPERATOR","->",774],["T_STRING","addStatusHistoryComment",774],"(",["T_STRING","Mage",774],["T_DOUBLE_COLON","::",774],["T_STRING","helper",774],"(",["T_CONSTANT_ENCAPSED_STRING","'sales'",774],")",["T_OBJECT_OPERATOR","->",774],["T_STRING","__",774],"(",["T_CONSTANT_ENCAPSED_STRING","'IPN \"Refunded\". Refund issued by merchant. Registered notification about refunded amount of %s. Transaction ID: \"%s\". Credit Memo has not been created. Please create offline Credit Memo.'",774],",",["T_WHITESPACE","\n                ",774],["T_VARIABLE","$this",775],["T_OBJECT_OPERATOR","->",775],["T_STRING","_formatPrice",775],"(",["T_VARIABLE","$notificationAmount",775],")",",",["T_WHITESPACE"," ",775],["T_VARIABLE","$transactionId",775],")",",",["T_WHITESPACE"," ",775],["T_STRING","false",775],")",";",["T_WHITESPACE","\n            ",775],["T_RETURN","return",776],["T_WHITESPACE"," ",776],["T_VARIABLE","$this",776],";",["T_WHITESPACE","\n        ",776],"}",["T_WHITESPACE","\n\n        ",777],["T_VARIABLE","$serviceModel",779],["T_WHITESPACE"," ",779],"=",["T_WHITESPACE"," ",779],["T_STRING","Mage",779],["T_DOUBLE_COLON","::",779],["T_STRING","getModel",779],"(",["T_CONSTANT_ENCAPSED_STRING","'sales\/service_order'",779],",",["T_WHITESPACE"," ",779],["T_VARIABLE","$order",779],")",";",["T_WHITESPACE","\n        ",779],["T_IF","if",780],["T_WHITESPACE"," ",780],"(",["T_VARIABLE","$invoice",780],")",["T_WHITESPACE"," ",780],"{",["T_WHITESPACE","\n            ",780],["T_IF","if",781],["T_WHITESPACE"," ",781],"(",["T_VARIABLE","$invoice",781],["T_OBJECT_OPERATOR","->",781],["T_STRING","getBaseTotalRefunded",781],"(",")",["T_WHITESPACE"," ",781],">",["T_WHITESPACE"," ",781],["T_LNUMBER","0",781],")",["T_WHITESPACE"," ",781],"{",["T_WHITESPACE","\n                ",781],["T_VARIABLE","$adjustment",782],["T_WHITESPACE"," ",782],"=",["T_WHITESPACE"," ",782],["T_ARRAY","array",782],"(",["T_CONSTANT_ENCAPSED_STRING","'adjustment_positive'",782],["T_WHITESPACE"," ",782],["T_DOUBLE_ARROW","=>",782],["T_WHITESPACE"," ",782],["T_VARIABLE","$amount",782],")",";",["T_WHITESPACE","\n            ",782],"}",["T_WHITESPACE"," ",783],["T_ELSE","else",783],["T_WHITESPACE"," ",783],"{",["T_WHITESPACE","\n                ",783],["T_VARIABLE","$adjustment",784],["T_WHITESPACE"," ",784],"=",["T_WHITESPACE"," ",784],["T_ARRAY","array",784],"(",["T_CONSTANT_ENCAPSED_STRING","'adjustment_negative'",784],["T_WHITESPACE"," ",784],["T_DOUBLE_ARROW","=>",784],["T_WHITESPACE"," ",784],["T_VARIABLE","$baseGrandTotal",784],["T_WHITESPACE"," ",784],"-",["T_WHITESPACE"," ",784],["T_VARIABLE","$amount",784],")",";",["T_WHITESPACE","\n            ",784],"}",["T_WHITESPACE","\n            ",785],["T_VARIABLE","$creditmemo",786],["T_WHITESPACE"," ",786],"=",["T_WHITESPACE"," ",786],["T_VARIABLE","$serviceModel",786],["T_OBJECT_OPERATOR","->",786],["T_STRING","prepareInvoiceCreditmemo",786],"(",["T_VARIABLE","$invoice",786],",",["T_WHITESPACE"," ",786],["T_VARIABLE","$adjustment",786],")",";",["T_WHITESPACE","\n            ",786],["T_IF","if",787],["T_WHITESPACE"," ",787],"(",["T_VARIABLE","$creditmemo",787],")",["T_WHITESPACE"," ",787],"{",["T_WHITESPACE","\n                ",787],["T_VARIABLE","$totalRefunded",788],["T_WHITESPACE"," ",788],"=",["T_WHITESPACE"," ",788],["T_VARIABLE","$invoice",788],["T_OBJECT_OPERATOR","->",788],["T_STRING","getBaseTotalRefunded",788],"(",")",["T_WHITESPACE"," ",788],"+",["T_WHITESPACE"," ",788],["T_VARIABLE","$creditmemo",788],["T_OBJECT_OPERATOR","->",788],["T_STRING","getBaseGrandTotal",788],"(",")",";",["T_WHITESPACE","\n                ",788],["T_VARIABLE","$this",789],["T_OBJECT_OPERATOR","->",789],["T_STRING","setShouldCloseParentTransaction",789],"(",["T_VARIABLE","$invoice",789],["T_OBJECT_OPERATOR","->",789],["T_STRING","getBaseGrandTotal",789],"(",")",["T_WHITESPACE"," ",789],["T_IS_SMALLER_OR_EQUAL","<=",789],["T_WHITESPACE"," ",789],["T_VARIABLE","$totalRefunded",789],")",";",["T_WHITESPACE","\n            ",789],"}",["T_WHITESPACE","\n        ",790],"}",["T_WHITESPACE"," ",791],["T_ELSE","else",791],["T_WHITESPACE"," ",791],"{",["T_WHITESPACE","\n            ",791],["T_IF","if",792],["T_WHITESPACE"," ",792],"(",["T_VARIABLE","$order",792],["T_OBJECT_OPERATOR","->",792],["T_STRING","getBaseTotalRefunded",792],"(",")",["T_WHITESPACE"," ",792],">",["T_WHITESPACE"," ",792],["T_LNUMBER","0",792],")",["T_WHITESPACE"," ",792],"{",["T_WHITESPACE","\n                ",792],["T_VARIABLE","$adjustment",793],["T_WHITESPACE"," ",793],"=",["T_WHITESPACE"," ",793],["T_ARRAY","array",793],"(",["T_CONSTANT_ENCAPSED_STRING","'adjustment_positive'",793],["T_WHITESPACE"," ",793],["T_DOUBLE_ARROW","=>",793],["T_WHITESPACE"," ",793],["T_VARIABLE","$amount",793],")",";",["T_WHITESPACE","\n            ",793],"}",["T_WHITESPACE"," ",794],["T_ELSE","else",794],["T_WHITESPACE"," ",794],"{",["T_WHITESPACE","\n                ",794],["T_VARIABLE","$adjustment",795],["T_WHITESPACE"," ",795],"=",["T_WHITESPACE"," ",795],["T_ARRAY","array",795],"(",["T_CONSTANT_ENCAPSED_STRING","'adjustment_negative'",795],["T_WHITESPACE"," ",795],["T_DOUBLE_ARROW","=>",795],["T_WHITESPACE"," ",795],["T_VARIABLE","$baseGrandTotal",795],["T_WHITESPACE"," ",795],"-",["T_WHITESPACE"," ",795],["T_VARIABLE","$amount",795],")",";",["T_WHITESPACE","\n            ",795],"}",["T_WHITESPACE","\n            ",796],["T_VARIABLE","$creditmemo",797],["T_WHITESPACE"," ",797],"=",["T_WHITESPACE"," ",797],["T_VARIABLE","$serviceModel",797],["T_OBJECT_OPERATOR","->",797],["T_STRING","prepareCreditmemo",797],"(",["T_VARIABLE","$adjustment",797],")",";",["T_WHITESPACE","\n            ",797],["T_IF","if",798],["T_WHITESPACE"," ",798],"(",["T_VARIABLE","$creditmemo",798],")",["T_WHITESPACE"," ",798],"{",["T_WHITESPACE","\n                ",798],["T_VARIABLE","$totalRefunded",799],["T_WHITESPACE"," ",799],"=",["T_WHITESPACE"," ",799],["T_VARIABLE","$order",799],["T_OBJECT_OPERATOR","->",799],["T_STRING","getBaseTotalRefunded",799],"(",")",["T_WHITESPACE"," ",799],"+",["T_WHITESPACE"," ",799],["T_VARIABLE","$creditmemo",799],["T_OBJECT_OPERATOR","->",799],["T_STRING","getBaseGrandTotal",799],"(",")",";",["T_WHITESPACE","\n                ",799],["T_VARIABLE","$this",800],["T_OBJECT_OPERATOR","->",800],["T_STRING","setShouldCloseParentTransaction",800],"(",["T_VARIABLE","$order",800],["T_OBJECT_OPERATOR","->",800],["T_STRING","getBaseGrandTotal",800],"(",")",["T_WHITESPACE"," ",800],["T_IS_SMALLER_OR_EQUAL","<=",800],["T_WHITESPACE"," ",800],["T_VARIABLE","$totalRefunded",800],")",";",["T_WHITESPACE","\n            ",800],"}",["T_WHITESPACE","\n        ",801],"}",["T_WHITESPACE","\n\n        ",802],["T_VARIABLE","$creditmemo",804],["T_OBJECT_OPERATOR","->",804],["T_STRING","setPaymentRefundDisallowed",804],"(",["T_STRING","true",804],")",["T_WHITESPACE","\n            ",804],["T_OBJECT_OPERATOR","->",805],["T_STRING","setAutomaticallyCreated",805],"(",["T_STRING","true",805],")",["T_WHITESPACE","\n            ",805],["T_OBJECT_OPERATOR","->",806],["T_STRING","register",806],"(",")",["T_WHITESPACE","\n            ",806],["T_OBJECT_OPERATOR","->",807],["T_STRING","addComment",807],"(",["T_STRING","Mage",807],["T_DOUBLE_COLON","::",807],["T_STRING","helper",807],"(",["T_CONSTANT_ENCAPSED_STRING","'sales'",807],")",["T_OBJECT_OPERATOR","->",807],["T_STRING","__",807],"(",["T_CONSTANT_ENCAPSED_STRING","'Credit memo has been created automatically'",807],")",")",["T_WHITESPACE","\n            ",807],["T_OBJECT_OPERATOR","->",808],["T_STRING","save",808],"(",")",";",["T_WHITESPACE","\n\n        ",808],["T_VARIABLE","$this",810],["T_OBJECT_OPERATOR","->",810],["T_STRING","_updateTotals",810],"(",["T_ARRAY","array",810],"(",["T_WHITESPACE","\n            ",810],["T_CONSTANT_ENCAPSED_STRING","'amount_refunded'",811],["T_WHITESPACE"," ",811],["T_DOUBLE_ARROW","=>",811],["T_WHITESPACE"," ",811],["T_VARIABLE","$creditmemo",811],["T_OBJECT_OPERATOR","->",811],["T_STRING","getGrandTotal",811],"(",")",",",["T_WHITESPACE","\n            ",811],["T_CONSTANT_ENCAPSED_STRING","'base_amount_refunded_online'",812],["T_WHITESPACE"," ",812],["T_DOUBLE_ARROW","=>",812],["T_WHITESPACE"," ",812],["T_VARIABLE","$amount",812],["T_WHITESPACE","\n        ",812],")",")",";",["T_WHITESPACE","\n\n        ",813],["T_VARIABLE","$this",815],["T_OBJECT_OPERATOR","->",815],["T_STRING","setCreatedCreditmemo",815],"(",["T_VARIABLE","$creditmemo",815],")",";",["T_WHITESPACE","\n        ",815],["T_COMMENT","\/\/ update transactions and order state\n",816],["T_WHITESPACE","        ",817],["T_VARIABLE","$transaction",817],["T_WHITESPACE"," ",817],"=",["T_WHITESPACE"," ",817],["T_VARIABLE","$this",817],["T_OBJECT_OPERATOR","->",817],["T_STRING","_addTransaction",817],"(",["T_STRING","Mage_Sales_Model_Order_Payment_Transaction",817],["T_DOUBLE_COLON","::",817],["T_STRING","TYPE_REFUND",817],",",["T_WHITESPACE"," ",817],["T_VARIABLE","$creditmemo",817],")",";",["T_WHITESPACE","\n        ",817],["T_VARIABLE","$message",818],["T_WHITESPACE"," ",818],"=",["T_WHITESPACE"," ",818],["T_VARIABLE","$this",818],["T_OBJECT_OPERATOR","->",818],["T_STRING","_prependMessage",818],"(",["T_WHITESPACE","\n            ",818],["T_STRING","Mage",819],["T_DOUBLE_COLON","::",819],["T_STRING","helper",819],"(",["T_CONSTANT_ENCAPSED_STRING","'sales'",819],")",["T_OBJECT_OPERATOR","->",819],["T_STRING","__",819],"(",["T_CONSTANT_ENCAPSED_STRING","'Registered notification about refunded amount of %s.'",819],",",["T_WHITESPACE"," ",819],["T_VARIABLE","$this",819],["T_OBJECT_OPERATOR","->",819],["T_STRING","_formatPrice",819],"(",["T_VARIABLE","$amount",819],")",")",["T_WHITESPACE","\n        ",819],")",";",["T_WHITESPACE","\n        ",820],["T_VARIABLE","$message",821],["T_WHITESPACE"," ",821],"=",["T_WHITESPACE"," ",821],["T_VARIABLE","$this",821],["T_OBJECT_OPERATOR","->",821],["T_STRING","_appendTransactionToMessage",821],"(",["T_VARIABLE","$transaction",821],",",["T_WHITESPACE"," ",821],["T_VARIABLE","$message",821],")",";",["T_WHITESPACE","\n        ",821],["T_VARIABLE","$order",822],["T_OBJECT_OPERATOR","->",822],["T_STRING","setState",822],"(",["T_STRING","Mage_Sales_Model_Order",822],["T_DOUBLE_COLON","::",822],["T_STRING","STATE_PROCESSING",822],",",["T_WHITESPACE"," ",822],["T_STRING","true",822],",",["T_WHITESPACE"," ",822],["T_VARIABLE","$message",822],")",";",["T_WHITESPACE","\n        ",822],["T_RETURN","return",823],["T_WHITESPACE"," ",823],["T_VARIABLE","$this",823],";",["T_WHITESPACE","\n    ",823],"}",["T_WHITESPACE","\n\n    ",824],["T_DOC_COMMENT","\/**\n     * Cancel a creditmemo: substract its totals from the payment\n     *\n     * @param Mage_Sales_Model_Order_Creditmemo $creditmemo\n     * @return Mage_Sales_Model_Order_Payment\n     *\/",826],["T_WHITESPACE","\n    ",831],["T_PUBLIC","public",832],["T_WHITESPACE"," ",832],["T_FUNCTION","function",832],["T_WHITESPACE"," ",832],["T_STRING","cancelCreditmemo",832],"(",["T_VARIABLE","$creditmemo",832],")",["T_WHITESPACE","\n    ",832],"{",["T_WHITESPACE","\n        ",833],["T_VARIABLE","$this",834],["T_OBJECT_OPERATOR","->",834],["T_STRING","_updateTotals",834],"(",["T_ARRAY","array",834],"(",["T_WHITESPACE","\n            ",834],["T_CONSTANT_ENCAPSED_STRING","'amount_refunded'",835],["T_WHITESPACE"," ",835],["T_DOUBLE_ARROW","=>",835],["T_WHITESPACE"," ",835],"-",["T_LNUMBER","1",835],["T_WHITESPACE"," ",835],"*",["T_WHITESPACE"," ",835],["T_VARIABLE","$creditmemo",835],["T_OBJECT_OPERATOR","->",835],["T_STRING","getGrandTotal",835],"(",")",",",["T_WHITESPACE","\n            ",835],["T_CONSTANT_ENCAPSED_STRING","'base_amount_refunded'",836],["T_WHITESPACE"," ",836],["T_DOUBLE_ARROW","=>",836],["T_WHITESPACE"," ",836],"-",["T_LNUMBER","1",836],["T_WHITESPACE"," ",836],"*",["T_WHITESPACE"," ",836],["T_VARIABLE","$creditmemo",836],["T_OBJECT_OPERATOR","->",836],["T_STRING","getBaseGrandTotal",836],"(",")",",",["T_WHITESPACE","\n            ",836],["T_CONSTANT_ENCAPSED_STRING","'shipping_refunded'",837],["T_WHITESPACE"," ",837],["T_DOUBLE_ARROW","=>",837],["T_WHITESPACE"," ",837],"-",["T_LNUMBER","1",837],["T_WHITESPACE"," ",837],"*",["T_WHITESPACE"," ",837],["T_VARIABLE","$creditmemo",837],["T_OBJECT_OPERATOR","->",837],["T_STRING","getShippingAmount",837],"(",")",",",["T_WHITESPACE","\n            ",837],["T_CONSTANT_ENCAPSED_STRING","'base_shipping_refunded'",838],["T_WHITESPACE"," ",838],["T_DOUBLE_ARROW","=>",838],["T_WHITESPACE"," ",838],"-",["T_LNUMBER","1",838],["T_WHITESPACE"," ",838],"*",["T_WHITESPACE"," ",838],["T_VARIABLE","$creditmemo",838],["T_OBJECT_OPERATOR","->",838],["T_STRING","getBaseShippingAmount",838],"(",")",["T_WHITESPACE","\n        ",838],")",")",";",["T_WHITESPACE","\n        ",839],["T_STRING","Mage",840],["T_DOUBLE_COLON","::",840],["T_STRING","dispatchEvent",840],"(",["T_CONSTANT_ENCAPSED_STRING","'sales_order_payment_cancel_creditmemo'",840],",",["T_WHITESPACE","\n            ",840],["T_ARRAY","array",841],"(",["T_CONSTANT_ENCAPSED_STRING","'payment'",841],["T_WHITESPACE"," ",841],["T_DOUBLE_ARROW","=>",841],["T_WHITESPACE"," ",841],["T_VARIABLE","$this",841],",",["T_WHITESPACE"," ",841],["T_CONSTANT_ENCAPSED_STRING","'creditmemo'",841],["T_WHITESPACE"," ",841],["T_DOUBLE_ARROW","=>",841],["T_WHITESPACE"," ",841],["T_VARIABLE","$creditmemo",841],")",["T_WHITESPACE","\n        ",841],")",";",["T_WHITESPACE","\n        ",842],["T_RETURN","return",843],["T_WHITESPACE"," ",843],["T_VARIABLE","$this",843],";",["T_WHITESPACE","\n    ",843],"}",["T_WHITESPACE","\n\n    ",844],["T_DOC_COMMENT","\/**\n     * Order cancellation hook for payment method instance\n     * Adds void transaction if needed\n     * @return Mage_Sales_Model_Order_Payment\n     *\/",846],["T_WHITESPACE","\n    ",850],["T_PUBLIC","public",851],["T_WHITESPACE"," ",851],["T_FUNCTION","function",851],["T_WHITESPACE"," ",851],["T_STRING","cancel",851],"(",")",["T_WHITESPACE","\n    ",851],"{",["T_WHITESPACE","\n        ",852],["T_VARIABLE","$isOnline",853],["T_WHITESPACE"," ",853],"=",["T_WHITESPACE"," ",853],["T_STRING","true",853],";",["T_WHITESPACE","\n        ",853],["T_IF","if",854],["T_WHITESPACE"," ",854],"(","!",["T_VARIABLE","$this",854],["T_OBJECT_OPERATOR","->",854],["T_STRING","canVoid",854],"(",["T_VARIABLE","$this",854],")",")",["T_WHITESPACE"," ",854],"{",["T_WHITESPACE","\n            ",854],["T_VARIABLE","$isOnline",855],["T_WHITESPACE"," ",855],"=",["T_WHITESPACE"," ",855],["T_STRING","false",855],";",["T_WHITESPACE","\n        ",855],"}",["T_WHITESPACE","\n\n        ",856],["T_IF","if",858],["T_WHITESPACE"," ",858],"(","!",["T_VARIABLE","$this",858],["T_OBJECT_OPERATOR","->",858],["T_STRING","hasMessage",858],"(",")",")",["T_WHITESPACE"," ",858],"{",["T_WHITESPACE","\n            ",858],["T_VARIABLE","$this",859],["T_OBJECT_OPERATOR","->",859],["T_STRING","setMessage",859],"(",["T_VARIABLE","$isOnline",859],["T_WHITESPACE"," ",859],"?",["T_WHITESPACE"," ",859],["T_STRING","Mage",859],["T_DOUBLE_COLON","::",859],["T_STRING","helper",859],"(",["T_CONSTANT_ENCAPSED_STRING","'sales'",859],")",["T_OBJECT_OPERATOR","->",859],["T_STRING","__",859],"(",["T_CONSTANT_ENCAPSED_STRING","'Canceled order online.'",859],")",["T_WHITESPACE","\n                ",859],":",["T_WHITESPACE"," ",860],["T_STRING","Mage",860],["T_DOUBLE_COLON","::",860],["T_STRING","helper",860],"(",["T_CONSTANT_ENCAPSED_STRING","'sales'",860],")",["T_OBJECT_OPERATOR","->",860],["T_STRING","__",860],"(",["T_CONSTANT_ENCAPSED_STRING","'Canceled order offline.'",860],")",["T_WHITESPACE","\n            ",860],")",";",["T_WHITESPACE","\n        ",861],"}",["T_WHITESPACE","\n\n        ",862],["T_IF","if",864],["T_WHITESPACE"," ",864],"(",["T_VARIABLE","$isOnline",864],")",["T_WHITESPACE"," ",864],"{",["T_WHITESPACE","\n            ",864],["T_VARIABLE","$this",865],["T_OBJECT_OPERATOR","->",865],["T_STRING","_void",865],"(",["T_VARIABLE","$isOnline",865],",",["T_WHITESPACE"," ",865],["T_STRING","null",865],",",["T_WHITESPACE"," ",865],["T_CONSTANT_ENCAPSED_STRING","'cancel'",865],")",";",["T_WHITESPACE","\n        ",865],"}",["T_WHITESPACE","\n\n        ",866],["T_STRING","Mage",868],["T_DOUBLE_COLON","::",868],["T_STRING","dispatchEvent",868],"(",["T_CONSTANT_ENCAPSED_STRING","'sales_order_payment_cancel'",868],",",["T_WHITESPACE"," ",868],["T_ARRAY","array",868],"(",["T_CONSTANT_ENCAPSED_STRING","'payment'",868],["T_WHITESPACE"," ",868],["T_DOUBLE_ARROW","=>",868],["T_WHITESPACE"," ",868],["T_VARIABLE","$this",868],")",")",";",["T_WHITESPACE","\n\n        ",868],["T_RETURN","return",870],["T_WHITESPACE"," ",870],["T_VARIABLE","$this",870],";",["T_WHITESPACE","\n    ",870],"}",["T_WHITESPACE","\n\n    ",871],["T_DOC_COMMENT","\/**\n     * Check order payment review availability\n     *\n     * @return bool\n     *\/",873],["T_WHITESPACE","\n    ",877],["T_PUBLIC","public",878],["T_WHITESPACE"," ",878],["T_FUNCTION","function",878],["T_WHITESPACE"," ",878],["T_STRING","canReviewPayment",878],"(",")",["T_WHITESPACE","\n    ",878],"{",["T_WHITESPACE","\n        ",879],["T_RETURN","return",880],["T_WHITESPACE"," ",880],["T_BOOL_CAST","(bool)",880],["T_VARIABLE","$this",880],["T_OBJECT_OPERATOR","->",880],["T_STRING","getMethodInstance",880],"(",")",["T_OBJECT_OPERATOR","->",880],["T_STRING","canReviewPayment",880],"(",["T_VARIABLE","$this",880],")",";",["T_WHITESPACE","\n    ",880],"}",["T_WHITESPACE","\n\n    ",881],["T_DOC_COMMENT","\/**\n     * Check whether fetching info of transaction could be done\n     *\n     * @return bool\n     *\/",883],["T_WHITESPACE","\n    ",887],["T_PUBLIC","public",888],["T_WHITESPACE"," ",888],["T_FUNCTION","function",888],["T_WHITESPACE"," ",888],["T_STRING","canFetchTransactionInfo",888],"(",")",["T_WHITESPACE","\n    ",888],"{",["T_WHITESPACE","\n        ",889],["T_RETURN","return",890],["T_WHITESPACE"," ",890],["T_BOOL_CAST","(bool)",890],["T_VARIABLE","$this",890],["T_OBJECT_OPERATOR","->",890],["T_STRING","getMethodInstance",890],"(",")",["T_OBJECT_OPERATOR","->",890],["T_STRING","canFetchTransactionInfo",890],"(",")",";",["T_WHITESPACE","\n    ",890],"}",["T_WHITESPACE","\n\n    ",891],["T_DOC_COMMENT","\/**\n     * Accept online a payment that is in review state\n     *\n     * @return Mage_Sales_Model_Order_Payment\n     *\/",893],["T_WHITESPACE","\n    ",897],["T_PUBLIC","public",898],["T_WHITESPACE"," ",898],["T_FUNCTION","function",898],["T_WHITESPACE"," ",898],["T_STRING","accept",898],"(",")",["T_WHITESPACE","\n    ",898],"{",["T_WHITESPACE","\n        ",899],["T_VARIABLE","$this",900],["T_OBJECT_OPERATOR","->",900],["T_STRING","registerPaymentReviewAction",900],"(",["T_STRING","self",900],["T_DOUBLE_COLON","::",900],["T_STRING","REVIEW_ACTION_ACCEPT",900],",",["T_WHITESPACE"," ",900],["T_STRING","true",900],")",";",["T_WHITESPACE","\n        ",900],["T_RETURN","return",901],["T_WHITESPACE"," ",901],["T_VARIABLE","$this",901],";",["T_WHITESPACE","\n    ",901],"}",["T_WHITESPACE","\n\n    ",902],["T_DOC_COMMENT","\/**\n     * Accept order with payment method instance\n     *\n     * @return Mage_Sales_Model_Order_Payment\n     *\/",904],["T_WHITESPACE","\n    ",908],["T_PUBLIC","public",909],["T_WHITESPACE"," ",909],["T_FUNCTION","function",909],["T_WHITESPACE"," ",909],["T_STRING","deny",909],"(",")",["T_WHITESPACE","\n    ",909],"{",["T_WHITESPACE","\n        ",910],["T_VARIABLE","$this",911],["T_OBJECT_OPERATOR","->",911],["T_STRING","registerPaymentReviewAction",911],"(",["T_STRING","self",911],["T_DOUBLE_COLON","::",911],["T_STRING","REVIEW_ACTION_DENY",911],",",["T_WHITESPACE"," ",911],["T_STRING","true",911],")",";",["T_WHITESPACE","\n        ",911],["T_RETURN","return",912],["T_WHITESPACE"," ",912],["T_VARIABLE","$this",912],";",["T_WHITESPACE","\n    ",912],"}",["T_WHITESPACE","\n\n    ",913],["T_DOC_COMMENT","\/**\n     * Perform the payment review action: either initiated by merchant or by a notification\n     *\n     * Sets order to processing state and optionally approves invoice or cancels the order\n     *\n     * @param string $action\n     * @param bool $isOnline\n     * @return Mage_Sales_Model_Order_Payment\n     *\/",915],["T_WHITESPACE","\n    ",923],["T_PUBLIC","public",924],["T_WHITESPACE"," ",924],["T_FUNCTION","function",924],["T_WHITESPACE"," ",924],["T_STRING","registerPaymentReviewAction",924],"(",["T_VARIABLE","$action",924],",",["T_WHITESPACE"," ",924],["T_VARIABLE","$isOnline",924],")",["T_WHITESPACE","\n    ",924],"{",["T_WHITESPACE","\n        ",925],["T_VARIABLE","$order",926],["T_WHITESPACE"," ",926],"=",["T_WHITESPACE"," ",926],["T_VARIABLE","$this",926],["T_OBJECT_OPERATOR","->",926],["T_STRING","getOrder",926],"(",")",";",["T_WHITESPACE","\n\n        ",926],["T_VARIABLE","$transactionId",928],["T_WHITESPACE"," ",928],"=",["T_WHITESPACE"," ",928],["T_VARIABLE","$isOnline",928],["T_WHITESPACE"," ",928],"?",["T_WHITESPACE"," ",928],["T_VARIABLE","$this",928],["T_OBJECT_OPERATOR","->",928],["T_STRING","getLastTransId",928],"(",")",["T_WHITESPACE"," ",928],":",["T_WHITESPACE"," ",928],["T_VARIABLE","$this",928],["T_OBJECT_OPERATOR","->",928],["T_STRING","getTransactionId",928],"(",")",";",["T_WHITESPACE","\n        ",928],["T_VARIABLE","$invoice",929],["T_WHITESPACE"," ",929],"=",["T_WHITESPACE"," ",929],["T_VARIABLE","$this",929],["T_OBJECT_OPERATOR","->",929],["T_STRING","_getInvoiceForTransactionId",929],"(",["T_VARIABLE","$transactionId",929],")",";",["T_WHITESPACE","\n\n        ",929],["T_COMMENT","\/\/ invoke the payment method to determine what to do with the transaction\n",931],["T_WHITESPACE","        ",932],["T_VARIABLE","$result",932],["T_WHITESPACE"," ",932],"=",["T_WHITESPACE"," ",932],["T_STRING","null",932],";",["T_WHITESPACE"," ",932],["T_VARIABLE","$message",932],["T_WHITESPACE"," ",932],"=",["T_WHITESPACE"," ",932],["T_STRING","null",932],";",["T_WHITESPACE","\n        ",932],["T_SWITCH","switch",933],["T_WHITESPACE"," ",933],"(",["T_VARIABLE","$action",933],")",["T_WHITESPACE"," ",933],"{",["T_WHITESPACE","\n            ",933],["T_CASE","case",934],["T_WHITESPACE"," ",934],["T_STRING","self",934],["T_DOUBLE_COLON","::",934],["T_STRING","REVIEW_ACTION_ACCEPT",934],":",["T_WHITESPACE","\n                ",934],["T_IF","if",935],["T_WHITESPACE"," ",935],"(",["T_VARIABLE","$isOnline",935],")",["T_WHITESPACE"," ",935],"{",["T_WHITESPACE","\n                    ",935],["T_IF","if",936],["T_WHITESPACE"," ",936],"(",["T_VARIABLE","$this",936],["T_OBJECT_OPERATOR","->",936],["T_STRING","getMethodInstance",936],"(",")",["T_OBJECT_OPERATOR","->",936],["T_STRING","setStore",936],"(",["T_VARIABLE","$order",936],["T_OBJECT_OPERATOR","->",936],["T_STRING","getStoreId",936],"(",")",")",["T_OBJECT_OPERATOR","->",936],["T_STRING","acceptPayment",936],"(",["T_VARIABLE","$this",936],")",")",["T_WHITESPACE"," ",936],"{",["T_WHITESPACE","\n                        ",936],["T_VARIABLE","$result",937],["T_WHITESPACE"," ",937],"=",["T_WHITESPACE"," ",937],["T_STRING","true",937],";",["T_WHITESPACE","\n                        ",937],["T_VARIABLE","$message",938],["T_WHITESPACE"," ",938],"=",["T_WHITESPACE"," ",938],["T_STRING","Mage",938],["T_DOUBLE_COLON","::",938],["T_STRING","helper",938],"(",["T_CONSTANT_ENCAPSED_STRING","'sales'",938],")",["T_OBJECT_OPERATOR","->",938],["T_STRING","__",938],"(",["T_CONSTANT_ENCAPSED_STRING","'Approved the payment online.'",938],")",";",["T_WHITESPACE","\n                    ",938],"}",["T_WHITESPACE"," ",939],["T_ELSE","else",939],["T_WHITESPACE"," ",939],"{",["T_WHITESPACE","\n                        ",939],["T_VARIABLE","$result",940],["T_WHITESPACE"," ",940],"=",["T_WHITESPACE"," ",940],"-",["T_LNUMBER","1",940],";",["T_WHITESPACE","\n                        ",940],["T_VARIABLE","$message",941],["T_WHITESPACE"," ",941],"=",["T_WHITESPACE"," ",941],["T_STRING","Mage",941],["T_DOUBLE_COLON","::",941],["T_STRING","helper",941],"(",["T_CONSTANT_ENCAPSED_STRING","'sales'",941],")",["T_OBJECT_OPERATOR","->",941],["T_STRING","__",941],"(",["T_CONSTANT_ENCAPSED_STRING","'There is no need to approve this payment.'",941],")",";",["T_WHITESPACE","\n                    ",941],"}",["T_WHITESPACE","\n                ",942],"}",["T_WHITESPACE"," ",943],["T_ELSE","else",943],["T_WHITESPACE"," ",943],"{",["T_WHITESPACE","\n                    ",943],["T_VARIABLE","$result",944],["T_WHITESPACE"," ",944],"=",["T_WHITESPACE"," ",944],["T_BOOL_CAST","(bool)",944],["T_VARIABLE","$this",944],["T_OBJECT_OPERATOR","->",944],["T_STRING","getNotificationResult",944],"(",")",["T_WHITESPACE"," ",944],"?",["T_WHITESPACE"," ",944],["T_STRING","true",944],["T_WHITESPACE"," ",944],":",["T_WHITESPACE"," ",944],"-",["T_LNUMBER","1",944],";",["T_WHITESPACE","\n                    ",944],["T_VARIABLE","$message",945],["T_WHITESPACE"," ",945],"=",["T_WHITESPACE"," ",945],["T_STRING","Mage",945],["T_DOUBLE_COLON","::",945],["T_STRING","helper",945],"(",["T_CONSTANT_ENCAPSED_STRING","'sales'",945],")",["T_OBJECT_OPERATOR","->",945],["T_STRING","__",945],"(",["T_CONSTANT_ENCAPSED_STRING","'Registered notification about approved payment.'",945],")",";",["T_WHITESPACE","\n                ",945],"}",["T_WHITESPACE","\n                ",946],["T_BREAK","break",947],";",["T_WHITESPACE","\n            ",947],["T_CASE","case",948],["T_WHITESPACE"," ",948],["T_STRING","self",948],["T_DOUBLE_COLON","::",948],["T_STRING","REVIEW_ACTION_DENY",948],":",["T_WHITESPACE","\n                ",948],["T_IF","if",949],["T_WHITESPACE"," ",949],"(",["T_VARIABLE","$isOnline",949],")",["T_WHITESPACE"," ",949],"{",["T_WHITESPACE","\n                    ",949],["T_IF","if",950],["T_WHITESPACE"," ",950],"(",["T_VARIABLE","$this",950],["T_OBJECT_OPERATOR","->",950],["T_STRING","getMethodInstance",950],"(",")",["T_OBJECT_OPERATOR","->",950],["T_STRING","setStore",950],"(",["T_VARIABLE","$order",950],["T_OBJECT_OPERATOR","->",950],["T_STRING","getStoreId",950],"(",")",")",["T_OBJECT_OPERATOR","->",950],["T_STRING","denyPayment",950],"(",["T_VARIABLE","$this",950],")",")",["T_WHITESPACE"," ",950],"{",["T_WHITESPACE","\n                        ",950],["T_VARIABLE","$result",951],["T_WHITESPACE"," ",951],"=",["T_WHITESPACE"," ",951],["T_STRING","false",951],";",["T_WHITESPACE","\n                        ",951],["T_VARIABLE","$message",952],["T_WHITESPACE"," ",952],"=",["T_WHITESPACE"," ",952],["T_STRING","Mage",952],["T_DOUBLE_COLON","::",952],["T_STRING","helper",952],"(",["T_CONSTANT_ENCAPSED_STRING","'sales'",952],")",["T_OBJECT_OPERATOR","->",952],["T_STRING","__",952],"(",["T_CONSTANT_ENCAPSED_STRING","'Denied the payment online.'",952],")",";",["T_WHITESPACE","\n                    ",952],"}",["T_WHITESPACE"," ",953],["T_ELSE","else",953],["T_WHITESPACE"," ",953],"{",["T_WHITESPACE","\n                        ",953],["T_VARIABLE","$result",954],["T_WHITESPACE"," ",954],"=",["T_WHITESPACE"," ",954],"-",["T_LNUMBER","1",954],";",["T_WHITESPACE","\n                        ",954],["T_VARIABLE","$message",955],["T_WHITESPACE"," ",955],"=",["T_WHITESPACE"," ",955],["T_STRING","Mage",955],["T_DOUBLE_COLON","::",955],["T_STRING","helper",955],"(",["T_CONSTANT_ENCAPSED_STRING","'sales'",955],")",["T_OBJECT_OPERATOR","->",955],["T_STRING","__",955],"(",["T_CONSTANT_ENCAPSED_STRING","'There is no need to deny this payment.'",955],")",";",["T_WHITESPACE","\n                    ",955],"}",["T_WHITESPACE","\n                ",956],"}",["T_WHITESPACE"," ",957],["T_ELSE","else",957],["T_WHITESPACE"," ",957],"{",["T_WHITESPACE","\n                    ",957],["T_VARIABLE","$result",958],["T_WHITESPACE"," ",958],"=",["T_WHITESPACE"," ",958],["T_BOOL_CAST","(bool)",958],["T_VARIABLE","$this",958],["T_OBJECT_OPERATOR","->",958],["T_STRING","getNotificationResult",958],"(",")",["T_WHITESPACE"," ",958],"?",["T_WHITESPACE"," ",958],["T_STRING","false",958],["T_WHITESPACE"," ",958],":",["T_WHITESPACE"," ",958],"-",["T_LNUMBER","1",958],";",["T_WHITESPACE","\n                    ",958],["T_VARIABLE","$message",959],["T_WHITESPACE"," ",959],"=",["T_WHITESPACE"," ",959],["T_STRING","Mage",959],["T_DOUBLE_COLON","::",959],["T_STRING","helper",959],"(",["T_CONSTANT_ENCAPSED_STRING","'sales'",959],")",["T_OBJECT_OPERATOR","->",959],["T_STRING","__",959],"(",["T_CONSTANT_ENCAPSED_STRING","'Registered notification about denied payment.'",959],")",";",["T_WHITESPACE","\n                ",959],"}",["T_WHITESPACE","\n                ",960],["T_BREAK","break",961],";",["T_WHITESPACE","\n            ",961],["T_CASE","case",962],["T_WHITESPACE"," ",962],["T_STRING","self",962],["T_DOUBLE_COLON","::",962],["T_STRING","REVIEW_ACTION_UPDATE",962],":",["T_WHITESPACE","\n                ",962],["T_IF","if",963],["T_WHITESPACE"," ",963],"(",["T_VARIABLE","$isOnline",963],")",["T_WHITESPACE"," ",963],"{",["T_WHITESPACE","\n                    ",963],["T_VARIABLE","$this",964],["T_OBJECT_OPERATOR","->",964],["T_STRING","getMethodInstance",964],"(",")",["T_WHITESPACE","\n                        ",964],["T_OBJECT_OPERATOR","->",965],["T_STRING","setStore",965],"(",["T_VARIABLE","$order",965],["T_OBJECT_OPERATOR","->",965],["T_STRING","getStoreId",965],"(",")",")",["T_WHITESPACE","\n                        ",965],["T_OBJECT_OPERATOR","->",966],["T_STRING","fetchTransactionInfo",966],"(",["T_VARIABLE","$this",966],",",["T_WHITESPACE"," ",966],["T_VARIABLE","$transactionId",966],")",";",["T_WHITESPACE","\n                ",966],"}",["T_WHITESPACE"," ",967],["T_ELSE","else",967],["T_WHITESPACE"," ",967],"{",["T_WHITESPACE","\n                    ",967],["T_COMMENT","\/\/ notification mechanism is responsible to update the payment object first\n",968],["T_WHITESPACE","                ",969],"}",["T_WHITESPACE","\n                ",969],["T_IF","if",970],["T_WHITESPACE"," ",970],"(",["T_VARIABLE","$this",970],["T_OBJECT_OPERATOR","->",970],["T_STRING","getIsTransactionApproved",970],"(",")",")",["T_WHITESPACE"," ",970],"{",["T_WHITESPACE","\n                    ",970],["T_VARIABLE","$result",971],["T_WHITESPACE"," ",971],"=",["T_WHITESPACE"," ",971],["T_STRING","true",971],";",["T_WHITESPACE","\n                    ",971],["T_VARIABLE","$message",972],["T_WHITESPACE"," ",972],"=",["T_WHITESPACE"," ",972],["T_STRING","Mage",972],["T_DOUBLE_COLON","::",972],["T_STRING","helper",972],"(",["T_CONSTANT_ENCAPSED_STRING","'sales'",972],")",["T_OBJECT_OPERATOR","->",972],["T_STRING","__",972],"(",["T_CONSTANT_ENCAPSED_STRING","'Registered update about approved payment.'",972],")",";",["T_WHITESPACE","\n                ",972],"}",["T_WHITESPACE"," ",973],["T_ELSEIF","elseif",973],["T_WHITESPACE"," ",973],"(",["T_VARIABLE","$this",973],["T_OBJECT_OPERATOR","->",973],["T_STRING","getIsTransactionDenied",973],"(",")",")",["T_WHITESPACE"," ",973],"{",["T_WHITESPACE","\n                    ",973],["T_VARIABLE","$result",974],["T_WHITESPACE"," ",974],"=",["T_WHITESPACE"," ",974],["T_STRING","false",974],";",["T_WHITESPACE","\n                    ",974],["T_VARIABLE","$message",975],["T_WHITESPACE"," ",975],"=",["T_WHITESPACE"," ",975],["T_STRING","Mage",975],["T_DOUBLE_COLON","::",975],["T_STRING","helper",975],"(",["T_CONSTANT_ENCAPSED_STRING","'sales'",975],")",["T_OBJECT_OPERATOR","->",975],["T_STRING","__",975],"(",["T_CONSTANT_ENCAPSED_STRING","'Registered update about denied payment.'",975],")",";",["T_WHITESPACE","\n                ",975],"}",["T_WHITESPACE"," ",976],["T_ELSE","else",976],["T_WHITESPACE"," ",976],"{",["T_WHITESPACE","\n                    ",976],["T_VARIABLE","$result",977],["T_WHITESPACE"," ",977],"=",["T_WHITESPACE"," ",977],"-",["T_LNUMBER","1",977],";",["T_WHITESPACE","\n                    ",977],["T_VARIABLE","$message",978],["T_WHITESPACE"," ",978],"=",["T_WHITESPACE"," ",978],["T_STRING","Mage",978],["T_DOUBLE_COLON","::",978],["T_STRING","helper",978],"(",["T_CONSTANT_ENCAPSED_STRING","'sales'",978],")",["T_OBJECT_OPERATOR","->",978],["T_STRING","__",978],"(",["T_CONSTANT_ENCAPSED_STRING","'There is no update for the payment.'",978],")",";",["T_WHITESPACE","\n                ",978],"}",["T_WHITESPACE","\n                ",979],["T_BREAK","break",980],";",["T_WHITESPACE","\n            ",980],["T_DEFAULT","default",981],":",["T_WHITESPACE","\n                ",981],["T_THROW","throw",982],["T_WHITESPACE"," ",982],["T_NEW","new",982],["T_WHITESPACE"," ",982],["T_STRING","Exception",982],"(",["T_CONSTANT_ENCAPSED_STRING","'Not implemented.'",982],")",";",["T_WHITESPACE","\n        ",982],"}",["T_WHITESPACE","\n        ",983],["T_VARIABLE","$message",984],["T_WHITESPACE"," ",984],"=",["T_WHITESPACE"," ",984],["T_VARIABLE","$this",984],["T_OBJECT_OPERATOR","->",984],["T_STRING","_prependMessage",984],"(",["T_VARIABLE","$message",984],")",";",["T_WHITESPACE","\n        ",984],["T_IF","if",985],["T_WHITESPACE"," ",985],"(",["T_VARIABLE","$transactionId",985],")",["T_WHITESPACE"," ",985],"{",["T_WHITESPACE","\n            ",985],["T_VARIABLE","$message",986],["T_WHITESPACE"," ",986],"=",["T_WHITESPACE"," ",986],["T_VARIABLE","$this",986],["T_OBJECT_OPERATOR","->",986],["T_STRING","_appendTransactionToMessage",986],"(",["T_VARIABLE","$transactionId",986],",",["T_WHITESPACE"," ",986],["T_VARIABLE","$message",986],")",";",["T_WHITESPACE","\n        ",986],"}",["T_WHITESPACE","\n\n        ",987],["T_COMMENT","\/\/ process payment in case of positive or negative result, or add a comment\n",989],["T_WHITESPACE","        ",990],["T_IF","if",990],["T_WHITESPACE"," ",990],"(","-",["T_LNUMBER","1",990],["T_WHITESPACE"," ",990],["T_IS_IDENTICAL","===",990],["T_WHITESPACE"," ",990],["T_VARIABLE","$result",990],")",["T_WHITESPACE"," ",990],"{",["T_WHITESPACE"," ",990],["T_COMMENT","\/\/ switch won't work with such $result!\n",990],["T_WHITESPACE","            ",991],["T_IF","if",991],["T_WHITESPACE"," ",991],"(",["T_VARIABLE","$order",991],["T_WHITESPACE"," ",991],["T_OBJECT_OPERATOR","->",991],["T_WHITESPACE"," ",991],["T_STRING","getState",991],"(",")",["T_WHITESPACE"," ",991],["T_IS_NOT_EQUAL","!=",991],["T_WHITESPACE"," ",991],["T_STRING","Mage_Sales_Model_Order",991],["T_DOUBLE_COLON","::",991],["T_STRING","STATE_PAYMENT_REVIEW",991],")",["T_WHITESPACE"," ",991],"{",["T_WHITESPACE","\n                ",991],["T_VARIABLE","$status",992],["T_WHITESPACE"," ",992],"=",["T_WHITESPACE"," ",992],["T_VARIABLE","$this",992],["T_OBJECT_OPERATOR","->",992],["T_STRING","getIsFraudDetected",992],"(",")",["T_WHITESPACE"," ",992],"?",["T_WHITESPACE"," ",992],["T_STRING","Mage_Sales_Model_Order",992],["T_DOUBLE_COLON","::",992],["T_STRING","STATUS_FRAUD",992],["T_WHITESPACE"," ",992],":",["T_WHITESPACE"," ",992],["T_STRING","false",992],";",["T_WHITESPACE","\n                ",992],["T_VARIABLE","$order",993],["T_OBJECT_OPERATOR","->",993],["T_STRING","setState",993],"(",["T_STRING","Mage_Sales_Model_Order",993],["T_DOUBLE_COLON","::",993],["T_STRING","STATE_PAYMENT_REVIEW",993],",",["T_WHITESPACE"," ",993],["T_VARIABLE","$status",993],",",["T_WHITESPACE"," ",993],["T_VARIABLE","$message",993],")",";",["T_WHITESPACE","\n                ",993],["T_IF","if",994],["T_WHITESPACE"," ",994],"(",["T_VARIABLE","$transactionId",994],")",["T_WHITESPACE"," ",994],"{",["T_WHITESPACE","\n                    ",994],["T_VARIABLE","$this",995],["T_OBJECT_OPERATOR","->",995],["T_STRING","setLastTransId",995],"(",["T_VARIABLE","$transactionId",995],")",";",["T_WHITESPACE","\n                ",995],"}",["T_WHITESPACE","\n            ",996],"}",["T_WHITESPACE"," ",997],["T_ELSE","else",997],["T_WHITESPACE"," ",997],"{",["T_WHITESPACE","\n                ",997],["T_VARIABLE","$order",998],["T_OBJECT_OPERATOR","->",998],["T_STRING","addStatusHistoryComment",998],"(",["T_VARIABLE","$message",998],")",";",["T_WHITESPACE","\n            ",998],"}",["T_WHITESPACE","\n        ",999],"}",["T_WHITESPACE"," ",1000],["T_ELSEIF","elseif",1000],["T_WHITESPACE"," ",1000],"(",["T_STRING","true",1000],["T_WHITESPACE"," ",1000],["T_IS_IDENTICAL","===",1000],["T_WHITESPACE"," ",1000],["T_VARIABLE","$result",1000],")",["T_WHITESPACE"," ",1000],"{",["T_WHITESPACE","\n            ",1000],["T_IF","if",1001],["T_WHITESPACE"," ",1001],"(",["T_VARIABLE","$invoice",1001],")",["T_WHITESPACE"," ",1001],"{",["T_WHITESPACE","\n                ",1001],["T_VARIABLE","$invoice",1002],["T_OBJECT_OPERATOR","->",1002],["T_STRING","pay",1002],"(",")",";",["T_WHITESPACE","\n                ",1002],["T_VARIABLE","$this",1003],["T_OBJECT_OPERATOR","->",1003],["T_STRING","_updateTotals",1003],"(",["T_ARRAY","array",1003],"(",["T_CONSTANT_ENCAPSED_STRING","'base_amount_paid_online'",1003],["T_WHITESPACE"," ",1003],["T_DOUBLE_ARROW","=>",1003],["T_WHITESPACE"," ",1003],["T_VARIABLE","$invoice",1003],["T_OBJECT_OPERATOR","->",1003],["T_STRING","getBaseGrandTotal",1003],"(",")",")",")",";",["T_WHITESPACE","\n                ",1003],["T_VARIABLE","$order",1004],["T_OBJECT_OPERATOR","->",1004],["T_STRING","addRelatedObject",1004],"(",["T_VARIABLE","$invoice",1004],")",";",["T_WHITESPACE","\n            ",1004],"}",["T_WHITESPACE","\n            ",1005],["T_VARIABLE","$order",1006],["T_OBJECT_OPERATOR","->",1006],["T_STRING","setState",1006],"(",["T_STRING","Mage_Sales_Model_Order",1006],["T_DOUBLE_COLON","::",1006],["T_STRING","STATE_PROCESSING",1006],",",["T_WHITESPACE"," ",1006],["T_STRING","true",1006],",",["T_WHITESPACE"," ",1006],["T_VARIABLE","$message",1006],")",";",["T_WHITESPACE","\n        ",1006],"}",["T_WHITESPACE"," ",1007],["T_ELSEIF","elseif",1007],["T_WHITESPACE"," ",1007],"(",["T_STRING","false",1007],["T_WHITESPACE"," ",1007],["T_IS_IDENTICAL","===",1007],["T_WHITESPACE"," ",1007],["T_VARIABLE","$result",1007],")",["T_WHITESPACE"," ",1007],"{",["T_WHITESPACE","\n            ",1007],["T_IF","if",1008],["T_WHITESPACE"," ",1008],"(",["T_VARIABLE","$invoice",1008],")",["T_WHITESPACE"," ",1008],"{",["T_WHITESPACE","\n                ",1008],["T_VARIABLE","$invoice",1009],["T_OBJECT_OPERATOR","->",1009],["T_STRING","cancel",1009],"(",")",";",["T_WHITESPACE","\n                ",1009],["T_VARIABLE","$order",1010],["T_OBJECT_OPERATOR","->",1010],["T_STRING","addRelatedObject",1010],"(",["T_VARIABLE","$invoice",1010],")",";",["T_WHITESPACE","\n            ",1010],"}",["T_WHITESPACE","\n            ",1011],["T_VARIABLE","$order",1012],["T_OBJECT_OPERATOR","->",1012],["T_STRING","registerCancellation",1012],"(",["T_VARIABLE","$message",1012],",",["T_WHITESPACE"," ",1012],["T_STRING","false",1012],")",";",["T_WHITESPACE","\n        ",1012],"}",["T_WHITESPACE","\n        ",1013],["T_RETURN","return",1014],["T_WHITESPACE"," ",1014],["T_VARIABLE","$this",1014],";",["T_WHITESPACE","\n    ",1014],"}",["T_WHITESPACE","\n\n    ",1015],["T_DOC_COMMENT","\/**\n     * Order payment either online\n     * Updates transactions hierarchy, if required\n     * Prevents transaction double processing\n     * Updates payment totals, updates order status and adds proper comments\n     *\n     * @param float $amount\n     * @return Mage_Sales_Model_Order_Payment\n     *\/",1017],["T_WHITESPACE","\n    ",1025],["T_PROTECTED","protected",1026],["T_WHITESPACE"," ",1026],["T_FUNCTION","function",1026],["T_WHITESPACE"," ",1026],["T_STRING","_order",1026],"(",["T_VARIABLE","$amount",1026],")",["T_WHITESPACE","\n    ",1026],"{",["T_WHITESPACE","\n        ",1027],["T_COMMENT","\/\/ update totals\n",1028],["T_WHITESPACE","        ",1029],["T_VARIABLE","$amount",1029],["T_WHITESPACE"," ",1029],"=",["T_WHITESPACE"," ",1029],["T_VARIABLE","$this",1029],["T_OBJECT_OPERATOR","->",1029],["T_STRING","_formatAmount",1029],"(",["T_VARIABLE","$amount",1029],",",["T_WHITESPACE"," ",1029],["T_STRING","true",1029],")",";",["T_WHITESPACE","\n\n        ",1029],["T_COMMENT","\/\/ do ordering\n",1031],["T_WHITESPACE","        ",1032],["T_VARIABLE","$order",1032],["T_WHITESPACE","  ",1032],"=",["T_WHITESPACE"," ",1032],["T_VARIABLE","$this",1032],["T_OBJECT_OPERATOR","->",1032],["T_STRING","getOrder",1032],"(",")",";",["T_WHITESPACE","\n        ",1032],["T_VARIABLE","$state",1033],["T_WHITESPACE","  ",1033],"=",["T_WHITESPACE"," ",1033],["T_STRING","Mage_Sales_Model_Order",1033],["T_DOUBLE_COLON","::",1033],["T_STRING","STATE_PROCESSING",1033],";",["T_WHITESPACE","\n        ",1033],["T_VARIABLE","$status",1034],["T_WHITESPACE"," ",1034],"=",["T_WHITESPACE"," ",1034],["T_STRING","true",1034],";",["T_WHITESPACE","\n        ",1034],["T_VARIABLE","$this",1035],["T_OBJECT_OPERATOR","->",1035],["T_STRING","getMethodInstance",1035],"(",")",["T_OBJECT_OPERATOR","->",1035],["T_STRING","setStore",1035],"(",["T_VARIABLE","$order",1035],["T_OBJECT_OPERATOR","->",1035],["T_STRING","getStoreId",1035],"(",")",")",["T_OBJECT_OPERATOR","->",1035],["T_STRING","order",1035],"(",["T_VARIABLE","$this",1035],",",["T_WHITESPACE"," ",1035],["T_VARIABLE","$amount",1035],")",";",["T_WHITESPACE","\n\n        ",1035],["T_IF","if",1037],["T_WHITESPACE"," ",1037],"(",["T_VARIABLE","$this",1037],["T_OBJECT_OPERATOR","->",1037],["T_STRING","getSkipOrderProcessing",1037],"(",")",")",["T_WHITESPACE"," ",1037],"{",["T_WHITESPACE","\n            ",1037],["T_RETURN","return",1038],["T_WHITESPACE"," ",1038],["T_VARIABLE","$this",1038],";",["T_WHITESPACE","\n        ",1038],"}",["T_WHITESPACE","\n\n        ",1039],["T_COMMENT","\/\/ similar logic of \"payment review\" order as in capturing\n",1041],["T_WHITESPACE","        ",1042],["T_IF","if",1042],["T_WHITESPACE"," ",1042],"(",["T_VARIABLE","$this",1042],["T_OBJECT_OPERATOR","->",1042],["T_STRING","getIsTransactionPending",1042],"(",")",")",["T_WHITESPACE"," ",1042],"{",["T_WHITESPACE","\n            ",1042],["T_VARIABLE","$message",1043],["T_WHITESPACE"," ",1043],"=",["T_WHITESPACE"," ",1043],["T_STRING","Mage",1043],["T_DOUBLE_COLON","::",1043],["T_STRING","helper",1043],"(",["T_CONSTANT_ENCAPSED_STRING","'sales'",1043],")",["T_OBJECT_OPERATOR","->",1043],["T_STRING","__",1043],"(",["T_CONSTANT_ENCAPSED_STRING","'Ordering amount of %s is pending approval on gateway.'",1043],",",["T_WHITESPACE"," ",1043],["T_VARIABLE","$this",1043],["T_OBJECT_OPERATOR","->",1043],["T_STRING","_formatPrice",1043],"(",["T_VARIABLE","$amount",1043],")",")",";",["T_WHITESPACE","\n            ",1043],["T_VARIABLE","$state",1044],["T_WHITESPACE"," ",1044],"=",["T_WHITESPACE"," ",1044],["T_STRING","Mage_Sales_Model_Order",1044],["T_DOUBLE_COLON","::",1044],["T_STRING","STATE_PAYMENT_REVIEW",1044],";",["T_WHITESPACE","\n            ",1044],["T_IF","if",1045],["T_WHITESPACE"," ",1045],"(",["T_VARIABLE","$this",1045],["T_OBJECT_OPERATOR","->",1045],["T_STRING","getIsFraudDetected",1045],"(",")",")",["T_WHITESPACE"," ",1045],"{",["T_WHITESPACE","\n                ",1045],["T_VARIABLE","$status",1046],["T_WHITESPACE"," ",1046],"=",["T_WHITESPACE"," ",1046],["T_STRING","Mage_Sales_Model_Order",1046],["T_DOUBLE_COLON","::",1046],["T_STRING","STATUS_FRAUD",1046],";",["T_WHITESPACE","\n            ",1046],"}",["T_WHITESPACE","\n        ",1047],"}",["T_WHITESPACE"," ",1048],["T_ELSE","else",1048],["T_WHITESPACE"," ",1048],"{",["T_WHITESPACE","\n            ",1048],["T_VARIABLE","$message",1049],["T_WHITESPACE"," ",1049],"=",["T_WHITESPACE"," ",1049],["T_STRING","Mage",1049],["T_DOUBLE_COLON","::",1049],["T_STRING","helper",1049],"(",["T_CONSTANT_ENCAPSED_STRING","'sales'",1049],")",["T_OBJECT_OPERATOR","->",1049],["T_STRING","__",1049],"(",["T_CONSTANT_ENCAPSED_STRING","'Ordered amount of %s.'",1049],",",["T_WHITESPACE"," ",1049],["T_VARIABLE","$this",1049],["T_OBJECT_OPERATOR","->",1049],["T_STRING","_formatPrice",1049],"(",["T_VARIABLE","$amount",1049],")",")",";",["T_WHITESPACE","\n        ",1049],"}",["T_WHITESPACE","\n\n        ",1050],["T_COMMENT","\/\/ update transactions, order state and add comments\n",1052],["T_WHITESPACE","        ",1053],["T_VARIABLE","$transaction",1053],["T_WHITESPACE"," ",1053],"=",["T_WHITESPACE"," ",1053],["T_VARIABLE","$this",1053],["T_OBJECT_OPERATOR","->",1053],["T_STRING","_addTransaction",1053],"(",["T_STRING","Mage_Sales_Model_Order_Payment_Transaction",1053],["T_DOUBLE_COLON","::",1053],["T_STRING","TYPE_ORDER",1053],")",";",["T_WHITESPACE","\n        ",1053],["T_VARIABLE","$message",1054],["T_WHITESPACE"," ",1054],"=",["T_WHITESPACE"," ",1054],["T_VARIABLE","$this",1054],["T_OBJECT_OPERATOR","->",1054],["T_STRING","_prependMessage",1054],"(",["T_VARIABLE","$message",1054],")",";",["T_WHITESPACE","\n        ",1054],["T_VARIABLE","$message",1055],["T_WHITESPACE"," ",1055],"=",["T_WHITESPACE"," ",1055],["T_VARIABLE","$this",1055],["T_OBJECT_OPERATOR","->",1055],["T_STRING","_appendTransactionToMessage",1055],"(",["T_VARIABLE","$transaction",1055],",",["T_WHITESPACE"," ",1055],["T_VARIABLE","$message",1055],")",";",["T_WHITESPACE","\n        ",1055],["T_VARIABLE","$order",1056],["T_OBJECT_OPERATOR","->",1056],["T_STRING","setState",1056],"(",["T_VARIABLE","$state",1056],",",["T_WHITESPACE"," ",1056],["T_VARIABLE","$status",1056],",",["T_WHITESPACE"," ",1056],["T_VARIABLE","$message",1056],")",";",["T_WHITESPACE","\n        ",1056],["T_RETURN","return",1057],["T_WHITESPACE"," ",1057],["T_VARIABLE","$this",1057],";",["T_WHITESPACE","\n    ",1057],"}",["T_WHITESPACE","\n\n    ",1058],["T_DOC_COMMENT","\/**\n     * Authorize payment either online or offline (process auth notification)\n     * Updates transactions hierarchy, if required\n     * Prevents transaction double processing\n     * Updates payment totals, updates order status and adds proper comments\n     *\n     * @param bool $isOnline\n     * @param float $amount\n     * @return Mage_Sales_Model_Order_Payment\n     *\/",1060],["T_WHITESPACE","\n    ",1069],["T_PROTECTED","protected",1070],["T_WHITESPACE"," ",1070],["T_FUNCTION","function",1070],["T_WHITESPACE"," ",1070],["T_STRING","_authorize",1070],"(",["T_VARIABLE","$isOnline",1070],",",["T_WHITESPACE"," ",1070],["T_VARIABLE","$amount",1070],")",["T_WHITESPACE","\n    ",1070],"{",["T_WHITESPACE","\n        ",1071],["T_COMMENT","\/\/ check for authorization amount to be equal to grand total\n",1072],["T_WHITESPACE","        ",1073],["T_VARIABLE","$this",1073],["T_OBJECT_OPERATOR","->",1073],["T_STRING","setShouldCloseParentTransaction",1073],"(",["T_STRING","false",1073],")",";",["T_WHITESPACE","\n        ",1073],["T_VARIABLE","$isSameCurrency",1074],["T_WHITESPACE"," ",1074],"=",["T_WHITESPACE"," ",1074],["T_VARIABLE","$this",1074],["T_OBJECT_OPERATOR","->",1074],["T_STRING","_isSameCurrency",1074],"(",")",";",["T_WHITESPACE","\n        ",1074],["T_IF","if",1075],["T_WHITESPACE"," ",1075],"(","!",["T_VARIABLE","$isSameCurrency",1075],["T_WHITESPACE"," ",1075],["T_BOOLEAN_OR","||",1075],["T_WHITESPACE"," ",1075],"!",["T_VARIABLE","$this",1075],["T_OBJECT_OPERATOR","->",1075],["T_STRING","_isCaptureFinal",1075],"(",["T_VARIABLE","$amount",1075],")",")",["T_WHITESPACE"," ",1075],"{",["T_WHITESPACE","\n            ",1075],["T_VARIABLE","$this",1076],["T_OBJECT_OPERATOR","->",1076],["T_STRING","setIsFraudDetected",1076],"(",["T_STRING","true",1076],")",";",["T_WHITESPACE","\n        ",1076],"}",["T_WHITESPACE","\n\n        ",1077],["T_COMMENT","\/\/ update totals\n",1079],["T_WHITESPACE","        ",1080],["T_VARIABLE","$amount",1080],["T_WHITESPACE"," ",1080],"=",["T_WHITESPACE"," ",1080],["T_VARIABLE","$this",1080],["T_OBJECT_OPERATOR","->",1080],["T_STRING","_formatAmount",1080],"(",["T_VARIABLE","$amount",1080],",",["T_WHITESPACE"," ",1080],["T_STRING","true",1080],")",";",["T_WHITESPACE","\n        ",1080],["T_VARIABLE","$this",1081],["T_OBJECT_OPERATOR","->",1081],["T_STRING","setBaseAmountAuthorized",1081],"(",["T_VARIABLE","$amount",1081],")",";",["T_WHITESPACE","\n\n        ",1081],["T_COMMENT","\/\/ do authorization\n",1083],["T_WHITESPACE","        ",1084],["T_VARIABLE","$order",1084],["T_WHITESPACE","  ",1084],"=",["T_WHITESPACE"," ",1084],["T_VARIABLE","$this",1084],["T_OBJECT_OPERATOR","->",1084],["T_STRING","getOrder",1084],"(",")",";",["T_WHITESPACE","\n        ",1084],["T_VARIABLE","$state",1085],["T_WHITESPACE","  ",1085],"=",["T_WHITESPACE"," ",1085],["T_STRING","Mage_Sales_Model_Order",1085],["T_DOUBLE_COLON","::",1085],["T_STRING","STATE_PROCESSING",1085],";",["T_WHITESPACE","\n        ",1085],["T_VARIABLE","$status",1086],["T_WHITESPACE"," ",1086],"=",["T_WHITESPACE"," ",1086],["T_STRING","true",1086],";",["T_WHITESPACE","\n        ",1086],["T_IF","if",1087],["T_WHITESPACE"," ",1087],"(",["T_VARIABLE","$isOnline",1087],")",["T_WHITESPACE"," ",1087],"{",["T_WHITESPACE","\n            ",1087],["T_COMMENT","\/\/ invoke authorization on gateway\n",1088],["T_WHITESPACE","            ",1089],["T_VARIABLE","$this",1089],["T_OBJECT_OPERATOR","->",1089],["T_STRING","getMethodInstance",1089],"(",")",["T_OBJECT_OPERATOR","->",1089],["T_STRING","setStore",1089],"(",["T_VARIABLE","$order",1089],["T_OBJECT_OPERATOR","->",1089],["T_STRING","getStoreId",1089],"(",")",")",["T_OBJECT_OPERATOR","->",1089],["T_STRING","authorize",1089],"(",["T_VARIABLE","$this",1089],",",["T_WHITESPACE"," ",1089],["T_VARIABLE","$amount",1089],")",";",["T_WHITESPACE","\n        ",1089],"}",["T_WHITESPACE","\n\n        ",1090],["T_COMMENT","\/\/ similar logic of \"payment review\" order as in capturing\n",1092],["T_WHITESPACE","        ",1093],["T_IF","if",1093],["T_WHITESPACE"," ",1093],"(",["T_VARIABLE","$this",1093],["T_OBJECT_OPERATOR","->",1093],["T_STRING","getIsTransactionPending",1093],"(",")",")",["T_WHITESPACE"," ",1093],"{",["T_WHITESPACE","\n            ",1093],["T_VARIABLE","$message",1094],["T_WHITESPACE"," ",1094],"=",["T_WHITESPACE"," ",1094],["T_STRING","Mage",1094],["T_DOUBLE_COLON","::",1094],["T_STRING","helper",1094],"(",["T_CONSTANT_ENCAPSED_STRING","'sales'",1094],")",["T_OBJECT_OPERATOR","->",1094],["T_STRING","__",1094],"(",["T_CONSTANT_ENCAPSED_STRING","'Authorizing amount of %s is pending approval on gateway.'",1094],",",["T_WHITESPACE"," ",1094],["T_VARIABLE","$this",1094],["T_OBJECT_OPERATOR","->",1094],["T_STRING","_formatPrice",1094],"(",["T_VARIABLE","$amount",1094],")",")",";",["T_WHITESPACE","\n            ",1094],["T_VARIABLE","$state",1095],["T_WHITESPACE"," ",1095],"=",["T_WHITESPACE"," ",1095],["T_STRING","Mage_Sales_Model_Order",1095],["T_DOUBLE_COLON","::",1095],["T_STRING","STATE_PAYMENT_REVIEW",1095],";",["T_WHITESPACE","\n            ",1095],["T_IF","if",1096],["T_WHITESPACE"," ",1096],"(",["T_VARIABLE","$this",1096],["T_OBJECT_OPERATOR","->",1096],["T_STRING","getIsFraudDetected",1096],"(",")",")",["T_WHITESPACE"," ",1096],"{",["T_WHITESPACE","\n                ",1096],["T_VARIABLE","$status",1097],["T_WHITESPACE"," ",1097],"=",["T_WHITESPACE"," ",1097],["T_STRING","Mage_Sales_Model_Order",1097],["T_DOUBLE_COLON","::",1097],["T_STRING","STATUS_FRAUD",1097],";",["T_WHITESPACE","\n            ",1097],"}",["T_WHITESPACE","\n        ",1098],"}",["T_WHITESPACE"," ",1099],["T_ELSE","else",1099],["T_WHITESPACE"," ",1099],"{",["T_WHITESPACE","\n            ",1099],["T_IF","if",1100],["T_WHITESPACE"," ",1100],"(",["T_VARIABLE","$this",1100],["T_OBJECT_OPERATOR","->",1100],["T_STRING","getIsFraudDetected",1100],"(",")",")",["T_WHITESPACE"," ",1100],"{",["T_WHITESPACE","\n                ",1100],["T_VARIABLE","$state",1101],["T_WHITESPACE"," ",1101],"=",["T_WHITESPACE"," ",1101],["T_STRING","Mage_Sales_Model_Order",1101],["T_DOUBLE_COLON","::",1101],["T_STRING","STATE_PAYMENT_REVIEW",1101],";",["T_WHITESPACE","\n                ",1101],["T_VARIABLE","$message",1102],["T_WHITESPACE"," ",1102],"=",["T_WHITESPACE"," ",1102],["T_STRING","Mage",1102],["T_DOUBLE_COLON","::",1102],["T_STRING","helper",1102],"(",["T_CONSTANT_ENCAPSED_STRING","'sales'",1102],")",["T_OBJECT_OPERATOR","->",1102],["T_STRING","__",1102],"(",["T_CONSTANT_ENCAPSED_STRING","'Order is suspended as its authorizing amount %s is suspected to be fraudulent.'",1102],",",["T_WHITESPACE"," ",1102],["T_VARIABLE","$this",1102],["T_OBJECT_OPERATOR","->",1102],["T_STRING","_formatPrice",1102],"(",["T_VARIABLE","$amount",1102],",",["T_WHITESPACE"," ",1102],["T_VARIABLE","$this",1102],["T_OBJECT_OPERATOR","->",1102],["T_STRING","getCurrencyCode",1102],"(",")",")",")",";",["T_WHITESPACE","\n                ",1102],["T_VARIABLE","$status",1103],["T_WHITESPACE"," ",1103],"=",["T_WHITESPACE"," ",1103],["T_STRING","Mage_Sales_Model_Order",1103],["T_DOUBLE_COLON","::",1103],["T_STRING","STATUS_FRAUD",1103],";",["T_WHITESPACE","\n            ",1103],"}",["T_WHITESPACE"," ",1104],["T_ELSE","else",1104],["T_WHITESPACE"," ",1104],"{",["T_WHITESPACE","\n                ",1104],["T_VARIABLE","$message",1105],["T_WHITESPACE"," ",1105],"=",["T_WHITESPACE"," ",1105],["T_STRING","Mage",1105],["T_DOUBLE_COLON","::",1105],["T_STRING","helper",1105],"(",["T_CONSTANT_ENCAPSED_STRING","'sales'",1105],")",["T_OBJECT_OPERATOR","->",1105],["T_STRING","__",1105],"(",["T_CONSTANT_ENCAPSED_STRING","'Authorized amount of %s.'",1105],",",["T_WHITESPACE"," ",1105],["T_VARIABLE","$this",1105],["T_OBJECT_OPERATOR","->",1105],["T_STRING","_formatPrice",1105],"(",["T_VARIABLE","$amount",1105],")",")",";",["T_WHITESPACE","\n            ",1105],"}",["T_WHITESPACE","\n        ",1106],"}",["T_WHITESPACE","\n\n        ",1107],["T_COMMENT","\/\/ update transactions, order state and add comments\n",1109],["T_WHITESPACE","        ",1110],["T_VARIABLE","$transaction",1110],["T_WHITESPACE"," ",1110],"=",["T_WHITESPACE"," ",1110],["T_VARIABLE","$this",1110],["T_OBJECT_OPERATOR","->",1110],["T_STRING","_addTransaction",1110],"(",["T_STRING","Mage_Sales_Model_Order_Payment_Transaction",1110],["T_DOUBLE_COLON","::",1110],["T_STRING","TYPE_AUTH",1110],")",";",["T_WHITESPACE","\n        ",1110],["T_IF","if",1111],["T_WHITESPACE"," ",1111],"(",["T_VARIABLE","$order",1111],["T_OBJECT_OPERATOR","->",1111],["T_STRING","isNominal",1111],"(",")",")",["T_WHITESPACE"," ",1111],"{",["T_WHITESPACE","\n            ",1111],["T_VARIABLE","$message",1112],["T_WHITESPACE"," ",1112],"=",["T_WHITESPACE"," ",1112],["T_VARIABLE","$this",1112],["T_OBJECT_OPERATOR","->",1112],["T_STRING","_prependMessage",1112],"(",["T_STRING","Mage",1112],["T_DOUBLE_COLON","::",1112],["T_STRING","helper",1112],"(",["T_CONSTANT_ENCAPSED_STRING","'sales'",1112],")",["T_OBJECT_OPERATOR","->",1112],["T_STRING","__",1112],"(",["T_CONSTANT_ENCAPSED_STRING","'Nominal order registered.'",1112],")",")",";",["T_WHITESPACE","\n        ",1112],"}",["T_WHITESPACE"," ",1113],["T_ELSE","else",1113],["T_WHITESPACE"," ",1113],"{",["T_WHITESPACE","\n            ",1113],["T_VARIABLE","$message",1114],["T_WHITESPACE"," ",1114],"=",["T_WHITESPACE"," ",1114],["T_VARIABLE","$this",1114],["T_OBJECT_OPERATOR","->",1114],["T_STRING","_prependMessage",1114],"(",["T_VARIABLE","$message",1114],")",";",["T_WHITESPACE","\n            ",1114],["T_VARIABLE","$message",1115],["T_WHITESPACE"," ",1115],"=",["T_WHITESPACE"," ",1115],["T_VARIABLE","$this",1115],["T_OBJECT_OPERATOR","->",1115],["T_STRING","_appendTransactionToMessage",1115],"(",["T_VARIABLE","$transaction",1115],",",["T_WHITESPACE"," ",1115],["T_VARIABLE","$message",1115],")",";",["T_WHITESPACE","\n        ",1115],"}",["T_WHITESPACE","\n        ",1116],["T_VARIABLE","$order",1117],["T_OBJECT_OPERATOR","->",1117],["T_STRING","setState",1117],"(",["T_VARIABLE","$state",1117],",",["T_WHITESPACE"," ",1117],["T_VARIABLE","$status",1117],",",["T_WHITESPACE"," ",1117],["T_VARIABLE","$message",1117],")",";",["T_WHITESPACE","\n\n        ",1117],["T_RETURN","return",1119],["T_WHITESPACE"," ",1119],["T_VARIABLE","$this",1119],";",["T_WHITESPACE","\n    ",1119],"}",["T_WHITESPACE","\n\n    ",1120],["T_DOC_COMMENT","\/**\n     * Public access to _authorize method\n     * @param bool $isOnline\n     * @param float $amount\n     *\/",1122],["T_WHITESPACE","\n    ",1126],["T_PUBLIC","public",1127],["T_WHITESPACE"," ",1127],["T_FUNCTION","function",1127],["T_WHITESPACE"," ",1127],["T_STRING","authorize",1127],"(",["T_VARIABLE","$isOnline",1127],",",["T_WHITESPACE"," ",1127],["T_VARIABLE","$amount",1127],")",["T_WHITESPACE","\n    ",1127],"{",["T_WHITESPACE","\n        ",1128],["T_RETURN","return",1129],["T_WHITESPACE"," ",1129],["T_VARIABLE","$this",1129],["T_OBJECT_OPERATOR","->",1129],["T_STRING","_authorize",1129],"(",["T_VARIABLE","$isOnline",1129],",",["T_WHITESPACE"," ",1129],["T_VARIABLE","$amount",1129],")",";",["T_WHITESPACE","\n    ",1129],"}",["T_WHITESPACE","\n\n    ",1130],["T_DOC_COMMENT","\/**\n     * Void payment either online or offline (process void notification)\n     * NOTE: that in some cases authorization can be voided after a capture. In such case it makes sense to use\n     *       the amount void amount, for informational purposes.\n     * Updates payment totals, updates order status and adds proper comments\n     *\n     * @param bool $isOnline\n     * @param float $amount\n     * @param string $gatewayCallback\n     * @return Mage_Sales_Model_Order_Payment\n     *\/",1132],["T_WHITESPACE","\n    ",1142],["T_PROTECTED","protected",1143],["T_WHITESPACE"," ",1143],["T_FUNCTION","function",1143],["T_WHITESPACE"," ",1143],["T_STRING","_void",1143],"(",["T_VARIABLE","$isOnline",1143],",",["T_WHITESPACE"," ",1143],["T_VARIABLE","$amount",1143],["T_WHITESPACE"," ",1143],"=",["T_WHITESPACE"," ",1143],["T_STRING","null",1143],",",["T_WHITESPACE"," ",1143],["T_VARIABLE","$gatewayCallback",1143],["T_WHITESPACE"," ",1143],"=",["T_WHITESPACE"," ",1143],["T_CONSTANT_ENCAPSED_STRING","'void'",1143],")",["T_WHITESPACE","\n    ",1143],"{",["T_WHITESPACE","\n        ",1144],["T_VARIABLE","$order",1145],["T_WHITESPACE"," ",1145],"=",["T_WHITESPACE"," ",1145],["T_VARIABLE","$this",1145],["T_OBJECT_OPERATOR","->",1145],["T_STRING","getOrder",1145],"(",")",";",["T_WHITESPACE","\n        ",1145],["T_VARIABLE","$authTransaction",1146],["T_WHITESPACE"," ",1146],"=",["T_WHITESPACE"," ",1146],["T_VARIABLE","$this",1146],["T_OBJECT_OPERATOR","->",1146],["T_STRING","getAuthorizationTransaction",1146],"(",")",";",["T_WHITESPACE","\n        ",1146],["T_VARIABLE","$this",1147],["T_OBJECT_OPERATOR","->",1147],["T_STRING","_generateTransactionId",1147],"(",["T_STRING","Mage_Sales_Model_Order_Payment_Transaction",1147],["T_DOUBLE_COLON","::",1147],["T_STRING","TYPE_VOID",1147],",",["T_WHITESPACE"," ",1147],["T_VARIABLE","$authTransaction",1147],")",";",["T_WHITESPACE","\n        ",1147],["T_VARIABLE","$this",1148],["T_OBJECT_OPERATOR","->",1148],["T_STRING","setShouldCloseParentTransaction",1148],"(",["T_STRING","true",1148],")",";",["T_WHITESPACE","\n\n        ",1148],["T_COMMENT","\/\/ attempt to void\n",1150],["T_WHITESPACE","        ",1151],["T_IF","if",1151],["T_WHITESPACE"," ",1151],"(",["T_VARIABLE","$isOnline",1151],")",["T_WHITESPACE"," ",1151],"{",["T_WHITESPACE","\n            ",1151],["T_VARIABLE","$this",1152],["T_OBJECT_OPERATOR","->",1152],["T_STRING","getMethodInstance",1152],"(",")",["T_OBJECT_OPERATOR","->",1152],["T_STRING","setStore",1152],"(",["T_VARIABLE","$order",1152],["T_OBJECT_OPERATOR","->",1152],["T_STRING","getStoreId",1152],"(",")",")",["T_OBJECT_OPERATOR","->",1152],["T_VARIABLE","$gatewayCallback",1152],"(",["T_VARIABLE","$this",1152],")",";",["T_WHITESPACE","\n        ",1152],"}",["T_WHITESPACE","\n        ",1153],["T_IF","if",1154],["T_WHITESPACE"," ",1154],"(",["T_VARIABLE","$this",1154],["T_OBJECT_OPERATOR","->",1154],["T_STRING","_isTransactionExists",1154],"(",")",")",["T_WHITESPACE"," ",1154],"{",["T_WHITESPACE","\n            ",1154],["T_RETURN","return",1155],["T_WHITESPACE"," ",1155],["T_VARIABLE","$this",1155],";",["T_WHITESPACE","\n        ",1155],"}",["T_WHITESPACE","\n\n        ",1156],["T_COMMENT","\/\/ if the authorization was untouched, we may assume voided amount = order grand total\n",1158],["T_WHITESPACE","        ",1159],["T_COMMENT","\/\/ but only if the payment auth amount equals to order grand total\n",1159],["T_WHITESPACE","        ",1160],["T_IF","if",1160],["T_WHITESPACE"," ",1160],"(",["T_VARIABLE","$authTransaction",1160],["T_WHITESPACE"," ",1160],["T_BOOLEAN_AND","&&",1160],["T_WHITESPACE"," ",1160],"(",["T_VARIABLE","$order",1160],["T_OBJECT_OPERATOR","->",1160],["T_STRING","getBaseGrandTotal",1160],"(",")",["T_WHITESPACE"," ",1160],["T_IS_EQUAL","==",1160],["T_WHITESPACE"," ",1160],["T_VARIABLE","$this",1160],["T_OBJECT_OPERATOR","->",1160],["T_STRING","getBaseAmountAuthorized",1160],"(",")",")",["T_WHITESPACE","\n            ",1160],["T_BOOLEAN_AND","&&",1161],["T_WHITESPACE"," ",1161],"(",["T_LNUMBER","0",1161],["T_WHITESPACE"," ",1161],["T_IS_EQUAL","==",1161],["T_WHITESPACE"," ",1161],["T_VARIABLE","$this",1161],["T_OBJECT_OPERATOR","->",1161],["T_STRING","getBaseAmountCanceled",1161],"(",")",")",")",["T_WHITESPACE"," ",1161],"{",["T_WHITESPACE","\n            ",1161],["T_IF","if",1162],["T_WHITESPACE"," ",1162],"(",["T_VARIABLE","$authTransaction",1162],["T_OBJECT_OPERATOR","->",1162],["T_STRING","canVoidAuthorizationCompletely",1162],"(",")",")",["T_WHITESPACE"," ",1162],"{",["T_WHITESPACE","\n                ",1162],["T_VARIABLE","$amount",1163],["T_WHITESPACE"," ",1163],"=",["T_WHITESPACE"," ",1163],["T_DOUBLE_CAST","(float)",1163],["T_VARIABLE","$order",1163],["T_OBJECT_OPERATOR","->",1163],["T_STRING","getBaseGrandTotal",1163],"(",")",";",["T_WHITESPACE","\n            ",1163],"}",["T_WHITESPACE","\n        ",1164],"}",["T_WHITESPACE","\n\n        ",1165],["T_IF","if",1167],["T_WHITESPACE"," ",1167],"(",["T_VARIABLE","$amount",1167],")",["T_WHITESPACE"," ",1167],"{",["T_WHITESPACE","\n            ",1167],["T_VARIABLE","$amount",1168],["T_WHITESPACE"," ",1168],"=",["T_WHITESPACE"," ",1168],["T_VARIABLE","$this",1168],["T_OBJECT_OPERATOR","->",1168],["T_STRING","_formatAmount",1168],"(",["T_VARIABLE","$amount",1168],")",";",["T_WHITESPACE","\n        ",1168],"}",["T_WHITESPACE","\n\n        ",1169],["T_COMMENT","\/\/ update transactions, order state and add comments\n",1171],["T_WHITESPACE","        ",1172],["T_VARIABLE","$transaction",1172],["T_WHITESPACE"," ",1172],"=",["T_WHITESPACE"," ",1172],["T_VARIABLE","$this",1172],["T_OBJECT_OPERATOR","->",1172],["T_STRING","_addTransaction",1172],"(",["T_STRING","Mage_Sales_Model_Order_Payment_Transaction",1172],["T_DOUBLE_COLON","::",1172],["T_STRING","TYPE_VOID",1172],",",["T_WHITESPACE"," ",1172],["T_STRING","null",1172],",",["T_WHITESPACE"," ",1172],["T_STRING","true",1172],")",";",["T_WHITESPACE","\n        ",1172],["T_VARIABLE","$message",1173],["T_WHITESPACE"," ",1173],"=",["T_WHITESPACE"," ",1173],["T_VARIABLE","$this",1173],["T_OBJECT_OPERATOR","->",1173],["T_STRING","hasMessage",1173],"(",")",["T_WHITESPACE"," ",1173],"?",["T_WHITESPACE"," ",1173],["T_VARIABLE","$this",1173],["T_OBJECT_OPERATOR","->",1173],["T_STRING","getMessage",1173],"(",")",["T_WHITESPACE"," ",1173],":",["T_WHITESPACE"," ",1173],["T_STRING","Mage",1173],["T_DOUBLE_COLON","::",1173],["T_STRING","helper",1173],"(",["T_CONSTANT_ENCAPSED_STRING","'sales'",1173],")",["T_OBJECT_OPERATOR","->",1173],["T_STRING","__",1173],"(",["T_CONSTANT_ENCAPSED_STRING","'Voided authorization.'",1173],")",";",["T_WHITESPACE","\n        ",1173],["T_VARIABLE","$message",1174],["T_WHITESPACE"," ",1174],"=",["T_WHITESPACE"," ",1174],["T_VARIABLE","$this",1174],["T_OBJECT_OPERATOR","->",1174],["T_STRING","_prependMessage",1174],"(",["T_VARIABLE","$message",1174],")",";",["T_WHITESPACE","\n        ",1174],["T_IF","if",1175],["T_WHITESPACE"," ",1175],"(",["T_VARIABLE","$amount",1175],")",["T_WHITESPACE"," ",1175],"{",["T_WHITESPACE","\n            ",1175],["T_VARIABLE","$message",1176],["T_WHITESPACE"," ",1176],["T_CONCAT_EQUAL",".=",1176],["T_WHITESPACE"," ",1176],["T_CONSTANT_ENCAPSED_STRING","' '",1176],["T_WHITESPACE"," ",1176],".",["T_WHITESPACE"," ",1176],["T_STRING","Mage",1176],["T_DOUBLE_COLON","::",1176],["T_STRING","helper",1176],"(",["T_CONSTANT_ENCAPSED_STRING","'sales'",1176],")",["T_OBJECT_OPERATOR","->",1176],["T_STRING","__",1176],"(",["T_CONSTANT_ENCAPSED_STRING","'Amount: %s.'",1176],",",["T_WHITESPACE"," ",1176],["T_VARIABLE","$this",1176],["T_OBJECT_OPERATOR","->",1176],["T_STRING","_formatPrice",1176],"(",["T_VARIABLE","$amount",1176],")",")",";",["T_WHITESPACE","\n        ",1176],"}",["T_WHITESPACE","\n        ",1177],["T_VARIABLE","$message",1178],["T_WHITESPACE"," ",1178],"=",["T_WHITESPACE"," ",1178],["T_VARIABLE","$this",1178],["T_OBJECT_OPERATOR","->",1178],["T_STRING","_appendTransactionToMessage",1178],"(",["T_VARIABLE","$transaction",1178],",",["T_WHITESPACE"," ",1178],["T_VARIABLE","$message",1178],")",";",["T_WHITESPACE","\n        ",1178],["T_VARIABLE","$order",1179],["T_OBJECT_OPERATOR","->",1179],["T_STRING","setState",1179],"(",["T_STRING","Mage_Sales_Model_Order",1179],["T_DOUBLE_COLON","::",1179],["T_STRING","STATE_PROCESSING",1179],",",["T_WHITESPACE"," ",1179],["T_STRING","true",1179],",",["T_WHITESPACE"," ",1179],["T_VARIABLE","$message",1179],")",";",["T_WHITESPACE","\n        ",1179],["T_RETURN","return",1180],["T_WHITESPACE"," ",1180],["T_VARIABLE","$this",1180],";",["T_WHITESPACE","\n    ",1180],"}",["T_WHITESPACE","\n\n",1181],["T_COMMENT","\/\/    \/**\n",1183],["T_COMMENT","\/\/     * TODO: implement this\n",1184],["T_COMMENT","\/\/     * @param Mage_Sales_Model_Order_Invoice $invoice\n",1185],["T_COMMENT","\/\/     * @return Mage_Sales_Model_Order_Payment\n",1186],["T_COMMENT","\/\/     *\/\n",1187],["T_COMMENT","\/\/    public function cancelCapture($invoice = null)\n",1188],["T_COMMENT","\/\/    {\n",1189],["T_COMMENT","\/\/    }\n",1190],["T_WHITESPACE","\n    ",1191],["T_DOC_COMMENT","\/**\n     * Create transaction,\n     * prepare its insertion into hierarchy and add its information to payment and comments\n     *\n     * To add transactions and related information,\n     * the following information should be set to payment before processing:\n     * - transaction_id\n     * - is_transaction_closed (optional) - whether transaction should be closed or open (closed by default)\n     * - parent_transaction_id (optional)\n     * - should_close_parent_transaction (optional) - whether to close parent transaction (closed by default)\n     *\n     * If the sales document is specified, it will be linked to the transaction as related for future usage.\n     * Currently transaction ID is set into the sales object\n     * This method writes the added transaction ID into last_trans_id field of the payment object\n     *\n     * To make sure transaction object won't cause trouble before saving, use $failsafe = true\n     *\n     * @param string $type\n     * @param Mage_Sales_Model_Abstract $salesDocument\n     * @param bool $failsafe\n     * @return null|Mage_Sales_Model_Order_Payment_Transaction\n     *\/",1192],["T_WHITESPACE","\n    ",1213],["T_PROTECTED","protected",1214],["T_WHITESPACE"," ",1214],["T_FUNCTION","function",1214],["T_WHITESPACE"," ",1214],["T_STRING","_addTransaction",1214],"(",["T_VARIABLE","$type",1214],",",["T_WHITESPACE"," ",1214],["T_VARIABLE","$salesDocument",1214],["T_WHITESPACE"," ",1214],"=",["T_WHITESPACE"," ",1214],["T_STRING","null",1214],",",["T_WHITESPACE"," ",1214],["T_VARIABLE","$failsafe",1214],["T_WHITESPACE"," ",1214],"=",["T_WHITESPACE"," ",1214],["T_STRING","false",1214],")",["T_WHITESPACE","\n    ",1214],"{",["T_WHITESPACE","\n        ",1215],["T_IF","if",1216],["T_WHITESPACE"," ",1216],"(",["T_VARIABLE","$this",1216],["T_OBJECT_OPERATOR","->",1216],["T_STRING","getSkipTransactionCreation",1216],"(",")",")",["T_WHITESPACE"," ",1216],"{",["T_WHITESPACE","\n            ",1216],["T_VARIABLE","$this",1217],["T_OBJECT_OPERATOR","->",1217],["T_STRING","unsTransactionId",1217],"(",")",";",["T_WHITESPACE","\n            ",1217],["T_RETURN","return",1218],["T_WHITESPACE"," ",1218],["T_STRING","null",1218],";",["T_WHITESPACE","\n        ",1218],"}",["T_WHITESPACE","\n\n        ",1219],["T_COMMENT","\/\/ look for set transaction ids\n",1221],["T_WHITESPACE","        ",1222],["T_VARIABLE","$transactionId",1222],["T_WHITESPACE"," ",1222],"=",["T_WHITESPACE"," ",1222],["T_VARIABLE","$this",1222],["T_OBJECT_OPERATOR","->",1222],["T_STRING","getTransactionId",1222],"(",")",";",["T_WHITESPACE","\n        ",1222],["T_IF","if",1223],["T_WHITESPACE"," ",1223],"(",["T_STRING","null",1223],["T_WHITESPACE"," ",1223],["T_IS_NOT_IDENTICAL","!==",1223],["T_WHITESPACE"," ",1223],["T_VARIABLE","$transactionId",1223],")",["T_WHITESPACE"," ",1223],"{",["T_WHITESPACE","\n            ",1223],["T_COMMENT","\/\/ set transaction parameters\n",1224],["T_WHITESPACE","            ",1225],["T_VARIABLE","$transaction",1225],["T_WHITESPACE"," ",1225],"=",["T_WHITESPACE"," ",1225],["T_STRING","false",1225],";",["T_WHITESPACE","\n            ",1225],["T_IF","if",1226],["T_WHITESPACE"," ",1226],"(",["T_VARIABLE","$this",1226],["T_OBJECT_OPERATOR","->",1226],["T_STRING","getOrder",1226],"(",")",["T_OBJECT_OPERATOR","->",1226],["T_STRING","getId",1226],"(",")",")",["T_WHITESPACE"," ",1226],"{",["T_WHITESPACE","\n                ",1226],["T_VARIABLE","$transaction",1227],["T_WHITESPACE"," ",1227],"=",["T_WHITESPACE"," ",1227],["T_VARIABLE","$this",1227],["T_OBJECT_OPERATOR","->",1227],["T_STRING","_lookupTransaction",1227],"(",["T_VARIABLE","$transactionId",1227],")",";",["T_WHITESPACE","\n            ",1227],"}",["T_WHITESPACE","\n            ",1228],["T_IF","if",1229],["T_WHITESPACE"," ",1229],"(","!",["T_VARIABLE","$transaction",1229],")",["T_WHITESPACE"," ",1229],"{",["T_WHITESPACE","\n                ",1229],["T_VARIABLE","$transaction",1230],["T_WHITESPACE"," ",1230],"=",["T_WHITESPACE"," ",1230],["T_STRING","Mage",1230],["T_DOUBLE_COLON","::",1230],["T_STRING","getModel",1230],"(",["T_CONSTANT_ENCAPSED_STRING","'sales\/order_payment_transaction'",1230],")",["T_OBJECT_OPERATOR","->",1230],["T_STRING","setTxnId",1230],"(",["T_VARIABLE","$transactionId",1230],")",";",["T_WHITESPACE","\n            ",1230],"}",["T_WHITESPACE","\n            ",1231],["T_VARIABLE","$transaction",1232],["T_WHITESPACE","\n                ",1232],["T_OBJECT_OPERATOR","->",1233],["T_STRING","setOrderPaymentObject",1233],"(",["T_VARIABLE","$this",1233],")",["T_WHITESPACE","\n                ",1233],["T_OBJECT_OPERATOR","->",1234],["T_STRING","setTxnType",1234],"(",["T_VARIABLE","$type",1234],")",["T_WHITESPACE","\n                ",1234],["T_OBJECT_OPERATOR","->",1235],["T_STRING","isFailsafe",1235],"(",["T_VARIABLE","$failsafe",1235],")",";",["T_WHITESPACE","\n\n            ",1235],["T_IF","if",1237],["T_WHITESPACE"," ",1237],"(",["T_VARIABLE","$this",1237],["T_OBJECT_OPERATOR","->",1237],["T_STRING","hasIsTransactionClosed",1237],"(",")",")",["T_WHITESPACE"," ",1237],"{",["T_WHITESPACE","\n                ",1237],["T_VARIABLE","$transaction",1238],["T_OBJECT_OPERATOR","->",1238],["T_STRING","setIsClosed",1238],"(",["T_INT_CAST","(int)",1238],["T_VARIABLE","$this",1238],["T_OBJECT_OPERATOR","->",1238],["T_STRING","getIsTransactionClosed",1238],"(",")",")",";",["T_WHITESPACE","\n            ",1238],"}",["T_WHITESPACE","\n\n            ",1239],["T_COMMENT","\/\/set transaction addition information\n",1241],["T_WHITESPACE","            ",1242],["T_IF","if",1242],["T_WHITESPACE"," ",1242],"(",["T_VARIABLE","$this",1242],["T_OBJECT_OPERATOR","->",1242],["T_STRING","_transactionAdditionalInfo",1242],")",["T_WHITESPACE"," ",1242],"{",["T_WHITESPACE","\n                ",1242],["T_FOREACH","foreach",1243],["T_WHITESPACE"," ",1243],"(",["T_VARIABLE","$this",1243],["T_OBJECT_OPERATOR","->",1243],["T_STRING","_transactionAdditionalInfo",1243],["T_WHITESPACE"," ",1243],["T_AS","as",1243],["T_WHITESPACE"," ",1243],["T_VARIABLE","$key",1243],["T_WHITESPACE"," ",1243],["T_DOUBLE_ARROW","=>",1243],["T_WHITESPACE"," ",1243],["T_VARIABLE","$value",1243],")",["T_WHITESPACE"," ",1243],"{",["T_WHITESPACE","\n                    ",1243],["T_VARIABLE","$transaction",1244],["T_OBJECT_OPERATOR","->",1244],["T_STRING","setAdditionalInformation",1244],"(",["T_VARIABLE","$key",1244],",",["T_WHITESPACE"," ",1244],["T_VARIABLE","$value",1244],")",";",["T_WHITESPACE","\n                ",1244],"}",["T_WHITESPACE","\n            ",1245],"}",["T_WHITESPACE","\n\n            ",1246],["T_COMMENT","\/\/ link with sales entities\n",1248],["T_WHITESPACE","            ",1249],["T_VARIABLE","$this",1249],["T_OBJECT_OPERATOR","->",1249],["T_STRING","setLastTransId",1249],"(",["T_VARIABLE","$transactionId",1249],")",";",["T_WHITESPACE","\n            ",1249],["T_VARIABLE","$this",1250],["T_OBJECT_OPERATOR","->",1250],["T_STRING","setCreatedTransaction",1250],"(",["T_VARIABLE","$transaction",1250],")",";",["T_WHITESPACE","\n            ",1250],["T_VARIABLE","$this",1251],["T_OBJECT_OPERATOR","->",1251],["T_STRING","getOrder",1251],"(",")",["T_OBJECT_OPERATOR","->",1251],["T_STRING","addRelatedObject",1251],"(",["T_VARIABLE","$transaction",1251],")",";",["T_WHITESPACE","\n            ",1251],["T_IF","if",1252],["T_WHITESPACE"," ",1252],"(",["T_VARIABLE","$salesDocument",1252],["T_WHITESPACE"," ",1252],["T_BOOLEAN_AND","&&",1252],["T_WHITESPACE"," ",1252],["T_VARIABLE","$salesDocument",1252],["T_WHITESPACE"," ",1252],["T_INSTANCEOF","instanceof",1252],["T_WHITESPACE"," ",1252],["T_STRING","Mage_Sales_Model_Abstract",1252],")",["T_WHITESPACE"," ",1252],"{",["T_WHITESPACE","\n                ",1252],["T_VARIABLE","$salesDocument",1253],["T_OBJECT_OPERATOR","->",1253],["T_STRING","setTransactionId",1253],"(",["T_VARIABLE","$transactionId",1253],")",";",["T_WHITESPACE","\n                ",1253],["T_COMMENT","\/\/ TODO: linking transaction with the sales document\n",1254],["T_WHITESPACE","            ",1255],"}",["T_WHITESPACE","\n\n            ",1255],["T_COMMENT","\/\/ link with parent transaction\n",1257],["T_WHITESPACE","            ",1258],["T_VARIABLE","$parentTransactionId",1258],["T_WHITESPACE"," ",1258],"=",["T_WHITESPACE"," ",1258],["T_VARIABLE","$this",1258],["T_OBJECT_OPERATOR","->",1258],["T_STRING","getParentTransactionId",1258],"(",")",";",["T_WHITESPACE","\n\n            ",1258],["T_IF","if",1260],["T_WHITESPACE"," ",1260],"(",["T_VARIABLE","$parentTransactionId",1260],")",["T_WHITESPACE"," ",1260],"{",["T_WHITESPACE","\n                ",1260],["T_VARIABLE","$transaction",1261],["T_OBJECT_OPERATOR","->",1261],["T_STRING","setParentTxnId",1261],"(",["T_VARIABLE","$parentTransactionId",1261],")",";",["T_WHITESPACE","\n                ",1261],["T_IF","if",1262],["T_WHITESPACE"," ",1262],"(",["T_VARIABLE","$this",1262],["T_OBJECT_OPERATOR","->",1262],["T_STRING","getShouldCloseParentTransaction",1262],"(",")",")",["T_WHITESPACE"," ",1262],"{",["T_WHITESPACE","\n                    ",1262],["T_VARIABLE","$parentTransaction",1263],["T_WHITESPACE"," ",1263],"=",["T_WHITESPACE"," ",1263],["T_VARIABLE","$this",1263],["T_OBJECT_OPERATOR","->",1263],["T_STRING","_lookupTransaction",1263],"(",["T_VARIABLE","$parentTransactionId",1263],")",";",["T_WHITESPACE","\n                    ",1263],["T_IF","if",1264],["T_WHITESPACE"," ",1264],"(",["T_VARIABLE","$parentTransaction",1264],")",["T_WHITESPACE"," ",1264],"{",["T_WHITESPACE","\n                        ",1264],["T_IF","if",1265],["T_WHITESPACE"," ",1265],"(","!",["T_VARIABLE","$parentTransaction",1265],["T_OBJECT_OPERATOR","->",1265],["T_STRING","getIsClosed",1265],"(",")",")",["T_WHITESPACE"," ",1265],"{",["T_WHITESPACE","\n                            ",1265],["T_VARIABLE","$parentTransaction",1266],["T_OBJECT_OPERATOR","->",1266],["T_STRING","isFailsafe",1266],"(",["T_VARIABLE","$failsafe",1266],")",["T_OBJECT_OPERATOR","->",1266],["T_STRING","close",1266],"(",["T_STRING","false",1266],")",";",["T_WHITESPACE","\n                        ",1266],"}",["T_WHITESPACE","\n                        ",1267],["T_VARIABLE","$this",1268],["T_OBJECT_OPERATOR","->",1268],["T_STRING","getOrder",1268],"(",")",["T_OBJECT_OPERATOR","->",1268],["T_STRING","addRelatedObject",1268],"(",["T_VARIABLE","$parentTransaction",1268],")",";",["T_WHITESPACE","\n                    ",1268],"}",["T_WHITESPACE","\n                ",1269],"}",["T_WHITESPACE","\n            ",1270],"}",["T_WHITESPACE","\n            ",1271],["T_RETURN","return",1272],["T_WHITESPACE"," ",1272],["T_VARIABLE","$transaction",1272],";",["T_WHITESPACE","\n        ",1272],"}",["T_WHITESPACE","\n    ",1273],"}",["T_WHITESPACE","\n\n    ",1274],["T_DOC_COMMENT","\/**\n     * Public acces to _addTransaction method\n     *\n     * @param string $type\n     * @param Mage_Sales_Model_Abstract $salesDocument\n     * @param bool $failsafe\n     * @param string $message\n     * @return null|Mage_Sales_Model_Order_Payment_Transaction\n     *\/",1276],["T_WHITESPACE","\n    ",1284],["T_PUBLIC","public",1285],["T_WHITESPACE"," ",1285],["T_FUNCTION","function",1285],["T_WHITESPACE"," ",1285],["T_STRING","addTransaction",1285],"(",["T_VARIABLE","$type",1285],",",["T_WHITESPACE"," ",1285],["T_VARIABLE","$salesDocument",1285],["T_WHITESPACE"," ",1285],"=",["T_WHITESPACE"," ",1285],["T_STRING","null",1285],",",["T_WHITESPACE"," ",1285],["T_VARIABLE","$failsafe",1285],["T_WHITESPACE"," ",1285],"=",["T_WHITESPACE"," ",1285],["T_STRING","false",1285],",",["T_WHITESPACE"," ",1285],["T_VARIABLE","$message",1285],["T_WHITESPACE"," ",1285],"=",["T_WHITESPACE"," ",1285],["T_STRING","false",1285],")",["T_WHITESPACE","\n    ",1285],"{",["T_WHITESPACE","\n        ",1286],["T_VARIABLE","$transaction",1287],["T_WHITESPACE"," ",1287],"=",["T_WHITESPACE"," ",1287],["T_VARIABLE","$this",1287],["T_OBJECT_OPERATOR","->",1287],["T_STRING","_addTransaction",1287],"(",["T_VARIABLE","$type",1287],",",["T_WHITESPACE"," ",1287],["T_VARIABLE","$salesDocument",1287],",",["T_WHITESPACE"," ",1287],["T_VARIABLE","$failsafe",1287],")",";",["T_WHITESPACE","\n\n        ",1287],["T_IF","if",1289],["T_WHITESPACE"," ",1289],"(",["T_VARIABLE","$message",1289],")",["T_WHITESPACE"," ",1289],"{",["T_WHITESPACE","\n            ",1289],["T_VARIABLE","$order",1290],["T_WHITESPACE"," ",1290],"=",["T_WHITESPACE"," ",1290],["T_VARIABLE","$this",1290],["T_OBJECT_OPERATOR","->",1290],["T_STRING","getOrder",1290],"(",")",";",["T_WHITESPACE","\n            ",1290],["T_VARIABLE","$message",1291],["T_WHITESPACE"," ",1291],"=",["T_WHITESPACE"," ",1291],["T_VARIABLE","$this",1291],["T_OBJECT_OPERATOR","->",1291],["T_STRING","_appendTransactionToMessage",1291],"(",["T_VARIABLE","$transaction",1291],",",["T_WHITESPACE"," ",1291],["T_VARIABLE","$message",1291],")",";",["T_WHITESPACE","\n            ",1291],["T_VARIABLE","$order",1292],["T_OBJECT_OPERATOR","->",1292],["T_STRING","addStatusHistoryComment",1292],"(",["T_VARIABLE","$message",1292],")",";",["T_WHITESPACE","\n        ",1292],"}",["T_WHITESPACE","\n\n        ",1293],["T_RETURN","return",1295],["T_WHITESPACE"," ",1295],["T_VARIABLE","$transaction",1295],";",["T_WHITESPACE","\n    ",1295],"}",["T_WHITESPACE","\n\n    ",1296],["T_DOC_COMMENT","\/**\n     * Import details data of specified transaction\n     *\n     * @param Mage_Sales_Model_Order_Payment_Transaction $transactionTo\n     * @return Mage_Sales_Model_Order_Payment\n     *\/",1298],["T_WHITESPACE","\n    ",1303],["T_PUBLIC","public",1304],["T_WHITESPACE"," ",1304],["T_FUNCTION","function",1304],["T_WHITESPACE"," ",1304],["T_STRING","importTransactionInfo",1304],"(",["T_STRING","Mage_Sales_Model_Order_Payment_Transaction",1304],["T_WHITESPACE"," ",1304],["T_VARIABLE","$transactionTo",1304],")",["T_WHITESPACE","\n    ",1304],"{",["T_WHITESPACE","\n        ",1305],["T_VARIABLE","$data",1306],["T_WHITESPACE"," ",1306],"=",["T_WHITESPACE"," ",1306],["T_VARIABLE","$this",1306],["T_OBJECT_OPERATOR","->",1306],["T_STRING","getMethodInstance",1306],"(",")",["T_WHITESPACE","\n            ",1306],["T_OBJECT_OPERATOR","->",1307],["T_STRING","setStore",1307],"(",["T_VARIABLE","$this",1307],["T_OBJECT_OPERATOR","->",1307],["T_STRING","getOrder",1307],"(",")",["T_OBJECT_OPERATOR","->",1307],["T_STRING","getStoreId",1307],"(",")",")",["T_WHITESPACE","\n            ",1307],["T_OBJECT_OPERATOR","->",1308],["T_STRING","fetchTransactionInfo",1308],"(",["T_VARIABLE","$this",1308],",",["T_WHITESPACE"," ",1308],["T_VARIABLE","$transactionTo",1308],["T_OBJECT_OPERATOR","->",1308],["T_STRING","getTxnId",1308],"(",")",")",";",["T_WHITESPACE","\n        ",1308],["T_IF","if",1309],["T_WHITESPACE"," ",1309],"(",["T_VARIABLE","$data",1309],")",["T_WHITESPACE"," ",1309],"{",["T_WHITESPACE","\n            ",1309],["T_VARIABLE","$transactionTo",1310],["T_OBJECT_OPERATOR","->",1310],["T_STRING","setAdditionalInformation",1310],"(",["T_STRING","Mage_Sales_Model_Order_Payment_Transaction",1310],["T_DOUBLE_COLON","::",1310],["T_STRING","RAW_DETAILS",1310],",",["T_WHITESPACE"," ",1310],["T_VARIABLE","$data",1310],")",";",["T_WHITESPACE","\n        ",1310],"}",["T_WHITESPACE","\n        ",1311],["T_RETURN","return",1312],["T_WHITESPACE"," ",1312],["T_VARIABLE","$this",1312],";",["T_WHITESPACE","\n    ",1312],"}",["T_WHITESPACE","\n\n    ",1313],["T_DOC_COMMENT","\/**\n     * Get the billing agreement, if any\n     *\n     * @return Mage_Sales_Model_Billing_Agreement|null\n     *\/",1315],["T_WHITESPACE","\n    ",1319],["T_PUBLIC","public",1320],["T_WHITESPACE"," ",1320],["T_FUNCTION","function",1320],["T_WHITESPACE"," ",1320],["T_STRING","getBillingAgreement",1320],"(",")",["T_WHITESPACE","\n    ",1320],"{",["T_WHITESPACE","\n        ",1321],["T_RETURN","return",1322],["T_WHITESPACE"," ",1322],["T_VARIABLE","$this",1322],["T_OBJECT_OPERATOR","->",1322],["T_STRING","_billingAgreement",1322],";",["T_WHITESPACE","\n    ",1322],"}",["T_WHITESPACE","\n\n    ",1323],["T_DOC_COMMENT","\/**\n     * Totals updater utility method\n     * Updates self totals by keys in data array('key' => $delta)\n     *\n     * @param array $data\n     *\/",1325],["T_WHITESPACE","\n    ",1330],["T_PROTECTED","protected",1331],["T_WHITESPACE"," ",1331],["T_FUNCTION","function",1331],["T_WHITESPACE"," ",1331],["T_STRING","_updateTotals",1331],"(",["T_VARIABLE","$data",1331],")",["T_WHITESPACE","\n    ",1331],"{",["T_WHITESPACE","\n        ",1332],["T_FOREACH","foreach",1333],["T_WHITESPACE"," ",1333],"(",["T_VARIABLE","$data",1333],["T_WHITESPACE"," ",1333],["T_AS","as",1333],["T_WHITESPACE"," ",1333],["T_VARIABLE","$key",1333],["T_WHITESPACE"," ",1333],["T_DOUBLE_ARROW","=>",1333],["T_WHITESPACE"," ",1333],["T_VARIABLE","$amount",1333],")",["T_WHITESPACE"," ",1333],"{",["T_WHITESPACE","\n            ",1333],["T_IF","if",1334],["T_WHITESPACE"," ",1334],"(",["T_STRING","null",1334],["T_WHITESPACE"," ",1334],["T_IS_NOT_IDENTICAL","!==",1334],["T_WHITESPACE"," ",1334],["T_VARIABLE","$amount",1334],")",["T_WHITESPACE"," ",1334],"{",["T_WHITESPACE","\n                ",1334],["T_VARIABLE","$was",1335],["T_WHITESPACE"," ",1335],"=",["T_WHITESPACE"," ",1335],["T_VARIABLE","$this",1335],["T_OBJECT_OPERATOR","->",1335],["T_STRING","getDataUsingMethod",1335],"(",["T_VARIABLE","$key",1335],")",";",["T_WHITESPACE","\n                ",1335],["T_VARIABLE","$this",1336],["T_OBJECT_OPERATOR","->",1336],["T_STRING","setDataUsingMethod",1336],"(",["T_VARIABLE","$key",1336],",",["T_WHITESPACE"," ",1336],["T_VARIABLE","$was",1336],["T_WHITESPACE"," ",1336],"+",["T_WHITESPACE"," ",1336],["T_VARIABLE","$amount",1336],")",";",["T_WHITESPACE","\n            ",1336],"}",["T_WHITESPACE","\n        ",1337],"}",["T_WHITESPACE","\n    ",1338],"}",["T_WHITESPACE","\n\n    ",1339],["T_DOC_COMMENT","\/**\n     * Prevent double processing of the same transaction by a payment notification\n     * Uses either specified txn_id or the transaction id that was set before\n     *\n     * @deprecated after 1.4.0.1\n     * @param string $txnId\n     * @throws Mage_Core_Exception\n     *\/",1341],["T_WHITESPACE","\n    ",1348],["T_PROTECTED","protected",1349],["T_WHITESPACE"," ",1349],["T_FUNCTION","function",1349],["T_WHITESPACE"," ",1349],["T_STRING","_avoidDoubleTransactionProcessing",1349],"(",["T_VARIABLE","$txnId",1349],["T_WHITESPACE"," ",1349],"=",["T_WHITESPACE"," ",1349],["T_STRING","null",1349],")",["T_WHITESPACE","\n    ",1349],"{",["T_WHITESPACE","\n        ",1350],["T_IF","if",1351],["T_WHITESPACE"," ",1351],"(",["T_VARIABLE","$this",1351],["T_OBJECT_OPERATOR","->",1351],["T_STRING","_isTransactionExists",1351],"(",["T_VARIABLE","$txnId",1351],")",")",["T_WHITESPACE"," ",1351],"{",["T_WHITESPACE","\n            ",1351],["T_STRING","Mage",1352],["T_DOUBLE_COLON","::",1352],["T_STRING","throwException",1352],"(",["T_WHITESPACE","\n                ",1352],["T_STRING","Mage",1353],["T_DOUBLE_COLON","::",1353],["T_STRING","helper",1353],"(",["T_CONSTANT_ENCAPSED_STRING","'sales'",1353],")",["T_OBJECT_OPERATOR","->",1353],["T_STRING","__",1353],"(",["T_CONSTANT_ENCAPSED_STRING","'Transaction \"%s\" was already processed.'",1353],",",["T_WHITESPACE"," ",1353],["T_VARIABLE","$txnId",1353],")",["T_WHITESPACE","\n            ",1353],")",";",["T_WHITESPACE","\n        ",1354],"}",["T_WHITESPACE","\n    ",1355],"}",["T_WHITESPACE","\n\n    ",1356],["T_DOC_COMMENT","\/**\n     * Check transaction existence by specified transaction id\n     *\n     * @param string $txnId\n     * @return boolean\n     *\/",1358],["T_WHITESPACE","\n    ",1363],["T_PROTECTED","protected",1364],["T_WHITESPACE"," ",1364],["T_FUNCTION","function",1364],["T_WHITESPACE"," ",1364],["T_STRING","_isTransactionExists",1364],"(",["T_VARIABLE","$txnId",1364],["T_WHITESPACE"," ",1364],"=",["T_WHITESPACE"," ",1364],["T_STRING","null",1364],")",["T_WHITESPACE","\n    ",1364],"{",["T_WHITESPACE","\n        ",1365],["T_IF","if",1366],["T_WHITESPACE"," ",1366],"(",["T_STRING","null",1366],["T_WHITESPACE"," ",1366],["T_IS_IDENTICAL","===",1366],["T_WHITESPACE"," ",1366],["T_VARIABLE","$txnId",1366],")",["T_WHITESPACE"," ",1366],"{",["T_WHITESPACE","\n            ",1366],["T_VARIABLE","$txnId",1367],["T_WHITESPACE"," ",1367],"=",["T_WHITESPACE"," ",1367],["T_VARIABLE","$this",1367],["T_OBJECT_OPERATOR","->",1367],["T_STRING","getTransactionId",1367],"(",")",";",["T_WHITESPACE","\n        ",1367],"}",["T_WHITESPACE","\n        ",1368],["T_RETURN","return",1369],["T_WHITESPACE"," ",1369],["T_VARIABLE","$txnId",1369],["T_WHITESPACE"," ",1369],["T_BOOLEAN_AND","&&",1369],["T_WHITESPACE"," ",1369],["T_VARIABLE","$this",1369],["T_OBJECT_OPERATOR","->",1369],["T_STRING","_lookupTransaction",1369],"(",["T_VARIABLE","$txnId",1369],")",";",["T_WHITESPACE","\n    ",1369],"}",["T_WHITESPACE","\n\n    ",1370],["T_DOC_COMMENT","\/**\n     * Append transaction ID (if any) message to the specified message\n     *\n     * @param Mage_Sales_Model_Order_Payment_Transaction|null $transaction\n     * @param string $message\n     * @return string\n     *\/",1372],["T_WHITESPACE","\n    ",1378],["T_PROTECTED","protected",1379],["T_WHITESPACE"," ",1379],["T_FUNCTION","function",1379],["T_WHITESPACE"," ",1379],["T_STRING","_appendTransactionToMessage",1379],"(",["T_VARIABLE","$transaction",1379],",",["T_WHITESPACE"," ",1379],["T_VARIABLE","$message",1379],")",["T_WHITESPACE","\n    ",1379],"{",["T_WHITESPACE","\n        ",1380],["T_IF","if",1381],["T_WHITESPACE"," ",1381],"(",["T_VARIABLE","$transaction",1381],")",["T_WHITESPACE"," ",1381],"{",["T_WHITESPACE","\n            ",1381],["T_VARIABLE","$txnId",1382],["T_WHITESPACE"," ",1382],"=",["T_WHITESPACE"," ",1382],["T_STRING","is_object",1382],"(",["T_VARIABLE","$transaction",1382],")",["T_WHITESPACE"," ",1382],"?",["T_WHITESPACE"," ",1382],["T_VARIABLE","$transaction",1382],["T_OBJECT_OPERATOR","->",1382],["T_STRING","getHtmlTxnId",1382],"(",")",["T_WHITESPACE"," ",1382],":",["T_WHITESPACE"," ",1382],["T_VARIABLE","$transaction",1382],";",["T_WHITESPACE","\n            ",1382],["T_VARIABLE","$message",1383],["T_WHITESPACE"," ",1383],["T_CONCAT_EQUAL",".=",1383],["T_WHITESPACE"," ",1383],["T_CONSTANT_ENCAPSED_STRING","' '",1383],["T_WHITESPACE"," ",1383],".",["T_WHITESPACE"," ",1383],["T_STRING","Mage",1383],["T_DOUBLE_COLON","::",1383],["T_STRING","helper",1383],"(",["T_CONSTANT_ENCAPSED_STRING","'sales'",1383],")",["T_OBJECT_OPERATOR","->",1383],["T_STRING","__",1383],"(",["T_CONSTANT_ENCAPSED_STRING","'Transaction ID: \"%s\".'",1383],",",["T_WHITESPACE"," ",1383],["T_VARIABLE","$txnId",1383],")",";",["T_WHITESPACE","\n        ",1383],"}",["T_WHITESPACE","\n        ",1384],["T_RETURN","return",1385],["T_WHITESPACE"," ",1385],["T_VARIABLE","$message",1385],";",["T_WHITESPACE","\n    ",1385],"}",["T_WHITESPACE","\n\n    ",1386],["T_DOC_COMMENT","\/**\n     * Prepend a \"prepared_message\" that may be set to the payment instance before, to the specified message\n     * Prepends value to the specified string or to the comment of specified order status history item instance\n     *\n     * @param string|Mage_Sales_Model_Order_Status_History $messagePrependTo\n     * @return string|Mage_Sales_Model_Order_Status_History\n     *\/",1388],["T_WHITESPACE","\n    ",1394],["T_PROTECTED","protected",1395],["T_WHITESPACE"," ",1395],["T_FUNCTION","function",1395],["T_WHITESPACE"," ",1395],["T_STRING","_prependMessage",1395],"(",["T_VARIABLE","$messagePrependTo",1395],")",["T_WHITESPACE","\n    ",1395],"{",["T_WHITESPACE","\n        ",1396],["T_VARIABLE","$preparedMessage",1397],["T_WHITESPACE"," ",1397],"=",["T_WHITESPACE"," ",1397],["T_VARIABLE","$this",1397],["T_OBJECT_OPERATOR","->",1397],["T_STRING","getPreparedMessage",1397],"(",")",";",["T_WHITESPACE","\n        ",1397],["T_IF","if",1398],["T_WHITESPACE"," ",1398],"(",["T_VARIABLE","$preparedMessage",1398],")",["T_WHITESPACE"," ",1398],"{",["T_WHITESPACE","\n            ",1398],["T_IF","if",1399],["T_WHITESPACE"," ",1399],"(",["T_STRING","is_string",1399],"(",["T_VARIABLE","$preparedMessage",1399],")",")",["T_WHITESPACE"," ",1399],"{",["T_WHITESPACE","\n                ",1399],["T_RETURN","return",1400],["T_WHITESPACE"," ",1400],["T_VARIABLE","$preparedMessage",1400],["T_WHITESPACE"," ",1400],".",["T_WHITESPACE"," ",1400],["T_CONSTANT_ENCAPSED_STRING","' '",1400],["T_WHITESPACE"," ",1400],".",["T_WHITESPACE"," ",1400],["T_VARIABLE","$messagePrependTo",1400],";",["T_WHITESPACE","\n            ",1400],"}",["T_WHITESPACE"," ",1401],["T_ELSEIF","elseif",1401],["T_WHITESPACE"," ",1401],"(",["T_STRING","is_object",1401],"(",["T_VARIABLE","$preparedMessage",1401],")",["T_WHITESPACE","\n                ",1401],["T_BOOLEAN_AND","&&",1402],["T_WHITESPACE"," ",1402],"(",["T_VARIABLE","$preparedMessage",1402],["T_WHITESPACE"," ",1402],["T_INSTANCEOF","instanceof",1402],["T_WHITESPACE"," ",1402],["T_STRING","Mage_Sales_Model_Order_Status_History",1402],")",["T_WHITESPACE","\n            ",1402],")",["T_WHITESPACE"," ",1403],"{",["T_WHITESPACE","\n                ",1403],["T_VARIABLE","$comment",1404],["T_WHITESPACE"," ",1404],"=",["T_WHITESPACE"," ",1404],["T_VARIABLE","$preparedMessage",1404],["T_OBJECT_OPERATOR","->",1404],["T_STRING","getComment",1404],"(",")",["T_WHITESPACE"," ",1404],".",["T_WHITESPACE"," ",1404],["T_CONSTANT_ENCAPSED_STRING","' '",1404],["T_WHITESPACE"," ",1404],".",["T_WHITESPACE"," ",1404],["T_VARIABLE","$messagePrependTo",1404],";",["T_WHITESPACE","\n                ",1404],["T_VARIABLE","$preparedMessage",1405],["T_OBJECT_OPERATOR","->",1405],["T_STRING","setComment",1405],"(",["T_VARIABLE","$comment",1405],")",";",["T_WHITESPACE","\n                ",1405],["T_RETURN","return",1406],["T_WHITESPACE"," ",1406],["T_VARIABLE","$comment",1406],";",["T_WHITESPACE","\n            ",1406],"}",["T_WHITESPACE","\n        ",1407],"}",["T_WHITESPACE","\n        ",1408],["T_RETURN","return",1409],["T_WHITESPACE"," ",1409],["T_VARIABLE","$messagePrependTo",1409],";",["T_WHITESPACE","\n    ",1409],"}",["T_WHITESPACE","\n\n    ",1410],["T_DOC_COMMENT","\/**\n     * Round up and cast specified amount to float or string\n     *\n     * @param string|float $amount\n     * @param bool $asFloat\n     * @return string|float\n     *\/",1412],["T_WHITESPACE","\n    ",1418],["T_PROTECTED","protected",1419],["T_WHITESPACE"," ",1419],["T_FUNCTION","function",1419],["T_WHITESPACE"," ",1419],["T_STRING","_formatAmount",1419],"(",["T_VARIABLE","$amount",1419],",",["T_WHITESPACE"," ",1419],["T_VARIABLE","$asFloat",1419],["T_WHITESPACE"," ",1419],"=",["T_WHITESPACE"," ",1419],["T_STRING","false",1419],")",["T_WHITESPACE","\n    ",1419],"{",["T_WHITESPACE","\n         ",1420],["T_VARIABLE","$amount",1421],["T_WHITESPACE"," ",1421],"=",["T_WHITESPACE"," ",1421],["T_STRING","Mage",1421],["T_DOUBLE_COLON","::",1421],["T_STRING","app",1421],"(",")",["T_OBJECT_OPERATOR","->",1421],["T_STRING","getStore",1421],"(",")",["T_OBJECT_OPERATOR","->",1421],["T_STRING","roundPrice",1421],"(",["T_VARIABLE","$amount",1421],")",";",["T_WHITESPACE","\n         ",1421],["T_RETURN","return",1422],["T_WHITESPACE"," ",1422],"!",["T_VARIABLE","$asFloat",1422],["T_WHITESPACE"," ",1422],"?",["T_WHITESPACE"," ",1422],["T_STRING_CAST","(string)",1422],["T_VARIABLE","$amount",1422],["T_WHITESPACE"," ",1422],":",["T_WHITESPACE"," ",1422],["T_VARIABLE","$amount",1422],";",["T_WHITESPACE","\n    ",1422],"}",["T_WHITESPACE","\n\n    ",1423],["T_DOC_COMMENT","\/**\n     * Format price with currency sign\n     * @param float $amount\n     * @param null|string $currency\n     * @return string\n     *\/",1425],["T_WHITESPACE","\n    ",1430],["T_PROTECTED","protected",1431],["T_WHITESPACE"," ",1431],["T_FUNCTION","function",1431],["T_WHITESPACE"," ",1431],["T_STRING","_formatPrice",1431],"(",["T_VARIABLE","$amount",1431],",",["T_WHITESPACE"," ",1431],["T_VARIABLE","$currency",1431],["T_WHITESPACE"," ",1431],"=",["T_WHITESPACE"," ",1431],["T_STRING","null",1431],")",["T_WHITESPACE","\n    ",1431],"{",["T_WHITESPACE","\n        ",1432],["T_RETURN","return",1433],["T_WHITESPACE"," ",1433],["T_VARIABLE","$this",1433],["T_OBJECT_OPERATOR","->",1433],["T_STRING","getOrder",1433],"(",")",["T_OBJECT_OPERATOR","->",1433],["T_STRING","getBaseCurrency",1433],"(",")",["T_OBJECT_OPERATOR","->",1433],["T_STRING","formatTxt",1433],"(",["T_WHITESPACE","\n            ",1433],["T_VARIABLE","$amount",1434],",",["T_WHITESPACE","\n            ",1434],["T_VARIABLE","$currency",1435],["T_WHITESPACE"," ",1435],"?",["T_WHITESPACE"," ",1435],["T_ARRAY","array",1435],"(",["T_CONSTANT_ENCAPSED_STRING","'currency'",1435],["T_WHITESPACE"," ",1435],["T_DOUBLE_ARROW","=>",1435],["T_WHITESPACE"," ",1435],["T_VARIABLE","$currency",1435],")",["T_WHITESPACE"," ",1435],":",["T_WHITESPACE"," ",1435],["T_ARRAY","array",1435],"(",")",["T_WHITESPACE","\n        ",1435],")",";",["T_WHITESPACE","\n    ",1436],"}",["T_WHITESPACE","\n\n    ",1437],["T_DOC_COMMENT","\/**\n     * Find one transaction by ID or type\n     * @param string $txnId\n     * @param string $txnType\n     * @return Mage_Sales_Model_Order_Payment_Transaction|false\n     *\/",1439],["T_WHITESPACE","\n    ",1444],["T_PROTECTED","protected",1445],["T_WHITESPACE"," ",1445],["T_FUNCTION","function",1445],["T_WHITESPACE"," ",1445],["T_STRING","_lookupTransaction",1445],"(",["T_VARIABLE","$txnId",1445],",",["T_WHITESPACE"," ",1445],["T_VARIABLE","$txnType",1445],["T_WHITESPACE"," ",1445],"=",["T_WHITESPACE"," ",1445],["T_STRING","false",1445],")",["T_WHITESPACE","\n    ",1445],"{",["T_WHITESPACE","\n        ",1446],["T_IF","if",1447],["T_WHITESPACE"," ",1447],"(","!",["T_VARIABLE","$txnId",1447],")",["T_WHITESPACE"," ",1447],"{",["T_WHITESPACE","\n            ",1447],["T_IF","if",1448],["T_WHITESPACE"," ",1448],"(",["T_VARIABLE","$txnType",1448],["T_WHITESPACE"," ",1448],["T_BOOLEAN_AND","&&",1448],["T_WHITESPACE"," ",1448],["T_VARIABLE","$this",1448],["T_OBJECT_OPERATOR","->",1448],["T_STRING","getId",1448],"(",")",")",["T_WHITESPACE"," ",1448],"{",["T_WHITESPACE","\n                ",1448],["T_VARIABLE","$collection",1449],["T_WHITESPACE"," ",1449],"=",["T_WHITESPACE"," ",1449],["T_STRING","Mage",1449],["T_DOUBLE_COLON","::",1449],["T_STRING","getModel",1449],"(",["T_CONSTANT_ENCAPSED_STRING","'sales\/order_payment_transaction'",1449],")",["T_OBJECT_OPERATOR","->",1449],["T_STRING","getCollection",1449],"(",")",["T_WHITESPACE","\n                    ",1449],["T_OBJECT_OPERATOR","->",1450],["T_STRING","setOrderFilter",1450],"(",["T_VARIABLE","$this",1450],["T_OBJECT_OPERATOR","->",1450],["T_STRING","getOrder",1450],"(",")",")",["T_WHITESPACE","\n                    ",1450],["T_OBJECT_OPERATOR","->",1451],["T_STRING","addPaymentIdFilter",1451],"(",["T_VARIABLE","$this",1451],["T_OBJECT_OPERATOR","->",1451],["T_STRING","getId",1451],"(",")",")",["T_WHITESPACE","\n                    ",1451],["T_OBJECT_OPERATOR","->",1452],["T_STRING","addTxnTypeFilter",1452],"(",["T_VARIABLE","$txnType",1452],")",["T_WHITESPACE","\n                    ",1452],["T_OBJECT_OPERATOR","->",1453],["T_STRING","setOrder",1453],"(",["T_CONSTANT_ENCAPSED_STRING","'created_at'",1453],",",["T_WHITESPACE"," ",1453],["T_STRING","Varien_Data_Collection",1453],["T_DOUBLE_COLON","::",1453],["T_STRING","SORT_ORDER_DESC",1453],")",["T_WHITESPACE","\n                    ",1453],["T_OBJECT_OPERATOR","->",1454],["T_STRING","setOrder",1454],"(",["T_CONSTANT_ENCAPSED_STRING","'transaction_id'",1454],",",["T_WHITESPACE"," ",1454],["T_STRING","Varien_Data_Collection",1454],["T_DOUBLE_COLON","::",1454],["T_STRING","SORT_ORDER_DESC",1454],")",";",["T_WHITESPACE","\n                ",1454],["T_FOREACH","foreach",1455],["T_WHITESPACE"," ",1455],"(",["T_VARIABLE","$collection",1455],["T_WHITESPACE"," ",1455],["T_AS","as",1455],["T_WHITESPACE"," ",1455],["T_VARIABLE","$txn",1455],")",["T_WHITESPACE"," ",1455],"{",["T_WHITESPACE","\n                    ",1455],["T_VARIABLE","$txn",1456],["T_OBJECT_OPERATOR","->",1456],["T_STRING","setOrderPaymentObject",1456],"(",["T_VARIABLE","$this",1456],")",";",["T_WHITESPACE","\n                    ",1456],["T_VARIABLE","$this",1457],["T_OBJECT_OPERATOR","->",1457],["T_STRING","_transactionsLookup",1457],"[",["T_VARIABLE","$txn",1457],["T_OBJECT_OPERATOR","->",1457],["T_STRING","getTxnId",1457],"(",")","]",["T_WHITESPACE"," ",1457],"=",["T_WHITESPACE"," ",1457],["T_VARIABLE","$txn",1457],";",["T_WHITESPACE","\n                    ",1457],["T_RETURN","return",1458],["T_WHITESPACE"," ",1458],["T_VARIABLE","$txn",1458],";",["T_WHITESPACE","\n                ",1458],"}",["T_WHITESPACE","\n            ",1459],"}",["T_WHITESPACE","\n            ",1460],["T_RETURN","return",1461],["T_WHITESPACE"," ",1461],["T_STRING","false",1461],";",["T_WHITESPACE","\n        ",1461],"}",["T_WHITESPACE","\n        ",1462],["T_IF","if",1463],["T_WHITESPACE"," ",1463],"(",["T_ISSET","isset",1463],"(",["T_VARIABLE","$this",1463],["T_OBJECT_OPERATOR","->",1463],["T_STRING","_transactionsLookup",1463],"[",["T_VARIABLE","$txnId",1463],"]",")",")",["T_WHITESPACE"," ",1463],"{",["T_WHITESPACE","\n            ",1463],["T_RETURN","return",1464],["T_WHITESPACE"," ",1464],["T_VARIABLE","$this",1464],["T_OBJECT_OPERATOR","->",1464],["T_STRING","_transactionsLookup",1464],"[",["T_VARIABLE","$txnId",1464],"]",";",["T_WHITESPACE","\n        ",1464],"}",["T_WHITESPACE","\n        ",1465],["T_VARIABLE","$txn",1466],["T_WHITESPACE"," ",1466],"=",["T_WHITESPACE"," ",1466],["T_STRING","Mage",1466],["T_DOUBLE_COLON","::",1466],["T_STRING","getModel",1466],"(",["T_CONSTANT_ENCAPSED_STRING","'sales\/order_payment_transaction'",1466],")",["T_WHITESPACE","\n            ",1466],["T_OBJECT_OPERATOR","->",1467],["T_STRING","setOrderPaymentObject",1467],"(",["T_VARIABLE","$this",1467],")",["T_WHITESPACE","\n            ",1467],["T_OBJECT_OPERATOR","->",1468],["T_STRING","loadByTxnId",1468],"(",["T_VARIABLE","$txnId",1468],")",";",["T_WHITESPACE","\n        ",1468],["T_IF","if",1469],["T_WHITESPACE"," ",1469],"(",["T_VARIABLE","$txn",1469],["T_OBJECT_OPERATOR","->",1469],["T_STRING","getId",1469],"(",")",")",["T_WHITESPACE"," ",1469],"{",["T_WHITESPACE","\n            ",1469],["T_VARIABLE","$this",1470],["T_OBJECT_OPERATOR","->",1470],["T_STRING","_transactionsLookup",1470],"[",["T_VARIABLE","$txnId",1470],"]",["T_WHITESPACE"," ",1470],"=",["T_WHITESPACE"," ",1470],["T_VARIABLE","$txn",1470],";",["T_WHITESPACE","\n        ",1470],"}",["T_WHITESPACE"," ",1471],["T_ELSE","else",1471],["T_WHITESPACE"," ",1471],"{",["T_WHITESPACE","\n            ",1471],["T_VARIABLE","$this",1472],["T_OBJECT_OPERATOR","->",1472],["T_STRING","_transactionsLookup",1472],"[",["T_VARIABLE","$txnId",1472],"]",["T_WHITESPACE"," ",1472],"=",["T_WHITESPACE"," ",1472],["T_STRING","false",1472],";",["T_WHITESPACE","\n        ",1472],"}",["T_WHITESPACE","\n        ",1473],["T_RETURN","return",1474],["T_WHITESPACE"," ",1474],["T_VARIABLE","$this",1474],["T_OBJECT_OPERATOR","->",1474],["T_STRING","_transactionsLookup",1474],"[",["T_VARIABLE","$txnId",1474],"]",";",["T_WHITESPACE","\n    ",1474],"}",["T_WHITESPACE","\n\n    ",1475],["T_DOC_COMMENT","\/**\n     * Find one transaction by ID or type\n     * @param string $txnId\n     * @param string $txnType\n     * @return Mage_Sales_Model_Order_Payment_Transaction|false\n     *\/",1477],["T_WHITESPACE","\n    ",1482],["T_PUBLIC","public",1483],["T_WHITESPACE"," ",1483],["T_FUNCTION","function",1483],["T_WHITESPACE"," ",1483],["T_STRING","lookupTransaction",1483],"(",["T_VARIABLE","$txnId",1483],",",["T_WHITESPACE"," ",1483],["T_VARIABLE","$txnType",1483],["T_WHITESPACE"," ",1483],"=",["T_WHITESPACE"," ",1483],["T_STRING","false",1483],")",["T_WHITESPACE","\n    ",1483],"{",["T_WHITESPACE","\n        ",1484],["T_RETURN","return",1485],["T_WHITESPACE"," ",1485],["T_VARIABLE","$this",1485],["T_OBJECT_OPERATOR","->",1485],["T_STRING","_lookupTransaction",1485],"(",["T_VARIABLE","$txnId",1485],",",["T_WHITESPACE"," ",1485],["T_VARIABLE","$txnType",1485],")",";",["T_WHITESPACE","\n    ",1485],"}",["T_WHITESPACE","\n\n    ",1486],["T_DOC_COMMENT","\/**\n     * Lookup an authorization transaction using parent transaction id, if set\n     * @return Mage_Sales_Model_Order_Payment_Transaction|false\n     *\/",1488],["T_WHITESPACE","\n    ",1491],["T_PUBLIC","public",1492],["T_WHITESPACE"," ",1492],["T_FUNCTION","function",1492],["T_WHITESPACE"," ",1492],["T_STRING","getAuthorizationTransaction",1492],"(",")",["T_WHITESPACE","\n    ",1492],"{",["T_WHITESPACE","\n        ",1493],["T_IF","if",1494],["T_WHITESPACE"," ",1494],"(",["T_VARIABLE","$this",1494],["T_OBJECT_OPERATOR","->",1494],["T_STRING","getParentTransactionId",1494],"(",")",")",["T_WHITESPACE"," ",1494],"{",["T_WHITESPACE","\n            ",1494],["T_VARIABLE","$txn",1495],["T_WHITESPACE"," ",1495],"=",["T_WHITESPACE"," ",1495],["T_VARIABLE","$this",1495],["T_OBJECT_OPERATOR","->",1495],["T_STRING","_lookupTransaction",1495],"(",["T_VARIABLE","$this",1495],["T_OBJECT_OPERATOR","->",1495],["T_STRING","getParentTransactionId",1495],"(",")",")",";",["T_WHITESPACE","\n        ",1495],"}",["T_WHITESPACE"," ",1496],["T_ELSE","else",1496],["T_WHITESPACE"," ",1496],"{",["T_WHITESPACE","\n            ",1496],["T_VARIABLE","$txn",1497],["T_WHITESPACE"," ",1497],"=",["T_WHITESPACE"," ",1497],["T_STRING","false",1497],";",["T_WHITESPACE","\n        ",1497],"}",["T_WHITESPACE","\n\n        ",1498],["T_IF","if",1500],["T_WHITESPACE"," ",1500],"(","!",["T_VARIABLE","$txn",1500],")",["T_WHITESPACE"," ",1500],"{",["T_WHITESPACE","\n            ",1500],["T_VARIABLE","$txn",1501],["T_WHITESPACE"," ",1501],"=",["T_WHITESPACE"," ",1501],["T_VARIABLE","$this",1501],["T_OBJECT_OPERATOR","->",1501],["T_STRING","_lookupTransaction",1501],"(",["T_STRING","false",1501],",",["T_WHITESPACE"," ",1501],["T_STRING","Mage_Sales_Model_Order_Payment_Transaction",1501],["T_DOUBLE_COLON","::",1501],["T_STRING","TYPE_AUTH",1501],")",";",["T_WHITESPACE","\n        ",1501],"}",["T_WHITESPACE","\n        ",1502],["T_RETURN","return",1503],["T_WHITESPACE"," ",1503],["T_VARIABLE","$txn",1503],";",["T_WHITESPACE","\n    ",1503],"}",["T_WHITESPACE","\n\n    ",1504],["T_DOC_COMMENT","\/**\n     * Lookup the transaction by id\n     * @param string $transactionId\n     * @return Mage_Sales_Model_Order_Payment_Transaction|false\n     *\/",1506],["T_WHITESPACE","\n    ",1510],["T_PUBLIC","public",1511],["T_WHITESPACE"," ",1511],["T_FUNCTION","function",1511],["T_WHITESPACE"," ",1511],["T_STRING","getTransaction",1511],"(",["T_VARIABLE","$transactionId",1511],")",["T_WHITESPACE","\n    ",1511],"{",["T_WHITESPACE","\n        ",1512],["T_RETURN","return",1513],["T_WHITESPACE"," ",1513],["T_VARIABLE","$this",1513],["T_OBJECT_OPERATOR","->",1513],["T_STRING","_lookupTransaction",1513],"(",["T_VARIABLE","$transactionId",1513],")",";",["T_WHITESPACE","\n    ",1513],"}",["T_WHITESPACE","\n\n    ",1514],["T_DOC_COMMENT","\/**\n     * Update transaction ids for further processing\n     * If no transactions were set before invoking, may generate an \"offline\" transaction id\n     *\n     * @param string $type\n     * @param Mage_Sales_Model_Order_Payment_Transaction $transactionBasedOn\n     *\/",1516],["T_WHITESPACE","\n    ",1522],["T_PROTECTED","protected",1523],["T_WHITESPACE"," ",1523],["T_FUNCTION","function",1523],["T_WHITESPACE"," ",1523],["T_STRING","_generateTransactionId",1523],"(",["T_VARIABLE","$type",1523],",",["T_WHITESPACE"," ",1523],["T_VARIABLE","$transactionBasedOn",1523],["T_WHITESPACE"," ",1523],"=",["T_WHITESPACE"," ",1523],["T_STRING","false",1523],")",["T_WHITESPACE","\n    ",1523],"{",["T_WHITESPACE","\n        ",1524],["T_IF","if",1525],["T_WHITESPACE"," ",1525],"(","!",["T_VARIABLE","$this",1525],["T_OBJECT_OPERATOR","->",1525],["T_STRING","getParentTransactionId",1525],"(",")",["T_WHITESPACE"," ",1525],["T_BOOLEAN_AND","&&",1525],["T_WHITESPACE"," ",1525],"!",["T_VARIABLE","$this",1525],["T_OBJECT_OPERATOR","->",1525],["T_STRING","getTransactionId",1525],"(",")",["T_WHITESPACE"," ",1525],["T_BOOLEAN_AND","&&",1525],["T_WHITESPACE"," ",1525],["T_VARIABLE","$transactionBasedOn",1525],")",["T_WHITESPACE"," ",1525],"{",["T_WHITESPACE","\n            ",1525],["T_VARIABLE","$this",1526],["T_OBJECT_OPERATOR","->",1526],["T_STRING","setParentTransactionId",1526],"(",["T_VARIABLE","$transactionBasedOn",1526],["T_OBJECT_OPERATOR","->",1526],["T_STRING","getTxnId",1526],"(",")",")",";",["T_WHITESPACE","\n        ",1526],"}",["T_WHITESPACE","\n        ",1527],["T_COMMENT","\/\/ generate transaction id for an offline action or payment method that didn't set it\n",1528],["T_WHITESPACE","        ",1529],["T_VARIABLE","$parentTxnId",1529],["T_WHITESPACE"," ",1529],"=",["T_WHITESPACE"," ",1529],["T_VARIABLE","$this",1529],["T_OBJECT_OPERATOR","->",1529],["T_STRING","getParentTransactionId",1529],"(",")",";",["T_WHITESPACE","\n        ",1529],["T_IF","if",1530],["T_WHITESPACE"," ",1530],"(",["T_VARIABLE","$parentTxnId",1530],["T_WHITESPACE"," ",1530],["T_BOOLEAN_AND","&&",1530],["T_WHITESPACE"," ",1530],"!",["T_VARIABLE","$this",1530],["T_OBJECT_OPERATOR","->",1530],["T_STRING","getTransactionId",1530],"(",")",")",["T_WHITESPACE"," ",1530],"{",["T_WHITESPACE","\n            ",1530],["T_VARIABLE","$this",1531],["T_OBJECT_OPERATOR","->",1531],["T_STRING","setTransactionId",1531],"(","\"",["T_CURLY_OPEN","{",1531],["T_VARIABLE","$parentTxnId",1531],"}",["T_ENCAPSED_AND_WHITESPACE","-",1531],["T_CURLY_OPEN","{",1531],["T_VARIABLE","$type",1531],"}","\"",")",";",["T_WHITESPACE","\n        ",1531],"}",["T_WHITESPACE","\n    ",1532],"}",["T_WHITESPACE","\n\n    ",1533],["T_DOC_COMMENT","\/**\n     * Decide whether authorization transaction may close (if the amount to capture will cover entire order)\n     * @param float $amountToCapture\n     * @return bool\n     *\/",1535],["T_WHITESPACE","\n    ",1539],["T_PROTECTED","protected",1540],["T_WHITESPACE"," ",1540],["T_FUNCTION","function",1540],["T_WHITESPACE"," ",1540],["T_STRING","_isCaptureFinal",1540],"(",["T_VARIABLE","$amountToCapture",1540],")",["T_WHITESPACE","\n    ",1540],"{",["T_WHITESPACE","\n        ",1541],["T_VARIABLE","$amountToCapture",1542],["T_WHITESPACE"," ",1542],"=",["T_WHITESPACE"," ",1542],["T_VARIABLE","$this",1542],["T_OBJECT_OPERATOR","->",1542],["T_STRING","_formatAmount",1542],"(",["T_VARIABLE","$amountToCapture",1542],",",["T_WHITESPACE"," ",1542],["T_STRING","true",1542],")",";",["T_WHITESPACE","\n        ",1542],["T_VARIABLE","$orderGrandTotal",1543],["T_WHITESPACE"," ",1543],"=",["T_WHITESPACE"," ",1543],["T_VARIABLE","$this",1543],["T_OBJECT_OPERATOR","->",1543],["T_STRING","_formatAmount",1543],"(",["T_VARIABLE","$this",1543],["T_OBJECT_OPERATOR","->",1543],["T_STRING","getOrder",1543],"(",")",["T_OBJECT_OPERATOR","->",1543],["T_STRING","getBaseGrandTotal",1543],"(",")",",",["T_WHITESPACE"," ",1543],["T_STRING","true",1543],")",";",["T_WHITESPACE","\n        ",1543],["T_IF","if",1544],["T_WHITESPACE"," ",1544],"(",["T_VARIABLE","$orderGrandTotal",1544],["T_WHITESPACE"," ",1544],["T_IS_EQUAL","==",1544],["T_WHITESPACE"," ",1544],["T_VARIABLE","$this",1544],["T_OBJECT_OPERATOR","->",1544],["T_STRING","_formatAmount",1544],"(",["T_VARIABLE","$this",1544],["T_OBJECT_OPERATOR","->",1544],["T_STRING","getBaseAmountPaid",1544],"(",")",",",["T_WHITESPACE"," ",1544],["T_STRING","true",1544],")",["T_WHITESPACE"," ",1544],"+",["T_WHITESPACE"," ",1544],["T_VARIABLE","$amountToCapture",1544],")",["T_WHITESPACE"," ",1544],"{",["T_WHITESPACE","\n            ",1544],["T_IF","if",1545],["T_WHITESPACE"," ",1545],"(",["T_STRING","false",1545],["T_WHITESPACE"," ",1545],["T_IS_NOT_IDENTICAL","!==",1545],["T_WHITESPACE"," ",1545],["T_VARIABLE","$this",1545],["T_OBJECT_OPERATOR","->",1545],["T_STRING","getShouldCloseParentTransaction",1545],"(",")",")",["T_WHITESPACE"," ",1545],"{",["T_WHITESPACE","\n                ",1545],["T_VARIABLE","$this",1546],["T_OBJECT_OPERATOR","->",1546],["T_STRING","setShouldCloseParentTransaction",1546],"(",["T_STRING","true",1546],")",";",["T_WHITESPACE","\n            ",1546],"}",["T_WHITESPACE","\n            ",1547],["T_RETURN","return",1548],["T_WHITESPACE"," ",1548],["T_STRING","true",1548],";",["T_WHITESPACE","\n        ",1548],"}",["T_WHITESPACE","\n        ",1549],["T_RETURN","return",1550],["T_WHITESPACE"," ",1550],["T_STRING","false",1550],";",["T_WHITESPACE","\n    ",1550],"}",["T_WHITESPACE","\n\n    ",1551],["T_DOC_COMMENT","\/**\n     * Check whether payment currency corresponds to order currency\n     *\n     * @return bool\n     *\/",1553],["T_WHITESPACE","\n    ",1557],["T_PROTECTED","protected",1558],["T_WHITESPACE"," ",1558],["T_FUNCTION","function",1558],["T_WHITESPACE"," ",1558],["T_STRING","_isSameCurrency",1558],"(",")",["T_WHITESPACE","\n    ",1558],"{",["T_WHITESPACE","\n        ",1559],["T_RETURN","return",1560],["T_WHITESPACE"," ",1560],"!",["T_VARIABLE","$this",1560],["T_OBJECT_OPERATOR","->",1560],["T_STRING","getCurrencyCode",1560],"(",")",["T_WHITESPACE"," ",1560],["T_BOOLEAN_OR","||",1560],["T_WHITESPACE"," ",1560],["T_VARIABLE","$this",1560],["T_OBJECT_OPERATOR","->",1560],["T_STRING","getCurrencyCode",1560],"(",")",["T_WHITESPACE"," ",1560],["T_IS_EQUAL","==",1560],["T_WHITESPACE"," ",1560],["T_VARIABLE","$this",1560],["T_OBJECT_OPERATOR","->",1560],["T_STRING","getOrder",1560],"(",")",["T_OBJECT_OPERATOR","->",1560],["T_STRING","getBaseCurrencyCode",1560],"(",")",";",["T_WHITESPACE","\n    ",1560],"}",["T_WHITESPACE","\n\n    ",1561],["T_DOC_COMMENT","\/**\n     * Before object save manipulations\n     *\n     * @return Mage_Sales_Model_Order_Payment\n     *\/",1563],["T_WHITESPACE","\n    ",1567],["T_PROTECTED","protected",1568],["T_WHITESPACE"," ",1568],["T_FUNCTION","function",1568],["T_WHITESPACE"," ",1568],["T_STRING","_beforeSave",1568],"(",")",["T_WHITESPACE","\n    ",1568],"{",["T_WHITESPACE","\n        ",1569],["T_STRING","parent",1570],["T_DOUBLE_COLON","::",1570],["T_STRING","_beforeSave",1570],"(",")",";",["T_WHITESPACE","\n\n        ",1570],["T_IF","if",1572],["T_WHITESPACE"," ",1572],"(","!",["T_VARIABLE","$this",1572],["T_OBJECT_OPERATOR","->",1572],["T_STRING","getParentId",1572],"(",")",["T_WHITESPACE"," ",1572],["T_BOOLEAN_AND","&&",1572],["T_WHITESPACE"," ",1572],["T_VARIABLE","$this",1572],["T_OBJECT_OPERATOR","->",1572],["T_STRING","getOrder",1572],"(",")",")",["T_WHITESPACE"," ",1572],"{",["T_WHITESPACE","\n            ",1572],["T_VARIABLE","$this",1573],["T_OBJECT_OPERATOR","->",1573],["T_STRING","setParentId",1573],"(",["T_VARIABLE","$this",1573],["T_OBJECT_OPERATOR","->",1573],["T_STRING","getOrder",1573],"(",")",["T_OBJECT_OPERATOR","->",1573],["T_STRING","getId",1573],"(",")",")",";",["T_WHITESPACE","\n        ",1573],"}",["T_WHITESPACE","\n\n        ",1574],["T_RETURN","return",1576],["T_WHITESPACE"," ",1576],["T_VARIABLE","$this",1576],";",["T_WHITESPACE","\n    ",1576],"}",["T_WHITESPACE","\n\n    ",1577],["T_DOC_COMMENT","\/**\n     * Generate billing agreement object if there is billing agreement data\n     * Adds it to order as related object\n     *\/",1579],["T_WHITESPACE","\n    ",1582],["T_PROTECTED","protected",1583],["T_WHITESPACE"," ",1583],["T_FUNCTION","function",1583],["T_WHITESPACE"," ",1583],["T_STRING","_createBillingAgreement",1583],"(",")",["T_WHITESPACE","\n    ",1583],"{",["T_WHITESPACE","\n        ",1584],["T_IF","if",1585],["T_WHITESPACE"," ",1585],"(",["T_VARIABLE","$this",1585],["T_OBJECT_OPERATOR","->",1585],["T_STRING","getBillingAgreementData",1585],"(",")",")",["T_WHITESPACE"," ",1585],"{",["T_WHITESPACE","\n            ",1585],["T_VARIABLE","$order",1586],["T_WHITESPACE"," ",1586],"=",["T_WHITESPACE"," ",1586],["T_VARIABLE","$this",1586],["T_OBJECT_OPERATOR","->",1586],["T_STRING","getOrder",1586],"(",")",";",["T_WHITESPACE","\n            ",1586],["T_VARIABLE","$agreement",1587],["T_WHITESPACE"," ",1587],"=",["T_WHITESPACE"," ",1587],["T_STRING","Mage",1587],["T_DOUBLE_COLON","::",1587],["T_STRING","getModel",1587],"(",["T_CONSTANT_ENCAPSED_STRING","'sales\/billing_agreement'",1587],")",["T_OBJECT_OPERATOR","->",1587],["T_STRING","importOrderPayment",1587],"(",["T_VARIABLE","$this",1587],")",";",["T_WHITESPACE","\n            ",1587],["T_IF","if",1588],["T_WHITESPACE"," ",1588],"(",["T_VARIABLE","$agreement",1588],["T_OBJECT_OPERATOR","->",1588],["T_STRING","isValid",1588],"(",")",")",["T_WHITESPACE"," ",1588],"{",["T_WHITESPACE","\n                ",1588],["T_VARIABLE","$message",1589],["T_WHITESPACE"," ",1589],"=",["T_WHITESPACE"," ",1589],["T_STRING","Mage",1589],["T_DOUBLE_COLON","::",1589],["T_STRING","helper",1589],"(",["T_CONSTANT_ENCAPSED_STRING","'sales'",1589],")",["T_OBJECT_OPERATOR","->",1589],["T_STRING","__",1589],"(",["T_CONSTANT_ENCAPSED_STRING","'Created billing agreement #%s.'",1589],",",["T_WHITESPACE"," ",1589],["T_VARIABLE","$agreement",1589],["T_OBJECT_OPERATOR","->",1589],["T_STRING","getReferenceId",1589],"(",")",")",";",["T_WHITESPACE","\n                ",1589],["T_VARIABLE","$order",1590],["T_OBJECT_OPERATOR","->",1590],["T_STRING","addRelatedObject",1590],"(",["T_VARIABLE","$agreement",1590],")",";",["T_WHITESPACE","\n                ",1590],["T_VARIABLE","$this",1591],["T_OBJECT_OPERATOR","->",1591],["T_STRING","_billingAgreement",1591],["T_WHITESPACE"," ",1591],"=",["T_WHITESPACE"," ",1591],["T_VARIABLE","$agreement",1591],";",["T_WHITESPACE","\n            ",1591],"}",["T_WHITESPACE"," ",1592],["T_ELSE","else",1592],["T_WHITESPACE"," ",1592],"{",["T_WHITESPACE","\n                ",1592],["T_VARIABLE","$message",1593],["T_WHITESPACE"," ",1593],"=",["T_WHITESPACE"," ",1593],["T_STRING","Mage",1593],["T_DOUBLE_COLON","::",1593],["T_STRING","helper",1593],"(",["T_CONSTANT_ENCAPSED_STRING","'sales'",1593],")",["T_OBJECT_OPERATOR","->",1593],["T_STRING","__",1593],"(",["T_CONSTANT_ENCAPSED_STRING","'Failed to create billing agreement for this order.'",1593],")",";",["T_WHITESPACE","\n            ",1593],"}",["T_WHITESPACE","\n            ",1594],["T_VARIABLE","$comment",1595],["T_WHITESPACE"," ",1595],"=",["T_WHITESPACE"," ",1595],["T_VARIABLE","$order",1595],["T_OBJECT_OPERATOR","->",1595],["T_STRING","addStatusHistoryComment",1595],"(",["T_VARIABLE","$message",1595],")",";",["T_WHITESPACE","\n            ",1595],["T_VARIABLE","$order",1596],["T_OBJECT_OPERATOR","->",1596],["T_STRING","addRelatedObject",1596],"(",["T_VARIABLE","$comment",1596],")",";",["T_WHITESPACE","\n        ",1596],"}",["T_WHITESPACE","\n    ",1597],"}",["T_WHITESPACE","\n\n    ",1598],["T_DOC_COMMENT","\/**\n     * Additionnal transaction info setter\n     *\n     * @param sting $key\n     * @param string $value\n     *\/",1600],["T_WHITESPACE","\n    ",1605],["T_PUBLIC","public",1606],["T_WHITESPACE"," ",1606],["T_FUNCTION","function",1606],["T_WHITESPACE"," ",1606],["T_STRING","setTransactionAdditionalInfo",1606],"(",["T_VARIABLE","$key",1606],",",["T_WHITESPACE"," ",1606],["T_VARIABLE","$value",1606],")",["T_WHITESPACE","\n    ",1606],"{",["T_WHITESPACE","\n        ",1607],["T_IF","if",1608],["T_WHITESPACE"," ",1608],"(",["T_STRING","is_array",1608],"(",["T_VARIABLE","$key",1608],")",")",["T_WHITESPACE"," ",1608],"{",["T_WHITESPACE","\n            ",1608],["T_VARIABLE","$this",1609],["T_OBJECT_OPERATOR","->",1609],["T_STRING","_transactionAdditionalInfo",1609],["T_WHITESPACE"," ",1609],"=",["T_WHITESPACE"," ",1609],["T_VARIABLE","$key",1609],";",["T_WHITESPACE","\n        ",1609],"}",["T_WHITESPACE"," ",1610],["T_ELSE","else",1610],["T_WHITESPACE"," ",1610],"{",["T_WHITESPACE","\n            ",1610],["T_VARIABLE","$this",1611],["T_OBJECT_OPERATOR","->",1611],["T_STRING","_transactionAdditionalInfo",1611],"[",["T_VARIABLE","$key",1611],"]",["T_WHITESPACE"," ",1611],"=",["T_WHITESPACE"," ",1611],["T_VARIABLE","$value",1611],";",["T_WHITESPACE","\n        ",1611],"}",["T_WHITESPACE","\n    ",1612],"}",["T_WHITESPACE","\n\n    ",1613],["T_DOC_COMMENT","\/**\n     * Additionnal transaction info getter\n     *\n     * @param sting $key\n     * @return mixed\n     *\/",1615],["T_WHITESPACE","\n    ",1620],["T_PUBLIC","public",1621],["T_WHITESPACE"," ",1621],["T_FUNCTION","function",1621],["T_WHITESPACE"," ",1621],["T_STRING","getTransactionAdditionalInfo",1621],"(",["T_VARIABLE","$key",1621],["T_WHITESPACE"," ",1621],"=",["T_WHITESPACE"," ",1621],["T_STRING","null",1621],")",["T_WHITESPACE","\n    ",1621],"{",["T_WHITESPACE","\n        ",1622],["T_IF","if",1623],["T_WHITESPACE"," ",1623],"(",["T_STRING","is_null",1623],"(",["T_VARIABLE","$key",1623],")",")",["T_WHITESPACE"," ",1623],"{",["T_WHITESPACE","\n            ",1623],["T_RETURN","return",1624],["T_WHITESPACE"," ",1624],["T_VARIABLE","$this",1624],["T_OBJECT_OPERATOR","->",1624],["T_STRING","_transactionAdditionalInfo",1624],";",["T_WHITESPACE","\n        ",1624],"}",["T_WHITESPACE","\n        ",1625],["T_RETURN","return",1626],["T_WHITESPACE"," ",1626],["T_ISSET","isset",1626],"(",["T_VARIABLE","$this",1626],["T_OBJECT_OPERATOR","->",1626],["T_STRING","_transactionAdditionalInfo",1626],"[",["T_VARIABLE","$key",1626],"]",")",["T_WHITESPACE"," ",1626],"?",["T_WHITESPACE"," ",1626],["T_VARIABLE","$this",1626],["T_OBJECT_OPERATOR","->",1626],["T_STRING","_transactionAdditionalInfo",1626],"[",["T_VARIABLE","$key",1626],"]",["T_WHITESPACE"," ",1626],":",["T_WHITESPACE"," ",1626],["T_STRING","null",1626],";",["T_WHITESPACE","\n    ",1626],"}",["T_WHITESPACE","\n\n    ",1627],["T_DOC_COMMENT","\/**\n     * Reset transaction additional info property\n     *\n     * @return Mage_Sales_Model_Order_Payment\n     *\/",1629],["T_WHITESPACE","\n    ",1633],["T_PUBLIC","public",1634],["T_WHITESPACE"," ",1634],["T_FUNCTION","function",1634],["T_WHITESPACE"," ",1634],["T_STRING","resetTransactionAdditionalInfo",1634],"(",")",["T_WHITESPACE","\n    ",1634],"{",["T_WHITESPACE","\n        ",1635],["T_VARIABLE","$this",1636],["T_OBJECT_OPERATOR","->",1636],["T_STRING","_transactionAdditionalInfo",1636],["T_WHITESPACE"," ",1636],"=",["T_WHITESPACE"," ",1636],["T_ARRAY","array",1636],"(",")",";",["T_WHITESPACE","\n        ",1636],["T_RETURN","return",1637],["T_WHITESPACE"," ",1637],["T_VARIABLE","$this",1637],";",["T_WHITESPACE","\n    ",1637],"}",["T_WHITESPACE","\n\n    ",1638],["T_DOC_COMMENT","\/**\n     * Return invoice model for transaction\n     *\n     * @param string $transactionId\n     * @return Mage_Sales_Model_Order_Invoice\n     *\/",1640],["T_WHITESPACE","\n    ",1645],["T_PROTECTED","protected",1646],["T_WHITESPACE"," ",1646],["T_FUNCTION","function",1646],["T_WHITESPACE"," ",1646],["T_STRING","_getInvoiceForTransactionId",1646],"(",["T_VARIABLE","$transactionId",1646],")",["T_WHITESPACE","\n    ",1646],"{",["T_WHITESPACE","\n        ",1647],["T_FOREACH","foreach",1648],["T_WHITESPACE"," ",1648],"(",["T_VARIABLE","$this",1648],["T_OBJECT_OPERATOR","->",1648],["T_STRING","getOrder",1648],"(",")",["T_OBJECT_OPERATOR","->",1648],["T_STRING","getInvoiceCollection",1648],"(",")",["T_WHITESPACE"," ",1648],["T_AS","as",1648],["T_WHITESPACE"," ",1648],["T_VARIABLE","$invoice",1648],")",["T_WHITESPACE"," ",1648],"{",["T_WHITESPACE","\n            ",1648],["T_IF","if",1649],["T_WHITESPACE"," ",1649],"(",["T_VARIABLE","$invoice",1649],["T_OBJECT_OPERATOR","->",1649],["T_STRING","getTransactionId",1649],"(",")",["T_WHITESPACE"," ",1649],["T_IS_EQUAL","==",1649],["T_WHITESPACE"," ",1649],["T_VARIABLE","$transactionId",1649],")",["T_WHITESPACE"," ",1649],"{",["T_WHITESPACE","\n                ",1649],["T_VARIABLE","$invoice",1650],["T_OBJECT_OPERATOR","->",1650],["T_STRING","load",1650],"(",["T_VARIABLE","$invoice",1650],["T_OBJECT_OPERATOR","->",1650],["T_STRING","getId",1650],"(",")",")",";",["T_WHITESPACE"," ",1650],["T_COMMENT","\/\/ to make sure all data will properly load (maybe not required)\n",1650],["T_WHITESPACE","                ",1651],["T_RETURN","return",1651],["T_WHITESPACE"," ",1651],["T_VARIABLE","$invoice",1651],";",["T_WHITESPACE","\n            ",1651],"}",["T_WHITESPACE","\n        ",1652],"}",["T_WHITESPACE","\n        ",1653],["T_FOREACH","foreach",1654],["T_WHITESPACE"," ",1654],"(",["T_VARIABLE","$this",1654],["T_OBJECT_OPERATOR","->",1654],["T_STRING","getOrder",1654],"(",")",["T_OBJECT_OPERATOR","->",1654],["T_STRING","getInvoiceCollection",1654],"(",")",["T_WHITESPACE"," ",1654],["T_AS","as",1654],["T_WHITESPACE"," ",1654],["T_VARIABLE","$invoice",1654],")",["T_WHITESPACE"," ",1654],"{",["T_WHITESPACE","\n            ",1654],["T_IF","if",1655],["T_WHITESPACE"," ",1655],"(",["T_VARIABLE","$invoice",1655],["T_OBJECT_OPERATOR","->",1655],["T_STRING","getState",1655],"(",")",["T_WHITESPACE"," ",1655],["T_IS_EQUAL","==",1655],["T_WHITESPACE"," ",1655],["T_STRING","Mage_Sales_Model_Order_Invoice",1655],["T_DOUBLE_COLON","::",1655],["T_STRING","STATE_OPEN",1655],["T_WHITESPACE","\n                ",1655],["T_BOOLEAN_AND","&&",1656],["T_WHITESPACE"," ",1656],["T_VARIABLE","$invoice",1656],["T_OBJECT_OPERATOR","->",1656],["T_STRING","load",1656],"(",["T_VARIABLE","$invoice",1656],["T_OBJECT_OPERATOR","->",1656],["T_STRING","getId",1656],"(",")",")",["T_WHITESPACE","\n            ",1656],")",["T_WHITESPACE"," ",1657],"{",["T_WHITESPACE","\n                ",1657],["T_VARIABLE","$invoice",1658],["T_OBJECT_OPERATOR","->",1658],["T_STRING","setTransactionId",1658],"(",["T_VARIABLE","$transactionId",1658],")",";",["T_WHITESPACE","\n                ",1658],["T_RETURN","return",1659],["T_WHITESPACE"," ",1659],["T_VARIABLE","$invoice",1659],";",["T_WHITESPACE","\n            ",1659],"}",["T_WHITESPACE","\n        ",1660],"}",["T_WHITESPACE","\n        ",1661],["T_RETURN","return",1662],["T_WHITESPACE"," ",1662],["T_STRING","false",1662],";",["T_WHITESPACE","\n    ",1662],"}",["T_WHITESPACE","\n",1663],"}",["T_WHITESPACE","\n",1664]]