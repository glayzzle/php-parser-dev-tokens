[["T_OPEN_TAG","<?php\n",1],["T_DOC_COMMENT","\/**\n * Magento\n *\n * NOTICE OF LICENSE\n *\n * This source file is subject to the Open Software License (OSL 3.0)\n * that is bundled with this package in the file LICENSE.txt.\n * It is also available through the world-wide-web at this URL:\n * http:\/\/opensource.org\/licenses\/osl-3.0.php\n * If you did not receive a copy of the license and are unable to\n * obtain it through the world-wide-web, please send an email\n * to license@magento.com so we can send you a copy immediately.\n *\n * DISCLAIMER\n *\n * Do not edit or add to this file if you wish to upgrade Magento to newer\n * versions in the future. If you wish to customize Magento for your\n * needs please refer to http:\/\/www.magento.com for more information.\n *\n * @category    Mage\n * @package     Mage_Sales\n * @copyright  Copyright (c) 2006-2016 X.commerce, Inc. and affiliates (http:\/\/www.magento.com)\n * @license    http:\/\/opensource.org\/licenses\/osl-3.0.php  Open Software License (OSL 3.0)\n *\/",2],["T_WHITESPACE","\n\n\n",25],["T_DOC_COMMENT","\/**\n * Sales observer\n *\n * @category   Mage\n * @package    Mage_Sales\n * @author     Magento Core Team <core@magentocommerce.com>\n *\/",28],["T_WHITESPACE","\n",34],["T_CLASS","class",35],["T_WHITESPACE"," ",35],["T_STRING","Mage_Sales_Model_Observer",35],["T_WHITESPACE","\n",35],"{",["T_WHITESPACE","\n    ",36],["T_DOC_COMMENT","\/**\n     * Expire quotes additional fields to filter\n     *\n     * @var array\n     *\/",37],["T_WHITESPACE","\n    ",41],["T_PROTECTED","protected",42],["T_WHITESPACE"," ",42],["T_VARIABLE","$_expireQuotesFilterFields",42],["T_WHITESPACE"," ",42],"=",["T_WHITESPACE"," ",42],["T_ARRAY","array",42],"(",")",";",["T_WHITESPACE","\n\n    ",42],["T_DOC_COMMENT","\/**\n     * Clean expired quotes (cron process)\n     *\n     * @param Mage_Cron_Model_Schedule $schedule\n     * @return Mage_Sales_Model_Observer\n     *\/",44],["T_WHITESPACE","\n    ",49],["T_PUBLIC","public",50],["T_WHITESPACE"," ",50],["T_FUNCTION","function",50],["T_WHITESPACE"," ",50],["T_STRING","cleanExpiredQuotes",50],"(",["T_VARIABLE","$schedule",50],")",["T_WHITESPACE","\n    ",50],"{",["T_WHITESPACE","\n        ",51],["T_STRING","Mage",52],["T_DOUBLE_COLON","::",52],["T_STRING","dispatchEvent",52],"(",["T_CONSTANT_ENCAPSED_STRING","'clear_expired_quotes_before'",52],",",["T_WHITESPACE"," ",52],["T_ARRAY","array",52],"(",["T_CONSTANT_ENCAPSED_STRING","'sales_observer'",52],["T_WHITESPACE"," ",52],["T_DOUBLE_ARROW","=>",52],["T_WHITESPACE"," ",52],["T_VARIABLE","$this",52],")",")",";",["T_WHITESPACE","\n\n        ",52],["T_VARIABLE","$lifetimes",54],["T_WHITESPACE"," ",54],"=",["T_WHITESPACE"," ",54],["T_STRING","Mage",54],["T_DOUBLE_COLON","::",54],["T_STRING","getConfig",54],"(",")",["T_OBJECT_OPERATOR","->",54],["T_STRING","getStoresConfigByPath",54],"(",["T_CONSTANT_ENCAPSED_STRING","'checkout\/cart\/delete_quote_after'",54],")",";",["T_WHITESPACE","\n        ",54],["T_FOREACH","foreach",55],["T_WHITESPACE"," ",55],"(",["T_VARIABLE","$lifetimes",55],["T_WHITESPACE"," ",55],["T_AS","as",55],["T_WHITESPACE"," ",55],["T_VARIABLE","$storeId",55],["T_DOUBLE_ARROW","=>",55],["T_VARIABLE","$lifetime",55],")",["T_WHITESPACE"," ",55],"{",["T_WHITESPACE","\n            ",55],["T_VARIABLE","$lifetime",56],["T_WHITESPACE"," ",56],["T_MUL_EQUAL","*=",56],["T_WHITESPACE"," ",56],["T_LNUMBER","86400",56],";",["T_WHITESPACE","\n\n            ",56],["T_DOC_COMMENT","\/** @var $quotes Mage_Sales_Model_Mysql4_Quote_Collection *\/",58],["T_WHITESPACE","\n            ",58],["T_VARIABLE","$quotes",59],["T_WHITESPACE"," ",59],"=",["T_WHITESPACE"," ",59],["T_STRING","Mage",59],["T_DOUBLE_COLON","::",59],["T_STRING","getModel",59],"(",["T_CONSTANT_ENCAPSED_STRING","'sales\/quote'",59],")",["T_OBJECT_OPERATOR","->",59],["T_STRING","getCollection",59],"(",")",";",["T_WHITESPACE","\n\n            ",59],["T_VARIABLE","$quotes",61],["T_OBJECT_OPERATOR","->",61],["T_STRING","addFieldToFilter",61],"(",["T_CONSTANT_ENCAPSED_STRING","'store_id'",61],",",["T_WHITESPACE"," ",61],["T_VARIABLE","$storeId",61],")",";",["T_WHITESPACE","\n            ",61],["T_VARIABLE","$quotes",62],["T_OBJECT_OPERATOR","->",62],["T_STRING","addFieldToFilter",62],"(",["T_CONSTANT_ENCAPSED_STRING","'updated_at'",62],",",["T_WHITESPACE"," ",62],["T_ARRAY","array",62],"(",["T_CONSTANT_ENCAPSED_STRING","'to'",62],["T_DOUBLE_ARROW","=>",62],["T_STRING","date",62],"(",["T_CONSTANT_ENCAPSED_STRING","\"Y-m-d\"",62],",",["T_WHITESPACE"," ",62],["T_STRING","time",62],"(",")","-",["T_VARIABLE","$lifetime",62],")",")",")",";",["T_WHITESPACE","\n            ",62],["T_VARIABLE","$quotes",63],["T_OBJECT_OPERATOR","->",63],["T_STRING","addFieldToFilter",63],"(",["T_CONSTANT_ENCAPSED_STRING","'is_active'",63],",",["T_WHITESPACE"," ",63],["T_LNUMBER","0",63],")",";",["T_WHITESPACE","\n\n            ",63],["T_FOREACH","foreach",65],["T_WHITESPACE"," ",65],"(",["T_VARIABLE","$this",65],["T_OBJECT_OPERATOR","->",65],["T_STRING","getExpireQuotesAdditionalFilterFields",65],"(",")",["T_WHITESPACE"," ",65],["T_AS","as",65],["T_WHITESPACE"," ",65],["T_VARIABLE","$field",65],["T_WHITESPACE"," ",65],["T_DOUBLE_ARROW","=>",65],["T_WHITESPACE"," ",65],["T_VARIABLE","$condition",65],")",["T_WHITESPACE"," ",65],"{",["T_WHITESPACE","\n                ",65],["T_VARIABLE","$quotes",66],["T_OBJECT_OPERATOR","->",66],["T_STRING","addFieldToFilter",66],"(",["T_VARIABLE","$field",66],",",["T_WHITESPACE"," ",66],["T_VARIABLE","$condition",66],")",";",["T_WHITESPACE","\n            ",66],"}",["T_WHITESPACE","\n\n            ",67],["T_VARIABLE","$quotes",69],["T_OBJECT_OPERATOR","->",69],["T_STRING","walk",69],"(",["T_CONSTANT_ENCAPSED_STRING","'delete'",69],")",";",["T_WHITESPACE","\n        ",69],"}",["T_WHITESPACE","\n        ",70],["T_RETURN","return",71],["T_WHITESPACE"," ",71],["T_VARIABLE","$this",71],";",["T_WHITESPACE","\n    ",71],"}",["T_WHITESPACE","\n\n    ",72],["T_DOC_COMMENT","\/**\n     * Retrieve expire quotes additional fields to filter\n     *\n     * @return array\n     *\/",74],["T_WHITESPACE","\n    ",78],["T_PUBLIC","public",79],["T_WHITESPACE"," ",79],["T_FUNCTION","function",79],["T_WHITESPACE"," ",79],["T_STRING","getExpireQuotesAdditionalFilterFields",79],"(",")",["T_WHITESPACE","\n    ",79],"{",["T_WHITESPACE","\n        ",80],["T_RETURN","return",81],["T_WHITESPACE"," ",81],["T_VARIABLE","$this",81],["T_OBJECT_OPERATOR","->",81],["T_STRING","_expireQuotesFilterFields",81],";",["T_WHITESPACE","\n    ",81],"}",["T_WHITESPACE","\n\n    ",82],["T_DOC_COMMENT","\/**\n     * Set expire quotes additional fields to filter\n     *\n     * @param array $fields\n     * @return Mage_Sales_Model_Observer\n     *\/",84],["T_WHITESPACE","\n    ",89],["T_PUBLIC","public",90],["T_WHITESPACE"," ",90],["T_FUNCTION","function",90],["T_WHITESPACE"," ",90],["T_STRING","setExpireQuotesAdditionalFilterFields",90],"(",["T_ARRAY","array",90],["T_WHITESPACE"," ",90],["T_VARIABLE","$fields",90],")",["T_WHITESPACE","\n    ",90],"{",["T_WHITESPACE","\n        ",91],["T_VARIABLE","$this",92],["T_OBJECT_OPERATOR","->",92],["T_STRING","_expireQuotesFilterFields",92],["T_WHITESPACE"," ",92],"=",["T_WHITESPACE"," ",92],["T_VARIABLE","$fields",92],";",["T_WHITESPACE","\n        ",92],["T_RETURN","return",93],["T_WHITESPACE"," ",93],["T_VARIABLE","$this",93],";",["T_WHITESPACE","\n    ",93],"}",["T_WHITESPACE","\n\n    ",94],["T_DOC_COMMENT","\/**\n     * When deleting product, substract it from all quotes quantities\n     *\n     * @throws Exception\n     * @param Varien_Event_Observer\n     * @return Mage_Sales_Model_Observer\n     *\/",96],["T_WHITESPACE","\n    ",102],["T_PUBLIC","public",103],["T_WHITESPACE"," ",103],["T_FUNCTION","function",103],["T_WHITESPACE"," ",103],["T_STRING","substractQtyFromQuotes",103],"(",["T_VARIABLE","$observer",103],")",["T_WHITESPACE","\n    ",103],"{",["T_WHITESPACE","\n        ",104],["T_VARIABLE","$product",105],["T_WHITESPACE"," ",105],"=",["T_WHITESPACE"," ",105],["T_VARIABLE","$observer",105],["T_OBJECT_OPERATOR","->",105],["T_STRING","getEvent",105],"(",")",["T_OBJECT_OPERATOR","->",105],["T_STRING","getProduct",105],"(",")",";",["T_WHITESPACE","\n        ",105],["T_STRING","Mage",106],["T_DOUBLE_COLON","::",106],["T_STRING","getResourceSingleton",106],"(",["T_CONSTANT_ENCAPSED_STRING","'sales\/quote'",106],")",["T_OBJECT_OPERATOR","->",106],["T_STRING","substractProductFromQuotes",106],"(",["T_VARIABLE","$product",106],")",";",["T_WHITESPACE","\n        ",106],["T_RETURN","return",107],["T_WHITESPACE"," ",107],["T_VARIABLE","$this",107],";",["T_WHITESPACE","\n    ",107],"}",["T_WHITESPACE","\n\n    ",108],["T_DOC_COMMENT","\/**\n     * When applying a catalog price rule, make related quotes recollect on demand\n     *\n     * @param Varien_Event_Observer $observer\n     * @return Mage_Sales_Model_Observer\n     *\/",110],["T_WHITESPACE","\n    ",115],["T_PUBLIC","public",116],["T_WHITESPACE"," ",116],["T_FUNCTION","function",116],["T_WHITESPACE"," ",116],["T_STRING","markQuotesRecollectOnCatalogRules",116],"(",["T_VARIABLE","$observer",116],")",["T_WHITESPACE","\n    ",116],"{",["T_WHITESPACE","\n        ",117],["T_VARIABLE","$product",118],["T_WHITESPACE"," ",118],"=",["T_WHITESPACE"," ",118],["T_VARIABLE","$observer",118],["T_OBJECT_OPERATOR","->",118],["T_STRING","getEvent",118],"(",")",["T_OBJECT_OPERATOR","->",118],["T_STRING","getProduct",118],"(",")",";",["T_WHITESPACE","\n\n        ",118],["T_IF","if",120],["T_WHITESPACE"," ",120],"(",["T_STRING","is_numeric",120],"(",["T_VARIABLE","$product",120],")",")",["T_WHITESPACE"," ",120],"{",["T_WHITESPACE","\n            ",120],["T_VARIABLE","$product",121],["T_WHITESPACE"," ",121],"=",["T_WHITESPACE"," ",121],["T_STRING","Mage",121],["T_DOUBLE_COLON","::",121],["T_STRING","getModel",121],"(",["T_CONSTANT_ENCAPSED_STRING","\"catalog\/product\"",121],")",["T_OBJECT_OPERATOR","->",121],["T_STRING","load",121],"(",["T_VARIABLE","$product",121],")",";",["T_WHITESPACE","\n        ",121],"}",["T_WHITESPACE","\n        ",122],["T_IF","if",123],["T_WHITESPACE"," ",123],"(",["T_VARIABLE","$product",123],["T_WHITESPACE"," ",123],["T_INSTANCEOF","instanceof",123],["T_WHITESPACE"," ",123],["T_STRING","Mage_Catalog_Model_Product",123],")",["T_WHITESPACE"," ",123],"{",["T_WHITESPACE","\n            ",123],["T_VARIABLE","$childrenProductList",124],["T_WHITESPACE"," ",124],"=",["T_WHITESPACE"," ",124],["T_STRING","Mage",124],["T_DOUBLE_COLON","::",124],["T_STRING","getSingleton",124],"(",["T_CONSTANT_ENCAPSED_STRING","'catalog\/product_type'",124],")",["T_OBJECT_OPERATOR","->",124],["T_STRING","factory",124],"(",["T_VARIABLE","$product",124],")",["T_WHITESPACE","\n                ",124],["T_OBJECT_OPERATOR","->",125],["T_STRING","getChildrenIds",125],"(",["T_VARIABLE","$product",125],["T_OBJECT_OPERATOR","->",125],["T_STRING","getId",125],"(",")",",",["T_WHITESPACE"," ",125],["T_STRING","false",125],")",";",["T_WHITESPACE","\n\n            ",125],["T_VARIABLE","$productIdList",127],["T_WHITESPACE"," ",127],"=",["T_WHITESPACE"," ",127],["T_ARRAY","array",127],"(",["T_VARIABLE","$product",127],["T_OBJECT_OPERATOR","->",127],["T_STRING","getId",127],"(",")",")",";",["T_WHITESPACE","\n            ",127],["T_FOREACH","foreach",128],["T_WHITESPACE"," ",128],"(",["T_VARIABLE","$childrenProductList",128],["T_WHITESPACE"," ",128],["T_AS","as",128],["T_WHITESPACE"," ",128],["T_VARIABLE","$groupData",128],")",["T_WHITESPACE"," ",128],"{",["T_WHITESPACE","\n                ",128],["T_VARIABLE","$productIdList",129],["T_WHITESPACE"," ",129],"=",["T_WHITESPACE"," ",129],["T_STRING","array_merge",129],"(",["T_VARIABLE","$productIdList",129],",",["T_WHITESPACE"," ",129],["T_VARIABLE","$groupData",129],")",";",["T_WHITESPACE","\n            ",129],"}",["T_WHITESPACE","\n        ",130],"}",["T_WHITESPACE"," ",131],["T_ELSE","else",131],["T_WHITESPACE"," ",131],"{",["T_WHITESPACE","\n            ",131],["T_VARIABLE","$productIdList",132],["T_WHITESPACE"," ",132],"=",["T_WHITESPACE"," ",132],["T_STRING","null",132],";",["T_WHITESPACE","\n        ",132],"}",["T_WHITESPACE","\n\n        ",133],["T_STRING","Mage",135],["T_DOUBLE_COLON","::",135],["T_STRING","getResourceSingleton",135],"(",["T_CONSTANT_ENCAPSED_STRING","'sales\/quote'",135],")",["T_OBJECT_OPERATOR","->",135],["T_STRING","markQuotesRecollectByAffectedProduct",135],"(",["T_VARIABLE","$productIdList",135],")",";",["T_WHITESPACE","\n        ",135],["T_RETURN","return",136],["T_WHITESPACE"," ",136],["T_VARIABLE","$this",136],";",["T_WHITESPACE","\n    ",136],"}",["T_WHITESPACE","\n\n    ",137],["T_DOC_COMMENT","\/**\n     * Catalog Product After Save (change status process)\n     *\n     * @param Varien_Event_Observer $observer\n     * @return Mage_Sales_Model_Observer\n     *\/",139],["T_WHITESPACE","\n    ",144],["T_PUBLIC","public",145],["T_WHITESPACE"," ",145],["T_FUNCTION","function",145],["T_WHITESPACE"," ",145],["T_STRING","catalogProductSaveAfter",145],"(",["T_STRING","Varien_Event_Observer",145],["T_WHITESPACE"," ",145],["T_VARIABLE","$observer",145],")",["T_WHITESPACE","\n    ",145],"{",["T_WHITESPACE","\n        ",146],["T_VARIABLE","$product",147],["T_WHITESPACE"," ",147],"=",["T_WHITESPACE"," ",147],["T_VARIABLE","$observer",147],["T_OBJECT_OPERATOR","->",147],["T_STRING","getEvent",147],"(",")",["T_OBJECT_OPERATOR","->",147],["T_STRING","getProduct",147],"(",")",";",["T_WHITESPACE","\n        ",147],["T_IF","if",148],["T_WHITESPACE"," ",148],"(",["T_VARIABLE","$product",148],["T_OBJECT_OPERATOR","->",148],["T_STRING","getStatus",148],"(",")",["T_WHITESPACE"," ",148],["T_IS_EQUAL","==",148],["T_WHITESPACE"," ",148],["T_STRING","Mage_Catalog_Model_Product_Status",148],["T_DOUBLE_COLON","::",148],["T_STRING","STATUS_ENABLED",148],")",["T_WHITESPACE"," ",148],"{",["T_WHITESPACE","\n            ",148],["T_RETURN","return",149],["T_WHITESPACE"," ",149],["T_VARIABLE","$this",149],";",["T_WHITESPACE","\n        ",149],"}",["T_WHITESPACE","\n\n        ",150],["T_STRING","Mage",152],["T_DOUBLE_COLON","::",152],["T_STRING","getResourceSingleton",152],"(",["T_CONSTANT_ENCAPSED_STRING","'sales\/quote'",152],")",["T_OBJECT_OPERATOR","->",152],["T_STRING","markQuotesRecollect",152],"(",["T_VARIABLE","$product",152],["T_OBJECT_OPERATOR","->",152],["T_STRING","getId",152],"(",")",")",";",["T_WHITESPACE","\n\n        ",152],["T_RETURN","return",154],["T_WHITESPACE"," ",154],["T_VARIABLE","$this",154],";",["T_WHITESPACE","\n    ",154],"}",["T_WHITESPACE","\n\n    ",155],["T_DOC_COMMENT","\/**\n     * Catalog Mass Status update process\n     *\n     * @param Varien_Event_Observer $observer\n     * @return Mage_Sales_Model_Observer\n     *\/",157],["T_WHITESPACE","\n    ",162],["T_PUBLIC","public",163],["T_WHITESPACE"," ",163],["T_FUNCTION","function",163],["T_WHITESPACE"," ",163],["T_STRING","catalogProductStatusUpdate",163],"(",["T_STRING","Varien_Event_Observer",163],["T_WHITESPACE"," ",163],["T_VARIABLE","$observer",163],")",["T_WHITESPACE","\n    ",163],"{",["T_WHITESPACE","\n        ",164],["T_VARIABLE","$status",165],["T_WHITESPACE","     ",165],"=",["T_WHITESPACE"," ",165],["T_VARIABLE","$observer",165],["T_OBJECT_OPERATOR","->",165],["T_STRING","getEvent",165],"(",")",["T_OBJECT_OPERATOR","->",165],["T_STRING","getStatus",165],"(",")",";",["T_WHITESPACE","\n        ",165],["T_IF","if",166],["T_WHITESPACE"," ",166],"(",["T_VARIABLE","$status",166],["T_WHITESPACE"," ",166],["T_IS_EQUAL","==",166],["T_WHITESPACE"," ",166],["T_STRING","Mage_Catalog_Model_Product_Status",166],["T_DOUBLE_COLON","::",166],["T_STRING","STATUS_ENABLED",166],")",["T_WHITESPACE"," ",166],"{",["T_WHITESPACE","\n            ",166],["T_RETURN","return",167],["T_WHITESPACE"," ",167],["T_VARIABLE","$this",167],";",["T_WHITESPACE","\n        ",167],"}",["T_WHITESPACE","\n        ",168],["T_VARIABLE","$productId",169],["T_WHITESPACE","  ",169],"=",["T_WHITESPACE"," ",169],["T_VARIABLE","$observer",169],["T_OBJECT_OPERATOR","->",169],["T_STRING","getEvent",169],"(",")",["T_OBJECT_OPERATOR","->",169],["T_STRING","getProductId",169],"(",")",";",["T_WHITESPACE","\n        ",169],["T_STRING","Mage",170],["T_DOUBLE_COLON","::",170],["T_STRING","getResourceSingleton",170],"(",["T_CONSTANT_ENCAPSED_STRING","'sales\/quote'",170],")",["T_OBJECT_OPERATOR","->",170],["T_STRING","markQuotesRecollect",170],"(",["T_VARIABLE","$productId",170],")",";",["T_WHITESPACE","\n\n        ",170],["T_RETURN","return",172],["T_WHITESPACE"," ",172],["T_VARIABLE","$this",172],";",["T_WHITESPACE","\n    ",172],"}",["T_WHITESPACE","\n\n    ",173],["T_DOC_COMMENT","\/**\n     * Refresh sales order report statistics for last day\n     *\n     * @param Mage_Cron_Model_Schedule $schedule\n     * @return Mage_Sales_Model_Observer\n     *\/",175],["T_WHITESPACE","\n    ",180],["T_PUBLIC","public",181],["T_WHITESPACE"," ",181],["T_FUNCTION","function",181],["T_WHITESPACE"," ",181],["T_STRING","aggregateSalesReportOrderData",181],"(",["T_VARIABLE","$schedule",181],")",["T_WHITESPACE","\n    ",181],"{",["T_WHITESPACE","\n        ",182],["T_STRING","Mage",183],["T_DOUBLE_COLON","::",183],["T_STRING","app",183],"(",")",["T_OBJECT_OPERATOR","->",183],["T_STRING","getLocale",183],"(",")",["T_OBJECT_OPERATOR","->",183],["T_STRING","emulate",183],"(",["T_LNUMBER","0",183],")",";",["T_WHITESPACE","\n        ",183],["T_VARIABLE","$currentDate",184],["T_WHITESPACE"," ",184],"=",["T_WHITESPACE"," ",184],["T_STRING","Mage",184],["T_DOUBLE_COLON","::",184],["T_STRING","app",184],"(",")",["T_OBJECT_OPERATOR","->",184],["T_STRING","getLocale",184],"(",")",["T_OBJECT_OPERATOR","->",184],["T_STRING","date",184],"(",")",";",["T_WHITESPACE","\n        ",184],["T_VARIABLE","$date",185],["T_WHITESPACE"," ",185],"=",["T_WHITESPACE"," ",185],["T_VARIABLE","$currentDate",185],["T_OBJECT_OPERATOR","->",185],["T_STRING","subHour",185],"(",["T_LNUMBER","25",185],")",";",["T_WHITESPACE","\n        ",185],["T_STRING","Mage",186],["T_DOUBLE_COLON","::",186],["T_STRING","getResourceModel",186],"(",["T_CONSTANT_ENCAPSED_STRING","'sales\/report_order'",186],")",["T_OBJECT_OPERATOR","->",186],["T_STRING","aggregate",186],"(",["T_VARIABLE","$date",186],")",";",["T_WHITESPACE","\n        ",186],["T_STRING","Mage",187],["T_DOUBLE_COLON","::",187],["T_STRING","app",187],"(",")",["T_OBJECT_OPERATOR","->",187],["T_STRING","getLocale",187],"(",")",["T_OBJECT_OPERATOR","->",187],["T_STRING","revert",187],"(",")",";",["T_WHITESPACE","\n        ",187],["T_RETURN","return",188],["T_WHITESPACE"," ",188],["T_VARIABLE","$this",188],";",["T_WHITESPACE","\n    ",188],"}",["T_WHITESPACE","\n\n    ",189],["T_DOC_COMMENT","\/**\n     * Refresh sales shipment report statistics for last day\n     *\n     * @param Mage_Cron_Model_Schedule $schedule\n     * @return Mage_Sales_Model_Observer\n     *\/",191],["T_WHITESPACE","\n    ",196],["T_PUBLIC","public",197],["T_WHITESPACE"," ",197],["T_FUNCTION","function",197],["T_WHITESPACE"," ",197],["T_STRING","aggregateSalesReportShipmentData",197],"(",["T_VARIABLE","$schedule",197],")",["T_WHITESPACE","\n    ",197],"{",["T_WHITESPACE","\n        ",198],["T_STRING","Mage",199],["T_DOUBLE_COLON","::",199],["T_STRING","app",199],"(",")",["T_OBJECT_OPERATOR","->",199],["T_STRING","getLocale",199],"(",")",["T_OBJECT_OPERATOR","->",199],["T_STRING","emulate",199],"(",["T_LNUMBER","0",199],")",";",["T_WHITESPACE","\n        ",199],["T_VARIABLE","$currentDate",200],["T_WHITESPACE"," ",200],"=",["T_WHITESPACE"," ",200],["T_STRING","Mage",200],["T_DOUBLE_COLON","::",200],["T_STRING","app",200],"(",")",["T_OBJECT_OPERATOR","->",200],["T_STRING","getLocale",200],"(",")",["T_OBJECT_OPERATOR","->",200],["T_STRING","date",200],"(",")",";",["T_WHITESPACE","\n        ",200],["T_VARIABLE","$date",201],["T_WHITESPACE"," ",201],"=",["T_WHITESPACE"," ",201],["T_VARIABLE","$currentDate",201],["T_OBJECT_OPERATOR","->",201],["T_STRING","subHour",201],"(",["T_LNUMBER","25",201],")",";",["T_WHITESPACE","\n        ",201],["T_STRING","Mage",202],["T_DOUBLE_COLON","::",202],["T_STRING","getResourceModel",202],"(",["T_CONSTANT_ENCAPSED_STRING","'sales\/report_shipping'",202],")",["T_OBJECT_OPERATOR","->",202],["T_STRING","aggregate",202],"(",["T_VARIABLE","$date",202],")",";",["T_WHITESPACE","\n        ",202],["T_STRING","Mage",203],["T_DOUBLE_COLON","::",203],["T_STRING","app",203],"(",")",["T_OBJECT_OPERATOR","->",203],["T_STRING","getLocale",203],"(",")",["T_OBJECT_OPERATOR","->",203],["T_STRING","revert",203],"(",")",";",["T_WHITESPACE","\n        ",203],["T_RETURN","return",204],["T_WHITESPACE"," ",204],["T_VARIABLE","$this",204],";",["T_WHITESPACE","\n    ",204],"}",["T_WHITESPACE","\n\n    ",205],["T_DOC_COMMENT","\/**\n     * Refresh sales invoiced report statistics for last day\n     *\n     * @param Mage_Cron_Model_Schedule $schedule\n     * @return Mage_Sales_Model_Observer\n     *\/",207],["T_WHITESPACE","\n    ",212],["T_PUBLIC","public",213],["T_WHITESPACE"," ",213],["T_FUNCTION","function",213],["T_WHITESPACE"," ",213],["T_STRING","aggregateSalesReportInvoicedData",213],"(",["T_VARIABLE","$schedule",213],")",["T_WHITESPACE","\n    ",213],"{",["T_WHITESPACE","\n        ",214],["T_STRING","Mage",215],["T_DOUBLE_COLON","::",215],["T_STRING","app",215],"(",")",["T_OBJECT_OPERATOR","->",215],["T_STRING","getLocale",215],"(",")",["T_OBJECT_OPERATOR","->",215],["T_STRING","emulate",215],"(",["T_LNUMBER","0",215],")",";",["T_WHITESPACE","\n        ",215],["T_VARIABLE","$currentDate",216],["T_WHITESPACE"," ",216],"=",["T_WHITESPACE"," ",216],["T_STRING","Mage",216],["T_DOUBLE_COLON","::",216],["T_STRING","app",216],"(",")",["T_OBJECT_OPERATOR","->",216],["T_STRING","getLocale",216],"(",")",["T_OBJECT_OPERATOR","->",216],["T_STRING","date",216],"(",")",";",["T_WHITESPACE","\n        ",216],["T_VARIABLE","$date",217],["T_WHITESPACE"," ",217],"=",["T_WHITESPACE"," ",217],["T_VARIABLE","$currentDate",217],["T_OBJECT_OPERATOR","->",217],["T_STRING","subHour",217],"(",["T_LNUMBER","25",217],")",";",["T_WHITESPACE","\n        ",217],["T_STRING","Mage",218],["T_DOUBLE_COLON","::",218],["T_STRING","getResourceModel",218],"(",["T_CONSTANT_ENCAPSED_STRING","'sales\/report_invoiced'",218],")",["T_OBJECT_OPERATOR","->",218],["T_STRING","aggregate",218],"(",["T_VARIABLE","$date",218],")",";",["T_WHITESPACE","\n        ",218],["T_STRING","Mage",219],["T_DOUBLE_COLON","::",219],["T_STRING","app",219],"(",")",["T_OBJECT_OPERATOR","->",219],["T_STRING","getLocale",219],"(",")",["T_OBJECT_OPERATOR","->",219],["T_STRING","revert",219],"(",")",";",["T_WHITESPACE","\n        ",219],["T_RETURN","return",220],["T_WHITESPACE"," ",220],["T_VARIABLE","$this",220],";",["T_WHITESPACE","\n    ",220],"}",["T_WHITESPACE","\n\n    ",221],["T_DOC_COMMENT","\/**\n     * Refresh sales refunded report statistics for last day\n     *\n     * @param Mage_Cron_Model_Schedule $schedule\n     * @return Mage_Sales_Model_Observer\n     *\/",223],["T_WHITESPACE","\n    ",228],["T_PUBLIC","public",229],["T_WHITESPACE"," ",229],["T_FUNCTION","function",229],["T_WHITESPACE"," ",229],["T_STRING","aggregateSalesReportRefundedData",229],"(",["T_VARIABLE","$schedule",229],")",["T_WHITESPACE","\n    ",229],"{",["T_WHITESPACE","\n        ",230],["T_STRING","Mage",231],["T_DOUBLE_COLON","::",231],["T_STRING","app",231],"(",")",["T_OBJECT_OPERATOR","->",231],["T_STRING","getLocale",231],"(",")",["T_OBJECT_OPERATOR","->",231],["T_STRING","emulate",231],"(",["T_LNUMBER","0",231],")",";",["T_WHITESPACE","\n        ",231],["T_VARIABLE","$currentDate",232],["T_WHITESPACE"," ",232],"=",["T_WHITESPACE"," ",232],["T_STRING","Mage",232],["T_DOUBLE_COLON","::",232],["T_STRING","app",232],"(",")",["T_OBJECT_OPERATOR","->",232],["T_STRING","getLocale",232],"(",")",["T_OBJECT_OPERATOR","->",232],["T_STRING","date",232],"(",")",";",["T_WHITESPACE","\n        ",232],["T_VARIABLE","$date",233],["T_WHITESPACE"," ",233],"=",["T_WHITESPACE"," ",233],["T_VARIABLE","$currentDate",233],["T_OBJECT_OPERATOR","->",233],["T_STRING","subHour",233],"(",["T_LNUMBER","25",233],")",";",["T_WHITESPACE","\n        ",233],["T_STRING","Mage",234],["T_DOUBLE_COLON","::",234],["T_STRING","getResourceModel",234],"(",["T_CONSTANT_ENCAPSED_STRING","'sales\/report_refunded'",234],")",["T_OBJECT_OPERATOR","->",234],["T_STRING","aggregate",234],"(",["T_VARIABLE","$date",234],")",";",["T_WHITESPACE","\n        ",234],["T_STRING","Mage",235],["T_DOUBLE_COLON","::",235],["T_STRING","app",235],"(",")",["T_OBJECT_OPERATOR","->",235],["T_STRING","getLocale",235],"(",")",["T_OBJECT_OPERATOR","->",235],["T_STRING","revert",235],"(",")",";",["T_WHITESPACE","\n        ",235],["T_RETURN","return",236],["T_WHITESPACE"," ",236],["T_VARIABLE","$this",236],";",["T_WHITESPACE","\n    ",236],"}",["T_WHITESPACE","\n\n    ",237],["T_DOC_COMMENT","\/**\n     * Refresh bestsellers report statistics for last day\n     *\n     * @param Mage_Cron_Model_Schedule $schedule\n     * @return Mage_Sales_Model_Observer\n     *\/",239],["T_WHITESPACE","\n    ",244],["T_PUBLIC","public",245],["T_WHITESPACE"," ",245],["T_FUNCTION","function",245],["T_WHITESPACE"," ",245],["T_STRING","aggregateSalesReportBestsellersData",245],"(",["T_VARIABLE","$schedule",245],")",["T_WHITESPACE","\n    ",245],"{",["T_WHITESPACE","\n        ",246],["T_STRING","Mage",247],["T_DOUBLE_COLON","::",247],["T_STRING","app",247],"(",")",["T_OBJECT_OPERATOR","->",247],["T_STRING","getLocale",247],"(",")",["T_OBJECT_OPERATOR","->",247],["T_STRING","emulate",247],"(",["T_LNUMBER","0",247],")",";",["T_WHITESPACE","\n        ",247],["T_VARIABLE","$currentDate",248],["T_WHITESPACE"," ",248],"=",["T_WHITESPACE"," ",248],["T_STRING","Mage",248],["T_DOUBLE_COLON","::",248],["T_STRING","app",248],"(",")",["T_OBJECT_OPERATOR","->",248],["T_STRING","getLocale",248],"(",")",["T_OBJECT_OPERATOR","->",248],["T_STRING","date",248],"(",")",";",["T_WHITESPACE","\n        ",248],["T_VARIABLE","$date",249],["T_WHITESPACE"," ",249],"=",["T_WHITESPACE"," ",249],["T_VARIABLE","$currentDate",249],["T_OBJECT_OPERATOR","->",249],["T_STRING","subHour",249],"(",["T_LNUMBER","25",249],")",";",["T_WHITESPACE","\n        ",249],["T_STRING","Mage",250],["T_DOUBLE_COLON","::",250],["T_STRING","getResourceModel",250],"(",["T_CONSTANT_ENCAPSED_STRING","'sales\/report_bestsellers'",250],")",["T_OBJECT_OPERATOR","->",250],["T_STRING","aggregate",250],"(",["T_VARIABLE","$date",250],")",";",["T_WHITESPACE","\n        ",250],["T_STRING","Mage",251],["T_DOUBLE_COLON","::",251],["T_STRING","app",251],"(",")",["T_OBJECT_OPERATOR","->",251],["T_STRING","getLocale",251],"(",")",["T_OBJECT_OPERATOR","->",251],["T_STRING","revert",251],"(",")",";",["T_WHITESPACE","\n        ",251],["T_RETURN","return",252],["T_WHITESPACE"," ",252],["T_VARIABLE","$this",252],";",["T_WHITESPACE","\n    ",252],"}",["T_WHITESPACE","\n\n    ",253],["T_DOC_COMMENT","\/**\n     * Add the recurring profile form when editing a product\n     *\n     * @param Varien_Event_Observer $observer\n     *\/",255],["T_WHITESPACE","\n    ",259],["T_PUBLIC","public",260],["T_WHITESPACE"," ",260],["T_FUNCTION","function",260],["T_WHITESPACE"," ",260],["T_STRING","prepareProductEditFormRecurringProfile",260],"(",["T_VARIABLE","$observer",260],")",["T_WHITESPACE","\n    ",260],"{",["T_WHITESPACE","\n        ",261],["T_COMMENT","\/\/ replace the element of recurring payment profile field with a form\n",262],["T_WHITESPACE","        ",263],["T_VARIABLE","$profileElement",263],["T_WHITESPACE"," ",263],"=",["T_WHITESPACE"," ",263],["T_VARIABLE","$observer",263],["T_OBJECT_OPERATOR","->",263],["T_STRING","getEvent",263],"(",")",["T_OBJECT_OPERATOR","->",263],["T_STRING","getProductElement",263],"(",")",";",["T_WHITESPACE","\n        ",263],["T_VARIABLE","$block",264],["T_WHITESPACE"," ",264],"=",["T_WHITESPACE"," ",264],["T_STRING","Mage",264],["T_DOUBLE_COLON","::",264],["T_STRING","app",264],"(",")",["T_OBJECT_OPERATOR","->",264],["T_STRING","getLayout",264],"(",")",["T_OBJECT_OPERATOR","->",264],["T_STRING","createBlock",264],"(",["T_CONSTANT_ENCAPSED_STRING","'sales\/adminhtml_recurring_profile_edit_form'",264],",",["T_WHITESPACE","\n            ",264],["T_CONSTANT_ENCAPSED_STRING","'adminhtml_recurring_profile_edit_form'",265],")",["T_OBJECT_OPERATOR","->",265],["T_STRING","setParentElement",265],"(",["T_VARIABLE","$profileElement",265],")",["T_WHITESPACE","\n            ",265],["T_OBJECT_OPERATOR","->",266],["T_STRING","setProductEntity",266],"(",["T_VARIABLE","$observer",266],["T_OBJECT_OPERATOR","->",266],["T_STRING","getEvent",266],"(",")",["T_OBJECT_OPERATOR","->",266],["T_STRING","getProduct",266],"(",")",")",";",["T_WHITESPACE","\n        ",266],["T_VARIABLE","$observer",267],["T_OBJECT_OPERATOR","->",267],["T_STRING","getEvent",267],"(",")",["T_OBJECT_OPERATOR","->",267],["T_STRING","getResult",267],"(",")",["T_OBJECT_OPERATOR","->",267],["T_STRING","output",267],["T_WHITESPACE"," ",267],"=",["T_WHITESPACE"," ",267],["T_VARIABLE","$block",267],["T_OBJECT_OPERATOR","->",267],["T_STRING","toHtml",267],"(",")",";",["T_WHITESPACE","\n\n        ",267],["T_COMMENT","\/\/ make the profile element dependent on is_recurring\n",269],["T_WHITESPACE","        ",270],["T_VARIABLE","$dependencies",270],["T_WHITESPACE"," ",270],"=",["T_WHITESPACE"," ",270],["T_STRING","Mage",270],["T_DOUBLE_COLON","::",270],["T_STRING","app",270],"(",")",["T_OBJECT_OPERATOR","->",270],["T_STRING","getLayout",270],"(",")",["T_OBJECT_OPERATOR","->",270],["T_STRING","createBlock",270],"(",["T_CONSTANT_ENCAPSED_STRING","'adminhtml\/widget_form_element_dependence'",270],",",["T_WHITESPACE","\n            ",270],["T_CONSTANT_ENCAPSED_STRING","'adminhtml_recurring_profile_edit_form_dependence'",271],")",["T_OBJECT_OPERATOR","->",271],["T_STRING","addFieldMap",271],"(",["T_CONSTANT_ENCAPSED_STRING","'is_recurring'",271],",",["T_WHITESPACE"," ",271],["T_CONSTANT_ENCAPSED_STRING","'product[is_recurring]'",271],")",["T_WHITESPACE","\n            ",271],["T_OBJECT_OPERATOR","->",272],["T_STRING","addFieldMap",272],"(",["T_VARIABLE","$profileElement",272],["T_OBJECT_OPERATOR","->",272],["T_STRING","getHtmlId",272],"(",")",",",["T_WHITESPACE"," ",272],["T_VARIABLE","$profileElement",272],["T_OBJECT_OPERATOR","->",272],["T_STRING","getName",272],"(",")",")",["T_WHITESPACE","\n            ",272],["T_OBJECT_OPERATOR","->",273],["T_STRING","addFieldDependence",273],"(",["T_VARIABLE","$profileElement",273],["T_OBJECT_OPERATOR","->",273],["T_STRING","getName",273],"(",")",",",["T_WHITESPACE"," ",273],["T_CONSTANT_ENCAPSED_STRING","'product[is_recurring]'",273],",",["T_WHITESPACE"," ",273],["T_CONSTANT_ENCAPSED_STRING","'1'",273],")",["T_WHITESPACE","\n            ",273],["T_OBJECT_OPERATOR","->",274],["T_STRING","addConfigOptions",274],"(",["T_ARRAY","array",274],"(",["T_CONSTANT_ENCAPSED_STRING","'levels_up'",274],["T_WHITESPACE"," ",274],["T_DOUBLE_ARROW","=>",274],["T_WHITESPACE"," ",274],["T_LNUMBER","2",274],")",")",";",["T_WHITESPACE","\n        ",274],["T_VARIABLE","$observer",275],["T_OBJECT_OPERATOR","->",275],["T_STRING","getEvent",275],"(",")",["T_OBJECT_OPERATOR","->",275],["T_STRING","getResult",275],"(",")",["T_OBJECT_OPERATOR","->",275],["T_STRING","output",275],["T_WHITESPACE"," ",275],["T_CONCAT_EQUAL",".=",275],["T_WHITESPACE"," ",275],["T_VARIABLE","$dependencies",275],["T_OBJECT_OPERATOR","->",275],["T_STRING","toHtml",275],"(",")",";",["T_WHITESPACE","\n    ",275],"}",["T_WHITESPACE","\n\n    ",276],["T_DOC_COMMENT","\/**\n     * Block admin ability to use customer billing agreements\n     *\n     * @param Varien_Event_Observer $observer\n     *\/",278],["T_WHITESPACE","\n    ",282],["T_PUBLIC","public",283],["T_WHITESPACE"," ",283],["T_FUNCTION","function",283],["T_WHITESPACE"," ",283],["T_STRING","restrictAdminBillingAgreementUsage",283],"(",["T_VARIABLE","$observer",283],")",["T_WHITESPACE","\n    ",283],"{",["T_WHITESPACE","\n        ",284],["T_VARIABLE","$methodInstance",285],["T_WHITESPACE"," ",285],"=",["T_WHITESPACE"," ",285],["T_VARIABLE","$observer",285],["T_OBJECT_OPERATOR","->",285],["T_STRING","getEvent",285],"(",")",["T_OBJECT_OPERATOR","->",285],["T_STRING","getMethodInstance",285],"(",")",";",["T_WHITESPACE","\n        ",285],["T_IF","if",286],["T_WHITESPACE"," ",286],"(","!","(",["T_VARIABLE","$methodInstance",286],["T_WHITESPACE"," ",286],["T_INSTANCEOF","instanceof",286],["T_WHITESPACE"," ",286],["T_STRING","Mage_Sales_Model_Payment_Method_Billing_AgreementAbstract",286],")",")",["T_WHITESPACE"," ",286],"{",["T_WHITESPACE","\n            ",286],["T_RETURN","return",287],";",["T_WHITESPACE","\n        ",287],"}",["T_WHITESPACE","\n        ",288],["T_IF","if",289],["T_WHITESPACE"," ",289],"(","!",["T_STRING","Mage",289],["T_DOUBLE_COLON","::",289],["T_STRING","getSingleton",289],"(",["T_CONSTANT_ENCAPSED_STRING","'admin\/session'",289],")",["T_OBJECT_OPERATOR","->",289],["T_STRING","isAllowed",289],"(",["T_CONSTANT_ENCAPSED_STRING","'sales\/order\/actions\/use'",289],")",")",["T_WHITESPACE"," ",289],"{",["T_WHITESPACE","\n            ",289],["T_VARIABLE","$observer",290],["T_OBJECT_OPERATOR","->",290],["T_STRING","getEvent",290],"(",")",["T_OBJECT_OPERATOR","->",290],["T_STRING","getResult",290],"(",")",["T_OBJECT_OPERATOR","->",290],["T_STRING","isAvailable",290],["T_WHITESPACE"," ",290],"=",["T_WHITESPACE"," ",290],["T_STRING","false",290],";",["T_WHITESPACE","\n        ",290],"}",["T_WHITESPACE","\n    ",291],"}",["T_WHITESPACE","\n\n    ",292],["T_DOC_COMMENT","\/**\n     * Set new customer group to all his quotes\n     *\n     * @param  Varien_Event_Observer $observer\n     * @return Mage_Sales_Model_Observer\n     *\/",294],["T_WHITESPACE","\n    ",299],["T_PUBLIC","public",300],["T_WHITESPACE"," ",300],["T_FUNCTION","function",300],["T_WHITESPACE"," ",300],["T_STRING","customerSaveAfter",300],"(",["T_STRING","Varien_Event_Observer",300],["T_WHITESPACE"," ",300],["T_VARIABLE","$observer",300],")",["T_WHITESPACE","\n    ",300],"{",["T_WHITESPACE","\n        ",301],["T_DOC_COMMENT","\/** @var $customer Mage_Customer_Model_Customer *\/",302],["T_WHITESPACE","\n        ",302],["T_VARIABLE","$customer",303],["T_WHITESPACE"," ",303],"=",["T_WHITESPACE"," ",303],["T_VARIABLE","$observer",303],["T_OBJECT_OPERATOR","->",303],["T_STRING","getEvent",303],"(",")",["T_OBJECT_OPERATOR","->",303],["T_STRING","getCustomer",303],"(",")",";",["T_WHITESPACE","\n\n        ",303],["T_IF","if",305],["T_WHITESPACE"," ",305],"(",["T_VARIABLE","$customer",305],["T_OBJECT_OPERATOR","->",305],["T_STRING","getGroupId",305],"(",")",["T_WHITESPACE"," ",305],["T_IS_NOT_IDENTICAL","!==",305],["T_WHITESPACE"," ",305],["T_VARIABLE","$customer",305],["T_OBJECT_OPERATOR","->",305],["T_STRING","getOrigData",305],"(",["T_CONSTANT_ENCAPSED_STRING","'group_id'",305],")",")",["T_WHITESPACE"," ",305],"{",["T_WHITESPACE","\n            ",305],["T_DOC_COMMENT","\/**\n             * It is needed to process customer's quotes for all websites\n             * if customer accounts are shared between all of them\n             *\/",306],["T_WHITESPACE","\n            ",309],["T_VARIABLE","$websites",310],["T_WHITESPACE"," ",310],"=",["T_WHITESPACE"," ",310],"(",["T_STRING","Mage",310],["T_DOUBLE_COLON","::",310],["T_STRING","getSingleton",310],"(",["T_CONSTANT_ENCAPSED_STRING","'customer\/config_share'",310],")",["T_OBJECT_OPERATOR","->",310],["T_STRING","isWebsiteScope",310],"(",")",")",["T_WHITESPACE","\n                ",310],"?",["T_WHITESPACE"," ",311],["T_ARRAY","array",311],"(",["T_STRING","Mage",311],["T_DOUBLE_COLON","::",311],["T_STRING","app",311],"(",")",["T_OBJECT_OPERATOR","->",311],["T_STRING","getWebsite",311],"(",["T_VARIABLE","$customer",311],["T_OBJECT_OPERATOR","->",311],["T_STRING","getWebsiteId",311],"(",")",")",")",["T_WHITESPACE","\n                ",311],":",["T_WHITESPACE"," ",312],["T_STRING","Mage",312],["T_DOUBLE_COLON","::",312],["T_STRING","app",312],"(",")",["T_OBJECT_OPERATOR","->",312],["T_STRING","getWebsites",312],"(",")",";",["T_WHITESPACE","\n\n            ",312],["T_DOC_COMMENT","\/** @var $quote Mage_Sales_Model_Quote *\/",314],["T_WHITESPACE","\n            ",314],["T_VARIABLE","$quote",315],["T_WHITESPACE"," ",315],"=",["T_WHITESPACE"," ",315],["T_STRING","Mage",315],["T_DOUBLE_COLON","::",315],["T_STRING","getSingleton",315],"(",["T_CONSTANT_ENCAPSED_STRING","'sales\/quote'",315],")",";",["T_WHITESPACE","\n\n            ",315],["T_FOREACH","foreach",317],["T_WHITESPACE"," ",317],"(",["T_VARIABLE","$websites",317],["T_WHITESPACE"," ",317],["T_AS","as",317],["T_WHITESPACE"," ",317],["T_VARIABLE","$website",317],")",["T_WHITESPACE"," ",317],"{",["T_WHITESPACE","\n                ",317],["T_VARIABLE","$quote",318],["T_OBJECT_OPERATOR","->",318],["T_STRING","setWebsite",318],"(",["T_VARIABLE","$website",318],")",";",["T_WHITESPACE","\n                ",318],["T_VARIABLE","$quote",319],["T_OBJECT_OPERATOR","->",319],["T_STRING","loadByCustomer",319],"(",["T_VARIABLE","$customer",319],")",";",["T_WHITESPACE","\n\n                ",319],["T_IF","if",321],["T_WHITESPACE"," ",321],"(",["T_VARIABLE","$quote",321],["T_OBJECT_OPERATOR","->",321],["T_STRING","getId",321],"(",")",")",["T_WHITESPACE"," ",321],"{",["T_WHITESPACE","\n                    ",321],["T_VARIABLE","$quote",322],["T_OBJECT_OPERATOR","->",322],["T_STRING","setCustomerGroupId",322],"(",["T_VARIABLE","$customer",322],["T_OBJECT_OPERATOR","->",322],["T_STRING","getGroupId",322],"(",")",")",";",["T_WHITESPACE","\n                    ",322],["T_VARIABLE","$quote",323],["T_OBJECT_OPERATOR","->",323],["T_STRING","collectTotals",323],"(",")",";",["T_WHITESPACE","\n                    ",323],["T_VARIABLE","$quote",324],["T_OBJECT_OPERATOR","->",324],["T_STRING","save",324],"(",")",";",["T_WHITESPACE","\n                ",324],"}",["T_WHITESPACE","\n            ",325],"}",["T_WHITESPACE","\n        ",326],"}",["T_WHITESPACE","\n\n        ",327],["T_RETURN","return",329],["T_WHITESPACE"," ",329],["T_VARIABLE","$this",329],";",["T_WHITESPACE","\n    ",329],"}",["T_WHITESPACE","\n\n    ",330],["T_DOC_COMMENT","\/**\n     * Set Quote information about MSRP price enabled\n     *\n     * @param Varien_Event_Observer $observer\n     *\/",332],["T_WHITESPACE","\n    ",336],["T_PUBLIC","public",337],["T_WHITESPACE"," ",337],["T_FUNCTION","function",337],["T_WHITESPACE"," ",337],["T_STRING","setQuoteCanApplyMsrp",337],"(",["T_STRING","Varien_Event_Observer",337],["T_WHITESPACE"," ",337],["T_VARIABLE","$observer",337],")",["T_WHITESPACE","\n    ",337],"{",["T_WHITESPACE","\n        ",338],["T_DOC_COMMENT","\/** @var $quote Mage_Sales_Model_Quote *\/",339],["T_WHITESPACE","\n        ",339],["T_VARIABLE","$quote",340],["T_WHITESPACE"," ",340],"=",["T_WHITESPACE"," ",340],["T_VARIABLE","$observer",340],["T_OBJECT_OPERATOR","->",340],["T_STRING","getEvent",340],"(",")",["T_OBJECT_OPERATOR","->",340],["T_STRING","getQuote",340],"(",")",";",["T_WHITESPACE","\n\n        ",340],["T_VARIABLE","$canApplyMsrp",342],["T_WHITESPACE"," ",342],"=",["T_WHITESPACE"," ",342],["T_STRING","false",342],";",["T_WHITESPACE","\n        ",342],["T_IF","if",343],["T_WHITESPACE"," ",343],"(",["T_STRING","Mage",343],["T_DOUBLE_COLON","::",343],["T_STRING","helper",343],"(",["T_CONSTANT_ENCAPSED_STRING","'catalog'",343],")",["T_OBJECT_OPERATOR","->",343],["T_STRING","isMsrpEnabled",343],"(",")",")",["T_WHITESPACE"," ",343],"{",["T_WHITESPACE","\n            ",343],["T_FOREACH","foreach",344],["T_WHITESPACE"," ",344],"(",["T_VARIABLE","$quote",344],["T_OBJECT_OPERATOR","->",344],["T_STRING","getAllAddresses",344],"(",")",["T_WHITESPACE"," ",344],["T_AS","as",344],["T_WHITESPACE"," ",344],["T_VARIABLE","$adddress",344],")",["T_WHITESPACE"," ",344],"{",["T_WHITESPACE","\n                ",344],["T_IF","if",345],["T_WHITESPACE"," ",345],"(",["T_VARIABLE","$adddress",345],["T_OBJECT_OPERATOR","->",345],["T_STRING","getCanApplyMsrp",345],"(",")",")",["T_WHITESPACE"," ",345],"{",["T_WHITESPACE","\n                    ",345],["T_VARIABLE","$canApplyMsrp",346],["T_WHITESPACE"," ",346],"=",["T_WHITESPACE"," ",346],["T_STRING","true",346],";",["T_WHITESPACE","\n                    ",346],["T_BREAK","break",347],";",["T_WHITESPACE","\n                ",347],"}",["T_WHITESPACE","\n            ",348],"}",["T_WHITESPACE","\n        ",349],"}",["T_WHITESPACE","\n\n        ",350],["T_VARIABLE","$quote",352],["T_OBJECT_OPERATOR","->",352],["T_STRING","setCanApplyMsrp",352],"(",["T_VARIABLE","$canApplyMsrp",352],")",";",["T_WHITESPACE","\n    ",352],"}",["T_WHITESPACE","\n\n    ",353],["T_DOC_COMMENT","\/**\n     * Add VAT validation request date and identifier to order comments\n     *\n     * @param Varien_Event_Observer $observer\n     * @return null\n     *\/",355],["T_WHITESPACE","\n    ",360],["T_PUBLIC","public",361],["T_WHITESPACE"," ",361],["T_FUNCTION","function",361],["T_WHITESPACE"," ",361],["T_STRING","addVatRequestParamsOrderComment",361],"(",["T_STRING","Varien_Event_Observer",361],["T_WHITESPACE"," ",361],["T_VARIABLE","$observer",361],")",["T_WHITESPACE","\n    ",361],"{",["T_WHITESPACE","\n        ",362],["T_DOC_COMMENT","\/** @var $orderInstance Mage_Sales_Model_Order *\/",363],["T_WHITESPACE","\n        ",363],["T_VARIABLE","$orderInstance",364],["T_WHITESPACE"," ",364],"=",["T_WHITESPACE"," ",364],["T_VARIABLE","$observer",364],["T_OBJECT_OPERATOR","->",364],["T_STRING","getOrder",364],"(",")",";",["T_WHITESPACE","\n        ",364],["T_DOC_COMMENT","\/** @var $orderAddress Mage_Sales_Model_Order_Address *\/",365],["T_WHITESPACE","\n        ",365],["T_VARIABLE","$orderAddress",366],["T_WHITESPACE"," ",366],"=",["T_WHITESPACE"," ",366],["T_VARIABLE","$this",366],["T_OBJECT_OPERATOR","->",366],["T_STRING","_getVatRequiredSalesAddress",366],"(",["T_VARIABLE","$orderInstance",366],")",";",["T_WHITESPACE","\n        ",366],["T_IF","if",367],["T_WHITESPACE"," ",367],"(","!","(",["T_VARIABLE","$orderAddress",367],["T_WHITESPACE"," ",367],["T_INSTANCEOF","instanceof",367],["T_WHITESPACE"," ",367],["T_STRING","Mage_Sales_Model_Order_Address",367],")",")",["T_WHITESPACE"," ",367],"{",["T_WHITESPACE","\n            ",367],["T_RETURN","return",368],";",["T_WHITESPACE","\n        ",368],"}",["T_WHITESPACE","\n\n        ",369],["T_VARIABLE","$vatRequestId",371],["T_WHITESPACE"," ",371],"=",["T_WHITESPACE"," ",371],["T_VARIABLE","$orderAddress",371],["T_OBJECT_OPERATOR","->",371],["T_STRING","getVatRequestId",371],"(",")",";",["T_WHITESPACE","\n        ",371],["T_VARIABLE","$vatRequestDate",372],["T_WHITESPACE"," ",372],"=",["T_WHITESPACE"," ",372],["T_VARIABLE","$orderAddress",372],["T_OBJECT_OPERATOR","->",372],["T_STRING","getVatRequestDate",372],"(",")",";",["T_WHITESPACE","\n        ",372],["T_IF","if",373],["T_WHITESPACE"," ",373],"(",["T_STRING","is_string",373],"(",["T_VARIABLE","$vatRequestId",373],")",["T_WHITESPACE"," ",373],["T_BOOLEAN_AND","&&",373],["T_WHITESPACE"," ",373],"!",["T_EMPTY","empty",373],"(",["T_VARIABLE","$vatRequestId",373],")",["T_WHITESPACE"," ",373],["T_BOOLEAN_AND","&&",373],["T_WHITESPACE"," ",373],["T_STRING","is_string",373],"(",["T_VARIABLE","$vatRequestDate",373],")",["T_WHITESPACE","\n            ",373],["T_BOOLEAN_AND","&&",374],["T_WHITESPACE"," ",374],"!",["T_EMPTY","empty",374],"(",["T_VARIABLE","$vatRequestDate",374],")",["T_WHITESPACE","\n        ",374],")",["T_WHITESPACE"," ",375],"{",["T_WHITESPACE","\n            ",375],["T_VARIABLE","$orderHistoryComment",376],["T_WHITESPACE"," ",376],"=",["T_WHITESPACE"," ",376],["T_STRING","Mage",376],["T_DOUBLE_COLON","::",376],["T_STRING","helper",376],"(",["T_CONSTANT_ENCAPSED_STRING","'customer'",376],")",["T_OBJECT_OPERATOR","->",376],["T_STRING","__",376],"(",["T_CONSTANT_ENCAPSED_STRING","'VAT Request Identifier'",376],")",["T_WHITESPACE","\n                ",376],".",["T_WHITESPACE"," ",377],["T_CONSTANT_ENCAPSED_STRING","': '",377],["T_WHITESPACE"," ",377],".",["T_WHITESPACE"," ",377],["T_VARIABLE","$vatRequestId",377],["T_WHITESPACE"," ",377],".",["T_WHITESPACE"," ",377],["T_CONSTANT_ENCAPSED_STRING","'<br \/>'",377],["T_WHITESPACE"," ",377],".",["T_WHITESPACE"," ",377],["T_STRING","Mage",377],["T_DOUBLE_COLON","::",377],["T_STRING","helper",377],"(",["T_CONSTANT_ENCAPSED_STRING","'customer'",377],")",["T_OBJECT_OPERATOR","->",377],["T_STRING","__",377],"(",["T_CONSTANT_ENCAPSED_STRING","'VAT Request Date'",377],")",["T_WHITESPACE","\n                ",377],".",["T_WHITESPACE"," ",378],["T_CONSTANT_ENCAPSED_STRING","': '",378],["T_WHITESPACE"," ",378],".",["T_WHITESPACE"," ",378],["T_VARIABLE","$vatRequestDate",378],";",["T_WHITESPACE","\n            ",378],["T_VARIABLE","$orderInstance",379],["T_OBJECT_OPERATOR","->",379],["T_STRING","addStatusHistoryComment",379],"(",["T_VARIABLE","$orderHistoryComment",379],",",["T_WHITESPACE"," ",379],["T_STRING","false",379],")",";",["T_WHITESPACE","\n        ",379],"}",["T_WHITESPACE","\n    ",380],"}",["T_WHITESPACE","\n\n    ",381],["T_DOC_COMMENT","\/**\n     * Retrieve sales address (order or quote) on which tax calculation must be based\n     *\n     * @param Mage_Core_Model_Abstract $salesModel\n     * @param Mage_Core_Model_Store|string|int|null $store\n     * @return Mage_Customer_Model_Address_Abstract|null\n     *\/",383],["T_WHITESPACE","\n    ",389],["T_PROTECTED","protected",390],["T_WHITESPACE"," ",390],["T_FUNCTION","function",390],["T_WHITESPACE"," ",390],["T_STRING","_getVatRequiredSalesAddress",390],"(",["T_VARIABLE","$salesModel",390],",",["T_WHITESPACE"," ",390],["T_VARIABLE","$store",390],["T_WHITESPACE"," ",390],"=",["T_WHITESPACE"," ",390],["T_STRING","null",390],")",["T_WHITESPACE","\n    ",390],"{",["T_WHITESPACE","\n        ",391],["T_VARIABLE","$configAddressType",392],["T_WHITESPACE"," ",392],"=",["T_WHITESPACE"," ",392],["T_STRING","Mage",392],["T_DOUBLE_COLON","::",392],["T_STRING","helper",392],"(",["T_CONSTANT_ENCAPSED_STRING","'customer\/address'",392],")",["T_OBJECT_OPERATOR","->",392],["T_STRING","getTaxCalculationAddressType",392],"(",["T_VARIABLE","$store",392],")",";",["T_WHITESPACE","\n        ",392],["T_VARIABLE","$requiredAddress",393],["T_WHITESPACE"," ",393],"=",["T_WHITESPACE"," ",393],["T_STRING","null",393],";",["T_WHITESPACE","\n        ",393],["T_SWITCH","switch",394],["T_WHITESPACE"," ",394],"(",["T_VARIABLE","$configAddressType",394],")",["T_WHITESPACE"," ",394],"{",["T_WHITESPACE","\n            ",394],["T_CASE","case",395],["T_WHITESPACE"," ",395],["T_STRING","Mage_Customer_Model_Address_Abstract",395],["T_DOUBLE_COLON","::",395],["T_STRING","TYPE_SHIPPING",395],":",["T_WHITESPACE","\n                ",395],["T_VARIABLE","$requiredAddress",396],["T_WHITESPACE"," ",396],"=",["T_WHITESPACE"," ",396],["T_VARIABLE","$salesModel",396],["T_OBJECT_OPERATOR","->",396],["T_STRING","getShippingAddress",396],"(",")",";",["T_WHITESPACE","\n                ",396],["T_BREAK","break",397],";",["T_WHITESPACE","\n            ",397],["T_DEFAULT","default",398],":",["T_WHITESPACE","\n                ",398],["T_VARIABLE","$requiredAddress",399],["T_WHITESPACE"," ",399],"=",["T_WHITESPACE"," ",399],["T_VARIABLE","$salesModel",399],["T_OBJECT_OPERATOR","->",399],["T_STRING","getBillingAddress",399],"(",")",";",["T_WHITESPACE","\n        ",399],"}",["T_WHITESPACE","\n        ",400],["T_RETURN","return",401],["T_WHITESPACE"," ",401],["T_VARIABLE","$requiredAddress",401],";",["T_WHITESPACE","\n    ",401],"}",["T_WHITESPACE","\n\n    ",402],["T_DOC_COMMENT","\/**\n     * Retrieve customer address (default billing or default shipping) ID on which tax calculation must be based\n     *\n     * @param Mage_Customer_Model_Customer $customer\n     * @param Mage_Core_Model_Store|string|int|null $store\n     * @return int|string\n     *\/",404],["T_WHITESPACE","\n    ",410],["T_PROTECTED","protected",411],["T_WHITESPACE"," ",411],["T_FUNCTION","function",411],["T_WHITESPACE"," ",411],["T_STRING","_getVatRequiredCustomerAddress",411],"(",["T_STRING","Mage_Customer_Model_Customer",411],["T_WHITESPACE"," ",411],["T_VARIABLE","$customer",411],",",["T_WHITESPACE"," ",411],["T_VARIABLE","$store",411],["T_WHITESPACE"," ",411],"=",["T_WHITESPACE"," ",411],["T_STRING","null",411],")",["T_WHITESPACE","\n    ",411],"{",["T_WHITESPACE","\n        ",412],["T_VARIABLE","$configAddressType",413],["T_WHITESPACE"," ",413],"=",["T_WHITESPACE"," ",413],["T_STRING","Mage",413],["T_DOUBLE_COLON","::",413],["T_STRING","helper",413],"(",["T_CONSTANT_ENCAPSED_STRING","'customer\/address'",413],")",["T_OBJECT_OPERATOR","->",413],["T_STRING","getTaxCalculationAddressType",413],"(",["T_VARIABLE","$store",413],")",";",["T_WHITESPACE","\n        ",413],["T_VARIABLE","$requiredAddress",414],["T_WHITESPACE"," ",414],"=",["T_WHITESPACE"," ",414],["T_STRING","null",414],";",["T_WHITESPACE","\n        ",414],["T_SWITCH","switch",415],["T_WHITESPACE"," ",415],"(",["T_VARIABLE","$configAddressType",415],")",["T_WHITESPACE"," ",415],"{",["T_WHITESPACE","\n            ",415],["T_CASE","case",416],["T_WHITESPACE"," ",416],["T_STRING","Mage_Customer_Model_Address_Abstract",416],["T_DOUBLE_COLON","::",416],["T_STRING","TYPE_SHIPPING",416],":",["T_WHITESPACE","\n                ",416],["T_VARIABLE","$requiredAddress",417],["T_WHITESPACE"," ",417],"=",["T_WHITESPACE"," ",417],["T_VARIABLE","$customer",417],["T_OBJECT_OPERATOR","->",417],["T_STRING","getDefaultShipping",417],"(",")",";",["T_WHITESPACE","\n                ",417],["T_BREAK","break",418],";",["T_WHITESPACE","\n            ",418],["T_DEFAULT","default",419],":",["T_WHITESPACE","\n                ",419],["T_VARIABLE","$requiredAddress",420],["T_WHITESPACE"," ",420],"=",["T_WHITESPACE"," ",420],["T_VARIABLE","$customer",420],["T_OBJECT_OPERATOR","->",420],["T_STRING","getDefaultBilling",420],"(",")",";",["T_WHITESPACE","\n        ",420],"}",["T_WHITESPACE","\n        ",421],["T_RETURN","return",422],["T_WHITESPACE"," ",422],["T_VARIABLE","$requiredAddress",422],";",["T_WHITESPACE","\n    ",422],"}",["T_WHITESPACE","\n\n    ",423],["T_DOC_COMMENT","\/**\n     * Handle customer VAT number if needed on collect_totals_before event of quote address\n     *\n     * @param Varien_Event_Observer $observer\n     *\/",425],["T_WHITESPACE","\n    ",429],["T_PUBLIC","public",430],["T_WHITESPACE"," ",430],["T_FUNCTION","function",430],["T_WHITESPACE"," ",430],["T_STRING","changeQuoteCustomerGroupId",430],"(",["T_STRING","Varien_Event_Observer",430],["T_WHITESPACE"," ",430],["T_VARIABLE","$observer",430],")",["T_WHITESPACE","\n    ",430],"{",["T_WHITESPACE","\n        ",431],["T_DOC_COMMENT","\/** @var $addressHelper Mage_Customer_Helper_Address *\/",432],["T_WHITESPACE","\n        ",432],["T_VARIABLE","$addressHelper",433],["T_WHITESPACE"," ",433],"=",["T_WHITESPACE"," ",433],["T_STRING","Mage",433],["T_DOUBLE_COLON","::",433],["T_STRING","helper",433],"(",["T_CONSTANT_ENCAPSED_STRING","'customer\/address'",433],")",";",["T_WHITESPACE","\n\n        ",433],["T_VARIABLE","$quoteAddress",435],["T_WHITESPACE"," ",435],"=",["T_WHITESPACE"," ",435],["T_VARIABLE","$observer",435],["T_OBJECT_OPERATOR","->",435],["T_STRING","getQuoteAddress",435],"(",")",";",["T_WHITESPACE","\n        ",435],["T_VARIABLE","$quoteInstance",436],["T_WHITESPACE"," ",436],"=",["T_WHITESPACE"," ",436],["T_VARIABLE","$quoteAddress",436],["T_OBJECT_OPERATOR","->",436],["T_STRING","getQuote",436],"(",")",";",["T_WHITESPACE","\n        ",436],["T_VARIABLE","$customerInstance",437],["T_WHITESPACE"," ",437],"=",["T_WHITESPACE"," ",437],["T_VARIABLE","$quoteInstance",437],["T_OBJECT_OPERATOR","->",437],["T_STRING","getCustomer",437],"(",")",";",["T_WHITESPACE","\n        ",437],["T_VARIABLE","$isDisableAutoGroupChange",438],["T_WHITESPACE"," ",438],"=",["T_WHITESPACE"," ",438],["T_VARIABLE","$customerInstance",438],["T_OBJECT_OPERATOR","->",438],["T_STRING","getDisableAutoGroupChange",438],"(",")",";",["T_WHITESPACE","\n\n        ",438],["T_VARIABLE","$storeId",440],["T_WHITESPACE"," ",440],"=",["T_WHITESPACE"," ",440],["T_VARIABLE","$customerInstance",440],["T_OBJECT_OPERATOR","->",440],["T_STRING","getStore",440],"(",")",";",["T_WHITESPACE","\n\n        ",440],["T_VARIABLE","$configAddressType",442],["T_WHITESPACE"," ",442],"=",["T_WHITESPACE"," ",442],["T_STRING","Mage",442],["T_DOUBLE_COLON","::",442],["T_STRING","helper",442],"(",["T_CONSTANT_ENCAPSED_STRING","'customer\/address'",442],")",["T_OBJECT_OPERATOR","->",442],["T_STRING","getTaxCalculationAddressType",442],"(",["T_VARIABLE","$storeId",442],")",";",["T_WHITESPACE","\n\n        ",442],["T_COMMENT","\/\/ When VAT is based on billing address then Magento have to handle only billing addresses\n",444],["T_WHITESPACE","        ",445],["T_VARIABLE","$additionalBillingAddressCondition",445],["T_WHITESPACE"," ",445],"=",["T_WHITESPACE"," ",445],"(",["T_VARIABLE","$configAddressType",445],["T_WHITESPACE"," ",445],["T_IS_EQUAL","==",445],["T_WHITESPACE"," ",445],["T_STRING","Mage_Customer_Model_Address_Abstract",445],["T_DOUBLE_COLON","::",445],["T_STRING","TYPE_BILLING",445],")",["T_WHITESPACE","\n            ",445],"?",["T_WHITESPACE"," ",446],["T_VARIABLE","$configAddressType",446],["T_WHITESPACE"," ",446],["T_IS_NOT_EQUAL","!=",446],["T_WHITESPACE"," ",446],["T_VARIABLE","$quoteAddress",446],["T_OBJECT_OPERATOR","->",446],["T_STRING","getAddressType",446],"(",")",["T_WHITESPACE"," ",446],":",["T_WHITESPACE"," ",446],["T_STRING","false",446],";",["T_WHITESPACE","\n        ",446],["T_COMMENT","\/\/ Handle only addresses that corresponds to VAT configuration\n",447],["T_WHITESPACE","        ",448],["T_IF","if",448],["T_WHITESPACE"," ",448],"(","!",["T_VARIABLE","$addressHelper",448],["T_OBJECT_OPERATOR","->",448],["T_STRING","isVatValidationEnabled",448],"(",["T_VARIABLE","$storeId",448],")",["T_WHITESPACE"," ",448],["T_BOOLEAN_OR","||",448],["T_WHITESPACE"," ",448],["T_VARIABLE","$additionalBillingAddressCondition",448],")",["T_WHITESPACE"," ",448],"{",["T_WHITESPACE","\n            ",448],["T_RETURN","return",449],";",["T_WHITESPACE","\n        ",449],"}",["T_WHITESPACE","\n\n        ",450],["T_DOC_COMMENT","\/** @var $customerHelper Mage_Customer_Helper_Data *\/",452],["T_WHITESPACE","\n        ",452],["T_VARIABLE","$customerHelper",453],["T_WHITESPACE"," ",453],"=",["T_WHITESPACE"," ",453],["T_STRING","Mage",453],["T_DOUBLE_COLON","::",453],["T_STRING","helper",453],"(",["T_CONSTANT_ENCAPSED_STRING","'customer'",453],")",";",["T_WHITESPACE","\n\n        ",453],["T_VARIABLE","$customerCountryCode",455],["T_WHITESPACE"," ",455],"=",["T_WHITESPACE"," ",455],["T_VARIABLE","$quoteAddress",455],["T_OBJECT_OPERATOR","->",455],["T_STRING","getCountryId",455],"(",")",";",["T_WHITESPACE","\n        ",455],["T_VARIABLE","$customerVatNumber",456],["T_WHITESPACE"," ",456],"=",["T_WHITESPACE"," ",456],["T_VARIABLE","$quoteAddress",456],["T_OBJECT_OPERATOR","->",456],["T_STRING","getVatId",456],"(",")",";",["T_WHITESPACE","\n\n        ",456],["T_IF","if",458],["T_WHITESPACE"," ",458],"(","(",["T_EMPTY","empty",458],"(",["T_VARIABLE","$customerVatNumber",458],")",["T_WHITESPACE"," ",458],["T_BOOLEAN_OR","||",458],["T_WHITESPACE"," ",458],"!",["T_STRING","Mage",458],["T_DOUBLE_COLON","::",458],["T_STRING","helper",458],"(",["T_CONSTANT_ENCAPSED_STRING","'core'",458],")",["T_OBJECT_OPERATOR","->",458],["T_STRING","isCountryInEU",458],"(",["T_VARIABLE","$customerCountryCode",458],")",")",["T_WHITESPACE","\n            ",458],["T_BOOLEAN_AND","&&",459],["T_WHITESPACE"," ",459],"!",["T_VARIABLE","$isDisableAutoGroupChange",459],["T_WHITESPACE","\n        ",459],")",["T_WHITESPACE"," ",460],"{",["T_WHITESPACE","\n            ",460],["T_VARIABLE","$groupId",461],["T_WHITESPACE"," ",461],"=",["T_WHITESPACE"," ",461],"(",["T_VARIABLE","$customerInstance",461],["T_OBJECT_OPERATOR","->",461],["T_STRING","getId",461],"(",")",")",["T_WHITESPACE"," ",461],"?",["T_WHITESPACE"," ",461],["T_VARIABLE","$customerHelper",461],["T_OBJECT_OPERATOR","->",461],["T_STRING","getDefaultCustomerGroupId",461],"(",["T_VARIABLE","$storeId",461],")",["T_WHITESPACE","\n                ",461],":",["T_WHITESPACE"," ",462],["T_STRING","Mage_Customer_Model_Group",462],["T_DOUBLE_COLON","::",462],["T_STRING","NOT_LOGGED_IN_ID",462],";",["T_WHITESPACE","\n\n            ",462],["T_VARIABLE","$quoteAddress",464],["T_OBJECT_OPERATOR","->",464],["T_STRING","setPrevQuoteCustomerGroupId",464],"(",["T_VARIABLE","$quoteInstance",464],["T_OBJECT_OPERATOR","->",464],["T_STRING","getCustomerGroupId",464],"(",")",")",";",["T_WHITESPACE","\n            ",464],["T_VARIABLE","$customerInstance",465],["T_OBJECT_OPERATOR","->",465],["T_STRING","setGroupId",465],"(",["T_VARIABLE","$groupId",465],")",";",["T_WHITESPACE","\n            ",465],["T_VARIABLE","$quoteInstance",466],["T_OBJECT_OPERATOR","->",466],["T_STRING","setCustomerGroupId",466],"(",["T_VARIABLE","$groupId",466],")",";",["T_WHITESPACE","\n\n            ",466],["T_RETURN","return",468],";",["T_WHITESPACE","\n        ",468],"}",["T_WHITESPACE","\n\n        ",469],["T_DOC_COMMENT","\/** @var $coreHelper Mage_Core_Helper_Data *\/",471],["T_WHITESPACE","\n        ",471],["T_VARIABLE","$coreHelper",472],["T_WHITESPACE"," ",472],"=",["T_WHITESPACE"," ",472],["T_STRING","Mage",472],["T_DOUBLE_COLON","::",472],["T_STRING","helper",472],"(",["T_CONSTANT_ENCAPSED_STRING","'core'",472],")",";",["T_WHITESPACE","\n        ",472],["T_VARIABLE","$merchantCountryCode",473],["T_WHITESPACE"," ",473],"=",["T_WHITESPACE"," ",473],["T_VARIABLE","$coreHelper",473],["T_OBJECT_OPERATOR","->",473],["T_STRING","getMerchantCountryCode",473],"(",")",";",["T_WHITESPACE","\n        ",473],["T_VARIABLE","$merchantVatNumber",474],["T_WHITESPACE"," ",474],"=",["T_WHITESPACE"," ",474],["T_VARIABLE","$coreHelper",474],["T_OBJECT_OPERATOR","->",474],["T_STRING","getMerchantVatNumber",474],"(",")",";",["T_WHITESPACE","\n\n        ",474],["T_VARIABLE","$gatewayResponse",476],["T_WHITESPACE"," ",476],"=",["T_WHITESPACE"," ",476],["T_STRING","null",476],";",["T_WHITESPACE","\n        ",476],["T_IF","if",477],["T_WHITESPACE"," ",477],"(",["T_VARIABLE","$addressHelper",477],["T_OBJECT_OPERATOR","->",477],["T_STRING","getValidateOnEachTransaction",477],"(",["T_VARIABLE","$storeId",477],")",["T_WHITESPACE","\n            ",477],["T_BOOLEAN_OR","||",478],["T_WHITESPACE"," ",478],["T_VARIABLE","$customerCountryCode",478],["T_WHITESPACE"," ",478],["T_IS_NOT_EQUAL","!=",478],["T_WHITESPACE"," ",478],["T_VARIABLE","$quoteAddress",478],["T_OBJECT_OPERATOR","->",478],["T_STRING","getValidatedCountryCode",478],"(",")",["T_WHITESPACE","\n            ",478],["T_BOOLEAN_OR","||",479],["T_WHITESPACE"," ",479],["T_VARIABLE","$customerVatNumber",479],["T_WHITESPACE"," ",479],["T_IS_NOT_EQUAL","!=",479],["T_WHITESPACE"," ",479],["T_VARIABLE","$quoteAddress",479],["T_OBJECT_OPERATOR","->",479],["T_STRING","getValidatedVatNumber",479],"(",")",["T_WHITESPACE","\n        ",479],")",["T_WHITESPACE"," ",480],"{",["T_WHITESPACE","\n            ",480],["T_COMMENT","\/\/ Send request to gateway\n",481],["T_WHITESPACE","            ",482],["T_VARIABLE","$gatewayResponse",482],["T_WHITESPACE"," ",482],"=",["T_WHITESPACE"," ",482],["T_VARIABLE","$customerHelper",482],["T_OBJECT_OPERATOR","->",482],["T_STRING","checkVatNumber",482],"(",["T_WHITESPACE","\n                ",482],["T_VARIABLE","$customerCountryCode",483],",",["T_WHITESPACE","\n                ",483],["T_VARIABLE","$customerVatNumber",484],",",["T_WHITESPACE","\n                ",484],"(",["T_VARIABLE","$merchantVatNumber",485],["T_WHITESPACE"," ",485],["T_IS_NOT_IDENTICAL","!==",485],["T_WHITESPACE"," ",485],["T_CONSTANT_ENCAPSED_STRING","''",485],")",["T_WHITESPACE"," ",485],"?",["T_WHITESPACE"," ",485],["T_VARIABLE","$merchantCountryCode",485],["T_WHITESPACE"," ",485],":",["T_WHITESPACE"," ",485],["T_CONSTANT_ENCAPSED_STRING","''",485],",",["T_WHITESPACE","\n                ",485],["T_VARIABLE","$merchantVatNumber",486],["T_WHITESPACE","\n            ",486],")",";",["T_WHITESPACE","\n\n            ",487],["T_COMMENT","\/\/ Store validation results in corresponding quote address\n",489],["T_WHITESPACE","            ",490],["T_VARIABLE","$quoteAddress",490],["T_OBJECT_OPERATOR","->",490],["T_STRING","setVatIsValid",490],"(",["T_INT_CAST","(int)",490],["T_VARIABLE","$gatewayResponse",490],["T_OBJECT_OPERATOR","->",490],["T_STRING","getIsValid",490],"(",")",")",["T_WHITESPACE","\n                ",490],["T_OBJECT_OPERATOR","->",491],["T_STRING","setVatRequestId",491],"(",["T_VARIABLE","$gatewayResponse",491],["T_OBJECT_OPERATOR","->",491],["T_STRING","getRequestIdentifier",491],"(",")",")",["T_WHITESPACE","\n                ",491],["T_OBJECT_OPERATOR","->",492],["T_STRING","setVatRequestDate",492],"(",["T_VARIABLE","$gatewayResponse",492],["T_OBJECT_OPERATOR","->",492],["T_STRING","getRequestDate",492],"(",")",")",["T_WHITESPACE","\n                ",492],["T_OBJECT_OPERATOR","->",493],["T_STRING","setVatRequestSuccess",493],"(",["T_VARIABLE","$gatewayResponse",493],["T_OBJECT_OPERATOR","->",493],["T_STRING","getRequestSuccess",493],"(",")",")",["T_WHITESPACE","\n                ",493],["T_OBJECT_OPERATOR","->",494],["T_STRING","setValidatedVatNumber",494],"(",["T_VARIABLE","$customerVatNumber",494],")",["T_WHITESPACE","\n                ",494],["T_OBJECT_OPERATOR","->",495],["T_STRING","setValidatedCountryCode",495],"(",["T_VARIABLE","$customerCountryCode",495],")",["T_WHITESPACE","\n                ",495],["T_OBJECT_OPERATOR","->",496],["T_STRING","save",496],"(",")",";",["T_WHITESPACE","\n        ",496],"}",["T_WHITESPACE"," ",497],["T_ELSE","else",497],["T_WHITESPACE"," ",497],"{",["T_WHITESPACE","\n            ",497],["T_COMMENT","\/\/ Restore validation results from corresponding quote address\n",498],["T_WHITESPACE","            ",499],["T_VARIABLE","$gatewayResponse",499],["T_WHITESPACE"," ",499],"=",["T_WHITESPACE"," ",499],["T_NEW","new",499],["T_WHITESPACE"," ",499],["T_STRING","Varien_Object",499],"(",["T_ARRAY","array",499],"(",["T_WHITESPACE","\n                ",499],["T_CONSTANT_ENCAPSED_STRING","'is_valid'",500],["T_WHITESPACE"," ",500],["T_DOUBLE_ARROW","=>",500],["T_WHITESPACE"," ",500],["T_INT_CAST","(int)",500],["T_VARIABLE","$quoteAddress",500],["T_OBJECT_OPERATOR","->",500],["T_STRING","getVatIsValid",500],"(",")",",",["T_WHITESPACE","\n                ",500],["T_CONSTANT_ENCAPSED_STRING","'request_identifier'",501],["T_WHITESPACE"," ",501],["T_DOUBLE_ARROW","=>",501],["T_WHITESPACE"," ",501],["T_STRING_CAST","(string)",501],["T_VARIABLE","$quoteAddress",501],["T_OBJECT_OPERATOR","->",501],["T_STRING","getVatRequestId",501],"(",")",",",["T_WHITESPACE","\n                ",501],["T_CONSTANT_ENCAPSED_STRING","'request_date'",502],["T_WHITESPACE"," ",502],["T_DOUBLE_ARROW","=>",502],["T_WHITESPACE"," ",502],["T_STRING_CAST","(string)",502],["T_VARIABLE","$quoteAddress",502],["T_OBJECT_OPERATOR","->",502],["T_STRING","getVatRequestDate",502],"(",")",",",["T_WHITESPACE","\n                ",502],["T_CONSTANT_ENCAPSED_STRING","'request_success'",503],["T_WHITESPACE"," ",503],["T_DOUBLE_ARROW","=>",503],["T_WHITESPACE"," ",503],["T_BOOL_CAST","(boolean)",503],["T_VARIABLE","$quoteAddress",503],["T_OBJECT_OPERATOR","->",503],["T_STRING","getVatRequestSuccess",503],"(",")",["T_WHITESPACE","\n            ",503],")",")",";",["T_WHITESPACE","\n        ",504],"}",["T_WHITESPACE","\n\n        ",505],["T_COMMENT","\/\/ Magento always has to emulate group even if customer uses default billing\/shipping address\n",507],["T_WHITESPACE","        ",508],["T_IF","if",508],["T_WHITESPACE"," ",508],"(","!",["T_VARIABLE","$isDisableAutoGroupChange",508],")",["T_WHITESPACE"," ",508],"{",["T_WHITESPACE","\n            ",508],["T_VARIABLE","$groupId",509],["T_WHITESPACE"," ",509],"=",["T_WHITESPACE"," ",509],["T_VARIABLE","$customerHelper",509],["T_OBJECT_OPERATOR","->",509],["T_STRING","getCustomerGroupIdBasedOnVatNumber",509],"(",["T_WHITESPACE","\n                ",509],["T_VARIABLE","$customerCountryCode",510],",",["T_WHITESPACE"," ",510],["T_VARIABLE","$gatewayResponse",510],",",["T_WHITESPACE"," ",510],["T_VARIABLE","$customerInstance",510],["T_OBJECT_OPERATOR","->",510],["T_STRING","getStore",510],"(",")",["T_WHITESPACE","\n            ",510],")",";",["T_WHITESPACE","\n        ",511],"}",["T_WHITESPACE"," ",512],["T_ELSE","else",512],["T_WHITESPACE"," ",512],"{",["T_WHITESPACE","\n            ",512],["T_VARIABLE","$groupId",513],["T_WHITESPACE"," ",513],"=",["T_WHITESPACE"," ",513],["T_VARIABLE","$quoteInstance",513],["T_OBJECT_OPERATOR","->",513],["T_STRING","getCustomerGroupId",513],"(",")",";",["T_WHITESPACE","\n        ",513],"}",["T_WHITESPACE","\n\n        ",514],["T_IF","if",516],["T_WHITESPACE"," ",516],"(",["T_VARIABLE","$groupId",516],")",["T_WHITESPACE"," ",516],"{",["T_WHITESPACE","\n            ",516],["T_VARIABLE","$quoteAddress",517],["T_OBJECT_OPERATOR","->",517],["T_STRING","setPrevQuoteCustomerGroupId",517],"(",["T_VARIABLE","$quoteInstance",517],["T_OBJECT_OPERATOR","->",517],["T_STRING","getCustomerGroupId",517],"(",")",")",";",["T_WHITESPACE","\n            ",517],["T_VARIABLE","$customerInstance",518],["T_OBJECT_OPERATOR","->",518],["T_STRING","setGroupId",518],"(",["T_VARIABLE","$groupId",518],")",";",["T_WHITESPACE","\n            ",518],["T_VARIABLE","$quoteInstance",519],["T_OBJECT_OPERATOR","->",519],["T_STRING","setCustomerGroupId",519],"(",["T_VARIABLE","$groupId",519],")",";",["T_WHITESPACE","\n        ",519],"}",["T_WHITESPACE","\n    ",520],"}",["T_WHITESPACE","\n\n    ",521],["T_DOC_COMMENT","\/**\n     * Restore initial customer group ID in quote if needed on collect_totals_after event of quote address\n     *\n     * @param Varien_Event_Observer $observer\n     *\/",523],["T_WHITESPACE","\n    ",527],["T_PUBLIC","public",528],["T_WHITESPACE"," ",528],["T_FUNCTION","function",528],["T_WHITESPACE"," ",528],["T_STRING","restoreQuoteCustomerGroupId",528],"(",["T_VARIABLE","$observer",528],")",["T_WHITESPACE","\n    ",528],"{",["T_WHITESPACE","\n        ",529],["T_VARIABLE","$quoteAddress",530],["T_WHITESPACE"," ",530],"=",["T_WHITESPACE"," ",530],["T_VARIABLE","$observer",530],["T_OBJECT_OPERATOR","->",530],["T_STRING","getQuoteAddress",530],"(",")",";",["T_WHITESPACE","\n        ",530],["T_VARIABLE","$configAddressType",531],["T_WHITESPACE"," ",531],"=",["T_WHITESPACE"," ",531],["T_STRING","Mage",531],["T_DOUBLE_COLON","::",531],["T_STRING","helper",531],"(",["T_CONSTANT_ENCAPSED_STRING","'customer\/address'",531],")",["T_OBJECT_OPERATOR","->",531],["T_STRING","getTaxCalculationAddressType",531],"(",")",";",["T_WHITESPACE","\n        ",531],["T_COMMENT","\/\/ Restore initial customer group ID in quote only if VAT is calculated based on shipping address\n",532],["T_WHITESPACE","        ",533],["T_IF","if",533],["T_WHITESPACE"," ",533],"(",["T_VARIABLE","$quoteAddress",533],["T_OBJECT_OPERATOR","->",533],["T_STRING","hasPrevQuoteCustomerGroupId",533],"(",")",["T_WHITESPACE","\n            ",533],["T_BOOLEAN_AND","&&",534],["T_WHITESPACE"," ",534],["T_VARIABLE","$configAddressType",534],["T_WHITESPACE"," ",534],["T_IS_EQUAL","==",534],["T_WHITESPACE"," ",534],["T_STRING","Mage_Customer_Model_Address_Abstract",534],["T_DOUBLE_COLON","::",534],["T_STRING","TYPE_SHIPPING",534],["T_WHITESPACE","\n        ",534],")",["T_WHITESPACE"," ",535],"{",["T_WHITESPACE","\n            ",535],["T_VARIABLE","$quoteAddress",536],["T_OBJECT_OPERATOR","->",536],["T_STRING","getQuote",536],"(",")",["T_OBJECT_OPERATOR","->",536],["T_STRING","setCustomerGroupId",536],"(",["T_VARIABLE","$quoteAddress",536],["T_OBJECT_OPERATOR","->",536],["T_STRING","getPrevQuoteCustomerGroupId",536],"(",")",")",";",["T_WHITESPACE","\n            ",536],["T_VARIABLE","$quoteAddress",537],["T_OBJECT_OPERATOR","->",537],["T_STRING","unsPrevQuoteCustomerGroupId",537],"(",")",";",["T_WHITESPACE","\n        ",537],"}",["T_WHITESPACE","\n    ",538],"}",["T_WHITESPACE","\n",539],"}",["T_WHITESPACE","\n",540]]