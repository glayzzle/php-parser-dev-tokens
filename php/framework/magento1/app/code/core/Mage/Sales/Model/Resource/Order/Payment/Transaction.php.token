[["T_OPEN_TAG","<?php\n",1],["T_DOC_COMMENT","\/**\n * Magento\n *\n * NOTICE OF LICENSE\n *\n * This source file is subject to the Open Software License (OSL 3.0)\n * that is bundled with this package in the file LICENSE.txt.\n * It is also available through the world-wide-web at this URL:\n * http:\/\/opensource.org\/licenses\/osl-3.0.php\n * If you did not receive a copy of the license and are unable to\n * obtain it through the world-wide-web, please send an email\n * to license@magento.com so we can send you a copy immediately.\n *\n * DISCLAIMER\n *\n * Do not edit or add to this file if you wish to upgrade Magento to newer\n * versions in the future. If you wish to customize Magento for your\n * needs please refer to http:\/\/www.magento.com for more information.\n *\n * @category    Mage\n * @package     Mage_Sales\n * @copyright  Copyright (c) 2006-2016 X.commerce, Inc. and affiliates (http:\/\/www.magento.com)\n * @license    http:\/\/opensource.org\/licenses\/osl-3.0.php  Open Software License (OSL 3.0)\n *\/",2],["T_WHITESPACE","\n\n\n",25],["T_DOC_COMMENT","\/**\n * Sales transaction resource model\n *\n * @category    Mage\n * @package     Mage_Sales\n * @author      Magento Core Team <core@magentocommerce.com>\n *\/",28],["T_WHITESPACE","\n",34],["T_CLASS","class",35],["T_WHITESPACE"," ",35],["T_STRING","Mage_Sales_Model_Resource_Order_Payment_Transaction",35],["T_WHITESPACE"," ",35],["T_EXTENDS","extends",35],["T_WHITESPACE"," ",35],["T_STRING","Mage_Sales_Model_Resource_Order_Abstract",35],["T_WHITESPACE","\n",35],"{",["T_WHITESPACE","\n    ",36],["T_DOC_COMMENT","\/**\n     * Serializeable field: additional_information\n     *\n     * @var array\n     *\/",37],["T_WHITESPACE","\n    ",41],["T_PROTECTED","protected",42],["T_WHITESPACE"," ",42],["T_VARIABLE","$_serializableFields",42],["T_WHITESPACE","   ",42],"=",["T_WHITESPACE"," ",42],["T_ARRAY","array",42],"(",["T_WHITESPACE","\n        ",42],["T_CONSTANT_ENCAPSED_STRING","'additional_information'",43],["T_WHITESPACE"," ",43],["T_DOUBLE_ARROW","=>",43],["T_WHITESPACE"," ",43],["T_ARRAY","array",43],"(",["T_STRING","null",43],",",["T_WHITESPACE"," ",43],["T_ARRAY","array",43],"(",")",")",["T_WHITESPACE","\n    ",43],")",";",["T_WHITESPACE","\n\n    ",44],["T_DOC_COMMENT","\/**\n     * Initialize main table and the primary key field name\n     *\n     *\/",46],["T_WHITESPACE","\n    ",49],["T_PROTECTED","protected",50],["T_WHITESPACE"," ",50],["T_FUNCTION","function",50],["T_WHITESPACE"," ",50],["T_STRING","_construct",50],"(",")",["T_WHITESPACE","\n    ",50],"{",["T_WHITESPACE","\n        ",51],["T_VARIABLE","$this",52],["T_OBJECT_OPERATOR","->",52],["T_STRING","_init",52],"(",["T_CONSTANT_ENCAPSED_STRING","'sales\/payment_transaction'",52],",",["T_WHITESPACE"," ",52],["T_CONSTANT_ENCAPSED_STRING","'transaction_id'",52],")",";",["T_WHITESPACE","\n    ",52],"}",["T_WHITESPACE","\n\n    ",53],["T_DOC_COMMENT","\/**\n     * Unserialize Varien_Object field in an object\n     *\n     * @param Mage_Core_Model_Abstract $object\n     * @param string $field\n     * @param mixed $defaultValue\n     *\/",55],["T_WHITESPACE","\n    ",61],["T_PROTECTED","protected",62],["T_WHITESPACE"," ",62],["T_FUNCTION","function",62],["T_WHITESPACE"," ",62],["T_STRING","_unserializeField",62],"(",["T_STRING","Varien_Object",62],["T_WHITESPACE"," ",62],["T_VARIABLE","$object",62],",",["T_WHITESPACE"," ",62],["T_VARIABLE","$field",62],",",["T_WHITESPACE"," ",62],["T_VARIABLE","$defaultValue",62],["T_WHITESPACE"," ",62],"=",["T_WHITESPACE"," ",62],["T_STRING","null",62],")",["T_WHITESPACE","\n    ",62],"{",["T_WHITESPACE","\n        ",63],["T_VARIABLE","$value",64],["T_WHITESPACE"," ",64],"=",["T_WHITESPACE"," ",64],["T_VARIABLE","$object",64],["T_OBJECT_OPERATOR","->",64],["T_STRING","getData",64],"(",["T_VARIABLE","$field",64],")",";",["T_WHITESPACE","\n        ",64],["T_IF","if",65],["T_WHITESPACE"," ",65],"(",["T_EMPTY","empty",65],"(",["T_VARIABLE","$value",65],")",")",["T_WHITESPACE"," ",65],"{",["T_WHITESPACE","\n            ",65],["T_VARIABLE","$object",66],["T_OBJECT_OPERATOR","->",66],["T_STRING","setData",66],"(",["T_VARIABLE","$field",66],",",["T_WHITESPACE"," ",66],["T_VARIABLE","$defaultValue",66],")",";",["T_WHITESPACE","\n        ",66],"}",["T_WHITESPACE"," ",67],["T_ELSEIF","elseif",67],["T_WHITESPACE"," ",67],"(","!",["T_STRING","is_array",67],"(",["T_VARIABLE","$value",67],")",["T_WHITESPACE"," ",67],["T_BOOLEAN_AND","&&",67],["T_WHITESPACE"," ",67],"!",["T_STRING","is_object",67],"(",["T_VARIABLE","$value",67],")",")",["T_WHITESPACE"," ",67],"{",["T_WHITESPACE","\n            ",67],["T_VARIABLE","$unserializedValue",68],["T_WHITESPACE"," ",68],"=",["T_WHITESPACE"," ",68],["T_STRING","false",68],";",["T_WHITESPACE","\n            ",68],["T_TRY","try",69],["T_WHITESPACE"," ",69],"{",["T_WHITESPACE","\n                ",69],["T_VARIABLE","$unserializedValue",70],["T_WHITESPACE"," ",70],"=",["T_WHITESPACE"," ",70],["T_STRING","Mage",70],["T_DOUBLE_COLON","::",70],["T_STRING","helper",70],"(",["T_CONSTANT_ENCAPSED_STRING","'core\/unserializeArray'",70],")",["T_WHITESPACE","\n                ",70],["T_OBJECT_OPERATOR","->",71],["T_STRING","unserialize",71],"(",["T_VARIABLE","$value",71],")",";",["T_WHITESPACE","\n            ",71],"}",["T_WHITESPACE"," ",72],["T_CATCH","catch",72],["T_WHITESPACE"," ",72],"(",["T_STRING","Exception",72],["T_WHITESPACE"," ",72],["T_VARIABLE","$e",72],")",["T_WHITESPACE"," ",72],"{",["T_WHITESPACE","\n                ",72],["T_STRING","Mage",73],["T_DOUBLE_COLON","::",73],["T_STRING","logException",73],"(",["T_VARIABLE","$e",73],")",";",["T_WHITESPACE","\n            ",73],"}",["T_WHITESPACE","\n            ",74],["T_VARIABLE","$object",75],["T_OBJECT_OPERATOR","->",75],["T_STRING","setData",75],"(",["T_VARIABLE","$field",75],",",["T_WHITESPACE"," ",75],["T_VARIABLE","$unserializedValue",75],")",";",["T_WHITESPACE","\n        ",75],"}",["T_WHITESPACE","\n    ",76],"}",["T_WHITESPACE","\n\n    ",77],["T_DOC_COMMENT","\/**\n     * Update transactions in database using provided transaction as parent for them\n     * have to repeat the business logic to avoid accidental injection of wrong transactions\n     *\n     * @param Mage_Sales_Model_Order_Payment_Transaction $transaction\n     *\/",79],["T_WHITESPACE","\n    ",84],["T_PUBLIC","public",85],["T_WHITESPACE"," ",85],["T_FUNCTION","function",85],["T_WHITESPACE"," ",85],["T_STRING","injectAsParent",85],"(",["T_STRING","Mage_Sales_Model_Order_Payment_Transaction",85],["T_WHITESPACE"," ",85],["T_VARIABLE","$transaction",85],")",["T_WHITESPACE","\n    ",85],"{",["T_WHITESPACE","\n        ",86],["T_VARIABLE","$txnId",87],["T_WHITESPACE"," ",87],"=",["T_WHITESPACE"," ",87],["T_VARIABLE","$transaction",87],["T_OBJECT_OPERATOR","->",87],["T_STRING","getTxnId",87],"(",")",";",["T_WHITESPACE","\n        ",87],["T_IF","if",88],["T_WHITESPACE"," ",88],"(",["T_VARIABLE","$txnId",88],["T_WHITESPACE"," ",88],["T_BOOLEAN_AND","&&",88],["T_WHITESPACE"," ",88],["T_STRING","Mage_Sales_Model_Order_Payment_Transaction",88],["T_DOUBLE_COLON","::",88],["T_STRING","TYPE_PAYMENT",88],["T_WHITESPACE"," ",88],["T_IS_IDENTICAL","===",88],["T_WHITESPACE"," ",88],["T_VARIABLE","$transaction",88],["T_OBJECT_OPERATOR","->",88],["T_STRING","getTxnType",88],"(",")",["T_WHITESPACE","\n            ",88],["T_BOOLEAN_AND","&&",89],["T_WHITESPACE"," ",89],["T_VARIABLE","$id",89],["T_WHITESPACE"," ",89],"=",["T_WHITESPACE"," ",89],["T_VARIABLE","$transaction",89],["T_OBJECT_OPERATOR","->",89],["T_STRING","getId",89],"(",")",["T_WHITESPACE","\n        ",89],")",["T_WHITESPACE"," ",90],"{",["T_WHITESPACE","\n            ",90],["T_VARIABLE","$adapter",91],["T_WHITESPACE"," ",91],"=",["T_WHITESPACE"," ",91],["T_VARIABLE","$this",91],["T_OBJECT_OPERATOR","->",91],["T_STRING","_getWriteAdapter",91],"(",")",";",["T_WHITESPACE","\n\n            ",91],["T_COMMENT","\/\/ verify such transaction exists, determine payment and order id\n",93],["T_WHITESPACE","            ",94],["T_VARIABLE","$verificationRow",94],["T_WHITESPACE"," ",94],"=",["T_WHITESPACE"," ",94],["T_VARIABLE","$adapter",94],["T_OBJECT_OPERATOR","->",94],["T_STRING","fetchRow",94],"(",["T_WHITESPACE","\n                ",94],["T_VARIABLE","$adapter",95],["T_OBJECT_OPERATOR","->",95],["T_STRING","select",95],"(",")",["T_OBJECT_OPERATOR","->",95],["T_STRING","from",95],"(",["T_VARIABLE","$this",95],["T_OBJECT_OPERATOR","->",95],["T_STRING","getMainTable",95],"(",")",",",["T_WHITESPACE"," ",95],["T_ARRAY","array",95],"(",["T_CONSTANT_ENCAPSED_STRING","'payment_id'",95],",",["T_WHITESPACE"," ",95],["T_CONSTANT_ENCAPSED_STRING","'order_id'",95],")",")",["T_WHITESPACE","\n                    ",95],["T_OBJECT_OPERATOR","->",96],["T_STRING","where",96],"(","\"",["T_CURLY_OPEN","{",96],["T_VARIABLE","$this",96],["T_OBJECT_OPERATOR","->",96],["T_STRING","getIdFieldName",96],"(",")","}",["T_ENCAPSED_AND_WHITESPACE"," = ?",96],"\"",",",["T_WHITESPACE"," ",96],["T_INT_CAST","(int)",96],["T_VARIABLE","$id",96],")",["T_WHITESPACE","\n            ",96],")",";",["T_WHITESPACE","\n            ",97],["T_IF","if",98],["T_WHITESPACE"," ",98],"(","!",["T_VARIABLE","$verificationRow",98],")",["T_WHITESPACE"," ",98],"{",["T_WHITESPACE","\n                ",98],["T_RETURN","return",99],";",["T_WHITESPACE","\n            ",99],"}",["T_WHITESPACE","\n            ",100],["T_LIST","list",101],"(",["T_VARIABLE","$paymentId",101],",",["T_WHITESPACE"," ",101],["T_VARIABLE","$orderId",101],")",["T_WHITESPACE"," ",101],"=",["T_WHITESPACE"," ",101],["T_STRING","array_values",101],"(",["T_VARIABLE","$verificationRow",101],")",";",["T_WHITESPACE","\n\n            ",101],["T_COMMENT","\/\/ inject\n",103],["T_WHITESPACE","            ",104],["T_VARIABLE","$where",104],["T_WHITESPACE"," ",104],"=",["T_WHITESPACE"," ",104],["T_ARRAY","array",104],"(",["T_WHITESPACE","\n                ",104],["T_VARIABLE","$adapter",105],["T_OBJECT_OPERATOR","->",105],["T_STRING","quoteIdentifier",105],"(",["T_VARIABLE","$this",105],["T_OBJECT_OPERATOR","->",105],["T_STRING","getIdFieldName",105],"(",")",")",["T_WHITESPACE"," ",105],".",["T_WHITESPACE"," ",105],["T_CONSTANT_ENCAPSED_STRING","'!=?'",105],["T_WHITESPACE"," ",105],["T_DOUBLE_ARROW","=>",105],["T_WHITESPACE"," ",105],["T_VARIABLE","$id",105],",",["T_WHITESPACE","\n                ",105],["T_NEW","new",106],["T_WHITESPACE"," ",106],["T_STRING","Zend_Db_Expr",106],"(",["T_CONSTANT_ENCAPSED_STRING","'parent_id IS NULL'",106],")",",",["T_WHITESPACE","\n                ",106],["T_CONSTANT_ENCAPSED_STRING","'payment_id = ?'",107],["T_WHITESPACE","    ",107],["T_DOUBLE_ARROW","=>",107],["T_WHITESPACE"," ",107],["T_INT_CAST","(int)",107],["T_VARIABLE","$paymentId",107],",",["T_WHITESPACE","\n                ",107],["T_CONSTANT_ENCAPSED_STRING","'order_id = ?'",108],["T_WHITESPACE","      ",108],["T_DOUBLE_ARROW","=>",108],["T_WHITESPACE"," ",108],["T_INT_CAST","(int)",108],["T_VARIABLE","$orderId",108],",",["T_WHITESPACE","\n                ",108],["T_CONSTANT_ENCAPSED_STRING","'parent_txn_id = ?'",109],["T_WHITESPACE"," ",109],["T_DOUBLE_ARROW","=>",109],["T_WHITESPACE"," ",109],["T_VARIABLE","$txnId",109],["T_WHITESPACE","\n            ",109],")",";",["T_WHITESPACE","\n            ",110],["T_VARIABLE","$adapter",111],["T_OBJECT_OPERATOR","->",111],["T_STRING","update",111],"(",["T_VARIABLE","$this",111],["T_OBJECT_OPERATOR","->",111],["T_STRING","getMainTable",111],"(",")",",",["T_WHITESPACE"," \n                ",111],["T_ARRAY","array",112],"(",["T_CONSTANT_ENCAPSED_STRING","'parent_id'",112],["T_WHITESPACE"," ",112],["T_DOUBLE_ARROW","=>",112],["T_WHITESPACE"," ",112],["T_VARIABLE","$id",112],")",",",["T_WHITESPACE","\n                ",112],["T_VARIABLE","$where",113],["T_WHITESPACE","\n            ",113],")",";",["T_WHITESPACE","\n        ",114],"}",["T_WHITESPACE","\n    ",115],"}",["T_WHITESPACE","\n\n    ",116],["T_DOC_COMMENT","\/**\n     * Load the transaction object by specified txn_id\n     *\n     * @param Mage_Sales_Model_Order_Payment_Transaction $transaction\n     * @param int $orderId\n     * @param int $paymentId\n     * @param string $txnId\n     *\/",118],["T_WHITESPACE","\n    ",125],["T_PUBLIC","public",126],["T_WHITESPACE"," ",126],["T_FUNCTION","function",126],["T_WHITESPACE"," ",126],["T_STRING","loadObjectByTxnId",126],"(",["T_STRING","Mage_Sales_Model_Order_Payment_Transaction",126],["T_WHITESPACE"," ",126],["T_VARIABLE","$transaction",126],",",["T_WHITESPACE"," ",126],["T_VARIABLE","$orderId",126],",",["T_WHITESPACE"," ",126],["T_VARIABLE","$paymentId",126],",",["T_WHITESPACE"," \n        ",126],["T_VARIABLE","$txnId",127],")",["T_WHITESPACE","\n    ",127],"{",["T_WHITESPACE","\n        ",128],["T_VARIABLE","$select",129],["T_WHITESPACE"," ",129],"=",["T_WHITESPACE"," ",129],["T_VARIABLE","$this",129],["T_OBJECT_OPERATOR","->",129],["T_STRING","_getLoadByUniqueKeySelect",129],"(",["T_VARIABLE","$orderId",129],",",["T_WHITESPACE"," ",129],["T_VARIABLE","$paymentId",129],",",["T_WHITESPACE"," ",129],["T_VARIABLE","$txnId",129],")",";",["T_WHITESPACE","\n        ",129],["T_VARIABLE","$data",130],["T_WHITESPACE","   ",130],"=",["T_WHITESPACE"," ",130],["T_VARIABLE","$this",130],["T_OBJECT_OPERATOR","->",130],["T_STRING","_getWriteAdapter",130],"(",")",["T_OBJECT_OPERATOR","->",130],["T_STRING","fetchRow",130],"(",["T_VARIABLE","$select",130],")",";",["T_WHITESPACE","\n        ",130],["T_VARIABLE","$transaction",131],["T_OBJECT_OPERATOR","->",131],["T_STRING","setData",131],"(",["T_VARIABLE","$data",131],")",";",["T_WHITESPACE","\n        ",131],["T_VARIABLE","$this",132],["T_OBJECT_OPERATOR","->",132],["T_STRING","unserializeFields",132],"(",["T_VARIABLE","$transaction",132],")",";",["T_WHITESPACE","\n        ",132],["T_VARIABLE","$this",133],["T_OBJECT_OPERATOR","->",133],["T_STRING","_afterLoad",133],"(",["T_VARIABLE","$transaction",133],")",";",["T_WHITESPACE","\n    ",133],"}",["T_WHITESPACE","\n\n    ",134],["T_DOC_COMMENT","\/**\n     * Retrieve order website id\n     *\n     * @param int $orderId\n     * @return string\n     *\/",136],["T_WHITESPACE","\n    ",141],["T_PUBLIC","public",142],["T_WHITESPACE"," ",142],["T_FUNCTION","function",142],["T_WHITESPACE"," ",142],["T_STRING","getOrderWebsiteId",142],"(",["T_VARIABLE","$orderId",142],")",["T_WHITESPACE","\n    ",142],"{",["T_WHITESPACE","\n        ",143],["T_VARIABLE","$adapter",144],["T_WHITESPACE"," ",144],"=",["T_WHITESPACE"," ",144],["T_VARIABLE","$this",144],["T_OBJECT_OPERATOR","->",144],["T_STRING","_getReadAdapter",144],"(",")",";",["T_WHITESPACE","\n        ",144],["T_VARIABLE","$bind",145],["T_WHITESPACE","    ",145],"=",["T_WHITESPACE"," ",145],["T_ARRAY","array",145],"(",["T_CONSTANT_ENCAPSED_STRING","':entity_id'",145],["T_WHITESPACE"," ",145],["T_DOUBLE_ARROW","=>",145],["T_WHITESPACE"," ",145],["T_VARIABLE","$orderId",145],")",";",["T_WHITESPACE","\n        ",145],["T_VARIABLE","$select",146],["T_WHITESPACE","  ",146],"=",["T_WHITESPACE"," ",146],["T_VARIABLE","$adapter",146],["T_OBJECT_OPERATOR","->",146],["T_STRING","select",146],"(",")",["T_WHITESPACE","\n            ",146],["T_OBJECT_OPERATOR","->",147],["T_STRING","from",147],"(",["T_ARRAY","array",147],"(",["T_CONSTANT_ENCAPSED_STRING","'so'",147],["T_WHITESPACE"," ",147],["T_DOUBLE_ARROW","=>",147],["T_WHITESPACE"," ",147],["T_VARIABLE","$this",147],["T_OBJECT_OPERATOR","->",147],["T_STRING","getTable",147],"(",["T_CONSTANT_ENCAPSED_STRING","'sales\/order'",147],")",")",",",["T_WHITESPACE"," ",147],["T_CONSTANT_ENCAPSED_STRING","'cs.website_id'",147],")",["T_WHITESPACE","\n            ",147],["T_OBJECT_OPERATOR","->",148],["T_STRING","joinInner",148],"(",["T_ARRAY","array",148],"(",["T_CONSTANT_ENCAPSED_STRING","'cs'",148],["T_WHITESPACE"," ",148],["T_DOUBLE_ARROW","=>",148],["T_WHITESPACE"," ",148],["T_VARIABLE","$this",148],["T_OBJECT_OPERATOR","->",148],["T_STRING","getTable",148],"(",["T_CONSTANT_ENCAPSED_STRING","'core\/store'",148],")",")",",",["T_WHITESPACE"," ",148],["T_CONSTANT_ENCAPSED_STRING","'cs.store_id = so.store_id'",148],")",["T_WHITESPACE","\n            ",148],["T_OBJECT_OPERATOR","->",149],["T_STRING","where",149],"(",["T_CONSTANT_ENCAPSED_STRING","'so.entity_id = :entity_id'",149],")",";",["T_WHITESPACE","\n        ",149],["T_RETURN","return",150],["T_WHITESPACE"," ",150],["T_VARIABLE","$adapter",150],["T_OBJECT_OPERATOR","->",150],["T_STRING","fetchOne",150],"(",["T_VARIABLE","$select",150],",",["T_WHITESPACE"," ",150],["T_VARIABLE","$bind",150],")",";",["T_WHITESPACE","\n    ",150],"}",["T_WHITESPACE","\n\n    ",151],["T_DOC_COMMENT","\/**\n     * Lookup for parent_id in already saved transactions of this payment by the order_id\n     * Also serialize additional information, if any\n     *\n     * @throws Mage_Core_Exception\n     *\n     * @param Mage_Sales_Model_Order_Payment_Transaction $transaction\n     * @return Mage_Sales_Model_Resource_Order_Payment_Transaction\n     *\/",153],["T_WHITESPACE","\n    ",161],["T_PROTECTED","protected",162],["T_WHITESPACE"," ",162],["T_FUNCTION","function",162],["T_WHITESPACE"," ",162],["T_STRING","_beforeSave",162],"(",["T_STRING","Mage_Core_Model_Abstract",162],["T_WHITESPACE"," ",162],["T_VARIABLE","$transaction",162],")",["T_WHITESPACE","\n    ",162],"{",["T_WHITESPACE","\n        ",163],["T_VARIABLE","$parentTxnId",164],["T_WHITESPACE"," ",164],"=",["T_WHITESPACE"," ",164],["T_VARIABLE","$transaction",164],["T_OBJECT_OPERATOR","->",164],["T_STRING","getData",164],"(",["T_CONSTANT_ENCAPSED_STRING","'parent_txn_id'",164],")",";",["T_WHITESPACE","\n        ",164],["T_VARIABLE","$txnId",165],["T_WHITESPACE","       ",165],"=",["T_WHITESPACE"," ",165],["T_VARIABLE","$transaction",165],["T_OBJECT_OPERATOR","->",165],["T_STRING","getData",165],"(",["T_CONSTANT_ENCAPSED_STRING","'txn_id'",165],")",";",["T_WHITESPACE","\n        ",165],["T_VARIABLE","$orderId",166],["T_WHITESPACE","     ",166],"=",["T_WHITESPACE"," ",166],["T_VARIABLE","$transaction",166],["T_OBJECT_OPERATOR","->",166],["T_STRING","getData",166],"(",["T_CONSTANT_ENCAPSED_STRING","'order_id'",166],")",";",["T_WHITESPACE","\n        ",166],["T_VARIABLE","$paymentId",167],["T_WHITESPACE","   ",167],"=",["T_WHITESPACE"," ",167],["T_VARIABLE","$transaction",167],["T_OBJECT_OPERATOR","->",167],["T_STRING","getData",167],"(",["T_CONSTANT_ENCAPSED_STRING","'payment_id'",167],")",";",["T_WHITESPACE","\n        ",167],["T_VARIABLE","$idFieldName",168],["T_WHITESPACE"," ",168],"=",["T_WHITESPACE"," ",168],["T_VARIABLE","$this",168],["T_OBJECT_OPERATOR","->",168],["T_STRING","getIdFieldName",168],"(",")",";",["T_WHITESPACE","\n\n        ",168],["T_IF","if",170],["T_WHITESPACE"," ",170],"(",["T_VARIABLE","$parentTxnId",170],")",["T_WHITESPACE"," ",170],"{",["T_WHITESPACE","\n            ",170],["T_IF","if",171],["T_WHITESPACE"," ",171],"(","!",["T_VARIABLE","$txnId",171],["T_WHITESPACE"," ",171],["T_BOOLEAN_OR","||",171],["T_WHITESPACE"," ",171],"!",["T_VARIABLE","$orderId",171],["T_WHITESPACE"," ",171],["T_BOOLEAN_OR","||",171],["T_WHITESPACE"," ",171],"!",["T_VARIABLE","$paymentId",171],")",["T_WHITESPACE"," ",171],"{",["T_WHITESPACE","\n                ",171],["T_STRING","Mage",172],["T_DOUBLE_COLON","::",172],["T_STRING","throwException",172],"(",["T_WHITESPACE","\n                    ",172],["T_STRING","Mage",173],["T_DOUBLE_COLON","::",173],["T_STRING","helper",173],"(",["T_CONSTANT_ENCAPSED_STRING","'sales'",173],")",["T_OBJECT_OPERATOR","->",173],["T_STRING","__",173],"(",["T_CONSTANT_ENCAPSED_STRING","'Not enough valid data to save the parent transaction ID.'",173],")",")",";",["T_WHITESPACE","\n            ",173],"}",["T_WHITESPACE","\n            ",174],["T_VARIABLE","$parentId",175],["T_WHITESPACE"," ",175],"=",["T_WHITESPACE"," ",175],["T_INT_CAST","(int)",175],["T_VARIABLE","$this",175],["T_OBJECT_OPERATOR","->",175],["T_STRING","_lookupByTxnId",175],"(",["T_VARIABLE","$orderId",175],",",["T_WHITESPACE"," ",175],["T_VARIABLE","$paymentId",175],",",["T_WHITESPACE"," ",175],["T_VARIABLE","$parentTxnId",175],",",["T_WHITESPACE"," ",175],["T_VARIABLE","$idFieldName",175],")",";",["T_WHITESPACE","\n            ",175],["T_IF","if",176],["T_WHITESPACE"," ",176],"(",["T_VARIABLE","$parentId",176],")",["T_WHITESPACE"," ",176],"{",["T_WHITESPACE","\n                ",176],["T_VARIABLE","$transaction",177],["T_OBJECT_OPERATOR","->",177],["T_STRING","setData",177],"(",["T_CONSTANT_ENCAPSED_STRING","'parent_id'",177],",",["T_WHITESPACE"," ",177],["T_VARIABLE","$parentId",177],")",";",["T_WHITESPACE","\n            ",177],"}",["T_WHITESPACE","\n        ",178],"}",["T_WHITESPACE","\n\n        ",179],["T_COMMENT","\/\/ make sure unique key won't cause trouble\n",181],["T_WHITESPACE","        ",182],["T_IF","if",182],["T_WHITESPACE"," ",182],"(",["T_VARIABLE","$transaction",182],["T_OBJECT_OPERATOR","->",182],["T_STRING","isFailsafe",182],"(",")",")",["T_WHITESPACE"," ",182],"{",["T_WHITESPACE","\n            ",182],["T_VARIABLE","$autoincrementId",183],["T_WHITESPACE"," ",183],"=",["T_WHITESPACE"," ",183],["T_INT_CAST","(int)",183],["T_VARIABLE","$this",183],["T_OBJECT_OPERATOR","->",183],["T_STRING","_lookupByTxnId",183],"(",["T_VARIABLE","$orderId",183],",",["T_WHITESPACE"," ",183],["T_VARIABLE","$paymentId",183],",",["T_WHITESPACE"," ",183],["T_VARIABLE","$txnId",183],",",["T_WHITESPACE"," ",183],["T_VARIABLE","$idFieldName",183],")",";",["T_WHITESPACE","\n            ",183],["T_IF","if",184],["T_WHITESPACE"," ",184],"(",["T_VARIABLE","$autoincrementId",184],")",["T_WHITESPACE"," ",184],"{",["T_WHITESPACE","\n                ",184],["T_VARIABLE","$transaction",185],["T_OBJECT_OPERATOR","->",185],["T_STRING","setData",185],"(",["T_VARIABLE","$idFieldName",185],",",["T_WHITESPACE"," ",185],["T_VARIABLE","$autoincrementId",185],")",["T_OBJECT_OPERATOR","->",185],["T_STRING","isObjectNew",185],"(",["T_STRING","false",185],")",";",["T_WHITESPACE","\n            ",185],"}",["T_WHITESPACE","\n        ",186],"}",["T_WHITESPACE","\n\n        ",187],["T_RETURN","return",189],["T_WHITESPACE"," ",189],["T_STRING","parent",189],["T_DOUBLE_COLON","::",189],["T_STRING","_beforeSave",189],"(",["T_VARIABLE","$transaction",189],")",";",["T_WHITESPACE","\n    ",189],"}",["T_WHITESPACE","\n\n    ",190],["T_DOC_COMMENT","\/**\n     * Load cell\/row by specified unique key parts\n     *\n     * @param int $orderId\n     * @param int $paymentId\n     * @param string $txnId\n     * @param mixed (array|string|object) $columns\n     * @param bool $isRow\n     * @param string $txnType\n     * @return mixed (array|string)\n     *\/",192],["T_WHITESPACE","\n    ",202],["T_PRIVATE","private",203],["T_WHITESPACE"," ",203],["T_FUNCTION","function",203],["T_WHITESPACE"," ",203],["T_STRING","_lookupByTxnId",203],"(",["T_VARIABLE","$orderId",203],",",["T_WHITESPACE"," ",203],["T_VARIABLE","$paymentId",203],",",["T_WHITESPACE"," ",203],["T_VARIABLE","$txnId",203],",",["T_WHITESPACE"," ",203],["T_VARIABLE","$columns",203],",",["T_WHITESPACE"," ",203],["T_VARIABLE","$isRow",203],["T_WHITESPACE"," ",203],"=",["T_WHITESPACE"," ",203],["T_STRING","false",203],",",["T_WHITESPACE"," ",203],["T_VARIABLE","$txnType",203],["T_WHITESPACE"," ",203],"=",["T_WHITESPACE"," ",203],["T_STRING","null",203],")",["T_WHITESPACE","\n    ",203],"{",["T_WHITESPACE","\n        ",204],["T_VARIABLE","$select",205],["T_WHITESPACE"," ",205],"=",["T_WHITESPACE"," ",205],["T_VARIABLE","$this",205],["T_OBJECT_OPERATOR","->",205],["T_STRING","_getLoadByUniqueKeySelect",205],"(",["T_VARIABLE","$orderId",205],",",["T_WHITESPACE"," ",205],["T_VARIABLE","$paymentId",205],",",["T_WHITESPACE"," ",205],["T_VARIABLE","$txnId",205],",",["T_WHITESPACE"," ",205],["T_VARIABLE","$columns",205],")",";",["T_WHITESPACE","\n        ",205],["T_IF","if",206],["T_WHITESPACE"," ",206],"(",["T_VARIABLE","$txnType",206],")",["T_WHITESPACE"," ",206],"{",["T_WHITESPACE","\n            ",206],["T_VARIABLE","$select",207],["T_OBJECT_OPERATOR","->",207],["T_STRING","where",207],"(",["T_CONSTANT_ENCAPSED_STRING","'txn_type = ?'",207],",",["T_WHITESPACE"," ",207],["T_VARIABLE","$txnType",207],")",";",["T_WHITESPACE","\n        ",207],"}",["T_WHITESPACE","\n        ",208],["T_IF","if",209],["T_WHITESPACE"," ",209],"(",["T_VARIABLE","$isRow",209],")",["T_WHITESPACE"," ",209],"{",["T_WHITESPACE","\n            ",209],["T_RETURN","return",210],["T_WHITESPACE"," ",210],["T_VARIABLE","$this",210],["T_OBJECT_OPERATOR","->",210],["T_STRING","_getWriteAdapter",210],"(",")",["T_OBJECT_OPERATOR","->",210],["T_STRING","fetchRow",210],"(",["T_VARIABLE","$select",210],")",";",["T_WHITESPACE","\n        ",210],"}",["T_WHITESPACE","\n        ",211],["T_RETURN","return",212],["T_WHITESPACE"," ",212],["T_VARIABLE","$this",212],["T_OBJECT_OPERATOR","->",212],["T_STRING","_getWriteAdapter",212],"(",")",["T_OBJECT_OPERATOR","->",212],["T_STRING","fetchOne",212],"(",["T_VARIABLE","$select",212],")",";",["T_WHITESPACE","\n    ",212],"}",["T_WHITESPACE","\n\n    ",213],["T_DOC_COMMENT","\/**\n     * Get select object for loading transaction by the unique key of order_id, payment_id, txn_id\n     *\n     * @param int $orderId\n     * @param int $paymentId\n     * @param string $txnId\n     * @param string|array|Zend_Db_Expr $columns\n     * @return Varien_Db_Select\n     *\/",215],["T_WHITESPACE","\n    ",223],["T_PRIVATE","private",224],["T_WHITESPACE"," ",224],["T_FUNCTION","function",224],["T_WHITESPACE"," ",224],["T_STRING","_getLoadByUniqueKeySelect",224],"(",["T_VARIABLE","$orderId",224],",",["T_WHITESPACE"," ",224],["T_VARIABLE","$paymentId",224],",",["T_WHITESPACE"," ",224],["T_VARIABLE","$txnId",224],",",["T_WHITESPACE"," ",224],["T_VARIABLE","$columns",224],["T_WHITESPACE"," ",224],"=",["T_WHITESPACE"," ",224],["T_CONSTANT_ENCAPSED_STRING","'*'",224],")",["T_WHITESPACE","\n    ",224],"{",["T_WHITESPACE","\n        ",225],["T_RETURN","return",226],["T_WHITESPACE"," ",226],["T_VARIABLE","$this",226],["T_OBJECT_OPERATOR","->",226],["T_STRING","_getWriteAdapter",226],"(",")",["T_OBJECT_OPERATOR","->",226],["T_STRING","select",226],"(",")",["T_WHITESPACE","\n            ",226],["T_OBJECT_OPERATOR","->",227],["T_STRING","from",227],"(",["T_VARIABLE","$this",227],["T_OBJECT_OPERATOR","->",227],["T_STRING","getMainTable",227],"(",")",",",["T_WHITESPACE"," ",227],["T_VARIABLE","$columns",227],")",["T_WHITESPACE","\n            ",227],["T_OBJECT_OPERATOR","->",228],["T_STRING","where",228],"(",["T_CONSTANT_ENCAPSED_STRING","'order_id = ?'",228],",",["T_WHITESPACE"," ",228],["T_VARIABLE","$orderId",228],")",["T_WHITESPACE","\n            ",228],["T_OBJECT_OPERATOR","->",229],["T_STRING","where",229],"(",["T_CONSTANT_ENCAPSED_STRING","'payment_id = ?'",229],",",["T_WHITESPACE"," ",229],["T_VARIABLE","$paymentId",229],")",["T_WHITESPACE","\n            ",229],["T_OBJECT_OPERATOR","->",230],["T_STRING","where",230],"(",["T_CONSTANT_ENCAPSED_STRING","'txn_id = ?'",230],",",["T_WHITESPACE"," ",230],["T_VARIABLE","$txnId",230],")",";",["T_WHITESPACE","\n    ",230],"}",["T_WHITESPACE","\n",231],"}",["T_WHITESPACE","\n",232]]