[["T_OPEN_TAG","<?php\n",1],["T_DOC_COMMENT","\/**\n * Magento\n *\n * NOTICE OF LICENSE\n *\n * This source file is subject to the Open Software License (OSL 3.0)\n * that is bundled with this package in the file LICENSE.txt.\n * It is also available through the world-wide-web at this URL:\n * http:\/\/opensource.org\/licenses\/osl-3.0.php\n * If you did not receive a copy of the license and are unable to\n * obtain it through the world-wide-web, please send an email\n * to license@magento.com so we can send you a copy immediately.\n *\n * DISCLAIMER\n *\n * Do not edit or add to this file if you wish to upgrade Magento to newer\n * versions in the future. If you wish to customize Magento for your\n * needs please refer to http:\/\/www.magento.com for more information.\n *\n * @category    Mage\n * @package     Mage_Sales\n * @copyright  Copyright (c) 2006-2016 X.commerce, Inc. and affiliates (http:\/\/www.magento.com)\n * @license    http:\/\/opensource.org\/licenses\/osl-3.0.php  Open Software License (OSL 3.0)\n *\/",2],["T_WHITESPACE","\n\n",25],["T_DOC_COMMENT","\/**\n * Billing Agreement abstract model\n *\n * @method Mage_Sales_Model_Resource_Billing_Agreement _getResource()\n * @method Mage_Sales_Model_Resource_Billing_Agreement getResource()\n * @method int getCustomerId()\n * @method Mage_Sales_Model_Billing_Agreement setCustomerId(int $value)\n * @method string getMethodCode()\n * @method Mage_Sales_Model_Billing_Agreement setMethodCode(string $value)\n * @method string getReferenceId()\n * @method Mage_Sales_Model_Billing_Agreement setReferenceId(string $value)\n * @method string getStatus()\n * @method Mage_Sales_Model_Billing_Agreement setStatus(string $value)\n * @method string getCreatedAt()\n * @method Mage_Sales_Model_Billing_Agreement setCreatedAt(string $value)\n * @method string getUpdatedAt()\n * @method Mage_Sales_Model_Billing_Agreement setUpdatedAt(string $value)\n * @method int getStoreId()\n * @method Mage_Sales_Model_Billing_Agreement setStoreId(int $value)\n * @method string getAgreementLabel()\n * @method Mage_Sales_Model_Billing_Agreement setAgreementLabel(string $value)\n *\n * @category    Mage\n * @package     Mage_Sales\n * @author      Magento Core Team <core@magentocommerce.com>\n *\/",27],["T_WHITESPACE","\n",52],["T_CLASS","class",53],["T_WHITESPACE"," ",53],["T_STRING","Mage_Sales_Model_Billing_Agreement",53],["T_WHITESPACE"," ",53],["T_EXTENDS","extends",53],["T_WHITESPACE"," ",53],["T_STRING","Mage_Payment_Model_Billing_AgreementAbstract",53],["T_WHITESPACE","\n",53],"{",["T_WHITESPACE","\n    ",54],["T_CONST","const",55],["T_WHITESPACE"," ",55],["T_STRING","STATUS_ACTIVE",55],["T_WHITESPACE","     ",55],"=",["T_WHITESPACE"," ",55],["T_CONSTANT_ENCAPSED_STRING","'active'",55],";",["T_WHITESPACE","\n    ",55],["T_CONST","const",56],["T_WHITESPACE"," ",56],["T_STRING","STATUS_CANCELED",56],["T_WHITESPACE","   ",56],"=",["T_WHITESPACE"," ",56],["T_CONSTANT_ENCAPSED_STRING","'canceled'",56],";",["T_WHITESPACE","\n\n    ",56],["T_DOC_COMMENT","\/**\n     * Related agreement orders\n     *\n     * @var array\n     *\/",58],["T_WHITESPACE","\n    ",62],["T_PROTECTED","protected",63],["T_WHITESPACE"," ",63],["T_VARIABLE","$_relatedOrders",63],["T_WHITESPACE"," ",63],"=",["T_WHITESPACE"," ",63],["T_ARRAY","array",63],"(",")",";",["T_WHITESPACE","\n\n    ",63],["T_DOC_COMMENT","\/**\n     * Init model\n     *\n     *\/",65],["T_WHITESPACE","\n    ",68],["T_PROTECTED","protected",69],["T_WHITESPACE"," ",69],["T_FUNCTION","function",69],["T_WHITESPACE"," ",69],["T_STRING","_construct",69],"(",")",["T_WHITESPACE","\n    ",69],"{",["T_WHITESPACE","\n        ",70],["T_VARIABLE","$this",71],["T_OBJECT_OPERATOR","->",71],["T_STRING","_init",71],"(",["T_CONSTANT_ENCAPSED_STRING","'sales\/billing_agreement'",71],")",";",["T_WHITESPACE","\n    ",71],"}",["T_WHITESPACE","\n\n    ",72],["T_DOC_COMMENT","\/**\n     * Set created_at parameter\n     *\n     * @return Mage_Core_Model_Abstract\n     *\/",74],["T_WHITESPACE","\n    ",78],["T_PROTECTED","protected",79],["T_WHITESPACE"," ",79],["T_FUNCTION","function",79],["T_WHITESPACE"," ",79],["T_STRING","_beforeSave",79],"(",")",["T_WHITESPACE","\n    ",79],"{",["T_WHITESPACE","\n        ",80],["T_VARIABLE","$date",81],["T_WHITESPACE"," ",81],"=",["T_WHITESPACE"," ",81],["T_STRING","Mage",81],["T_DOUBLE_COLON","::",81],["T_STRING","getModel",81],"(",["T_CONSTANT_ENCAPSED_STRING","'core\/date'",81],")",["T_OBJECT_OPERATOR","->",81],["T_STRING","gmtDate",81],"(",")",";",["T_WHITESPACE","\n        ",81],["T_IF","if",82],["T_WHITESPACE"," ",82],"(",["T_VARIABLE","$this",82],["T_OBJECT_OPERATOR","->",82],["T_STRING","isObjectNew",82],"(",")",["T_WHITESPACE"," ",82],["T_BOOLEAN_AND","&&",82],["T_WHITESPACE"," ",82],"!",["T_VARIABLE","$this",82],["T_OBJECT_OPERATOR","->",82],["T_STRING","getCreatedAt",82],"(",")",")",["T_WHITESPACE"," ",82],"{",["T_WHITESPACE","\n            ",82],["T_VARIABLE","$this",83],["T_OBJECT_OPERATOR","->",83],["T_STRING","setCreatedAt",83],"(",["T_VARIABLE","$date",83],")",";",["T_WHITESPACE","\n        ",83],"}",["T_WHITESPACE"," ",84],["T_ELSE","else",84],["T_WHITESPACE"," ",84],"{",["T_WHITESPACE","\n            ",84],["T_VARIABLE","$this",85],["T_OBJECT_OPERATOR","->",85],["T_STRING","setUpdatedAt",85],"(",["T_VARIABLE","$date",85],")",";",["T_WHITESPACE","\n        ",85],"}",["T_WHITESPACE","\n        ",86],["T_RETURN","return",87],["T_WHITESPACE"," ",87],["T_STRING","parent",87],["T_DOUBLE_COLON","::",87],["T_STRING","_beforeSave",87],"(",")",";",["T_WHITESPACE","\n    ",87],"}",["T_WHITESPACE","\n\n    ",88],["T_DOC_COMMENT","\/**\n     * Save agreement order relations\n     *\n     * @return Mage_Core_Model_Abstract\n     *\/",90],["T_WHITESPACE","\n    ",94],["T_PROTECTED","protected",95],["T_WHITESPACE"," ",95],["T_FUNCTION","function",95],["T_WHITESPACE"," ",95],["T_STRING","_afterSave",95],"(",")",["T_WHITESPACE","\n    ",95],"{",["T_WHITESPACE","\n        ",96],["T_IF","if",97],["T_WHITESPACE"," ",97],"(","!",["T_EMPTY","empty",97],"(",["T_VARIABLE","$this",97],["T_OBJECT_OPERATOR","->",97],["T_STRING","_relatedOrders",97],")",")",["T_WHITESPACE"," ",97],"{",["T_WHITESPACE","\n            ",97],["T_VARIABLE","$this",98],["T_OBJECT_OPERATOR","->",98],["T_STRING","_saveOrderRelations",98],"(",")",";",["T_WHITESPACE","\n        ",98],"}",["T_WHITESPACE","\n        ",99],["T_RETURN","return",100],["T_WHITESPACE"," ",100],["T_STRING","parent",100],["T_DOUBLE_COLON","::",100],["T_STRING","_afterSave",100],"(",")",";",["T_WHITESPACE","\n    ",100],"}",["T_WHITESPACE","\n\n    ",101],["T_DOC_COMMENT","\/**\n     * Retrieve billing agreement status label\n     *\n     * @return string\n     *\/",103],["T_WHITESPACE","\n    ",107],["T_PUBLIC","public",108],["T_WHITESPACE"," ",108],["T_FUNCTION","function",108],["T_WHITESPACE"," ",108],["T_STRING","getStatusLabel",108],"(",")",["T_WHITESPACE","\n    ",108],"{",["T_WHITESPACE","\n        ",109],["T_SWITCH","switch",110],["T_WHITESPACE"," ",110],"(",["T_VARIABLE","$this",110],["T_OBJECT_OPERATOR","->",110],["T_STRING","getStatus",110],"(",")",")",["T_WHITESPACE"," ",110],"{",["T_WHITESPACE","\n            ",110],["T_CASE","case",111],["T_WHITESPACE"," ",111],["T_STRING","self",111],["T_DOUBLE_COLON","::",111],["T_STRING","STATUS_ACTIVE",111],":",["T_WHITESPACE","\n                ",111],["T_RETURN","return",112],["T_WHITESPACE"," ",112],["T_STRING","Mage",112],["T_DOUBLE_COLON","::",112],["T_STRING","helper",112],"(",["T_CONSTANT_ENCAPSED_STRING","'sales'",112],")",["T_OBJECT_OPERATOR","->",112],["T_STRING","__",112],"(",["T_CONSTANT_ENCAPSED_STRING","'Active'",112],")",";",["T_WHITESPACE","\n            ",112],["T_CASE","case",113],["T_WHITESPACE"," ",113],["T_STRING","self",113],["T_DOUBLE_COLON","::",113],["T_STRING","STATUS_CANCELED",113],":",["T_WHITESPACE","\n                ",113],["T_RETURN","return",114],["T_WHITESPACE"," ",114],["T_STRING","Mage",114],["T_DOUBLE_COLON","::",114],["T_STRING","helper",114],"(",["T_CONSTANT_ENCAPSED_STRING","'sales'",114],")",["T_OBJECT_OPERATOR","->",114],["T_STRING","__",114],"(",["T_CONSTANT_ENCAPSED_STRING","'Canceled'",114],")",";",["T_WHITESPACE","\n        ",114],"}",["T_WHITESPACE","\n    ",115],"}",["T_WHITESPACE","\n\n    ",116],["T_DOC_COMMENT","\/**\n     * Initialize token\n     *\n     * @return string\n     *\/",118],["T_WHITESPACE","\n    ",122],["T_PUBLIC","public",123],["T_WHITESPACE"," ",123],["T_FUNCTION","function",123],["T_WHITESPACE"," ",123],["T_STRING","initToken",123],"(",")",["T_WHITESPACE","\n    ",123],"{",["T_WHITESPACE","\n        ",124],["T_VARIABLE","$this",125],["T_OBJECT_OPERATOR","->",125],["T_STRING","getPaymentMethodInstance",125],"(",")",["T_WHITESPACE","\n            ",125],["T_OBJECT_OPERATOR","->",126],["T_STRING","initBillingAgreementToken",126],"(",["T_VARIABLE","$this",126],")",";",["T_WHITESPACE","\n        ",126],["T_RETURN","return",127],["T_WHITESPACE"," ",127],["T_VARIABLE","$this",127],["T_OBJECT_OPERATOR","->",127],["T_STRING","getRedirectUrl",127],"(",")",";",["T_WHITESPACE","\n    ",127],"}",["T_WHITESPACE","\n\n    ",128],["T_DOC_COMMENT","\/**\n     * Get billing agreement details\n     * Data from response is inside this object\n     *\n     * @return Mage_Sales_Model_Billing_Agreement\n     *\/",130],["T_WHITESPACE","\n    ",135],["T_PUBLIC","public",136],["T_WHITESPACE"," ",136],["T_FUNCTION","function",136],["T_WHITESPACE"," ",136],["T_STRING","verifyToken",136],"(",")",["T_WHITESPACE","\n    ",136],"{",["T_WHITESPACE","\n        ",137],["T_VARIABLE","$this",138],["T_OBJECT_OPERATOR","->",138],["T_STRING","getPaymentMethodInstance",138],"(",")",["T_WHITESPACE","\n            ",138],["T_OBJECT_OPERATOR","->",139],["T_STRING","getBillingAgreementTokenInfo",139],"(",["T_VARIABLE","$this",139],")",";",["T_WHITESPACE","\n        ",139],["T_RETURN","return",140],["T_WHITESPACE"," ",140],["T_VARIABLE","$this",140],";",["T_WHITESPACE","\n    ",140],"}",["T_WHITESPACE","\n\n    ",141],["T_DOC_COMMENT","\/**\n     * Check for permissions\n     *\n     * @param int $customerIdSession\n     * @return boolean\n     *\/",143],["T_WHITESPACE","\n    ",148],["T_PUBLIC","public",149],["T_WHITESPACE"," ",149],["T_FUNCTION","function",149],["T_WHITESPACE"," ",149],["T_STRING","canPerformAction",149],"(",["T_VARIABLE","$customerIdSession",149],")",["T_WHITESPACE","\n    ",149],"{",["T_WHITESPACE","\n        ",150],["T_COMMENT","\/\/ Get the customer id from billing agreement and compare to logged in customer id\n",151],["T_WHITESPACE","        ",152],["T_RETURN","return",152],["T_WHITESPACE"," ",152],"(",["T_INT_CAST","(int)",152],["T_VARIABLE","$this",152],["T_OBJECT_OPERATOR","->",152],["T_STRING","getCustomerId",152],"(",")",["T_WHITESPACE"," ",152],["T_IS_IDENTICAL","===",152],["T_WHITESPACE"," ",152],["T_INT_CAST","(int)",152],["T_VARIABLE","$customerIdSession",152],")",["T_WHITESPACE"," ",152],"?",["T_WHITESPACE"," ",152],["T_STRING","true",152],["T_WHITESPACE"," ",152],":",["T_WHITESPACE"," ",152],["T_STRING","false",152],";",["T_WHITESPACE","\n    ",152],"}",["T_WHITESPACE","\n\n    ",153],["T_DOC_COMMENT","\/**\n     * Create billing agreement\n     *\n     * @return Mage_Sales_Model_Billing_Agreement\n     *\/",155],["T_WHITESPACE","\n    ",159],["T_PUBLIC","public",160],["T_WHITESPACE"," ",160],["T_FUNCTION","function",160],["T_WHITESPACE"," ",160],["T_STRING","place",160],"(",")",["T_WHITESPACE","\n    ",160],"{",["T_WHITESPACE","\n        ",161],["T_VARIABLE","$this",162],["T_OBJECT_OPERATOR","->",162],["T_STRING","verifyToken",162],"(",")",";",["T_WHITESPACE","\n\n        ",162],["T_VARIABLE","$paymentMethodInstance",164],["T_WHITESPACE"," ",164],"=",["T_WHITESPACE"," ",164],["T_VARIABLE","$this",164],["T_OBJECT_OPERATOR","->",164],["T_STRING","getPaymentMethodInstance",164],"(",")",["T_WHITESPACE","\n            ",164],["T_OBJECT_OPERATOR","->",165],["T_STRING","placeBillingAgreement",165],"(",["T_VARIABLE","$this",165],")",";",["T_WHITESPACE","\n\n        ",165],["T_VARIABLE","$this",167],["T_OBJECT_OPERATOR","->",167],["T_STRING","setCustomerId",167],"(",["T_VARIABLE","$this",167],["T_OBJECT_OPERATOR","->",167],["T_STRING","getCustomer",167],"(",")",["T_OBJECT_OPERATOR","->",167],["T_STRING","getId",167],"(",")",")",["T_WHITESPACE","\n            ",167],["T_OBJECT_OPERATOR","->",168],["T_STRING","setMethodCode",168],"(",["T_VARIABLE","$this",168],["T_OBJECT_OPERATOR","->",168],["T_STRING","getMethodCode",168],"(",")",")",["T_WHITESPACE","\n            ",168],["T_OBJECT_OPERATOR","->",169],["T_STRING","setReferenceId",169],"(",["T_VARIABLE","$this",169],["T_OBJECT_OPERATOR","->",169],["T_STRING","getBillingAgreementId",169],"(",")",")",["T_WHITESPACE","\n            ",169],["T_OBJECT_OPERATOR","->",170],["T_STRING","setStatus",170],"(",["T_STRING","self",170],["T_DOUBLE_COLON","::",170],["T_STRING","STATUS_ACTIVE",170],")",["T_WHITESPACE","\n            ",170],["T_OBJECT_OPERATOR","->",171],["T_STRING","setAgreementLabel",171],"(",["T_VARIABLE","$paymentMethodInstance",171],["T_OBJECT_OPERATOR","->",171],["T_STRING","getTitle",171],"(",")",")",["T_WHITESPACE","\n            ",171],["T_OBJECT_OPERATOR","->",172],["T_STRING","save",172],"(",")",";",["T_WHITESPACE","\n        ",172],["T_RETURN","return",173],["T_WHITESPACE"," ",173],["T_VARIABLE","$this",173],";",["T_WHITESPACE","\n    ",173],"}",["T_WHITESPACE","\n\n    ",174],["T_DOC_COMMENT","\/**\n     * Cancel billing agreement\n     *\n     * @return Mage_Sales_Model_Billing_Agreement\n     *\/",176],["T_WHITESPACE","\n    ",180],["T_PUBLIC","public",181],["T_WHITESPACE"," ",181],["T_FUNCTION","function",181],["T_WHITESPACE"," ",181],["T_STRING","cancel",181],"(",")",["T_WHITESPACE","\n    ",181],"{",["T_WHITESPACE","\n        ",182],["T_VARIABLE","$this",183],["T_OBJECT_OPERATOR","->",183],["T_STRING","setStatus",183],"(",["T_STRING","self",183],["T_DOUBLE_COLON","::",183],["T_STRING","STATUS_CANCELED",183],")",";",["T_WHITESPACE","\n        ",183],["T_VARIABLE","$this",184],["T_OBJECT_OPERATOR","->",184],["T_STRING","getPaymentMethodInstance",184],"(",")",["T_OBJECT_OPERATOR","->",184],["T_STRING","updateBillingAgreementStatus",184],"(",["T_VARIABLE","$this",184],")",";",["T_WHITESPACE","\n        ",184],["T_RETURN","return",185],["T_WHITESPACE"," ",185],["T_VARIABLE","$this",185],["T_OBJECT_OPERATOR","->",185],["T_STRING","save",185],"(",")",";",["T_WHITESPACE","\n    ",185],"}",["T_WHITESPACE","\n\n    ",186],["T_DOC_COMMENT","\/**\n     * Check whether can cancel billing agreement\n     *\n     * @return bool\n     *\/",188],["T_WHITESPACE","\n    ",192],["T_PUBLIC","public",193],["T_WHITESPACE"," ",193],["T_FUNCTION","function",193],["T_WHITESPACE"," ",193],["T_STRING","canCancel",193],"(",")",["T_WHITESPACE","\n    ",193],"{",["T_WHITESPACE","\n        ",194],["T_RETURN","return",195],["T_WHITESPACE"," ",195],"(",["T_VARIABLE","$this",195],["T_OBJECT_OPERATOR","->",195],["T_STRING","getStatus",195],"(",")",["T_WHITESPACE"," ",195],["T_IS_NOT_EQUAL","!=",195],["T_WHITESPACE"," ",195],["T_STRING","self",195],["T_DOUBLE_COLON","::",195],["T_STRING","STATUS_CANCELED",195],")",";",["T_WHITESPACE","\n    ",195],"}",["T_WHITESPACE","\n\n    ",196],["T_DOC_COMMENT","\/**\n     * Retrieve billing agreement statuses array\n     *\n     * @return array\n     *\/",198],["T_WHITESPACE","\n    ",202],["T_PUBLIC","public",203],["T_WHITESPACE"," ",203],["T_FUNCTION","function",203],["T_WHITESPACE"," ",203],["T_STRING","getStatusesArray",203],"(",")",["T_WHITESPACE","\n    ",203],"{",["T_WHITESPACE","\n        ",204],["T_RETURN","return",205],["T_WHITESPACE"," ",205],["T_ARRAY","array",205],"(",["T_WHITESPACE","\n            ",205],["T_STRING","self",206],["T_DOUBLE_COLON","::",206],["T_STRING","STATUS_ACTIVE",206],["T_WHITESPACE","     ",206],["T_DOUBLE_ARROW","=>",206],["T_WHITESPACE"," ",206],["T_STRING","Mage",206],["T_DOUBLE_COLON","::",206],["T_STRING","helper",206],"(",["T_CONSTANT_ENCAPSED_STRING","'sales'",206],")",["T_OBJECT_OPERATOR","->",206],["T_STRING","__",206],"(",["T_CONSTANT_ENCAPSED_STRING","'Active'",206],")",",",["T_WHITESPACE","\n            ",206],["T_STRING","self",207],["T_DOUBLE_COLON","::",207],["T_STRING","STATUS_CANCELED",207],["T_WHITESPACE","   ",207],["T_DOUBLE_ARROW","=>",207],["T_WHITESPACE"," ",207],["T_STRING","Mage",207],["T_DOUBLE_COLON","::",207],["T_STRING","helper",207],"(",["T_CONSTANT_ENCAPSED_STRING","'sales'",207],")",["T_OBJECT_OPERATOR","->",207],["T_STRING","__",207],"(",["T_CONSTANT_ENCAPSED_STRING","'Canceled'",207],")",["T_WHITESPACE","\n        ",207],")",";",["T_WHITESPACE","\n    ",208],"}",["T_WHITESPACE","\n\n    ",209],["T_DOC_COMMENT","\/**\n     * Validate data\n     *\n     * @return bool\n     *\/",211],["T_WHITESPACE","\n    ",215],["T_PUBLIC","public",216],["T_WHITESPACE"," ",216],["T_FUNCTION","function",216],["T_WHITESPACE"," ",216],["T_STRING","isValid",216],"(",")",["T_WHITESPACE","\n    ",216],"{",["T_WHITESPACE","\n        ",217],["T_VARIABLE","$result",218],["T_WHITESPACE"," ",218],"=",["T_WHITESPACE"," ",218],["T_STRING","parent",218],["T_DOUBLE_COLON","::",218],["T_STRING","isValid",218],"(",")",";",["T_WHITESPACE","\n        ",218],["T_IF","if",219],["T_WHITESPACE"," ",219],"(","!",["T_VARIABLE","$this",219],["T_OBJECT_OPERATOR","->",219],["T_STRING","getCustomerId",219],"(",")",")",["T_WHITESPACE"," ",219],"{",["T_WHITESPACE","\n            ",219],["T_VARIABLE","$this",220],["T_OBJECT_OPERATOR","->",220],["T_STRING","_errors",220],"[","]",["T_WHITESPACE"," ",220],"=",["T_WHITESPACE"," ",220],["T_STRING","Mage",220],["T_DOUBLE_COLON","::",220],["T_STRING","helper",220],"(",["T_CONSTANT_ENCAPSED_STRING","'payment'",220],")",["T_OBJECT_OPERATOR","->",220],["T_STRING","__",220],"(",["T_CONSTANT_ENCAPSED_STRING","'Customer ID is not set.'",220],")",";",["T_WHITESPACE","\n        ",220],"}",["T_WHITESPACE","\n        ",221],["T_IF","if",222],["T_WHITESPACE"," ",222],"(","!",["T_VARIABLE","$this",222],["T_OBJECT_OPERATOR","->",222],["T_STRING","getStatus",222],"(",")",")",["T_WHITESPACE"," ",222],"{",["T_WHITESPACE","\n            ",222],["T_VARIABLE","$this",223],["T_OBJECT_OPERATOR","->",223],["T_STRING","_errors",223],"[","]",["T_WHITESPACE"," ",223],"=",["T_WHITESPACE"," ",223],["T_STRING","Mage",223],["T_DOUBLE_COLON","::",223],["T_STRING","helper",223],"(",["T_CONSTANT_ENCAPSED_STRING","'payment'",223],")",["T_OBJECT_OPERATOR","->",223],["T_STRING","__",223],"(",["T_CONSTANT_ENCAPSED_STRING","'Billing Agreement status is not set.'",223],")",";",["T_WHITESPACE","\n        ",223],"}",["T_WHITESPACE","\n        ",224],["T_RETURN","return",225],["T_WHITESPACE"," ",225],["T_VARIABLE","$result",225],["T_WHITESPACE"," ",225],["T_BOOLEAN_AND","&&",225],["T_WHITESPACE"," ",225],["T_EMPTY","empty",225],"(",["T_VARIABLE","$this",225],["T_OBJECT_OPERATOR","->",225],["T_STRING","_errors",225],")",";",["T_WHITESPACE","\n    ",225],"}",["T_WHITESPACE","\n\n    ",226],["T_DOC_COMMENT","\/**\n     * Import payment data to billing agreement\n     *\n     * $payment->getBillingAgreementData() contains array with following structure :\n     *  [billing_agreement_id]  => string\n     *  [method_code]           => string\n     *\n     * @param Mage_Sales_Model_Order_Payment $payment\n     * @return Mage_Sales_Model_Billing_Agreement\n     *\/",228],["T_WHITESPACE","\n    ",237],["T_PUBLIC","public",238],["T_WHITESPACE"," ",238],["T_FUNCTION","function",238],["T_WHITESPACE"," ",238],["T_STRING","importOrderPayment",238],"(",["T_STRING","Mage_Sales_Model_Order_Payment",238],["T_WHITESPACE"," ",238],["T_VARIABLE","$payment",238],")",["T_WHITESPACE","\n    ",238],"{",["T_WHITESPACE","\n        ",239],["T_VARIABLE","$baData",240],["T_WHITESPACE"," ",240],"=",["T_WHITESPACE"," ",240],["T_VARIABLE","$payment",240],["T_OBJECT_OPERATOR","->",240],["T_STRING","getBillingAgreementData",240],"(",")",";",["T_WHITESPACE","\n\n        ",240],["T_VARIABLE","$this",242],["T_OBJECT_OPERATOR","->",242],["T_STRING","_paymentMethodInstance",242],["T_WHITESPACE"," ",242],"=",["T_WHITESPACE"," ",242],"(",["T_ISSET","isset",242],"(",["T_VARIABLE","$baData",242],"[",["T_CONSTANT_ENCAPSED_STRING","'method_code'",242],"]",")",")",["T_WHITESPACE","\n            ",242],"?",["T_WHITESPACE"," ",243],["T_STRING","Mage",243],["T_DOUBLE_COLON","::",243],["T_STRING","helper",243],"(",["T_CONSTANT_ENCAPSED_STRING","'payment'",243],")",["T_OBJECT_OPERATOR","->",243],["T_STRING","getMethodInstance",243],"(",["T_VARIABLE","$baData",243],"[",["T_CONSTANT_ENCAPSED_STRING","'method_code'",243],"]",")",["T_WHITESPACE","\n            ",243],":",["T_WHITESPACE"," ",244],["T_VARIABLE","$payment",244],["T_OBJECT_OPERATOR","->",244],["T_STRING","getMethodInstance",244],"(",")",";",["T_WHITESPACE","\n        ",244],["T_IF","if",245],["T_WHITESPACE"," ",245],"(",["T_VARIABLE","$this",245],["T_OBJECT_OPERATOR","->",245],["T_STRING","_paymentMethodInstance",245],")",["T_WHITESPACE"," ",245],"{",["T_WHITESPACE","\n            ",245],["T_VARIABLE","$this",246],["T_OBJECT_OPERATOR","->",246],["T_STRING","_paymentMethodInstance",246],["T_OBJECT_OPERATOR","->",246],["T_STRING","setStore",246],"(",["T_VARIABLE","$payment",246],["T_OBJECT_OPERATOR","->",246],["T_STRING","getMethodInstance",246],"(",")",["T_OBJECT_OPERATOR","->",246],["T_STRING","getStore",246],"(",")",")",";",["T_WHITESPACE","\n            ",246],["T_VARIABLE","$this",247],["T_OBJECT_OPERATOR","->",247],["T_STRING","setCustomerId",247],"(",["T_VARIABLE","$payment",247],["T_OBJECT_OPERATOR","->",247],["T_STRING","getOrder",247],"(",")",["T_OBJECT_OPERATOR","->",247],["T_STRING","getCustomerId",247],"(",")",")",["T_WHITESPACE","\n                ",247],["T_OBJECT_OPERATOR","->",248],["T_STRING","setMethodCode",248],"(",["T_VARIABLE","$this",248],["T_OBJECT_OPERATOR","->",248],["T_STRING","_paymentMethodInstance",248],["T_OBJECT_OPERATOR","->",248],["T_STRING","getCode",248],"(",")",")",["T_WHITESPACE","\n                ",248],["T_OBJECT_OPERATOR","->",249],["T_STRING","setReferenceId",249],"(",["T_VARIABLE","$baData",249],"[",["T_CONSTANT_ENCAPSED_STRING","'billing_agreement_id'",249],"]",")",["T_WHITESPACE","\n                ",249],["T_OBJECT_OPERATOR","->",250],["T_STRING","setStatus",250],"(",["T_STRING","self",250],["T_DOUBLE_COLON","::",250],["T_STRING","STATUS_ACTIVE",250],")",";",["T_WHITESPACE","\n        ",250],"}",["T_WHITESPACE","\n        ",251],["T_RETURN","return",252],["T_WHITESPACE"," ",252],["T_VARIABLE","$this",252],";",["T_WHITESPACE","\n    ",252],"}",["T_WHITESPACE","\n\n    ",253],["T_DOC_COMMENT","\/**\n     * Retrieve available customer Billing Agreements\n     *\n     * @param int $customer\n     * @return Mage_Paypal_Controller_Express_Abstract\n     *\/",255],["T_WHITESPACE","\n    ",260],["T_PUBLIC","public",261],["T_WHITESPACE"," ",261],["T_FUNCTION","function",261],["T_WHITESPACE"," ",261],["T_STRING","getAvailableCustomerBillingAgreements",261],"(",["T_VARIABLE","$customerId",261],")",["T_WHITESPACE","\n    ",261],"{",["T_WHITESPACE","\n        ",262],["T_VARIABLE","$collection",263],["T_WHITESPACE"," ",263],"=",["T_WHITESPACE"," ",263],["T_STRING","Mage",263],["T_DOUBLE_COLON","::",263],["T_STRING","getResourceModel",263],"(",["T_CONSTANT_ENCAPSED_STRING","'sales\/billing_agreement_collection'",263],")",";",["T_WHITESPACE","\n        ",263],["T_VARIABLE","$collection",264],["T_OBJECT_OPERATOR","->",264],["T_STRING","addFieldToFilter",264],"(",["T_CONSTANT_ENCAPSED_STRING","'customer_id'",264],",",["T_WHITESPACE"," ",264],["T_VARIABLE","$customerId",264],")",["T_WHITESPACE","\n            ",264],["T_OBJECT_OPERATOR","->",265],["T_STRING","addFieldToFilter",265],"(",["T_CONSTANT_ENCAPSED_STRING","'status'",265],",",["T_WHITESPACE"," ",265],["T_STRING","self",265],["T_DOUBLE_COLON","::",265],["T_STRING","STATUS_ACTIVE",265],")",["T_WHITESPACE","\n            ",265],["T_OBJECT_OPERATOR","->",266],["T_STRING","setOrder",266],"(",["T_CONSTANT_ENCAPSED_STRING","'agreement_id'",266],")",";",["T_WHITESPACE","\n        ",266],["T_RETURN","return",267],["T_WHITESPACE"," ",267],["T_VARIABLE","$collection",267],";",["T_WHITESPACE","\n    ",267],"}",["T_WHITESPACE","\n\n    ",268],["T_DOC_COMMENT","\/**\n     * Check whether need to create billing agreement for customer\n     *\n     * @param int $customerId\n     * @return bool\n     *\/",270],["T_WHITESPACE","\n    ",275],["T_PUBLIC","public",276],["T_WHITESPACE"," ",276],["T_FUNCTION","function",276],["T_WHITESPACE"," ",276],["T_STRING","needToCreateForCustomer",276],"(",["T_VARIABLE","$customerId",276],")",["T_WHITESPACE","\n    ",276],"{",["T_WHITESPACE","\n        ",277],["T_RETURN","return",278],["T_WHITESPACE"," ",278],["T_VARIABLE","$customerId",278],["T_WHITESPACE"," ",278],"?",["T_WHITESPACE"," ",278],["T_STRING","count",278],"(",["T_VARIABLE","$this",278],["T_OBJECT_OPERATOR","->",278],["T_STRING","getAvailableCustomerBillingAgreements",278],"(",["T_VARIABLE","$customerId",278],")",")",["T_WHITESPACE"," ",278],["T_IS_EQUAL","==",278],["T_WHITESPACE"," ",278],["T_LNUMBER","0",278],["T_WHITESPACE"," ",278],":",["T_WHITESPACE"," ",278],["T_STRING","false",278],";",["T_WHITESPACE","\n    ",278],"}",["T_WHITESPACE","\n\n    ",279],["T_DOC_COMMENT","\/**\n     * Add order relation to current billing agreement\n     *\n     * @param int|Mage_Sales_Model_Order $orderId\n     * @return Mage_Sales_Model_Billing_Agreement\n     *\/",281],["T_WHITESPACE","\n    ",286],["T_PUBLIC","public",287],["T_WHITESPACE"," ",287],["T_FUNCTION","function",287],["T_WHITESPACE"," ",287],["T_STRING","addOrderRelation",287],"(",["T_VARIABLE","$orderId",287],")",["T_WHITESPACE","\n    ",287],"{",["T_WHITESPACE","\n        ",288],["T_VARIABLE","$this",289],["T_OBJECT_OPERATOR","->",289],["T_STRING","_relatedOrders",289],"[","]",["T_WHITESPACE"," ",289],"=",["T_WHITESPACE"," ",289],["T_VARIABLE","$orderId",289],";",["T_WHITESPACE","\n        ",289],["T_RETURN","return",290],["T_WHITESPACE"," ",290],["T_VARIABLE","$this",290],";",["T_WHITESPACE","\n    ",290],"}",["T_WHITESPACE","\n\n    ",291],["T_DOC_COMMENT","\/**\n     * Save related orders\n     *\/",293],["T_WHITESPACE","\n    ",295],["T_PROTECTED","protected",296],["T_WHITESPACE"," ",296],["T_FUNCTION","function",296],["T_WHITESPACE"," ",296],["T_STRING","_saveOrderRelations",296],"(",")",["T_WHITESPACE","\n    ",296],"{",["T_WHITESPACE","\n        ",297],["T_FOREACH","foreach",298],["T_WHITESPACE"," ",298],"(",["T_VARIABLE","$this",298],["T_OBJECT_OPERATOR","->",298],["T_STRING","_relatedOrders",298],["T_WHITESPACE"," ",298],["T_AS","as",298],["T_WHITESPACE"," ",298],["T_VARIABLE","$order",298],")",["T_WHITESPACE"," ",298],"{",["T_WHITESPACE","\n            ",298],["T_VARIABLE","$orderId",299],["T_WHITESPACE"," ",299],"=",["T_WHITESPACE"," ",299],["T_VARIABLE","$order",299],["T_WHITESPACE"," ",299],["T_INSTANCEOF","instanceof",299],["T_WHITESPACE"," ",299],["T_STRING","Mage_Sales_Model_Order",299],["T_WHITESPACE"," ",299],"?",["T_WHITESPACE"," ",299],["T_VARIABLE","$order",299],["T_OBJECT_OPERATOR","->",299],["T_STRING","getId",299],"(",")",["T_WHITESPACE"," ",299],":",["T_WHITESPACE"," ",299],["T_INT_CAST","(int)",299],["T_WHITESPACE"," ",299],["T_VARIABLE","$order",299],";",["T_WHITESPACE","\n            ",299],["T_VARIABLE","$this",300],["T_OBJECT_OPERATOR","->",300],["T_STRING","getResource",300],"(",")",["T_OBJECT_OPERATOR","->",300],["T_STRING","addOrderRelation",300],"(",["T_VARIABLE","$this",300],["T_OBJECT_OPERATOR","->",300],["T_STRING","getId",300],"(",")",",",["T_WHITESPACE"," ",300],["T_VARIABLE","$orderId",300],")",";",["T_WHITESPACE","\n        ",300],"}",["T_WHITESPACE","\n    ",301],"}",["T_WHITESPACE","\n\n",302],"}",["T_WHITESPACE","\n",304]]