[["T_OPEN_TAG","<?php\n",1],["T_DOC_COMMENT","\/**\n * Magento\n *\n * NOTICE OF LICENSE\n *\n * This source file is subject to the Open Software License (OSL 3.0)\n * that is bundled with this package in the file LICENSE.txt.\n * It is also available through the world-wide-web at this URL:\n * http:\/\/opensource.org\/licenses\/osl-3.0.php\n * If you did not receive a copy of the license and are unable to\n * obtain it through the world-wide-web, please send an email\n * to license@magento.com so we can send you a copy immediately.\n *\n * DISCLAIMER\n *\n * Do not edit or add to this file if you wish to upgrade Magento to newer\n * versions in the future. If you wish to customize Magento for your\n * needs please refer to http:\/\/www.magento.com for more information.\n *\n * @category    Mage\n * @package     Mage_Sales\n * @copyright  Copyright (c) 2006-2016 X.commerce, Inc. and affiliates (http:\/\/www.magento.com)\n * @license    http:\/\/opensource.org\/licenses\/osl-3.0.php  Open Software License (OSL 3.0)\n *\/",2],["T_WHITESPACE","\n\n",25],["T_VARIABLE","$installer",27],["T_WHITESPACE"," ",27],"=",["T_WHITESPACE"," ",27],["T_VARIABLE","$this",27],";",["T_WHITESPACE","\n",27],["T_COMMENT","\/* @var $installer Mage_Sales_Model_Mysql4_Setup *\/",28],["T_WHITESPACE","\n\n",28],["T_VARIABLE","$installer",30],["T_OBJECT_OPERATOR","->",30],["T_STRING","getConnection",30],"(",")",["T_OBJECT_OPERATOR","->",30],["T_STRING","addColumn",30],"(",["T_VARIABLE","$this",30],["T_OBJECT_OPERATOR","->",30],["T_STRING","getTable",30],"(",["T_CONSTANT_ENCAPSED_STRING","'sales_order'",30],")",",",["T_WHITESPACE"," ",30],["T_CONSTANT_ENCAPSED_STRING","'discount_refunded'",30],",",["T_WHITESPACE"," ",30],["T_CONSTANT_ENCAPSED_STRING","'decimal(12,4) default NULL AFTER `subtotal_canceled`'",30],")",";",["T_WHITESPACE","\n",30],["T_VARIABLE","$installer",31],["T_OBJECT_OPERATOR","->",31],["T_STRING","getConnection",31],"(",")",["T_OBJECT_OPERATOR","->",31],["T_STRING","addColumn",31],"(",["T_VARIABLE","$this",31],["T_OBJECT_OPERATOR","->",31],["T_STRING","getTable",31],"(",["T_CONSTANT_ENCAPSED_STRING","'sales_order'",31],")",",",["T_WHITESPACE"," ",31],["T_CONSTANT_ENCAPSED_STRING","'discount_canceled'",31],",",["T_WHITESPACE"," ",31],["T_CONSTANT_ENCAPSED_STRING","'decimal(12,4) default NULL AFTER `discount_refunded`'",31],")",";",["T_WHITESPACE","\n",31],["T_VARIABLE","$installer",32],["T_OBJECT_OPERATOR","->",32],["T_STRING","getConnection",32],"(",")",["T_OBJECT_OPERATOR","->",32],["T_STRING","addColumn",32],"(",["T_VARIABLE","$this",32],["T_OBJECT_OPERATOR","->",32],["T_STRING","getTable",32],"(",["T_CONSTANT_ENCAPSED_STRING","'sales_order'",32],")",",",["T_WHITESPACE"," ",32],["T_CONSTANT_ENCAPSED_STRING","'discount_invoiced'",32],",",["T_WHITESPACE"," ",32],["T_CONSTANT_ENCAPSED_STRING","'decimal(12,4) default NULL AFTER `discount_canceled`'",32],")",";",["T_WHITESPACE","\n",32],["T_VARIABLE","$installer",33],["T_OBJECT_OPERATOR","->",33],["T_STRING","getConnection",33],"(",")",["T_OBJECT_OPERATOR","->",33],["T_STRING","addColumn",33],"(",["T_VARIABLE","$this",33],["T_OBJECT_OPERATOR","->",33],["T_STRING","getTable",33],"(",["T_CONSTANT_ENCAPSED_STRING","'sales_order'",33],")",",",["T_WHITESPACE"," ",33],["T_CONSTANT_ENCAPSED_STRING","'base_discount_refunded'",33],",",["T_WHITESPACE"," ",33],["T_CONSTANT_ENCAPSED_STRING","'decimal(12,4) default NULL AFTER `base_subtotal_canceled`'",33],")",";",["T_WHITESPACE","\n",33],["T_VARIABLE","$installer",34],["T_OBJECT_OPERATOR","->",34],["T_STRING","getConnection",34],"(",")",["T_OBJECT_OPERATOR","->",34],["T_STRING","addColumn",34],"(",["T_VARIABLE","$this",34],["T_OBJECT_OPERATOR","->",34],["T_STRING","getTable",34],"(",["T_CONSTANT_ENCAPSED_STRING","'sales_order'",34],")",",",["T_WHITESPACE"," ",34],["T_CONSTANT_ENCAPSED_STRING","'base_discount_canceled'",34],",",["T_WHITESPACE"," ",34],["T_CONSTANT_ENCAPSED_STRING","'decimal(12,4) default NULL AFTER `base_discount_refunded`'",34],")",";",["T_WHITESPACE","\n",34],["T_VARIABLE","$installer",35],["T_OBJECT_OPERATOR","->",35],["T_STRING","getConnection",35],"(",")",["T_OBJECT_OPERATOR","->",35],["T_STRING","addColumn",35],"(",["T_VARIABLE","$this",35],["T_OBJECT_OPERATOR","->",35],["T_STRING","getTable",35],"(",["T_CONSTANT_ENCAPSED_STRING","'sales_order'",35],")",",",["T_WHITESPACE"," ",35],["T_CONSTANT_ENCAPSED_STRING","'base_discount_invoiced'",35],",",["T_WHITESPACE"," ",35],["T_CONSTANT_ENCAPSED_STRING","'decimal(12,4) default NULL AFTER `base_discount_canceled`'",35],")",";",["T_WHITESPACE","\n\n",35],["T_VARIABLE","$installer",37],["T_OBJECT_OPERATOR","->",37],["T_STRING","addAttribute",37],"(",["T_CONSTANT_ENCAPSED_STRING","'order'",37],",",["T_WHITESPACE"," ",37],["T_CONSTANT_ENCAPSED_STRING","'discount_refunded'",37],",",["T_WHITESPACE"," ",37],["T_ARRAY","array",37],"(",["T_CONSTANT_ENCAPSED_STRING","'type'",37],["T_DOUBLE_ARROW","=>",37],["T_CONSTANT_ENCAPSED_STRING","'static'",37],")",")",";",["T_WHITESPACE","\n",37],["T_VARIABLE","$installer",38],["T_OBJECT_OPERATOR","->",38],["T_STRING","addAttribute",38],"(",["T_CONSTANT_ENCAPSED_STRING","'order'",38],",",["T_WHITESPACE"," ",38],["T_CONSTANT_ENCAPSED_STRING","'discount_canceled'",38],",",["T_WHITESPACE"," ",38],["T_ARRAY","array",38],"(",["T_CONSTANT_ENCAPSED_STRING","'type'",38],["T_DOUBLE_ARROW","=>",38],["T_CONSTANT_ENCAPSED_STRING","'static'",38],")",")",";",["T_WHITESPACE","\n",38],["T_VARIABLE","$installer",39],["T_OBJECT_OPERATOR","->",39],["T_STRING","addAttribute",39],"(",["T_CONSTANT_ENCAPSED_STRING","'order'",39],",",["T_WHITESPACE"," ",39],["T_CONSTANT_ENCAPSED_STRING","'discount_invoiced'",39],",",["T_WHITESPACE"," ",39],["T_ARRAY","array",39],"(",["T_CONSTANT_ENCAPSED_STRING","'type'",39],["T_DOUBLE_ARROW","=>",39],["T_CONSTANT_ENCAPSED_STRING","'static'",39],")",")",";",["T_WHITESPACE","\n",39],["T_VARIABLE","$installer",40],["T_OBJECT_OPERATOR","->",40],["T_STRING","addAttribute",40],"(",["T_CONSTANT_ENCAPSED_STRING","'order'",40],",",["T_WHITESPACE"," ",40],["T_CONSTANT_ENCAPSED_STRING","'base_discount_refunded'",40],",",["T_WHITESPACE"," ",40],["T_ARRAY","array",40],"(",["T_CONSTANT_ENCAPSED_STRING","'type'",40],["T_DOUBLE_ARROW","=>",40],["T_CONSTANT_ENCAPSED_STRING","'static'",40],")",")",";",["T_WHITESPACE","\n",40],["T_VARIABLE","$installer",41],["T_OBJECT_OPERATOR","->",41],["T_STRING","addAttribute",41],"(",["T_CONSTANT_ENCAPSED_STRING","'order'",41],",",["T_WHITESPACE"," ",41],["T_CONSTANT_ENCAPSED_STRING","'base_discount_canceled'",41],",",["T_WHITESPACE"," ",41],["T_ARRAY","array",41],"(",["T_CONSTANT_ENCAPSED_STRING","'type'",41],["T_DOUBLE_ARROW","=>",41],["T_CONSTANT_ENCAPSED_STRING","'static'",41],")",")",";",["T_WHITESPACE","\n",41],["T_VARIABLE","$installer",42],["T_OBJECT_OPERATOR","->",42],["T_STRING","addAttribute",42],"(",["T_CONSTANT_ENCAPSED_STRING","'order'",42],",",["T_WHITESPACE"," ",42],["T_CONSTANT_ENCAPSED_STRING","'base_discount_invoiced'",42],",",["T_WHITESPACE"," ",42],["T_ARRAY","array",42],"(",["T_CONSTANT_ENCAPSED_STRING","'type'",42],["T_DOUBLE_ARROW","=>",42],["T_CONSTANT_ENCAPSED_STRING","'static'",42],")",")",";",["T_WHITESPACE","\n\n",42],["T_VARIABLE","$sql",44],["T_WHITESPACE"," ",44],"=",["T_WHITESPACE"," ",44],["T_CONSTANT_ENCAPSED_STRING","\"\n    SELECT `e_int`.`value` AS `order_id`,\n        SUM(e_decimal.value) AS `order_discount`,\n        SUM(e_decimal_base.value) AS `order_base_discount`\n    FROM `%s` AS `e_int`\n        INNER JOIN `%s` AS `e_decimal`\n            ON e_int.entity_id=e_decimal.entity_id AND e_decimal.attribute_id='%d'\n        INNER JOIN `%s` AS `e_decimal_base`\n            ON e_int.entity_id=e_decimal_base.entity_id AND e_decimal_base.attribute_id='%d'\n    WHERE e_int.entity_type_id='%d' AND e_int.attribute_id='%d'\n    GROUP BY `e_int`.`value`\n\"",44],";",["T_WHITESPACE","\n\n",55],["T_VARIABLE","$ordersEntity",57],["T_WHITESPACE"," ",57],"=",["T_WHITESPACE"," ",57],["T_VARIABLE","$installer",57],["T_OBJECT_OPERATOR","->",57],["T_STRING","getEntityType",57],"(",["T_CONSTANT_ENCAPSED_STRING","'order'",57],")",";",["T_WHITESPACE","\n",57],["T_COMMENT","\/\/ hardcoding `sales_order` due to change in config.xml for 'sales\/order'  from `sales_order` to `sales_flat_order`\n",58],["T_VARIABLE","$ordersEntity",59],"[",["T_CONSTANT_ENCAPSED_STRING","'entity_table'",59],"]",["T_WHITESPACE"," ",59],"=",["T_WHITESPACE"," ",59],["T_CONSTANT_ENCAPSED_STRING","'sales_order'",59],";",["T_WHITESPACE","\n",59],["T_VARIABLE","$ordersTable",60],["T_WHITESPACE"," ",60],"=",["T_WHITESPACE"," ",60],["T_VARIABLE","$installer",60],["T_OBJECT_OPERATOR","->",60],["T_STRING","getTable",60],"(",["T_VARIABLE","$ordersEntity",60],"[",["T_CONSTANT_ENCAPSED_STRING","'entity_table'",60],"]",")",";",["T_WHITESPACE","\n\n",60],["T_COMMENT","\/\/ Update discount_refunded (base_discount_refunded)\n",62],["T_VARIABLE","$entityTypeId",63],["T_WHITESPACE"," ",63],"=",["T_WHITESPACE"," ",63],["T_VARIABLE","$installer",63],["T_OBJECT_OPERATOR","->",63],["T_STRING","getEntityTypeId",63],"(",["T_CONSTANT_ENCAPSED_STRING","'creditmemo'",63],")",";",["T_WHITESPACE","\n",63],["T_VARIABLE","$orderAttributeId",64],["T_WHITESPACE"," ",64],"=",["T_WHITESPACE"," ",64],["T_VARIABLE","$installer",64],["T_OBJECT_OPERATOR","->",64],["T_STRING","getAttributeId",64],"(",["T_VARIABLE","$entityTypeId",64],",",["T_WHITESPACE"," ",64],["T_CONSTANT_ENCAPSED_STRING","'order_id'",64],")",";",["T_WHITESPACE","\n",64],["T_VARIABLE","$orderAttributeTable",65],["T_WHITESPACE"," ",65],"=",["T_WHITESPACE"," ",65],["T_VARIABLE","$installer",65],["T_OBJECT_OPERATOR","->",65],["T_STRING","getAttributeTable",65],"(",["T_VARIABLE","$entityTypeId",65],",",["T_WHITESPACE"," ",65],["T_CONSTANT_ENCAPSED_STRING","'order_id'",65],")",";",["T_WHITESPACE","\n",65],["T_VARIABLE","$discountAttributeId",66],["T_WHITESPACE"," ",66],"=",["T_WHITESPACE"," ",66],["T_VARIABLE","$installer",66],["T_OBJECT_OPERATOR","->",66],["T_STRING","getAttributeId",66],"(",["T_VARIABLE","$entityTypeId",66],",",["T_WHITESPACE"," ",66],["T_CONSTANT_ENCAPSED_STRING","'discount_amount'",66],")",";",["T_WHITESPACE","\n",66],["T_VARIABLE","$discountAttributeTable",67],["T_WHITESPACE"," ",67],"=",["T_WHITESPACE"," ",67],["T_VARIABLE","$installer",67],["T_OBJECT_OPERATOR","->",67],["T_STRING","getAttributeTable",67],"(",["T_VARIABLE","$entityTypeId",67],",",["T_WHITESPACE"," ",67],["T_CONSTANT_ENCAPSED_STRING","'discount_amount'",67],")",";",["T_WHITESPACE","\n",67],["T_VARIABLE","$baseDiscountAttributeId",68],["T_WHITESPACE"," ",68],"=",["T_WHITESPACE"," ",68],["T_VARIABLE","$installer",68],["T_OBJECT_OPERATOR","->",68],["T_STRING","getAttributeId",68],"(",["T_VARIABLE","$entityTypeId",68],",",["T_WHITESPACE"," ",68],["T_CONSTANT_ENCAPSED_STRING","'base_discount_amount'",68],")",";",["T_WHITESPACE","\n",68],["T_VARIABLE","$baseDiscountAttributeTable",69],["T_WHITESPACE"," ",69],"=",["T_WHITESPACE"," ",69],["T_VARIABLE","$installer",69],["T_OBJECT_OPERATOR","->",69],["T_STRING","getAttributeTable",69],"(",["T_VARIABLE","$entityTypeId",69],",",["T_WHITESPACE"," ",69],["T_CONSTANT_ENCAPSED_STRING","'base_discount_amount'",69],")",";",["T_WHITESPACE","\n\n",69],["T_VARIABLE","$temporaryTableName",71],["T_WHITESPACE"," ",71],"=",["T_WHITESPACE"," ",71],["T_CONSTANT_ENCAPSED_STRING","'sales_sql_update'",71],["T_WHITESPACE"," ",71],".",["T_WHITESPACE"," ",71],["T_STRING","crc32",71],"(",["T_STRING","uniqid",71],"(",["T_CONSTANT_ENCAPSED_STRING","'sales'",71],")",")",";",["T_WHITESPACE","\n\n",71],["T_VARIABLE","$preparedSql",73],["T_WHITESPACE"," ",73],"=",["T_WHITESPACE"," ",73],["T_CONSTANT_ENCAPSED_STRING","'CREATE TEMPORARY TABLE '",73],["T_WHITESPACE"," ",73],".",["T_WHITESPACE"," ",73],["T_VARIABLE","$installer",73],["T_OBJECT_OPERATOR","->",73],["T_STRING","getConnection",73],"(",")",["T_OBJECT_OPERATOR","->",73],["T_STRING","quoteIdentifier",73],"(",["T_VARIABLE","$temporaryTableName",73],")",["T_WHITESPACE"," ",73],".",["T_WHITESPACE"," ",73],["T_CONSTANT_ENCAPSED_STRING","' '",73],["T_WHITESPACE"," ",73],".",["T_WHITESPACE"," ",73],["T_STRING","sprintf",73],"(",["T_VARIABLE","$sql",73],",",["T_WHITESPACE","\n    ",73],["T_VARIABLE","$orderAttributeTable",74],",",["T_WHITESPACE","\n    ",74],["T_VARIABLE","$discountAttributeTable",75],",",["T_WHITESPACE","\n    ",75],["T_VARIABLE","$discountAttributeId",76],",",["T_WHITESPACE","\n    ",76],["T_VARIABLE","$baseDiscountAttributeTable",77],",",["T_WHITESPACE","\n    ",77],["T_VARIABLE","$baseDiscountAttributeId",78],",",["T_WHITESPACE","\n    ",78],["T_VARIABLE","$entityTypeId",79],",",["T_WHITESPACE","\n    ",79],["T_VARIABLE","$orderAttributeId",80],["T_WHITESPACE","\n",80],")",";",["T_WHITESPACE","\n\n",81],["T_VARIABLE","$installer",83],["T_OBJECT_OPERATOR","->",83],["T_STRING","getConnection",83],"(",")",["T_OBJECT_OPERATOR","->",83],["T_STRING","query",83],"(",["T_VARIABLE","$preparedSql",83],")",";",["T_WHITESPACE","\n",83],["T_VARIABLE","$select",84],["T_WHITESPACE"," ",84],"=",["T_WHITESPACE"," ",84],["T_VARIABLE","$installer",84],["T_OBJECT_OPERATOR","->",84],["T_STRING","getConnection",84],"(",")",["T_OBJECT_OPERATOR","->",84],["T_STRING","select",84],"(",")",";",["T_WHITESPACE","\n",84],["T_VARIABLE","$select",85],["T_OBJECT_OPERATOR","->",85],["T_STRING","join",85],"(",["T_ARRAY","array",85],"(",["T_CONSTANT_ENCAPSED_STRING","'to_update'",85],["T_WHITESPACE"," ",85],["T_DOUBLE_ARROW","=>",85],["T_WHITESPACE"," ",85],["T_VARIABLE","$temporaryTableName",85],")",",",["T_WHITESPACE"," \n    ",85],["T_CONSTANT_ENCAPSED_STRING","'to_update.order_id = main_table.entity_id'",86],",",["T_WHITESPACE"," \n    ",86],["T_ARRAY","array",87],"(",["T_WHITESPACE","\n        ",87],["T_CONSTANT_ENCAPSED_STRING","'discount_refunded'",88],["T_WHITESPACE"," ",88],["T_DOUBLE_ARROW","=>",88],["T_WHITESPACE"," ",88],["T_CONSTANT_ENCAPSED_STRING","'order_discount'",88],",",["T_WHITESPACE","\n        ",88],["T_CONSTANT_ENCAPSED_STRING","'base_discount_refunded'",89],["T_WHITESPACE"," ",89],["T_DOUBLE_ARROW","=>",89],["T_WHITESPACE"," ",89],["T_CONSTANT_ENCAPSED_STRING","'order_base_discount'",89],["T_WHITESPACE","\n    ",89],")",["T_WHITESPACE","\n",90],")",";",["T_WHITESPACE","\n\n",91],["T_VARIABLE","$installer",93],["T_OBJECT_OPERATOR","->",93],["T_STRING","getConnection",93],"(",")",["T_OBJECT_OPERATOR","->",93],["T_STRING","query",93],"(",["T_WHITESPACE","\n    ",93],["T_VARIABLE","$select",94],["T_OBJECT_OPERATOR","->",94],["T_STRING","crossUpdateFromSelect",94],"(",["T_ARRAY","array",94],"(",["T_CONSTANT_ENCAPSED_STRING","'main_table'",94],["T_DOUBLE_ARROW","=>",94],["T_VARIABLE","$ordersTable",94],")",")",["T_WHITESPACE","\n",94],")",";",["T_WHITESPACE","\n \n",95],["T_VARIABLE","$installer",97],["T_OBJECT_OPERATOR","->",97],["T_STRING","getConnection",97],"(",")",["T_OBJECT_OPERATOR","->",97],["T_STRING","query",97],"(",["T_WHITESPACE","\n    ",97],["T_CONSTANT_ENCAPSED_STRING","'DROP TEMPORARY TABLE '",98],["T_WHITESPACE"," ",98],".",["T_WHITESPACE"," ",98],["T_VARIABLE","$installer",98],["T_OBJECT_OPERATOR","->",98],["T_STRING","getConnection",98],"(",")",["T_OBJECT_OPERATOR","->",98],["T_STRING","quoteIdentifier",98],"(",["T_VARIABLE","$temporaryTableName",98],")",["T_WHITESPACE","\n",98],")",";",["T_WHITESPACE","\n\n",99],["T_COMMENT","\/\/ Update discount_invoiced (base_discount_invoiced)\n",101],["T_VARIABLE","$entityTypeId",102],["T_WHITESPACE"," ",102],"=",["T_WHITESPACE"," ",102],["T_VARIABLE","$installer",102],["T_OBJECT_OPERATOR","->",102],["T_STRING","getEntityTypeId",102],"(",["T_CONSTANT_ENCAPSED_STRING","'invoice'",102],")",";",["T_WHITESPACE","\n",102],["T_VARIABLE","$orderAttributeId",103],["T_WHITESPACE"," ",103],"=",["T_WHITESPACE"," ",103],["T_VARIABLE","$installer",103],["T_OBJECT_OPERATOR","->",103],["T_STRING","getAttributeId",103],"(",["T_VARIABLE","$entityTypeId",103],",",["T_WHITESPACE"," ",103],["T_CONSTANT_ENCAPSED_STRING","'order_id'",103],")",";",["T_WHITESPACE","\n",103],["T_VARIABLE","$orderAttributeTable",104],["T_WHITESPACE"," ",104],"=",["T_WHITESPACE"," ",104],["T_VARIABLE","$installer",104],["T_OBJECT_OPERATOR","->",104],["T_STRING","getAttributeTable",104],"(",["T_VARIABLE","$entityTypeId",104],",",["T_WHITESPACE"," ",104],["T_CONSTANT_ENCAPSED_STRING","'order_id'",104],")",";",["T_WHITESPACE","\n",104],["T_VARIABLE","$discountAttributeId",105],["T_WHITESPACE"," ",105],"=",["T_WHITESPACE"," ",105],["T_VARIABLE","$installer",105],["T_OBJECT_OPERATOR","->",105],["T_STRING","getAttributeId",105],"(",["T_VARIABLE","$entityTypeId",105],",",["T_WHITESPACE"," ",105],["T_CONSTANT_ENCAPSED_STRING","'discount_amount'",105],")",";",["T_WHITESPACE","\n",105],["T_VARIABLE","$discountAttributeTable",106],["T_WHITESPACE"," ",106],"=",["T_WHITESPACE"," ",106],["T_VARIABLE","$installer",106],["T_OBJECT_OPERATOR","->",106],["T_STRING","getAttributeTable",106],"(",["T_VARIABLE","$entityTypeId",106],",",["T_WHITESPACE"," ",106],["T_CONSTANT_ENCAPSED_STRING","'discount_amount'",106],")",";",["T_WHITESPACE","\n",106],["T_VARIABLE","$baseDiscountAttributeId",107],["T_WHITESPACE"," ",107],"=",["T_WHITESPACE"," ",107],["T_VARIABLE","$installer",107],["T_OBJECT_OPERATOR","->",107],["T_STRING","getAttributeId",107],"(",["T_VARIABLE","$entityTypeId",107],",",["T_WHITESPACE"," ",107],["T_CONSTANT_ENCAPSED_STRING","'base_discount_amount'",107],")",";",["T_WHITESPACE","\n",107],["T_VARIABLE","$baseDiscountAttributeTable",108],["T_WHITESPACE"," ",108],"=",["T_WHITESPACE"," ",108],["T_VARIABLE","$installer",108],["T_OBJECT_OPERATOR","->",108],["T_STRING","getAttributeTable",108],"(",["T_VARIABLE","$entityTypeId",108],",",["T_WHITESPACE"," ",108],["T_CONSTANT_ENCAPSED_STRING","'base_discount_amount'",108],")",";",["T_WHITESPACE","\n\n",108],["T_VARIABLE","$preparedSql",110],["T_WHITESPACE"," ",110],"=",["T_WHITESPACE"," ",110],["T_CONSTANT_ENCAPSED_STRING","'CREATE TEMPORARY TABLE '",110],["T_WHITESPACE"," ",110],".",["T_WHITESPACE"," ",110],["T_VARIABLE","$installer",110],["T_OBJECT_OPERATOR","->",110],["T_STRING","getConnection",110],"(",")",["T_OBJECT_OPERATOR","->",110],["T_STRING","quoteIdentifier",110],"(",["T_VARIABLE","$temporaryTableName",110],")",["T_WHITESPACE"," ",110],".",["T_WHITESPACE"," ",110],["T_CONSTANT_ENCAPSED_STRING","' '",110],["T_WHITESPACE"," ",110],".",["T_WHITESPACE"," ",110],["T_STRING","sprintf",110],"(",["T_VARIABLE","$sql",110],",",["T_WHITESPACE","\n    ",110],["T_VARIABLE","$orderAttributeTable",111],",",["T_WHITESPACE","\n    ",111],["T_VARIABLE","$discountAttributeTable",112],",",["T_WHITESPACE","\n    ",112],["T_VARIABLE","$discountAttributeId",113],",",["T_WHITESPACE","\n    ",113],["T_VARIABLE","$baseDiscountAttributeTable",114],",",["T_WHITESPACE","\n    ",114],["T_VARIABLE","$baseDiscountAttributeId",115],",",["T_WHITESPACE","\n    ",115],["T_VARIABLE","$entityTypeId",116],",",["T_WHITESPACE","\n    ",116],["T_VARIABLE","$orderAttributeId",117],["T_WHITESPACE","\n",117],")",";",["T_WHITESPACE","\n\n",118],["T_VARIABLE","$installer",120],["T_OBJECT_OPERATOR","->",120],["T_STRING","getConnection",120],"(",")",["T_OBJECT_OPERATOR","->",120],["T_STRING","query",120],"(",["T_VARIABLE","$preparedSql",120],")",";",["T_WHITESPACE","\n",120],["T_VARIABLE","$select",121],["T_WHITESPACE"," ",121],"=",["T_WHITESPACE"," ",121],["T_VARIABLE","$installer",121],["T_OBJECT_OPERATOR","->",121],["T_STRING","getConnection",121],"(",")",["T_OBJECT_OPERATOR","->",121],["T_STRING","select",121],"(",")",";",["T_WHITESPACE","\n",121],["T_VARIABLE","$select",122],["T_OBJECT_OPERATOR","->",122],["T_STRING","join",122],"(",["T_ARRAY","array",122],"(",["T_CONSTANT_ENCAPSED_STRING","'to_update'",122],["T_WHITESPACE"," ",122],["T_DOUBLE_ARROW","=>",122],["T_WHITESPACE"," ",122],["T_VARIABLE","$temporaryTableName",122],")",",",["T_WHITESPACE"," \n    ",122],["T_CONSTANT_ENCAPSED_STRING","'to_update.order_id = main_table.entity_id'",123],",",["T_WHITESPACE"," \n    ",123],["T_ARRAY","array",124],"(",["T_WHITESPACE","\n        ",124],["T_CONSTANT_ENCAPSED_STRING","'discount_invoiced'",125],["T_WHITESPACE"," ",125],["T_DOUBLE_ARROW","=>",125],["T_WHITESPACE"," ",125],["T_CONSTANT_ENCAPSED_STRING","'order_discount'",125],",",["T_WHITESPACE","\n        ",125],["T_CONSTANT_ENCAPSED_STRING","'base_discount_invoiced'",126],["T_WHITESPACE"," ",126],["T_DOUBLE_ARROW","=>",126],["T_WHITESPACE"," ",126],["T_CONSTANT_ENCAPSED_STRING","'order_base_discount'",126],["T_WHITESPACE","\n    ",126],")",["T_WHITESPACE","\n",127],")",";",["T_WHITESPACE","\n\n",128],["T_VARIABLE","$installer",130],["T_OBJECT_OPERATOR","->",130],["T_STRING","getConnection",130],"(",")",["T_OBJECT_OPERATOR","->",130],["T_STRING","query",130],"(",["T_WHITESPACE","\n    ",130],["T_VARIABLE","$select",131],["T_OBJECT_OPERATOR","->",131],["T_STRING","crossUpdateFromSelect",131],"(",["T_ARRAY","array",131],"(",["T_CONSTANT_ENCAPSED_STRING","'main_table'",131],["T_DOUBLE_ARROW","=>",131],["T_VARIABLE","$ordersTable",131],")",")",["T_WHITESPACE","\n",131],")",";",["T_WHITESPACE","\n \n",132],["T_VARIABLE","$installer",134],["T_OBJECT_OPERATOR","->",134],["T_STRING","getConnection",134],"(",")",["T_OBJECT_OPERATOR","->",134],["T_STRING","query",134],"(",["T_WHITESPACE","\n    ",134],["T_CONSTANT_ENCAPSED_STRING","'DROP TEMPORARY TABLE '",135],["T_WHITESPACE"," ",135],".",["T_WHITESPACE"," ",135],["T_VARIABLE","$installer",135],["T_OBJECT_OPERATOR","->",135],["T_STRING","getConnection",135],"(",")",["T_OBJECT_OPERATOR","->",135],["T_STRING","quoteIdentifier",135],"(",["T_VARIABLE","$temporaryTableName",135],")",["T_WHITESPACE","\n",135],")",";",["T_WHITESPACE","\n\n",136],["T_COMMENT","\/\/ Update discount_canceled (base_discount_canceled)\n",138],["T_VARIABLE","$statusAttributeId",139],["T_WHITESPACE"," ",139],"=",["T_WHITESPACE"," ",139],["T_VARIABLE","$installer",139],["T_OBJECT_OPERATOR","->",139],["T_STRING","getAttributeId",139],"(",["T_VARIABLE","$ordersEntity",139],"[",["T_CONSTANT_ENCAPSED_STRING","'entity_type_id'",139],"]",",",["T_WHITESPACE"," ",139],["T_CONSTANT_ENCAPSED_STRING","'status'",139],")",";",["T_WHITESPACE","\n",139],["T_COMMENT","\/\/ hardcoding `sales_order_varchar` due to change in config.xml for 'sales\/order'  from `sales_order` to `sales_flat_order`\n",140],["T_VARIABLE","$statusAttributeTable",141],["T_WHITESPACE"," ",141],"=",["T_WHITESPACE"," ",141],["T_VARIABLE","$installer",141],["T_OBJECT_OPERATOR","->",141],["T_STRING","getTable",141],"(",["T_VARIABLE","$ordersTable",141],".",["T_CONSTANT_ENCAPSED_STRING","'_varchar'",141],")",";",["T_WHITESPACE","\n\n",141],["T_VARIABLE","$select",143],["T_WHITESPACE"," ",143],"=",["T_WHITESPACE"," ",143],["T_VARIABLE","$installer",143],["T_OBJECT_OPERATOR","->",143],["T_STRING","getConnection",143],"(",")",["T_OBJECT_OPERATOR","->",143],["T_STRING","select",143],"(",")",";",["T_WHITESPACE","\n",143],["T_VARIABLE","$select",144],["T_OBJECT_OPERATOR","->",144],["T_STRING","from",144],"(",["T_WHITESPACE","\n        ",144],["T_ARRAY","array",145],"(",["T_CONSTANT_ENCAPSED_STRING","'s'",145],["T_WHITESPACE"," ",145],["T_DOUBLE_ARROW","=>",145],["T_WHITESPACE"," ",145],["T_VARIABLE","$statusAttributeTable",145],")",",",["T_WHITESPACE","\n        ",145],["T_ARRAY","array",146],"(",["T_CONSTANT_ENCAPSED_STRING","'order_id'",146],["T_WHITESPACE"," ",146],["T_DOUBLE_ARROW","=>",146],["T_WHITESPACE"," ",146],["T_CONSTANT_ENCAPSED_STRING","'s.entity_id'",146],")",["T_WHITESPACE","\n    ",146],")",["T_WHITESPACE","\n    ",147],["T_OBJECT_OPERATOR","->",148],["T_STRING","where",148],"(",["T_CONSTANT_ENCAPSED_STRING","'s.attribute_id=?'",148],",",["T_WHITESPACE"," ",148],["T_VARIABLE","$statusAttributeId",148],")",["T_WHITESPACE","\n    ",148],["T_OBJECT_OPERATOR","->",149],["T_STRING","where",149],"(",["T_CONSTANT_ENCAPSED_STRING","'s.value=?'",149],",",["T_WHITESPACE"," ",149],["T_STRING","Mage_Sales_Model_Order",149],["T_DOUBLE_COLON","::",149],["T_STRING","STATE_CANCELED",149],")",";",["T_WHITESPACE","\n\n",149],["T_VARIABLE","$installer",151],["T_OBJECT_OPERATOR","->",151],["T_STRING","run",151],"(","\"",["T_ENCAPSED_AND_WHITESPACE","\n    UPDATE `",151],["T_CURLY_OPEN","{",152],["T_VARIABLE","$ordersTable",152],"}",["T_ENCAPSED_AND_WHITESPACE","` SET\n        `discount_canceled`=`discount_amount`-`discount_invoiced`,\n        `base_discount_canceled`=`base_discount_amount`-`base_discount_invoiced`\n    WHERE `entity_id` IN(",152],["T_CURLY_OPEN","{",155],["T_VARIABLE","$select",155],["T_OBJECT_OPERATOR","->",155],["T_STRING","assemble",155],"(",")","}",["T_ENCAPSED_AND_WHITESPACE",");\n",155],"\"",")",";",["T_WHITESPACE","\n",156]]