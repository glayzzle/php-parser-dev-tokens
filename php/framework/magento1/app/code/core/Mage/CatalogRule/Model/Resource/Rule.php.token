[["T_OPEN_TAG","<?php\n",1],["T_DOC_COMMENT","\/**\n * Magento\n *\n * NOTICE OF LICENSE\n *\n * This source file is subject to the Open Software License (OSL 3.0)\n * that is bundled with this package in the file LICENSE.txt.\n * It is also available through the world-wide-web at this URL:\n * http:\/\/opensource.org\/licenses\/osl-3.0.php\n * If you did not receive a copy of the license and are unable to\n * obtain it through the world-wide-web, please send an email\n * to license@magento.com so we can send you a copy immediately.\n *\n * DISCLAIMER\n *\n * Do not edit or add to this file if you wish to upgrade Magento to newer\n * versions in the future. If you wish to customize Magento for your\n * needs please refer to http:\/\/www.magento.com for more information.\n *\n * @category    Mage\n * @package     Mage_CatalogRule\n * @copyright  Copyright (c) 2006-2016 X.commerce, Inc. and affiliates (http:\/\/www.magento.com)\n * @license    http:\/\/opensource.org\/licenses\/osl-3.0.php  Open Software License (OSL 3.0)\n *\/",2],["T_WHITESPACE","\n\n\n",25],["T_DOC_COMMENT","\/**\n * Catalog rules resource model\n *\n * @category    Mage\n * @package     Mage_CatalogRule\n * @author      Magento Core Team <core@magentocommerce.com>\n *\/",28],["T_WHITESPACE","\n",34],["T_CLASS","class",35],["T_WHITESPACE"," ",35],["T_STRING","Mage_CatalogRule_Model_Resource_Rule",35],["T_WHITESPACE"," ",35],["T_EXTENDS","extends",35],["T_WHITESPACE"," ",35],["T_STRING","Mage_Rule_Model_Resource_Abstract",35],["T_WHITESPACE","\n",35],"{",["T_WHITESPACE","\n    ",36],["T_DOC_COMMENT","\/**\n     * Store number of seconds in a day\n     *\/",37],["T_WHITESPACE","\n    ",39],["T_CONST","const",40],["T_WHITESPACE"," ",40],["T_STRING","SECONDS_IN_DAY",40],["T_WHITESPACE"," ",40],"=",["T_WHITESPACE"," ",40],["T_LNUMBER","86400",40],";",["T_WHITESPACE","\n\n    ",40],["T_DOC_COMMENT","\/**\n     * Number of products in range for insert\n     *\/",42],["T_WHITESPACE","\n    ",44],["T_CONST","const",45],["T_WHITESPACE"," ",45],["T_STRING","RANGE_PRODUCT_STEP",45],["T_WHITESPACE"," ",45],"=",["T_WHITESPACE"," ",45],["T_LNUMBER","1000000",45],";",["T_WHITESPACE","\n\n    ",45],["T_DOC_COMMENT","\/**\n     * Store associated with rule entities information map\n     *\n     * @var array\n     *\/",47],["T_WHITESPACE","\n    ",51],["T_PROTECTED","protected",52],["T_WHITESPACE"," ",52],["T_VARIABLE","$_associatedEntitiesMap",52],["T_WHITESPACE"," ",52],"=",["T_WHITESPACE"," ",52],["T_ARRAY","array",52],"(",["T_WHITESPACE","\n        ",52],["T_CONSTANT_ENCAPSED_STRING","'website'",53],["T_WHITESPACE"," ",53],["T_DOUBLE_ARROW","=>",53],["T_WHITESPACE"," ",53],["T_ARRAY","array",53],"(",["T_WHITESPACE","\n            ",53],["T_CONSTANT_ENCAPSED_STRING","'associations_table'",54],["T_WHITESPACE"," ",54],["T_DOUBLE_ARROW","=>",54],["T_WHITESPACE"," ",54],["T_CONSTANT_ENCAPSED_STRING","'catalogrule\/website'",54],",",["T_WHITESPACE","\n            ",54],["T_CONSTANT_ENCAPSED_STRING","'rule_id_field'",55],["T_WHITESPACE","      ",55],["T_DOUBLE_ARROW","=>",55],["T_WHITESPACE"," ",55],["T_CONSTANT_ENCAPSED_STRING","'rule_id'",55],",",["T_WHITESPACE","\n            ",55],["T_CONSTANT_ENCAPSED_STRING","'entity_id_field'",56],["T_WHITESPACE","    ",56],["T_DOUBLE_ARROW","=>",56],["T_WHITESPACE"," ",56],["T_CONSTANT_ENCAPSED_STRING","'website_id'",56],["T_WHITESPACE","\n        ",56],")",",",["T_WHITESPACE","\n        ",57],["T_CONSTANT_ENCAPSED_STRING","'customer_group'",58],["T_WHITESPACE"," ",58],["T_DOUBLE_ARROW","=>",58],["T_WHITESPACE"," ",58],["T_ARRAY","array",58],"(",["T_WHITESPACE","\n            ",58],["T_CONSTANT_ENCAPSED_STRING","'associations_table'",59],["T_WHITESPACE"," ",59],["T_DOUBLE_ARROW","=>",59],["T_WHITESPACE"," ",59],["T_CONSTANT_ENCAPSED_STRING","'catalogrule\/customer_group'",59],",",["T_WHITESPACE","\n            ",59],["T_CONSTANT_ENCAPSED_STRING","'rule_id_field'",60],["T_WHITESPACE","      ",60],["T_DOUBLE_ARROW","=>",60],["T_WHITESPACE"," ",60],["T_CONSTANT_ENCAPSED_STRING","'rule_id'",60],",",["T_WHITESPACE","\n            ",60],["T_CONSTANT_ENCAPSED_STRING","'entity_id_field'",61],["T_WHITESPACE","    ",61],["T_DOUBLE_ARROW","=>",61],["T_WHITESPACE"," ",61],["T_CONSTANT_ENCAPSED_STRING","'customer_group_id'",61],["T_WHITESPACE","\n        ",61],")",["T_WHITESPACE","\n    ",62],")",";",["T_WHITESPACE","\n\n    ",63],["T_DOC_COMMENT","\/**\n     * Factory instance\n     *\n     * @var Mage_Core_Model_Factory\n     *\/",65],["T_WHITESPACE","\n    ",69],["T_PROTECTED","protected",70],["T_WHITESPACE"," ",70],["T_VARIABLE","$_factory",70],";",["T_WHITESPACE","\n\n    ",70],["T_DOC_COMMENT","\/**\n     * App instance\n     *\n     * @var Mage_Core_Model_App\n     *\/",72],["T_WHITESPACE","\n    ",76],["T_PROTECTED","protected",77],["T_WHITESPACE"," ",77],["T_VARIABLE","$_app",77],";",["T_WHITESPACE","\n\n    ",77],["T_DOC_COMMENT","\/**\n     * Constructor with parameters\n     * Array of arguments with keys\n     *  - 'factory' Mage_Core_Model_Factory\n     *\n     * @param array $args\n     *\/",79],["T_WHITESPACE","\n    ",85],["T_PUBLIC","public",86],["T_WHITESPACE"," ",86],["T_FUNCTION","function",86],["T_WHITESPACE"," ",86],["T_STRING","__construct",86],"(",["T_ARRAY","array",86],["T_WHITESPACE"," ",86],["T_VARIABLE","$args",86],["T_WHITESPACE"," ",86],"=",["T_WHITESPACE"," ",86],["T_ARRAY","array",86],"(",")",")",["T_WHITESPACE","\n    ",86],"{",["T_WHITESPACE","\n        ",87],["T_VARIABLE","$this",88],["T_OBJECT_OPERATOR","->",88],["T_STRING","_factory",88],["T_WHITESPACE"," ",88],"=",["T_WHITESPACE"," ",88],"!",["T_EMPTY","empty",88],"(",["T_VARIABLE","$args",88],"[",["T_CONSTANT_ENCAPSED_STRING","'factory'",88],"]",")",["T_WHITESPACE"," ",88],"?",["T_WHITESPACE"," ",88],["T_VARIABLE","$args",88],"[",["T_CONSTANT_ENCAPSED_STRING","'factory'",88],"]",["T_WHITESPACE"," ",88],":",["T_WHITESPACE"," ",88],["T_STRING","Mage",88],["T_DOUBLE_COLON","::",88],["T_STRING","getSingleton",88],"(",["T_CONSTANT_ENCAPSED_STRING","'core\/factory'",88],")",";",["T_WHITESPACE","\n        ",88],["T_VARIABLE","$this",89],["T_OBJECT_OPERATOR","->",89],["T_STRING","_app",89],["T_WHITESPACE","     ",89],"=",["T_WHITESPACE"," ",89],"!",["T_EMPTY","empty",89],"(",["T_VARIABLE","$args",89],"[",["T_CONSTANT_ENCAPSED_STRING","'app'",89],"]",")",["T_WHITESPACE"," ",89],"?",["T_WHITESPACE"," ",89],["T_VARIABLE","$args",89],"[",["T_CONSTANT_ENCAPSED_STRING","'app'",89],"]",["T_WHITESPACE"," ",89],":",["T_WHITESPACE"," ",89],["T_STRING","Mage",89],["T_DOUBLE_COLON","::",89],["T_STRING","app",89],"(",")",";",["T_WHITESPACE","\n\n        ",89],["T_STRING","parent",91],["T_DOUBLE_COLON","::",91],["T_STRING","__construct",91],"(",")",";",["T_WHITESPACE","\n    ",91],"}",["T_WHITESPACE","\n\n    ",92],["T_DOC_COMMENT","\/**\n     * Initialize main table and table id field\n     *\/",94],["T_WHITESPACE","\n    ",96],["T_PROTECTED","protected",97],["T_WHITESPACE"," ",97],["T_FUNCTION","function",97],["T_WHITESPACE"," ",97],["T_STRING","_construct",97],"(",")",["T_WHITESPACE","\n    ",97],"{",["T_WHITESPACE","\n        ",98],["T_VARIABLE","$this",99],["T_OBJECT_OPERATOR","->",99],["T_STRING","_init",99],"(",["T_CONSTANT_ENCAPSED_STRING","'catalogrule\/rule'",99],",",["T_WHITESPACE"," ",99],["T_CONSTANT_ENCAPSED_STRING","'rule_id'",99],")",";",["T_WHITESPACE","\n    ",99],"}",["T_WHITESPACE","\n\n    ",100],["T_DOC_COMMENT","\/**\n     * Add customer group ids and website ids to rule data after load\n     *\n     * @param Mage_Core_Model_Abstract $object\n     *\n     * @return Mage_CatalogRule_Model_Resource_Rule\n     *\/",102],["T_WHITESPACE","\n    ",108],["T_PROTECTED","protected",109],["T_WHITESPACE"," ",109],["T_FUNCTION","function",109],["T_WHITESPACE"," ",109],["T_STRING","_afterLoad",109],"(",["T_STRING","Mage_Core_Model_Abstract",109],["T_WHITESPACE"," ",109],["T_VARIABLE","$object",109],")",["T_WHITESPACE","\n    ",109],"{",["T_WHITESPACE","\n        ",110],["T_VARIABLE","$object",111],["T_OBJECT_OPERATOR","->",111],["T_STRING","setData",111],"(",["T_CONSTANT_ENCAPSED_STRING","'customer_group_ids'",111],",",["T_WHITESPACE"," ",111],["T_ARRAY_CAST","(array)",111],["T_VARIABLE","$this",111],["T_OBJECT_OPERATOR","->",111],["T_STRING","getCustomerGroupIds",111],"(",["T_VARIABLE","$object",111],["T_OBJECT_OPERATOR","->",111],["T_STRING","getId",111],"(",")",")",")",";",["T_WHITESPACE","\n        ",111],["T_VARIABLE","$object",112],["T_OBJECT_OPERATOR","->",112],["T_STRING","setData",112],"(",["T_CONSTANT_ENCAPSED_STRING","'website_ids'",112],",",["T_WHITESPACE"," ",112],["T_ARRAY_CAST","(array)",112],["T_VARIABLE","$this",112],["T_OBJECT_OPERATOR","->",112],["T_STRING","getWebsiteIds",112],"(",["T_VARIABLE","$object",112],["T_OBJECT_OPERATOR","->",112],["T_STRING","getId",112],"(",")",")",")",";",["T_WHITESPACE","\n\n        ",112],["T_RETURN","return",114],["T_WHITESPACE"," ",114],["T_STRING","parent",114],["T_DOUBLE_COLON","::",114],["T_STRING","_afterLoad",114],"(",["T_VARIABLE","$object",114],")",";",["T_WHITESPACE","\n    ",114],"}",["T_WHITESPACE","\n\n    ",115],["T_DOC_COMMENT","\/**\n     * Bind catalog rule to customer group(s) and website(s).\n     * Update products which are matched for rule.\n     *\n     * @param Mage_Core_Model_Abstract $object\n     *\n     * @return Mage_CatalogRule_Model_Resource_Rule\n     *\/",117],["T_WHITESPACE","\n    ",124],["T_PROTECTED","protected",125],["T_WHITESPACE"," ",125],["T_FUNCTION","function",125],["T_WHITESPACE"," ",125],["T_STRING","_afterSave",125],"(",["T_STRING","Mage_Core_Model_Abstract",125],["T_WHITESPACE"," ",125],["T_VARIABLE","$object",125],")",["T_WHITESPACE","\n    ",125],"{",["T_WHITESPACE","\n        ",126],["T_IF","if",127],["T_WHITESPACE"," ",127],"(",["T_VARIABLE","$object",127],["T_OBJECT_OPERATOR","->",127],["T_STRING","hasWebsiteIds",127],"(",")",")",["T_WHITESPACE"," ",127],"{",["T_WHITESPACE","\n            ",127],["T_VARIABLE","$websiteIds",128],["T_WHITESPACE"," ",128],"=",["T_WHITESPACE"," ",128],["T_VARIABLE","$object",128],["T_OBJECT_OPERATOR","->",128],["T_STRING","getWebsiteIds",128],"(",")",";",["T_WHITESPACE","\n            ",128],["T_IF","if",129],["T_WHITESPACE"," ",129],"(","!",["T_STRING","is_array",129],"(",["T_VARIABLE","$websiteIds",129],")",")",["T_WHITESPACE"," ",129],"{",["T_WHITESPACE","\n                ",129],["T_VARIABLE","$websiteIds",130],["T_WHITESPACE"," ",130],"=",["T_WHITESPACE"," ",130],["T_STRING","explode",130],"(",["T_CONSTANT_ENCAPSED_STRING","','",130],",",["T_WHITESPACE"," ",130],["T_STRING_CAST","(string)",130],["T_VARIABLE","$websiteIds",130],")",";",["T_WHITESPACE","\n            ",130],"}",["T_WHITESPACE","\n            ",131],["T_VARIABLE","$this",132],["T_OBJECT_OPERATOR","->",132],["T_STRING","bindRuleToEntity",132],"(",["T_VARIABLE","$object",132],["T_OBJECT_OPERATOR","->",132],["T_STRING","getId",132],"(",")",",",["T_WHITESPACE"," ",132],["T_VARIABLE","$websiteIds",132],",",["T_WHITESPACE"," ",132],["T_CONSTANT_ENCAPSED_STRING","'website'",132],")",";",["T_WHITESPACE","\n        ",132],"}",["T_WHITESPACE","\n\n        ",133],["T_IF","if",135],["T_WHITESPACE"," ",135],"(",["T_VARIABLE","$object",135],["T_OBJECT_OPERATOR","->",135],["T_STRING","hasCustomerGroupIds",135],"(",")",")",["T_WHITESPACE"," ",135],"{",["T_WHITESPACE","\n            ",135],["T_VARIABLE","$customerGroupIds",136],["T_WHITESPACE"," ",136],"=",["T_WHITESPACE"," ",136],["T_VARIABLE","$object",136],["T_OBJECT_OPERATOR","->",136],["T_STRING","getCustomerGroupIds",136],"(",")",";",["T_WHITESPACE","\n            ",136],["T_IF","if",137],["T_WHITESPACE"," ",137],"(","!",["T_STRING","is_array",137],"(",["T_VARIABLE","$customerGroupIds",137],")",")",["T_WHITESPACE"," ",137],"{",["T_WHITESPACE","\n                ",137],["T_VARIABLE","$customerGroupIds",138],["T_WHITESPACE"," ",138],"=",["T_WHITESPACE"," ",138],["T_STRING","explode",138],"(",["T_CONSTANT_ENCAPSED_STRING","','",138],",",["T_WHITESPACE"," ",138],["T_STRING_CAST","(string)",138],["T_VARIABLE","$customerGroupIds",138],")",";",["T_WHITESPACE","\n            ",138],"}",["T_WHITESPACE","\n            ",139],["T_VARIABLE","$this",140],["T_OBJECT_OPERATOR","->",140],["T_STRING","bindRuleToEntity",140],"(",["T_VARIABLE","$object",140],["T_OBJECT_OPERATOR","->",140],["T_STRING","getId",140],"(",")",",",["T_WHITESPACE"," ",140],["T_VARIABLE","$customerGroupIds",140],",",["T_WHITESPACE"," ",140],["T_CONSTANT_ENCAPSED_STRING","'customer_group'",140],")",";",["T_WHITESPACE","\n        ",140],"}",["T_WHITESPACE","\n\n        ",141],["T_STRING","parent",143],["T_DOUBLE_COLON","::",143],["T_STRING","_afterSave",143],"(",["T_VARIABLE","$object",143],")",";",["T_WHITESPACE","\n        ",143],["T_RETURN","return",144],["T_WHITESPACE"," ",144],["T_VARIABLE","$this",144],";",["T_WHITESPACE","\n    ",144],"}",["T_WHITESPACE","\n\n    ",145],["T_DOC_COMMENT","\/**\n     * Deletes records in catalogrule\/product_data by rule ID and product IDs\n     *\n     * @param int $ruleId\n     * @param array $productIds\n     *\/",147],["T_WHITESPACE","\n    ",152],["T_PUBLIC","public",153],["T_WHITESPACE"," ",153],["T_FUNCTION","function",153],["T_WHITESPACE"," ",153],["T_STRING","cleanProductData",153],"(",["T_VARIABLE","$ruleId",153],",",["T_WHITESPACE"," ",153],["T_ARRAY","array",153],["T_WHITESPACE"," ",153],["T_VARIABLE","$productIds",153],["T_WHITESPACE"," ",153],"=",["T_WHITESPACE"," ",153],["T_ARRAY","array",153],"(",")",")",["T_WHITESPACE","\n    ",153],"{",["T_WHITESPACE","\n        ",154],["T_DOC_COMMENT","\/** @var $write Varien_Db_Adapter_Interface *\/",155],["T_WHITESPACE","\n        ",155],["T_VARIABLE","$write",156],["T_WHITESPACE"," ",156],"=",["T_WHITESPACE"," ",156],["T_VARIABLE","$this",156],["T_OBJECT_OPERATOR","->",156],["T_STRING","_getWriteAdapter",156],"(",")",";",["T_WHITESPACE","\n\n        ",156],["T_VARIABLE","$conditions",158],["T_WHITESPACE"," ",158],"=",["T_WHITESPACE"," ",158],["T_ARRAY","array",158],"(",["T_CONSTANT_ENCAPSED_STRING","'rule_id = ?'",158],["T_WHITESPACE"," ",158],["T_DOUBLE_ARROW","=>",158],["T_WHITESPACE"," ",158],["T_VARIABLE","$ruleId",158],")",";",["T_WHITESPACE","\n\n        ",158],["T_IF","if",160],["T_WHITESPACE"," ",160],"(",["T_STRING","count",160],"(",["T_VARIABLE","$productIds",160],")",["T_WHITESPACE"," ",160],">",["T_WHITESPACE"," ",160],["T_LNUMBER","0",160],")",["T_WHITESPACE"," ",160],"{",["T_WHITESPACE","\n            ",160],["T_VARIABLE","$conditions",161],"[",["T_CONSTANT_ENCAPSED_STRING","'product_id IN (?)'",161],"]",["T_WHITESPACE"," ",161],"=",["T_WHITESPACE"," ",161],["T_VARIABLE","$productIds",161],";",["T_WHITESPACE","\n        ",161],"}",["T_WHITESPACE","\n\n        ",162],["T_VARIABLE","$write",164],["T_OBJECT_OPERATOR","->",164],["T_STRING","delete",164],"(",["T_VARIABLE","$this",164],["T_OBJECT_OPERATOR","->",164],["T_STRING","getTable",164],"(",["T_CONSTANT_ENCAPSED_STRING","'catalogrule\/rule_product'",164],")",",",["T_WHITESPACE"," ",164],["T_VARIABLE","$conditions",164],")",";",["T_WHITESPACE","\n    ",164],"}",["T_WHITESPACE","\n\n    ",165],["T_DOC_COMMENT","\/**\n     * Return whether the product fits the rule\n     *\n     * @param Mage_CatalogRule_Model_Rule $rule\n     * @param Varien_Object $product\n     * @param array $websiteIds\n     * @return bool\n     *\/",167],["T_WHITESPACE","\n    ",174],["T_PUBLIC","public",175],["T_WHITESPACE"," ",175],["T_FUNCTION","function",175],["T_WHITESPACE"," ",175],["T_STRING","validateProduct",175],"(",["T_STRING","Mage_CatalogRule_Model_Rule",175],["T_WHITESPACE"," ",175],["T_VARIABLE","$rule",175],",",["T_WHITESPACE"," ",175],["T_STRING","Varien_Object",175],["T_WHITESPACE"," ",175],["T_VARIABLE","$product",175],",",["T_WHITESPACE"," ",175],["T_VARIABLE","$websiteIds",175],["T_WHITESPACE"," ",175],"=",["T_WHITESPACE"," ",175],["T_ARRAY","array",175],"(",")",")",["T_WHITESPACE","\n    ",175],"{",["T_WHITESPACE","\n        ",176],["T_DOC_COMMENT","\/** @var $helper Mage_Catalog_Helper_Product_Flat *\/",177],["T_WHITESPACE","\n        ",177],["T_VARIABLE","$helper",178],["T_WHITESPACE"," ",178],"=",["T_WHITESPACE"," ",178],["T_VARIABLE","$this",178],["T_OBJECT_OPERATOR","->",178],["T_STRING","_factory",178],["T_OBJECT_OPERATOR","->",178],["T_STRING","getHelper",178],"(",["T_CONSTANT_ENCAPSED_STRING","'catalog\/product_flat'",178],")",";",["T_WHITESPACE","\n        ",178],["T_IF","if",179],["T_WHITESPACE"," ",179],"(",["T_VARIABLE","$helper",179],["T_OBJECT_OPERATOR","->",179],["T_STRING","isEnabled",179],"(",")",["T_WHITESPACE"," ",179],["T_BOOLEAN_AND","&&",179],["T_WHITESPACE"," ",179],["T_VARIABLE","$helper",179],["T_OBJECT_OPERATOR","->",179],["T_STRING","isBuiltAllStores",179],"(",")",")",["T_WHITESPACE"," ",179],"{",["T_WHITESPACE","\n            ",179],["T_DOC_COMMENT","\/** @var $store Mage_Core_Model_Store *\/",180],["T_WHITESPACE","\n            ",180],["T_FOREACH","foreach",181],["T_WHITESPACE"," ",181],"(",["T_VARIABLE","$this",181],["T_OBJECT_OPERATOR","->",181],["T_STRING","_app",181],["T_OBJECT_OPERATOR","->",181],["T_STRING","getStores",181],"(",["T_STRING","false",181],")",["T_WHITESPACE"," ",181],["T_AS","as",181],["T_WHITESPACE"," ",181],["T_VARIABLE","$store",181],")",["T_WHITESPACE"," ",181],"{",["T_WHITESPACE","\n                ",181],["T_IF","if",182],["T_WHITESPACE"," ",182],"(",["T_STRING","count",182],"(",["T_VARIABLE","$websiteIds",182],")",["T_WHITESPACE"," ",182],["T_IS_EQUAL","==",182],["T_WHITESPACE"," ",182],["T_LNUMBER","0",182],["T_WHITESPACE"," ",182],["T_BOOLEAN_OR","||",182],["T_WHITESPACE"," ",182],["T_STRING","in_array",182],"(",["T_VARIABLE","$store",182],["T_OBJECT_OPERATOR","->",182],["T_STRING","getWebsiteId",182],"(",")",",",["T_WHITESPACE"," ",182],["T_VARIABLE","$websiteIds",182],")",")",["T_WHITESPACE"," ",182],"{",["T_WHITESPACE","\n                    ",182],["T_DOC_COMMENT","\/** @var $selectByStore Varien_Db_Select *\/",183],["T_WHITESPACE","\n                    ",183],["T_VARIABLE","$selectByStore",184],["T_WHITESPACE"," ",184],"=",["T_WHITESPACE"," ",184],["T_VARIABLE","$rule",184],["T_OBJECT_OPERATOR","->",184],["T_STRING","getProductFlatSelect",184],"(",["T_VARIABLE","$store",184],["T_OBJECT_OPERATOR","->",184],["T_STRING","getId",184],"(",")",")",";",["T_WHITESPACE","\n                    ",184],["T_VARIABLE","$selectByStore",185],["T_OBJECT_OPERATOR","->",185],["T_STRING","where",185],"(",["T_CONSTANT_ENCAPSED_STRING","'p.entity_id = ?'",185],",",["T_WHITESPACE"," ",185],["T_VARIABLE","$product",185],["T_OBJECT_OPERATOR","->",185],["T_STRING","getId",185],"(",")",")",";",["T_WHITESPACE","\n                    ",185],["T_VARIABLE","$selectByStore",186],["T_OBJECT_OPERATOR","->",186],["T_STRING","limit",186],"(",["T_LNUMBER","1",186],")",";",["T_WHITESPACE","\n                    ",186],["T_IF","if",187],["T_WHITESPACE"," ",187],"(",["T_VARIABLE","$this",187],["T_OBJECT_OPERATOR","->",187],["T_STRING","_getReadAdapter",187],"(",")",["T_OBJECT_OPERATOR","->",187],["T_STRING","fetchOne",187],"(",["T_VARIABLE","$selectByStore",187],")",")",["T_WHITESPACE"," ",187],"{",["T_WHITESPACE","\n                        ",187],["T_RETURN","return",188],["T_WHITESPACE"," ",188],["T_STRING","true",188],";",["T_WHITESPACE","\n                    ",188],"}",["T_WHITESPACE","\n                ",189],"}",["T_WHITESPACE","\n            ",190],"}",["T_WHITESPACE","\n            ",191],["T_RETURN","return",192],["T_WHITESPACE"," ",192],["T_STRING","false",192],";",["T_WHITESPACE","\n        ",192],"}",["T_WHITESPACE"," ",193],["T_ELSE","else",193],["T_WHITESPACE"," ",193],"{",["T_WHITESPACE","\n            ",193],["T_RETURN","return",194],["T_WHITESPACE"," ",194],["T_VARIABLE","$rule",194],["T_OBJECT_OPERATOR","->",194],["T_STRING","getConditions",194],"(",")",["T_OBJECT_OPERATOR","->",194],["T_STRING","validate",194],"(",["T_VARIABLE","$product",194],")",";",["T_WHITESPACE","\n        ",194],"}",["T_WHITESPACE","\n    ",195],"}",["T_WHITESPACE","\n\n    ",196],["T_DOC_COMMENT","\/**\n     * Inserts rule data into catalogrule\/rule_product table\n     *\n     * @param Mage_CatalogRule_Model_Rule $rule\n     * @param array $websiteIds\n     * @param array $productIds\n     *\/",198],["T_WHITESPACE","\n    ",204],["T_PUBLIC","public",205],["T_WHITESPACE"," ",205],["T_FUNCTION","function",205],["T_WHITESPACE"," ",205],["T_STRING","insertRuleData",205],"(",["T_STRING","Mage_CatalogRule_Model_Rule",205],["T_WHITESPACE"," ",205],["T_VARIABLE","$rule",205],",",["T_WHITESPACE"," ",205],["T_ARRAY","array",205],["T_WHITESPACE"," ",205],["T_VARIABLE","$websiteIds",205],",",["T_WHITESPACE"," ",205],["T_ARRAY","array",205],["T_WHITESPACE"," ",205],["T_VARIABLE","$productIds",205],["T_WHITESPACE"," ",205],"=",["T_WHITESPACE"," ",205],["T_ARRAY","array",205],"(",")",")",["T_WHITESPACE","\n    ",205],"{",["T_WHITESPACE","\n        ",206],["T_DOC_COMMENT","\/** @var $write Varien_Db_Adapter_Interface *\/",207],["T_WHITESPACE","\n        ",207],["T_VARIABLE","$write",208],["T_WHITESPACE"," ",208],"=",["T_WHITESPACE"," ",208],["T_VARIABLE","$this",208],["T_OBJECT_OPERATOR","->",208],["T_STRING","_getWriteAdapter",208],"(",")",";",["T_WHITESPACE","\n\n        ",208],["T_VARIABLE","$customerGroupIds",210],["T_WHITESPACE"," ",210],"=",["T_WHITESPACE"," ",210],["T_VARIABLE","$rule",210],["T_OBJECT_OPERATOR","->",210],["T_STRING","getCustomerGroupIds",210],"(",")",";",["T_WHITESPACE","\n\n        ",210],["T_VARIABLE","$fromTime",212],["T_WHITESPACE"," ",212],"=",["T_WHITESPACE"," ",212],["T_INT_CAST","(int)",212],["T_WHITESPACE"," ",212],["T_STRING","strtotime",212],"(",["T_VARIABLE","$rule",212],["T_OBJECT_OPERATOR","->",212],["T_STRING","getFromDate",212],"(",")",")",";",["T_WHITESPACE","\n        ",212],["T_VARIABLE","$toTime",213],["T_WHITESPACE"," ",213],"=",["T_WHITESPACE"," ",213],["T_INT_CAST","(int)",213],["T_WHITESPACE"," ",213],["T_STRING","strtotime",213],"(",["T_VARIABLE","$rule",213],["T_OBJECT_OPERATOR","->",213],["T_STRING","getToDate",213],"(",")",")",";",["T_WHITESPACE","\n        ",213],["T_VARIABLE","$toTime",214],["T_WHITESPACE"," ",214],"=",["T_WHITESPACE"," ",214],["T_VARIABLE","$toTime",214],["T_WHITESPACE"," ",214],"?",["T_WHITESPACE"," ",214],"(",["T_VARIABLE","$toTime",214],["T_WHITESPACE"," ",214],"+",["T_WHITESPACE"," ",214],["T_STRING","self",214],["T_DOUBLE_COLON","::",214],["T_STRING","SECONDS_IN_DAY",214],["T_WHITESPACE"," ",214],"-",["T_WHITESPACE"," ",214],["T_LNUMBER","1",214],")",["T_WHITESPACE"," ",214],":",["T_WHITESPACE"," ",214],["T_LNUMBER","0",214],";",["T_WHITESPACE","\n\n        ",214],["T_DOC_COMMENT","\/** @var Mage_Core_Model_Date $coreDate *\/",216],["T_WHITESPACE","\n        ",216],["T_VARIABLE","$coreDate",217],["T_WHITESPACE","  ",217],"=",["T_WHITESPACE"," ",217],["T_VARIABLE","$this",217],["T_OBJECT_OPERATOR","->",217],["T_STRING","_factory",217],["T_OBJECT_OPERATOR","->",217],["T_STRING","getModel",217],"(",["T_CONSTANT_ENCAPSED_STRING","'core\/date'",217],")",";",["T_WHITESPACE","\n        ",217],["T_VARIABLE","$timestamp",218],["T_WHITESPACE"," ",218],"=",["T_WHITESPACE"," ",218],["T_VARIABLE","$coreDate",218],["T_OBJECT_OPERATOR","->",218],["T_STRING","gmtTimestamp",218],"(",["T_CONSTANT_ENCAPSED_STRING","'Today'",218],")",";",["T_WHITESPACE","\n        ",218],["T_IF","if",219],["T_WHITESPACE"," ",219],"(",["T_VARIABLE","$fromTime",219],["T_WHITESPACE"," ",219],">",["T_WHITESPACE"," ",219],["T_VARIABLE","$timestamp",219],["T_WHITESPACE","\n            ",219],["T_BOOLEAN_OR","||",220],["T_WHITESPACE"," ",220],"(",["T_VARIABLE","$toTime",220],["T_WHITESPACE"," ",220],["T_BOOLEAN_AND","&&",220],["T_WHITESPACE"," ",220],["T_VARIABLE","$toTime",220],["T_WHITESPACE"," ",220],"<",["T_WHITESPACE"," ",220],["T_VARIABLE","$timestamp",220],")",["T_WHITESPACE","\n        ",220],")",["T_WHITESPACE"," ",221],"{",["T_WHITESPACE","\n            ",221],["T_RETURN","return",222],";",["T_WHITESPACE","\n        ",222],"}",["T_WHITESPACE","\n        ",223],["T_VARIABLE","$sortOrder",224],["T_WHITESPACE"," ",224],"=",["T_WHITESPACE"," ",224],["T_INT_CAST","(int)",224],["T_WHITESPACE"," ",224],["T_VARIABLE","$rule",224],["T_OBJECT_OPERATOR","->",224],["T_STRING","getSortOrder",224],"(",")",";",["T_WHITESPACE","\n        ",224],["T_VARIABLE","$actionOperator",225],["T_WHITESPACE"," ",225],"=",["T_WHITESPACE"," ",225],["T_VARIABLE","$rule",225],["T_OBJECT_OPERATOR","->",225],["T_STRING","getSimpleAction",225],"(",")",";",["T_WHITESPACE","\n        ",225],["T_VARIABLE","$actionAmount",226],["T_WHITESPACE"," ",226],"=",["T_WHITESPACE"," ",226],["T_DOUBLE_CAST","(float)",226],["T_WHITESPACE"," ",226],["T_VARIABLE","$rule",226],["T_OBJECT_OPERATOR","->",226],["T_STRING","getDiscountAmount",226],"(",")",";",["T_WHITESPACE","\n        ",226],["T_VARIABLE","$subActionOperator",227],["T_WHITESPACE"," ",227],"=",["T_WHITESPACE"," ",227],["T_VARIABLE","$rule",227],["T_OBJECT_OPERATOR","->",227],["T_STRING","getSubIsEnable",227],"(",")",["T_WHITESPACE"," ",227],"?",["T_WHITESPACE"," ",227],["T_VARIABLE","$rule",227],["T_OBJECT_OPERATOR","->",227],["T_STRING","getSubSimpleAction",227],"(",")",["T_WHITESPACE"," ",227],":",["T_WHITESPACE"," ",227],["T_CONSTANT_ENCAPSED_STRING","''",227],";",["T_WHITESPACE","\n        ",227],["T_VARIABLE","$subActionAmount",228],["T_WHITESPACE"," ",228],"=",["T_WHITESPACE"," ",228],["T_DOUBLE_CAST","(float)",228],["T_WHITESPACE"," ",228],["T_VARIABLE","$rule",228],["T_OBJECT_OPERATOR","->",228],["T_STRING","getSubDiscountAmount",228],"(",")",";",["T_WHITESPACE","\n        ",228],["T_VARIABLE","$actionStop",229],["T_WHITESPACE"," ",229],"=",["T_WHITESPACE"," ",229],["T_INT_CAST","(int)",229],["T_WHITESPACE"," ",229],["T_VARIABLE","$rule",229],["T_OBJECT_OPERATOR","->",229],["T_STRING","getStopRulesProcessing",229],"(",")",";",["T_WHITESPACE","\n        ",229],["T_DOC_COMMENT","\/** @var $helper Mage_Catalog_Helper_Product_Flat *\/",230],["T_WHITESPACE","\n        ",230],["T_VARIABLE","$helper",231],["T_WHITESPACE"," ",231],"=",["T_WHITESPACE"," ",231],["T_VARIABLE","$this",231],["T_OBJECT_OPERATOR","->",231],["T_STRING","_factory",231],["T_OBJECT_OPERATOR","->",231],["T_STRING","getHelper",231],"(",["T_CONSTANT_ENCAPSED_STRING","'catalog\/product_flat'",231],")",";",["T_WHITESPACE","\n\n        ",231],["T_IF","if",233],["T_WHITESPACE"," ",233],"(",["T_VARIABLE","$helper",233],["T_OBJECT_OPERATOR","->",233],["T_STRING","isEnabled",233],"(",")",["T_WHITESPACE"," ",233],["T_BOOLEAN_AND","&&",233],["T_WHITESPACE"," ",233],["T_VARIABLE","$helper",233],["T_OBJECT_OPERATOR","->",233],["T_STRING","isBuiltAllStores",233],"(",")",")",["T_WHITESPACE"," ",233],"{",["T_WHITESPACE","\n            ",233],["T_DOC_COMMENT","\/** @var $store Mage_Core_Model_Store *\/",234],["T_WHITESPACE","\n            ",234],["T_FOREACH","foreach",235],["T_WHITESPACE"," ",235],"(",["T_VARIABLE","$this",235],["T_OBJECT_OPERATOR","->",235],["T_STRING","_app",235],["T_OBJECT_OPERATOR","->",235],["T_STRING","getStores",235],"(",["T_STRING","false",235],")",["T_WHITESPACE"," ",235],["T_AS","as",235],["T_WHITESPACE"," ",235],["T_VARIABLE","$store",235],")",["T_WHITESPACE"," ",235],"{",["T_WHITESPACE","\n                ",235],["T_IF","if",236],["T_WHITESPACE"," ",236],"(",["T_STRING","in_array",236],"(",["T_VARIABLE","$store",236],["T_OBJECT_OPERATOR","->",236],["T_STRING","getWebsiteId",236],"(",")",",",["T_WHITESPACE"," ",236],["T_VARIABLE","$websiteIds",236],")",")",["T_WHITESPACE"," ",236],"{",["T_WHITESPACE","\n                    ",236],["T_DOC_COMMENT","\/** @var $selectByStore Varien_Db_Select *\/",237],["T_WHITESPACE","\n                    ",237],["T_VARIABLE","$selectByStore",238],["T_WHITESPACE"," ",238],"=",["T_WHITESPACE"," ",238],["T_VARIABLE","$rule",238],["T_OBJECT_OPERATOR","->",238],["T_STRING","getProductFlatSelect",238],"(",["T_VARIABLE","$store",238],["T_OBJECT_OPERATOR","->",238],["T_STRING","getId",238],"(",")",")",["T_WHITESPACE","\n                        ",238],["T_OBJECT_OPERATOR","->",239],["T_STRING","joinLeft",239],"(",["T_ARRAY","array",239],"(",["T_CONSTANT_ENCAPSED_STRING","'cg'",239],["T_WHITESPACE"," ",239],["T_DOUBLE_ARROW","=>",239],["T_WHITESPACE"," ",239],["T_VARIABLE","$this",239],["T_OBJECT_OPERATOR","->",239],["T_STRING","getTable",239],"(",["T_CONSTANT_ENCAPSED_STRING","'customer\/customer_group'",239],")",")",",",["T_WHITESPACE","\n                            ",239],["T_VARIABLE","$write",240],["T_OBJECT_OPERATOR","->",240],["T_STRING","quoteInto",240],"(",["T_CONSTANT_ENCAPSED_STRING","'cg.customer_group_id IN (?)'",240],",",["T_WHITESPACE"," ",240],["T_VARIABLE","$customerGroupIds",240],")",",",["T_WHITESPACE","\n                            ",240],["T_ARRAY","array",241],"(",["T_CONSTANT_ENCAPSED_STRING","'cg.customer_group_id'",241],")",")",["T_WHITESPACE","\n                        ",241],["T_OBJECT_OPERATOR","->",242],["T_STRING","reset",242],"(",["T_STRING","Varien_Db_Select",242],["T_DOUBLE_COLON","::",242],["T_STRING","COLUMNS",242],")",["T_WHITESPACE","\n                        ",242],["T_OBJECT_OPERATOR","->",243],["T_STRING","columns",243],"(",["T_ARRAY","array",243],"(",["T_WHITESPACE","\n                            ",243],["T_NEW","new",244],["T_WHITESPACE"," ",244],["T_STRING","Zend_Db_Expr",244],"(",["T_VARIABLE","$store",244],["T_OBJECT_OPERATOR","->",244],["T_STRING","getWebsiteId",244],"(",")",")",",",["T_WHITESPACE","\n                            ",244],["T_CONSTANT_ENCAPSED_STRING","'cg.customer_group_id'",245],",",["T_WHITESPACE","\n                            ",245],["T_CONSTANT_ENCAPSED_STRING","'p.entity_id'",246],",",["T_WHITESPACE","\n                            ",246],["T_NEW","new",247],["T_WHITESPACE"," ",247],["T_STRING","Zend_Db_Expr",247],"(",["T_VARIABLE","$rule",247],["T_OBJECT_OPERATOR","->",247],["T_STRING","getId",247],"(",")",")",",",["T_WHITESPACE","\n                            ",247],["T_NEW","new",248],["T_WHITESPACE"," ",248],["T_STRING","Zend_Db_Expr",248],"(",["T_VARIABLE","$fromTime",248],")",",",["T_WHITESPACE","\n                            ",248],["T_NEW","new",249],["T_WHITESPACE"," ",249],["T_STRING","Zend_Db_Expr",249],"(",["T_VARIABLE","$toTime",249],")",",",["T_WHITESPACE","\n                            ",249],["T_NEW","new",250],["T_WHITESPACE"," ",250],["T_STRING","Zend_Db_Expr",250],"(",["T_CONSTANT_ENCAPSED_STRING","\"'\"",250],["T_WHITESPACE"," ",250],".",["T_WHITESPACE"," ",250],["T_VARIABLE","$actionOperator",250],["T_WHITESPACE"," ",250],".",["T_WHITESPACE"," ",250],["T_CONSTANT_ENCAPSED_STRING","\"'\"",250],")",",",["T_WHITESPACE","\n                            ",250],["T_NEW","new",251],["T_WHITESPACE"," ",251],["T_STRING","Zend_Db_Expr",251],"(",["T_VARIABLE","$actionAmount",251],")",",",["T_WHITESPACE","\n                            ",251],["T_NEW","new",252],["T_WHITESPACE"," ",252],["T_STRING","Zend_Db_Expr",252],"(",["T_VARIABLE","$actionStop",252],")",",",["T_WHITESPACE","\n                            ",252],["T_NEW","new",253],["T_WHITESPACE"," ",253],["T_STRING","Zend_Db_Expr",253],"(",["T_VARIABLE","$sortOrder",253],")",",",["T_WHITESPACE","\n                            ",253],["T_NEW","new",254],["T_WHITESPACE"," ",254],["T_STRING","Zend_Db_Expr",254],"(",["T_CONSTANT_ENCAPSED_STRING","\"'\"",254],["T_WHITESPACE"," ",254],".",["T_WHITESPACE"," ",254],["T_VARIABLE","$subActionOperator",254],["T_WHITESPACE"," ",254],".",["T_WHITESPACE"," ",254],["T_CONSTANT_ENCAPSED_STRING","\"'\"",254],")",",",["T_WHITESPACE","\n                            ",254],["T_NEW","new",255],["T_WHITESPACE"," ",255],["T_STRING","Zend_Db_Expr",255],"(",["T_VARIABLE","$subActionAmount",255],")",",",["T_WHITESPACE","\n                        ",255],")",")",";",["T_WHITESPACE","\n\n                    ",256],["T_IF","if",258],["T_WHITESPACE"," ",258],"(",["T_STRING","count",258],"(",["T_VARIABLE","$productIds",258],")",["T_WHITESPACE"," ",258],">",["T_WHITESPACE"," ",258],["T_LNUMBER","0",258],")",["T_WHITESPACE"," ",258],"{",["T_WHITESPACE","\n                        ",258],["T_VARIABLE","$selectByStore",259],["T_OBJECT_OPERATOR","->",259],["T_STRING","where",259],"(",["T_CONSTANT_ENCAPSED_STRING","'p.entity_id IN (?)'",259],",",["T_WHITESPACE"," ",259],["T_STRING","array_keys",259],"(",["T_VARIABLE","$productIds",259],")",")",";",["T_WHITESPACE","\n                    ",259],"}",["T_WHITESPACE","\n\n                    ",260],["T_VARIABLE","$selects",262],["T_WHITESPACE"," ",262],"=",["T_WHITESPACE"," ",262],["T_VARIABLE","$write",262],["T_OBJECT_OPERATOR","->",262],["T_STRING","selectsByRange",262],"(",["T_CONSTANT_ENCAPSED_STRING","'entity_id'",262],",",["T_WHITESPACE"," ",262],["T_VARIABLE","$selectByStore",262],",",["T_WHITESPACE"," ",262],["T_STRING","self",262],["T_DOUBLE_COLON","::",262],["T_STRING","RANGE_PRODUCT_STEP",262],")",";",["T_WHITESPACE","\n                    ",262],["T_FOREACH","foreach",263],["T_WHITESPACE"," ",263],"(",["T_VARIABLE","$selects",263],["T_WHITESPACE"," ",263],["T_AS","as",263],["T_WHITESPACE"," ",263],["T_VARIABLE","$select",263],")",["T_WHITESPACE"," ",263],"{",["T_WHITESPACE","\n                        ",263],["T_VARIABLE","$write",264],["T_OBJECT_OPERATOR","->",264],["T_STRING","query",264],"(",["T_WHITESPACE","\n                            ",264],["T_VARIABLE","$write",265],["T_OBJECT_OPERATOR","->",265],["T_STRING","insertFromSelect",265],"(",["T_WHITESPACE","\n                                ",265],["T_VARIABLE","$select",266],",",["T_WHITESPACE"," ",266],["T_VARIABLE","$this",266],["T_OBJECT_OPERATOR","->",266],["T_STRING","getTable",266],"(",["T_CONSTANT_ENCAPSED_STRING","'catalogrule\/rule_product'",266],")",",",["T_WHITESPACE"," ",266],["T_ARRAY","array",266],"(",["T_WHITESPACE","\n                                    ",266],["T_CONSTANT_ENCAPSED_STRING","'website_id'",267],",",["T_WHITESPACE","\n                                    ",267],["T_CONSTANT_ENCAPSED_STRING","'customer_group_id'",268],",",["T_WHITESPACE","\n                                    ",268],["T_CONSTANT_ENCAPSED_STRING","'product_id'",269],",",["T_WHITESPACE","\n                                    ",269],["T_CONSTANT_ENCAPSED_STRING","'rule_id'",270],",",["T_WHITESPACE","\n                                    ",270],["T_CONSTANT_ENCAPSED_STRING","'from_time'",271],",",["T_WHITESPACE","\n                                    ",271],["T_CONSTANT_ENCAPSED_STRING","'to_time'",272],",",["T_WHITESPACE","\n                                    ",272],["T_CONSTANT_ENCAPSED_STRING","'action_operator'",273],",",["T_WHITESPACE","\n                                    ",273],["T_CONSTANT_ENCAPSED_STRING","'action_amount'",274],",",["T_WHITESPACE","\n                                    ",274],["T_CONSTANT_ENCAPSED_STRING","'action_stop'",275],",",["T_WHITESPACE","\n                                    ",275],["T_CONSTANT_ENCAPSED_STRING","'sort_order'",276],",",["T_WHITESPACE","\n                                    ",276],["T_CONSTANT_ENCAPSED_STRING","'sub_simple_action'",277],",",["T_WHITESPACE","\n                                    ",277],["T_CONSTANT_ENCAPSED_STRING","'sub_discount_amount'",278],",",["T_WHITESPACE","\n                                ",278],")",",",["T_WHITESPACE"," ",279],["T_STRING","Varien_Db_Adapter_Interface",279],["T_DOUBLE_COLON","::",279],["T_STRING","INSERT_IGNORE",279],["T_WHITESPACE","\n                            ",279],")",["T_WHITESPACE","\n                        ",280],")",";",["T_WHITESPACE","\n                    ",281],"}",["T_WHITESPACE","\n                ",282],"}",["T_WHITESPACE","\n            ",283],"}",["T_WHITESPACE","\n        ",284],"}",["T_WHITESPACE"," ",285],["T_ELSE","else",285],["T_WHITESPACE"," ",285],"{",["T_WHITESPACE","\n            ",285],["T_IF","if",286],["T_WHITESPACE"," ",286],"(",["T_STRING","count",286],"(",["T_VARIABLE","$productIds",286],")",["T_WHITESPACE"," ",286],["T_IS_EQUAL","==",286],["T_WHITESPACE"," ",286],["T_LNUMBER","0",286],")",["T_WHITESPACE"," ",286],"{",["T_WHITESPACE","\n                ",286],["T_STRING","Varien_Profiler",287],["T_DOUBLE_COLON","::",287],["T_STRING","start",287],"(",["T_CONSTANT_ENCAPSED_STRING","'__MATCH_PRODUCTS__'",287],")",";",["T_WHITESPACE","\n                ",287],["T_VARIABLE","$productIds",288],["T_WHITESPACE"," ",288],"=",["T_WHITESPACE"," ",288],["T_VARIABLE","$rule",288],["T_OBJECT_OPERATOR","->",288],["T_STRING","getMatchingProductIds",288],"(",")",";",["T_WHITESPACE","\n                ",288],["T_STRING","Varien_Profiler",289],["T_DOUBLE_COLON","::",289],["T_STRING","stop",289],"(",["T_CONSTANT_ENCAPSED_STRING","'__MATCH_PRODUCTS__'",289],")",";",["T_WHITESPACE","\n            ",289],"}",["T_WHITESPACE","\n\n            ",290],["T_VARIABLE","$rows",292],["T_WHITESPACE"," ",292],"=",["T_WHITESPACE"," ",292],["T_ARRAY","array",292],"(",")",";",["T_WHITESPACE","\n            ",292],["T_FOREACH","foreach",293],["T_WHITESPACE"," ",293],"(",["T_VARIABLE","$productIds",293],["T_WHITESPACE"," ",293],["T_AS","as",293],["T_WHITESPACE"," ",293],["T_VARIABLE","$productId",293],["T_WHITESPACE"," ",293],["T_DOUBLE_ARROW","=>",293],["T_WHITESPACE"," ",293],["T_VARIABLE","$validationByWebsite",293],")",["T_WHITESPACE"," ",293],"{",["T_WHITESPACE","\n                ",293],["T_FOREACH","foreach",294],["T_WHITESPACE"," ",294],"(",["T_VARIABLE","$websiteIds",294],["T_WHITESPACE"," ",294],["T_AS","as",294],["T_WHITESPACE"," ",294],["T_VARIABLE","$websiteId",294],")",["T_WHITESPACE"," ",294],"{",["T_WHITESPACE","\n                    ",294],["T_FOREACH","foreach",295],["T_WHITESPACE"," ",295],"(",["T_VARIABLE","$customerGroupIds",295],["T_WHITESPACE"," ",295],["T_AS","as",295],["T_WHITESPACE"," ",295],["T_VARIABLE","$customerGroupId",295],")",["T_WHITESPACE"," ",295],"{",["T_WHITESPACE","\n                        ",295],["T_IF","if",296],["T_WHITESPACE"," ",296],"(",["T_EMPTY","empty",296],"(",["T_VARIABLE","$validationByWebsite",296],"[",["T_VARIABLE","$websiteId",296],"]",")",")",["T_WHITESPACE"," ",296],"{",["T_WHITESPACE","\n                            ",296],["T_CONTINUE","continue",297],";",["T_WHITESPACE","\n                        ",297],"}",["T_WHITESPACE","\n                        ",298],["T_VARIABLE","$rows",299],"[","]",["T_WHITESPACE"," ",299],"=",["T_WHITESPACE"," ",299],["T_ARRAY","array",299],"(",["T_WHITESPACE","\n                            ",299],["T_CONSTANT_ENCAPSED_STRING","'rule_id'",300],["T_WHITESPACE","             ",300],["T_DOUBLE_ARROW","=>",300],["T_WHITESPACE"," ",300],["T_VARIABLE","$rule",300],["T_OBJECT_OPERATOR","->",300],["T_STRING","getId",300],"(",")",",",["T_WHITESPACE","\n                            ",300],["T_CONSTANT_ENCAPSED_STRING","'from_time'",301],["T_WHITESPACE","           ",301],["T_DOUBLE_ARROW","=>",301],["T_WHITESPACE"," ",301],["T_VARIABLE","$fromTime",301],",",["T_WHITESPACE","\n                            ",301],["T_CONSTANT_ENCAPSED_STRING","'to_time'",302],["T_WHITESPACE","             ",302],["T_DOUBLE_ARROW","=>",302],["T_WHITESPACE"," ",302],["T_VARIABLE","$toTime",302],",",["T_WHITESPACE","\n                            ",302],["T_CONSTANT_ENCAPSED_STRING","'website_id'",303],["T_WHITESPACE","          ",303],["T_DOUBLE_ARROW","=>",303],["T_WHITESPACE"," ",303],["T_VARIABLE","$websiteId",303],",",["T_WHITESPACE","\n                            ",303],["T_CONSTANT_ENCAPSED_STRING","'customer_group_id'",304],["T_WHITESPACE","   ",304],["T_DOUBLE_ARROW","=>",304],["T_WHITESPACE"," ",304],["T_VARIABLE","$customerGroupId",304],",",["T_WHITESPACE","\n                            ",304],["T_CONSTANT_ENCAPSED_STRING","'product_id'",305],["T_WHITESPACE","          ",305],["T_DOUBLE_ARROW","=>",305],["T_WHITESPACE"," ",305],["T_VARIABLE","$productId",305],",",["T_WHITESPACE","\n                            ",305],["T_CONSTANT_ENCAPSED_STRING","'action_operator'",306],["T_WHITESPACE","     ",306],["T_DOUBLE_ARROW","=>",306],["T_WHITESPACE"," ",306],["T_VARIABLE","$actionOperator",306],",",["T_WHITESPACE","\n                            ",306],["T_CONSTANT_ENCAPSED_STRING","'action_amount'",307],["T_WHITESPACE","       ",307],["T_DOUBLE_ARROW","=>",307],["T_WHITESPACE"," ",307],["T_VARIABLE","$actionAmount",307],",",["T_WHITESPACE","\n                            ",307],["T_CONSTANT_ENCAPSED_STRING","'action_stop'",308],["T_WHITESPACE","         ",308],["T_DOUBLE_ARROW","=>",308],["T_WHITESPACE"," ",308],["T_VARIABLE","$actionStop",308],",",["T_WHITESPACE","\n                            ",308],["T_CONSTANT_ENCAPSED_STRING","'sort_order'",309],["T_WHITESPACE","          ",309],["T_DOUBLE_ARROW","=>",309],["T_WHITESPACE"," ",309],["T_VARIABLE","$sortOrder",309],",",["T_WHITESPACE","\n                            ",309],["T_CONSTANT_ENCAPSED_STRING","'sub_simple_action'",310],["T_WHITESPACE","   ",310],["T_DOUBLE_ARROW","=>",310],["T_WHITESPACE"," ",310],["T_VARIABLE","$subActionOperator",310],",",["T_WHITESPACE","\n                            ",310],["T_CONSTANT_ENCAPSED_STRING","'sub_discount_amount'",311],["T_WHITESPACE"," ",311],["T_DOUBLE_ARROW","=>",311],["T_WHITESPACE"," ",311],["T_VARIABLE","$subActionAmount",311],",",["T_WHITESPACE","\n                        ",311],")",";",["T_WHITESPACE","\n\n                        ",312],["T_IF","if",314],["T_WHITESPACE"," ",314],"(",["T_STRING","count",314],"(",["T_VARIABLE","$rows",314],")",["T_WHITESPACE"," ",314],["T_IS_EQUAL","==",314],["T_WHITESPACE"," ",314],["T_LNUMBER","1000",314],")",["T_WHITESPACE"," ",314],"{",["T_WHITESPACE","\n                            ",314],["T_VARIABLE","$write",315],["T_OBJECT_OPERATOR","->",315],["T_STRING","insertMultiple",315],"(",["T_VARIABLE","$this",315],["T_OBJECT_OPERATOR","->",315],["T_STRING","getTable",315],"(",["T_CONSTANT_ENCAPSED_STRING","'catalogrule\/rule_product'",315],")",",",["T_WHITESPACE"," ",315],["T_VARIABLE","$rows",315],")",";",["T_WHITESPACE","\n                            ",315],["T_VARIABLE","$rows",316],["T_WHITESPACE"," ",316],"=",["T_WHITESPACE"," ",316],["T_ARRAY","array",316],"(",")",";",["T_WHITESPACE","\n                        ",316],"}",["T_WHITESPACE","\n                    ",317],"}",["T_WHITESPACE","\n                ",318],"}",["T_WHITESPACE","\n            ",319],"}",["T_WHITESPACE","\n\n            ",320],["T_IF","if",322],["T_WHITESPACE"," ",322],"(","!",["T_EMPTY","empty",322],"(",["T_VARIABLE","$rows",322],")",")",["T_WHITESPACE"," ",322],"{",["T_WHITESPACE","\n                ",322],["T_VARIABLE","$write",323],["T_OBJECT_OPERATOR","->",323],["T_STRING","insertMultiple",323],"(",["T_VARIABLE","$this",323],["T_OBJECT_OPERATOR","->",323],["T_STRING","getTable",323],"(",["T_CONSTANT_ENCAPSED_STRING","'catalogrule\/rule_product'",323],")",",",["T_WHITESPACE"," ",323],["T_VARIABLE","$rows",323],")",";",["T_WHITESPACE","\n            ",323],"}",["T_WHITESPACE","\n        ",324],"}",["T_WHITESPACE","\n    ",325],"}",["T_WHITESPACE","\n\n    ",326],["T_DOC_COMMENT","\/**\n     * Update products which are matched for rule\n     *\n     * @param Mage_CatalogRule_Model_Rule $rule\n     *\n     * @throws Exception\n     * @return Mage_CatalogRule_Model_Resource_Rule\n     *\/",328],["T_WHITESPACE","\n    ",335],["T_PUBLIC","public",336],["T_WHITESPACE"," ",336],["T_FUNCTION","function",336],["T_WHITESPACE"," ",336],["T_STRING","updateRuleProductData",336],"(",["T_STRING","Mage_CatalogRule_Model_Rule",336],["T_WHITESPACE"," ",336],["T_VARIABLE","$rule",336],")",["T_WHITESPACE","\n    ",336],"{",["T_WHITESPACE","\n        ",337],["T_VARIABLE","$ruleId",338],["T_WHITESPACE"," ",338],"=",["T_WHITESPACE"," ",338],["T_VARIABLE","$rule",338],["T_OBJECT_OPERATOR","->",338],["T_STRING","getId",338],"(",")",";",["T_WHITESPACE","\n        ",338],["T_VARIABLE","$write",339],["T_WHITESPACE","  ",339],"=",["T_WHITESPACE"," ",339],["T_VARIABLE","$this",339],["T_OBJECT_OPERATOR","->",339],["T_STRING","_getWriteAdapter",339],"(",")",";",["T_WHITESPACE","\n        ",339],["T_VARIABLE","$write",340],["T_OBJECT_OPERATOR","->",340],["T_STRING","beginTransaction",340],"(",")",";",["T_WHITESPACE","\n        ",340],["T_IF","if",341],["T_WHITESPACE"," ",341],"(",["T_VARIABLE","$rule",341],["T_OBJECT_OPERATOR","->",341],["T_STRING","getProductsFilter",341],"(",")",")",["T_WHITESPACE"," ",341],"{",["T_WHITESPACE","\n            ",341],["T_VARIABLE","$this",342],["T_OBJECT_OPERATOR","->",342],["T_STRING","cleanProductData",342],"(",["T_VARIABLE","$ruleId",342],",",["T_WHITESPACE"," ",342],["T_VARIABLE","$rule",342],["T_OBJECT_OPERATOR","->",342],["T_STRING","getProductsFilter",342],"(",")",")",";",["T_WHITESPACE","\n        ",342],"}",["T_WHITESPACE"," ",343],["T_ELSE","else",343],["T_WHITESPACE"," ",343],"{",["T_WHITESPACE","\n            ",343],["T_VARIABLE","$this",344],["T_OBJECT_OPERATOR","->",344],["T_STRING","cleanProductData",344],"(",["T_VARIABLE","$ruleId",344],")",";",["T_WHITESPACE","\n        ",344],"}",["T_WHITESPACE","\n\n        ",345],["T_IF","if",347],["T_WHITESPACE"," ",347],"(","!",["T_VARIABLE","$rule",347],["T_OBJECT_OPERATOR","->",347],["T_STRING","getIsActive",347],"(",")",")",["T_WHITESPACE"," ",347],"{",["T_WHITESPACE","\n            ",347],["T_VARIABLE","$write",348],["T_OBJECT_OPERATOR","->",348],["T_STRING","commit",348],"(",")",";",["T_WHITESPACE","\n            ",348],["T_RETURN","return",349],["T_WHITESPACE"," ",349],["T_VARIABLE","$this",349],";",["T_WHITESPACE","\n        ",349],"}",["T_WHITESPACE","\n\n        ",350],["T_VARIABLE","$websiteIds",352],["T_WHITESPACE"," ",352],"=",["T_WHITESPACE"," ",352],["T_VARIABLE","$rule",352],["T_OBJECT_OPERATOR","->",352],["T_STRING","getWebsiteIds",352],"(",")",";",["T_WHITESPACE","\n        ",352],["T_IF","if",353],["T_WHITESPACE"," ",353],"(","!",["T_STRING","is_array",353],"(",["T_VARIABLE","$websiteIds",353],")",")",["T_WHITESPACE"," ",353],"{",["T_WHITESPACE","\n            ",353],["T_VARIABLE","$websiteIds",354],["T_WHITESPACE"," ",354],"=",["T_WHITESPACE"," ",354],["T_STRING","explode",354],"(",["T_CONSTANT_ENCAPSED_STRING","','",354],",",["T_WHITESPACE"," ",354],["T_VARIABLE","$websiteIds",354],")",";",["T_WHITESPACE","\n        ",354],"}",["T_WHITESPACE","\n        ",355],["T_IF","if",356],["T_WHITESPACE"," ",356],"(",["T_EMPTY","empty",356],"(",["T_VARIABLE","$websiteIds",356],")",")",["T_WHITESPACE"," ",356],"{",["T_WHITESPACE","\n            ",356],["T_RETURN","return",357],["T_WHITESPACE"," ",357],["T_VARIABLE","$this",357],";",["T_WHITESPACE","\n        ",357],"}",["T_WHITESPACE","\n\n        ",358],["T_TRY","try",360],["T_WHITESPACE"," ",360],"{",["T_WHITESPACE","\n            ",360],["T_VARIABLE","$this",361],["T_OBJECT_OPERATOR","->",361],["T_STRING","insertRuleData",361],"(",["T_VARIABLE","$rule",361],",",["T_WHITESPACE"," ",361],["T_VARIABLE","$websiteIds",361],")",";",["T_WHITESPACE","\n            ",361],["T_VARIABLE","$write",362],["T_OBJECT_OPERATOR","->",362],["T_STRING","commit",362],"(",")",";",["T_WHITESPACE","\n        ",362],"}",["T_WHITESPACE"," ",363],["T_CATCH","catch",363],["T_WHITESPACE"," ",363],"(",["T_STRING","Exception",363],["T_WHITESPACE"," ",363],["T_VARIABLE","$e",363],")",["T_WHITESPACE"," ",363],"{",["T_WHITESPACE","\n            ",363],["T_VARIABLE","$write",364],["T_OBJECT_OPERATOR","->",364],["T_STRING","rollback",364],"(",")",";",["T_WHITESPACE","\n            ",364],["T_THROW","throw",365],["T_WHITESPACE"," ",365],["T_VARIABLE","$e",365],";",["T_WHITESPACE","\n        ",365],"}",["T_WHITESPACE","\n\n        ",366],["T_RETURN","return",368],["T_WHITESPACE"," ",368],["T_VARIABLE","$this",368],";",["T_WHITESPACE","\n    ",368],"}",["T_WHITESPACE","\n\n    ",369],["T_DOC_COMMENT","\/**\n     * Get all product ids matched for rule\n     *\n     * @param int $ruleId\n     *\n     * @return array\n     *\/",371],["T_WHITESPACE","\n    ",377],["T_PUBLIC","public",378],["T_WHITESPACE"," ",378],["T_FUNCTION","function",378],["T_WHITESPACE"," ",378],["T_STRING","getRuleProductIds",378],"(",["T_VARIABLE","$ruleId",378],")",["T_WHITESPACE","\n    ",378],"{",["T_WHITESPACE","\n        ",379],["T_VARIABLE","$read",380],["T_WHITESPACE"," ",380],"=",["T_WHITESPACE"," ",380],["T_VARIABLE","$this",380],["T_OBJECT_OPERATOR","->",380],["T_STRING","_getReadAdapter",380],"(",")",";",["T_WHITESPACE","\n        ",380],["T_VARIABLE","$select",381],["T_WHITESPACE"," ",381],"=",["T_WHITESPACE"," ",381],["T_VARIABLE","$read",381],["T_OBJECT_OPERATOR","->",381],["T_STRING","select",381],"(",")",["T_OBJECT_OPERATOR","->",381],["T_STRING","from",381],"(",["T_VARIABLE","$this",381],["T_OBJECT_OPERATOR","->",381],["T_STRING","getTable",381],"(",["T_CONSTANT_ENCAPSED_STRING","'catalogrule\/rule_product'",381],")",",",["T_WHITESPACE"," ",381],["T_CONSTANT_ENCAPSED_STRING","'product_id'",381],")",["T_WHITESPACE","\n            ",381],["T_OBJECT_OPERATOR","->",382],["T_STRING","where",382],"(",["T_CONSTANT_ENCAPSED_STRING","'rule_id=?'",382],",",["T_WHITESPACE"," ",382],["T_VARIABLE","$ruleId",382],")",";",["T_WHITESPACE","\n\n        ",382],["T_RETURN","return",384],["T_WHITESPACE"," ",384],["T_VARIABLE","$read",384],["T_OBJECT_OPERATOR","->",384],["T_STRING","fetchCol",384],"(",["T_VARIABLE","$select",384],")",";",["T_WHITESPACE","\n    ",384],"}",["T_WHITESPACE","\n\n    ",385],["T_DOC_COMMENT","\/**\n     * Remove catalog rules product prices for specified date range and product\n     *\n     * @param int|string $fromDate\n     * @param int|string $toDate\n     * @param int|null $productId\n     *\n     * @return Mage_CatalogRule_Model_Resource_Rule\n     *\/",387],["T_WHITESPACE","\n    ",395],["T_PUBLIC","public",396],["T_WHITESPACE"," ",396],["T_FUNCTION","function",396],["T_WHITESPACE"," ",396],["T_STRING","removeCatalogPricesForDateRange",396],"(",["T_VARIABLE","$fromDate",396],",",["T_WHITESPACE"," ",396],["T_VARIABLE","$toDate",396],",",["T_WHITESPACE"," ",396],["T_VARIABLE","$productId",396],["T_WHITESPACE"," ",396],"=",["T_WHITESPACE"," ",396],["T_STRING","null",396],")",["T_WHITESPACE","\n    ",396],"{",["T_WHITESPACE","\n        ",397],["T_VARIABLE","$write",398],["T_WHITESPACE"," ",398],"=",["T_WHITESPACE"," ",398],["T_VARIABLE","$this",398],["T_OBJECT_OPERATOR","->",398],["T_STRING","_getWriteAdapter",398],"(",")",";",["T_WHITESPACE","\n        ",398],["T_VARIABLE","$conds",399],["T_WHITESPACE"," ",399],"=",["T_WHITESPACE"," ",399],["T_ARRAY","array",399],"(",")",";",["T_WHITESPACE","\n        ",399],["T_VARIABLE","$cond",400],["T_WHITESPACE"," ",400],"=",["T_WHITESPACE"," ",400],["T_VARIABLE","$write",400],["T_OBJECT_OPERATOR","->",400],["T_STRING","quoteInto",400],"(",["T_CONSTANT_ENCAPSED_STRING","'rule_date between ?'",400],",",["T_WHITESPACE"," ",400],["T_VARIABLE","$this",400],["T_OBJECT_OPERATOR","->",400],["T_STRING","formatDate",400],"(",["T_VARIABLE","$fromDate",400],")",")",";",["T_WHITESPACE","\n        ",400],["T_VARIABLE","$cond",401],["T_WHITESPACE"," ",401],"=",["T_WHITESPACE"," ",401],["T_VARIABLE","$write",401],["T_OBJECT_OPERATOR","->",401],["T_STRING","quoteInto",401],"(",["T_VARIABLE","$cond",401],".",["T_CONSTANT_ENCAPSED_STRING","' and ?'",401],",",["T_WHITESPACE"," ",401],["T_VARIABLE","$this",401],["T_OBJECT_OPERATOR","->",401],["T_STRING","formatDate",401],"(",["T_VARIABLE","$toDate",401],")",")",";",["T_WHITESPACE","\n        ",401],["T_VARIABLE","$conds",402],"[","]",["T_WHITESPACE"," ",402],"=",["T_WHITESPACE"," ",402],["T_VARIABLE","$cond",402],";",["T_WHITESPACE","\n        ",402],["T_IF","if",403],["T_WHITESPACE"," ",403],"(","!",["T_STRING","is_null",403],"(",["T_VARIABLE","$productId",403],")",")",["T_WHITESPACE"," ",403],"{",["T_WHITESPACE","\n            ",403],["T_VARIABLE","$conds",404],"[","]",["T_WHITESPACE"," ",404],"=",["T_WHITESPACE"," ",404],["T_VARIABLE","$write",404],["T_OBJECT_OPERATOR","->",404],["T_STRING","quoteInto",404],"(",["T_CONSTANT_ENCAPSED_STRING","'product_id=?'",404],",",["T_WHITESPACE"," ",404],["T_VARIABLE","$productId",404],")",";",["T_WHITESPACE","\n        ",404],"}",["T_WHITESPACE","\n\n        ",405],["T_DOC_COMMENT","\/**\n         * Add information about affected products\n         * It can be used in processes which related with product price (like catalog index)\n         *\/",407],["T_WHITESPACE","\n        ",410],["T_VARIABLE","$select",411],["T_WHITESPACE"," ",411],"=",["T_WHITESPACE"," ",411],["T_VARIABLE","$this",411],["T_OBJECT_OPERATOR","->",411],["T_STRING","_getWriteAdapter",411],"(",")",["T_OBJECT_OPERATOR","->",411],["T_STRING","select",411],"(",")",["T_WHITESPACE","\n            ",411],["T_OBJECT_OPERATOR","->",412],["T_STRING","from",412],"(",["T_VARIABLE","$this",412],["T_OBJECT_OPERATOR","->",412],["T_STRING","getTable",412],"(",["T_CONSTANT_ENCAPSED_STRING","'catalogrule\/rule_product_price'",412],")",",",["T_WHITESPACE"," ",412],["T_CONSTANT_ENCAPSED_STRING","'product_id'",412],")",["T_WHITESPACE","\n            ",412],["T_OBJECT_OPERATOR","->",413],["T_STRING","where",413],"(",["T_STRING","implode",413],"(",["T_CONSTANT_ENCAPSED_STRING","' AND '",413],",",["T_WHITESPACE"," ",413],["T_VARIABLE","$conds",413],")",")",["T_WHITESPACE","\n            ",413],["T_OBJECT_OPERATOR","->",414],["T_STRING","group",414],"(",["T_CONSTANT_ENCAPSED_STRING","'product_id'",414],")",";",["T_WHITESPACE","\n\n        ",414],["T_VARIABLE","$replace",416],["T_WHITESPACE"," ",416],"=",["T_WHITESPACE"," ",416],["T_VARIABLE","$write",416],["T_OBJECT_OPERATOR","->",416],["T_STRING","insertFromSelect",416],"(",["T_WHITESPACE","\n            ",416],["T_VARIABLE","$select",417],",",["T_WHITESPACE","\n            ",417],["T_VARIABLE","$this",418],["T_OBJECT_OPERATOR","->",418],["T_STRING","getTable",418],"(",["T_CONSTANT_ENCAPSED_STRING","'catalogrule\/affected_product'",418],")",",",["T_WHITESPACE","\n            ",418],["T_ARRAY","array",419],"(",["T_CONSTANT_ENCAPSED_STRING","'product_id'",419],")",",",["T_WHITESPACE","\n            ",419],["T_STRING","true",420],["T_WHITESPACE","\n        ",420],")",";",["T_WHITESPACE","\n        ",421],["T_VARIABLE","$write",422],["T_OBJECT_OPERATOR","->",422],["T_STRING","query",422],"(",["T_VARIABLE","$replace",422],")",";",["T_WHITESPACE","\n        ",422],["T_VARIABLE","$write",423],["T_OBJECT_OPERATOR","->",423],["T_STRING","delete",423],"(",["T_VARIABLE","$this",423],["T_OBJECT_OPERATOR","->",423],["T_STRING","getTable",423],"(",["T_CONSTANT_ENCAPSED_STRING","'catalogrule\/rule_product_price'",423],")",",",["T_WHITESPACE"," ",423],["T_VARIABLE","$conds",423],")",";",["T_WHITESPACE","\n        ",423],["T_RETURN","return",424],["T_WHITESPACE"," ",424],["T_VARIABLE","$this",424],";",["T_WHITESPACE","\n    ",424],"}",["T_WHITESPACE","\n\n    ",425],["T_DOC_COMMENT","\/**\n     * Delete old price rules data\n     *\n     * @param string $date\n     * @param int|null $productId\n     *\n     * @return Mage_CatalogRule_Model_Resource_Rule\n     *\/",427],["T_WHITESPACE","\n    ",434],["T_PUBLIC","public",435],["T_WHITESPACE"," ",435],["T_FUNCTION","function",435],["T_WHITESPACE"," ",435],["T_STRING","deleteOldData",435],"(",["T_VARIABLE","$date",435],",",["T_WHITESPACE"," ",435],["T_VARIABLE","$productId",435],["T_WHITESPACE"," ",435],"=",["T_WHITESPACE"," ",435],["T_STRING","null",435],")",["T_WHITESPACE","\n    ",435],"{",["T_WHITESPACE","\n        ",436],["T_VARIABLE","$write",437],["T_WHITESPACE"," ",437],"=",["T_WHITESPACE"," ",437],["T_VARIABLE","$this",437],["T_OBJECT_OPERATOR","->",437],["T_STRING","_getWriteAdapter",437],"(",")",";",["T_WHITESPACE","\n        ",437],["T_VARIABLE","$conds",438],["T_WHITESPACE"," ",438],"=",["T_WHITESPACE"," ",438],["T_ARRAY","array",438],"(",")",";",["T_WHITESPACE","\n        ",438],["T_VARIABLE","$conds",439],"[","]",["T_WHITESPACE"," ",439],"=",["T_WHITESPACE"," ",439],["T_VARIABLE","$write",439],["T_OBJECT_OPERATOR","->",439],["T_STRING","quoteInto",439],"(",["T_CONSTANT_ENCAPSED_STRING","'rule_date<?'",439],",",["T_WHITESPACE"," ",439],["T_VARIABLE","$this",439],["T_OBJECT_OPERATOR","->",439],["T_STRING","formatDate",439],"(",["T_VARIABLE","$date",439],")",")",";",["T_WHITESPACE","\n        ",439],["T_IF","if",440],["T_WHITESPACE"," ",440],"(","!",["T_STRING","is_null",440],"(",["T_VARIABLE","$productId",440],")",")",["T_WHITESPACE"," ",440],"{",["T_WHITESPACE","\n            ",440],["T_VARIABLE","$conds",441],"[","]",["T_WHITESPACE"," ",441],"=",["T_WHITESPACE"," ",441],["T_VARIABLE","$write",441],["T_OBJECT_OPERATOR","->",441],["T_STRING","quoteInto",441],"(",["T_CONSTANT_ENCAPSED_STRING","'product_id=?'",441],",",["T_WHITESPACE"," ",441],["T_VARIABLE","$productId",441],")",";",["T_WHITESPACE","\n        ",441],"}",["T_WHITESPACE","\n        ",442],["T_VARIABLE","$write",443],["T_OBJECT_OPERATOR","->",443],["T_STRING","delete",443],"(",["T_VARIABLE","$this",443],["T_OBJECT_OPERATOR","->",443],["T_STRING","getTable",443],"(",["T_CONSTANT_ENCAPSED_STRING","'catalogrule\/rule_product_price'",443],")",",",["T_WHITESPACE"," ",443],["T_VARIABLE","$conds",443],")",";",["T_WHITESPACE","\n        ",443],["T_RETURN","return",444],["T_WHITESPACE"," ",444],["T_VARIABLE","$this",444],";",["T_WHITESPACE","\n    ",444],"}",["T_WHITESPACE","\n\n    ",445],["T_DOC_COMMENT","\/**\n     * Get DB resource statement for processing query result\n     *\n     * @param int $fromDate\n     * @param int $toDate\n     * @param int|null $productId\n     * @param int|null $websiteId\n     *\n     * @return Zend_Db_Statement_Interface\n     *\/",447],["T_WHITESPACE","\n    ",456],["T_PROTECTED","protected",457],["T_WHITESPACE"," ",457],["T_FUNCTION","function",457],["T_WHITESPACE"," ",457],["T_STRING","_getRuleProductsStmt",457],"(",["T_VARIABLE","$fromDate",457],",",["T_WHITESPACE"," ",457],["T_VARIABLE","$toDate",457],",",["T_WHITESPACE"," ",457],["T_VARIABLE","$productId",457],["T_WHITESPACE"," ",457],"=",["T_WHITESPACE"," ",457],["T_STRING","null",457],",",["T_WHITESPACE"," ",457],["T_VARIABLE","$websiteId",457],["T_WHITESPACE"," ",457],"=",["T_WHITESPACE"," ",457],["T_STRING","null",457],")",["T_WHITESPACE","\n    ",457],"{",["T_WHITESPACE","\n        ",458],["T_VARIABLE","$read",459],["T_WHITESPACE"," ",459],"=",["T_WHITESPACE"," ",459],["T_VARIABLE","$this",459],["T_OBJECT_OPERATOR","->",459],["T_STRING","_getReadAdapter",459],"(",")",";",["T_WHITESPACE","\n        ",459],["T_DOC_COMMENT","\/**\n         * Sort order is important\n         * It used for check stop price rule condition.\n         * website_id   customer_group_id   product_id  sort_order\n         *  1           1                   1           0\n         *  1           1                   1           1\n         *  1           1                   1           2\n         * if row with sort order 1 will have stop flag we should exclude\n         * all next rows for same product id from price calculation\n         *\/",460],["T_WHITESPACE","\n        ",469],["T_VARIABLE","$select",470],["T_WHITESPACE"," ",470],"=",["T_WHITESPACE"," ",470],["T_VARIABLE","$read",470],["T_OBJECT_OPERATOR","->",470],["T_STRING","select",470],"(",")",["T_WHITESPACE","\n            ",470],["T_OBJECT_OPERATOR","->",471],["T_STRING","from",471],"(",["T_ARRAY","array",471],"(",["T_CONSTANT_ENCAPSED_STRING","'rp'",471],["T_WHITESPACE"," ",471],["T_DOUBLE_ARROW","=>",471],["T_WHITESPACE"," ",471],["T_VARIABLE","$this",471],["T_OBJECT_OPERATOR","->",471],["T_STRING","getTable",471],"(",["T_CONSTANT_ENCAPSED_STRING","'catalogrule\/rule_product'",471],")",")",")",["T_WHITESPACE","\n            ",471],["T_OBJECT_OPERATOR","->",472],["T_STRING","where",472],"(",["T_VARIABLE","$read",472],["T_OBJECT_OPERATOR","->",472],["T_STRING","quoteInto",472],"(",["T_CONSTANT_ENCAPSED_STRING","'rp.from_time = 0 or rp.from_time <= ?'",472],",",["T_WHITESPACE"," ",472],["T_VARIABLE","$toDate",472],")",["T_WHITESPACE","\n            ",472],".",["T_WHITESPACE"," ",473],["T_CONSTANT_ENCAPSED_STRING","' OR '",473],["T_WHITESPACE"," ",473],".",["T_WHITESPACE"," ",473],["T_VARIABLE","$read",473],["T_OBJECT_OPERATOR","->",473],["T_STRING","quoteInto",473],"(",["T_CONSTANT_ENCAPSED_STRING","'rp.to_time = 0 or rp.to_time >= ?'",473],",",["T_WHITESPACE"," ",473],["T_VARIABLE","$fromDate",473],")",")",["T_WHITESPACE","\n            ",473],["T_OBJECT_OPERATOR","->",474],["T_STRING","order",474],"(",["T_ARRAY","array",474],"(",["T_CONSTANT_ENCAPSED_STRING","'rp.website_id'",474],",",["T_WHITESPACE"," ",474],["T_CONSTANT_ENCAPSED_STRING","'rp.customer_group_id'",474],",",["T_WHITESPACE"," ",474],["T_CONSTANT_ENCAPSED_STRING","'rp.product_id'",474],",",["T_WHITESPACE"," ",474],["T_CONSTANT_ENCAPSED_STRING","'rp.sort_order'",474],",",["T_WHITESPACE"," ",474],["T_CONSTANT_ENCAPSED_STRING","'rp.rule_id'",474],")",")",";",["T_WHITESPACE","\n\n        ",474],["T_IF","if",476],["T_WHITESPACE"," ",476],"(","!",["T_STRING","is_null",476],"(",["T_VARIABLE","$productId",476],")",")",["T_WHITESPACE"," ",476],"{",["T_WHITESPACE","\n            ",476],["T_VARIABLE","$select",477],["T_OBJECT_OPERATOR","->",477],["T_STRING","where",477],"(",["T_CONSTANT_ENCAPSED_STRING","'rp.product_id=?'",477],",",["T_WHITESPACE"," ",477],["T_VARIABLE","$productId",477],")",";",["T_WHITESPACE","\n        ",477],"}",["T_WHITESPACE","\n\n        ",478],["T_DOC_COMMENT","\/**\n         * Join default price and websites prices to result\n         *\/",480],["T_WHITESPACE","\n        ",482],["T_VARIABLE","$priceAttr",483],["T_WHITESPACE","  ",483],"=",["T_WHITESPACE"," ",483],["T_STRING","Mage",483],["T_DOUBLE_COLON","::",483],["T_STRING","getSingleton",483],"(",["T_CONSTANT_ENCAPSED_STRING","'eav\/config'",483],")",["T_OBJECT_OPERATOR","->",483],["T_STRING","getAttribute",483],"(",["T_STRING","Mage_Catalog_Model_Product",483],["T_DOUBLE_COLON","::",483],["T_STRING","ENTITY",483],",",["T_WHITESPACE"," ",483],["T_CONSTANT_ENCAPSED_STRING","'price'",483],")",";",["T_WHITESPACE","\n        ",483],["T_VARIABLE","$priceTable",484],["T_WHITESPACE"," ",484],"=",["T_WHITESPACE"," ",484],["T_VARIABLE","$priceAttr",484],["T_OBJECT_OPERATOR","->",484],["T_STRING","getBackend",484],"(",")",["T_OBJECT_OPERATOR","->",484],["T_STRING","getTable",484],"(",")",";",["T_WHITESPACE","\n        ",484],["T_VARIABLE","$attributeId",485],"=",["T_WHITESPACE"," ",485],["T_VARIABLE","$priceAttr",485],["T_OBJECT_OPERATOR","->",485],["T_STRING","getId",485],"(",")",";",["T_WHITESPACE","\n\n        ",485],["T_VARIABLE","$joinCondition",487],["T_WHITESPACE"," ",487],"=",["T_WHITESPACE"," ",487],["T_CONSTANT_ENCAPSED_STRING","'%1$s.entity_id=rp.product_id AND (%1$s.attribute_id='",487],["T_WHITESPACE"," ",487],".",["T_WHITESPACE"," ",487],["T_VARIABLE","$attributeId",487],["T_WHITESPACE","\n            ",487],".",["T_WHITESPACE"," ",488],["T_CONSTANT_ENCAPSED_STRING","') and %1$s.store_id=%2$s'",488],";",["T_WHITESPACE","\n\n        ",488],["T_VARIABLE","$select",490],["T_OBJECT_OPERATOR","->",490],["T_STRING","join",490],"(",["T_WHITESPACE","\n            ",490],["T_ARRAY","array",491],"(",["T_CONSTANT_ENCAPSED_STRING","'pp_default'",491],["T_DOUBLE_ARROW","=>",491],["T_VARIABLE","$priceTable",491],")",",",["T_WHITESPACE","\n            ",491],["T_STRING","sprintf",492],"(",["T_VARIABLE","$joinCondition",492],",",["T_WHITESPACE"," ",492],["T_CONSTANT_ENCAPSED_STRING","'pp_default'",492],",",["T_WHITESPACE"," ",492],["T_STRING","Mage_Core_Model_App",492],["T_DOUBLE_COLON","::",492],["T_STRING","ADMIN_STORE_ID",492],")",",",["T_WHITESPACE","\n            ",492],["T_ARRAY","array",493],"(",["T_CONSTANT_ENCAPSED_STRING","'default_price'",493],["T_DOUBLE_ARROW","=>",493],["T_CONSTANT_ENCAPSED_STRING","'pp_default.value'",493],")",["T_WHITESPACE","\n        ",493],")",";",["T_WHITESPACE","\n\n        ",494],["T_IF","if",496],["T_WHITESPACE"," ",496],"(",["T_VARIABLE","$websiteId",496],["T_WHITESPACE"," ",496],["T_IS_NOT_IDENTICAL","!==",496],["T_WHITESPACE"," ",496],["T_STRING","null",496],")",["T_WHITESPACE"," ",496],"{",["T_WHITESPACE","\n            ",496],["T_VARIABLE","$website",497],["T_WHITESPACE","  ",497],"=",["T_WHITESPACE"," ",497],["T_STRING","Mage",497],["T_DOUBLE_COLON","::",497],["T_STRING","app",497],"(",")",["T_OBJECT_OPERATOR","->",497],["T_STRING","getWebsite",497],"(",["T_VARIABLE","$websiteId",497],")",";",["T_WHITESPACE","\n            ",497],["T_VARIABLE","$defaultGroup",498],["T_WHITESPACE"," ",498],"=",["T_WHITESPACE"," ",498],["T_VARIABLE","$website",498],["T_OBJECT_OPERATOR","->",498],["T_STRING","getDefaultGroup",498],"(",")",";",["T_WHITESPACE","\n            ",498],["T_IF","if",499],["T_WHITESPACE"," ",499],"(",["T_VARIABLE","$defaultGroup",499],["T_WHITESPACE"," ",499],["T_INSTANCEOF","instanceof",499],["T_WHITESPACE"," ",499],["T_STRING","Mage_Core_Model_Store_Group",499],")",["T_WHITESPACE"," ",499],"{",["T_WHITESPACE","\n                ",499],["T_VARIABLE","$storeId",500],["T_WHITESPACE"," ",500],"=",["T_WHITESPACE"," ",500],["T_VARIABLE","$defaultGroup",500],["T_OBJECT_OPERATOR","->",500],["T_STRING","getDefaultStoreId",500],"(",")",";",["T_WHITESPACE","\n            ",500],"}",["T_WHITESPACE"," ",501],["T_ELSE","else",501],["T_WHITESPACE"," ",501],"{",["T_WHITESPACE","\n                ",501],["T_VARIABLE","$storeId",502],["T_WHITESPACE"," ",502],"=",["T_WHITESPACE"," ",502],["T_STRING","Mage_Core_Model_App",502],["T_DOUBLE_COLON","::",502],["T_STRING","ADMIN_STORE_ID",502],";",["T_WHITESPACE","\n            ",502],"}",["T_WHITESPACE","\n\n            ",503],["T_VARIABLE","$select",505],["T_OBJECT_OPERATOR","->",505],["T_STRING","joinInner",505],"(",["T_WHITESPACE","\n                ",505],["T_ARRAY","array",506],"(",["T_CONSTANT_ENCAPSED_STRING","'product_website'",506],["T_WHITESPACE"," ",506],["T_DOUBLE_ARROW","=>",506],["T_WHITESPACE"," ",506],["T_VARIABLE","$this",506],["T_OBJECT_OPERATOR","->",506],["T_STRING","getTable",506],"(",["T_CONSTANT_ENCAPSED_STRING","'catalog\/product_website'",506],")",")",",",["T_WHITESPACE","\n                ",506],["T_CONSTANT_ENCAPSED_STRING","'product_website.product_id=rp.product_id '",507],["T_WHITESPACE"," ",507],".",["T_WHITESPACE","\n                ",507],["T_CONSTANT_ENCAPSED_STRING","'AND rp.website_id=product_website.website_id '",508],["T_WHITESPACE"," ",508],".",["T_WHITESPACE","\n                ",508],["T_CONSTANT_ENCAPSED_STRING","'AND product_website.website_id='",509],".",["T_VARIABLE","$websiteId",509],",",["T_WHITESPACE","\n                ",509],["T_ARRAY","array",510],"(",")",["T_WHITESPACE","\n            ",510],")",";",["T_WHITESPACE","\n\n            ",511],["T_VARIABLE","$tableAlias",513],["T_WHITESPACE"," ",513],"=",["T_WHITESPACE"," ",513],["T_CONSTANT_ENCAPSED_STRING","'pp'",513],".",["T_VARIABLE","$websiteId",513],";",["T_WHITESPACE","\n            ",513],["T_VARIABLE","$fieldAlias",514],["T_WHITESPACE"," ",514],"=",["T_WHITESPACE"," ",514],["T_CONSTANT_ENCAPSED_STRING","'website_'",514],".",["T_VARIABLE","$websiteId",514],".",["T_CONSTANT_ENCAPSED_STRING","'_price'",514],";",["T_WHITESPACE","\n            ",514],["T_VARIABLE","$select",515],["T_OBJECT_OPERATOR","->",515],["T_STRING","joinLeft",515],"(",["T_WHITESPACE","\n                ",515],["T_ARRAY","array",516],"(",["T_VARIABLE","$tableAlias",516],["T_DOUBLE_ARROW","=>",516],["T_VARIABLE","$priceTable",516],")",",",["T_WHITESPACE","\n                ",516],["T_STRING","sprintf",517],"(",["T_VARIABLE","$joinCondition",517],",",["T_WHITESPACE"," ",517],["T_VARIABLE","$tableAlias",517],",",["T_WHITESPACE"," ",517],["T_VARIABLE","$storeId",517],")",",",["T_WHITESPACE","\n                ",517],["T_ARRAY","array",518],"(",["T_VARIABLE","$fieldAlias",518],["T_DOUBLE_ARROW","=>",518],["T_VARIABLE","$tableAlias",518],".",["T_CONSTANT_ENCAPSED_STRING","'.value'",518],")",["T_WHITESPACE","\n            ",518],")",";",["T_WHITESPACE","\n        ",519],"}",["T_WHITESPACE"," ",520],["T_ELSE","else",520],["T_WHITESPACE"," ",520],"{",["T_WHITESPACE","\n            ",520],["T_FOREACH","foreach",521],["T_WHITESPACE"," ",521],"(",["T_STRING","Mage",521],["T_DOUBLE_COLON","::",521],["T_STRING","app",521],"(",")",["T_OBJECT_OPERATOR","->",521],["T_STRING","getWebsites",521],"(",")",["T_WHITESPACE"," ",521],["T_AS","as",521],["T_WHITESPACE"," ",521],["T_VARIABLE","$website",521],")",["T_WHITESPACE"," ",521],"{",["T_WHITESPACE","\n                ",521],["T_VARIABLE","$websiteId",522],["T_WHITESPACE","  ",522],"=",["T_WHITESPACE"," ",522],["T_VARIABLE","$website",522],["T_OBJECT_OPERATOR","->",522],["T_STRING","getId",522],"(",")",";",["T_WHITESPACE","\n                ",522],["T_VARIABLE","$defaultGroup",523],["T_WHITESPACE"," ",523],"=",["T_WHITESPACE"," ",523],["T_VARIABLE","$website",523],["T_OBJECT_OPERATOR","->",523],["T_STRING","getDefaultGroup",523],"(",")",";",["T_WHITESPACE","\n                ",523],["T_IF","if",524],["T_WHITESPACE"," ",524],"(",["T_VARIABLE","$defaultGroup",524],["T_WHITESPACE"," ",524],["T_INSTANCEOF","instanceof",524],["T_WHITESPACE"," ",524],["T_STRING","Mage_Core_Model_Store_Group",524],")",["T_WHITESPACE"," ",524],"{",["T_WHITESPACE","\n                    ",524],["T_VARIABLE","$storeId",525],["T_WHITESPACE"," ",525],"=",["T_WHITESPACE"," ",525],["T_VARIABLE","$defaultGroup",525],["T_OBJECT_OPERATOR","->",525],["T_STRING","getDefaultStoreId",525],"(",")",";",["T_WHITESPACE","\n                ",525],"}",["T_WHITESPACE"," ",526],["T_ELSE","else",526],["T_WHITESPACE"," ",526],"{",["T_WHITESPACE","\n                    ",526],["T_VARIABLE","$storeId",527],["T_WHITESPACE"," ",527],"=",["T_WHITESPACE"," ",527],["T_STRING","Mage_Core_Model_App",527],["T_DOUBLE_COLON","::",527],["T_STRING","ADMIN_STORE_ID",527],";",["T_WHITESPACE","\n                ",527],"}",["T_WHITESPACE","\n\n                ",528],["T_VARIABLE","$tableAlias",530],["T_WHITESPACE"," ",530],"=",["T_WHITESPACE"," ",530],["T_CONSTANT_ENCAPSED_STRING","'pp'",530],["T_WHITESPACE"," ",530],".",["T_WHITESPACE"," ",530],["T_VARIABLE","$websiteId",530],";",["T_WHITESPACE","\n                ",530],["T_VARIABLE","$fieldAlias",531],["T_WHITESPACE"," ",531],"=",["T_WHITESPACE"," ",531],["T_CONSTANT_ENCAPSED_STRING","'website_'",531],["T_WHITESPACE"," ",531],".",["T_WHITESPACE"," ",531],["T_VARIABLE","$websiteId",531],["T_WHITESPACE"," ",531],".",["T_WHITESPACE"," ",531],["T_CONSTANT_ENCAPSED_STRING","'_price'",531],";",["T_WHITESPACE","\n                ",531],["T_VARIABLE","$select",532],["T_OBJECT_OPERATOR","->",532],["T_STRING","joinLeft",532],"(",["T_WHITESPACE","\n                    ",532],["T_ARRAY","array",533],"(",["T_VARIABLE","$tableAlias",533],["T_WHITESPACE"," ",533],["T_DOUBLE_ARROW","=>",533],["T_WHITESPACE"," ",533],["T_VARIABLE","$priceTable",533],")",",",["T_WHITESPACE","\n                    ",533],["T_STRING","sprintf",534],"(",["T_VARIABLE","$joinCondition",534],",",["T_WHITESPACE"," ",534],["T_VARIABLE","$tableAlias",534],",",["T_WHITESPACE"," ",534],["T_VARIABLE","$storeId",534],")",",",["T_WHITESPACE","\n                    ",534],["T_ARRAY","array",535],"(",["T_VARIABLE","$fieldAlias",535],["T_WHITESPACE"," ",535],["T_DOUBLE_ARROW","=>",535],["T_WHITESPACE"," ",535],["T_VARIABLE","$tableAlias",535],".",["T_CONSTANT_ENCAPSED_STRING","'.value'",535],")",["T_WHITESPACE","\n                ",535],")",";",["T_WHITESPACE","\n            ",536],"}",["T_WHITESPACE","\n        ",537],"}",["T_WHITESPACE","\n\n        ",538],["T_RETURN","return",540],["T_WHITESPACE"," ",540],["T_VARIABLE","$read",540],["T_OBJECT_OPERATOR","->",540],["T_STRING","query",540],"(",["T_VARIABLE","$select",540],")",";",["T_WHITESPACE","\n    ",540],"}",["T_WHITESPACE","\n\n    ",541],["T_DOC_COMMENT","\/**\n     * Generate catalog price rules prices for specified date range\n     * If from date is not defined - will be used previous day by UTC\n     * If to date is not defined - will be used next day by UTC\n     *\n     * @param int|Mage_Catalog_Model_Product $product\n     *\n     * @throws Exception\n     * @return Mage_CatalogRule_Model_Resource_Rule\n     *\/",543],["T_WHITESPACE","\n    ",552],["T_PUBLIC","public",553],["T_WHITESPACE"," ",553],["T_FUNCTION","function",553],["T_WHITESPACE"," ",553],["T_STRING","applyAllRules",553],"(",["T_VARIABLE","$product",553],["T_WHITESPACE"," ",553],"=",["T_WHITESPACE"," ",553],["T_STRING","null",553],")",["T_WHITESPACE","\n    ",553],"{",["T_WHITESPACE","\n        ",554],["T_VARIABLE","$this",555],["T_OBJECT_OPERATOR","->",555],["T_STRING","_reindexCatalogRule",555],"(",["T_VARIABLE","$product",555],")",";",["T_WHITESPACE","\n        ",555],["T_RETURN","return",556],["T_WHITESPACE"," ",556],["T_VARIABLE","$this",556],";",["T_WHITESPACE","\n    ",556],"}",["T_WHITESPACE","\n\n    ",557],["T_DOC_COMMENT","\/**\n     * Generate catalog price rules prices for specified date range\n     * If from date is not defined - will be used previous day by UTC\n     * If to date is not defined - will be used next day by UTC\n     *\n     * @param int|string|null $fromDate\n     * @param int|string|null $toDate\n     * @param int $productId\n     *\n     * @deprecated after 1.7.0.2 use method applyAllRules\n     *\n     * @return Mage_CatalogRule_Model_Resource_Rule\n     *\/",559],["T_WHITESPACE","\n    ",571],["T_PUBLIC","public",572],["T_WHITESPACE"," ",572],["T_FUNCTION","function",572],["T_WHITESPACE"," ",572],["T_STRING","applyAllRulesForDateRange",572],"(",["T_VARIABLE","$fromDate",572],["T_WHITESPACE"," ",572],"=",["T_WHITESPACE"," ",572],["T_STRING","null",572],",",["T_WHITESPACE"," ",572],["T_VARIABLE","$toDate",572],["T_WHITESPACE"," ",572],"=",["T_WHITESPACE"," ",572],["T_STRING","null",572],",",["T_WHITESPACE"," ",572],["T_VARIABLE","$productId",572],["T_WHITESPACE"," ",572],"=",["T_WHITESPACE"," ",572],["T_STRING","null",572],")",["T_WHITESPACE","\n    ",572],"{",["T_WHITESPACE","\n        ",573],["T_RETURN","return",574],["T_WHITESPACE"," ",574],["T_VARIABLE","$this",574],["T_OBJECT_OPERATOR","->",574],["T_STRING","applyAllRules",574],"(",["T_VARIABLE","$productId",574],")",";",["T_WHITESPACE","\n    ",574],"}",["T_WHITESPACE","\n\n    ",575],["T_DOC_COMMENT","\/**\n     * Run reindex\n     *\n     * @param int|Mage_Catalog_Model_Product $product\n     *\/",577],["T_WHITESPACE","\n    ",581],["T_PROTECTED","protected",582],["T_WHITESPACE"," ",582],["T_FUNCTION","function",582],["T_WHITESPACE"," ",582],["T_STRING","_reindexCatalogRule",582],"(",["T_VARIABLE","$product",582],["T_WHITESPACE"," ",582],"=",["T_WHITESPACE"," ",582],["T_STRING","null",582],")",["T_WHITESPACE","\n    ",582],"{",["T_WHITESPACE","\n        ",583],["T_VARIABLE","$indexerCode",584],["T_WHITESPACE"," ",584],"=",["T_WHITESPACE"," ",584],["T_CONSTANT_ENCAPSED_STRING","'catalogrule\/action_index_refresh'",584],";",["T_WHITESPACE","\n        ",584],["T_VARIABLE","$value",585],["T_WHITESPACE"," ",585],"=",["T_WHITESPACE"," ",585],["T_STRING","null",585],";",["T_WHITESPACE","\n        ",585],["T_IF","if",586],["T_WHITESPACE"," ",586],"(",["T_VARIABLE","$product",586],")",["T_WHITESPACE"," ",586],"{",["T_WHITESPACE","\n            ",586],["T_VARIABLE","$value",587],["T_WHITESPACE"," ",587],"=",["T_WHITESPACE"," ",587],["T_VARIABLE","$product",587],["T_WHITESPACE"," ",587],["T_INSTANCEOF","instanceof",587],["T_WHITESPACE"," ",587],["T_STRING","Mage_Catalog_Model_Product",587],["T_WHITESPACE"," ",587],"?",["T_WHITESPACE"," ",587],["T_VARIABLE","$product",587],["T_OBJECT_OPERATOR","->",587],["T_STRING","getId",587],"(",")",["T_WHITESPACE"," ",587],":",["T_WHITESPACE"," ",587],["T_VARIABLE","$product",587],";",["T_WHITESPACE","\n            ",587],["T_VARIABLE","$indexerCode",588],["T_WHITESPACE"," ",588],"=",["T_WHITESPACE"," ",588],["T_CONSTANT_ENCAPSED_STRING","'catalogrule\/action_index_refresh_row'",588],";",["T_WHITESPACE","\n        ",588],"}",["T_WHITESPACE","\n\n        ",589],["T_DOC_COMMENT","\/** @var $indexer Mage_CatalogRule_Model_Action_Index_Refresh *\/",591],["T_WHITESPACE","\n        ",591],["T_VARIABLE","$indexer",592],["T_WHITESPACE"," ",592],"=",["T_WHITESPACE"," ",592],["T_STRING","Mage",592],["T_DOUBLE_COLON","::",592],["T_STRING","getModel",592],"(",["T_WHITESPACE","\n            ",592],["T_VARIABLE","$indexerCode",593],",",["T_WHITESPACE","\n            ",593],["T_ARRAY","array",594],"(",["T_WHITESPACE","\n                ",594],["T_CONSTANT_ENCAPSED_STRING","'connection'",595],["T_WHITESPACE"," ",595],["T_DOUBLE_ARROW","=>",595],["T_WHITESPACE"," ",595],["T_VARIABLE","$this",595],["T_OBJECT_OPERATOR","->",595],["T_STRING","_getWriteAdapter",595],"(",")",",",["T_WHITESPACE","\n                ",595],["T_CONSTANT_ENCAPSED_STRING","'factory'",596],["T_WHITESPACE","    ",596],["T_DOUBLE_ARROW","=>",596],["T_WHITESPACE"," ",596],["T_STRING","Mage",596],["T_DOUBLE_COLON","::",596],["T_STRING","getModel",596],"(",["T_CONSTANT_ENCAPSED_STRING","'core\/factory'",596],")",",",["T_WHITESPACE","\n                ",596],["T_CONSTANT_ENCAPSED_STRING","'resource'",597],["T_WHITESPACE","   ",597],["T_DOUBLE_ARROW","=>",597],["T_WHITESPACE"," ",597],["T_VARIABLE","$this",597],",",["T_WHITESPACE","\n                ",597],["T_CONSTANT_ENCAPSED_STRING","'app'",598],["T_WHITESPACE","        ",598],["T_DOUBLE_ARROW","=>",598],["T_WHITESPACE"," ",598],["T_STRING","Mage",598],["T_DOUBLE_COLON","::",598],["T_STRING","app",598],"(",")",",",["T_WHITESPACE","\n                ",598],["T_CONSTANT_ENCAPSED_STRING","'value'",599],["T_WHITESPACE","      ",599],["T_DOUBLE_ARROW","=>",599],["T_WHITESPACE"," ",599],["T_VARIABLE","$value",599],["T_WHITESPACE","\n            ",599],")",["T_WHITESPACE","\n        ",600],")",";",["T_WHITESPACE","\n        ",601],["T_VARIABLE","$indexer",602],["T_OBJECT_OPERATOR","->",602],["T_STRING","execute",602],"(",")",";",["T_WHITESPACE","\n    ",602],"}",["T_WHITESPACE","\n\n    ",603],["T_DOC_COMMENT","\/**\n     * Calculate product price based on price rule data and previous information\n     *\n     * @param array $ruleData\n     * @param null|array $productData\n     *\n     * @return float\n     *\/",605],["T_WHITESPACE","\n    ",612],["T_PROTECTED","protected",613],["T_WHITESPACE"," ",613],["T_FUNCTION","function",613],["T_WHITESPACE"," ",613],["T_STRING","_calcRuleProductPrice",613],"(",["T_VARIABLE","$ruleData",613],",",["T_WHITESPACE"," ",613],["T_VARIABLE","$productData",613],["T_WHITESPACE"," ",613],"=",["T_WHITESPACE"," ",613],["T_STRING","null",613],")",["T_WHITESPACE","\n    ",613],"{",["T_WHITESPACE","\n        ",614],["T_IF","if",615],["T_WHITESPACE"," ",615],"(",["T_VARIABLE","$productData",615],["T_WHITESPACE"," ",615],["T_IS_NOT_IDENTICAL","!==",615],["T_WHITESPACE"," ",615],["T_STRING","null",615],["T_WHITESPACE"," ",615],["T_BOOLEAN_AND","&&",615],["T_WHITESPACE"," ",615],["T_ISSET","isset",615],"(",["T_VARIABLE","$productData",615],"[",["T_CONSTANT_ENCAPSED_STRING","'rule_price'",615],"]",")",")",["T_WHITESPACE"," ",615],"{",["T_WHITESPACE","\n            ",615],["T_VARIABLE","$productPrice",616],["T_WHITESPACE"," ",616],"=",["T_WHITESPACE"," ",616],["T_VARIABLE","$productData",616],"[",["T_CONSTANT_ENCAPSED_STRING","'rule_price'",616],"]",";",["T_WHITESPACE","\n        ",616],"}",["T_WHITESPACE"," ",617],["T_ELSE","else",617],["T_WHITESPACE"," ",617],"{",["T_WHITESPACE","\n            ",617],["T_VARIABLE","$websiteId",618],["T_WHITESPACE"," ",618],"=",["T_WHITESPACE"," ",618],["T_VARIABLE","$ruleData",618],"[",["T_CONSTANT_ENCAPSED_STRING","'website_id'",618],"]",";",["T_WHITESPACE","\n            ",618],["T_IF","if",619],["T_WHITESPACE"," ",619],"(",["T_ISSET","isset",619],"(",["T_VARIABLE","$ruleData",619],"[",["T_CONSTANT_ENCAPSED_STRING","'website_'",619],".",["T_VARIABLE","$websiteId",619],".",["T_CONSTANT_ENCAPSED_STRING","'_price'",619],"]",")",")",["T_WHITESPACE"," ",619],"{",["T_WHITESPACE","\n                ",619],["T_VARIABLE","$productPrice",620],["T_WHITESPACE"," ",620],"=",["T_WHITESPACE"," ",620],["T_VARIABLE","$ruleData",620],"[",["T_CONSTANT_ENCAPSED_STRING","'website_'",620],".",["T_VARIABLE","$websiteId",620],".",["T_CONSTANT_ENCAPSED_STRING","'_price'",620],"]",";",["T_WHITESPACE","\n            ",620],"}",["T_WHITESPACE"," ",621],["T_ELSE","else",621],["T_WHITESPACE"," ",621],"{",["T_WHITESPACE","\n                ",621],["T_VARIABLE","$productPrice",622],["T_WHITESPACE"," ",622],"=",["T_WHITESPACE"," ",622],["T_VARIABLE","$ruleData",622],"[",["T_CONSTANT_ENCAPSED_STRING","'default_price'",622],"]",";",["T_WHITESPACE","\n            ",622],"}",["T_WHITESPACE","\n        ",623],"}",["T_WHITESPACE","\n\n        ",624],["T_VARIABLE","$productPrice",626],["T_WHITESPACE"," ",626],"=",["T_WHITESPACE"," ",626],["T_STRING","Mage",626],["T_DOUBLE_COLON","::",626],["T_STRING","helper",626],"(",["T_CONSTANT_ENCAPSED_STRING","'catalogrule'",626],")",["T_OBJECT_OPERATOR","->",626],["T_STRING","calcPriceRule",626],"(",["T_WHITESPACE","\n            ",626],["T_VARIABLE","$ruleData",627],"[",["T_CONSTANT_ENCAPSED_STRING","'action_operator'",627],"]",",",["T_WHITESPACE","\n            ",627],["T_VARIABLE","$ruleData",628],"[",["T_CONSTANT_ENCAPSED_STRING","'action_amount'",628],"]",",",["T_WHITESPACE","\n            ",628],["T_VARIABLE","$productPrice",629],")",";",["T_WHITESPACE","\n\n        ",629],["T_RETURN","return",631],["T_WHITESPACE"," ",631],["T_STRING","Mage",631],["T_DOUBLE_COLON","::",631],["T_STRING","app",631],"(",")",["T_OBJECT_OPERATOR","->",631],["T_STRING","getStore",631],"(",")",["T_OBJECT_OPERATOR","->",631],["T_STRING","roundPrice",631],"(",["T_VARIABLE","$productPrice",631],")",";",["T_WHITESPACE","\n    ",631],"}",["T_WHITESPACE","\n\n    ",632],["T_DOC_COMMENT","\/**\n     * Save rule prices for products to DB\n     *\n     * @param array $arrData\n     *\n     * @return Mage_CatalogRule_Model_Resource_Rule\n     *\/",634],["T_WHITESPACE","\n    ",640],["T_PROTECTED","protected",641],["T_WHITESPACE"," ",641],["T_FUNCTION","function",641],["T_WHITESPACE"," ",641],["T_STRING","_saveRuleProductPrices",641],"(",["T_VARIABLE","$arrData",641],")",["T_WHITESPACE","\n    ",641],"{",["T_WHITESPACE","\n        ",642],["T_IF","if",643],["T_WHITESPACE"," ",643],"(",["T_EMPTY","empty",643],"(",["T_VARIABLE","$arrData",643],")",")",["T_WHITESPACE"," ",643],"{",["T_WHITESPACE","\n            ",643],["T_RETURN","return",644],["T_WHITESPACE"," ",644],["T_VARIABLE","$this",644],";",["T_WHITESPACE","\n        ",644],"}",["T_WHITESPACE","\n\n        ",645],["T_VARIABLE","$adapter",647],["T_WHITESPACE","    ",647],"=",["T_WHITESPACE"," ",647],["T_VARIABLE","$this",647],["T_OBJECT_OPERATOR","->",647],["T_STRING","_getWriteAdapter",647],"(",")",";",["T_WHITESPACE","\n        ",647],["T_VARIABLE","$productIds",648],["T_WHITESPACE"," ",648],"=",["T_WHITESPACE"," ",648],["T_ARRAY","array",648],"(",")",";",["T_WHITESPACE","\n\n        ",648],["T_VARIABLE","$adapter",650],["T_OBJECT_OPERATOR","->",650],["T_STRING","beginTransaction",650],"(",")",";",["T_WHITESPACE","\n        ",650],["T_TRY","try",651],["T_WHITESPACE"," ",651],"{",["T_WHITESPACE","\n            ",651],["T_FOREACH","foreach",652],["T_WHITESPACE"," ",652],"(",["T_VARIABLE","$arrData",652],["T_WHITESPACE"," ",652],["T_AS","as",652],["T_WHITESPACE"," ",652],["T_VARIABLE","$key",652],["T_WHITESPACE"," ",652],["T_DOUBLE_ARROW","=>",652],["T_WHITESPACE"," ",652],["T_VARIABLE","$data",652],")",["T_WHITESPACE"," ",652],"{",["T_WHITESPACE","\n                ",652],["T_VARIABLE","$productIds",653],"[",["T_CONSTANT_ENCAPSED_STRING","'product_id'",653],"]",["T_WHITESPACE"," ",653],"=",["T_WHITESPACE"," ",653],["T_VARIABLE","$data",653],"[",["T_CONSTANT_ENCAPSED_STRING","'product_id'",653],"]",";",["T_WHITESPACE","\n                ",653],["T_VARIABLE","$arrData",654],"[",["T_VARIABLE","$key",654],"]","[",["T_CONSTANT_ENCAPSED_STRING","'rule_date'",654],"]",["T_WHITESPACE"," ",654],"=",["T_WHITESPACE"," ",654],["T_VARIABLE","$this",654],["T_OBJECT_OPERATOR","->",654],["T_STRING","formatDate",654],"(",["T_VARIABLE","$data",654],"[",["T_CONSTANT_ENCAPSED_STRING","'rule_date'",654],"]",",",["T_WHITESPACE"," ",654],["T_STRING","false",654],")",";",["T_WHITESPACE","\n                ",654],["T_VARIABLE","$arrData",655],"[",["T_VARIABLE","$key",655],"]","[",["T_CONSTANT_ENCAPSED_STRING","'latest_start_date'",655],"]",["T_WHITESPACE"," ",655],"=",["T_WHITESPACE"," ",655],["T_VARIABLE","$this",655],["T_OBJECT_OPERATOR","->",655],["T_STRING","formatDate",655],"(",["T_VARIABLE","$data",655],"[",["T_CONSTANT_ENCAPSED_STRING","'latest_start_date'",655],"]",",",["T_WHITESPACE"," ",655],["T_STRING","false",655],")",";",["T_WHITESPACE","\n                ",655],["T_VARIABLE","$arrData",656],"[",["T_VARIABLE","$key",656],"]","[",["T_CONSTANT_ENCAPSED_STRING","'earliest_end_date'",656],"]",["T_WHITESPACE"," ",656],"=",["T_WHITESPACE"," ",656],["T_VARIABLE","$this",656],["T_OBJECT_OPERATOR","->",656],["T_STRING","formatDate",656],"(",["T_VARIABLE","$data",656],"[",["T_CONSTANT_ENCAPSED_STRING","'earliest_end_date'",656],"]",",",["T_WHITESPACE"," ",656],["T_STRING","false",656],")",";",["T_WHITESPACE","\n            ",656],"}",["T_WHITESPACE","\n            ",657],["T_VARIABLE","$adapter",658],["T_OBJECT_OPERATOR","->",658],["T_STRING","insertOnDuplicate",658],"(",["T_VARIABLE","$this",658],["T_OBJECT_OPERATOR","->",658],["T_STRING","getTable",658],"(",["T_CONSTANT_ENCAPSED_STRING","'catalogrule\/affected_product'",658],")",",",["T_WHITESPACE"," ",658],["T_STRING","array_unique",658],"(",["T_VARIABLE","$productIds",658],")",")",";",["T_WHITESPACE","\n            ",658],["T_VARIABLE","$adapter",659],["T_OBJECT_OPERATOR","->",659],["T_STRING","insertOnDuplicate",659],"(",["T_VARIABLE","$this",659],["T_OBJECT_OPERATOR","->",659],["T_STRING","getTable",659],"(",["T_CONSTANT_ENCAPSED_STRING","'catalogrule\/rule_product_price'",659],")",",",["T_WHITESPACE"," ",659],["T_VARIABLE","$arrData",659],")",";",["T_WHITESPACE","\n\n        ",659],"}",["T_WHITESPACE"," ",661],["T_CATCH","catch",661],["T_WHITESPACE"," ",661],"(",["T_STRING","Exception",661],["T_WHITESPACE"," ",661],["T_VARIABLE","$e",661],")",["T_WHITESPACE"," ",661],"{",["T_WHITESPACE","\n            ",661],["T_VARIABLE","$adapter",662],["T_OBJECT_OPERATOR","->",662],["T_STRING","rollback",662],"(",")",";",["T_WHITESPACE","\n            ",662],["T_THROW","throw",663],["T_WHITESPACE"," ",663],["T_VARIABLE","$e",663],";",["T_WHITESPACE","\n\n        ",663],"}",["T_WHITESPACE","\n        ",665],["T_VARIABLE","$adapter",666],["T_OBJECT_OPERATOR","->",666],["T_STRING","commit",666],"(",")",";",["T_WHITESPACE","\n\n        ",666],["T_RETURN","return",668],["T_WHITESPACE"," ",668],["T_VARIABLE","$this",668],";",["T_WHITESPACE","\n    ",668],"}",["T_WHITESPACE","\n\n    ",669],["T_DOC_COMMENT","\/**\n     * Get catalog rules product price for specific date, website and\n     * customer group\n     *\n     * @param int|string $date\n     * @param int $wId\n     * @param int $gId\n     * @param int $pId\n     *\n     * @return float|bool\n     *\/",671],["T_WHITESPACE","\n    ",681],["T_PUBLIC","public",682],["T_WHITESPACE"," ",682],["T_FUNCTION","function",682],["T_WHITESPACE"," ",682],["T_STRING","getRulePrice",682],"(",["T_VARIABLE","$date",682],",",["T_WHITESPACE"," ",682],["T_VARIABLE","$wId",682],",",["T_WHITESPACE"," ",682],["T_VARIABLE","$gId",682],",",["T_WHITESPACE"," ",682],["T_VARIABLE","$pId",682],")",["T_WHITESPACE","\n    ",682],"{",["T_WHITESPACE","\n        ",683],["T_VARIABLE","$data",684],["T_WHITESPACE"," ",684],"=",["T_WHITESPACE"," ",684],["T_VARIABLE","$this",684],["T_OBJECT_OPERATOR","->",684],["T_STRING","getRulePrices",684],"(",["T_VARIABLE","$date",684],",",["T_WHITESPACE"," ",684],["T_VARIABLE","$wId",684],",",["T_WHITESPACE"," ",684],["T_VARIABLE","$gId",684],",",["T_WHITESPACE"," ",684],["T_ARRAY","array",684],"(",["T_VARIABLE","$pId",684],")",")",";",["T_WHITESPACE","\n        ",684],["T_IF","if",685],["T_WHITESPACE"," ",685],"(",["T_ISSET","isset",685],"(",["T_VARIABLE","$data",685],"[",["T_VARIABLE","$pId",685],"]",")",")",["T_WHITESPACE"," ",685],"{",["T_WHITESPACE","\n            ",685],["T_RETURN","return",686],["T_WHITESPACE"," ",686],["T_VARIABLE","$data",686],"[",["T_VARIABLE","$pId",686],"]",";",["T_WHITESPACE","\n        ",686],"}",["T_WHITESPACE","\n\n        ",687],["T_RETURN","return",689],["T_WHITESPACE"," ",689],["T_STRING","false",689],";",["T_WHITESPACE","\n    ",689],"}",["T_WHITESPACE","\n\n    ",690],["T_DOC_COMMENT","\/**\n     * Retrieve product prices by catalog rule for specific date, website and customer group\n     * Collect data with  product Id => price pairs\n     *\n     * @param int|string $date\n     * @param int $websiteId\n     * @param int $customerGroupId\n     * @param array $productIds\n     *\n     * @return array\n     *\/",692],["T_WHITESPACE","\n    ",702],["T_PUBLIC","public",703],["T_WHITESPACE"," ",703],["T_FUNCTION","function",703],["T_WHITESPACE"," ",703],["T_STRING","getRulePrices",703],"(",["T_VARIABLE","$date",703],",",["T_WHITESPACE"," ",703],["T_VARIABLE","$websiteId",703],",",["T_WHITESPACE"," ",703],["T_VARIABLE","$customerGroupId",703],",",["T_WHITESPACE"," ",703],["T_VARIABLE","$productIds",703],")",["T_WHITESPACE","\n    ",703],"{",["T_WHITESPACE","\n        ",704],["T_VARIABLE","$adapter",705],["T_WHITESPACE"," ",705],"=",["T_WHITESPACE"," ",705],["T_VARIABLE","$this",705],["T_OBJECT_OPERATOR","->",705],["T_STRING","_getReadAdapter",705],"(",")",";",["T_WHITESPACE","\n        ",705],["T_VARIABLE","$select",706],["T_WHITESPACE","  ",706],"=",["T_WHITESPACE"," ",706],["T_VARIABLE","$adapter",706],["T_OBJECT_OPERATOR","->",706],["T_STRING","select",706],"(",")",["T_WHITESPACE","\n            ",706],["T_OBJECT_OPERATOR","->",707],["T_STRING","from",707],"(",["T_VARIABLE","$this",707],["T_OBJECT_OPERATOR","->",707],["T_STRING","getTable",707],"(",["T_CONSTANT_ENCAPSED_STRING","'catalogrule\/rule_product_price'",707],")",",",["T_WHITESPACE"," ",707],["T_ARRAY","array",707],"(",["T_CONSTANT_ENCAPSED_STRING","'product_id'",707],",",["T_WHITESPACE"," ",707],["T_CONSTANT_ENCAPSED_STRING","'rule_price'",707],")",")",["T_WHITESPACE","\n            ",707],["T_OBJECT_OPERATOR","->",708],["T_STRING","where",708],"(",["T_CONSTANT_ENCAPSED_STRING","'rule_date = ?'",708],",",["T_WHITESPACE"," ",708],["T_VARIABLE","$this",708],["T_OBJECT_OPERATOR","->",708],["T_STRING","formatDate",708],"(",["T_VARIABLE","$date",708],",",["T_WHITESPACE"," ",708],["T_STRING","false",708],")",")",["T_WHITESPACE","\n            ",708],["T_OBJECT_OPERATOR","->",709],["T_STRING","where",709],"(",["T_CONSTANT_ENCAPSED_STRING","'website_id = ?'",709],",",["T_WHITESPACE"," ",709],["T_VARIABLE","$websiteId",709],")",["T_WHITESPACE","\n            ",709],["T_OBJECT_OPERATOR","->",710],["T_STRING","where",710],"(",["T_CONSTANT_ENCAPSED_STRING","'customer_group_id = ?'",710],",",["T_WHITESPACE"," ",710],["T_VARIABLE","$customerGroupId",710],")",["T_WHITESPACE","\n            ",710],["T_OBJECT_OPERATOR","->",711],["T_STRING","where",711],"(",["T_CONSTANT_ENCAPSED_STRING","'product_id IN(?)'",711],",",["T_WHITESPACE"," ",711],["T_VARIABLE","$productIds",711],")",";",["T_WHITESPACE","\n        ",711],["T_RETURN","return",712],["T_WHITESPACE"," ",712],["T_VARIABLE","$adapter",712],["T_OBJECT_OPERATOR","->",712],["T_STRING","fetchPairs",712],"(",["T_VARIABLE","$select",712],")",";",["T_WHITESPACE","\n    ",712],"}",["T_WHITESPACE","\n\n    ",713],["T_DOC_COMMENT","\/**\n     * Get active rule data based on few filters\n     *\n     * @param int|string $date\n     * @param int $websiteId\n     * @param int $customerGroupId\n     * @param int $productId\n     * @return array\n     *\/",715],["T_WHITESPACE","\n    ",723],["T_PUBLIC","public",724],["T_WHITESPACE"," ",724],["T_FUNCTION","function",724],["T_WHITESPACE"," ",724],["T_STRING","getRulesFromProduct",724],"(",["T_VARIABLE","$date",724],",",["T_WHITESPACE"," ",724],["T_VARIABLE","$websiteId",724],",",["T_WHITESPACE"," ",724],["T_VARIABLE","$customerGroupId",724],",",["T_WHITESPACE"," ",724],["T_VARIABLE","$productId",724],")",["T_WHITESPACE","\n    ",724],"{",["T_WHITESPACE","\n        ",725],["T_VARIABLE","$adapter",726],["T_WHITESPACE"," ",726],"=",["T_WHITESPACE"," ",726],["T_VARIABLE","$this",726],["T_OBJECT_OPERATOR","->",726],["T_STRING","_getReadAdapter",726],"(",")",";",["T_WHITESPACE","\n        ",726],["T_IF","if",727],["T_WHITESPACE"," ",727],"(",["T_STRING","is_string",727],"(",["T_VARIABLE","$date",727],")",")",["T_WHITESPACE"," ",727],"{",["T_WHITESPACE","\n            ",727],["T_VARIABLE","$date",728],["T_WHITESPACE"," ",728],"=",["T_WHITESPACE"," ",728],["T_STRING","strtotime",728],"(",["T_VARIABLE","$date",728],")",";",["T_WHITESPACE","\n        ",728],"}",["T_WHITESPACE","\n        ",729],["T_VARIABLE","$select",730],["T_WHITESPACE"," ",730],"=",["T_WHITESPACE"," ",730],["T_VARIABLE","$adapter",730],["T_OBJECT_OPERATOR","->",730],["T_STRING","select",730],"(",")",["T_WHITESPACE","\n            ",730],["T_OBJECT_OPERATOR","->",731],["T_STRING","from",731],"(",["T_VARIABLE","$this",731],["T_OBJECT_OPERATOR","->",731],["T_STRING","getTable",731],"(",["T_CONSTANT_ENCAPSED_STRING","'catalogrule\/rule_product'",731],")",")",["T_WHITESPACE","\n            ",731],["T_OBJECT_OPERATOR","->",732],["T_STRING","where",732],"(",["T_CONSTANT_ENCAPSED_STRING","'website_id = ?'",732],",",["T_WHITESPACE"," ",732],["T_VARIABLE","$websiteId",732],")",["T_WHITESPACE","\n            ",732],["T_OBJECT_OPERATOR","->",733],["T_STRING","where",733],"(",["T_CONSTANT_ENCAPSED_STRING","'customer_group_id = ?'",733],",",["T_WHITESPACE"," ",733],["T_VARIABLE","$customerGroupId",733],")",["T_WHITESPACE","\n            ",733],["T_OBJECT_OPERATOR","->",734],["T_STRING","where",734],"(",["T_CONSTANT_ENCAPSED_STRING","'product_id = ?'",734],",",["T_WHITESPACE"," ",734],["T_VARIABLE","$productId",734],")",["T_WHITESPACE","\n            ",734],["T_OBJECT_OPERATOR","->",735],["T_STRING","where",735],"(",["T_CONSTANT_ENCAPSED_STRING","'from_time = 0 or from_time < ?'",735],",",["T_WHITESPACE"," ",735],["T_VARIABLE","$date",735],")",["T_WHITESPACE","\n            ",735],["T_OBJECT_OPERATOR","->",736],["T_STRING","where",736],"(",["T_CONSTANT_ENCAPSED_STRING","'to_time = 0 or to_time > ?'",736],",",["T_WHITESPACE"," ",736],["T_VARIABLE","$date",736],")",["T_WHITESPACE","\n            ",736],["T_OBJECT_OPERATOR","->",737],["T_STRING","order",737],"(",["T_CONSTANT_ENCAPSED_STRING","'sort_order'",737],")",";",["T_WHITESPACE","\n\n        ",737],["T_RETURN","return",739],["T_WHITESPACE"," ",739],["T_VARIABLE","$adapter",739],["T_OBJECT_OPERATOR","->",739],["T_STRING","fetchAll",739],"(",["T_VARIABLE","$select",739],")",";",["T_WHITESPACE","\n    ",739],"}",["T_WHITESPACE","\n\n    ",740],["T_DOC_COMMENT","\/**\n     * Retrieve product price data for all customer groups\n     *\n     * @param int|string $date\n     * @param int $wId\n     * @param int $pId\n     *\n     * @return array\n     *\/",742],["T_WHITESPACE","\n    ",750],["T_PUBLIC","public",751],["T_WHITESPACE"," ",751],["T_FUNCTION","function",751],["T_WHITESPACE"," ",751],["T_STRING","getRulesForProduct",751],"(",["T_VARIABLE","$date",751],",",["T_WHITESPACE"," ",751],["T_VARIABLE","$wId",751],",",["T_WHITESPACE"," ",751],["T_VARIABLE","$pId",751],")",["T_WHITESPACE","\n    ",751],"{",["T_WHITESPACE","\n        ",752],["T_VARIABLE","$read",753],["T_WHITESPACE"," ",753],"=",["T_WHITESPACE"," ",753],["T_VARIABLE","$this",753],["T_OBJECT_OPERATOR","->",753],["T_STRING","_getReadAdapter",753],"(",")",";",["T_WHITESPACE","\n        ",753],["T_VARIABLE","$select",754],["T_WHITESPACE"," ",754],"=",["T_WHITESPACE"," ",754],["T_VARIABLE","$read",754],["T_OBJECT_OPERATOR","->",754],["T_STRING","select",754],"(",")",["T_WHITESPACE","\n            ",754],["T_OBJECT_OPERATOR","->",755],["T_STRING","from",755],"(",["T_VARIABLE","$this",755],["T_OBJECT_OPERATOR","->",755],["T_STRING","getTable",755],"(",["T_CONSTANT_ENCAPSED_STRING","'catalogrule\/rule_product_price'",755],")",",",["T_WHITESPACE"," ",755],["T_CONSTANT_ENCAPSED_STRING","'*'",755],")",["T_WHITESPACE","\n            ",755],["T_OBJECT_OPERATOR","->",756],["T_STRING","where",756],"(",["T_CONSTANT_ENCAPSED_STRING","'rule_date=?'",756],",",["T_WHITESPACE"," ",756],["T_VARIABLE","$this",756],["T_OBJECT_OPERATOR","->",756],["T_STRING","formatDate",756],"(",["T_VARIABLE","$date",756],",",["T_WHITESPACE"," ",756],["T_STRING","false",756],")",")",["T_WHITESPACE","\n            ",756],["T_OBJECT_OPERATOR","->",757],["T_STRING","where",757],"(",["T_CONSTANT_ENCAPSED_STRING","'website_id=?'",757],",",["T_WHITESPACE"," ",757],["T_VARIABLE","$wId",757],")",["T_WHITESPACE","\n            ",757],["T_OBJECT_OPERATOR","->",758],["T_STRING","where",758],"(",["T_CONSTANT_ENCAPSED_STRING","'product_id=?'",758],",",["T_WHITESPACE"," ",758],["T_VARIABLE","$pId",758],")",";",["T_WHITESPACE","\n\n        ",758],["T_RETURN","return",760],["T_WHITESPACE"," ",760],["T_VARIABLE","$read",760],["T_OBJECT_OPERATOR","->",760],["T_STRING","fetchAll",760],"(",["T_VARIABLE","$select",760],")",";",["T_WHITESPACE","\n    ",760],"}",["T_WHITESPACE","\n\n    ",761],["T_DOC_COMMENT","\/**\n     * Apply catalog rule to product\n     *\n     * @param Mage_CatalogRule_Model_Rule $rule\n     * @param Mage_Catalog_Model_Product $product\n     * @param array $websiteIds\n     *\n     * @throws Exception\n     * @return Mage_CatalogRule_Model_Resource_Rule\n     *\/",763],["T_WHITESPACE","\n    ",772],["T_PUBLIC","public",773],["T_WHITESPACE"," ",773],["T_FUNCTION","function",773],["T_WHITESPACE"," ",773],["T_STRING","applyToProduct",773],"(",["T_VARIABLE","$rule",773],",",["T_WHITESPACE"," ",773],["T_VARIABLE","$product",773],",",["T_WHITESPACE"," ",773],["T_VARIABLE","$websiteIds",773],")",["T_WHITESPACE","\n    ",773],"{",["T_WHITESPACE","\n        ",774],["T_IF","if",775],["T_WHITESPACE"," ",775],"(","!",["T_VARIABLE","$rule",775],["T_OBJECT_OPERATOR","->",775],["T_STRING","getIsActive",775],"(",")",")",["T_WHITESPACE"," ",775],"{",["T_WHITESPACE","\n            ",775],["T_RETURN","return",776],["T_WHITESPACE"," ",776],["T_VARIABLE","$this",776],";",["T_WHITESPACE","\n        ",776],"}",["T_WHITESPACE","\n\n        ",777],["T_VARIABLE","$ruleId",779],["T_WHITESPACE","    ",779],"=",["T_WHITESPACE"," ",779],["T_VARIABLE","$rule",779],["T_OBJECT_OPERATOR","->",779],["T_STRING","getId",779],"(",")",";",["T_WHITESPACE","\n        ",779],["T_VARIABLE","$productId",780],["T_WHITESPACE"," ",780],"=",["T_WHITESPACE"," ",780],["T_VARIABLE","$product",780],["T_OBJECT_OPERATOR","->",780],["T_STRING","getId",780],"(",")",";",["T_WHITESPACE","\n\n        ",780],["T_VARIABLE","$write",782],["T_WHITESPACE"," ",782],"=",["T_WHITESPACE"," ",782],["T_VARIABLE","$this",782],["T_OBJECT_OPERATOR","->",782],["T_STRING","_getWriteAdapter",782],"(",")",";",["T_WHITESPACE","\n        ",782],["T_VARIABLE","$write",783],["T_OBJECT_OPERATOR","->",783],["T_STRING","beginTransaction",783],"(",")",";",["T_WHITESPACE","\n\n        ",783],["T_IF","if",785],["T_WHITESPACE"," ",785],"(",["T_VARIABLE","$this",785],["T_OBJECT_OPERATOR","->",785],["T_STRING","_isProductMatchedRule",785],"(",["T_VARIABLE","$ruleId",785],",",["T_WHITESPACE"," ",785],["T_VARIABLE","$product",785],")",")",["T_WHITESPACE"," ",785],"{",["T_WHITESPACE","\n            ",785],["T_VARIABLE","$this",786],["T_OBJECT_OPERATOR","->",786],["T_STRING","cleanProductData",786],"(",["T_VARIABLE","$ruleId",786],",",["T_WHITESPACE"," ",786],["T_ARRAY","array",786],"(",["T_VARIABLE","$productId",786],")",")",";",["T_WHITESPACE","\n        ",786],"}",["T_WHITESPACE","\n        ",787],["T_IF","if",788],["T_WHITESPACE"," ",788],"(",["T_VARIABLE","$this",788],["T_OBJECT_OPERATOR","->",788],["T_STRING","validateProduct",788],"(",["T_VARIABLE","$rule",788],",",["T_WHITESPACE"," ",788],["T_VARIABLE","$product",788],",",["T_WHITESPACE"," ",788],["T_VARIABLE","$websiteIds",788],")",")",["T_WHITESPACE"," ",788],"{",["T_WHITESPACE","\n            ",788],["T_TRY","try",789],["T_WHITESPACE"," ",789],"{",["T_WHITESPACE","\n                ",789],["T_VARIABLE","$this",790],["T_OBJECT_OPERATOR","->",790],["T_STRING","insertRuleData",790],"(",["T_VARIABLE","$rule",790],",",["T_WHITESPACE"," ",790],["T_VARIABLE","$websiteIds",790],",",["T_WHITESPACE"," ",790],["T_ARRAY","array",790],"(",["T_WHITESPACE","\n                    ",790],["T_VARIABLE","$productId",791],["T_WHITESPACE"," ",791],["T_DOUBLE_ARROW","=>",791],["T_WHITESPACE"," ",791],["T_STRING","array_combine",791],"(",["T_STRING","array_values",791],"(",["T_VARIABLE","$websiteIds",791],")",",",["T_WHITESPACE"," ",791],["T_STRING","array_values",791],"(",["T_VARIABLE","$websiteIds",791],")",")",")",["T_WHITESPACE","\n                ",791],")",";",["T_WHITESPACE","\n            ",792],"}",["T_WHITESPACE"," ",793],["T_CATCH","catch",793],["T_WHITESPACE"," ",793],"(",["T_STRING","Exception",793],["T_WHITESPACE"," ",793],["T_VARIABLE","$e",793],")",["T_WHITESPACE"," ",793],"{",["T_WHITESPACE","\n                ",793],["T_VARIABLE","$write",794],["T_OBJECT_OPERATOR","->",794],["T_STRING","rollback",794],"(",")",";",["T_WHITESPACE","\n                ",794],["T_THROW","throw",795],["T_WHITESPACE"," ",795],["T_VARIABLE","$e",795],";",["T_WHITESPACE","\n            ",795],"}",["T_WHITESPACE","\n        ",796],"}",["T_WHITESPACE"," ",797],["T_ELSE","else",797],["T_WHITESPACE"," ",797],"{",["T_WHITESPACE","\n            ",797],["T_VARIABLE","$write",798],["T_OBJECT_OPERATOR","->",798],["T_STRING","delete",798],"(",["T_VARIABLE","$this",798],["T_OBJECT_OPERATOR","->",798],["T_STRING","getTable",798],"(",["T_CONSTANT_ENCAPSED_STRING","'catalogrule\/rule_product_price'",798],")",",",["T_WHITESPACE"," ",798],["T_ARRAY","array",798],"(",["T_WHITESPACE","\n                ",798],["T_VARIABLE","$write",799],["T_OBJECT_OPERATOR","->",799],["T_STRING","quoteInto",799],"(",["T_CONSTANT_ENCAPSED_STRING","'product_id = ?'",799],",",["T_WHITESPACE"," ",799],["T_VARIABLE","$productId",799],")",",",["T_WHITESPACE","\n            ",799],")",")",";",["T_WHITESPACE","\n        ",800],"}",["T_WHITESPACE","\n\n        ",801],["T_VARIABLE","$write",803],["T_OBJECT_OPERATOR","->",803],["T_STRING","commit",803],"(",")",";",["T_WHITESPACE","\n        ",803],["T_RETURN","return",804],["T_WHITESPACE"," ",804],["T_VARIABLE","$this",804],";",["T_WHITESPACE","\n    ",804],"}",["T_WHITESPACE","\n\n    ",805],["T_DOC_COMMENT","\/**\n     * Get ids of matched rules for specific product\n     *\n     * @param int $productId\n     * @return array\n     *\/",807],["T_WHITESPACE","\n    ",812],["T_PUBLIC","public",813],["T_WHITESPACE"," ",813],["T_FUNCTION","function",813],["T_WHITESPACE"," ",813],["T_STRING","getProductRuleIds",813],"(",["T_VARIABLE","$productId",813],")",["T_WHITESPACE","\n    ",813],"{",["T_WHITESPACE","\n        ",814],["T_VARIABLE","$read",815],["T_WHITESPACE"," ",815],"=",["T_WHITESPACE"," ",815],["T_VARIABLE","$this",815],["T_OBJECT_OPERATOR","->",815],["T_STRING","_getReadAdapter",815],"(",")",";",["T_WHITESPACE","\n        ",815],["T_VARIABLE","$select",816],["T_WHITESPACE"," ",816],"=",["T_WHITESPACE"," ",816],["T_VARIABLE","$read",816],["T_OBJECT_OPERATOR","->",816],["T_STRING","select",816],"(",")",["T_OBJECT_OPERATOR","->",816],["T_STRING","from",816],"(",["T_VARIABLE","$this",816],["T_OBJECT_OPERATOR","->",816],["T_STRING","getTable",816],"(",["T_CONSTANT_ENCAPSED_STRING","'catalogrule\/rule_product'",816],")",",",["T_WHITESPACE"," ",816],["T_CONSTANT_ENCAPSED_STRING","'rule_id'",816],")",";",["T_WHITESPACE","\n        ",816],["T_VARIABLE","$select",817],["T_OBJECT_OPERATOR","->",817],["T_STRING","where",817],"(",["T_CONSTANT_ENCAPSED_STRING","'product_id = ?'",817],",",["T_WHITESPACE"," ",817],["T_VARIABLE","$productId",817],")",";",["T_WHITESPACE","\n        ",817],["T_RETURN","return",818],["T_WHITESPACE"," ",818],["T_STRING","array_flip",818],"(",["T_VARIABLE","$read",818],["T_OBJECT_OPERATOR","->",818],["T_STRING","fetchCol",818],"(",["T_VARIABLE","$select",818],")",")",";",["T_WHITESPACE","\n    ",818],"}",["T_WHITESPACE","\n\n    ",819],["T_DOC_COMMENT","\/**\n     * Is product has been matched the rule\n     *\n     * @param int $ruleId\n     * @param Mage_Catalog_Model_Product $product\n     * @return bool\n     *\/",821],["T_WHITESPACE","\n    ",827],["T_PROTECTED","protected",828],["T_WHITESPACE"," ",828],["T_FUNCTION","function",828],["T_WHITESPACE"," ",828],["T_STRING","_isProductMatchedRule",828],"(",["T_VARIABLE","$ruleId",828],",",["T_WHITESPACE"," ",828],["T_VARIABLE","$product",828],")",["T_WHITESPACE","\n    ",828],"{",["T_WHITESPACE","\n        ",829],["T_VARIABLE","$rules",830],["T_WHITESPACE"," ",830],"=",["T_WHITESPACE"," ",830],["T_VARIABLE","$product",830],["T_OBJECT_OPERATOR","->",830],["T_STRING","getMatchedRules",830],"(",")",";",["T_WHITESPACE","\n        ",830],["T_RETURN","return",831],["T_WHITESPACE"," ",831],["T_ISSET","isset",831],"(",["T_VARIABLE","$rules",831],"[",["T_VARIABLE","$ruleId",831],"]",")",";",["T_WHITESPACE","\n    ",831],"}",["T_WHITESPACE","\n",832],"}",["T_WHITESPACE","\n",833]]