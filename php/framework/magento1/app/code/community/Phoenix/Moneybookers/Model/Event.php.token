[["T_OPEN_TAG","<?php\n",1],["T_DOC_COMMENT","\/**\n * Magento\n *\n * NOTICE OF LICENSE\n *\n * This source file is subject to the Open Software License (OSL 3.0)\n * that is bundled with this package in the file LICENSE.txt.\n * It is also available through the world-wide-web at this URL:\n * http:\/\/opensource.org\/licenses\/osl-3.0.php\n * If you did not receive a copy of the license and are unable to\n * obtain it through the world-wide-web, please send an email\n * to license@magentocommerce.com so we can send you a copy immediately.\n *\n * @category    Phoenix\n * @package     Phoenix_Moneybookers\n * @copyright   Copyright (c) 2016 Phoenix Medien GmbH & Co. KG (http:\/\/www.phoenix-medien.de)\n * @license     http:\/\/opensource.org\/licenses\/osl-3.0.php  Open Software License (OSL 3.0)\n *\/",2],["T_WHITESPACE","\n\n",19],["T_DOC_COMMENT","\/**\n * Moneybookers notification processor model\n *\/",21],["T_WHITESPACE","\n",23],["T_CLASS","class",24],["T_WHITESPACE"," ",24],["T_STRING","Phoenix_Moneybookers_Model_Event",24],["T_WHITESPACE","\n",24],"{",["T_WHITESPACE","\n    ",25],["T_CONST","const",26],["T_WHITESPACE"," ",26],["T_STRING","MONEYBOOKERS_STATUS_FAIL",26],["T_WHITESPACE"," ",26],"=",["T_WHITESPACE"," ",26],"-",["T_LNUMBER","2",26],";",["T_WHITESPACE","\n    ",26],["T_CONST","const",27],["T_WHITESPACE"," ",27],["T_STRING","MONEYBOOKERS_STATUS_CANCEL",27],["T_WHITESPACE"," ",27],"=",["T_WHITESPACE"," ",27],"-",["T_LNUMBER","1",27],";",["T_WHITESPACE","\n    ",27],["T_CONST","const",28],["T_WHITESPACE"," ",28],["T_STRING","MONEYBOOKERS_STATUS_PENDING",28],["T_WHITESPACE"," ",28],"=",["T_WHITESPACE"," ",28],["T_LNUMBER","0",28],";",["T_WHITESPACE","\n    ",28],["T_CONST","const",29],["T_WHITESPACE"," ",29],["T_STRING","MONEYBOOKERS_STATUS_SUCCESS",29],["T_WHITESPACE"," ",29],"=",["T_WHITESPACE"," ",29],["T_LNUMBER","2",29],";",["T_WHITESPACE","\n\n    ",29],["T_DOC_COMMENT","\/**\n     * Store order instance\n     *\n     * @var Mage_Sales_Model_Order\n     *\/",31],["T_WHITESPACE","\n    ",35],["T_PROTECTED","protected",36],["T_WHITESPACE"," ",36],["T_VARIABLE","$_order",36],["T_WHITESPACE"," ",36],"=",["T_WHITESPACE"," ",36],["T_STRING","null",36],";",["T_WHITESPACE","\n\n    ",36],["T_DOC_COMMENT","\/**\n     * Event request data\n     * @var array\n     *\/",38],["T_WHITESPACE","\n    ",41],["T_PROTECTED","protected",42],["T_WHITESPACE"," ",42],["T_VARIABLE","$_eventData",42],["T_WHITESPACE"," ",42],"=",["T_WHITESPACE"," ",42],["T_ARRAY","array",42],"(",")",";",["T_WHITESPACE","\n\n    ",42],["T_DOC_COMMENT","\/**\n     * Enent request data setter\n     * @param array $data\n     * @return Phoenix_Moneybookers_Model_Event\n     *\/",44],["T_WHITESPACE","\n    ",48],["T_PUBLIC","public",49],["T_WHITESPACE"," ",49],["T_FUNCTION","function",49],["T_WHITESPACE"," ",49],["T_STRING","setEventData",49],"(",["T_ARRAY","array",49],["T_WHITESPACE"," ",49],["T_VARIABLE","$data",49],")",["T_WHITESPACE","\n    ",49],"{",["T_WHITESPACE","\n        ",50],["T_VARIABLE","$this",51],["T_OBJECT_OPERATOR","->",51],["T_STRING","_eventData",51],["T_WHITESPACE"," ",51],"=",["T_WHITESPACE"," ",51],["T_VARIABLE","$data",51],";",["T_WHITESPACE","\n        ",51],["T_RETURN","return",52],["T_WHITESPACE"," ",52],["T_VARIABLE","$this",52],";",["T_WHITESPACE","\n    ",52],"}",["T_WHITESPACE","\n\n    ",53],["T_DOC_COMMENT","\/**\n     * Event request data getter\n     * @param string $key\n     * @return array|string\n     *\/",55],["T_WHITESPACE","\n    ",59],["T_PUBLIC","public",60],["T_WHITESPACE"," ",60],["T_FUNCTION","function",60],["T_WHITESPACE"," ",60],["T_STRING","getEventData",60],"(",["T_VARIABLE","$key",60],["T_WHITESPACE"," ",60],"=",["T_WHITESPACE"," ",60],["T_STRING","null",60],")",["T_WHITESPACE","\n    ",60],"{",["T_WHITESPACE","\n        ",61],["T_IF","if",62],["T_WHITESPACE"," ",62],"(",["T_STRING","null",62],["T_WHITESPACE"," ",62],["T_IS_IDENTICAL","===",62],["T_WHITESPACE"," ",62],["T_VARIABLE","$key",62],")",["T_WHITESPACE"," ",62],"{",["T_WHITESPACE","\n            ",62],["T_RETURN","return",63],["T_WHITESPACE"," ",63],["T_VARIABLE","$this",63],["T_OBJECT_OPERATOR","->",63],["T_STRING","_eventData",63],";",["T_WHITESPACE","\n        ",63],"}",["T_WHITESPACE","\n        ",64],["T_RETURN","return",65],["T_WHITESPACE"," ",65],["T_ISSET","isset",65],"(",["T_VARIABLE","$this",65],["T_OBJECT_OPERATOR","->",65],["T_STRING","_eventData",65],"[",["T_VARIABLE","$key",65],"]",")",["T_WHITESPACE"," ",65],"?",["T_WHITESPACE"," ",65],["T_VARIABLE","$this",65],["T_OBJECT_OPERATOR","->",65],["T_STRING","_eventData",65],"[",["T_VARIABLE","$key",65],"]",["T_WHITESPACE"," ",65],":",["T_WHITESPACE"," ",65],["T_STRING","null",65],";",["T_WHITESPACE","\n    ",65],"}",["T_WHITESPACE","\n\n    ",66],["T_DOC_COMMENT","\/**\n     * Get singleton of Checkout Session Model\n     *\n     * @return Mage_Checkout_Model_Session\n     *\/",68],["T_WHITESPACE","\n    ",72],["T_PROTECTED","protected",73],["T_WHITESPACE"," ",73],["T_FUNCTION","function",73],["T_WHITESPACE"," ",73],["T_STRING","_getCheckout",73],"(",")",["T_WHITESPACE","\n    ",73],"{",["T_WHITESPACE","\n        ",74],["T_RETURN","return",75],["T_WHITESPACE"," ",75],["T_STRING","Mage",75],["T_DOUBLE_COLON","::",75],["T_STRING","getSingleton",75],"(",["T_CONSTANT_ENCAPSED_STRING","'checkout\/session'",75],")",";",["T_WHITESPACE","\n    ",75],"}",["T_WHITESPACE","\n\n    ",76],["T_DOC_COMMENT","\/**\n     * Process status notification from Monebookers server\n     *\n     * @return String\n     *\/",78],["T_WHITESPACE","\n    ",82],["T_PUBLIC","public",83],["T_WHITESPACE"," ",83],["T_FUNCTION","function",83],["T_WHITESPACE"," ",83],["T_STRING","processStatusEvent",83],"(",")",["T_WHITESPACE","\n    ",83],"{",["T_WHITESPACE","\n        ",84],["T_TRY","try",85],["T_WHITESPACE"," ",85],"{",["T_WHITESPACE","\n            ",85],["T_VARIABLE","$params",86],["T_WHITESPACE"," ",86],"=",["T_WHITESPACE"," ",86],["T_VARIABLE","$this",86],["T_OBJECT_OPERATOR","->",86],["T_STRING","_validateEventData",86],"(",")",";",["T_WHITESPACE","\n            ",86],["T_VARIABLE","$msg",87],["T_WHITESPACE"," ",87],"=",["T_WHITESPACE"," ",87],["T_CONSTANT_ENCAPSED_STRING","''",87],";",["T_WHITESPACE","\n            ",87],["T_SWITCH","switch",88],"(",["T_VARIABLE","$params",88],"[",["T_CONSTANT_ENCAPSED_STRING","'status'",88],"]",")",["T_WHITESPACE"," ",88],"{",["T_WHITESPACE","\n                ",88],["T_CASE","case",89],["T_WHITESPACE"," ",89],["T_STRING","self",89],["T_DOUBLE_COLON","::",89],["T_STRING","MONEYBOOKERS_STATUS_FAIL",89],":",["T_WHITESPACE"," ",89],["T_COMMENT","\/\/fail\n",89],["T_WHITESPACE","                    ",90],["T_VARIABLE","$msg",90],["T_WHITESPACE"," ",90],"=",["T_WHITESPACE"," ",90],["T_STRING","Mage",90],["T_DOUBLE_COLON","::",90],["T_STRING","helper",90],"(",["T_CONSTANT_ENCAPSED_STRING","'moneybookers'",90],")",["T_OBJECT_OPERATOR","->",90],["T_STRING","__",90],"(",["T_CONSTANT_ENCAPSED_STRING","'Payment failed.'",90],")",";",["T_WHITESPACE","\n                    ",90],["T_VARIABLE","$this",91],["T_OBJECT_OPERATOR","->",91],["T_STRING","_processCancel",91],"(",["T_VARIABLE","$msg",91],")",";",["T_WHITESPACE","\n                    ",91],["T_BREAK","break",92],";",["T_WHITESPACE","\n                ",92],["T_CASE","case",93],["T_WHITESPACE"," ",93],["T_STRING","self",93],["T_DOUBLE_COLON","::",93],["T_STRING","MONEYBOOKERS_STATUS_CANCEL",93],":",["T_WHITESPACE"," ",93],["T_COMMENT","\/\/cancel\n",93],["T_WHITESPACE","                    ",94],["T_VARIABLE","$msg",94],["T_WHITESPACE"," ",94],"=",["T_WHITESPACE"," ",94],["T_STRING","Mage",94],["T_DOUBLE_COLON","::",94],["T_STRING","helper",94],"(",["T_CONSTANT_ENCAPSED_STRING","'moneybookers'",94],")",["T_OBJECT_OPERATOR","->",94],["T_STRING","__",94],"(",["T_CONSTANT_ENCAPSED_STRING","'Payment was canceled.'",94],")",";",["T_WHITESPACE","\n                    ",94],["T_VARIABLE","$this",95],["T_OBJECT_OPERATOR","->",95],["T_STRING","_processCancel",95],"(",["T_VARIABLE","$msg",95],")",";",["T_WHITESPACE","\n                    ",95],["T_BREAK","break",96],";",["T_WHITESPACE","\n                ",96],["T_CASE","case",97],["T_WHITESPACE"," ",97],["T_STRING","self",97],["T_DOUBLE_COLON","::",97],["T_STRING","MONEYBOOKERS_STATUS_PENDING",97],":",["T_WHITESPACE"," ",97],["T_COMMENT","\/\/pending\n",97],["T_WHITESPACE","                    ",98],["T_VARIABLE","$msg",98],["T_WHITESPACE"," ",98],"=",["T_WHITESPACE"," ",98],["T_STRING","Mage",98],["T_DOUBLE_COLON","::",98],["T_STRING","helper",98],"(",["T_CONSTANT_ENCAPSED_STRING","'moneybookers'",98],")",["T_OBJECT_OPERATOR","->",98],["T_STRING","__",98],"(",["T_CONSTANT_ENCAPSED_STRING","'Pending bank transfer created.'",98],")",";",["T_WHITESPACE","\n                    ",98],["T_VARIABLE","$this",99],["T_OBJECT_OPERATOR","->",99],["T_STRING","_processSale",99],"(",["T_VARIABLE","$params",99],"[",["T_CONSTANT_ENCAPSED_STRING","'status'",99],"]",",",["T_WHITESPACE"," ",99],["T_VARIABLE","$msg",99],")",";",["T_WHITESPACE","\n                    ",99],["T_BREAK","break",100],";",["T_WHITESPACE","\n                ",100],["T_CASE","case",101],["T_WHITESPACE"," ",101],["T_STRING","self",101],["T_DOUBLE_COLON","::",101],["T_STRING","MONEYBOOKERS_STATUS_SUCCESS",101],":",["T_WHITESPACE"," ",101],["T_COMMENT","\/\/ok\n",101],["T_WHITESPACE","                    ",102],["T_VARIABLE","$msg",102],["T_WHITESPACE"," ",102],"=",["T_WHITESPACE"," ",102],["T_STRING","Mage",102],["T_DOUBLE_COLON","::",102],["T_STRING","helper",102],"(",["T_CONSTANT_ENCAPSED_STRING","'moneybookers'",102],")",["T_OBJECT_OPERATOR","->",102],["T_STRING","__",102],"(",["T_CONSTANT_ENCAPSED_STRING","'The amount has been authorized and captured by Moneybookers.'",102],")",";",["T_WHITESPACE","\n                    ",102],["T_VARIABLE","$this",103],["T_OBJECT_OPERATOR","->",103],["T_STRING","_processSale",103],"(",["T_VARIABLE","$params",103],"[",["T_CONSTANT_ENCAPSED_STRING","'status'",103],"]",",",["T_WHITESPACE"," ",103],["T_VARIABLE","$msg",103],")",";",["T_WHITESPACE","\n                    ",103],["T_BREAK","break",104],";",["T_WHITESPACE","\n            ",104],"}",["T_WHITESPACE","\n            ",105],["T_RETURN","return",106],["T_WHITESPACE"," ",106],["T_VARIABLE","$msg",106],";",["T_WHITESPACE","\n        ",106],"}",["T_WHITESPACE"," ",107],["T_CATCH","catch",107],["T_WHITESPACE"," ",107],"(",["T_STRING","Mage_Core_Exception",107],["T_WHITESPACE"," ",107],["T_VARIABLE","$e",107],")",["T_WHITESPACE"," ",107],"{",["T_WHITESPACE","\n            ",107],["T_RETURN","return",108],["T_WHITESPACE"," ",108],["T_VARIABLE","$e",108],["T_OBJECT_OPERATOR","->",108],["T_STRING","getMessage",108],"(",")",";",["T_WHITESPACE","\n        ",108],"}",["T_WHITESPACE"," ",109],["T_CATCH","catch",109],"(",["T_STRING","Exception",109],["T_WHITESPACE"," ",109],["T_VARIABLE","$e",109],")",["T_WHITESPACE"," ",109],"{",["T_WHITESPACE","\n            ",109],["T_STRING","Mage",110],["T_DOUBLE_COLON","::",110],["T_STRING","logException",110],"(",["T_VARIABLE","$e",110],")",";",["T_WHITESPACE","\n        ",110],"}",["T_WHITESPACE","\n        ",111],["T_RETURN","return",112],";",["T_WHITESPACE","\n    ",112],"}",["T_WHITESPACE","\n\n    ",113],["T_DOC_COMMENT","\/**\n     * Process cancelation\n     *\/",115],["T_WHITESPACE","\n    ",117],["T_PUBLIC","public",118],["T_WHITESPACE"," ",118],["T_FUNCTION","function",118],["T_WHITESPACE"," ",118],["T_STRING","cancelEvent",118],"(",")",["T_WHITESPACE"," ",118],"{",["T_WHITESPACE","\n        ",118],["T_TRY","try",119],["T_WHITESPACE"," ",119],"{",["T_WHITESPACE","\n            ",119],["T_VARIABLE","$this",120],["T_OBJECT_OPERATOR","->",120],["T_STRING","_validateEventData",120],"(",["T_STRING","false",120],")",";",["T_WHITESPACE","\n            ",120],["T_VARIABLE","$this",121],["T_OBJECT_OPERATOR","->",121],["T_STRING","_processCancel",121],"(",["T_CONSTANT_ENCAPSED_STRING","'Payment was canceled.'",121],")",";",["T_WHITESPACE","\n            ",121],["T_RETURN","return",122],["T_WHITESPACE"," ",122],["T_STRING","Mage",122],["T_DOUBLE_COLON","::",122],["T_STRING","helper",122],"(",["T_CONSTANT_ENCAPSED_STRING","'moneybookers'",122],")",["T_OBJECT_OPERATOR","->",122],["T_STRING","__",122],"(",["T_CONSTANT_ENCAPSED_STRING","'The order has been canceled.'",122],")",";",["T_WHITESPACE","\n        ",122],"}",["T_WHITESPACE"," ",123],["T_CATCH","catch",123],["T_WHITESPACE"," ",123],"(",["T_STRING","Mage_Core_Exception",123],["T_WHITESPACE"," ",123],["T_VARIABLE","$e",123],")",["T_WHITESPACE"," ",123],"{",["T_WHITESPACE","\n            ",123],["T_RETURN","return",124],["T_WHITESPACE"," ",124],["T_VARIABLE","$e",124],["T_OBJECT_OPERATOR","->",124],["T_STRING","getMessage",124],"(",")",";",["T_WHITESPACE","\n        ",124],"}",["T_WHITESPACE"," ",125],["T_CATCH","catch",125],"(",["T_STRING","Exception",125],["T_WHITESPACE"," ",125],["T_VARIABLE","$e",125],")",["T_WHITESPACE"," ",125],"{",["T_WHITESPACE","\n            ",125],["T_STRING","Mage",126],["T_DOUBLE_COLON","::",126],["T_STRING","logException",126],"(",["T_VARIABLE","$e",126],")",";",["T_WHITESPACE","\n        ",126],"}",["T_WHITESPACE","\n        ",127],["T_RETURN","return",128],["T_WHITESPACE"," ",128],["T_CONSTANT_ENCAPSED_STRING","''",128],";",["T_WHITESPACE","\n    ",128],"}",["T_WHITESPACE","\n\n    ",129],["T_DOC_COMMENT","\/**\n     * Validate request and return QuoteId\n     * Can throw Mage_Core_Exception and Exception\n     *\n     * @return int\n     *\/",131],["T_WHITESPACE","\n    ",136],["T_PUBLIC","public",137],["T_WHITESPACE"," ",137],["T_FUNCTION","function",137],["T_WHITESPACE"," ",137],["T_STRING","successEvent",137],"(",")","{",["T_WHITESPACE","\n        ",137],["T_VARIABLE","$this",138],["T_OBJECT_OPERATOR","->",138],["T_STRING","_validateEventData",138],"(",["T_STRING","false",138],")",";",["T_WHITESPACE","\n        ",138],["T_RETURN","return",139],["T_WHITESPACE"," ",139],["T_VARIABLE","$this",139],["T_OBJECT_OPERATOR","->",139],["T_STRING","_order",139],["T_OBJECT_OPERATOR","->",139],["T_STRING","getQuoteId",139],"(",")",";",["T_WHITESPACE","\n    ",139],"}",["T_WHITESPACE","\n\n    ",140],["T_DOC_COMMENT","\/**\n     * Processed order cancelation\n     * @param string $msg Order history message\n     *\/",142],["T_WHITESPACE","\n    ",145],["T_PROTECTED","protected",146],["T_WHITESPACE"," ",146],["T_FUNCTION","function",146],["T_WHITESPACE"," ",146],["T_STRING","_processCancel",146],"(",["T_VARIABLE","$msg",146],")",["T_WHITESPACE","\n    ",146],"{",["T_WHITESPACE","\n        ",147],["T_VARIABLE","$this",148],["T_OBJECT_OPERATOR","->",148],["T_STRING","_order",148],["T_OBJECT_OPERATOR","->",148],["T_STRING","cancel",148],"(",")",";",["T_WHITESPACE","\n        ",148],["T_VARIABLE","$this",149],["T_OBJECT_OPERATOR","->",149],["T_STRING","_order",149],["T_OBJECT_OPERATOR","->",149],["T_STRING","addStatusToHistory",149],"(",["T_STRING","Mage_Sales_Model_Order",149],["T_DOUBLE_COLON","::",149],["T_STRING","STATE_CANCELED",149],",",["T_WHITESPACE"," ",149],["T_VARIABLE","$msg",149],")",";",["T_WHITESPACE","\n        ",149],["T_VARIABLE","$this",150],["T_OBJECT_OPERATOR","->",150],["T_STRING","_order",150],["T_OBJECT_OPERATOR","->",150],["T_STRING","save",150],"(",")",";",["T_WHITESPACE","\n    ",150],"}",["T_WHITESPACE","\n\n    ",151],["T_DOC_COMMENT","\/**\n     * Processes payment confirmation, creates invoice if necessary, updates order status,\n     * sends order confirmation to customer\n     *\n     * @param string $status\n     * @param string $msg Order history message\n     *\/",153],["T_WHITESPACE","\n    ",159],["T_PROTECTED","protected",160],["T_WHITESPACE"," ",160],["T_FUNCTION","function",160],["T_WHITESPACE"," ",160],["T_STRING","_processSale",160],"(",["T_VARIABLE","$status",160],",",["T_WHITESPACE"," ",160],["T_VARIABLE","$msg",160],")",["T_WHITESPACE","\n    ",160],"{",["T_WHITESPACE","\n        ",161],["T_SWITCH","switch",162],["T_WHITESPACE"," ",162],"(",["T_VARIABLE","$status",162],")",["T_WHITESPACE"," ",162],"{",["T_WHITESPACE","\n            ",162],["T_CASE","case",163],["T_WHITESPACE"," ",163],["T_STRING","self",163],["T_DOUBLE_COLON","::",163],["T_STRING","MONEYBOOKERS_STATUS_SUCCESS",163],":",["T_WHITESPACE","\n                ",163],["T_VARIABLE","$this",164],["T_OBJECT_OPERATOR","->",164],["T_STRING","_createInvoice",164],"(",")",";",["T_WHITESPACE","\n                ",164],["T_VARIABLE","$this",165],["T_OBJECT_OPERATOR","->",165],["T_STRING","_order",165],["T_OBJECT_OPERATOR","->",165],["T_STRING","setState",165],"(",["T_STRING","Mage_Sales_Model_Order",165],["T_DOUBLE_COLON","::",165],["T_STRING","STATE_PROCESSING",165],",",["T_WHITESPACE"," ",165],["T_STRING","true",165],",",["T_WHITESPACE"," ",165],["T_VARIABLE","$msg",165],")",";",["T_WHITESPACE","\n                ",165],["T_COMMENT","\/\/ save transaction ID\n",166],["T_WHITESPACE","                ",167],["T_VARIABLE","$this",167],["T_OBJECT_OPERATOR","->",167],["T_STRING","_order",167],["T_OBJECT_OPERATOR","->",167],["T_STRING","getPayment",167],"(",")",["T_OBJECT_OPERATOR","->",167],["T_STRING","setLastTransId",167],"(",["T_VARIABLE","$this",167],["T_OBJECT_OPERATOR","->",167],["T_STRING","getEventData",167],"(",["T_CONSTANT_ENCAPSED_STRING","'mb_transaction_id'",167],")",")",";",["T_WHITESPACE","\n                ",167],["T_COMMENT","\/\/ send new order email\n",168],["T_WHITESPACE","                ",169],["T_VARIABLE","$this",169],["T_OBJECT_OPERATOR","->",169],["T_STRING","_order",169],["T_OBJECT_OPERATOR","->",169],["T_STRING","queueNewOrderEmail",169],"(",")",";",["T_WHITESPACE","\n                ",169],["T_VARIABLE","$this",170],["T_OBJECT_OPERATOR","->",170],["T_STRING","_order",170],["T_OBJECT_OPERATOR","->",170],["T_STRING","setEmailSent",170],"(",["T_STRING","true",170],")",";",["T_WHITESPACE","\n                ",170],["T_BREAK","break",171],";",["T_WHITESPACE","\n            ",171],["T_CASE","case",172],["T_WHITESPACE"," ",172],["T_STRING","self",172],["T_DOUBLE_COLON","::",172],["T_STRING","MONEYBOOKERS_STATUS_PENDING",172],":",["T_WHITESPACE","\n                ",172],["T_VARIABLE","$this",173],["T_OBJECT_OPERATOR","->",173],["T_STRING","_order",173],["T_OBJECT_OPERATOR","->",173],["T_STRING","setState",173],"(",["T_STRING","Mage_Sales_Model_Order",173],["T_DOUBLE_COLON","::",173],["T_STRING","STATE_PENDING_PAYMENT",173],",",["T_WHITESPACE"," ",173],["T_STRING","true",173],",",["T_WHITESPACE"," ",173],["T_VARIABLE","$msg",173],")",";",["T_WHITESPACE","\n                ",173],["T_COMMENT","\/\/ save transaction ID\n",174],["T_WHITESPACE","                ",175],["T_VARIABLE","$this",175],["T_OBJECT_OPERATOR","->",175],["T_STRING","_order",175],["T_OBJECT_OPERATOR","->",175],["T_STRING","getPayment",175],"(",")",["T_OBJECT_OPERATOR","->",175],["T_STRING","setLastTransId",175],"(",["T_VARIABLE","$this",175],["T_OBJECT_OPERATOR","->",175],["T_STRING","getEventData",175],"(",["T_CONSTANT_ENCAPSED_STRING","'mb_transaction_id'",175],")",")",";",["T_WHITESPACE","\n                ",175],["T_BREAK","break",176],";",["T_WHITESPACE","\n        ",176],"}",["T_WHITESPACE","\n        ",177],["T_VARIABLE","$this",178],["T_OBJECT_OPERATOR","->",178],["T_STRING","_order",178],["T_OBJECT_OPERATOR","->",178],["T_STRING","save",178],"(",")",";",["T_WHITESPACE","\n    ",178],"}",["T_WHITESPACE","\n\n    ",179],["T_DOC_COMMENT","\/**\n     * Builds invoice for order\n     *\/",181],["T_WHITESPACE","\n    ",183],["T_PROTECTED","protected",184],["T_WHITESPACE"," ",184],["T_FUNCTION","function",184],["T_WHITESPACE"," ",184],["T_STRING","_createInvoice",184],"(",")",["T_WHITESPACE","\n    ",184],"{",["T_WHITESPACE","\n        ",185],["T_IF","if",186],["T_WHITESPACE"," ",186],"(","!",["T_VARIABLE","$this",186],["T_OBJECT_OPERATOR","->",186],["T_STRING","_order",186],["T_OBJECT_OPERATOR","->",186],["T_STRING","canInvoice",186],"(",")",")",["T_WHITESPACE"," ",186],"{",["T_WHITESPACE","\n            ",186],["T_RETURN","return",187],";",["T_WHITESPACE","\n        ",187],"}",["T_WHITESPACE","\n        ",188],["T_VARIABLE","$invoice",189],["T_WHITESPACE"," ",189],"=",["T_WHITESPACE"," ",189],["T_VARIABLE","$this",189],["T_OBJECT_OPERATOR","->",189],["T_STRING","_order",189],["T_OBJECT_OPERATOR","->",189],["T_STRING","prepareInvoice",189],"(",")",";",["T_WHITESPACE","\n        ",189],["T_VARIABLE","$invoice",190],["T_OBJECT_OPERATOR","->",190],["T_STRING","register",190],"(",")",["T_OBJECT_OPERATOR","->",190],["T_STRING","capture",190],"(",")",";",["T_WHITESPACE","\n        ",190],["T_VARIABLE","$this",191],["T_OBJECT_OPERATOR","->",191],["T_STRING","_order",191],["T_OBJECT_OPERATOR","->",191],["T_STRING","addRelatedObject",191],"(",["T_VARIABLE","$invoice",191],")",";",["T_WHITESPACE","\n    ",191],"}",["T_WHITESPACE","\n\n    ",192],["T_DOC_COMMENT","\/**\n     * Checking returned parameters\n     * Thorws Mage_Core_Exception if error\n     * @param bool $fullCheck Whether to make additional validations such as payment status, transaction signature etc.\n     *\n     * @return array  $params request params\n     *\/",194],["T_WHITESPACE","\n    ",200],["T_PROTECTED","protected",201],["T_WHITESPACE"," ",201],["T_FUNCTION","function",201],["T_WHITESPACE"," ",201],["T_STRING","_validateEventData",201],"(",["T_VARIABLE","$fullCheck",201],["T_WHITESPACE"," ",201],"=",["T_WHITESPACE"," ",201],["T_STRING","true",201],")",["T_WHITESPACE","\n    ",201],"{",["T_WHITESPACE","\n        ",202],["T_COMMENT","\/\/ get request variables\n",203],["T_WHITESPACE","        ",204],["T_VARIABLE","$params",204],["T_WHITESPACE"," ",204],"=",["T_WHITESPACE"," ",204],["T_VARIABLE","$this",204],["T_OBJECT_OPERATOR","->",204],["T_STRING","_eventData",204],";",["T_WHITESPACE","\n        ",204],["T_IF","if",205],["T_WHITESPACE"," ",205],"(",["T_EMPTY","empty",205],"(",["T_VARIABLE","$params",205],")",")",["T_WHITESPACE"," ",205],"{",["T_WHITESPACE","\n            ",205],["T_STRING","Mage",206],["T_DOUBLE_COLON","::",206],["T_STRING","throwException",206],"(",["T_CONSTANT_ENCAPSED_STRING","'Request does not contain any elements.'",206],")",";",["T_WHITESPACE","\n        ",206],"}",["T_WHITESPACE","\n\n        ",207],["T_COMMENT","\/\/ check order ID\n",209],["T_WHITESPACE","        ",210],["T_IF","if",210],["T_WHITESPACE"," ",210],"(",["T_EMPTY","empty",210],"(",["T_VARIABLE","$params",210],"[",["T_CONSTANT_ENCAPSED_STRING","'transaction_id'",210],"]",")",["T_WHITESPACE","\n            ",210],["T_BOOLEAN_OR","||",211],["T_WHITESPACE"," ",211],"(",["T_VARIABLE","$fullCheck",211],["T_WHITESPACE"," ",211],["T_IS_EQUAL","==",211],["T_WHITESPACE"," ",211],["T_STRING","false",211],["T_WHITESPACE"," ",211],["T_BOOLEAN_AND","&&",211],["T_WHITESPACE"," ",211],["T_VARIABLE","$this",211],["T_OBJECT_OPERATOR","->",211],["T_STRING","_getCheckout",211],"(",")",["T_OBJECT_OPERATOR","->",211],["T_STRING","getMoneybookersRealOrderId",211],"(",")",["T_WHITESPACE"," ",211],["T_IS_NOT_EQUAL","!=",211],["T_WHITESPACE"," ",211],["T_VARIABLE","$params",211],"[",["T_CONSTANT_ENCAPSED_STRING","'transaction_id'",211],"]",")",["T_WHITESPACE","\n        ",211],")",["T_WHITESPACE"," ",212],"{",["T_WHITESPACE","\n            ",212],["T_STRING","Mage",213],["T_DOUBLE_COLON","::",213],["T_STRING","throwException",213],"(",["T_CONSTANT_ENCAPSED_STRING","'Missing or invalid order ID.'",213],")",";",["T_WHITESPACE","\n        ",213],"}",["T_WHITESPACE","\n        ",214],["T_COMMENT","\/\/ load order for further validation\n",215],["T_WHITESPACE","        ",216],["T_VARIABLE","$this",216],["T_OBJECT_OPERATOR","->",216],["T_STRING","_order",216],["T_WHITESPACE"," ",216],"=",["T_WHITESPACE"," ",216],["T_STRING","Mage",216],["T_DOUBLE_COLON","::",216],["T_STRING","getModel",216],"(",["T_CONSTANT_ENCAPSED_STRING","'sales\/order'",216],")",["T_OBJECT_OPERATOR","->",216],["T_STRING","loadByIncrementId",216],"(",["T_VARIABLE","$params",216],"[",["T_CONSTANT_ENCAPSED_STRING","'transaction_id'",216],"]",")",";",["T_WHITESPACE","\n        ",216],["T_IF","if",217],["T_WHITESPACE"," ",217],"(","!",["T_VARIABLE","$this",217],["T_OBJECT_OPERATOR","->",217],["T_STRING","_order",217],["T_OBJECT_OPERATOR","->",217],["T_STRING","getId",217],"(",")",")",["T_WHITESPACE"," ",217],"{",["T_WHITESPACE","\n            ",217],["T_STRING","Mage",218],["T_DOUBLE_COLON","::",218],["T_STRING","throwException",218],"(",["T_CONSTANT_ENCAPSED_STRING","'Order not found.'",218],")",";",["T_WHITESPACE","\n        ",218],"}",["T_WHITESPACE","\n\n        ",219],["T_IF","if",221],["T_WHITESPACE"," ",221],"(",["T_LNUMBER","0",221],["T_WHITESPACE"," ",221],["T_IS_NOT_IDENTICAL","!==",221],["T_WHITESPACE"," ",221],["T_STRING","strpos",221],"(",["T_VARIABLE","$this",221],["T_OBJECT_OPERATOR","->",221],["T_STRING","_order",221],["T_OBJECT_OPERATOR","->",221],["T_STRING","getPayment",221],"(",")",["T_OBJECT_OPERATOR","->",221],["T_STRING","getMethodInstance",221],"(",")",["T_OBJECT_OPERATOR","->",221],["T_STRING","getCode",221],"(",")",",",["T_WHITESPACE"," ",221],["T_CONSTANT_ENCAPSED_STRING","'moneybookers_'",221],")",")",["T_WHITESPACE"," ",221],"{",["T_WHITESPACE","\n            ",221],["T_STRING","Mage",222],["T_DOUBLE_COLON","::",222],["T_STRING","throwException",222],"(",["T_CONSTANT_ENCAPSED_STRING","'Unknown payment method.'",222],")",";",["T_WHITESPACE","\n        ",222],"}",["T_WHITESPACE","\n\n        ",223],["T_COMMENT","\/\/ make additional validation\n",225],["T_WHITESPACE","        ",226],["T_IF","if",226],["T_WHITESPACE"," ",226],"(",["T_VARIABLE","$fullCheck",226],")",["T_WHITESPACE"," ",226],"{",["T_WHITESPACE","\n            ",226],["T_COMMENT","\/\/ check payment status\n",227],["T_WHITESPACE","            ",228],["T_IF","if",228],["T_WHITESPACE"," ",228],"(",["T_EMPTY","empty",228],"(",["T_VARIABLE","$params",228],"[",["T_CONSTANT_ENCAPSED_STRING","'status'",228],"]",")",")",["T_WHITESPACE"," ",228],"{",["T_WHITESPACE","\n                ",228],["T_STRING","Mage",229],["T_DOUBLE_COLON","::",229],["T_STRING","throwException",229],"(",["T_CONSTANT_ENCAPSED_STRING","'Unknown payment status.'",229],")",";",["T_WHITESPACE","\n            ",229],"}",["T_WHITESPACE","\n\n            ",230],["T_COMMENT","\/\/ check transaction signature\n",232],["T_WHITESPACE","            ",233],["T_IF","if",233],["T_WHITESPACE"," ",233],"(",["T_EMPTY","empty",233],"(",["T_VARIABLE","$params",233],"[",["T_CONSTANT_ENCAPSED_STRING","'md5sig'",233],"]",")",")",["T_WHITESPACE"," ",233],"{",["T_WHITESPACE","\n                ",233],["T_STRING","Mage",234],["T_DOUBLE_COLON","::",234],["T_STRING","throwException",234],"(",["T_CONSTANT_ENCAPSED_STRING","'Invalid transaction signature.'",234],")",";",["T_WHITESPACE","\n            ",234],"}",["T_WHITESPACE","\n\n            ",235],["T_VARIABLE","$checkParams",237],["T_WHITESPACE"," ",237],"=",["T_WHITESPACE"," ",237],["T_ARRAY","array",237],"(",["T_CONSTANT_ENCAPSED_STRING","'merchant_id'",237],",",["T_WHITESPACE"," ",237],["T_CONSTANT_ENCAPSED_STRING","'transaction_id'",237],",",["T_WHITESPACE"," ",237],["T_CONSTANT_ENCAPSED_STRING","'secret'",237],",",["T_WHITESPACE"," ",237],["T_CONSTANT_ENCAPSED_STRING","'mb_amount'",237],",",["T_WHITESPACE"," ",237],["T_CONSTANT_ENCAPSED_STRING","'mb_currency'",237],",",["T_WHITESPACE"," ",237],["T_CONSTANT_ENCAPSED_STRING","'status'",237],")",";",["T_WHITESPACE","\n            ",237],["T_VARIABLE","$md5String",238],["T_WHITESPACE"," ",238],"=",["T_WHITESPACE"," ",238],["T_CONSTANT_ENCAPSED_STRING","''",238],";",["T_WHITESPACE","\n            ",238],["T_FOREACH","foreach",239],["T_WHITESPACE"," ",239],"(",["T_VARIABLE","$checkParams",239],["T_WHITESPACE"," ",239],["T_AS","as",239],["T_WHITESPACE"," ",239],["T_VARIABLE","$key",239],")",["T_WHITESPACE"," ",239],"{",["T_WHITESPACE","\n                ",239],["T_IF","if",240],["T_WHITESPACE"," ",240],"(",["T_VARIABLE","$key",240],["T_WHITESPACE"," ",240],["T_IS_EQUAL","==",240],["T_WHITESPACE"," ",240],["T_CONSTANT_ENCAPSED_STRING","'merchant_id'",240],")",["T_WHITESPACE"," ",240],"{",["T_WHITESPACE","\n                    ",240],["T_VARIABLE","$md5String",241],["T_WHITESPACE"," ",241],["T_CONCAT_EQUAL",".=",241],["T_WHITESPACE"," ",241],["T_STRING","Mage",241],["T_DOUBLE_COLON","::",241],["T_STRING","getStoreConfig",241],"(",["T_STRING","Phoenix_Moneybookers_Helper_Data",241],["T_DOUBLE_COLON","::",241],["T_STRING","XML_PATH_CUSTOMER_ID",241],",",["T_WHITESPACE","\n                        ",241],["T_VARIABLE","$this",242],["T_OBJECT_OPERATOR","->",242],["T_STRING","_order",242],["T_OBJECT_OPERATOR","->",242],["T_STRING","getStoreId",242],"(",")",["T_WHITESPACE","\n                    ",242],")",";",["T_WHITESPACE","\n                ",243],"}",["T_WHITESPACE"," ",244],["T_ELSEIF","elseif",244],["T_WHITESPACE"," ",244],"(",["T_VARIABLE","$key",244],["T_WHITESPACE"," ",244],["T_IS_EQUAL","==",244],["T_WHITESPACE"," ",244],["T_CONSTANT_ENCAPSED_STRING","'secret'",244],")",["T_WHITESPACE"," ",244],"{",["T_WHITESPACE","\n                    ",244],["T_VARIABLE","$secretKey",245],["T_WHITESPACE"," ",245],"=",["T_WHITESPACE"," ",245],["T_STRING","Mage",245],["T_DOUBLE_COLON","::",245],["T_STRING","getStoreConfig",245],"(",["T_WHITESPACE","\n                        ",245],["T_STRING","Phoenix_Moneybookers_Helper_Data",246],["T_DOUBLE_COLON","::",246],["T_STRING","XML_PATH_SECRET_KEY",246],",",["T_WHITESPACE","\n                        ",246],["T_VARIABLE","$this",247],["T_OBJECT_OPERATOR","->",247],["T_STRING","_order",247],["T_OBJECT_OPERATOR","->",247],["T_STRING","getStoreId",247],"(",")",["T_WHITESPACE","\n                    ",247],")",";",["T_WHITESPACE","\n\n                    ",248],["T_IF","if",250],["T_WHITESPACE"," ",250],"(",["T_EMPTY","empty",250],"(",["T_VARIABLE","$secretKey",250],")",")",["T_WHITESPACE"," ",250],"{",["T_WHITESPACE","\n                        ",250],["T_STRING","Mage",251],["T_DOUBLE_COLON","::",251],["T_STRING","throwException",251],"(",["T_CONSTANT_ENCAPSED_STRING","'Secret key is empty.'",251],")",";",["T_WHITESPACE","\n                    ",251],"}",["T_WHITESPACE","\n\n                    ",252],["T_VARIABLE","$md5String",254],["T_WHITESPACE"," ",254],["T_CONCAT_EQUAL",".=",254],["T_WHITESPACE"," ",254],["T_STRING","strtoupper",254],"(",["T_STRING","md5",254],"(",["T_VARIABLE","$secretKey",254],")",")",";",["T_WHITESPACE","\n                ",254],"}",["T_WHITESPACE"," ",255],["T_ELSEIF","elseif",255],["T_WHITESPACE"," ",255],"(",["T_ISSET","isset",255],"(",["T_VARIABLE","$params",255],"[",["T_VARIABLE","$key",255],"]",")",")",["T_WHITESPACE"," ",255],"{",["T_WHITESPACE","\n                    ",255],["T_VARIABLE","$md5String",256],["T_WHITESPACE"," ",256],["T_CONCAT_EQUAL",".=",256],["T_WHITESPACE"," ",256],["T_VARIABLE","$params",256],"[",["T_VARIABLE","$key",256],"]",";",["T_WHITESPACE","\n                ",256],"}",["T_WHITESPACE","\n            ",257],"}",["T_WHITESPACE","\n            ",258],["T_VARIABLE","$md5String",259],["T_WHITESPACE"," ",259],"=",["T_WHITESPACE"," ",259],["T_STRING","strtoupper",259],"(",["T_STRING","md5",259],"(",["T_VARIABLE","$md5String",259],")",")",";",["T_WHITESPACE","\n\n            ",259],["T_IF","if",261],["T_WHITESPACE"," ",261],"(",["T_VARIABLE","$md5String",261],["T_WHITESPACE"," ",261],["T_IS_NOT_EQUAL","!=",261],["T_WHITESPACE"," ",261],["T_VARIABLE","$params",261],"[",["T_CONSTANT_ENCAPSED_STRING","'md5sig'",261],"]",")",["T_WHITESPACE"," ",261],"{",["T_WHITESPACE","\n                ",261],["T_STRING","Mage",262],["T_DOUBLE_COLON","::",262],["T_STRING","throwException",262],"(",["T_CONSTANT_ENCAPSED_STRING","'Hash is not valid.'",262],")",";",["T_WHITESPACE","\n            ",262],"}",["T_WHITESPACE","\n\n            ",263],["T_COMMENT","\/\/ check transaction amount if currency matches\n",265],["T_WHITESPACE","            ",266],["T_IF","if",266],["T_WHITESPACE"," ",266],"(",["T_VARIABLE","$this",266],["T_OBJECT_OPERATOR","->",266],["T_STRING","_order",266],["T_OBJECT_OPERATOR","->",266],["T_STRING","getOrderCurrencyCode",266],"(",")",["T_WHITESPACE"," ",266],["T_IS_EQUAL","==",266],["T_WHITESPACE"," ",266],["T_VARIABLE","$params",266],"[",["T_CONSTANT_ENCAPSED_STRING","'mb_currency'",266],"]",")",["T_WHITESPACE"," ",266],"{",["T_WHITESPACE","\n                ",266],["T_IF","if",267],["T_WHITESPACE"," ",267],"(",["T_STRING","round",267],"(",["T_VARIABLE","$this",267],["T_OBJECT_OPERATOR","->",267],["T_STRING","_order",267],["T_OBJECT_OPERATOR","->",267],["T_STRING","getGrandTotal",267],"(",")",",",["T_WHITESPACE"," ",267],["T_LNUMBER","2",267],")",["T_WHITESPACE"," ",267],["T_IS_NOT_EQUAL","!=",267],["T_WHITESPACE"," ",267],["T_VARIABLE","$params",267],"[",["T_CONSTANT_ENCAPSED_STRING","'mb_amount'",267],"]",")",["T_WHITESPACE"," ",267],"{",["T_WHITESPACE","\n                    ",267],["T_STRING","Mage",268],["T_DOUBLE_COLON","::",268],["T_STRING","throwException",268],"(",["T_CONSTANT_ENCAPSED_STRING","'Transaction amount does not match.'",268],")",";",["T_WHITESPACE","\n                ",268],"}",["T_WHITESPACE","\n            ",269],"}",["T_WHITESPACE","\n        ",270],"}",["T_WHITESPACE","\n        ",271],["T_RETURN","return",272],["T_WHITESPACE"," ",272],["T_VARIABLE","$params",272],";",["T_WHITESPACE","\n    ",272],"}",["T_WHITESPACE","\n",273],"}",["T_WHITESPACE","\n",274]]