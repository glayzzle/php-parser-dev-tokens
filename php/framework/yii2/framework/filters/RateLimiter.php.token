[["T_OPEN_TAG","<?php\n",1],["T_DOC_COMMENT","\/**\n * @link http:\/\/www.yiiframework.com\/\n * @copyright Copyright (c) 2008 Yii Software LLC\n * @license http:\/\/www.yiiframework.com\/license\/\n *\/",2],["T_WHITESPACE","\n\n",6],["T_NAMESPACE","namespace",8],["T_WHITESPACE"," ",8],["T_STRING","yii",8],["T_NS_SEPARATOR","\\",8],["T_STRING","filters",8],";",["T_WHITESPACE","\n\n",8],["T_USE","use",10],["T_WHITESPACE"," ",10],["T_STRING","Yii",10],";",["T_WHITESPACE","\n",10],["T_USE","use",11],["T_WHITESPACE"," ",11],["T_STRING","yii",11],["T_NS_SEPARATOR","\\",11],["T_STRING","base",11],["T_NS_SEPARATOR","\\",11],["T_STRING","ActionFilter",11],";",["T_WHITESPACE","\n",11],["T_USE","use",12],["T_WHITESPACE"," ",12],["T_STRING","yii",12],["T_NS_SEPARATOR","\\",12],["T_STRING","web",12],["T_NS_SEPARATOR","\\",12],["T_STRING","Request",12],";",["T_WHITESPACE","\n",12],["T_USE","use",13],["T_WHITESPACE"," ",13],["T_STRING","yii",13],["T_NS_SEPARATOR","\\",13],["T_STRING","web",13],["T_NS_SEPARATOR","\\",13],["T_STRING","Response",13],";",["T_WHITESPACE","\n",13],["T_USE","use",14],["T_WHITESPACE"," ",14],["T_STRING","yii",14],["T_NS_SEPARATOR","\\",14],["T_STRING","web",14],["T_NS_SEPARATOR","\\",14],["T_STRING","TooManyRequestsHttpException",14],";",["T_WHITESPACE","\n\n",14],["T_DOC_COMMENT","\/**\n * RateLimiter implements a rate limiting algorithm based on the [leaky bucket algorithm](http:\/\/en.wikipedia.org\/wiki\/Leaky_bucket).\n *\n * You may use RateLimiter by attaching it as a behavior to a controller or module, like the following,\n *\n * ```php\n * public function behaviors()\n * {\n *     return [\n *         'rateLimiter' => [\n *             'class' => \\yii\\filters\\RateLimiter::className(),\n *         ],\n *     ];\n * }\n * ```\n *\n * When the user has exceeded his rate limit, RateLimiter will throw a [[TooManyRequestsHttpException]] exception.\n *\n * Note that RateLimiter requires [[user]] to implement the [[RateLimitInterface]]. RateLimiter will\n * do nothing if [[user]] is not set or does not implement [[RateLimitInterface]].\n *\n * @author Qiang Xue <qiang.xue@gmail.com>\n * @since 2.0\n *\/",16],["T_WHITESPACE","\n",39],["T_CLASS","class",40],["T_WHITESPACE"," ",40],["T_STRING","RateLimiter",40],["T_WHITESPACE"," ",40],["T_EXTENDS","extends",40],["T_WHITESPACE"," ",40],["T_STRING","ActionFilter",40],["T_WHITESPACE","\n",40],"{",["T_WHITESPACE","\n    ",41],["T_DOC_COMMENT","\/**\n     * @var bool whether to include rate limit headers in the response\n     *\/",42],["T_WHITESPACE","\n    ",44],["T_PUBLIC","public",45],["T_WHITESPACE"," ",45],["T_VARIABLE","$enableRateLimitHeaders",45],["T_WHITESPACE"," ",45],"=",["T_WHITESPACE"," ",45],["T_STRING","true",45],";",["T_WHITESPACE","\n    ",45],["T_DOC_COMMENT","\/**\n     * @var string the message to be displayed when rate limit exceeds\n     *\/",46],["T_WHITESPACE","\n    ",48],["T_PUBLIC","public",49],["T_WHITESPACE"," ",49],["T_VARIABLE","$errorMessage",49],["T_WHITESPACE"," ",49],"=",["T_WHITESPACE"," ",49],["T_CONSTANT_ENCAPSED_STRING","'Rate limit exceeded.'",49],";",["T_WHITESPACE","\n    ",49],["T_DOC_COMMENT","\/**\n     * @var RateLimitInterface the user object that implements the RateLimitInterface.\n     * If not set, it will take the value of `Yii::$app->user->getIdentity(false)`.\n     *\/",50],["T_WHITESPACE","\n    ",53],["T_PUBLIC","public",54],["T_WHITESPACE"," ",54],["T_VARIABLE","$user",54],";",["T_WHITESPACE","\n    ",54],["T_DOC_COMMENT","\/**\n     * @var Request the current request. If not set, the `request` application component will be used.\n     *\/",55],["T_WHITESPACE","\n    ",57],["T_PUBLIC","public",58],["T_WHITESPACE"," ",58],["T_VARIABLE","$request",58],";",["T_WHITESPACE","\n    ",58],["T_DOC_COMMENT","\/**\n     * @var Response the response to be sent. If not set, the `response` application component will be used.\n     *\/",59],["T_WHITESPACE","\n    ",61],["T_PUBLIC","public",62],["T_WHITESPACE"," ",62],["T_VARIABLE","$response",62],";",["T_WHITESPACE","\n\n\n    ",62],["T_DOC_COMMENT","\/**\n     * @inheritdoc\n     *\/",65],["T_WHITESPACE","\n    ",67],["T_PUBLIC","public",68],["T_WHITESPACE"," ",68],["T_FUNCTION","function",68],["T_WHITESPACE"," ",68],["T_STRING","beforeAction",68],"(",["T_VARIABLE","$action",68],")",["T_WHITESPACE","\n    ",68],"{",["T_WHITESPACE","\n        ",69],["T_VARIABLE","$user",70],["T_WHITESPACE"," ",70],"=",["T_WHITESPACE"," ",70],["T_VARIABLE","$this",70],["T_OBJECT_OPERATOR","->",70],["T_STRING","user",70],["T_WHITESPACE"," ",70],"?",["T_WHITESPACE"," ",70],":",["T_WHITESPACE"," ",70],"(",["T_STRING","Yii",70],["T_DOUBLE_COLON","::",70],["T_VARIABLE","$app",70],["T_OBJECT_OPERATOR","->",70],["T_STRING","getUser",70],"(",")",["T_WHITESPACE"," ",70],"?",["T_WHITESPACE"," ",70],["T_STRING","Yii",70],["T_DOUBLE_COLON","::",70],["T_VARIABLE","$app",70],["T_OBJECT_OPERATOR","->",70],["T_STRING","getUser",70],"(",")",["T_OBJECT_OPERATOR","->",70],["T_STRING","getIdentity",70],"(",["T_STRING","false",70],")",["T_WHITESPACE"," ",70],":",["T_WHITESPACE"," ",70],["T_STRING","null",70],")",";",["T_WHITESPACE","\n        ",70],["T_IF","if",71],["T_WHITESPACE"," ",71],"(",["T_VARIABLE","$user",71],["T_WHITESPACE"," ",71],["T_INSTANCEOF","instanceof",71],["T_WHITESPACE"," ",71],["T_STRING","RateLimitInterface",71],")",["T_WHITESPACE"," ",71],"{",["T_WHITESPACE","\n            ",71],["T_STRING","Yii",72],["T_DOUBLE_COLON","::",72],["T_STRING","trace",72],"(",["T_CONSTANT_ENCAPSED_STRING","'Check rate limit'",72],",",["T_WHITESPACE"," ",72],["T_METHOD_C","__METHOD__",72],")",";",["T_WHITESPACE","\n            ",72],["T_VARIABLE","$this",73],["T_OBJECT_OPERATOR","->",73],["T_STRING","checkRateLimit",73],"(",["T_WHITESPACE","\n                ",73],["T_VARIABLE","$user",74],",",["T_WHITESPACE","\n                ",74],["T_VARIABLE","$this",75],["T_OBJECT_OPERATOR","->",75],["T_STRING","request",75],["T_WHITESPACE"," ",75],"?",["T_WHITESPACE"," ",75],":",["T_WHITESPACE"," ",75],["T_STRING","Yii",75],["T_DOUBLE_COLON","::",75],["T_VARIABLE","$app",75],["T_OBJECT_OPERATOR","->",75],["T_STRING","getRequest",75],"(",")",",",["T_WHITESPACE","\n                ",75],["T_VARIABLE","$this",76],["T_OBJECT_OPERATOR","->",76],["T_STRING","response",76],["T_WHITESPACE"," ",76],"?",["T_WHITESPACE"," ",76],":",["T_WHITESPACE"," ",76],["T_STRING","Yii",76],["T_DOUBLE_COLON","::",76],["T_VARIABLE","$app",76],["T_OBJECT_OPERATOR","->",76],["T_STRING","getResponse",76],"(",")",",",["T_WHITESPACE","\n                ",76],["T_VARIABLE","$action",77],["T_WHITESPACE","\n            ",77],")",";",["T_WHITESPACE","\n        ",78],"}",["T_WHITESPACE"," ",79],["T_ELSEIF","elseif",79],["T_WHITESPACE"," ",79],"(",["T_VARIABLE","$user",79],")",["T_WHITESPACE"," ",79],"{",["T_WHITESPACE","\n            ",79],["T_STRING","Yii",80],["T_DOUBLE_COLON","::",80],["T_STRING","info",80],"(",["T_CONSTANT_ENCAPSED_STRING","'Rate limit skipped: \"user\" does not implement RateLimitInterface.'",80],",",["T_WHITESPACE"," ",80],["T_METHOD_C","__METHOD__",80],")",";",["T_WHITESPACE","\n        ",80],"}",["T_WHITESPACE"," ",81],["T_ELSE","else",81],["T_WHITESPACE"," ",81],"{",["T_WHITESPACE","\n            ",81],["T_STRING","Yii",82],["T_DOUBLE_COLON","::",82],["T_STRING","info",82],"(",["T_CONSTANT_ENCAPSED_STRING","'Rate limit skipped: user not logged in.'",82],",",["T_WHITESPACE"," ",82],["T_METHOD_C","__METHOD__",82],")",";",["T_WHITESPACE","\n        ",82],"}",["T_WHITESPACE","\n        ",83],["T_RETURN","return",84],["T_WHITESPACE"," ",84],["T_STRING","true",84],";",["T_WHITESPACE","\n    ",84],"}",["T_WHITESPACE","\n\n    ",85],["T_DOC_COMMENT","\/**\n     * Checks whether the rate limit exceeds.\n     * @param RateLimitInterface $user the current user\n     * @param Request $request\n     * @param Response $response\n     * @param \\yii\\base\\Action $action the action to be executed\n     * @throws TooManyRequestsHttpException if rate limit exceeds\n     *\/",87],["T_WHITESPACE","\n    ",94],["T_PUBLIC","public",95],["T_WHITESPACE"," ",95],["T_FUNCTION","function",95],["T_WHITESPACE"," ",95],["T_STRING","checkRateLimit",95],"(",["T_VARIABLE","$user",95],",",["T_WHITESPACE"," ",95],["T_VARIABLE","$request",95],",",["T_WHITESPACE"," ",95],["T_VARIABLE","$response",95],",",["T_WHITESPACE"," ",95],["T_VARIABLE","$action",95],")",["T_WHITESPACE","\n    ",95],"{",["T_WHITESPACE","\n        ",96],["T_VARIABLE","$current",97],["T_WHITESPACE"," ",97],"=",["T_WHITESPACE"," ",97],["T_STRING","time",97],"(",")",";",["T_WHITESPACE","\n\n        ",97],["T_LIST","list",99],["T_WHITESPACE"," ",99],"(",["T_VARIABLE","$limit",99],",",["T_WHITESPACE"," ",99],["T_VARIABLE","$window",99],")",["T_WHITESPACE"," ",99],"=",["T_WHITESPACE"," ",99],["T_VARIABLE","$user",99],["T_OBJECT_OPERATOR","->",99],["T_STRING","getRateLimit",99],"(",["T_VARIABLE","$request",99],",",["T_WHITESPACE"," ",99],["T_VARIABLE","$action",99],")",";",["T_WHITESPACE","\n        ",99],["T_LIST","list",100],["T_WHITESPACE"," ",100],"(",["T_VARIABLE","$allowance",100],",",["T_WHITESPACE"," ",100],["T_VARIABLE","$timestamp",100],")",["T_WHITESPACE"," ",100],"=",["T_WHITESPACE"," ",100],["T_VARIABLE","$user",100],["T_OBJECT_OPERATOR","->",100],["T_STRING","loadAllowance",100],"(",["T_VARIABLE","$request",100],",",["T_WHITESPACE"," ",100],["T_VARIABLE","$action",100],")",";",["T_WHITESPACE","\n\n        ",100],["T_VARIABLE","$allowance",102],["T_WHITESPACE"," ",102],["T_PLUS_EQUAL","+=",102],["T_WHITESPACE"," ",102],["T_INT_CAST","(int)",102],["T_WHITESPACE"," ",102],"(","(",["T_VARIABLE","$current",102],["T_WHITESPACE"," ",102],"-",["T_WHITESPACE"," ",102],["T_VARIABLE","$timestamp",102],")",["T_WHITESPACE"," ",102],"*",["T_WHITESPACE"," ",102],["T_VARIABLE","$limit",102],["T_WHITESPACE"," ",102],"\/",["T_WHITESPACE"," ",102],["T_VARIABLE","$window",102],")",";",["T_WHITESPACE","\n        ",102],["T_IF","if",103],["T_WHITESPACE"," ",103],"(",["T_VARIABLE","$allowance",103],["T_WHITESPACE"," ",103],">",["T_WHITESPACE"," ",103],["T_VARIABLE","$limit",103],")",["T_WHITESPACE"," ",103],"{",["T_WHITESPACE","\n            ",103],["T_VARIABLE","$allowance",104],["T_WHITESPACE"," ",104],"=",["T_WHITESPACE"," ",104],["T_VARIABLE","$limit",104],";",["T_WHITESPACE","\n        ",104],"}",["T_WHITESPACE","\n\n        ",105],["T_IF","if",107],["T_WHITESPACE"," ",107],"(",["T_VARIABLE","$allowance",107],["T_WHITESPACE"," ",107],"<",["T_WHITESPACE"," ",107],["T_LNUMBER","1",107],")",["T_WHITESPACE"," ",107],"{",["T_WHITESPACE","\n            ",107],["T_VARIABLE","$user",108],["T_OBJECT_OPERATOR","->",108],["T_STRING","saveAllowance",108],"(",["T_VARIABLE","$request",108],",",["T_WHITESPACE"," ",108],["T_VARIABLE","$action",108],",",["T_WHITESPACE"," ",108],["T_LNUMBER","0",108],",",["T_WHITESPACE"," ",108],["T_VARIABLE","$current",108],")",";",["T_WHITESPACE","\n            ",108],["T_VARIABLE","$this",109],["T_OBJECT_OPERATOR","->",109],["T_STRING","addRateLimitHeaders",109],"(",["T_VARIABLE","$response",109],",",["T_WHITESPACE"," ",109],["T_VARIABLE","$limit",109],",",["T_WHITESPACE"," ",109],["T_LNUMBER","0",109],",",["T_WHITESPACE"," ",109],["T_VARIABLE","$window",109],")",";",["T_WHITESPACE","\n            ",109],["T_THROW","throw",110],["T_WHITESPACE"," ",110],["T_NEW","new",110],["T_WHITESPACE"," ",110],["T_STRING","TooManyRequestsHttpException",110],"(",["T_VARIABLE","$this",110],["T_OBJECT_OPERATOR","->",110],["T_STRING","errorMessage",110],")",";",["T_WHITESPACE","\n        ",110],"}",["T_WHITESPACE"," ",111],["T_ELSE","else",111],["T_WHITESPACE"," ",111],"{",["T_WHITESPACE","\n            ",111],["T_VARIABLE","$user",112],["T_OBJECT_OPERATOR","->",112],["T_STRING","saveAllowance",112],"(",["T_VARIABLE","$request",112],",",["T_WHITESPACE"," ",112],["T_VARIABLE","$action",112],",",["T_WHITESPACE"," ",112],["T_VARIABLE","$allowance",112],["T_WHITESPACE"," ",112],"-",["T_WHITESPACE"," ",112],["T_LNUMBER","1",112],",",["T_WHITESPACE"," ",112],["T_VARIABLE","$current",112],")",";",["T_WHITESPACE","\n            ",112],["T_VARIABLE","$this",113],["T_OBJECT_OPERATOR","->",113],["T_STRING","addRateLimitHeaders",113],"(",["T_VARIABLE","$response",113],",",["T_WHITESPACE"," ",113],["T_VARIABLE","$limit",113],",",["T_WHITESPACE"," ",113],["T_VARIABLE","$allowance",113],["T_WHITESPACE"," ",113],"-",["T_WHITESPACE"," ",113],["T_LNUMBER","1",113],",",["T_WHITESPACE"," ",113],["T_INT_CAST","(int)",113],["T_WHITESPACE"," ",113],"(","(",["T_VARIABLE","$limit",113],["T_WHITESPACE"," ",113],"-",["T_WHITESPACE"," ",113],["T_VARIABLE","$allowance",113],")",["T_WHITESPACE"," ",113],"*",["T_WHITESPACE"," ",113],["T_VARIABLE","$window",113],["T_WHITESPACE"," ",113],"\/",["T_WHITESPACE"," ",113],["T_VARIABLE","$limit",113],")",")",";",["T_WHITESPACE","\n        ",113],"}",["T_WHITESPACE","\n    ",114],"}",["T_WHITESPACE","\n\n    ",115],["T_DOC_COMMENT","\/**\n     * Adds the rate limit headers to the response\n     * @param Response $response\n     * @param int $limit the maximum number of allowed requests during a period\n     * @param int $remaining the remaining number of allowed requests within the current period\n     * @param int $reset the number of seconds to wait before having maximum number of allowed requests again\n     *\/",117],["T_WHITESPACE","\n    ",123],["T_PUBLIC","public",124],["T_WHITESPACE"," ",124],["T_FUNCTION","function",124],["T_WHITESPACE"," ",124],["T_STRING","addRateLimitHeaders",124],"(",["T_VARIABLE","$response",124],",",["T_WHITESPACE"," ",124],["T_VARIABLE","$limit",124],",",["T_WHITESPACE"," ",124],["T_VARIABLE","$remaining",124],",",["T_WHITESPACE"," ",124],["T_VARIABLE","$reset",124],")",["T_WHITESPACE","\n    ",124],"{",["T_WHITESPACE","\n        ",125],["T_IF","if",126],["T_WHITESPACE"," ",126],"(",["T_VARIABLE","$this",126],["T_OBJECT_OPERATOR","->",126],["T_STRING","enableRateLimitHeaders",126],")",["T_WHITESPACE"," ",126],"{",["T_WHITESPACE","\n            ",126],["T_VARIABLE","$response",127],["T_OBJECT_OPERATOR","->",127],["T_STRING","getHeaders",127],"(",")",["T_WHITESPACE","\n                ",127],["T_OBJECT_OPERATOR","->",128],["T_STRING","set",128],"(",["T_CONSTANT_ENCAPSED_STRING","'X-Rate-Limit-Limit'",128],",",["T_WHITESPACE"," ",128],["T_VARIABLE","$limit",128],")",["T_WHITESPACE","\n                ",128],["T_OBJECT_OPERATOR","->",129],["T_STRING","set",129],"(",["T_CONSTANT_ENCAPSED_STRING","'X-Rate-Limit-Remaining'",129],",",["T_WHITESPACE"," ",129],["T_VARIABLE","$remaining",129],")",["T_WHITESPACE","\n                ",129],["T_OBJECT_OPERATOR","->",130],["T_STRING","set",130],"(",["T_CONSTANT_ENCAPSED_STRING","'X-Rate-Limit-Reset'",130],",",["T_WHITESPACE"," ",130],["T_VARIABLE","$reset",130],")",";",["T_WHITESPACE","\n        ",130],"}",["T_WHITESPACE","\n    ",131],"}",["T_WHITESPACE","\n",132],"}",["T_WHITESPACE","\n",133]]