[["T_OPEN_TAG","<?php\n",1],["T_DOC_COMMENT","\/**\n * Copyright \u00c2\u00a9 2013-2017 Magento, Inc. All rights reserved.\n * See COPYING.txt for license details.\n *\/",2],["T_WHITESPACE","\n",5],["T_NAMESPACE","namespace",6],["T_WHITESPACE"," ",6],["T_STRING","Magento",6],["T_NS_SEPARATOR","\\",6],["T_STRING","Quote",6],["T_NS_SEPARATOR","\\",6],["T_STRING","Observer",6],["T_NS_SEPARATOR","\\",6],["T_STRING","Frontend",6],["T_NS_SEPARATOR","\\",6],["T_STRING","Quote",6],["T_NS_SEPARATOR","\\",6],["T_STRING","Address",6],";",["T_WHITESPACE","\n\n",6],["T_CLASS","class",8],["T_WHITESPACE"," ",8],["T_STRING","VatValidator",8],["T_WHITESPACE","\n",8],"{",["T_WHITESPACE","\n    ",9],["T_DOC_COMMENT","\/**\n     * Customer address\n     *\n     * @var \\Magento\\Customer\\Helper\\Address\n     *\/",10],["T_WHITESPACE","\n    ",14],["T_PROTECTED","protected",15],["T_WHITESPACE"," ",15],["T_VARIABLE","$customerAddress",15],";",["T_WHITESPACE","\n\n    ",15],["T_DOC_COMMENT","\/**\n     * Customer VAT\n     *\n     * @var \\Magento\\Customer\\Model\\Vat\n     *\/",17],["T_WHITESPACE","\n    ",21],["T_PROTECTED","protected",22],["T_WHITESPACE"," ",22],["T_VARIABLE","$customerVat",22],";",["T_WHITESPACE","\n\n    ",22],["T_DOC_COMMENT","\/**\n     * @param \\Magento\\Customer\\Helper\\Address $customerAddress\n     * @param \\Magento\\Customer\\Model\\Vat $customerVat\n     *\/",24],["T_WHITESPACE","\n    ",27],["T_PUBLIC","public",28],["T_WHITESPACE"," ",28],["T_FUNCTION","function",28],["T_WHITESPACE"," ",28],["T_STRING","__construct",28],"(",["T_WHITESPACE","\n        ",28],["T_NS_SEPARATOR","\\",29],["T_STRING","Magento",29],["T_NS_SEPARATOR","\\",29],["T_STRING","Customer",29],["T_NS_SEPARATOR","\\",29],["T_STRING","Helper",29],["T_NS_SEPARATOR","\\",29],["T_STRING","Address",29],["T_WHITESPACE"," ",29],["T_VARIABLE","$customerAddress",29],",",["T_WHITESPACE","\n        ",29],["T_NS_SEPARATOR","\\",30],["T_STRING","Magento",30],["T_NS_SEPARATOR","\\",30],["T_STRING","Customer",30],["T_NS_SEPARATOR","\\",30],["T_STRING","Model",30],["T_NS_SEPARATOR","\\",30],["T_STRING","Vat",30],["T_WHITESPACE"," ",30],["T_VARIABLE","$customerVat",30],["T_WHITESPACE","\n    ",30],")",["T_WHITESPACE"," ",31],"{",["T_WHITESPACE","\n        ",31],["T_VARIABLE","$this",32],["T_OBJECT_OPERATOR","->",32],["T_STRING","customerVat",32],["T_WHITESPACE"," ",32],"=",["T_WHITESPACE"," ",32],["T_VARIABLE","$customerVat",32],";",["T_WHITESPACE","\n        ",32],["T_VARIABLE","$this",33],["T_OBJECT_OPERATOR","->",33],["T_STRING","customerAddress",33],["T_WHITESPACE"," ",33],"=",["T_WHITESPACE"," ",33],["T_VARIABLE","$customerAddress",33],";",["T_WHITESPACE","\n    ",33],"}",["T_WHITESPACE","\n\n    ",34],["T_DOC_COMMENT","\/**\n     * Validate VAT number\n     *\n     * @param \\Magento\\Quote\\Model\\Quote\\Address $quoteAddress\n     * @param \\Magento\\Store\\Model\\Store|int $store\n     * @return \\Magento\\Framework\\DataObject\n     *\/",36],["T_WHITESPACE","\n    ",42],["T_PUBLIC","public",43],["T_WHITESPACE"," ",43],["T_FUNCTION","function",43],["T_WHITESPACE"," ",43],["T_STRING","validate",43],"(",["T_NS_SEPARATOR","\\",43],["T_STRING","Magento",43],["T_NS_SEPARATOR","\\",43],["T_STRING","Quote",43],["T_NS_SEPARATOR","\\",43],["T_STRING","Model",43],["T_NS_SEPARATOR","\\",43],["T_STRING","Quote",43],["T_NS_SEPARATOR","\\",43],["T_STRING","Address",43],["T_WHITESPACE"," ",43],["T_VARIABLE","$quoteAddress",43],",",["T_WHITESPACE"," ",43],["T_VARIABLE","$store",43],")",["T_WHITESPACE","\n    ",43],"{",["T_WHITESPACE","\n        ",44],["T_VARIABLE","$customerCountryCode",45],["T_WHITESPACE"," ",45],"=",["T_WHITESPACE"," ",45],["T_VARIABLE","$quoteAddress",45],["T_OBJECT_OPERATOR","->",45],["T_STRING","getCountryId",45],"(",")",";",["T_WHITESPACE","\n        ",45],["T_VARIABLE","$customerVatNumber",46],["T_WHITESPACE"," ",46],"=",["T_WHITESPACE"," ",46],["T_VARIABLE","$quoteAddress",46],["T_OBJECT_OPERATOR","->",46],["T_STRING","getVatId",46],"(",")",";",["T_WHITESPACE","\n\n        ",46],["T_VARIABLE","$merchantCountryCode",48],["T_WHITESPACE"," ",48],"=",["T_WHITESPACE"," ",48],["T_VARIABLE","$this",48],["T_OBJECT_OPERATOR","->",48],["T_STRING","customerVat",48],["T_OBJECT_OPERATOR","->",48],["T_STRING","getMerchantCountryCode",48],"(",")",";",["T_WHITESPACE","\n        ",48],["T_VARIABLE","$merchantVatNumber",49],["T_WHITESPACE"," ",49],"=",["T_WHITESPACE"," ",49],["T_VARIABLE","$this",49],["T_OBJECT_OPERATOR","->",49],["T_STRING","customerVat",49],["T_OBJECT_OPERATOR","->",49],["T_STRING","getMerchantVatNumber",49],"(",")",";",["T_WHITESPACE","\n\n        ",49],["T_VARIABLE","$validationResult",51],["T_WHITESPACE"," ",51],"=",["T_WHITESPACE"," ",51],["T_STRING","null",51],";",["T_WHITESPACE","\n        ",51],["T_IF","if",52],["T_WHITESPACE"," ",52],"(",["T_VARIABLE","$this",52],["T_OBJECT_OPERATOR","->",52],["T_STRING","customerAddress",52],["T_OBJECT_OPERATOR","->",52],["T_STRING","hasValidateOnEachTransaction",52],"(",["T_WHITESPACE","\n            ",52],["T_VARIABLE","$store",53],["T_WHITESPACE","\n        ",53],")",["T_WHITESPACE"," ",54],["T_BOOLEAN_OR","||",54],["T_WHITESPACE","\n            ",54],["T_VARIABLE","$customerCountryCode",55],["T_WHITESPACE"," ",55],["T_IS_NOT_EQUAL","!=",55],["T_WHITESPACE"," ",55],["T_VARIABLE","$quoteAddress",55],["T_OBJECT_OPERATOR","->",55],["T_STRING","getValidatedCountryCode",55],"(",")",["T_WHITESPACE"," ",55],["T_BOOLEAN_OR","||",55],["T_WHITESPACE","\n            ",55],["T_VARIABLE","$customerVatNumber",56],["T_WHITESPACE"," ",56],["T_IS_NOT_EQUAL","!=",56],["T_WHITESPACE"," ",56],["T_VARIABLE","$quoteAddress",56],["T_OBJECT_OPERATOR","->",56],["T_STRING","getValidatedVatNumber",56],"(",")",["T_WHITESPACE","\n        ",56],")",["T_WHITESPACE"," ",57],"{",["T_WHITESPACE","\n            ",57],["T_COMMENT","\/\/ Send request to gateway\n",58],["T_WHITESPACE","            ",59],["T_VARIABLE","$validationResult",59],["T_WHITESPACE"," ",59],"=",["T_WHITESPACE"," ",59],["T_VARIABLE","$this",59],["T_OBJECT_OPERATOR","->",59],["T_STRING","customerVat",59],["T_OBJECT_OPERATOR","->",59],["T_STRING","checkVatNumber",59],"(",["T_WHITESPACE","\n                ",59],["T_VARIABLE","$customerCountryCode",60],",",["T_WHITESPACE","\n                ",60],["T_VARIABLE","$customerVatNumber",61],",",["T_WHITESPACE","\n                ",61],["T_VARIABLE","$merchantVatNumber",62],["T_WHITESPACE"," ",62],["T_IS_NOT_IDENTICAL","!==",62],["T_WHITESPACE"," ",62],["T_CONSTANT_ENCAPSED_STRING","''",62],["T_WHITESPACE"," ",62],"?",["T_WHITESPACE"," ",62],["T_VARIABLE","$merchantCountryCode",62],["T_WHITESPACE"," ",62],":",["T_WHITESPACE"," ",62],["T_CONSTANT_ENCAPSED_STRING","''",62],",",["T_WHITESPACE","\n                ",62],["T_VARIABLE","$merchantVatNumber",63],["T_WHITESPACE","\n            ",63],")",";",["T_WHITESPACE","\n\n            ",64],["T_COMMENT","\/\/ Store validation results in corresponding quote address\n",66],["T_WHITESPACE","            ",67],["T_VARIABLE","$quoteAddress",67],["T_OBJECT_OPERATOR","->",67],["T_STRING","setVatIsValid",67],"(",["T_INT_CAST","(int)",67],["T_VARIABLE","$validationResult",67],["T_OBJECT_OPERATOR","->",67],["T_STRING","getIsValid",67],"(",")",")",";",["T_WHITESPACE","\n            ",67],["T_VARIABLE","$quoteAddress",68],["T_OBJECT_OPERATOR","->",68],["T_STRING","setVatRequestId",68],"(",["T_VARIABLE","$validationResult",68],["T_OBJECT_OPERATOR","->",68],["T_STRING","getRequestIdentifier",68],"(",")",")",";",["T_WHITESPACE","\n            ",68],["T_VARIABLE","$quoteAddress",69],["T_OBJECT_OPERATOR","->",69],["T_STRING","setVatRequestDate",69],"(",["T_VARIABLE","$validationResult",69],["T_OBJECT_OPERATOR","->",69],["T_STRING","getRequestDate",69],"(",")",")",";",["T_WHITESPACE","\n            ",69],["T_VARIABLE","$quoteAddress",70],["T_OBJECT_OPERATOR","->",70],["T_STRING","setVatRequestSuccess",70],"(",["T_VARIABLE","$validationResult",70],["T_OBJECT_OPERATOR","->",70],["T_STRING","getRequestSuccess",70],"(",")",")",";",["T_WHITESPACE","\n            ",70],["T_VARIABLE","$quoteAddress",71],["T_OBJECT_OPERATOR","->",71],["T_STRING","setValidatedVatNumber",71],"(",["T_VARIABLE","$customerVatNumber",71],")",";",["T_WHITESPACE","\n            ",71],["T_VARIABLE","$quoteAddress",72],["T_OBJECT_OPERATOR","->",72],["T_STRING","setValidatedCountryCode",72],"(",["T_VARIABLE","$customerCountryCode",72],")",";",["T_WHITESPACE","\n            ",72],["T_VARIABLE","$quoteAddress",73],["T_OBJECT_OPERATOR","->",73],["T_STRING","save",73],"(",")",";",["T_WHITESPACE","\n        ",73],"}",["T_WHITESPACE"," ",74],["T_ELSE","else",74],["T_WHITESPACE"," ",74],"{",["T_WHITESPACE","\n            ",74],["T_COMMENT","\/\/ Restore validation results from corresponding quote address\n",75],["T_WHITESPACE","            ",76],["T_VARIABLE","$validationResult",76],["T_WHITESPACE"," ",76],"=",["T_WHITESPACE"," ",76],["T_NEW","new",76],["T_WHITESPACE"," ",76],["T_NS_SEPARATOR","\\",76],["T_STRING","Magento",76],["T_NS_SEPARATOR","\\",76],["T_STRING","Framework",76],["T_NS_SEPARATOR","\\",76],["T_STRING","DataObject",76],"(",["T_WHITESPACE","\n                ",76],"[",["T_WHITESPACE","\n                    ",77],["T_CONSTANT_ENCAPSED_STRING","'is_valid'",78],["T_WHITESPACE"," ",78],["T_DOUBLE_ARROW","=>",78],["T_WHITESPACE"," ",78],["T_INT_CAST","(int)",78],["T_VARIABLE","$quoteAddress",78],["T_OBJECT_OPERATOR","->",78],["T_STRING","getVatIsValid",78],"(",")",",",["T_WHITESPACE","\n                    ",78],["T_CONSTANT_ENCAPSED_STRING","'request_identifier'",79],["T_WHITESPACE"," ",79],["T_DOUBLE_ARROW","=>",79],["T_WHITESPACE"," ",79],["T_STRING_CAST","(string)",79],["T_VARIABLE","$quoteAddress",79],["T_OBJECT_OPERATOR","->",79],["T_STRING","getVatRequestId",79],"(",")",",",["T_WHITESPACE","\n                    ",79],["T_CONSTANT_ENCAPSED_STRING","'request_date'",80],["T_WHITESPACE"," ",80],["T_DOUBLE_ARROW","=>",80],["T_WHITESPACE"," ",80],["T_STRING_CAST","(string)",80],["T_VARIABLE","$quoteAddress",80],["T_OBJECT_OPERATOR","->",80],["T_STRING","getVatRequestDate",80],"(",")",",",["T_WHITESPACE","\n                    ",80],["T_CONSTANT_ENCAPSED_STRING","'request_success'",81],["T_WHITESPACE"," ",81],["T_DOUBLE_ARROW","=>",81],["T_WHITESPACE"," ",81],["T_BOOL_CAST","(bool)",81],["T_VARIABLE","$quoteAddress",81],["T_OBJECT_OPERATOR","->",81],["T_STRING","getVatRequestSuccess",81],"(",")",",",["T_WHITESPACE","\n                ",81],"]",["T_WHITESPACE","\n            ",82],")",";",["T_WHITESPACE","\n        ",83],"}",["T_WHITESPACE","\n\n        ",84],["T_RETURN","return",86],["T_WHITESPACE"," ",86],["T_VARIABLE","$validationResult",86],";",["T_WHITESPACE","\n    ",86],"}",["T_WHITESPACE","\n\n    ",87],["T_DOC_COMMENT","\/**\n     * Check whether VAT ID validation is enabled\n     *\n     * @param \\Magento\\Quote\\Model\\Quote\\Address $quoteAddress\n     * @param \\Magento\\Store\\Model\\Store|int $store\n     * @return bool\n     *\/",89],["T_WHITESPACE","\n    ",95],["T_PUBLIC","public",96],["T_WHITESPACE"," ",96],["T_FUNCTION","function",96],["T_WHITESPACE"," ",96],["T_STRING","isEnabled",96],"(",["T_NS_SEPARATOR","\\",96],["T_STRING","Magento",96],["T_NS_SEPARATOR","\\",96],["T_STRING","Quote",96],["T_NS_SEPARATOR","\\",96],["T_STRING","Model",96],["T_NS_SEPARATOR","\\",96],["T_STRING","Quote",96],["T_NS_SEPARATOR","\\",96],["T_STRING","Address",96],["T_WHITESPACE"," ",96],["T_VARIABLE","$quoteAddress",96],",",["T_WHITESPACE"," ",96],["T_VARIABLE","$store",96],")",["T_WHITESPACE","\n    ",96],"{",["T_WHITESPACE","\n        ",97],["T_VARIABLE","$configAddressType",98],["T_WHITESPACE"," ",98],"=",["T_WHITESPACE"," ",98],["T_VARIABLE","$this",98],["T_OBJECT_OPERATOR","->",98],["T_STRING","customerAddress",98],["T_OBJECT_OPERATOR","->",98],["T_STRING","getTaxCalculationAddressType",98],"(",["T_VARIABLE","$store",98],")",";",["T_WHITESPACE","\n\n        ",98],["T_COMMENT","\/\/ When VAT is based on billing address then Magento have to handle only billing addresses\n",100],["T_WHITESPACE","        ",101],["T_VARIABLE","$additionalBillingAddressCondition",101],["T_WHITESPACE"," ",101],"=",["T_WHITESPACE"," ",101],["T_VARIABLE","$configAddressType",101],["T_WHITESPACE"," ",101],["T_IS_EQUAL","==",101],["T_WHITESPACE","\n            ",101],["T_NS_SEPARATOR","\\",102],["T_STRING","Magento",102],["T_NS_SEPARATOR","\\",102],["T_STRING","Customer",102],["T_NS_SEPARATOR","\\",102],["T_STRING","Model",102],["T_NS_SEPARATOR","\\",102],["T_STRING","Address",102],["T_NS_SEPARATOR","\\",102],["T_STRING","AbstractAddress",102],["T_DOUBLE_COLON","::",102],["T_STRING","TYPE_BILLING",102],["T_WHITESPACE"," ",102],"?",["T_WHITESPACE"," ",102],["T_VARIABLE","$configAddressType",102],["T_WHITESPACE"," ",102],["T_IS_NOT_EQUAL","!=",102],["T_WHITESPACE","\n            ",102],["T_VARIABLE","$quoteAddress",103],["T_OBJECT_OPERATOR","->",103],["T_STRING","getAddressType",103],"(",")",["T_WHITESPACE"," ",103],":",["T_WHITESPACE"," ",103],["T_STRING","false",103],";",["T_WHITESPACE","\n\n        ",103],["T_COMMENT","\/\/ Handle only addresses that corresponds to VAT configuration\n",105],["T_WHITESPACE","        ",106],["T_IF","if",106],["T_WHITESPACE"," ",106],"(","!",["T_VARIABLE","$this",106],["T_OBJECT_OPERATOR","->",106],["T_STRING","customerAddress",106],["T_OBJECT_OPERATOR","->",106],["T_STRING","isVatValidationEnabled",106],"(",["T_VARIABLE","$store",106],")",["T_WHITESPACE"," ",106],["T_BOOLEAN_OR","||",106],["T_WHITESPACE"," ",106],["T_VARIABLE","$additionalBillingAddressCondition",106],")",["T_WHITESPACE"," ",106],"{",["T_WHITESPACE","\n            ",106],["T_RETURN","return",107],["T_WHITESPACE"," ",107],["T_STRING","false",107],";",["T_WHITESPACE","\n        ",107],"}",["T_WHITESPACE","\n\n        ",108],["T_RETURN","return",110],["T_WHITESPACE"," ",110],["T_STRING","true",110],";",["T_WHITESPACE","\n    ",110],"}",["T_WHITESPACE","\n",111],"}",["T_WHITESPACE","\n",112]]