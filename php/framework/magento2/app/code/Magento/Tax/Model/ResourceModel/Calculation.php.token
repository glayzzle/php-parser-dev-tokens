[["T_OPEN_TAG","<?php\n",1],["T_DOC_COMMENT","\/**\n * Copyright \u00c2\u00a9 2013-2017 Magento, Inc. All rights reserved.\n * See COPYING.txt for license details.\n *\/",2],["T_WHITESPACE","\n\n\n",5],["T_DOC_COMMENT","\/**\n * Tax Calculation Resource Model\n *\/",8],["T_WHITESPACE","\n",10],["T_NAMESPACE","namespace",11],["T_WHITESPACE"," ",11],["T_STRING","Magento",11],["T_NS_SEPARATOR","\\",11],["T_STRING","Tax",11],["T_NS_SEPARATOR","\\",11],["T_STRING","Model",11],["T_NS_SEPARATOR","\\",11],["T_STRING","ResourceModel",11],";",["T_WHITESPACE","\n\n",11],["T_CLASS","class",13],["T_WHITESPACE"," ",13],["T_STRING","Calculation",13],["T_WHITESPACE"," ",13],["T_EXTENDS","extends",13],["T_WHITESPACE"," ",13],["T_NS_SEPARATOR","\\",13],["T_STRING","Magento",13],["T_NS_SEPARATOR","\\",13],["T_STRING","Framework",13],["T_NS_SEPARATOR","\\",13],["T_STRING","Model",13],["T_NS_SEPARATOR","\\",13],["T_STRING","ResourceModel",13],["T_NS_SEPARATOR","\\",13],["T_STRING","Db",13],["T_NS_SEPARATOR","\\",13],["T_STRING","AbstractDb",13],["T_WHITESPACE","\n",13],"{",["T_WHITESPACE","\n    ",14],["T_DOC_COMMENT","\/**\n     * Store ISO 3166-1 alpha-2 USA country code\n     *\/",15],["T_WHITESPACE","\n    ",17],["T_CONST","const",18],["T_WHITESPACE"," ",18],["T_STRING","USA_COUNTRY_CODE",18],["T_WHITESPACE"," ",18],"=",["T_WHITESPACE"," ",18],["T_CONSTANT_ENCAPSED_STRING","'US'",18],";",["T_WHITESPACE","\n\n    ",18],["T_DOC_COMMENT","\/**\n     * Rates cache\n     *\n     * @var array\n     *\/",20],["T_WHITESPACE","\n    ",24],["T_PROTECTED","protected",25],["T_WHITESPACE"," ",25],["T_VARIABLE","$_ratesCache",25],["T_WHITESPACE"," ",25],"=",["T_WHITESPACE"," ",25],"[","]",";",["T_WHITESPACE","\n\n    ",25],["T_DOC_COMMENT","\/**\n     * Tax data\n     *\n     * @var \\Magento\\Tax\\Helper\\Data\n     *\/",27],["T_WHITESPACE","\n    ",31],["T_PROTECTED","protected",32],["T_WHITESPACE"," ",32],["T_VARIABLE","$_taxData",32],";",["T_WHITESPACE","\n\n    ",32],["T_DOC_COMMENT","\/**\n     * @var \\Magento\\Store\\Model\\StoreManagerInterface\n     *\/",34],["T_WHITESPACE","\n    ",36],["T_PROTECTED","protected",37],["T_WHITESPACE"," ",37],["T_VARIABLE","$_storeManager",37],";",["T_WHITESPACE","\n\n    ",37],["T_DOC_COMMENT","\/**\n     * @param \\Magento\\Framework\\Model\\ResourceModel\\Db\\Context $context\n     * @param \\Magento\\Tax\\Helper\\Data $taxData\n     * @param \\Magento\\Store\\Model\\StoreManagerInterface $storeManager\n     * @param string $connectionName\n     *\/",39],["T_WHITESPACE","\n    ",44],["T_PUBLIC","public",45],["T_WHITESPACE"," ",45],["T_FUNCTION","function",45],["T_WHITESPACE"," ",45],["T_STRING","__construct",45],"(",["T_WHITESPACE","\n        ",45],["T_NS_SEPARATOR","\\",46],["T_STRING","Magento",46],["T_NS_SEPARATOR","\\",46],["T_STRING","Framework",46],["T_NS_SEPARATOR","\\",46],["T_STRING","Model",46],["T_NS_SEPARATOR","\\",46],["T_STRING","ResourceModel",46],["T_NS_SEPARATOR","\\",46],["T_STRING","Db",46],["T_NS_SEPARATOR","\\",46],["T_STRING","Context",46],["T_WHITESPACE"," ",46],["T_VARIABLE","$context",46],",",["T_WHITESPACE","\n        ",46],["T_NS_SEPARATOR","\\",47],["T_STRING","Magento",47],["T_NS_SEPARATOR","\\",47],["T_STRING","Tax",47],["T_NS_SEPARATOR","\\",47],["T_STRING","Helper",47],["T_NS_SEPARATOR","\\",47],["T_STRING","Data",47],["T_WHITESPACE"," ",47],["T_VARIABLE","$taxData",47],",",["T_WHITESPACE","\n        ",47],["T_NS_SEPARATOR","\\",48],["T_STRING","Magento",48],["T_NS_SEPARATOR","\\",48],["T_STRING","Store",48],["T_NS_SEPARATOR","\\",48],["T_STRING","Model",48],["T_NS_SEPARATOR","\\",48],["T_STRING","StoreManagerInterface",48],["T_WHITESPACE"," ",48],["T_VARIABLE","$storeManager",48],",",["T_WHITESPACE","\n        ",48],["T_VARIABLE","$connectionName",49],["T_WHITESPACE"," ",49],"=",["T_WHITESPACE"," ",49],["T_STRING","null",49],["T_WHITESPACE","\n    ",49],")",["T_WHITESPACE"," ",50],"{",["T_WHITESPACE","\n        ",50],["T_VARIABLE","$this",51],["T_OBJECT_OPERATOR","->",51],["T_STRING","_taxData",51],["T_WHITESPACE"," ",51],"=",["T_WHITESPACE"," ",51],["T_VARIABLE","$taxData",51],";",["T_WHITESPACE","\n        ",51],["T_VARIABLE","$this",52],["T_OBJECT_OPERATOR","->",52],["T_STRING","_storeManager",52],["T_WHITESPACE"," ",52],"=",["T_WHITESPACE"," ",52],["T_VARIABLE","$storeManager",52],";",["T_WHITESPACE","\n        ",52],["T_STRING","parent",53],["T_DOUBLE_COLON","::",53],["T_STRING","__construct",53],"(",["T_VARIABLE","$context",53],",",["T_WHITESPACE"," ",53],["T_VARIABLE","$connectionName",53],")",";",["T_WHITESPACE","\n    ",53],"}",["T_WHITESPACE","\n\n    ",54],["T_DOC_COMMENT","\/**\n     * Resource initialization\n     *\n     * @return void\n     *\/",56],["T_WHITESPACE","\n    ",60],["T_PROTECTED","protected",61],["T_WHITESPACE"," ",61],["T_FUNCTION","function",61],["T_WHITESPACE"," ",61],["T_STRING","_construct",61],"(",")",["T_WHITESPACE","\n    ",61],"{",["T_WHITESPACE","\n        ",62],["T_VARIABLE","$this",63],["T_OBJECT_OPERATOR","->",63],["T_STRING","_setMainTable",63],"(",["T_CONSTANT_ENCAPSED_STRING","'tax_calculation'",63],")",";",["T_WHITESPACE","\n    ",63],"}",["T_WHITESPACE","\n\n    ",64],["T_DOC_COMMENT","\/**\n     * Delete calculation settings by rule id\n     *\n     * @param int $ruleId\n     * @return $this\n     *\/",66],["T_WHITESPACE","\n    ",71],["T_PUBLIC","public",72],["T_WHITESPACE"," ",72],["T_FUNCTION","function",72],["T_WHITESPACE"," ",72],["T_STRING","deleteByRuleId",72],"(",["T_VARIABLE","$ruleId",72],")",["T_WHITESPACE","\n    ",72],"{",["T_WHITESPACE","\n        ",73],["T_VARIABLE","$conn",74],["T_WHITESPACE"," ",74],"=",["T_WHITESPACE"," ",74],["T_VARIABLE","$this",74],["T_OBJECT_OPERATOR","->",74],["T_STRING","getConnection",74],"(",")",";",["T_WHITESPACE","\n        ",74],["T_VARIABLE","$where",75],["T_WHITESPACE"," ",75],"=",["T_WHITESPACE"," ",75],["T_VARIABLE","$conn",75],["T_OBJECT_OPERATOR","->",75],["T_STRING","quoteInto",75],"(",["T_CONSTANT_ENCAPSED_STRING","'tax_calculation_rule_id = ?'",75],",",["T_WHITESPACE"," ",75],["T_INT_CAST","(int)",75],["T_VARIABLE","$ruleId",75],")",";",["T_WHITESPACE","\n        ",75],["T_VARIABLE","$conn",76],["T_OBJECT_OPERATOR","->",76],["T_STRING","delete",76],"(",["T_VARIABLE","$this",76],["T_OBJECT_OPERATOR","->",76],["T_STRING","getMainTable",76],"(",")",",",["T_WHITESPACE"," ",76],["T_VARIABLE","$where",76],")",";",["T_WHITESPACE","\n\n        ",76],["T_RETURN","return",78],["T_WHITESPACE"," ",78],["T_VARIABLE","$this",78],";",["T_WHITESPACE","\n    ",78],"}",["T_WHITESPACE","\n\n    ",79],["T_DOC_COMMENT","\/**\n     * Retrieve distinct calculation\n     *\n     * @param  string $field\n     * @param  int $ruleId\n     * @return array\n     *\/",81],["T_WHITESPACE","\n    ",87],["T_PUBLIC","public",88],["T_WHITESPACE"," ",88],["T_FUNCTION","function",88],["T_WHITESPACE"," ",88],["T_STRING","getCalculationsById",88],"(",["T_VARIABLE","$field",88],",",["T_WHITESPACE"," ",88],["T_VARIABLE","$ruleId",88],")",["T_WHITESPACE","\n    ",88],"{",["T_WHITESPACE","\n        ",89],["T_VARIABLE","$select",90],["T_WHITESPACE"," ",90],"=",["T_WHITESPACE"," ",90],["T_VARIABLE","$this",90],["T_OBJECT_OPERATOR","->",90],["T_STRING","getConnection",90],"(",")",["T_OBJECT_OPERATOR","->",90],["T_STRING","select",90],"(",")",";",["T_WHITESPACE","\n        ",90],["T_VARIABLE","$select",91],["T_OBJECT_OPERATOR","->",91],["T_STRING","from",91],"(",["T_VARIABLE","$this",91],["T_OBJECT_OPERATOR","->",91],["T_STRING","getMainTable",91],"(",")",",",["T_WHITESPACE"," ",91],["T_VARIABLE","$field",91],")",["T_OBJECT_OPERATOR","->",91],["T_STRING","where",91],"(",["T_CONSTANT_ENCAPSED_STRING","'tax_calculation_rule_id = ?'",91],",",["T_WHITESPACE"," ",91],["T_INT_CAST","(int)",91],["T_VARIABLE","$ruleId",91],")",";",["T_WHITESPACE","\n\n        ",91],["T_RETURN","return",93],["T_WHITESPACE"," ",93],["T_VARIABLE","$this",93],["T_OBJECT_OPERATOR","->",93],["T_STRING","getConnection",93],"(",")",["T_OBJECT_OPERATOR","->",93],["T_STRING","fetchCol",93],"(",["T_VARIABLE","$select",93],")",";",["T_WHITESPACE","\n    ",93],"}",["T_WHITESPACE","\n\n    ",94],["T_DOC_COMMENT","\/**\n     * Get tax rate information: calculation process data and tax rate\n     *\n     * @param \\Magento\\Framework\\DataObject $request\n     * @return array\n     *\/",96],["T_WHITESPACE","\n    ",101],["T_PUBLIC","public",102],["T_WHITESPACE"," ",102],["T_FUNCTION","function",102],["T_WHITESPACE"," ",102],["T_STRING","getRateInfo",102],"(",["T_VARIABLE","$request",102],")",["T_WHITESPACE","\n    ",102],"{",["T_WHITESPACE","\n        ",103],["T_VARIABLE","$rates",104],["T_WHITESPACE"," ",104],"=",["T_WHITESPACE"," ",104],["T_VARIABLE","$this",104],["T_OBJECT_OPERATOR","->",104],["T_STRING","_getRates",104],"(",["T_VARIABLE","$request",104],")",";",["T_WHITESPACE","\n        ",104],["T_RETURN","return",105],["T_WHITESPACE"," ",105],"[",["T_WHITESPACE","\n            ",105],["T_CONSTANT_ENCAPSED_STRING","'process'",106],["T_WHITESPACE"," ",106],["T_DOUBLE_ARROW","=>",106],["T_WHITESPACE"," ",106],["T_VARIABLE","$this",106],["T_OBJECT_OPERATOR","->",106],["T_STRING","getCalculationProcess",106],"(",["T_VARIABLE","$request",106],",",["T_WHITESPACE"," ",106],["T_VARIABLE","$rates",106],")",",",["T_WHITESPACE","\n            ",106],["T_CONSTANT_ENCAPSED_STRING","'value'",107],["T_WHITESPACE"," ",107],["T_DOUBLE_ARROW","=>",107],["T_WHITESPACE"," ",107],["T_VARIABLE","$this",107],["T_OBJECT_OPERATOR","->",107],["T_STRING","_calculateRate",107],"(",["T_VARIABLE","$rates",107],")",["T_WHITESPACE","\n        ",107],"]",";",["T_WHITESPACE","\n    ",108],"}",["T_WHITESPACE","\n\n    ",109],["T_DOC_COMMENT","\/**\n     * Get tax rate for specific tax rate request\n     *\n     * @param \\Magento\\Framework\\DataObject $request\n     * @return int\n     *\/",111],["T_WHITESPACE","\n    ",116],["T_PUBLIC","public",117],["T_WHITESPACE"," ",117],["T_FUNCTION","function",117],["T_WHITESPACE"," ",117],["T_STRING","getRate",117],"(",["T_VARIABLE","$request",117],")",["T_WHITESPACE","\n    ",117],"{",["T_WHITESPACE","\n        ",118],["T_RETURN","return",119],["T_WHITESPACE"," ",119],["T_VARIABLE","$this",119],["T_OBJECT_OPERATOR","->",119],["T_STRING","_calculateRate",119],"(",["T_VARIABLE","$this",119],["T_OBJECT_OPERATOR","->",119],["T_STRING","_getRates",119],"(",["T_VARIABLE","$request",119],")",")",";",["T_WHITESPACE","\n    ",119],"}",["T_WHITESPACE","\n\n    ",120],["T_DOC_COMMENT","\/**\n     * Retrieve Calculation Process\n     *\n     * @param \\Magento\\Framework\\DataObject $request\n     * @param array|null $rates\n     * @return array\n     * @SuppressWarnings(PHPMD.CyclomaticComplexity)\n     * @SuppressWarnings(PHPMD.NPathComplexity)\n     *\/",122],["T_WHITESPACE","\n    ",130],["T_PUBLIC","public",131],["T_WHITESPACE"," ",131],["T_FUNCTION","function",131],["T_WHITESPACE"," ",131],["T_STRING","getCalculationProcess",131],"(",["T_VARIABLE","$request",131],",",["T_WHITESPACE"," ",131],["T_VARIABLE","$rates",131],["T_WHITESPACE"," ",131],"=",["T_WHITESPACE"," ",131],["T_STRING","null",131],")",["T_WHITESPACE","\n    ",131],"{",["T_WHITESPACE","\n        ",132],["T_IF","if",133],["T_WHITESPACE"," ",133],"(",["T_VARIABLE","$rates",133],["T_WHITESPACE"," ",133],["T_IS_IDENTICAL","===",133],["T_WHITESPACE"," ",133],["T_STRING","null",133],")",["T_WHITESPACE"," ",133],"{",["T_WHITESPACE","\n            ",133],["T_VARIABLE","$rates",134],["T_WHITESPACE"," ",134],"=",["T_WHITESPACE"," ",134],["T_VARIABLE","$this",134],["T_OBJECT_OPERATOR","->",134],["T_STRING","_getRates",134],"(",["T_VARIABLE","$request",134],")",";",["T_WHITESPACE","\n        ",134],"}",["T_WHITESPACE","\n\n        ",135],["T_VARIABLE","$result",137],["T_WHITESPACE"," ",137],"=",["T_WHITESPACE"," ",137],"[","]",";",["T_WHITESPACE","\n        ",137],["T_VARIABLE","$row",138],["T_WHITESPACE"," ",138],"=",["T_WHITESPACE"," ",138],"[","]",";",["T_WHITESPACE","\n        ",138],["T_VARIABLE","$ids",139],["T_WHITESPACE"," ",139],"=",["T_WHITESPACE"," ",139],"[","]",";",["T_WHITESPACE","\n        ",139],["T_VARIABLE","$currentRate",140],["T_WHITESPACE"," ",140],"=",["T_WHITESPACE"," ",140],["T_LNUMBER","0",140],";",["T_WHITESPACE","\n        ",140],["T_VARIABLE","$totalPercent",141],["T_WHITESPACE"," ",141],"=",["T_WHITESPACE"," ",141],["T_LNUMBER","0",141],";",["T_WHITESPACE","\n        ",141],["T_VARIABLE","$countedRates",142],["T_WHITESPACE"," ",142],"=",["T_WHITESPACE"," ",142],["T_STRING","count",142],"(",["T_VARIABLE","$rates",142],")",";",["T_WHITESPACE","\n        ",142],["T_FOR","for",143],["T_WHITESPACE"," ",143],"(",["T_VARIABLE","$i",143],["T_WHITESPACE"," ",143],"=",["T_WHITESPACE"," ",143],["T_LNUMBER","0",143],";",["T_WHITESPACE"," ",143],["T_VARIABLE","$i",143],["T_WHITESPACE"," ",143],"<",["T_WHITESPACE"," ",143],["T_VARIABLE","$countedRates",143],";",["T_WHITESPACE"," ",143],["T_VARIABLE","$i",143],["T_INC","++",143],")",["T_WHITESPACE"," ",143],"{",["T_WHITESPACE","\n            ",143],["T_VARIABLE","$rate",144],["T_WHITESPACE"," ",144],"=",["T_WHITESPACE"," ",144],["T_VARIABLE","$rates",144],"[",["T_VARIABLE","$i",144],"]",";",["T_WHITESPACE","\n            ",144],["T_VARIABLE","$value",145],["T_WHITESPACE"," ",145],"=",["T_WHITESPACE"," ",145],"(",["T_ISSET","isset",145],"(",["T_VARIABLE","$rate",145],"[",["T_CONSTANT_ENCAPSED_STRING","'value'",145],"]",")",["T_WHITESPACE"," ",145],"?",["T_WHITESPACE"," ",145],["T_VARIABLE","$rate",145],"[",["T_CONSTANT_ENCAPSED_STRING","'value'",145],"]",["T_WHITESPACE"," ",145],":",["T_WHITESPACE"," ",145],["T_VARIABLE","$rate",145],"[",["T_CONSTANT_ENCAPSED_STRING","'percent'",145],"]",")",["T_WHITESPACE"," ",145],"*",["T_WHITESPACE"," ",145],["T_LNUMBER","1",145],";",["T_WHITESPACE","\n\n            ",145],["T_VARIABLE","$oneRate",147],["T_WHITESPACE"," ",147],"=",["T_WHITESPACE"," ",147],"[",["T_WHITESPACE","\n                ",147],["T_CONSTANT_ENCAPSED_STRING","'code'",148],["T_WHITESPACE"," ",148],["T_DOUBLE_ARROW","=>",148],["T_WHITESPACE"," ",148],["T_VARIABLE","$rate",148],"[",["T_CONSTANT_ENCAPSED_STRING","'code'",148],"]",",",["T_WHITESPACE","\n                ",148],["T_CONSTANT_ENCAPSED_STRING","'title'",149],["T_WHITESPACE"," ",149],["T_DOUBLE_ARROW","=>",149],["T_WHITESPACE"," ",149],["T_VARIABLE","$rate",149],"[",["T_CONSTANT_ENCAPSED_STRING","'title'",149],"]",",",["T_WHITESPACE","\n                ",149],["T_CONSTANT_ENCAPSED_STRING","'percent'",150],["T_WHITESPACE"," ",150],["T_DOUBLE_ARROW","=>",150],["T_WHITESPACE"," ",150],["T_VARIABLE","$value",150],",",["T_WHITESPACE","\n                ",150],["T_CONSTANT_ENCAPSED_STRING","'position'",151],["T_WHITESPACE"," ",151],["T_DOUBLE_ARROW","=>",151],["T_WHITESPACE"," ",151],["T_VARIABLE","$rate",151],"[",["T_CONSTANT_ENCAPSED_STRING","'position'",151],"]",",",["T_WHITESPACE","\n                ",151],["T_CONSTANT_ENCAPSED_STRING","'priority'",152],["T_WHITESPACE"," ",152],["T_DOUBLE_ARROW","=>",152],["T_WHITESPACE"," ",152],["T_VARIABLE","$rate",152],"[",["T_CONSTANT_ENCAPSED_STRING","'priority'",152],"]",["T_WHITESPACE","\n            ",152],"]",";",["T_WHITESPACE","\n            ",153],["T_IF","if",154],["T_WHITESPACE"," ",154],"(",["T_ISSET","isset",154],"(",["T_VARIABLE","$rate",154],"[",["T_CONSTANT_ENCAPSED_STRING","'tax_calculation_rule_id'",154],"]",")",")",["T_WHITESPACE"," ",154],"{",["T_WHITESPACE","\n                ",154],["T_VARIABLE","$oneRate",155],"[",["T_CONSTANT_ENCAPSED_STRING","'rule_id'",155],"]",["T_WHITESPACE"," ",155],"=",["T_WHITESPACE"," ",155],["T_VARIABLE","$rate",155],"[",["T_CONSTANT_ENCAPSED_STRING","'tax_calculation_rule_id'",155],"]",";",["T_WHITESPACE","\n            ",155],"}",["T_WHITESPACE","\n\n            ",156],["T_IF","if",158],["T_WHITESPACE"," ",158],"(",["T_ISSET","isset",158],"(",["T_VARIABLE","$rate",158],"[",["T_CONSTANT_ENCAPSED_STRING","'hidden'",158],"]",")",")",["T_WHITESPACE"," ",158],"{",["T_WHITESPACE","\n                ",158],["T_VARIABLE","$row",159],"[",["T_CONSTANT_ENCAPSED_STRING","'hidden'",159],"]",["T_WHITESPACE"," ",159],"=",["T_WHITESPACE"," ",159],["T_VARIABLE","$rate",159],"[",["T_CONSTANT_ENCAPSED_STRING","'hidden'",159],"]",";",["T_WHITESPACE","\n            ",159],"}",["T_WHITESPACE","\n\n            ",160],["T_IF","if",162],["T_WHITESPACE"," ",162],"(",["T_ISSET","isset",162],"(",["T_VARIABLE","$rate",162],"[",["T_CONSTANT_ENCAPSED_STRING","'amount'",162],"]",")",")",["T_WHITESPACE"," ",162],"{",["T_WHITESPACE","\n                ",162],["T_VARIABLE","$row",163],"[",["T_CONSTANT_ENCAPSED_STRING","'amount'",163],"]",["T_WHITESPACE"," ",163],"=",["T_WHITESPACE"," ",163],["T_VARIABLE","$rate",163],"[",["T_CONSTANT_ENCAPSED_STRING","'amount'",163],"]",";",["T_WHITESPACE","\n            ",163],"}",["T_WHITESPACE","\n\n            ",164],["T_IF","if",166],["T_WHITESPACE"," ",166],"(",["T_ISSET","isset",166],"(",["T_VARIABLE","$rate",166],"[",["T_CONSTANT_ENCAPSED_STRING","'base_amount'",166],"]",")",")",["T_WHITESPACE"," ",166],"{",["T_WHITESPACE","\n                ",166],["T_VARIABLE","$row",167],"[",["T_CONSTANT_ENCAPSED_STRING","'base_amount'",167],"]",["T_WHITESPACE"," ",167],"=",["T_WHITESPACE"," ",167],["T_VARIABLE","$rate",167],"[",["T_CONSTANT_ENCAPSED_STRING","'base_amount'",167],"]",";",["T_WHITESPACE","\n            ",167],"}",["T_WHITESPACE","\n            ",168],["T_IF","if",169],["T_WHITESPACE"," ",169],"(",["T_ISSET","isset",169],"(",["T_VARIABLE","$rate",169],"[",["T_CONSTANT_ENCAPSED_STRING","'base_real_amount'",169],"]",")",")",["T_WHITESPACE"," ",169],"{",["T_WHITESPACE","\n                ",169],["T_VARIABLE","$row",170],"[",["T_CONSTANT_ENCAPSED_STRING","'base_real_amount'",170],"]",["T_WHITESPACE"," ",170],"=",["T_WHITESPACE"," ",170],["T_VARIABLE","$rate",170],"[",["T_CONSTANT_ENCAPSED_STRING","'base_real_amount'",170],"]",";",["T_WHITESPACE","\n            ",170],"}",["T_WHITESPACE","\n            ",171],["T_VARIABLE","$row",172],"[",["T_CONSTANT_ENCAPSED_STRING","'rates'",172],"]","[","]",["T_WHITESPACE"," ",172],"=",["T_WHITESPACE"," ",172],["T_VARIABLE","$oneRate",172],";",["T_WHITESPACE","\n\n            ",172],["T_VARIABLE","$ruleId",174],["T_WHITESPACE"," ",174],"=",["T_WHITESPACE"," ",174],["T_STRING","null",174],";",["T_WHITESPACE","\n            ",174],["T_IF","if",175],["T_WHITESPACE"," ",175],"(",["T_ISSET","isset",175],"(",["T_VARIABLE","$rates",175],"[",["T_VARIABLE","$i",175],["T_WHITESPACE"," ",175],"+",["T_WHITESPACE"," ",175],["T_LNUMBER","1",175],"]","[",["T_CONSTANT_ENCAPSED_STRING","'tax_calculation_rule_id'",175],"]",")",")",["T_WHITESPACE"," ",175],"{",["T_WHITESPACE","\n                ",175],["T_VARIABLE","$ruleId",176],["T_WHITESPACE"," ",176],"=",["T_WHITESPACE"," ",176],["T_VARIABLE","$rate",176],"[",["T_CONSTANT_ENCAPSED_STRING","'tax_calculation_rule_id'",176],"]",";",["T_WHITESPACE","\n            ",176],"}",["T_WHITESPACE","\n            ",177],["T_VARIABLE","$priority",178],["T_WHITESPACE"," ",178],"=",["T_WHITESPACE"," ",178],["T_VARIABLE","$rate",178],"[",["T_CONSTANT_ENCAPSED_STRING","'priority'",178],"]",";",["T_WHITESPACE","\n            ",178],["T_VARIABLE","$ids",179],"[","]",["T_WHITESPACE"," ",179],"=",["T_WHITESPACE"," ",179],["T_VARIABLE","$rate",179],"[",["T_CONSTANT_ENCAPSED_STRING","'code'",179],"]",";",["T_WHITESPACE","\n\n            ",179],["T_IF","if",181],["T_WHITESPACE"," ",181],"(",["T_ISSET","isset",181],"(",["T_VARIABLE","$rates",181],"[",["T_VARIABLE","$i",181],["T_WHITESPACE"," ",181],"+",["T_WHITESPACE"," ",181],["T_LNUMBER","1",181],"]","[",["T_CONSTANT_ENCAPSED_STRING","'tax_calculation_rule_id'",181],"]",")",")",["T_WHITESPACE"," ",181],"{",["T_WHITESPACE","\n                ",181],["T_WHILE","while",182],["T_WHITESPACE"," ",182],"(",["T_ISSET","isset",182],"(",["T_VARIABLE","$rates",182],"[",["T_VARIABLE","$i",182],["T_WHITESPACE"," ",182],"+",["T_WHITESPACE"," ",182],["T_LNUMBER","1",182],"]",")",["T_WHITESPACE"," ",182],["T_BOOLEAN_AND","&&",182],["T_WHITESPACE"," ",182],["T_VARIABLE","$rates",182],"[",["T_VARIABLE","$i",182],["T_WHITESPACE"," ",182],"+",["T_WHITESPACE"," ",182],["T_LNUMBER","1",182],"]","[",["T_CONSTANT_ENCAPSED_STRING","'tax_calculation_rule_id'",182],"]",["T_WHITESPACE"," ",182],["T_IS_EQUAL","==",182],["T_WHITESPACE"," ",182],["T_VARIABLE","$ruleId",182],")",["T_WHITESPACE"," ",182],"{",["T_WHITESPACE","\n                    ",182],["T_VARIABLE","$i",183],["T_INC","++",183],";",["T_WHITESPACE","\n                ",183],"}",["T_WHITESPACE","\n            ",184],"}",["T_WHITESPACE","\n\n            ",185],["T_VARIABLE","$currentRate",187],["T_WHITESPACE"," ",187],["T_PLUS_EQUAL","+=",187],["T_WHITESPACE"," ",187],["T_VARIABLE","$value",187],";",["T_WHITESPACE","\n\n            ",187],["T_IF","if",189],["T_WHITESPACE"," ",189],"(","!",["T_ISSET","isset",189],"(",["T_WHITESPACE","\n                ",189],["T_VARIABLE","$rates",190],"[",["T_VARIABLE","$i",190],["T_WHITESPACE"," ",190],"+",["T_WHITESPACE"," ",190],["T_LNUMBER","1",190],"]",["T_WHITESPACE","\n            ",190],")",["T_WHITESPACE"," ",191],["T_BOOLEAN_OR","||",191],["T_WHITESPACE"," ",191],["T_VARIABLE","$rates",191],"[",["T_VARIABLE","$i",191],["T_WHITESPACE"," ",191],"+",["T_WHITESPACE"," ",191],["T_LNUMBER","1",191],"]","[",["T_CONSTANT_ENCAPSED_STRING","'priority'",191],"]",["T_WHITESPACE"," ",191],["T_IS_NOT_EQUAL","!=",191],["T_WHITESPACE"," ",191],["T_VARIABLE","$priority",191],["T_WHITESPACE"," ",191],["T_BOOLEAN_OR","||",191],["T_WHITESPACE"," ",191],["T_ISSET","isset",191],"(",["T_WHITESPACE","\n                ",191],["T_VARIABLE","$rates",192],"[",["T_VARIABLE","$i",192],["T_WHITESPACE"," ",192],"+",["T_WHITESPACE"," ",192],["T_LNUMBER","1",192],"]","[",["T_CONSTANT_ENCAPSED_STRING","'process'",192],"]",["T_WHITESPACE","\n            ",192],")",["T_WHITESPACE"," ",193],["T_BOOLEAN_AND","&&",193],["T_WHITESPACE"," ",193],["T_VARIABLE","$rates",193],"[",["T_VARIABLE","$i",193],["T_WHITESPACE"," ",193],"+",["T_WHITESPACE"," ",193],["T_LNUMBER","1",193],"]","[",["T_CONSTANT_ENCAPSED_STRING","'process'",193],"]",["T_WHITESPACE"," ",193],["T_IS_NOT_EQUAL","!=",193],["T_WHITESPACE"," ",193],["T_VARIABLE","$rate",193],"[",["T_CONSTANT_ENCAPSED_STRING","'process'",193],"]",["T_WHITESPACE","\n            ",193],")",["T_WHITESPACE"," ",194],"{",["T_WHITESPACE","\n                ",194],["T_IF","if",195],["T_WHITESPACE"," ",195],"(","!",["T_EMPTY","empty",195],"(",["T_VARIABLE","$rates",195],"[",["T_VARIABLE","$i",195],"]","[",["T_CONSTANT_ENCAPSED_STRING","'calculate_subtotal'",195],"]",")",")",["T_WHITESPACE"," ",195],"{",["T_WHITESPACE","\n                    ",195],["T_VARIABLE","$row",196],"[",["T_CONSTANT_ENCAPSED_STRING","'percent'",196],"]",["T_WHITESPACE"," ",196],"=",["T_WHITESPACE"," ",196],["T_VARIABLE","$currentRate",196],";",["T_WHITESPACE","\n                    ",196],["T_VARIABLE","$totalPercent",197],["T_WHITESPACE"," ",197],["T_PLUS_EQUAL","+=",197],["T_WHITESPACE"," ",197],["T_VARIABLE","$currentRate",197],";",["T_WHITESPACE","\n                ",197],"}",["T_WHITESPACE"," ",198],["T_ELSE","else",198],["T_WHITESPACE"," ",198],"{",["T_WHITESPACE","\n                    ",198],["T_VARIABLE","$row",199],"[",["T_CONSTANT_ENCAPSED_STRING","'percent'",199],"]",["T_WHITESPACE"," ",199],"=",["T_WHITESPACE"," ",199],["T_VARIABLE","$this",199],["T_OBJECT_OPERATOR","->",199],["T_STRING","_collectPercent",199],"(",["T_VARIABLE","$totalPercent",199],",",["T_WHITESPACE"," ",199],["T_VARIABLE","$currentRate",199],")",";",["T_WHITESPACE","\n                    ",199],["T_VARIABLE","$totalPercent",200],["T_WHITESPACE"," ",200],["T_PLUS_EQUAL","+=",200],["T_WHITESPACE"," ",200],["T_VARIABLE","$row",200],"[",["T_CONSTANT_ENCAPSED_STRING","'percent'",200],"]",";",["T_WHITESPACE","\n                ",200],"}",["T_WHITESPACE","\n                ",201],["T_VARIABLE","$row",202],"[",["T_CONSTANT_ENCAPSED_STRING","'id'",202],"]",["T_WHITESPACE"," ",202],"=",["T_WHITESPACE"," ",202],["T_STRING","implode",202],"(",["T_CONSTANT_ENCAPSED_STRING","''",202],",",["T_WHITESPACE"," ",202],["T_VARIABLE","$ids",202],")",";",["T_WHITESPACE","\n                ",202],["T_VARIABLE","$result",203],"[","]",["T_WHITESPACE"," ",203],"=",["T_WHITESPACE"," ",203],["T_VARIABLE","$row",203],";",["T_WHITESPACE","\n                ",203],["T_VARIABLE","$row",204],["T_WHITESPACE"," ",204],"=",["T_WHITESPACE"," ",204],"[","]",";",["T_WHITESPACE","\n                ",204],["T_VARIABLE","$ids",205],["T_WHITESPACE"," ",205],"=",["T_WHITESPACE"," ",205],"[","]",";",["T_WHITESPACE","\n\n                ",205],["T_VARIABLE","$currentRate",207],["T_WHITESPACE"," ",207],"=",["T_WHITESPACE"," ",207],["T_LNUMBER","0",207],";",["T_WHITESPACE","\n            ",207],"}",["T_WHITESPACE","\n        ",208],"}",["T_WHITESPACE","\n\n        ",209],["T_RETURN","return",211],["T_WHITESPACE"," ",211],["T_VARIABLE","$result",211],";",["T_WHITESPACE","\n    ",211],"}",["T_WHITESPACE","\n\n    ",212],["T_DOC_COMMENT","\/**\n     * Return combined percent value\n     *\n     * @param float|int $percent\n     * @param float|int $rate\n     * @return float\n     *\/",214],["T_WHITESPACE","\n    ",220],["T_PROTECTED","protected",221],["T_WHITESPACE"," ",221],["T_FUNCTION","function",221],["T_WHITESPACE"," ",221],["T_STRING","_collectPercent",221],"(",["T_VARIABLE","$percent",221],",",["T_WHITESPACE"," ",221],["T_VARIABLE","$rate",221],")",["T_WHITESPACE","\n    ",221],"{",["T_WHITESPACE","\n        ",222],["T_RETURN","return",223],["T_WHITESPACE"," ",223],"(",["T_LNUMBER","100",223],["T_WHITESPACE"," ",223],"+",["T_WHITESPACE"," ",223],["T_VARIABLE","$percent",223],")",["T_WHITESPACE"," ",223],"*",["T_WHITESPACE"," ",223],"(",["T_VARIABLE","$rate",223],["T_WHITESPACE"," ",223],"\/",["T_WHITESPACE"," ",223],["T_LNUMBER","100",223],")",";",["T_WHITESPACE","\n    ",223],"}",["T_WHITESPACE","\n\n    ",224],["T_DOC_COMMENT","\/**\n     * Create search templates for postcode\n     *\n     * @param string $postcode\n     * @param string|null $exactPostcode\n     * @return string[]\n     *\/",226],["T_WHITESPACE","\n    ",232],["T_PROTECTED","protected",233],["T_WHITESPACE"," ",233],["T_FUNCTION","function",233],["T_WHITESPACE"," ",233],["T_STRING","_createSearchPostCodeTemplates",233],"(",["T_VARIABLE","$postcode",233],",",["T_WHITESPACE"," ",233],["T_VARIABLE","$exactPostcode",233],["T_WHITESPACE"," ",233],"=",["T_WHITESPACE"," ",233],["T_STRING","null",233],")",["T_WHITESPACE","\n    ",233],"{",["T_WHITESPACE","\n        ",234],["T_COMMENT","\/\/ as needed, reduce the postcode to the correct length\n",235],["T_WHITESPACE","        ",236],["T_VARIABLE","$len",236],["T_WHITESPACE"," ",236],"=",["T_WHITESPACE"," ",236],["T_VARIABLE","$this",236],["T_OBJECT_OPERATOR","->",236],["T_STRING","_taxData",236],["T_OBJECT_OPERATOR","->",236],["T_STRING","getPostCodeSubStringLength",236],"(",")",";",["T_WHITESPACE","\n        ",236],["T_VARIABLE","$postcode",237],["T_WHITESPACE"," ",237],"=",["T_WHITESPACE"," ",237],["T_STRING","substr",237],"(",["T_VARIABLE","$postcode",237],",",["T_WHITESPACE"," ",237],["T_LNUMBER","0",237],",",["T_WHITESPACE"," ",237],["T_VARIABLE","$len",237],")",";",["T_WHITESPACE","\n\n        ",237],["T_COMMENT","\/\/ begin creating the search template array\n",239],["T_WHITESPACE","        ",240],["T_VARIABLE","$strArr",240],["T_WHITESPACE"," ",240],"=",["T_WHITESPACE"," ",240],"[",["T_VARIABLE","$postcode",240],",",["T_WHITESPACE"," ",240],["T_VARIABLE","$postcode",240],["T_WHITESPACE"," ",240],".",["T_WHITESPACE"," ",240],["T_CONSTANT_ENCAPSED_STRING","'*'",240],"]",";",["T_WHITESPACE","\n\n        ",240],["T_COMMENT","\/\/ if supplied, use the exact postcode as the basis for the search templates\n",242],["T_WHITESPACE","        ",243],["T_IF","if",243],["T_WHITESPACE"," ",243],"(",["T_VARIABLE","$exactPostcode",243],")",["T_WHITESPACE"," ",243],"{",["T_WHITESPACE","\n            ",243],["T_VARIABLE","$postcode",244],["T_WHITESPACE"," ",244],"=",["T_WHITESPACE"," ",244],["T_STRING","substr",244],"(",["T_VARIABLE","$exactPostcode",244],",",["T_WHITESPACE"," ",244],["T_LNUMBER","0",244],",",["T_WHITESPACE"," ",244],["T_VARIABLE","$len",244],")",";",["T_WHITESPACE","\n            ",244],["T_VARIABLE","$strArr",245],"[","]",["T_WHITESPACE"," ",245],"=",["T_WHITESPACE"," ",245],["T_VARIABLE","$postcode",245],";",["T_WHITESPACE","\n        ",245],"}",["T_WHITESPACE","\n\n        ",246],["T_COMMENT","\/\/ finish building out the search template array\n",248],["T_WHITESPACE","        ",249],["T_VARIABLE","$strlen",249],["T_WHITESPACE"," ",249],"=",["T_WHITESPACE"," ",249],["T_STRING","strlen",249],"(",["T_VARIABLE","$postcode",249],")",";",["T_WHITESPACE","\n        ",249],["T_FOR","for",250],["T_WHITESPACE"," ",250],"(",["T_VARIABLE","$i",250],["T_WHITESPACE"," ",250],"=",["T_WHITESPACE"," ",250],["T_LNUMBER","1",250],";",["T_WHITESPACE"," ",250],["T_VARIABLE","$i",250],["T_WHITESPACE"," ",250],"<",["T_WHITESPACE"," ",250],["T_VARIABLE","$strlen",250],";",["T_WHITESPACE"," ",250],["T_VARIABLE","$i",250],["T_INC","++",250],")",["T_WHITESPACE"," ",250],"{",["T_WHITESPACE","\n            ",250],["T_VARIABLE","$strArr",251],"[","]",["T_WHITESPACE"," ",251],"=",["T_WHITESPACE"," ",251],["T_STRING","sprintf",251],"(",["T_CONSTANT_ENCAPSED_STRING","'%s*'",251],",",["T_WHITESPACE"," ",251],["T_STRING","substr",251],"(",["T_VARIABLE","$postcode",251],",",["T_WHITESPACE"," ",251],["T_LNUMBER","0",251],",",["T_WHITESPACE"," ",251],"-",["T_VARIABLE","$i",251],")",")",";",["T_WHITESPACE","\n        ",251],"}",["T_WHITESPACE","\n\n        ",252],["T_RETURN","return",254],["T_WHITESPACE"," ",254],["T_VARIABLE","$strArr",254],";",["T_WHITESPACE","\n    ",254],"}",["T_WHITESPACE","\n\n    ",255],["T_DOC_COMMENT","\/**\n     * Returns tax rates for request - either pereforms SELECT from DB, or returns already cached result\n     * Notice that productClassId due to optimization can be array of ids\n     *\n     * @param \\Magento\\Framework\\DataObject $request\n     * @return array\n     * @SuppressWarnings(PHPMD.CyclomaticComplexity)\n     * @SuppressWarnings(PHPMD.NPathComplexity)\n     * @SuppressWarnings(PHPMD.ExcessiveMethodLength)\n     *\/",257],["T_WHITESPACE","\n    ",266],["T_PROTECTED","protected",267],["T_WHITESPACE"," ",267],["T_FUNCTION","function",267],["T_WHITESPACE"," ",267],["T_STRING","_getRates",267],"(",["T_VARIABLE","$request",267],")",["T_WHITESPACE","\n    ",267],"{",["T_WHITESPACE","\n        ",268],["T_COMMENT","\/\/ Extract params that influence our SELECT statement and use them to create cache key\n",269],["T_WHITESPACE","        ",270],["T_VARIABLE","$storeId",270],["T_WHITESPACE"," ",270],"=",["T_WHITESPACE"," ",270],["T_VARIABLE","$this",270],["T_OBJECT_OPERATOR","->",270],["T_STRING","_storeManager",270],["T_OBJECT_OPERATOR","->",270],["T_STRING","getStore",270],"(",["T_VARIABLE","$request",270],["T_OBJECT_OPERATOR","->",270],["T_STRING","getStore",270],"(",")",")",["T_OBJECT_OPERATOR","->",270],["T_STRING","getId",270],"(",")",";",["T_WHITESPACE","\n        ",270],["T_VARIABLE","$customerClassId",271],["T_WHITESPACE"," ",271],"=",["T_WHITESPACE"," ",271],["T_VARIABLE","$request",271],["T_OBJECT_OPERATOR","->",271],["T_STRING","getCustomerClassId",271],"(",")",";",["T_WHITESPACE","\n        ",271],["T_VARIABLE","$countryId",272],["T_WHITESPACE"," ",272],"=",["T_WHITESPACE"," ",272],["T_VARIABLE","$request",272],["T_OBJECT_OPERATOR","->",272],["T_STRING","getCountryId",272],"(",")",";",["T_WHITESPACE","\n        ",272],["T_VARIABLE","$regionId",273],["T_WHITESPACE"," ",273],"=",["T_WHITESPACE"," ",273],["T_VARIABLE","$request",273],["T_OBJECT_OPERATOR","->",273],["T_STRING","getRegionId",273],"(",")",";",["T_WHITESPACE","\n        ",273],["T_VARIABLE","$postcode",274],["T_WHITESPACE"," ",274],"=",["T_WHITESPACE"," ",274],["T_VARIABLE","$request",274],["T_OBJECT_OPERATOR","->",274],["T_STRING","getPostcode",274],"(",")",";",["T_WHITESPACE","\n\n        ",274],["T_COMMENT","\/\/ Process productClassId as it can be array or usual value. Form best key for cache.\n",276],["T_WHITESPACE","        ",277],["T_VARIABLE","$productClassId",277],["T_WHITESPACE"," ",277],"=",["T_WHITESPACE"," ",277],["T_VARIABLE","$request",277],["T_OBJECT_OPERATOR","->",277],["T_STRING","getProductClassId",277],"(",")",";",["T_WHITESPACE","\n        ",277],["T_VARIABLE","$ids",278],["T_WHITESPACE"," ",278],"=",["T_WHITESPACE"," ",278],["T_STRING","is_array",278],"(",["T_VARIABLE","$productClassId",278],")",["T_WHITESPACE"," ",278],"?",["T_WHITESPACE"," ",278],["T_VARIABLE","$productClassId",278],["T_WHITESPACE"," ",278],":",["T_WHITESPACE"," ",278],"[",["T_VARIABLE","$productClassId",278],"]",";",["T_WHITESPACE","\n        ",278],["T_FOREACH","foreach",279],["T_WHITESPACE"," ",279],"(",["T_VARIABLE","$ids",279],["T_WHITESPACE"," ",279],["T_AS","as",279],["T_WHITESPACE"," ",279],["T_VARIABLE","$key",279],["T_WHITESPACE"," ",279],["T_DOUBLE_ARROW","=>",279],["T_WHITESPACE"," ",279],["T_VARIABLE","$val",279],")",["T_WHITESPACE"," ",279],"{",["T_WHITESPACE","\n            ",279],["T_VARIABLE","$ids",280],"[",["T_VARIABLE","$key",280],"]",["T_WHITESPACE"," ",280],"=",["T_WHITESPACE"," ",280],["T_INT_CAST","(int)",280],["T_VARIABLE","$val",280],";",["T_WHITESPACE"," ",280],["T_COMMENT","\/\/ Make it integer for equal cache keys even in case of null\/false\/0 values\n",280],["T_WHITESPACE","        ",281],"}",["T_WHITESPACE","\n        ",281],["T_VARIABLE","$ids",282],["T_WHITESPACE"," ",282],"=",["T_WHITESPACE"," ",282],["T_STRING","array_unique",282],"(",["T_VARIABLE","$ids",282],")",";",["T_WHITESPACE","\n        ",282],["T_STRING","sort",283],"(",["T_VARIABLE","$ids",283],")",";",["T_WHITESPACE","\n        ",283],["T_VARIABLE","$productClassKey",284],["T_WHITESPACE"," ",284],"=",["T_WHITESPACE"," ",284],["T_STRING","implode",284],"(",["T_CONSTANT_ENCAPSED_STRING","','",284],",",["T_WHITESPACE"," ",284],["T_VARIABLE","$ids",284],")",";",["T_WHITESPACE","\n\n        ",284],["T_COMMENT","\/\/ Form cache key and either get data from cache or from DB\n",286],["T_WHITESPACE","        ",287],["T_VARIABLE","$cacheKey",287],["T_WHITESPACE"," ",287],"=",["T_WHITESPACE"," ",287],["T_STRING","implode",287],"(",["T_WHITESPACE","\n            ",287],["T_CONSTANT_ENCAPSED_STRING","'|'",288],",",["T_WHITESPACE","\n            ",288],"[",["T_VARIABLE","$storeId",289],",",["T_WHITESPACE"," ",289],["T_VARIABLE","$customerClassId",289],",",["T_WHITESPACE"," ",289],["T_VARIABLE","$productClassKey",289],",",["T_WHITESPACE"," ",289],["T_VARIABLE","$countryId",289],",",["T_WHITESPACE"," ",289],["T_VARIABLE","$regionId",289],",",["T_WHITESPACE"," ",289],["T_VARIABLE","$postcode",289],"]",["T_WHITESPACE","\n        ",289],")",";",["T_WHITESPACE","\n\n        ",290],["T_IF","if",292],["T_WHITESPACE"," ",292],"(","!",["T_ISSET","isset",292],"(",["T_VARIABLE","$this",292],["T_OBJECT_OPERATOR","->",292],["T_STRING","_ratesCache",292],"[",["T_VARIABLE","$cacheKey",292],"]",")",")",["T_WHITESPACE"," ",292],"{",["T_WHITESPACE","\n            ",292],["T_COMMENT","\/\/ Make SELECT and get data\n",293],["T_WHITESPACE","            ",294],["T_VARIABLE","$select",294],["T_WHITESPACE"," ",294],"=",["T_WHITESPACE"," ",294],["T_VARIABLE","$this",294],["T_OBJECT_OPERATOR","->",294],["T_STRING","getConnection",294],"(",")",["T_OBJECT_OPERATOR","->",294],["T_STRING","select",294],"(",")",";",["T_WHITESPACE","\n            ",294],["T_VARIABLE","$select",295],["T_OBJECT_OPERATOR","->",295],["T_STRING","from",295],"(",["T_WHITESPACE","\n                ",295],"[",["T_CONSTANT_ENCAPSED_STRING","'main_table'",296],["T_WHITESPACE"," ",296],["T_DOUBLE_ARROW","=>",296],["T_WHITESPACE"," ",296],["T_VARIABLE","$this",296],["T_OBJECT_OPERATOR","->",296],["T_STRING","getMainTable",296],"(",")","]",",",["T_WHITESPACE","\n                ",296],"[",["T_WHITESPACE","\n                    ",297],["T_CONSTANT_ENCAPSED_STRING","'tax_calculation_rate_id'",298],",",["T_WHITESPACE","\n                    ",298],["T_CONSTANT_ENCAPSED_STRING","'tax_calculation_rule_id'",299],",",["T_WHITESPACE","\n                    ",299],["T_CONSTANT_ENCAPSED_STRING","'customer_tax_class_id'",300],",",["T_WHITESPACE","\n                    ",300],["T_CONSTANT_ENCAPSED_STRING","'product_tax_class_id'",301],["T_WHITESPACE","\n                ",301],"]",["T_WHITESPACE","\n            ",302],")",["T_OBJECT_OPERATOR","->",303],["T_STRING","where",303],"(",["T_WHITESPACE","\n                ",303],["T_CONSTANT_ENCAPSED_STRING","'customer_tax_class_id = ?'",304],",",["T_WHITESPACE","\n                ",304],["T_INT_CAST","(int)",305],["T_VARIABLE","$customerClassId",305],["T_WHITESPACE","\n            ",305],")",";",["T_WHITESPACE","\n            ",306],["T_IF","if",307],["T_WHITESPACE"," ",307],"(",["T_VARIABLE","$productClassId",307],")",["T_WHITESPACE"," ",307],"{",["T_WHITESPACE","\n                ",307],["T_VARIABLE","$select",308],["T_OBJECT_OPERATOR","->",308],["T_STRING","where",308],"(",["T_CONSTANT_ENCAPSED_STRING","'product_tax_class_id IN (?)'",308],",",["T_WHITESPACE"," ",308],["T_VARIABLE","$productClassId",308],")",";",["T_WHITESPACE","\n            ",308],"}",["T_WHITESPACE","\n            ",309],["T_VARIABLE","$ifnullTitleValue",310],["T_WHITESPACE"," ",310],"=",["T_WHITESPACE"," ",310],["T_VARIABLE","$this",310],["T_OBJECT_OPERATOR","->",310],["T_STRING","getConnection",310],"(",")",["T_OBJECT_OPERATOR","->",310],["T_STRING","getCheckSql",310],"(",["T_WHITESPACE","\n                ",310],["T_CONSTANT_ENCAPSED_STRING","'title_table.value IS NULL'",311],",",["T_WHITESPACE","\n                ",311],["T_CONSTANT_ENCAPSED_STRING","'rate.code'",312],",",["T_WHITESPACE","\n                ",312],["T_CONSTANT_ENCAPSED_STRING","'title_table.value'",313],["T_WHITESPACE","\n            ",313],")",";",["T_WHITESPACE","\n            ",314],["T_VARIABLE","$ruleTableAliasName",315],["T_WHITESPACE"," ",315],"=",["T_WHITESPACE"," ",315],["T_VARIABLE","$this",315],["T_OBJECT_OPERATOR","->",315],["T_STRING","getConnection",315],"(",")",["T_OBJECT_OPERATOR","->",315],["T_STRING","quoteIdentifier",315],"(",["T_CONSTANT_ENCAPSED_STRING","'rule.tax_calculation_rule_id'",315],")",";",["T_WHITESPACE","\n            ",315],["T_VARIABLE","$select",316],["T_OBJECT_OPERATOR","->",316],["T_STRING","join",316],"(",["T_WHITESPACE","\n                ",316],"[",["T_CONSTANT_ENCAPSED_STRING","'rule'",317],["T_WHITESPACE"," ",317],["T_DOUBLE_ARROW","=>",317],["T_WHITESPACE"," ",317],["T_VARIABLE","$this",317],["T_OBJECT_OPERATOR","->",317],["T_STRING","getTable",317],"(",["T_CONSTANT_ENCAPSED_STRING","'tax_calculation_rule'",317],")","]",",",["T_WHITESPACE","\n                ",317],["T_VARIABLE","$ruleTableAliasName",318],["T_WHITESPACE"," ",318],".",["T_WHITESPACE"," ",318],["T_CONSTANT_ENCAPSED_STRING","' = main_table.tax_calculation_rule_id'",318],",",["T_WHITESPACE","\n                ",318],"[",["T_CONSTANT_ENCAPSED_STRING","'rule.priority'",319],",",["T_WHITESPACE"," ",319],["T_CONSTANT_ENCAPSED_STRING","'rule.position'",319],",",["T_WHITESPACE"," ",319],["T_CONSTANT_ENCAPSED_STRING","'rule.calculate_subtotal'",319],"]",["T_WHITESPACE","\n            ",319],")",["T_OBJECT_OPERATOR","->",320],["T_STRING","join",320],"(",["T_WHITESPACE","\n                ",320],"[",["T_CONSTANT_ENCAPSED_STRING","'rate'",321],["T_WHITESPACE"," ",321],["T_DOUBLE_ARROW","=>",321],["T_WHITESPACE"," ",321],["T_VARIABLE","$this",321],["T_OBJECT_OPERATOR","->",321],["T_STRING","getTable",321],"(",["T_CONSTANT_ENCAPSED_STRING","'tax_calculation_rate'",321],")","]",",",["T_WHITESPACE","\n                ",321],["T_CONSTANT_ENCAPSED_STRING","'rate.tax_calculation_rate_id = main_table.tax_calculation_rate_id'",322],",",["T_WHITESPACE","\n                ",322],"[",["T_WHITESPACE","\n                    ",323],["T_CONSTANT_ENCAPSED_STRING","'value'",324],["T_WHITESPACE"," ",324],["T_DOUBLE_ARROW","=>",324],["T_WHITESPACE"," ",324],["T_CONSTANT_ENCAPSED_STRING","'rate.rate'",324],",",["T_WHITESPACE","\n                    ",324],["T_CONSTANT_ENCAPSED_STRING","'rate.tax_country_id'",325],",",["T_WHITESPACE","\n                    ",325],["T_CONSTANT_ENCAPSED_STRING","'rate.tax_region_id'",326],",",["T_WHITESPACE","\n                    ",326],["T_CONSTANT_ENCAPSED_STRING","'rate.tax_postcode'",327],",",["T_WHITESPACE","\n                    ",327],["T_CONSTANT_ENCAPSED_STRING","'rate.tax_calculation_rate_id'",328],",",["T_WHITESPACE","\n                    ",328],["T_CONSTANT_ENCAPSED_STRING","'rate.code'",329],["T_WHITESPACE","\n                ",329],"]",["T_WHITESPACE","\n            ",330],")",["T_OBJECT_OPERATOR","->",331],["T_STRING","joinLeft",331],"(",["T_WHITESPACE","\n                ",331],"[",["T_CONSTANT_ENCAPSED_STRING","'title_table'",332],["T_WHITESPACE"," ",332],["T_DOUBLE_ARROW","=>",332],["T_WHITESPACE"," ",332],["T_VARIABLE","$this",332],["T_OBJECT_OPERATOR","->",332],["T_STRING","getTable",332],"(",["T_CONSTANT_ENCAPSED_STRING","'tax_calculation_rate_title'",332],")","]",",",["T_WHITESPACE","\n                ",332],["T_CONSTANT_ENCAPSED_STRING","\"rate.tax_calculation_rate_id = title_table.tax_calculation_rate_id \"",333],["T_WHITESPACE"," ",333],".",["T_WHITESPACE","\n                ",333],"\"",["T_ENCAPSED_AND_WHITESPACE","AND title_table.store_id = '",334],["T_CURLY_OPEN","{",334],["T_VARIABLE","$storeId",334],"}",["T_ENCAPSED_AND_WHITESPACE","'",334],"\"",",",["T_WHITESPACE","\n                ",334],"[",["T_CONSTANT_ENCAPSED_STRING","'title'",335],["T_WHITESPACE"," ",335],["T_DOUBLE_ARROW","=>",335],["T_WHITESPACE"," ",335],["T_VARIABLE","$ifnullTitleValue",335],"]",["T_WHITESPACE","\n            ",335],")",["T_OBJECT_OPERATOR","->",336],["T_STRING","where",336],"(",["T_WHITESPACE","\n                ",336],["T_CONSTANT_ENCAPSED_STRING","'rate.tax_country_id = ?'",337],",",["T_WHITESPACE","\n                ",337],["T_VARIABLE","$countryId",338],["T_WHITESPACE","\n            ",338],")",["T_OBJECT_OPERATOR","->",339],["T_STRING","where",339],"(",["T_WHITESPACE","\n                ",339],["T_CONSTANT_ENCAPSED_STRING","\"rate.tax_region_id IN(?)\"",340],",",["T_WHITESPACE","\n                ",340],"[",["T_LNUMBER","0",341],",",["T_WHITESPACE"," ",341],["T_INT_CAST","(int)",341],["T_VARIABLE","$regionId",341],"]",["T_WHITESPACE","\n            ",341],")",";",["T_WHITESPACE","\n            ",342],["T_VARIABLE","$postcodeIsNumeric",343],["T_WHITESPACE"," ",343],"=",["T_WHITESPACE"," ",343],["T_STRING","is_numeric",343],"(",["T_VARIABLE","$postcode",343],")",";",["T_WHITESPACE","\n            ",343],["T_VARIABLE","$postcodeIsRange",344],["T_WHITESPACE"," ",344],"=",["T_WHITESPACE"," ",344],["T_STRING","false",344],";",["T_WHITESPACE","\n            ",344],["T_VARIABLE","$originalPostcode",345],["T_WHITESPACE"," ",345],"=",["T_WHITESPACE"," ",345],["T_STRING","null",345],";",["T_WHITESPACE","\n            ",345],["T_IF","if",346],["T_WHITESPACE"," ",346],"(",["T_STRING","is_string",346],"(",["T_VARIABLE","$postcode",346],")",["T_WHITESPACE"," ",346],["T_BOOLEAN_AND","&&",346],["T_WHITESPACE"," ",346],["T_STRING","preg_match",346],"(",["T_CONSTANT_ENCAPSED_STRING","'\/^(.+)-(.+)$\/'",346],",",["T_WHITESPACE"," ",346],["T_VARIABLE","$postcode",346],",",["T_WHITESPACE"," ",346],["T_VARIABLE","$matches",346],")",")",["T_WHITESPACE"," ",346],"{",["T_WHITESPACE","\n                ",346],["T_IF","if",347],["T_WHITESPACE"," ",347],"(",["T_VARIABLE","$countryId",347],["T_WHITESPACE"," ",347],["T_IS_EQUAL","==",347],["T_WHITESPACE"," ",347],["T_STRING","self",347],["T_DOUBLE_COLON","::",347],["T_STRING","USA_COUNTRY_CODE",347],["T_WHITESPACE"," ",347],["T_BOOLEAN_AND","&&",347],["T_WHITESPACE"," ",347],["T_STRING","is_numeric",347],"(",["T_VARIABLE","$matches",347],"[",["T_LNUMBER","2",347],"]",")",["T_WHITESPACE"," ",347],["T_BOOLEAN_AND","&&",347],["T_WHITESPACE"," ",347],["T_STRING","strlen",347],"(",["T_VARIABLE","$matches",347],"[",["T_LNUMBER","2",347],"]",")",["T_WHITESPACE"," ",347],["T_IS_EQUAL","==",347],["T_WHITESPACE"," ",347],["T_LNUMBER","4",347],")",["T_WHITESPACE"," ",347],"{",["T_WHITESPACE","\n                    ",347],["T_VARIABLE","$postcodeIsNumeric",348],["T_WHITESPACE"," ",348],"=",["T_WHITESPACE"," ",348],["T_STRING","true",348],";",["T_WHITESPACE","\n                    ",348],["T_VARIABLE","$originalPostcode",349],["T_WHITESPACE"," ",349],"=",["T_WHITESPACE"," ",349],["T_VARIABLE","$postcode",349],";",["T_WHITESPACE","\n                    ",349],["T_VARIABLE","$postcode",350],["T_WHITESPACE"," ",350],"=",["T_WHITESPACE"," ",350],["T_VARIABLE","$matches",350],"[",["T_LNUMBER","1",350],"]",";",["T_WHITESPACE","\n                ",350],"}",["T_WHITESPACE"," ",351],["T_ELSE","else",351],["T_WHITESPACE"," ",351],"{",["T_WHITESPACE","\n                    ",351],["T_VARIABLE","$postcodeIsRange",352],["T_WHITESPACE"," ",352],"=",["T_WHITESPACE"," ",352],["T_STRING","true",352],";",["T_WHITESPACE","\n                    ",352],["T_VARIABLE","$zipFrom",353],["T_WHITESPACE"," ",353],"=",["T_WHITESPACE"," ",353],["T_VARIABLE","$matches",353],"[",["T_LNUMBER","1",353],"]",";",["T_WHITESPACE","\n                    ",353],["T_VARIABLE","$zipTo",354],["T_WHITESPACE"," ",354],"=",["T_WHITESPACE"," ",354],["T_VARIABLE","$matches",354],"[",["T_LNUMBER","2",354],"]",";",["T_WHITESPACE","\n                ",354],"}",["T_WHITESPACE","\n            ",355],"}",["T_WHITESPACE","\n\n            ",356],["T_IF","if",358],["T_WHITESPACE"," ",358],"(",["T_VARIABLE","$postcodeIsNumeric",358],["T_WHITESPACE"," ",358],["T_BOOLEAN_OR","||",358],["T_WHITESPACE"," ",358],["T_VARIABLE","$postcodeIsRange",358],")",["T_WHITESPACE"," ",358],"{",["T_WHITESPACE","\n                ",358],["T_VARIABLE","$selectClone",359],["T_WHITESPACE"," ",359],"=",["T_WHITESPACE"," ",359],["T_CLONE","clone",359],["T_WHITESPACE"," ",359],["T_VARIABLE","$select",359],";",["T_WHITESPACE","\n                ",359],["T_VARIABLE","$selectClone",360],["T_OBJECT_OPERATOR","->",360],["T_STRING","where",360],"(",["T_CONSTANT_ENCAPSED_STRING","'rate.zip_is_range IS NOT NULL'",360],")",";",["T_WHITESPACE","\n            ",360],"}",["T_WHITESPACE","\n            ",361],["T_VARIABLE","$select",362],["T_OBJECT_OPERATOR","->",362],["T_STRING","where",362],"(",["T_CONSTANT_ENCAPSED_STRING","'rate.zip_is_range IS NULL'",362],")",";",["T_WHITESPACE","\n\n            ",362],["T_IF","if",364],["T_WHITESPACE"," ",364],"(",["T_VARIABLE","$postcode",364],["T_WHITESPACE"," ",364],["T_IS_NOT_EQUAL","!=",364],["T_WHITESPACE"," ",364],["T_CONSTANT_ENCAPSED_STRING","'*'",364],["T_WHITESPACE"," ",364],["T_BOOLEAN_OR","||",364],["T_WHITESPACE"," ",364],["T_VARIABLE","$postcodeIsRange",364],")",["T_WHITESPACE"," ",364],"{",["T_WHITESPACE","\n                ",364],["T_VARIABLE","$select",365],["T_OBJECT_OPERATOR","->",365],["T_STRING","where",365],"(",["T_WHITESPACE","\n                    ",365],["T_CONSTANT_ENCAPSED_STRING","\"rate.tax_postcode IS NULL OR rate.tax_postcode IN('*', '', ?)\"",366],",",["T_WHITESPACE","\n                    ",366],["T_VARIABLE","$postcodeIsRange",367],["T_WHITESPACE"," ",367],"?",["T_WHITESPACE"," ",367],["T_VARIABLE","$postcode",367],["T_WHITESPACE"," ",367],":",["T_WHITESPACE"," ",367],["T_VARIABLE","$this",367],["T_OBJECT_OPERATOR","->",367],["T_STRING","_createSearchPostCodeTemplates",367],"(",["T_VARIABLE","$postcode",367],",",["T_WHITESPACE"," ",367],["T_VARIABLE","$originalPostcode",367],")",["T_WHITESPACE","\n                ",367],")",";",["T_WHITESPACE","\n                ",368],["T_IF","if",369],["T_WHITESPACE"," ",369],"(",["T_VARIABLE","$postcodeIsNumeric",369],")",["T_WHITESPACE"," ",369],"{",["T_WHITESPACE","\n                    ",369],["T_VARIABLE","$selectClone",370],["T_OBJECT_OPERATOR","->",370],["T_STRING","where",370],"(",["T_CONSTANT_ENCAPSED_STRING","'? BETWEEN rate.zip_from AND rate.zip_to'",370],",",["T_WHITESPACE"," ",370],["T_VARIABLE","$postcode",370],")",";",["T_WHITESPACE","\n                ",370],"}",["T_WHITESPACE"," ",371],["T_ELSEIF","elseif",371],["T_WHITESPACE"," ",371],"(",["T_VARIABLE","$postcodeIsRange",371],")",["T_WHITESPACE"," ",371],"{",["T_WHITESPACE","\n                    ",371],["T_VARIABLE","$selectClone",372],["T_OBJECT_OPERATOR","->",372],["T_STRING","where",372],"(",["T_CONSTANT_ENCAPSED_STRING","'rate.zip_from >= ?'",372],",",["T_WHITESPACE"," ",372],["T_VARIABLE","$zipFrom",372],")",["T_WHITESPACE","\n                        ",372],["T_OBJECT_OPERATOR","->",373],["T_STRING","where",373],"(",["T_CONSTANT_ENCAPSED_STRING","'rate.zip_to <= ?'",373],",",["T_WHITESPACE"," ",373],["T_VARIABLE","$zipTo",373],")",";",["T_WHITESPACE","\n                ",373],"}",["T_WHITESPACE","\n            ",374],"}",["T_WHITESPACE","\n\n            ",375],["T_DOC_COMMENT","\/**\n             * @see ZF-7592 issue http:\/\/framework.zend.com\/issues\/browse\/ZF-7592\n             *\/",377],["T_WHITESPACE","\n            ",379],["T_IF","if",380],["T_WHITESPACE"," ",380],"(",["T_VARIABLE","$postcodeIsNumeric",380],["T_WHITESPACE"," ",380],["T_BOOLEAN_OR","||",380],["T_WHITESPACE"," ",380],["T_VARIABLE","$postcodeIsRange",380],")",["T_WHITESPACE"," ",380],"{",["T_WHITESPACE","\n                ",380],["T_VARIABLE","$select",381],["T_WHITESPACE"," ",381],"=",["T_WHITESPACE"," ",381],["T_VARIABLE","$this",381],["T_OBJECT_OPERATOR","->",381],["T_STRING","getConnection",381],"(",")",["T_OBJECT_OPERATOR","->",381],["T_STRING","select",381],"(",")",["T_OBJECT_OPERATOR","->",381],["T_STRING","union",381],"(",["T_WHITESPACE","\n                    ",381],"[",["T_CONSTANT_ENCAPSED_STRING","'('",382],["T_WHITESPACE"," ",382],".",["T_WHITESPACE"," ",382],["T_VARIABLE","$select",382],["T_WHITESPACE"," ",382],".",["T_WHITESPACE"," ",382],["T_CONSTANT_ENCAPSED_STRING","')'",382],",",["T_WHITESPACE"," ",382],["T_CONSTANT_ENCAPSED_STRING","'('",382],["T_WHITESPACE"," ",382],".",["T_WHITESPACE"," ",382],["T_VARIABLE","$selectClone",382],["T_WHITESPACE"," ",382],".",["T_WHITESPACE"," ",382],["T_CONSTANT_ENCAPSED_STRING","')'",382],"]",["T_WHITESPACE","\n                ",382],")",";",["T_WHITESPACE","\n            ",383],"}",["T_WHITESPACE","\n\n            ",384],["T_VARIABLE","$select",386],["T_OBJECT_OPERATOR","->",386],["T_STRING","order",386],"(",["T_WHITESPACE","\n                ",386],["T_CONSTANT_ENCAPSED_STRING","'priority '",387],["T_WHITESPACE"," ",387],".",["T_WHITESPACE"," ",387],["T_NS_SEPARATOR","\\",387],["T_STRING","Magento",387],["T_NS_SEPARATOR","\\",387],["T_STRING","Framework",387],["T_NS_SEPARATOR","\\",387],["T_STRING","DB",387],["T_NS_SEPARATOR","\\",387],["T_STRING","Select",387],["T_DOUBLE_COLON","::",387],["T_STRING","SQL_ASC",387],["T_WHITESPACE","\n            ",387],")",["T_OBJECT_OPERATOR","->",388],["T_STRING","order",388],"(",["T_WHITESPACE","\n                ",388],["T_CONSTANT_ENCAPSED_STRING","'tax_calculation_rule_id '",389],["T_WHITESPACE"," ",389],".",["T_WHITESPACE"," ",389],["T_NS_SEPARATOR","\\",389],["T_STRING","Magento",389],["T_NS_SEPARATOR","\\",389],["T_STRING","Framework",389],["T_NS_SEPARATOR","\\",389],["T_STRING","DB",389],["T_NS_SEPARATOR","\\",389],["T_STRING","Select",389],["T_DOUBLE_COLON","::",389],["T_STRING","SQL_ASC",389],["T_WHITESPACE","\n            ",389],")",["T_OBJECT_OPERATOR","->",390],["T_STRING","order",390],"(",["T_WHITESPACE","\n                ",390],["T_CONSTANT_ENCAPSED_STRING","'tax_country_id '",391],["T_WHITESPACE"," ",391],".",["T_WHITESPACE"," ",391],["T_NS_SEPARATOR","\\",391],["T_STRING","Magento",391],["T_NS_SEPARATOR","\\",391],["T_STRING","Framework",391],["T_NS_SEPARATOR","\\",391],["T_STRING","DB",391],["T_NS_SEPARATOR","\\",391],["T_STRING","Select",391],["T_DOUBLE_COLON","::",391],["T_STRING","SQL_DESC",391],["T_WHITESPACE","\n            ",391],")",["T_OBJECT_OPERATOR","->",392],["T_STRING","order",392],"(",["T_WHITESPACE","\n                ",392],["T_CONSTANT_ENCAPSED_STRING","'tax_region_id '",393],["T_WHITESPACE"," ",393],".",["T_WHITESPACE"," ",393],["T_NS_SEPARATOR","\\",393],["T_STRING","Magento",393],["T_NS_SEPARATOR","\\",393],["T_STRING","Framework",393],["T_NS_SEPARATOR","\\",393],["T_STRING","DB",393],["T_NS_SEPARATOR","\\",393],["T_STRING","Select",393],["T_DOUBLE_COLON","::",393],["T_STRING","SQL_DESC",393],["T_WHITESPACE","\n            ",393],")",["T_OBJECT_OPERATOR","->",394],["T_STRING","order",394],"(",["T_WHITESPACE","\n                ",394],["T_CONSTANT_ENCAPSED_STRING","'tax_postcode '",395],["T_WHITESPACE"," ",395],".",["T_WHITESPACE"," ",395],["T_NS_SEPARATOR","\\",395],["T_STRING","Magento",395],["T_NS_SEPARATOR","\\",395],["T_STRING","Framework",395],["T_NS_SEPARATOR","\\",395],["T_STRING","DB",395],["T_NS_SEPARATOR","\\",395],["T_STRING","Select",395],["T_DOUBLE_COLON","::",395],["T_STRING","SQL_DESC",395],["T_WHITESPACE","\n            ",395],")",["T_OBJECT_OPERATOR","->",396],["T_STRING","order",396],"(",["T_WHITESPACE","\n                ",396],["T_CONSTANT_ENCAPSED_STRING","'value '",397],["T_WHITESPACE"," ",397],".",["T_WHITESPACE"," ",397],["T_NS_SEPARATOR","\\",397],["T_STRING","Magento",397],["T_NS_SEPARATOR","\\",397],["T_STRING","Framework",397],["T_NS_SEPARATOR","\\",397],["T_STRING","DB",397],["T_NS_SEPARATOR","\\",397],["T_STRING","Select",397],["T_DOUBLE_COLON","::",397],["T_STRING","SQL_DESC",397],["T_WHITESPACE","\n            ",397],")",";",["T_WHITESPACE","\n\n            ",398],["T_VARIABLE","$fetchResult",400],["T_WHITESPACE"," ",400],"=",["T_WHITESPACE"," ",400],["T_VARIABLE","$this",400],["T_OBJECT_OPERATOR","->",400],["T_STRING","getConnection",400],"(",")",["T_OBJECT_OPERATOR","->",400],["T_STRING","fetchAll",400],"(",["T_VARIABLE","$select",400],")",";",["T_WHITESPACE","\n            ",400],["T_VARIABLE","$filteredRates",401],["T_WHITESPACE"," ",401],"=",["T_WHITESPACE"," ",401],"[","]",";",["T_WHITESPACE","\n            ",401],["T_IF","if",402],["T_WHITESPACE"," ",402],"(",["T_VARIABLE","$fetchResult",402],")",["T_WHITESPACE"," ",402],"{",["T_WHITESPACE","\n                ",402],["T_FOREACH","foreach",403],["T_WHITESPACE"," ",403],"(",["T_VARIABLE","$fetchResult",403],["T_WHITESPACE"," ",403],["T_AS","as",403],["T_WHITESPACE"," ",403],["T_VARIABLE","$rate",403],")",["T_WHITESPACE"," ",403],"{",["T_WHITESPACE","\n                    ",403],["T_IF","if",404],["T_WHITESPACE"," ",404],"(","!",["T_ISSET","isset",404],"(",["T_VARIABLE","$filteredRates",404],"[",["T_VARIABLE","$rate",404],"[",["T_CONSTANT_ENCAPSED_STRING","'tax_calculation_rate_id'",404],"]","]",")",")",["T_WHITESPACE"," ",404],"{",["T_WHITESPACE","\n                        ",404],["T_VARIABLE","$filteredRates",405],"[",["T_VARIABLE","$rate",405],"[",["T_CONSTANT_ENCAPSED_STRING","'tax_calculation_rate_id'",405],"]","]",["T_WHITESPACE"," ",405],"=",["T_WHITESPACE"," ",405],["T_VARIABLE","$rate",405],";",["T_WHITESPACE","\n                    ",405],"}",["T_WHITESPACE","\n                ",406],"}",["T_WHITESPACE","\n            ",407],"}",["T_WHITESPACE","\n            ",408],["T_VARIABLE","$this",409],["T_OBJECT_OPERATOR","->",409],["T_STRING","_ratesCache",409],"[",["T_VARIABLE","$cacheKey",409],"]",["T_WHITESPACE"," ",409],"=",["T_WHITESPACE"," ",409],["T_STRING","array_values",409],"(",["T_VARIABLE","$filteredRates",409],")",";",["T_WHITESPACE","\n        ",409],"}",["T_WHITESPACE","\n\n        ",410],["T_RETURN","return",412],["T_WHITESPACE"," ",412],["T_VARIABLE","$this",412],["T_OBJECT_OPERATOR","->",412],["T_STRING","_ratesCache",412],"[",["T_VARIABLE","$cacheKey",412],"]",";",["T_WHITESPACE","\n    ",412],"}",["T_WHITESPACE","\n\n    ",413],["T_DOC_COMMENT","\/**\n     * Calculate rate\n     *\n     * @param array $rates\n     * @return int\n     *\/",415],["T_WHITESPACE","\n    ",420],["T_PROTECTED","protected",421],["T_WHITESPACE"," ",421],["T_FUNCTION","function",421],["T_WHITESPACE"," ",421],["T_STRING","_calculateRate",421],"(",["T_VARIABLE","$rates",421],")",["T_WHITESPACE","\n    ",421],"{",["T_WHITESPACE","\n        ",422],["T_VARIABLE","$result",423],["T_WHITESPACE"," ",423],"=",["T_WHITESPACE"," ",423],["T_LNUMBER","0",423],";",["T_WHITESPACE","\n        ",423],["T_VARIABLE","$currentRate",424],["T_WHITESPACE"," ",424],"=",["T_WHITESPACE"," ",424],["T_LNUMBER","0",424],";",["T_WHITESPACE","\n        ",424],["T_VARIABLE","$countedRates",425],["T_WHITESPACE"," ",425],"=",["T_WHITESPACE"," ",425],["T_STRING","count",425],"(",["T_VARIABLE","$rates",425],")",";",["T_WHITESPACE","\n        ",425],["T_FOR","for",426],["T_WHITESPACE"," ",426],"(",["T_VARIABLE","$i",426],["T_WHITESPACE"," ",426],"=",["T_WHITESPACE"," ",426],["T_LNUMBER","0",426],";",["T_WHITESPACE"," ",426],["T_VARIABLE","$i",426],["T_WHITESPACE"," ",426],"<",["T_WHITESPACE"," ",426],["T_VARIABLE","$countedRates",426],";",["T_WHITESPACE"," ",426],["T_VARIABLE","$i",426],["T_INC","++",426],")",["T_WHITESPACE"," ",426],"{",["T_WHITESPACE","\n            ",426],["T_VARIABLE","$rate",427],["T_WHITESPACE"," ",427],"=",["T_WHITESPACE"," ",427],["T_VARIABLE","$rates",427],"[",["T_VARIABLE","$i",427],"]",";",["T_WHITESPACE","\n            ",427],["T_VARIABLE","$rule",428],["T_WHITESPACE"," ",428],"=",["T_WHITESPACE"," ",428],["T_VARIABLE","$rate",428],"[",["T_CONSTANT_ENCAPSED_STRING","'tax_calculation_rule_id'",428],"]",";",["T_WHITESPACE","\n            ",428],["T_VARIABLE","$value",429],["T_WHITESPACE"," ",429],"=",["T_WHITESPACE"," ",429],["T_VARIABLE","$rate",429],"[",["T_CONSTANT_ENCAPSED_STRING","'value'",429],"]",";",["T_WHITESPACE","\n            ",429],["T_VARIABLE","$priority",430],["T_WHITESPACE"," ",430],"=",["T_WHITESPACE"," ",430],["T_VARIABLE","$rate",430],"[",["T_CONSTANT_ENCAPSED_STRING","'priority'",430],"]",";",["T_WHITESPACE","\n\n            ",430],["T_WHILE","while",432],["T_WHITESPACE"," ",432],"(",["T_ISSET","isset",432],"(",["T_VARIABLE","$rates",432],"[",["T_VARIABLE","$i",432],["T_WHITESPACE"," ",432],"+",["T_WHITESPACE"," ",432],["T_LNUMBER","1",432],"]",")",["T_WHITESPACE"," ",432],["T_BOOLEAN_AND","&&",432],["T_WHITESPACE"," ",432],["T_VARIABLE","$rates",432],"[",["T_VARIABLE","$i",432],["T_WHITESPACE"," ",432],"+",["T_WHITESPACE"," ",432],["T_LNUMBER","1",432],"]","[",["T_CONSTANT_ENCAPSED_STRING","'tax_calculation_rule_id'",432],"]",["T_WHITESPACE"," ",432],["T_IS_EQUAL","==",432],["T_WHITESPACE"," ",432],["T_VARIABLE","$rule",432],")",["T_WHITESPACE"," ",432],"{",["T_WHITESPACE","\n                ",432],["T_VARIABLE","$i",433],["T_INC","++",433],";",["T_WHITESPACE","\n            ",433],"}",["T_WHITESPACE","\n\n            ",434],["T_VARIABLE","$currentRate",436],["T_WHITESPACE"," ",436],["T_PLUS_EQUAL","+=",436],["T_WHITESPACE"," ",436],["T_VARIABLE","$value",436],";",["T_WHITESPACE","\n\n            ",436],["T_IF","if",438],["T_WHITESPACE"," ",438],"(","!",["T_ISSET","isset",438],"(",["T_VARIABLE","$rates",438],"[",["T_VARIABLE","$i",438],["T_WHITESPACE"," ",438],"+",["T_WHITESPACE"," ",438],["T_LNUMBER","1",438],"]",")",["T_WHITESPACE"," ",438],["T_BOOLEAN_OR","||",438],["T_WHITESPACE"," ",438],["T_VARIABLE","$rates",438],"[",["T_VARIABLE","$i",438],["T_WHITESPACE"," ",438],"+",["T_WHITESPACE"," ",438],["T_LNUMBER","1",438],"]","[",["T_CONSTANT_ENCAPSED_STRING","'priority'",438],"]",["T_WHITESPACE"," ",438],["T_IS_NOT_EQUAL","!=",438],["T_WHITESPACE"," ",438],["T_VARIABLE","$priority",438],")",["T_WHITESPACE"," ",438],"{",["T_WHITESPACE","\n                ",438],["T_IF","if",439],["T_WHITESPACE"," ",439],"(","!",["T_EMPTY","empty",439],"(",["T_VARIABLE","$rates",439],"[",["T_VARIABLE","$i",439],"]","[",["T_CONSTANT_ENCAPSED_STRING","'calculate_subtotal'",439],"]",")",")",["T_WHITESPACE"," ",439],"{",["T_WHITESPACE","\n                    ",439],["T_VARIABLE","$result",440],["T_WHITESPACE"," ",440],["T_PLUS_EQUAL","+=",440],["T_WHITESPACE"," ",440],["T_VARIABLE","$currentRate",440],";",["T_WHITESPACE","\n                ",440],"}",["T_WHITESPACE"," ",441],["T_ELSE","else",441],["T_WHITESPACE"," ",441],"{",["T_WHITESPACE","\n                    ",441],["T_VARIABLE","$result",442],["T_WHITESPACE"," ",442],["T_PLUS_EQUAL","+=",442],["T_WHITESPACE"," ",442],["T_VARIABLE","$this",442],["T_OBJECT_OPERATOR","->",442],["T_STRING","_collectPercent",442],"(",["T_VARIABLE","$result",442],",",["T_WHITESPACE"," ",442],["T_VARIABLE","$currentRate",442],")",";",["T_WHITESPACE","\n                ",442],"}",["T_WHITESPACE","\n                ",443],["T_VARIABLE","$currentRate",444],["T_WHITESPACE"," ",444],"=",["T_WHITESPACE"," ",444],["T_LNUMBER","0",444],";",["T_WHITESPACE","\n            ",444],"}",["T_WHITESPACE","\n        ",445],"}",["T_WHITESPACE","\n\n        ",446],["T_RETURN","return",448],["T_WHITESPACE"," ",448],["T_VARIABLE","$result",448],";",["T_WHITESPACE","\n    ",448],"}",["T_WHITESPACE","\n\n    ",449],["T_DOC_COMMENT","\/**\n     * Retrieve rate ids\n     *\n     * @param \\Magento\\Framework\\DataObject $request\n     * @return array\n     *\/",451],["T_WHITESPACE","\n    ",456],["T_PUBLIC","public",457],["T_WHITESPACE"," ",457],["T_FUNCTION","function",457],["T_WHITESPACE"," ",457],["T_STRING","getRateIds",457],"(",["T_VARIABLE","$request",457],")",["T_WHITESPACE","\n    ",457],"{",["T_WHITESPACE","\n        ",458],["T_VARIABLE","$result",459],["T_WHITESPACE"," ",459],"=",["T_WHITESPACE"," ",459],"[","]",";",["T_WHITESPACE","\n        ",459],["T_VARIABLE","$rates",460],["T_WHITESPACE"," ",460],"=",["T_WHITESPACE"," ",460],["T_VARIABLE","$this",460],["T_OBJECT_OPERATOR","->",460],["T_STRING","_getRates",460],"(",["T_VARIABLE","$request",460],")",";",["T_WHITESPACE","\n        ",460],["T_VARIABLE","$countedRates",461],["T_WHITESPACE"," ",461],"=",["T_WHITESPACE"," ",461],["T_STRING","count",461],"(",["T_VARIABLE","$rates",461],")",";",["T_WHITESPACE","\n        ",461],["T_FOR","for",462],["T_WHITESPACE"," ",462],"(",["T_VARIABLE","$i",462],["T_WHITESPACE"," ",462],"=",["T_WHITESPACE"," ",462],["T_LNUMBER","0",462],";",["T_WHITESPACE"," ",462],["T_VARIABLE","$i",462],["T_WHITESPACE"," ",462],"<",["T_WHITESPACE"," ",462],["T_VARIABLE","$countedRates",462],";",["T_WHITESPACE"," ",462],["T_VARIABLE","$i",462],["T_INC","++",462],")",["T_WHITESPACE"," ",462],"{",["T_WHITESPACE","\n            ",462],["T_VARIABLE","$rate",463],["T_WHITESPACE"," ",463],"=",["T_WHITESPACE"," ",463],["T_VARIABLE","$rates",463],"[",["T_VARIABLE","$i",463],"]",";",["T_WHITESPACE","\n            ",463],["T_VARIABLE","$rule",464],["T_WHITESPACE"," ",464],"=",["T_WHITESPACE"," ",464],["T_VARIABLE","$rate",464],"[",["T_CONSTANT_ENCAPSED_STRING","'tax_calculation_rule_id'",464],"]",";",["T_WHITESPACE","\n            ",464],["T_VARIABLE","$result",465],"[","]",["T_WHITESPACE"," ",465],"=",["T_WHITESPACE"," ",465],["T_VARIABLE","$rate",465],"[",["T_CONSTANT_ENCAPSED_STRING","'tax_calculation_rate_id'",465],"]",";",["T_WHITESPACE","\n            ",465],["T_WHILE","while",466],["T_WHITESPACE"," ",466],"(",["T_ISSET","isset",466],"(",["T_VARIABLE","$rates",466],"[",["T_VARIABLE","$i",466],["T_WHITESPACE"," ",466],"+",["T_WHITESPACE"," ",466],["T_LNUMBER","1",466],"]",")",["T_WHITESPACE"," ",466],["T_BOOLEAN_AND","&&",466],["T_WHITESPACE"," ",466],["T_VARIABLE","$rates",466],"[",["T_VARIABLE","$i",466],["T_WHITESPACE"," ",466],"+",["T_WHITESPACE"," ",466],["T_LNUMBER","1",466],"]","[",["T_CONSTANT_ENCAPSED_STRING","'tax_calculation_rule_id'",466],"]",["T_WHITESPACE"," ",466],["T_IS_EQUAL","==",466],["T_WHITESPACE"," ",466],["T_VARIABLE","$rule",466],")",["T_WHITESPACE"," ",466],"{",["T_WHITESPACE","\n                ",466],["T_VARIABLE","$i",467],["T_INC","++",467],";",["T_WHITESPACE","\n            ",467],"}",["T_WHITESPACE","\n        ",468],"}",["T_WHITESPACE","\n\n        ",469],["T_RETURN","return",471],["T_WHITESPACE"," ",471],["T_VARIABLE","$result",471],";",["T_WHITESPACE","\n    ",471],"}",["T_WHITESPACE","\n",472],"}",["T_WHITESPACE","\n",473]]