[["T_OPEN_TAG","<?php\n",1],["T_DOC_COMMENT","\/**\n * Copyright \u00c2\u00a9 2013-2017 Magento, Inc. All rights reserved.\n * See COPYING.txt for license details.\n *\/",2],["T_WHITESPACE","\n",5],["T_NAMESPACE","namespace",6],["T_WHITESPACE"," ",6],["T_STRING","Magento",6],["T_NS_SEPARATOR","\\",6],["T_STRING","Tax",6],["T_NS_SEPARATOR","\\",6],["T_STRING","Model",6],["T_NS_SEPARATOR","\\",6],["T_STRING","Calculation",6],";",["T_WHITESPACE","\n\n",6],["T_USE","use",8],["T_WHITESPACE"," ",8],["T_STRING","Magento",8],["T_NS_SEPARATOR","\\",8],["T_STRING","Tax",8],["T_NS_SEPARATOR","\\",8],["T_STRING","Api",8],["T_NS_SEPARATOR","\\",8],["T_STRING","Data",8],["T_NS_SEPARATOR","\\",8],["T_STRING","QuoteDetailsItemInterface",8],";",["T_WHITESPACE","\n\n",8],["T_ABSTRACT","abstract",10],["T_WHITESPACE"," ",10],["T_CLASS","class",10],["T_WHITESPACE"," ",10],["T_STRING","AbstractAggregateCalculator",10],["T_WHITESPACE"," ",10],["T_EXTENDS","extends",10],["T_WHITESPACE"," ",10],["T_STRING","AbstractCalculator",10],["T_WHITESPACE","\n",10],"{",["T_WHITESPACE","\n    ",11],["T_DOC_COMMENT","\/**\n     * {@inheritdoc}\n     *\/",12],["T_WHITESPACE","\n    ",14],["T_PROTECTED","protected",15],["T_WHITESPACE"," ",15],["T_FUNCTION","function",15],["T_WHITESPACE"," ",15],["T_STRING","calculateWithTaxInPrice",15],"(",["T_STRING","QuoteDetailsItemInterface",15],["T_WHITESPACE"," ",15],["T_VARIABLE","$item",15],",",["T_WHITESPACE"," ",15],["T_VARIABLE","$quantity",15],",",["T_WHITESPACE"," ",15],["T_VARIABLE","$round",15],["T_WHITESPACE"," ",15],"=",["T_WHITESPACE"," ",15],["T_STRING","true",15],")",["T_WHITESPACE","\n    ",15],"{",["T_WHITESPACE","\n        ",16],["T_VARIABLE","$taxRateRequest",17],["T_WHITESPACE"," ",17],"=",["T_WHITESPACE"," ",17],["T_VARIABLE","$this",17],["T_OBJECT_OPERATOR","->",17],["T_STRING","getAddressRateRequest",17],"(",")",["T_OBJECT_OPERATOR","->",17],["T_STRING","setProductClassId",17],"(",["T_WHITESPACE","\n            ",17],["T_VARIABLE","$this",18],["T_OBJECT_OPERATOR","->",18],["T_STRING","taxClassManagement",18],["T_OBJECT_OPERATOR","->",18],["T_STRING","getTaxClassId",18],"(",["T_VARIABLE","$item",18],["T_OBJECT_OPERATOR","->",18],["T_STRING","getTaxClassKey",18],"(",")",")",["T_WHITESPACE","\n        ",18],")",";",["T_WHITESPACE","\n        ",19],["T_VARIABLE","$rate",20],["T_WHITESPACE"," ",20],"=",["T_WHITESPACE"," ",20],["T_VARIABLE","$this",20],["T_OBJECT_OPERATOR","->",20],["T_STRING","calculationTool",20],["T_OBJECT_OPERATOR","->",20],["T_STRING","getRate",20],"(",["T_VARIABLE","$taxRateRequest",20],")",";",["T_WHITESPACE","\n        ",20],["T_VARIABLE","$storeRate",21],["T_WHITESPACE"," ",21],"=",["T_WHITESPACE"," ",21],["T_VARIABLE","$storeRate",21],["T_WHITESPACE"," ",21],"=",["T_WHITESPACE"," ",21],["T_VARIABLE","$this",21],["T_OBJECT_OPERATOR","->",21],["T_STRING","calculationTool",21],["T_OBJECT_OPERATOR","->",21],["T_STRING","getStoreRate",21],"(",["T_VARIABLE","$taxRateRequest",21],",",["T_WHITESPACE"," ",21],["T_VARIABLE","$this",21],["T_OBJECT_OPERATOR","->",21],["T_STRING","storeId",21],")",";",["T_WHITESPACE","\n\n        ",21],["T_VARIABLE","$discountTaxCompensationAmount",23],["T_WHITESPACE"," ",23],"=",["T_WHITESPACE"," ",23],["T_LNUMBER","0",23],";",["T_WHITESPACE","\n        ",23],["T_VARIABLE","$applyTaxAfterDiscount",24],["T_WHITESPACE"," ",24],"=",["T_WHITESPACE"," ",24],["T_VARIABLE","$this",24],["T_OBJECT_OPERATOR","->",24],["T_STRING","config",24],["T_OBJECT_OPERATOR","->",24],["T_STRING","applyTaxAfterDiscount",24],"(",["T_VARIABLE","$this",24],["T_OBJECT_OPERATOR","->",24],["T_STRING","storeId",24],")",";",["T_WHITESPACE","\n        ",24],["T_VARIABLE","$discountAmount",25],["T_WHITESPACE"," ",25],"=",["T_WHITESPACE"," ",25],["T_VARIABLE","$item",25],["T_OBJECT_OPERATOR","->",25],["T_STRING","getDiscountAmount",25],"(",")",";",["T_WHITESPACE","\n\n        ",25],["T_COMMENT","\/\/ Calculate $rowTotalInclTax\n",27],["T_WHITESPACE","        ",28],["T_VARIABLE","$priceInclTax",28],["T_WHITESPACE"," ",28],"=",["T_WHITESPACE"," ",28],["T_VARIABLE","$this",28],["T_OBJECT_OPERATOR","->",28],["T_STRING","calculationTool",28],["T_OBJECT_OPERATOR","->",28],["T_STRING","round",28],"(",["T_VARIABLE","$item",28],["T_OBJECT_OPERATOR","->",28],["T_STRING","getUnitPrice",28],"(",")",")",";",["T_WHITESPACE","\n        ",28],["T_VARIABLE","$rowTotalInclTax",29],["T_WHITESPACE"," ",29],"=",["T_WHITESPACE"," ",29],["T_VARIABLE","$priceInclTax",29],["T_WHITESPACE"," ",29],"*",["T_WHITESPACE"," ",29],["T_VARIABLE","$quantity",29],";",["T_WHITESPACE","\n        ",29],["T_IF","if",30],["T_WHITESPACE"," ",30],"(","!",["T_VARIABLE","$this",30],["T_OBJECT_OPERATOR","->",30],["T_STRING","isSameRateAsStore",30],"(",["T_VARIABLE","$rate",30],",",["T_WHITESPACE"," ",30],["T_VARIABLE","$storeRate",30],")",")",["T_WHITESPACE"," ",30],"{",["T_WHITESPACE","\n            ",30],["T_VARIABLE","$priceInclTax",31],["T_WHITESPACE"," ",31],"=",["T_WHITESPACE"," ",31],["T_VARIABLE","$this",31],["T_OBJECT_OPERATOR","->",31],["T_STRING","calculatePriceInclTax",31],"(",["T_VARIABLE","$priceInclTax",31],",",["T_WHITESPACE"," ",31],["T_VARIABLE","$storeRate",31],",",["T_WHITESPACE"," ",31],["T_VARIABLE","$rate",31],",",["T_WHITESPACE"," ",31],["T_VARIABLE","$round",31],")",";",["T_WHITESPACE","\n            ",31],["T_VARIABLE","$rowTotalInclTax",32],["T_WHITESPACE"," ",32],"=",["T_WHITESPACE"," ",32],["T_VARIABLE","$priceInclTax",32],["T_WHITESPACE"," ",32],"*",["T_WHITESPACE"," ",32],["T_VARIABLE","$quantity",32],";",["T_WHITESPACE","\n        ",32],"}",["T_WHITESPACE","\n        ",33],["T_VARIABLE","$rowTaxExact",34],["T_WHITESPACE"," ",34],"=",["T_WHITESPACE"," ",34],["T_VARIABLE","$this",34],["T_OBJECT_OPERATOR","->",34],["T_STRING","calculationTool",34],["T_OBJECT_OPERATOR","->",34],["T_STRING","calcTaxAmount",34],"(",["T_VARIABLE","$rowTotalInclTax",34],",",["T_WHITESPACE"," ",34],["T_VARIABLE","$rate",34],",",["T_WHITESPACE"," ",34],["T_STRING","true",34],",",["T_WHITESPACE"," ",34],["T_STRING","false",34],")",";",["T_WHITESPACE","\n        ",34],["T_VARIABLE","$deltaRoundingType",35],["T_WHITESPACE"," ",35],"=",["T_WHITESPACE"," ",35],["T_STRING","self",35],["T_DOUBLE_COLON","::",35],["T_STRING","KEY_REGULAR_DELTA_ROUNDING",35],";",["T_WHITESPACE","\n        ",35],["T_IF","if",36],["T_WHITESPACE"," ",36],"(",["T_VARIABLE","$applyTaxAfterDiscount",36],")",["T_WHITESPACE"," ",36],"{",["T_WHITESPACE","\n            ",36],["T_VARIABLE","$deltaRoundingType",37],["T_WHITESPACE"," ",37],"=",["T_WHITESPACE"," ",37],["T_STRING","self",37],["T_DOUBLE_COLON","::",37],["T_STRING","KEY_TAX_BEFORE_DISCOUNT_DELTA_ROUNDING",37],";",["T_WHITESPACE","\n        ",37],"}",["T_WHITESPACE","\n        ",38],["T_VARIABLE","$rowTax",39],["T_WHITESPACE"," ",39],"=",["T_WHITESPACE"," ",39],["T_VARIABLE","$this",39],["T_OBJECT_OPERATOR","->",39],["T_STRING","roundAmount",39],"(",["T_VARIABLE","$rowTaxExact",39],",",["T_WHITESPACE"," ",39],["T_VARIABLE","$rate",39],",",["T_WHITESPACE"," ",39],["T_STRING","true",39],",",["T_WHITESPACE"," ",39],["T_VARIABLE","$deltaRoundingType",39],",",["T_WHITESPACE"," ",39],["T_VARIABLE","$round",39],",",["T_WHITESPACE"," ",39],["T_VARIABLE","$item",39],")",";",["T_WHITESPACE","\n        ",39],["T_VARIABLE","$rowTotal",40],["T_WHITESPACE"," ",40],"=",["T_WHITESPACE"," ",40],["T_VARIABLE","$rowTotalInclTax",40],["T_WHITESPACE"," ",40],"-",["T_WHITESPACE"," ",40],["T_VARIABLE","$rowTax",40],";",["T_WHITESPACE","\n        ",40],["T_VARIABLE","$price",41],["T_WHITESPACE"," ",41],"=",["T_WHITESPACE"," ",41],["T_VARIABLE","$rowTotal",41],["T_WHITESPACE"," ",41],"\/",["T_WHITESPACE"," ",41],["T_VARIABLE","$quantity",41],";",["T_WHITESPACE","\n        ",41],["T_IF","if",42],["T_WHITESPACE"," ",42],"(",["T_VARIABLE","$round",42],")",["T_WHITESPACE"," ",42],"{",["T_WHITESPACE","\n            ",42],["T_VARIABLE","$price",43],["T_WHITESPACE"," ",43],"=",["T_WHITESPACE"," ",43],["T_VARIABLE","$this",43],["T_OBJECT_OPERATOR","->",43],["T_STRING","calculationTool",43],["T_OBJECT_OPERATOR","->",43],["T_STRING","round",43],"(",["T_VARIABLE","$price",43],")",";",["T_WHITESPACE","\n        ",43],"}",["T_WHITESPACE","\n\n        ",44],["T_COMMENT","\/\/Handle discount\n",46],["T_WHITESPACE","        ",47],["T_IF","if",47],["T_WHITESPACE"," ",47],"(",["T_VARIABLE","$applyTaxAfterDiscount",47],")",["T_WHITESPACE"," ",47],"{",["T_WHITESPACE","\n            ",47],["T_COMMENT","\/\/TODO: handle originalDiscountAmount\n",48],["T_WHITESPACE","            ",49],["T_VARIABLE","$taxableAmount",49],["T_WHITESPACE"," ",49],"=",["T_WHITESPACE"," ",49],["T_STRING","max",49],"(",["T_VARIABLE","$rowTotalInclTax",49],["T_WHITESPACE"," ",49],"-",["T_WHITESPACE"," ",49],["T_VARIABLE","$discountAmount",49],",",["T_WHITESPACE"," ",49],["T_LNUMBER","0",49],")",";",["T_WHITESPACE","\n            ",49],["T_VARIABLE","$rowTaxAfterDiscount",50],["T_WHITESPACE"," ",50],"=",["T_WHITESPACE"," ",50],["T_VARIABLE","$this",50],["T_OBJECT_OPERATOR","->",50],["T_STRING","calculationTool",50],["T_OBJECT_OPERATOR","->",50],["T_STRING","calcTaxAmount",50],"(",["T_WHITESPACE","\n                ",50],["T_VARIABLE","$taxableAmount",51],",",["T_WHITESPACE","\n                ",51],["T_VARIABLE","$rate",52],",",["T_WHITESPACE","\n                ",52],["T_STRING","true",53],",",["T_WHITESPACE","\n                ",53],["T_STRING","false",54],["T_WHITESPACE","\n            ",54],")",";",["T_WHITESPACE","\n            ",55],["T_VARIABLE","$rowTaxAfterDiscount",56],["T_WHITESPACE"," ",56],"=",["T_WHITESPACE"," ",56],["T_VARIABLE","$this",56],["T_OBJECT_OPERATOR","->",56],["T_STRING","roundAmount",56],"(",["T_WHITESPACE","\n                ",56],["T_VARIABLE","$rowTaxAfterDiscount",57],",",["T_WHITESPACE","\n                ",57],["T_VARIABLE","$rate",58],",",["T_WHITESPACE","\n                ",58],["T_STRING","true",59],",",["T_WHITESPACE","\n                ",59],["T_STRING","self",60],["T_DOUBLE_COLON","::",60],["T_STRING","KEY_REGULAR_DELTA_ROUNDING",60],",",["T_WHITESPACE","\n                ",60],["T_VARIABLE","$round",61],",",["T_WHITESPACE","\n                ",61],["T_VARIABLE","$item",62],["T_WHITESPACE","\n            ",62],")",";",["T_WHITESPACE","\n            ",63],["T_COMMENT","\/\/ Set discount tax compensation\n",64],["T_WHITESPACE","            ",65],["T_VARIABLE","$discountTaxCompensationAmount",65],["T_WHITESPACE"," ",65],"=",["T_WHITESPACE"," ",65],["T_VARIABLE","$rowTax",65],["T_WHITESPACE"," ",65],"-",["T_WHITESPACE"," ",65],["T_VARIABLE","$rowTaxAfterDiscount",65],";",["T_WHITESPACE","\n            ",65],["T_VARIABLE","$rowTax",66],["T_WHITESPACE"," ",66],"=",["T_WHITESPACE"," ",66],["T_VARIABLE","$rowTaxAfterDiscount",66],";",["T_WHITESPACE","\n        ",66],"}",["T_WHITESPACE","\n\n        ",67],["T_COMMENT","\/\/ Calculate applied taxes\n",69],["T_WHITESPACE","        ",70],["T_DOC_COMMENT","\/** @var  \\Magento\\Tax\\Api\\Data\\AppliedTaxInterface[] $appliedTaxes *\/",70],["T_WHITESPACE","\n        ",70],["T_VARIABLE","$appliedRates",71],["T_WHITESPACE"," ",71],"=",["T_WHITESPACE"," ",71],["T_VARIABLE","$this",71],["T_OBJECT_OPERATOR","->",71],["T_STRING","calculationTool",71],["T_OBJECT_OPERATOR","->",71],["T_STRING","getAppliedRates",71],"(",["T_VARIABLE","$taxRateRequest",71],")",";",["T_WHITESPACE","\n        ",71],["T_VARIABLE","$appliedTaxes",72],["T_WHITESPACE"," ",72],"=",["T_WHITESPACE"," ",72],["T_VARIABLE","$this",72],["T_OBJECT_OPERATOR","->",72],["T_STRING","getAppliedTaxes",72],"(",["T_VARIABLE","$rowTax",72],",",["T_WHITESPACE"," ",72],["T_VARIABLE","$rate",72],",",["T_WHITESPACE"," ",72],["T_VARIABLE","$appliedRates",72],")",";",["T_WHITESPACE","\n\n        ",72],["T_RETURN","return",74],["T_WHITESPACE"," ",74],["T_VARIABLE","$this",74],["T_OBJECT_OPERATOR","->",74],["T_STRING","taxDetailsItemDataObjectFactory",74],["T_OBJECT_OPERATOR","->",74],["T_STRING","create",74],"(",")",["T_WHITESPACE","\n            ",74],["T_OBJECT_OPERATOR","->",75],["T_STRING","setCode",75],"(",["T_VARIABLE","$item",75],["T_OBJECT_OPERATOR","->",75],["T_STRING","getCode",75],"(",")",")",["T_WHITESPACE","\n            ",75],["T_OBJECT_OPERATOR","->",76],["T_STRING","setType",76],"(",["T_VARIABLE","$item",76],["T_OBJECT_OPERATOR","->",76],["T_STRING","getType",76],"(",")",")",["T_WHITESPACE","\n            ",76],["T_OBJECT_OPERATOR","->",77],["T_STRING","setRowTax",77],"(",["T_VARIABLE","$rowTax",77],")",["T_WHITESPACE","\n            ",77],["T_OBJECT_OPERATOR","->",78],["T_STRING","setPrice",78],"(",["T_VARIABLE","$price",78],")",["T_WHITESPACE","\n            ",78],["T_OBJECT_OPERATOR","->",79],["T_STRING","setPriceInclTax",79],"(",["T_VARIABLE","$priceInclTax",79],")",["T_WHITESPACE","\n            ",79],["T_OBJECT_OPERATOR","->",80],["T_STRING","setRowTotal",80],"(",["T_VARIABLE","$rowTotal",80],")",["T_WHITESPACE","\n            ",80],["T_OBJECT_OPERATOR","->",81],["T_STRING","setRowTotalInclTax",81],"(",["T_VARIABLE","$rowTotalInclTax",81],")",["T_WHITESPACE","\n            ",81],["T_OBJECT_OPERATOR","->",82],["T_STRING","setDiscountTaxCompensationAmount",82],"(",["T_VARIABLE","$discountTaxCompensationAmount",82],")",["T_WHITESPACE","\n            ",82],["T_OBJECT_OPERATOR","->",83],["T_STRING","setAssociatedItemCode",83],"(",["T_VARIABLE","$item",83],["T_OBJECT_OPERATOR","->",83],["T_STRING","getAssociatedItemCode",83],"(",")",")",["T_WHITESPACE","\n            ",83],["T_OBJECT_OPERATOR","->",84],["T_STRING","setTaxPercent",84],"(",["T_VARIABLE","$rate",84],")",["T_WHITESPACE","\n            ",84],["T_OBJECT_OPERATOR","->",85],["T_STRING","setAppliedTaxes",85],"(",["T_VARIABLE","$appliedTaxes",85],")",";",["T_WHITESPACE","\n    ",85],"}",["T_WHITESPACE","\n\n    ",86],["T_DOC_COMMENT","\/**\n     * {@inheritdoc}\n     *\/",88],["T_WHITESPACE","\n    ",90],["T_PROTECTED","protected",91],["T_WHITESPACE"," ",91],["T_FUNCTION","function",91],["T_WHITESPACE"," ",91],["T_STRING","calculateWithTaxNotInPrice",91],"(",["T_STRING","QuoteDetailsItemInterface",91],["T_WHITESPACE"," ",91],["T_VARIABLE","$item",91],",",["T_WHITESPACE"," ",91],["T_VARIABLE","$quantity",91],",",["T_WHITESPACE"," ",91],["T_VARIABLE","$round",91],["T_WHITESPACE"," ",91],"=",["T_WHITESPACE"," ",91],["T_STRING","true",91],")",["T_WHITESPACE","\n    ",91],"{",["T_WHITESPACE","\n        ",92],["T_VARIABLE","$taxRateRequest",93],["T_WHITESPACE"," ",93],"=",["T_WHITESPACE"," ",93],["T_VARIABLE","$this",93],["T_OBJECT_OPERATOR","->",93],["T_STRING","getAddressRateRequest",93],"(",")",["T_OBJECT_OPERATOR","->",93],["T_STRING","setProductClassId",93],"(",["T_WHITESPACE","\n            ",93],["T_VARIABLE","$this",94],["T_OBJECT_OPERATOR","->",94],["T_STRING","taxClassManagement",94],["T_OBJECT_OPERATOR","->",94],["T_STRING","getTaxClassId",94],"(",["T_VARIABLE","$item",94],["T_OBJECT_OPERATOR","->",94],["T_STRING","getTaxClassKey",94],"(",")",")",["T_WHITESPACE","\n        ",94],")",";",["T_WHITESPACE","\n        ",95],["T_VARIABLE","$rate",96],["T_WHITESPACE"," ",96],"=",["T_WHITESPACE"," ",96],["T_VARIABLE","$this",96],["T_OBJECT_OPERATOR","->",96],["T_STRING","calculationTool",96],["T_OBJECT_OPERATOR","->",96],["T_STRING","getRate",96],"(",["T_VARIABLE","$taxRateRequest",96],")",";",["T_WHITESPACE","\n        ",96],["T_VARIABLE","$appliedRates",97],["T_WHITESPACE"," ",97],"=",["T_WHITESPACE"," ",97],["T_VARIABLE","$this",97],["T_OBJECT_OPERATOR","->",97],["T_STRING","calculationTool",97],["T_OBJECT_OPERATOR","->",97],["T_STRING","getAppliedRates",97],"(",["T_VARIABLE","$taxRateRequest",97],")",";",["T_WHITESPACE","\n\n        ",97],["T_VARIABLE","$applyTaxAfterDiscount",99],["T_WHITESPACE"," ",99],"=",["T_WHITESPACE"," ",99],["T_VARIABLE","$this",99],["T_OBJECT_OPERATOR","->",99],["T_STRING","config",99],["T_OBJECT_OPERATOR","->",99],["T_STRING","applyTaxAfterDiscount",99],"(",["T_VARIABLE","$this",99],["T_OBJECT_OPERATOR","->",99],["T_STRING","storeId",99],")",";",["T_WHITESPACE","\n        ",99],["T_VARIABLE","$discountAmount",100],["T_WHITESPACE"," ",100],"=",["T_WHITESPACE"," ",100],["T_VARIABLE","$item",100],["T_OBJECT_OPERATOR","->",100],["T_STRING","getDiscountAmount",100],"(",")",";",["T_WHITESPACE","\n        ",100],["T_VARIABLE","$discountTaxCompensationAmount",101],["T_WHITESPACE"," ",101],"=",["T_WHITESPACE"," ",101],["T_LNUMBER","0",101],";",["T_WHITESPACE","\n\n        ",101],["T_COMMENT","\/\/ Calculate $rowTotal\n",103],["T_WHITESPACE","        ",104],["T_VARIABLE","$price",104],["T_WHITESPACE"," ",104],"=",["T_WHITESPACE"," ",104],["T_VARIABLE","$this",104],["T_OBJECT_OPERATOR","->",104],["T_STRING","calculationTool",104],["T_OBJECT_OPERATOR","->",104],["T_STRING","round",104],"(",["T_VARIABLE","$item",104],["T_OBJECT_OPERATOR","->",104],["T_STRING","getUnitPrice",104],"(",")",")",";",["T_WHITESPACE","\n        ",104],["T_VARIABLE","$rowTotal",105],["T_WHITESPACE"," ",105],"=",["T_WHITESPACE"," ",105],["T_VARIABLE","$price",105],["T_WHITESPACE"," ",105],"*",["T_WHITESPACE"," ",105],["T_VARIABLE","$quantity",105],";",["T_WHITESPACE","\n        ",105],["T_VARIABLE","$rowTaxes",106],["T_WHITESPACE"," ",106],"=",["T_WHITESPACE"," ",106],"[","]",";",["T_WHITESPACE","\n        ",106],["T_VARIABLE","$rowTaxesBeforeDiscount",107],["T_WHITESPACE"," ",107],"=",["T_WHITESPACE"," ",107],"[","]",";",["T_WHITESPACE","\n        ",107],["T_VARIABLE","$appliedTaxes",108],["T_WHITESPACE"," ",108],"=",["T_WHITESPACE"," ",108],"[","]",";",["T_WHITESPACE","\n        ",108],["T_COMMENT","\/\/Apply each tax rate separately\n",109],["T_WHITESPACE","        ",110],["T_FOREACH","foreach",110],["T_WHITESPACE"," ",110],"(",["T_VARIABLE","$appliedRates",110],["T_WHITESPACE"," ",110],["T_AS","as",110],["T_WHITESPACE"," ",110],["T_VARIABLE","$appliedRate",110],")",["T_WHITESPACE"," ",110],"{",["T_WHITESPACE","\n            ",110],["T_VARIABLE","$taxId",111],["T_WHITESPACE"," ",111],"=",["T_WHITESPACE"," ",111],["T_VARIABLE","$appliedRate",111],"[",["T_CONSTANT_ENCAPSED_STRING","'id'",111],"]",";",["T_WHITESPACE","\n            ",111],["T_VARIABLE","$taxRate",112],["T_WHITESPACE"," ",112],"=",["T_WHITESPACE"," ",112],["T_VARIABLE","$appliedRate",112],"[",["T_CONSTANT_ENCAPSED_STRING","'percent'",112],"]",";",["T_WHITESPACE","\n            ",112],["T_VARIABLE","$rowTaxPerRate",113],["T_WHITESPACE"," ",113],"=",["T_WHITESPACE"," ",113],["T_VARIABLE","$this",113],["T_OBJECT_OPERATOR","->",113],["T_STRING","calculationTool",113],["T_OBJECT_OPERATOR","->",113],["T_STRING","calcTaxAmount",113],"(",["T_VARIABLE","$rowTotal",113],",",["T_WHITESPACE"," ",113],["T_VARIABLE","$taxRate",113],",",["T_WHITESPACE"," ",113],["T_STRING","false",113],",",["T_WHITESPACE"," ",113],["T_STRING","false",113],")",";",["T_WHITESPACE","\n            ",113],["T_VARIABLE","$deltaRoundingType",114],["T_WHITESPACE"," ",114],"=",["T_WHITESPACE"," ",114],["T_STRING","self",114],["T_DOUBLE_COLON","::",114],["T_STRING","KEY_REGULAR_DELTA_ROUNDING",114],";",["T_WHITESPACE","\n            ",114],["T_IF","if",115],["T_WHITESPACE"," ",115],"(",["T_VARIABLE","$applyTaxAfterDiscount",115],")",["T_WHITESPACE"," ",115],"{",["T_WHITESPACE","\n                ",115],["T_VARIABLE","$deltaRoundingType",116],["T_WHITESPACE"," ",116],"=",["T_WHITESPACE"," ",116],["T_STRING","self",116],["T_DOUBLE_COLON","::",116],["T_STRING","KEY_TAX_BEFORE_DISCOUNT_DELTA_ROUNDING",116],";",["T_WHITESPACE","\n            ",116],"}",["T_WHITESPACE","\n            ",117],["T_VARIABLE","$rowTaxPerRate",118],["T_WHITESPACE"," ",118],"=",["T_WHITESPACE"," ",118],["T_VARIABLE","$this",118],["T_OBJECT_OPERATOR","->",118],["T_STRING","roundAmount",118],"(",["T_VARIABLE","$rowTaxPerRate",118],",",["T_WHITESPACE"," ",118],["T_VARIABLE","$taxId",118],",",["T_WHITESPACE"," ",118],["T_STRING","false",118],",",["T_WHITESPACE"," ",118],["T_VARIABLE","$deltaRoundingType",118],",",["T_WHITESPACE"," ",118],["T_VARIABLE","$round",118],",",["T_WHITESPACE"," ",118],["T_VARIABLE","$item",118],")",";",["T_WHITESPACE","\n            ",118],["T_VARIABLE","$rowTaxAfterDiscount",119],["T_WHITESPACE"," ",119],"=",["T_WHITESPACE"," ",119],["T_VARIABLE","$rowTaxPerRate",119],";",["T_WHITESPACE","\n\n            ",119],["T_COMMENT","\/\/Handle discount\n",121],["T_WHITESPACE","            ",122],["T_IF","if",122],["T_WHITESPACE"," ",122],"(",["T_VARIABLE","$applyTaxAfterDiscount",122],")",["T_WHITESPACE"," ",122],"{",["T_WHITESPACE","\n                ",122],["T_COMMENT","\/\/TODO: handle originalDiscountAmount\n",123],["T_WHITESPACE","                ",124],["T_VARIABLE","$taxableAmount",124],["T_WHITESPACE"," ",124],"=",["T_WHITESPACE"," ",124],["T_STRING","max",124],"(",["T_VARIABLE","$rowTotal",124],["T_WHITESPACE"," ",124],"-",["T_WHITESPACE"," ",124],["T_VARIABLE","$discountAmount",124],",",["T_WHITESPACE"," ",124],["T_LNUMBER","0",124],")",";",["T_WHITESPACE","\n                ",124],["T_VARIABLE","$rowTaxAfterDiscount",125],["T_WHITESPACE"," ",125],"=",["T_WHITESPACE"," ",125],["T_VARIABLE","$this",125],["T_OBJECT_OPERATOR","->",125],["T_STRING","calculationTool",125],["T_OBJECT_OPERATOR","->",125],["T_STRING","calcTaxAmount",125],"(",["T_WHITESPACE","\n                    ",125],["T_VARIABLE","$taxableAmount",126],",",["T_WHITESPACE","\n                    ",126],["T_VARIABLE","$taxRate",127],",",["T_WHITESPACE","\n                    ",127],["T_STRING","false",128],",",["T_WHITESPACE","\n                    ",128],["T_STRING","false",129],["T_WHITESPACE","\n                ",129],")",";",["T_WHITESPACE","\n                ",130],["T_VARIABLE","$rowTaxAfterDiscount",131],["T_WHITESPACE"," ",131],"=",["T_WHITESPACE"," ",131],["T_VARIABLE","$this",131],["T_OBJECT_OPERATOR","->",131],["T_STRING","roundAmount",131],"(",["T_WHITESPACE","\n                    ",131],["T_VARIABLE","$rowTaxAfterDiscount",132],",",["T_WHITESPACE","\n                    ",132],["T_VARIABLE","$taxId",133],",",["T_WHITESPACE","\n                    ",133],["T_STRING","false",134],",",["T_WHITESPACE","\n                    ",134],["T_STRING","self",135],["T_DOUBLE_COLON","::",135],["T_STRING","KEY_REGULAR_DELTA_ROUNDING",135],",",["T_WHITESPACE","\n                    ",135],["T_VARIABLE","$round",136],",",["T_WHITESPACE","\n                    ",136],["T_VARIABLE","$item",137],["T_WHITESPACE","\n                ",137],")",";",["T_WHITESPACE","\n            ",138],"}",["T_WHITESPACE","\n            ",139],["T_VARIABLE","$appliedTaxes",140],"[",["T_VARIABLE","$taxId",140],"]",["T_WHITESPACE"," ",140],"=",["T_WHITESPACE"," ",140],["T_VARIABLE","$this",140],["T_OBJECT_OPERATOR","->",140],["T_STRING","getAppliedTax",140],"(",["T_WHITESPACE","\n                ",140],["T_VARIABLE","$rowTaxAfterDiscount",141],",",["T_WHITESPACE","\n                ",141],["T_VARIABLE","$appliedRate",142],["T_WHITESPACE","\n            ",142],")",";",["T_WHITESPACE","\n\n            ",143],["T_VARIABLE","$rowTaxes",145],"[","]",["T_WHITESPACE"," ",145],"=",["T_WHITESPACE"," ",145],["T_VARIABLE","$rowTaxAfterDiscount",145],";",["T_WHITESPACE","\n            ",145],["T_VARIABLE","$rowTaxesBeforeDiscount",146],"[","]",["T_WHITESPACE"," ",146],"=",["T_WHITESPACE"," ",146],["T_VARIABLE","$rowTaxPerRate",146],";",["T_WHITESPACE","\n        ",146],"}",["T_WHITESPACE","\n        ",147],["T_VARIABLE","$rowTax",148],["T_WHITESPACE"," ",148],"=",["T_WHITESPACE"," ",148],["T_STRING","array_sum",148],"(",["T_VARIABLE","$rowTaxes",148],")",";",["T_WHITESPACE","\n        ",148],["T_VARIABLE","$rowTaxBeforeDiscount",149],["T_WHITESPACE"," ",149],"=",["T_WHITESPACE"," ",149],["T_STRING","array_sum",149],"(",["T_VARIABLE","$rowTaxesBeforeDiscount",149],")",";",["T_WHITESPACE","\n        ",149],["T_VARIABLE","$rowTotalInclTax",150],["T_WHITESPACE"," ",150],"=",["T_WHITESPACE"," ",150],["T_VARIABLE","$rowTotal",150],["T_WHITESPACE"," ",150],"+",["T_WHITESPACE"," ",150],["T_VARIABLE","$rowTaxBeforeDiscount",150],";",["T_WHITESPACE","\n        ",150],["T_VARIABLE","$priceInclTax",151],["T_WHITESPACE"," ",151],"=",["T_WHITESPACE"," ",151],["T_VARIABLE","$rowTotalInclTax",151],["T_WHITESPACE"," ",151],"\/",["T_WHITESPACE"," ",151],["T_VARIABLE","$quantity",151],";",["T_WHITESPACE","\n        ",151],["T_IF","if",152],["T_WHITESPACE"," ",152],"(",["T_VARIABLE","$round",152],")",["T_WHITESPACE"," ",152],"{",["T_WHITESPACE","\n            ",152],["T_VARIABLE","$priceInclTax",153],["T_WHITESPACE"," ",153],"=",["T_WHITESPACE"," ",153],["T_VARIABLE","$this",153],["T_OBJECT_OPERATOR","->",153],["T_STRING","calculationTool",153],["T_OBJECT_OPERATOR","->",153],["T_STRING","round",153],"(",["T_VARIABLE","$priceInclTax",153],")",";",["T_WHITESPACE","\n        ",153],"}",["T_WHITESPACE","\n\n        ",154],["T_RETURN","return",156],["T_WHITESPACE"," ",156],["T_VARIABLE","$this",156],["T_OBJECT_OPERATOR","->",156],["T_STRING","taxDetailsItemDataObjectFactory",156],["T_OBJECT_OPERATOR","->",156],["T_STRING","create",156],"(",")",["T_WHITESPACE","\n            ",156],["T_OBJECT_OPERATOR","->",157],["T_STRING","setCode",157],"(",["T_VARIABLE","$item",157],["T_OBJECT_OPERATOR","->",157],["T_STRING","getCode",157],"(",")",")",["T_WHITESPACE","\n            ",157],["T_OBJECT_OPERATOR","->",158],["T_STRING","setType",158],"(",["T_VARIABLE","$item",158],["T_OBJECT_OPERATOR","->",158],["T_STRING","getType",158],"(",")",")",["T_WHITESPACE","\n            ",158],["T_OBJECT_OPERATOR","->",159],["T_STRING","setRowTax",159],"(",["T_VARIABLE","$rowTax",159],")",["T_WHITESPACE","\n            ",159],["T_OBJECT_OPERATOR","->",160],["T_STRING","setPrice",160],"(",["T_VARIABLE","$price",160],")",["T_WHITESPACE","\n            ",160],["T_OBJECT_OPERATOR","->",161],["T_STRING","setPriceInclTax",161],"(",["T_VARIABLE","$priceInclTax",161],")",["T_WHITESPACE","\n            ",161],["T_OBJECT_OPERATOR","->",162],["T_STRING","setRowTotal",162],"(",["T_VARIABLE","$rowTotal",162],")",["T_WHITESPACE","\n            ",162],["T_OBJECT_OPERATOR","->",163],["T_STRING","setRowTotalInclTax",163],"(",["T_VARIABLE","$rowTotalInclTax",163],")",["T_WHITESPACE","\n            ",163],["T_OBJECT_OPERATOR","->",164],["T_STRING","setDiscountTaxCompensationAmount",164],"(",["T_VARIABLE","$discountTaxCompensationAmount",164],")",["T_WHITESPACE","\n            ",164],["T_OBJECT_OPERATOR","->",165],["T_STRING","setAssociatedItemCode",165],"(",["T_VARIABLE","$item",165],["T_OBJECT_OPERATOR","->",165],["T_STRING","getAssociatedItemCode",165],"(",")",")",["T_WHITESPACE","\n            ",165],["T_OBJECT_OPERATOR","->",166],["T_STRING","setTaxPercent",166],"(",["T_VARIABLE","$rate",166],")",["T_WHITESPACE","\n            ",166],["T_OBJECT_OPERATOR","->",167],["T_STRING","setAppliedTaxes",167],"(",["T_VARIABLE","$appliedTaxes",167],")",";",["T_WHITESPACE","\n    ",167],"}",["T_WHITESPACE","\n\n    ",168],["T_DOC_COMMENT","\/**\n     * Round amount\n     *\n     * @param float $amount\n     * @param null|float $rate\n     * @param null|bool $direction\n     * @param string $type\n     * @param bool $round\n     * @param QuoteDetailsItemInterface $item\n     * @return float\n     *\/",170],["T_WHITESPACE","\n    ",180],["T_ABSTRACT","abstract",181],["T_WHITESPACE"," ",181],["T_PROTECTED","protected",181],["T_WHITESPACE"," ",181],["T_FUNCTION","function",181],["T_WHITESPACE"," ",181],["T_STRING","roundAmount",181],"(",["T_WHITESPACE","\n        ",181],["T_VARIABLE","$amount",182],",",["T_WHITESPACE","\n        ",182],["T_VARIABLE","$rate",183],["T_WHITESPACE"," ",183],"=",["T_WHITESPACE"," ",183],["T_STRING","null",183],",",["T_WHITESPACE","\n        ",183],["T_VARIABLE","$direction",184],["T_WHITESPACE"," ",184],"=",["T_WHITESPACE"," ",184],["T_STRING","null",184],",",["T_WHITESPACE","\n        ",184],["T_VARIABLE","$type",185],["T_WHITESPACE"," ",185],"=",["T_WHITESPACE"," ",185],["T_STRING","self",185],["T_DOUBLE_COLON","::",185],["T_STRING","KEY_REGULAR_DELTA_ROUNDING",185],",",["T_WHITESPACE","\n        ",185],["T_VARIABLE","$round",186],["T_WHITESPACE"," ",186],"=",["T_WHITESPACE"," ",186],["T_STRING","true",186],",",["T_WHITESPACE","\n        ",186],["T_VARIABLE","$item",187],["T_WHITESPACE"," ",187],"=",["T_WHITESPACE"," ",187],["T_STRING","null",187],["T_WHITESPACE","\n    ",187],")",";",["T_WHITESPACE","\n",188],"}",["T_WHITESPACE","\n",189]]