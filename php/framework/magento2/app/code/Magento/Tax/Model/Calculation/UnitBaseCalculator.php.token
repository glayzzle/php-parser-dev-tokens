[["T_OPEN_TAG","<?php\n",1],["T_DOC_COMMENT","\/**\n * Copyright \u00c2\u00a9 2013-2017 Magento, Inc. All rights reserved.\n * See COPYING.txt for license details.\n *\/",2],["T_WHITESPACE","\n",5],["T_NAMESPACE","namespace",6],["T_WHITESPACE"," ",6],["T_STRING","Magento",6],["T_NS_SEPARATOR","\\",6],["T_STRING","Tax",6],["T_NS_SEPARATOR","\\",6],["T_STRING","Model",6],["T_NS_SEPARATOR","\\",6],["T_STRING","Calculation",6],";",["T_WHITESPACE","\n\n",6],["T_USE","use",8],["T_WHITESPACE"," ",8],["T_STRING","Magento",8],["T_NS_SEPARATOR","\\",8],["T_STRING","Tax",8],["T_NS_SEPARATOR","\\",8],["T_STRING","Api",8],["T_NS_SEPARATOR","\\",8],["T_STRING","Data",8],["T_NS_SEPARATOR","\\",8],["T_STRING","QuoteDetailsItemInterface",8],";",["T_WHITESPACE","\n\n",8],["T_CLASS","class",10],["T_WHITESPACE"," ",10],["T_STRING","UnitBaseCalculator",10],["T_WHITESPACE"," ",10],["T_EXTENDS","extends",10],["T_WHITESPACE"," ",10],["T_STRING","AbstractCalculator",10],["T_WHITESPACE","\n",10],"{",["T_WHITESPACE","\n    ",11],["T_DOC_COMMENT","\/**\n     * {@inheritdoc}\n     *\/",12],["T_WHITESPACE","\n    ",14],["T_PROTECTED","protected",15],["T_WHITESPACE"," ",15],["T_FUNCTION","function",15],["T_WHITESPACE"," ",15],["T_STRING","roundAmount",15],"(",["T_WHITESPACE","\n        ",15],["T_VARIABLE","$amount",16],",",["T_WHITESPACE","\n        ",16],["T_VARIABLE","$rate",17],["T_WHITESPACE"," ",17],"=",["T_WHITESPACE"," ",17],["T_STRING","null",17],",",["T_WHITESPACE","\n        ",17],["T_VARIABLE","$direction",18],["T_WHITESPACE"," ",18],"=",["T_WHITESPACE"," ",18],["T_STRING","null",18],",",["T_WHITESPACE","\n        ",18],["T_VARIABLE","$type",19],["T_WHITESPACE"," ",19],"=",["T_WHITESPACE"," ",19],["T_STRING","self",19],["T_DOUBLE_COLON","::",19],["T_STRING","KEY_REGULAR_DELTA_ROUNDING",19],",",["T_WHITESPACE","\n        ",19],["T_VARIABLE","$round",20],["T_WHITESPACE"," ",20],"=",["T_WHITESPACE"," ",20],["T_STRING","true",20],",",["T_WHITESPACE","\n        ",20],["T_VARIABLE","$item",21],["T_WHITESPACE"," ",21],"=",["T_WHITESPACE"," ",21],["T_STRING","null",21],["T_WHITESPACE","\n    ",21],")",["T_WHITESPACE"," ",22],"{",["T_WHITESPACE","\n        ",22],["T_IF","if",23],["T_WHITESPACE"," ",23],"(",["T_VARIABLE","$item",23],["T_OBJECT_OPERATOR","->",23],["T_STRING","getAssociatedItemCode",23],"(",")",")",["T_WHITESPACE"," ",23],"{",["T_WHITESPACE","\n            ",23],["T_COMMENT","\/\/ Use delta rounding of the product's instead of the weee's\n",24],["T_WHITESPACE","            ",25],["T_VARIABLE","$type",25],["T_WHITESPACE"," ",25],"=",["T_WHITESPACE"," ",25],["T_VARIABLE","$type",25],["T_WHITESPACE"," ",25],".",["T_WHITESPACE"," ",25],["T_VARIABLE","$item",25],["T_OBJECT_OPERATOR","->",25],["T_STRING","getAssociatedItemCode",25],"(",")",";",["T_WHITESPACE","\n        ",25],"}",["T_WHITESPACE"," ",26],["T_ELSE","else",26],["T_WHITESPACE"," ",26],"{",["T_WHITESPACE","\n            ",26],["T_VARIABLE","$type",27],["T_WHITESPACE"," ",27],"=",["T_WHITESPACE"," ",27],["T_VARIABLE","$type",27],["T_WHITESPACE"," ",27],".",["T_WHITESPACE"," ",27],["T_VARIABLE","$item",27],["T_OBJECT_OPERATOR","->",27],["T_STRING","getCode",27],"(",")",";",["T_WHITESPACE","\n        ",27],"}",["T_WHITESPACE","\n\n        ",28],["T_RETURN","return",30],["T_WHITESPACE"," ",30],["T_VARIABLE","$this",30],["T_OBJECT_OPERATOR","->",30],["T_STRING","deltaRound",30],"(",["T_VARIABLE","$amount",30],",",["T_WHITESPACE"," ",30],["T_VARIABLE","$rate",30],",",["T_WHITESPACE"," ",30],["T_VARIABLE","$direction",30],",",["T_WHITESPACE"," ",30],["T_VARIABLE","$type",30],",",["T_WHITESPACE"," ",30],["T_VARIABLE","$round",30],")",";",["T_WHITESPACE","\n    ",30],"}",["T_WHITESPACE","\n\n    ",31],["T_DOC_COMMENT","\/**\n     * {@inheritdoc}\n     *\/",33],["T_WHITESPACE","\n    ",35],["T_PROTECTED","protected",36],["T_WHITESPACE"," ",36],["T_FUNCTION","function",36],["T_WHITESPACE"," ",36],["T_STRING","calculateWithTaxInPrice",36],"(",["T_STRING","QuoteDetailsItemInterface",36],["T_WHITESPACE"," ",36],["T_VARIABLE","$item",36],",",["T_WHITESPACE"," ",36],["T_VARIABLE","$quantity",36],",",["T_WHITESPACE"," ",36],["T_VARIABLE","$round",36],["T_WHITESPACE"," ",36],"=",["T_WHITESPACE"," ",36],["T_STRING","true",36],")",["T_WHITESPACE","\n    ",36],"{",["T_WHITESPACE","\n        ",37],["T_VARIABLE","$taxRateRequest",38],["T_WHITESPACE"," ",38],"=",["T_WHITESPACE"," ",38],["T_VARIABLE","$this",38],["T_OBJECT_OPERATOR","->",38],["T_STRING","getAddressRateRequest",38],"(",")",["T_OBJECT_OPERATOR","->",38],["T_STRING","setProductClassId",38],"(",["T_WHITESPACE","\n            ",38],["T_VARIABLE","$this",39],["T_OBJECT_OPERATOR","->",39],["T_STRING","taxClassManagement",39],["T_OBJECT_OPERATOR","->",39],["T_STRING","getTaxClassId",39],"(",["T_VARIABLE","$item",39],["T_OBJECT_OPERATOR","->",39],["T_STRING","getTaxClassKey",39],"(",")",")",["T_WHITESPACE","\n        ",39],")",";",["T_WHITESPACE","\n        ",40],["T_VARIABLE","$rate",41],["T_WHITESPACE"," ",41],"=",["T_WHITESPACE"," ",41],["T_VARIABLE","$this",41],["T_OBJECT_OPERATOR","->",41],["T_STRING","calculationTool",41],["T_OBJECT_OPERATOR","->",41],["T_STRING","getRate",41],"(",["T_VARIABLE","$taxRateRequest",41],")",";",["T_WHITESPACE","\n        ",41],["T_VARIABLE","$storeRate",42],["T_WHITESPACE"," ",42],"=",["T_WHITESPACE"," ",42],["T_VARIABLE","$storeRate",42],["T_WHITESPACE"," ",42],"=",["T_WHITESPACE"," ",42],["T_VARIABLE","$this",42],["T_OBJECT_OPERATOR","->",42],["T_STRING","calculationTool",42],["T_OBJECT_OPERATOR","->",42],["T_STRING","getStoreRate",42],"(",["T_VARIABLE","$taxRateRequest",42],",",["T_WHITESPACE"," ",42],["T_VARIABLE","$this",42],["T_OBJECT_OPERATOR","->",42],["T_STRING","storeId",42],")",";",["T_WHITESPACE","\n\n        ",42],["T_COMMENT","\/\/ Calculate $priceInclTax\n",44],["T_WHITESPACE","        ",45],["T_VARIABLE","$applyTaxAfterDiscount",45],["T_WHITESPACE"," ",45],"=",["T_WHITESPACE"," ",45],["T_VARIABLE","$this",45],["T_OBJECT_OPERATOR","->",45],["T_STRING","config",45],["T_OBJECT_OPERATOR","->",45],["T_STRING","applyTaxAfterDiscount",45],"(",["T_VARIABLE","$this",45],["T_OBJECT_OPERATOR","->",45],["T_STRING","storeId",45],")",";",["T_WHITESPACE","\n        ",45],["T_VARIABLE","$priceInclTax",46],["T_WHITESPACE"," ",46],"=",["T_WHITESPACE"," ",46],["T_VARIABLE","$this",46],["T_OBJECT_OPERATOR","->",46],["T_STRING","calculationTool",46],["T_OBJECT_OPERATOR","->",46],["T_STRING","round",46],"(",["T_VARIABLE","$item",46],["T_OBJECT_OPERATOR","->",46],["T_STRING","getUnitPrice",46],"(",")",")",";",["T_WHITESPACE","\n        ",46],["T_IF","if",47],["T_WHITESPACE"," ",47],"(","!",["T_VARIABLE","$this",47],["T_OBJECT_OPERATOR","->",47],["T_STRING","isSameRateAsStore",47],"(",["T_VARIABLE","$rate",47],",",["T_WHITESPACE"," ",47],["T_VARIABLE","$storeRate",47],")",")",["T_WHITESPACE"," ",47],"{",["T_WHITESPACE","\n            ",47],["T_VARIABLE","$priceInclTax",48],["T_WHITESPACE"," ",48],"=",["T_WHITESPACE"," ",48],["T_VARIABLE","$this",48],["T_OBJECT_OPERATOR","->",48],["T_STRING","calculatePriceInclTax",48],"(",["T_VARIABLE","$priceInclTax",48],",",["T_WHITESPACE"," ",48],["T_VARIABLE","$storeRate",48],",",["T_WHITESPACE"," ",48],["T_VARIABLE","$rate",48],",",["T_WHITESPACE"," ",48],["T_VARIABLE","$round",48],")",";",["T_WHITESPACE","\n        ",48],"}",["T_WHITESPACE","\n        ",49],["T_VARIABLE","$uniTax",50],["T_WHITESPACE"," ",50],"=",["T_WHITESPACE"," ",50],["T_VARIABLE","$this",50],["T_OBJECT_OPERATOR","->",50],["T_STRING","calculationTool",50],["T_OBJECT_OPERATOR","->",50],["T_STRING","calcTaxAmount",50],"(",["T_VARIABLE","$priceInclTax",50],",",["T_WHITESPACE"," ",50],["T_VARIABLE","$rate",50],",",["T_WHITESPACE"," ",50],["T_STRING","true",50],",",["T_WHITESPACE"," ",50],["T_STRING","false",50],")",";",["T_WHITESPACE","\n        ",50],["T_VARIABLE","$deltaRoundingType",51],["T_WHITESPACE"," ",51],"=",["T_WHITESPACE"," ",51],["T_STRING","self",51],["T_DOUBLE_COLON","::",51],["T_STRING","KEY_REGULAR_DELTA_ROUNDING",51],";",["T_WHITESPACE","\n        ",51],["T_IF","if",52],["T_WHITESPACE"," ",52],"(",["T_VARIABLE","$applyTaxAfterDiscount",52],")",["T_WHITESPACE"," ",52],"{",["T_WHITESPACE","\n            ",52],["T_VARIABLE","$deltaRoundingType",53],["T_WHITESPACE"," ",53],"=",["T_WHITESPACE"," ",53],["T_STRING","self",53],["T_DOUBLE_COLON","::",53],["T_STRING","KEY_TAX_BEFORE_DISCOUNT_DELTA_ROUNDING",53],";",["T_WHITESPACE","\n        ",53],"}",["T_WHITESPACE","\n        ",54],["T_VARIABLE","$uniTax",55],["T_WHITESPACE"," ",55],"=",["T_WHITESPACE"," ",55],["T_VARIABLE","$this",55],["T_OBJECT_OPERATOR","->",55],["T_STRING","roundAmount",55],"(",["T_VARIABLE","$uniTax",55],",",["T_WHITESPACE"," ",55],["T_VARIABLE","$rate",55],",",["T_WHITESPACE"," ",55],["T_STRING","true",55],",",["T_WHITESPACE"," ",55],["T_VARIABLE","$deltaRoundingType",55],",",["T_WHITESPACE"," ",55],["T_VARIABLE","$round",55],",",["T_WHITESPACE"," ",55],["T_VARIABLE","$item",55],")",";",["T_WHITESPACE","\n        ",55],["T_VARIABLE","$price",56],["T_WHITESPACE"," ",56],"=",["T_WHITESPACE"," ",56],["T_VARIABLE","$priceInclTax",56],["T_WHITESPACE"," ",56],"-",["T_WHITESPACE"," ",56],["T_VARIABLE","$uniTax",56],";",["T_WHITESPACE","\n\n        ",56],["T_COMMENT","\/\/Handle discount\n",58],["T_WHITESPACE","        ",59],["T_VARIABLE","$discountTaxCompensationAmount",59],["T_WHITESPACE"," ",59],"=",["T_WHITESPACE"," ",59],["T_LNUMBER","0",59],";",["T_WHITESPACE","\n        ",59],["T_VARIABLE","$discountAmount",60],["T_WHITESPACE"," ",60],"=",["T_WHITESPACE"," ",60],["T_VARIABLE","$item",60],["T_OBJECT_OPERATOR","->",60],["T_STRING","getDiscountAmount",60],"(",")",";",["T_WHITESPACE","\n        ",60],["T_IF","if",61],["T_WHITESPACE"," ",61],"(",["T_VARIABLE","$applyTaxAfterDiscount",61],")",["T_WHITESPACE"," ",61],"{",["T_WHITESPACE","\n            ",61],["T_COMMENT","\/\/TODO: handle originalDiscountAmount\n",62],["T_WHITESPACE","            ",63],["T_VARIABLE","$unitDiscountAmount",63],["T_WHITESPACE"," ",63],"=",["T_WHITESPACE"," ",63],["T_VARIABLE","$discountAmount",63],["T_WHITESPACE"," ",63],"\/",["T_WHITESPACE"," ",63],["T_VARIABLE","$quantity",63],";",["T_WHITESPACE","\n            ",63],["T_VARIABLE","$taxableAmount",64],["T_WHITESPACE"," ",64],"=",["T_WHITESPACE"," ",64],["T_STRING","max",64],"(",["T_VARIABLE","$priceInclTax",64],["T_WHITESPACE"," ",64],"-",["T_WHITESPACE"," ",64],["T_VARIABLE","$unitDiscountAmount",64],",",["T_WHITESPACE"," ",64],["T_LNUMBER","0",64],")",";",["T_WHITESPACE","\n            ",64],["T_VARIABLE","$unitTaxAfterDiscount",65],["T_WHITESPACE"," ",65],"=",["T_WHITESPACE"," ",65],["T_VARIABLE","$this",65],["T_OBJECT_OPERATOR","->",65],["T_STRING","calculationTool",65],["T_OBJECT_OPERATOR","->",65],["T_STRING","calcTaxAmount",65],"(",["T_WHITESPACE","\n                ",65],["T_VARIABLE","$taxableAmount",66],",",["T_WHITESPACE","\n                ",66],["T_VARIABLE","$rate",67],",",["T_WHITESPACE","\n                ",67],["T_STRING","true",68],",",["T_WHITESPACE","\n                ",68],["T_STRING","false",69],["T_WHITESPACE","\n            ",69],")",";",["T_WHITESPACE","\n            ",70],["T_VARIABLE","$unitTaxAfterDiscount",71],["T_WHITESPACE"," ",71],"=",["T_WHITESPACE"," ",71],["T_VARIABLE","$this",71],["T_OBJECT_OPERATOR","->",71],["T_STRING","roundAmount",71],"(",["T_WHITESPACE","\n                ",71],["T_VARIABLE","$unitTaxAfterDiscount",72],",",["T_WHITESPACE","\n                ",72],["T_VARIABLE","$rate",73],",",["T_WHITESPACE","\n                ",73],["T_STRING","true",74],",",["T_WHITESPACE","\n                ",74],["T_STRING","self",75],["T_DOUBLE_COLON","::",75],["T_STRING","KEY_REGULAR_DELTA_ROUNDING",75],",",["T_WHITESPACE","\n                ",75],["T_VARIABLE","$round",76],",",["T_WHITESPACE","\n                ",76],["T_VARIABLE","$item",77],["T_WHITESPACE","\n            ",77],")",";",["T_WHITESPACE","\n\n            ",78],["T_COMMENT","\/\/ Set discount tax compensation\n",80],["T_WHITESPACE","            ",81],["T_VARIABLE","$unitDiscountTaxCompensationAmount",81],["T_WHITESPACE"," ",81],"=",["T_WHITESPACE"," ",81],["T_VARIABLE","$uniTax",81],["T_WHITESPACE"," ",81],"-",["T_WHITESPACE"," ",81],["T_VARIABLE","$unitTaxAfterDiscount",81],";",["T_WHITESPACE","\n            ",81],["T_VARIABLE","$discountTaxCompensationAmount",82],["T_WHITESPACE"," ",82],"=",["T_WHITESPACE"," ",82],["T_VARIABLE","$unitDiscountTaxCompensationAmount",82],["T_WHITESPACE"," ",82],"*",["T_WHITESPACE"," ",82],["T_VARIABLE","$quantity",82],";",["T_WHITESPACE","\n            ",82],["T_VARIABLE","$uniTax",83],["T_WHITESPACE"," ",83],"=",["T_WHITESPACE"," ",83],["T_VARIABLE","$unitTaxAfterDiscount",83],";",["T_WHITESPACE","\n        ",83],"}",["T_WHITESPACE","\n        ",84],["T_VARIABLE","$rowTax",85],["T_WHITESPACE"," ",85],"=",["T_WHITESPACE"," ",85],["T_VARIABLE","$uniTax",85],["T_WHITESPACE"," ",85],"*",["T_WHITESPACE"," ",85],["T_VARIABLE","$quantity",85],";",["T_WHITESPACE","\n\n        ",85],["T_COMMENT","\/\/ Calculate applied taxes\n",87],["T_WHITESPACE","        ",88],["T_DOC_COMMENT","\/** @var  \\Magento\\Tax\\Api\\Data\\AppliedTaxInterface[] $appliedTaxes *\/",88],["T_WHITESPACE","\n        ",88],["T_VARIABLE","$appliedRates",89],["T_WHITESPACE"," ",89],"=",["T_WHITESPACE"," ",89],["T_VARIABLE","$this",89],["T_OBJECT_OPERATOR","->",89],["T_STRING","calculationTool",89],["T_OBJECT_OPERATOR","->",89],["T_STRING","getAppliedRates",89],"(",["T_VARIABLE","$taxRateRequest",89],")",";",["T_WHITESPACE","\n        ",89],["T_VARIABLE","$appliedTaxes",90],["T_WHITESPACE"," ",90],"=",["T_WHITESPACE"," ",90],["T_VARIABLE","$this",90],["T_OBJECT_OPERATOR","->",90],["T_STRING","getAppliedTaxes",90],"(",["T_VARIABLE","$rowTax",90],",",["T_WHITESPACE"," ",90],["T_VARIABLE","$rate",90],",",["T_WHITESPACE"," ",90],["T_VARIABLE","$appliedRates",90],")",";",["T_WHITESPACE","\n\n        ",90],["T_RETURN","return",92],["T_WHITESPACE"," ",92],["T_VARIABLE","$this",92],["T_OBJECT_OPERATOR","->",92],["T_STRING","taxDetailsItemDataObjectFactory",92],["T_OBJECT_OPERATOR","->",92],["T_STRING","create",92],"(",")",["T_WHITESPACE","\n            ",92],["T_OBJECT_OPERATOR","->",93],["T_STRING","setCode",93],"(",["T_VARIABLE","$item",93],["T_OBJECT_OPERATOR","->",93],["T_STRING","getCode",93],"(",")",")",["T_WHITESPACE","\n            ",93],["T_OBJECT_OPERATOR","->",94],["T_STRING","setType",94],"(",["T_VARIABLE","$item",94],["T_OBJECT_OPERATOR","->",94],["T_STRING","getType",94],"(",")",")",["T_WHITESPACE","\n            ",94],["T_OBJECT_OPERATOR","->",95],["T_STRING","setRowTax",95],"(",["T_VARIABLE","$rowTax",95],")",["T_WHITESPACE","\n            ",95],["T_OBJECT_OPERATOR","->",96],["T_STRING","setPrice",96],"(",["T_VARIABLE","$price",96],")",["T_WHITESPACE","\n            ",96],["T_OBJECT_OPERATOR","->",97],["T_STRING","setPriceInclTax",97],"(",["T_VARIABLE","$priceInclTax",97],")",["T_WHITESPACE","\n            ",97],["T_OBJECT_OPERATOR","->",98],["T_STRING","setRowTotal",98],"(",["T_VARIABLE","$price",98],["T_WHITESPACE"," ",98],"*",["T_WHITESPACE"," ",98],["T_VARIABLE","$quantity",98],")",["T_WHITESPACE","\n            ",98],["T_OBJECT_OPERATOR","->",99],["T_STRING","setRowTotalInclTax",99],"(",["T_VARIABLE","$priceInclTax",99],["T_WHITESPACE"," ",99],"*",["T_WHITESPACE"," ",99],["T_VARIABLE","$quantity",99],")",["T_WHITESPACE","\n            ",99],["T_OBJECT_OPERATOR","->",100],["T_STRING","setDiscountTaxCompensationAmount",100],"(",["T_VARIABLE","$discountTaxCompensationAmount",100],")",["T_WHITESPACE","\n            ",100],["T_OBJECT_OPERATOR","->",101],["T_STRING","setAssociatedItemCode",101],"(",["T_VARIABLE","$item",101],["T_OBJECT_OPERATOR","->",101],["T_STRING","getAssociatedItemCode",101],"(",")",")",["T_WHITESPACE","\n            ",101],["T_OBJECT_OPERATOR","->",102],["T_STRING","setTaxPercent",102],"(",["T_VARIABLE","$rate",102],")",["T_WHITESPACE","\n            ",102],["T_OBJECT_OPERATOR","->",103],["T_STRING","setAppliedTaxes",103],"(",["T_VARIABLE","$appliedTaxes",103],")",";",["T_WHITESPACE","\n    ",103],"}",["T_WHITESPACE","\n\n    ",104],["T_DOC_COMMENT","\/**\n     * {@inheritdoc}\n     *\/",106],["T_WHITESPACE","\n    ",108],["T_PROTECTED","protected",109],["T_WHITESPACE"," ",109],["T_FUNCTION","function",109],["T_WHITESPACE"," ",109],["T_STRING","calculateWithTaxNotInPrice",109],"(",["T_STRING","QuoteDetailsItemInterface",109],["T_WHITESPACE"," ",109],["T_VARIABLE","$item",109],",",["T_WHITESPACE"," ",109],["T_VARIABLE","$quantity",109],",",["T_WHITESPACE"," ",109],["T_VARIABLE","$round",109],["T_WHITESPACE"," ",109],"=",["T_WHITESPACE"," ",109],["T_STRING","true",109],")",["T_WHITESPACE","\n    ",109],"{",["T_WHITESPACE","\n        ",110],["T_VARIABLE","$taxRateRequest",111],["T_WHITESPACE"," ",111],"=",["T_WHITESPACE"," ",111],["T_VARIABLE","$this",111],["T_OBJECT_OPERATOR","->",111],["T_STRING","getAddressRateRequest",111],"(",")",["T_OBJECT_OPERATOR","->",111],["T_STRING","setProductClassId",111],"(",["T_WHITESPACE","\n            ",111],["T_VARIABLE","$this",112],["T_OBJECT_OPERATOR","->",112],["T_STRING","taxClassManagement",112],["T_OBJECT_OPERATOR","->",112],["T_STRING","getTaxClassId",112],"(",["T_VARIABLE","$item",112],["T_OBJECT_OPERATOR","->",112],["T_STRING","getTaxClassKey",112],"(",")",")",["T_WHITESPACE","\n        ",112],")",";",["T_WHITESPACE","\n        ",113],["T_VARIABLE","$rate",114],["T_WHITESPACE"," ",114],"=",["T_WHITESPACE"," ",114],["T_VARIABLE","$this",114],["T_OBJECT_OPERATOR","->",114],["T_STRING","calculationTool",114],["T_OBJECT_OPERATOR","->",114],["T_STRING","getRate",114],"(",["T_VARIABLE","$taxRateRequest",114],")",";",["T_WHITESPACE","\n        ",114],["T_VARIABLE","$appliedRates",115],["T_WHITESPACE"," ",115],"=",["T_WHITESPACE"," ",115],["T_VARIABLE","$this",115],["T_OBJECT_OPERATOR","->",115],["T_STRING","calculationTool",115],["T_OBJECT_OPERATOR","->",115],["T_STRING","getAppliedRates",115],"(",["T_VARIABLE","$taxRateRequest",115],")",";",["T_WHITESPACE","\n\n        ",115],["T_VARIABLE","$applyTaxAfterDiscount",117],["T_WHITESPACE"," ",117],"=",["T_WHITESPACE"," ",117],["T_VARIABLE","$this",117],["T_OBJECT_OPERATOR","->",117],["T_STRING","config",117],["T_OBJECT_OPERATOR","->",117],["T_STRING","applyTaxAfterDiscount",117],"(",["T_VARIABLE","$this",117],["T_OBJECT_OPERATOR","->",117],["T_STRING","storeId",117],")",";",["T_WHITESPACE","\n        ",117],["T_VARIABLE","$discountAmount",118],["T_WHITESPACE"," ",118],"=",["T_WHITESPACE"," ",118],["T_VARIABLE","$item",118],["T_OBJECT_OPERATOR","->",118],["T_STRING","getDiscountAmount",118],"(",")",";",["T_WHITESPACE","\n        ",118],["T_VARIABLE","$discountTaxCompensationAmount",119],["T_WHITESPACE"," ",119],"=",["T_WHITESPACE"," ",119],["T_LNUMBER","0",119],";",["T_WHITESPACE","\n\n        ",119],["T_COMMENT","\/\/ Calculate $price\n",121],["T_WHITESPACE","        ",122],["T_VARIABLE","$price",122],["T_WHITESPACE"," ",122],"=",["T_WHITESPACE"," ",122],["T_VARIABLE","$this",122],["T_OBJECT_OPERATOR","->",122],["T_STRING","calculationTool",122],["T_OBJECT_OPERATOR","->",122],["T_STRING","round",122],"(",["T_VARIABLE","$item",122],["T_OBJECT_OPERATOR","->",122],["T_STRING","getUnitPrice",122],"(",")",")",";",["T_WHITESPACE","\n        ",122],["T_VARIABLE","$unitTaxes",123],["T_WHITESPACE"," ",123],"=",["T_WHITESPACE"," ",123],"[","]",";",["T_WHITESPACE","\n        ",123],["T_VARIABLE","$unitTaxesBeforeDiscount",124],["T_WHITESPACE"," ",124],"=",["T_WHITESPACE"," ",124],"[","]",";",["T_WHITESPACE","\n        ",124],["T_VARIABLE","$appliedTaxes",125],["T_WHITESPACE"," ",125],"=",["T_WHITESPACE"," ",125],"[","]",";",["T_WHITESPACE","\n        ",125],["T_COMMENT","\/\/Apply each tax rate separately\n",126],["T_WHITESPACE","        ",127],["T_FOREACH","foreach",127],["T_WHITESPACE"," ",127],"(",["T_VARIABLE","$appliedRates",127],["T_WHITESPACE"," ",127],["T_AS","as",127],["T_WHITESPACE"," ",127],["T_VARIABLE","$appliedRate",127],")",["T_WHITESPACE"," ",127],"{",["T_WHITESPACE","\n            ",127],["T_VARIABLE","$taxId",128],["T_WHITESPACE"," ",128],"=",["T_WHITESPACE"," ",128],["T_VARIABLE","$appliedRate",128],"[",["T_CONSTANT_ENCAPSED_STRING","'id'",128],"]",";",["T_WHITESPACE","\n            ",128],["T_VARIABLE","$taxRate",129],["T_WHITESPACE"," ",129],"=",["T_WHITESPACE"," ",129],["T_VARIABLE","$appliedRate",129],"[",["T_CONSTANT_ENCAPSED_STRING","'percent'",129],"]",";",["T_WHITESPACE","\n            ",129],["T_VARIABLE","$unitTaxPerRate",130],["T_WHITESPACE"," ",130],"=",["T_WHITESPACE"," ",130],["T_VARIABLE","$this",130],["T_OBJECT_OPERATOR","->",130],["T_STRING","calculationTool",130],["T_OBJECT_OPERATOR","->",130],["T_STRING","calcTaxAmount",130],"(",["T_VARIABLE","$price",130],",",["T_WHITESPACE"," ",130],["T_VARIABLE","$taxRate",130],",",["T_WHITESPACE"," ",130],["T_STRING","false",130],",",["T_WHITESPACE"," ",130],["T_STRING","false",130],")",";",["T_WHITESPACE","\n            ",130],["T_VARIABLE","$deltaRoundingType",131],["T_WHITESPACE"," ",131],"=",["T_WHITESPACE"," ",131],["T_STRING","self",131],["T_DOUBLE_COLON","::",131],["T_STRING","KEY_REGULAR_DELTA_ROUNDING",131],";",["T_WHITESPACE","\n            ",131],["T_IF","if",132],["T_WHITESPACE"," ",132],"(",["T_VARIABLE","$applyTaxAfterDiscount",132],")",["T_WHITESPACE"," ",132],"{",["T_WHITESPACE","\n                ",132],["T_VARIABLE","$deltaRoundingType",133],["T_WHITESPACE"," ",133],"=",["T_WHITESPACE"," ",133],["T_STRING","self",133],["T_DOUBLE_COLON","::",133],["T_STRING","KEY_TAX_BEFORE_DISCOUNT_DELTA_ROUNDING",133],";",["T_WHITESPACE","\n            ",133],"}",["T_WHITESPACE","\n            ",134],["T_VARIABLE","$unitTaxPerRate",135],["T_WHITESPACE"," ",135],"=",["T_WHITESPACE"," ",135],["T_VARIABLE","$this",135],["T_OBJECT_OPERATOR","->",135],["T_STRING","roundAmount",135],"(",["T_VARIABLE","$unitTaxPerRate",135],",",["T_WHITESPACE"," ",135],["T_VARIABLE","$taxId",135],",",["T_WHITESPACE"," ",135],["T_STRING","false",135],",",["T_WHITESPACE"," ",135],["T_VARIABLE","$deltaRoundingType",135],",",["T_WHITESPACE"," ",135],["T_VARIABLE","$round",135],",",["T_WHITESPACE"," ",135],["T_VARIABLE","$item",135],")",";",["T_WHITESPACE","\n            ",135],["T_VARIABLE","$unitTaxAfterDiscount",136],["T_WHITESPACE"," ",136],"=",["T_WHITESPACE"," ",136],["T_VARIABLE","$unitTaxPerRate",136],";",["T_WHITESPACE","\n\n            ",136],["T_COMMENT","\/\/Handle discount\n",138],["T_WHITESPACE","            ",139],["T_IF","if",139],["T_WHITESPACE"," ",139],"(",["T_VARIABLE","$applyTaxAfterDiscount",139],")",["T_WHITESPACE"," ",139],"{",["T_WHITESPACE","\n                ",139],["T_COMMENT","\/\/TODO: handle originalDiscountAmount\n",140],["T_WHITESPACE","                ",141],["T_VARIABLE","$unitDiscountAmount",141],["T_WHITESPACE"," ",141],"=",["T_WHITESPACE"," ",141],["T_VARIABLE","$discountAmount",141],["T_WHITESPACE"," ",141],"\/",["T_WHITESPACE"," ",141],["T_VARIABLE","$quantity",141],";",["T_WHITESPACE","\n                ",141],["T_VARIABLE","$taxableAmount",142],["T_WHITESPACE"," ",142],"=",["T_WHITESPACE"," ",142],["T_STRING","max",142],"(",["T_VARIABLE","$price",142],["T_WHITESPACE"," ",142],"-",["T_WHITESPACE"," ",142],["T_VARIABLE","$unitDiscountAmount",142],",",["T_WHITESPACE"," ",142],["T_LNUMBER","0",142],")",";",["T_WHITESPACE","\n                ",142],["T_VARIABLE","$unitTaxAfterDiscount",143],["T_WHITESPACE"," ",143],"=",["T_WHITESPACE"," ",143],["T_VARIABLE","$this",143],["T_OBJECT_OPERATOR","->",143],["T_STRING","calculationTool",143],["T_OBJECT_OPERATOR","->",143],["T_STRING","calcTaxAmount",143],"(",["T_WHITESPACE","\n                    ",143],["T_VARIABLE","$taxableAmount",144],",",["T_WHITESPACE","\n                    ",144],["T_VARIABLE","$taxRate",145],",",["T_WHITESPACE","\n                    ",145],["T_STRING","false",146],",",["T_WHITESPACE","\n                    ",146],["T_STRING","false",147],["T_WHITESPACE","\n                ",147],")",";",["T_WHITESPACE","\n                ",148],["T_VARIABLE","$unitTaxAfterDiscount",149],["T_WHITESPACE"," ",149],"=",["T_WHITESPACE"," ",149],["T_VARIABLE","$this",149],["T_OBJECT_OPERATOR","->",149],["T_STRING","roundAmount",149],"(",["T_WHITESPACE","\n                    ",149],["T_VARIABLE","$unitTaxAfterDiscount",150],",",["T_WHITESPACE","\n                    ",150],["T_VARIABLE","$taxId",151],",",["T_WHITESPACE","\n                    ",151],["T_STRING","false",152],",",["T_WHITESPACE","\n                    ",152],["T_STRING","self",153],["T_DOUBLE_COLON","::",153],["T_STRING","KEY_REGULAR_DELTA_ROUNDING",153],",",["T_WHITESPACE","\n                    ",153],["T_VARIABLE","$round",154],",",["T_WHITESPACE","\n                    ",154],["T_VARIABLE","$item",155],["T_WHITESPACE","\n                ",155],")",";",["T_WHITESPACE","\n            ",156],"}",["T_WHITESPACE","\n            ",157],["T_VARIABLE","$appliedTaxes",158],"[",["T_VARIABLE","$taxId",158],"]",["T_WHITESPACE"," ",158],"=",["T_WHITESPACE"," ",158],["T_VARIABLE","$this",158],["T_OBJECT_OPERATOR","->",158],["T_STRING","getAppliedTax",158],"(",["T_WHITESPACE","\n                ",158],["T_VARIABLE","$unitTaxAfterDiscount",159],["T_WHITESPACE"," ",159],"*",["T_WHITESPACE"," ",159],["T_VARIABLE","$quantity",159],",",["T_WHITESPACE","\n                ",159],["T_VARIABLE","$appliedRate",160],["T_WHITESPACE","\n            ",160],")",";",["T_WHITESPACE","\n\n            ",161],["T_VARIABLE","$unitTaxes",163],"[","]",["T_WHITESPACE"," ",163],"=",["T_WHITESPACE"," ",163],["T_VARIABLE","$unitTaxAfterDiscount",163],";",["T_WHITESPACE","\n            ",163],["T_VARIABLE","$unitTaxesBeforeDiscount",164],"[","]",["T_WHITESPACE"," ",164],"=",["T_WHITESPACE"," ",164],["T_VARIABLE","$unitTaxPerRate",164],";",["T_WHITESPACE","\n        ",164],"}",["T_WHITESPACE","\n        ",165],["T_VARIABLE","$unitTax",166],["T_WHITESPACE"," ",166],"=",["T_WHITESPACE"," ",166],["T_STRING","array_sum",166],"(",["T_VARIABLE","$unitTaxes",166],")",";",["T_WHITESPACE","\n        ",166],["T_VARIABLE","$unitTaxBeforeDiscount",167],["T_WHITESPACE"," ",167],"=",["T_WHITESPACE"," ",167],["T_STRING","array_sum",167],"(",["T_VARIABLE","$unitTaxesBeforeDiscount",167],")",";",["T_WHITESPACE","\n\n        ",167],["T_VARIABLE","$rowTax",169],["T_WHITESPACE"," ",169],"=",["T_WHITESPACE"," ",169],["T_VARIABLE","$unitTax",169],["T_WHITESPACE"," ",169],"*",["T_WHITESPACE"," ",169],["T_VARIABLE","$quantity",169],";",["T_WHITESPACE","\n        ",169],["T_VARIABLE","$priceInclTax",170],["T_WHITESPACE"," ",170],"=",["T_WHITESPACE"," ",170],["T_VARIABLE","$price",170],["T_WHITESPACE"," ",170],"+",["T_WHITESPACE"," ",170],["T_VARIABLE","$unitTaxBeforeDiscount",170],";",["T_WHITESPACE","\n\n        ",170],["T_RETURN","return",172],["T_WHITESPACE"," ",172],["T_VARIABLE","$this",172],["T_OBJECT_OPERATOR","->",172],["T_STRING","taxDetailsItemDataObjectFactory",172],["T_OBJECT_OPERATOR","->",172],["T_STRING","create",172],"(",")",["T_WHITESPACE","\n            ",172],["T_OBJECT_OPERATOR","->",173],["T_STRING","setCode",173],"(",["T_VARIABLE","$item",173],["T_OBJECT_OPERATOR","->",173],["T_STRING","getCode",173],"(",")",")",["T_WHITESPACE","\n            ",173],["T_OBJECT_OPERATOR","->",174],["T_STRING","setType",174],"(",["T_VARIABLE","$item",174],["T_OBJECT_OPERATOR","->",174],["T_STRING","getType",174],"(",")",")",["T_WHITESPACE","\n            ",174],["T_OBJECT_OPERATOR","->",175],["T_STRING","setRowTax",175],"(",["T_VARIABLE","$rowTax",175],")",["T_WHITESPACE","\n            ",175],["T_OBJECT_OPERATOR","->",176],["T_STRING","setPrice",176],"(",["T_VARIABLE","$price",176],")",["T_WHITESPACE","\n            ",176],["T_OBJECT_OPERATOR","->",177],["T_STRING","setPriceInclTax",177],"(",["T_VARIABLE","$priceInclTax",177],")",["T_WHITESPACE","\n            ",177],["T_OBJECT_OPERATOR","->",178],["T_STRING","setRowTotal",178],"(",["T_VARIABLE","$price",178],["T_WHITESPACE"," ",178],"*",["T_WHITESPACE"," ",178],["T_VARIABLE","$quantity",178],")",["T_WHITESPACE","\n            ",178],["T_OBJECT_OPERATOR","->",179],["T_STRING","setRowTotalInclTax",179],"(",["T_VARIABLE","$priceInclTax",179],["T_WHITESPACE"," ",179],"*",["T_WHITESPACE"," ",179],["T_VARIABLE","$quantity",179],")",["T_WHITESPACE","\n            ",179],["T_OBJECT_OPERATOR","->",180],["T_STRING","setDiscountTaxCompensationAmount",180],"(",["T_VARIABLE","$discountTaxCompensationAmount",180],")",["T_WHITESPACE","\n            ",180],["T_OBJECT_OPERATOR","->",181],["T_STRING","setAssociatedItemCode",181],"(",["T_VARIABLE","$item",181],["T_OBJECT_OPERATOR","->",181],["T_STRING","getAssociatedItemCode",181],"(",")",")",["T_WHITESPACE","\n            ",181],["T_OBJECT_OPERATOR","->",182],["T_STRING","setTaxPercent",182],"(",["T_VARIABLE","$rate",182],")",["T_WHITESPACE","\n            ",182],["T_OBJECT_OPERATOR","->",183],["T_STRING","setAppliedTaxes",183],"(",["T_VARIABLE","$appliedTaxes",183],")",";",["T_WHITESPACE","\n    ",183],"}",["T_WHITESPACE","\n",184],"}",["T_WHITESPACE","\n",185]]