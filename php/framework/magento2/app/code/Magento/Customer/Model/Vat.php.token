[["T_OPEN_TAG","<?php\n",1],["T_DOC_COMMENT","\/**\n * Copyright \u00c2\u00a9 2013-2017 Magento, Inc. All rights reserved.\n * See COPYING.txt for license details.\n *\/",2],["T_WHITESPACE","\n",5],["T_NAMESPACE","namespace",6],["T_WHITESPACE"," ",6],["T_STRING","Magento",6],["T_NS_SEPARATOR","\\",6],["T_STRING","Customer",6],["T_NS_SEPARATOR","\\",6],["T_STRING","Model",6],";",["T_WHITESPACE","\n\n",6],["T_USE","use",8],["T_WHITESPACE"," ",8],["T_STRING","Magento",8],["T_NS_SEPARATOR","\\",8],["T_STRING","Framework",8],["T_NS_SEPARATOR","\\",8],["T_STRING","App",8],["T_NS_SEPARATOR","\\",8],["T_STRING","Config",8],["T_NS_SEPARATOR","\\",8],["T_STRING","ScopeConfigInterface",8],";",["T_WHITESPACE","\n",8],["T_USE","use",9],["T_WHITESPACE"," ",9],["T_STRING","Magento",9],["T_NS_SEPARATOR","\\",9],["T_STRING","Framework",9],["T_NS_SEPARATOR","\\",9],["T_STRING","DataObject",9],";",["T_WHITESPACE","\n",9],["T_USE","use",10],["T_WHITESPACE"," ",10],["T_STRING","Magento",10],["T_NS_SEPARATOR","\\",10],["T_STRING","Framework",10],["T_NS_SEPARATOR","\\",10],["T_STRING","Exception",10],["T_NS_SEPARATOR","\\",10],["T_STRING","LocalizedException",10],";",["T_WHITESPACE","\n",10],["T_USE","use",11],["T_WHITESPACE"," ",11],["T_STRING","Magento",11],["T_NS_SEPARATOR","\\",11],["T_STRING","Store",11],["T_NS_SEPARATOR","\\",11],["T_STRING","Model",11],["T_NS_SEPARATOR","\\",11],["T_STRING","Store",11],";",["T_WHITESPACE","\n",11],["T_USE","use",12],["T_WHITESPACE"," ",12],["T_STRING","Magento",12],["T_NS_SEPARATOR","\\",12],["T_STRING","Store",12],["T_NS_SEPARATOR","\\",12],["T_STRING","Model",12],["T_NS_SEPARATOR","\\",12],["T_STRING","Information",12],["T_WHITESPACE"," ",12],["T_AS","as",12],["T_WHITESPACE"," ",12],["T_STRING","StoreInformation",12],";",["T_WHITESPACE","\n",12],["T_USE","use",13],["T_WHITESPACE"," ",13],["T_STRING","Psr",13],["T_NS_SEPARATOR","\\",13],["T_STRING","Log",13],["T_NS_SEPARATOR","\\",13],["T_STRING","LoggerInterface",13],["T_WHITESPACE"," ",13],["T_AS","as",13],["T_WHITESPACE"," ",13],["T_STRING","PsrLogger",13],";",["T_WHITESPACE","\n",13],["T_USE","use",14],["T_WHITESPACE"," ",14],["T_STRING","Magento",14],["T_NS_SEPARATOR","\\",14],["T_STRING","Store",14],["T_NS_SEPARATOR","\\",14],["T_STRING","Model",14],["T_NS_SEPARATOR","\\",14],["T_STRING","ScopeInterface",14],";",["T_WHITESPACE","\n\n",14],["T_DOC_COMMENT","\/**\n * Customer VAT model\n *\/",16],["T_WHITESPACE","\n",18],["T_CLASS","class",19],["T_WHITESPACE"," ",19],["T_STRING","Vat",19],["T_WHITESPACE","\n",19],"{",["T_WHITESPACE","\n    ",20],["T_DOC_COMMENT","\/**\n     * Config paths to VAT related customer groups\n     *\/",21],["T_WHITESPACE","\n    ",23],["T_CONST","const",24],["T_WHITESPACE"," ",24],["T_STRING","XML_PATH_CUSTOMER_VIV_INTRA_UNION_GROUP",24],["T_WHITESPACE"," ",24],"=",["T_WHITESPACE"," ",24],["T_CONSTANT_ENCAPSED_STRING","'customer\/create_account\/viv_intra_union_group'",24],";",["T_WHITESPACE","\n\n    ",24],["T_CONST","const",26],["T_WHITESPACE"," ",26],["T_STRING","XML_PATH_CUSTOMER_VIV_DOMESTIC_GROUP",26],["T_WHITESPACE"," ",26],"=",["T_WHITESPACE"," ",26],["T_CONSTANT_ENCAPSED_STRING","'customer\/create_account\/viv_domestic_group'",26],";",["T_WHITESPACE","\n\n    ",26],["T_CONST","const",28],["T_WHITESPACE"," ",28],["T_STRING","XML_PATH_CUSTOMER_VIV_INVALID_GROUP",28],["T_WHITESPACE"," ",28],"=",["T_WHITESPACE"," ",28],["T_CONSTANT_ENCAPSED_STRING","'customer\/create_account\/viv_invalid_group'",28],";",["T_WHITESPACE","\n\n    ",28],["T_CONST","const",30],["T_WHITESPACE"," ",30],["T_STRING","XML_PATH_CUSTOMER_VIV_ERROR_GROUP",30],["T_WHITESPACE"," ",30],"=",["T_WHITESPACE"," ",30],["T_CONSTANT_ENCAPSED_STRING","'customer\/create_account\/viv_error_group'",30],";",["T_WHITESPACE","\n\n    ",30],["T_DOC_COMMENT","\/**\n     * VAT class constants\n     *\/",32],["T_WHITESPACE","\n    ",34],["T_CONST","const",35],["T_WHITESPACE"," ",35],["T_STRING","VAT_CLASS_DOMESTIC",35],["T_WHITESPACE"," ",35],"=",["T_WHITESPACE"," ",35],["T_CONSTANT_ENCAPSED_STRING","'domestic'",35],";",["T_WHITESPACE","\n\n    ",35],["T_CONST","const",37],["T_WHITESPACE"," ",37],["T_STRING","VAT_CLASS_INTRA_UNION",37],["T_WHITESPACE"," ",37],"=",["T_WHITESPACE"," ",37],["T_CONSTANT_ENCAPSED_STRING","'intra_union'",37],";",["T_WHITESPACE","\n\n    ",37],["T_CONST","const",39],["T_WHITESPACE"," ",39],["T_STRING","VAT_CLASS_INVALID",39],["T_WHITESPACE"," ",39],"=",["T_WHITESPACE"," ",39],["T_CONSTANT_ENCAPSED_STRING","'invalid'",39],";",["T_WHITESPACE","\n\n    ",39],["T_CONST","const",41],["T_WHITESPACE"," ",41],["T_STRING","VAT_CLASS_ERROR",41],["T_WHITESPACE"," ",41],"=",["T_WHITESPACE"," ",41],["T_CONSTANT_ENCAPSED_STRING","'error'",41],";",["T_WHITESPACE","\n\n    ",41],["T_DOC_COMMENT","\/**\n     * WSDL of VAT validation service\n     *\n     *\/",43],["T_WHITESPACE","\n    ",46],["T_CONST","const",47],["T_WHITESPACE"," ",47],["T_STRING","VAT_VALIDATION_WSDL_URL",47],["T_WHITESPACE"," ",47],"=",["T_WHITESPACE"," ",47],["T_CONSTANT_ENCAPSED_STRING","'http:\/\/ec.europa.eu\/taxation_customs\/vies\/services\/checkVatService?wsdl'",47],";",["T_WHITESPACE","\n\n    ",47],["T_DOC_COMMENT","\/**\n     * Config path to option that enables\/disables automatic group assignment based on VAT\n     *\/",49],["T_WHITESPACE","\n    ",51],["T_CONST","const",52],["T_WHITESPACE"," ",52],["T_STRING","XML_PATH_CUSTOMER_GROUP_AUTO_ASSIGN",52],["T_WHITESPACE"," ",52],"=",["T_WHITESPACE"," ",52],["T_CONSTANT_ENCAPSED_STRING","'customer\/create_account\/auto_group_assign'",52],";",["T_WHITESPACE","\n\n    ",52],["T_DOC_COMMENT","\/**\n     * Config path to UE country list\n     *\/",54],["T_WHITESPACE","\n    ",56],["T_CONST","const",57],["T_WHITESPACE"," ",57],["T_STRING","XML_PATH_EU_COUNTRIES_LIST",57],["T_WHITESPACE"," ",57],"=",["T_WHITESPACE"," ",57],["T_CONSTANT_ENCAPSED_STRING","'general\/country\/eu_countries'",57],";",["T_WHITESPACE","\n\n    ",57],["T_DOC_COMMENT","\/**\n     * @var ScopeConfigInterface\n     *\/",59],["T_WHITESPACE","\n    ",61],["T_PROTECTED","protected",62],["T_WHITESPACE"," ",62],["T_VARIABLE","$scopeConfig",62],";",["T_WHITESPACE","\n\n    ",62],["T_DOC_COMMENT","\/**\n     * @var PsrLogger\n     *\/",64],["T_WHITESPACE","\n    ",66],["T_PROTECTED","protected",67],["T_WHITESPACE"," ",67],["T_VARIABLE","$logger",67],";",["T_WHITESPACE","\n\n    ",67],["T_DOC_COMMENT","\/**\n     * @param ScopeConfigInterface $scopeConfig\n     * @param PsrLogger $logger\n     *\/",69],["T_WHITESPACE","\n    ",72],["T_PUBLIC","public",73],["T_WHITESPACE"," ",73],["T_FUNCTION","function",73],["T_WHITESPACE"," ",73],["T_STRING","__construct",73],"(",["T_WHITESPACE","\n        ",73],["T_STRING","ScopeConfigInterface",74],["T_WHITESPACE"," ",74],["T_VARIABLE","$scopeConfig",74],",",["T_WHITESPACE","\n        ",74],["T_STRING","PsrLogger",75],["T_WHITESPACE"," ",75],["T_VARIABLE","$logger",75],["T_WHITESPACE","\n    ",75],")",["T_WHITESPACE"," ",76],"{",["T_WHITESPACE","\n        ",76],["T_VARIABLE","$this",77],["T_OBJECT_OPERATOR","->",77],["T_STRING","scopeConfig",77],["T_WHITESPACE"," ",77],"=",["T_WHITESPACE"," ",77],["T_VARIABLE","$scopeConfig",77],";",["T_WHITESPACE","\n        ",77],["T_VARIABLE","$this",78],["T_OBJECT_OPERATOR","->",78],["T_STRING","logger",78],["T_WHITESPACE"," ",78],"=",["T_WHITESPACE"," ",78],["T_VARIABLE","$logger",78],";",["T_WHITESPACE","\n    ",78],"}",["T_WHITESPACE","\n\n    ",79],["T_DOC_COMMENT","\/**\n     * Retrieve merchant country code\n     *\n     * @param Store|string|int|null $store\n     * @return string\n     *\/",81],["T_WHITESPACE","\n    ",86],["T_PUBLIC","public",87],["T_WHITESPACE"," ",87],["T_FUNCTION","function",87],["T_WHITESPACE"," ",87],["T_STRING","getMerchantCountryCode",87],"(",["T_VARIABLE","$store",87],["T_WHITESPACE"," ",87],"=",["T_WHITESPACE"," ",87],["T_STRING","null",87],")",["T_WHITESPACE","\n    ",87],"{",["T_WHITESPACE","\n        ",88],["T_RETURN","return",89],["T_WHITESPACE"," ",89],["T_STRING_CAST","(string)",89],["T_VARIABLE","$this",89],["T_OBJECT_OPERATOR","->",89],["T_STRING","scopeConfig",89],["T_OBJECT_OPERATOR","->",89],["T_STRING","getValue",89],"(",["T_WHITESPACE","\n            ",89],["T_STRING","StoreInformation",90],["T_DOUBLE_COLON","::",90],["T_STRING","XML_PATH_STORE_INFO_COUNTRY_CODE",90],",",["T_WHITESPACE","\n            ",90],["T_STRING","ScopeInterface",91],["T_DOUBLE_COLON","::",91],["T_STRING","SCOPE_STORE",91],",",["T_WHITESPACE","\n            ",91],["T_VARIABLE","$store",92],["T_WHITESPACE","\n        ",92],")",";",["T_WHITESPACE","\n    ",93],"}",["T_WHITESPACE","\n\n    ",94],["T_DOC_COMMENT","\/**\n     * Retrieve merchant VAT number\n     *\n     * @param Store|string|int|null $store\n     * @return string\n     *\/",96],["T_WHITESPACE","\n    ",101],["T_PUBLIC","public",102],["T_WHITESPACE"," ",102],["T_FUNCTION","function",102],["T_WHITESPACE"," ",102],["T_STRING","getMerchantVatNumber",102],"(",["T_VARIABLE","$store",102],["T_WHITESPACE"," ",102],"=",["T_WHITESPACE"," ",102],["T_STRING","null",102],")",["T_WHITESPACE","\n    ",102],"{",["T_WHITESPACE","\n        ",103],["T_RETURN","return",104],["T_WHITESPACE"," ",104],["T_STRING_CAST","(string)",104],["T_VARIABLE","$this",104],["T_OBJECT_OPERATOR","->",104],["T_STRING","scopeConfig",104],["T_OBJECT_OPERATOR","->",104],["T_STRING","getValue",104],"(",["T_WHITESPACE","\n            ",104],["T_STRING","StoreInformation",105],["T_DOUBLE_COLON","::",105],["T_STRING","XML_PATH_STORE_INFO_VAT_NUMBER",105],",",["T_WHITESPACE","\n            ",105],["T_STRING","ScopeInterface",106],["T_DOUBLE_COLON","::",106],["T_STRING","SCOPE_STORE",106],",",["T_WHITESPACE","\n            ",106],["T_VARIABLE","$store",107],["T_WHITESPACE","\n        ",107],")",";",["T_WHITESPACE","\n    ",108],"}",["T_WHITESPACE","\n\n    ",109],["T_DOC_COMMENT","\/**\n     * Retrieve customer group ID based on his VAT number\n     *\n     * @param string $customerCountryCode\n     * @param DataObject $vatValidationResult\n     * @param \\Magento\\Store\\Model\\Store|string|int $store\n     * @return null|int\n     *\/",111],["T_WHITESPACE","\n    ",118],["T_PUBLIC","public",119],["T_WHITESPACE"," ",119],["T_FUNCTION","function",119],["T_WHITESPACE"," ",119],["T_STRING","getCustomerGroupIdBasedOnVatNumber",119],"(",["T_VARIABLE","$customerCountryCode",119],",",["T_WHITESPACE"," ",119],["T_VARIABLE","$vatValidationResult",119],",",["T_WHITESPACE"," ",119],["T_VARIABLE","$store",119],["T_WHITESPACE"," ",119],"=",["T_WHITESPACE"," ",119],["T_STRING","null",119],")",["T_WHITESPACE","\n    ",119],"{",["T_WHITESPACE","\n        ",120],["T_VARIABLE","$groupId",121],["T_WHITESPACE"," ",121],"=",["T_WHITESPACE"," ",121],["T_STRING","null",121],";",["T_WHITESPACE","\n\n        ",121],["T_VARIABLE","$isAutoGroupAssign",123],["T_WHITESPACE"," ",123],"=",["T_WHITESPACE"," ",123],["T_VARIABLE","$this",123],["T_OBJECT_OPERATOR","->",123],["T_STRING","scopeConfig",123],["T_OBJECT_OPERATOR","->",123],["T_STRING","isSetFlag",123],"(",["T_WHITESPACE","\n            ",123],["T_STRING","self",124],["T_DOUBLE_COLON","::",124],["T_STRING","XML_PATH_CUSTOMER_GROUP_AUTO_ASSIGN",124],",",["T_WHITESPACE","\n            ",124],["T_STRING","ScopeInterface",125],["T_DOUBLE_COLON","::",125],["T_STRING","SCOPE_STORE",125],",",["T_WHITESPACE","\n            ",125],["T_VARIABLE","$store",126],["T_WHITESPACE","\n        ",126],")",";",["T_WHITESPACE","\n        ",127],["T_IF","if",128],["T_WHITESPACE"," ",128],"(","!",["T_VARIABLE","$isAutoGroupAssign",128],")",["T_WHITESPACE"," ",128],"{",["T_WHITESPACE","\n            ",128],["T_RETURN","return",129],["T_WHITESPACE"," ",129],["T_VARIABLE","$groupId",129],";",["T_WHITESPACE","\n        ",129],"}",["T_WHITESPACE","\n\n        ",130],["T_VARIABLE","$vatClass",132],["T_WHITESPACE"," ",132],"=",["T_WHITESPACE"," ",132],["T_VARIABLE","$this",132],["T_OBJECT_OPERATOR","->",132],["T_STRING","getCustomerVatClass",132],"(",["T_VARIABLE","$customerCountryCode",132],",",["T_WHITESPACE"," ",132],["T_VARIABLE","$vatValidationResult",132],",",["T_WHITESPACE"," ",132],["T_VARIABLE","$store",132],")",";",["T_WHITESPACE","\n\n        ",132],["T_VARIABLE","$vatClassToGroupXmlPathMap",134],["T_WHITESPACE"," ",134],"=",["T_WHITESPACE"," ",134],"[",["T_WHITESPACE","\n            ",134],["T_STRING","self",135],["T_DOUBLE_COLON","::",135],["T_STRING","VAT_CLASS_DOMESTIC",135],["T_WHITESPACE"," ",135],["T_DOUBLE_ARROW","=>",135],["T_WHITESPACE"," ",135],["T_STRING","self",135],["T_DOUBLE_COLON","::",135],["T_STRING","XML_PATH_CUSTOMER_VIV_DOMESTIC_GROUP",135],",",["T_WHITESPACE","\n            ",135],["T_STRING","self",136],["T_DOUBLE_COLON","::",136],["T_STRING","VAT_CLASS_INTRA_UNION",136],["T_WHITESPACE"," ",136],["T_DOUBLE_ARROW","=>",136],["T_WHITESPACE"," ",136],["T_STRING","self",136],["T_DOUBLE_COLON","::",136],["T_STRING","XML_PATH_CUSTOMER_VIV_INTRA_UNION_GROUP",136],",",["T_WHITESPACE","\n            ",136],["T_STRING","self",137],["T_DOUBLE_COLON","::",137],["T_STRING","VAT_CLASS_INVALID",137],["T_WHITESPACE"," ",137],["T_DOUBLE_ARROW","=>",137],["T_WHITESPACE"," ",137],["T_STRING","self",137],["T_DOUBLE_COLON","::",137],["T_STRING","XML_PATH_CUSTOMER_VIV_INVALID_GROUP",137],",",["T_WHITESPACE","\n            ",137],["T_STRING","self",138],["T_DOUBLE_COLON","::",138],["T_STRING","VAT_CLASS_ERROR",138],["T_WHITESPACE"," ",138],["T_DOUBLE_ARROW","=>",138],["T_WHITESPACE"," ",138],["T_STRING","self",138],["T_DOUBLE_COLON","::",138],["T_STRING","XML_PATH_CUSTOMER_VIV_ERROR_GROUP",138],",",["T_WHITESPACE","\n        ",138],"]",";",["T_WHITESPACE","\n\n        ",139],["T_IF","if",141],["T_WHITESPACE"," ",141],"(",["T_ISSET","isset",141],"(",["T_VARIABLE","$vatClassToGroupXmlPathMap",141],"[",["T_VARIABLE","$vatClass",141],"]",")",")",["T_WHITESPACE"," ",141],"{",["T_WHITESPACE","\n            ",141],["T_VARIABLE","$groupId",142],["T_WHITESPACE"," ",142],"=",["T_WHITESPACE"," ",142],["T_INT_CAST","(int)",142],["T_VARIABLE","$this",142],["T_OBJECT_OPERATOR","->",142],["T_STRING","scopeConfig",142],["T_OBJECT_OPERATOR","->",142],["T_STRING","getValue",142],"(",["T_WHITESPACE","\n                ",142],["T_VARIABLE","$vatClassToGroupXmlPathMap",143],"[",["T_VARIABLE","$vatClass",143],"]",",",["T_WHITESPACE","\n                ",143],["T_STRING","ScopeInterface",144],["T_DOUBLE_COLON","::",144],["T_STRING","SCOPE_STORE",144],",",["T_WHITESPACE","\n                ",144],["T_VARIABLE","$store",145],["T_WHITESPACE","\n            ",145],")",";",["T_WHITESPACE","\n        ",146],"}",["T_WHITESPACE","\n\n        ",147],["T_RETURN","return",149],["T_WHITESPACE"," ",149],["T_VARIABLE","$groupId",149],";",["T_WHITESPACE","\n    ",149],"}",["T_WHITESPACE","\n\n    ",150],["T_DOC_COMMENT","\/**\n     * Send request to VAT validation service and return validation result\n     *\n     * @param string $countryCode\n     * @param string $vatNumber\n     * @param string $requesterCountryCode\n     * @param string $requesterVatNumber\n     *\n     * @return DataObject\n     *\/",152],["T_WHITESPACE","\n    ",161],["T_PUBLIC","public",162],["T_WHITESPACE"," ",162],["T_FUNCTION","function",162],["T_WHITESPACE"," ",162],["T_STRING","checkVatNumber",162],"(",["T_VARIABLE","$countryCode",162],",",["T_WHITESPACE"," ",162],["T_VARIABLE","$vatNumber",162],",",["T_WHITESPACE"," ",162],["T_VARIABLE","$requesterCountryCode",162],["T_WHITESPACE"," ",162],"=",["T_WHITESPACE"," ",162],["T_CONSTANT_ENCAPSED_STRING","''",162],",",["T_WHITESPACE"," ",162],["T_VARIABLE","$requesterVatNumber",162],["T_WHITESPACE"," ",162],"=",["T_WHITESPACE"," ",162],["T_CONSTANT_ENCAPSED_STRING","''",162],")",["T_WHITESPACE","\n    ",162],"{",["T_WHITESPACE","\n        ",163],["T_COMMENT","\/\/ Default response\n",164],["T_WHITESPACE","        ",165],["T_VARIABLE","$gatewayResponse",165],["T_WHITESPACE"," ",165],"=",["T_WHITESPACE"," ",165],["T_NEW","new",165],["T_WHITESPACE"," ",165],["T_STRING","DataObject",165],"(","[",["T_WHITESPACE","\n            ",165],["T_CONSTANT_ENCAPSED_STRING","'is_valid'",166],["T_WHITESPACE"," ",166],["T_DOUBLE_ARROW","=>",166],["T_WHITESPACE"," ",166],["T_STRING","false",166],",",["T_WHITESPACE","\n            ",166],["T_CONSTANT_ENCAPSED_STRING","'request_date'",167],["T_WHITESPACE"," ",167],["T_DOUBLE_ARROW","=>",167],["T_WHITESPACE"," ",167],["T_CONSTANT_ENCAPSED_STRING","''",167],",",["T_WHITESPACE","\n            ",167],["T_CONSTANT_ENCAPSED_STRING","'request_identifier'",168],["T_WHITESPACE"," ",168],["T_DOUBLE_ARROW","=>",168],["T_WHITESPACE"," ",168],["T_CONSTANT_ENCAPSED_STRING","''",168],",",["T_WHITESPACE","\n            ",168],["T_CONSTANT_ENCAPSED_STRING","'request_success'",169],["T_WHITESPACE"," ",169],["T_DOUBLE_ARROW","=>",169],["T_WHITESPACE"," ",169],["T_STRING","false",169],",",["T_WHITESPACE","\n            ",169],["T_CONSTANT_ENCAPSED_STRING","'request_message'",170],["T_WHITESPACE"," ",170],["T_DOUBLE_ARROW","=>",170],["T_WHITESPACE"," ",170],["T_STRING","__",170],"(",["T_CONSTANT_ENCAPSED_STRING","'Error during VAT Number verification.'",170],")",",",["T_WHITESPACE","\n        ",170],"]",")",";",["T_WHITESPACE","\n\n        ",171],["T_IF","if",173],["T_WHITESPACE"," ",173],"(","!",["T_STRING","extension_loaded",173],"(",["T_CONSTANT_ENCAPSED_STRING","'soap'",173],")",")",["T_WHITESPACE"," ",173],"{",["T_WHITESPACE","\n            ",173],["T_VARIABLE","$this",174],["T_OBJECT_OPERATOR","->",174],["T_STRING","logger",174],["T_OBJECT_OPERATOR","->",174],["T_STRING","critical",174],"(",["T_NEW","new",174],["T_WHITESPACE"," ",174],["T_STRING","LocalizedException",174],"(",["T_STRING","__",174],"(",["T_CONSTANT_ENCAPSED_STRING","'PHP SOAP extension is required.'",174],")",")",")",";",["T_WHITESPACE","\n            ",174],["T_RETURN","return",175],["T_WHITESPACE"," ",175],["T_VARIABLE","$gatewayResponse",175],";",["T_WHITESPACE","\n        ",175],"}",["T_WHITESPACE","\n\n        ",176],["T_IF","if",178],["T_WHITESPACE"," ",178],"(","!",["T_VARIABLE","$this",178],["T_OBJECT_OPERATOR","->",178],["T_STRING","canCheckVatNumber",178],"(",["T_VARIABLE","$countryCode",178],",",["T_WHITESPACE"," ",178],["T_VARIABLE","$vatNumber",178],",",["T_WHITESPACE"," ",178],["T_VARIABLE","$requesterCountryCode",178],",",["T_WHITESPACE"," ",178],["T_VARIABLE","$requesterVatNumber",178],")",")",["T_WHITESPACE"," ",178],"{",["T_WHITESPACE","\n            ",178],["T_RETURN","return",179],["T_WHITESPACE"," ",179],["T_VARIABLE","$gatewayResponse",179],";",["T_WHITESPACE","\n        ",179],"}",["T_WHITESPACE","\n\n        ",180],["T_TRY","try",182],["T_WHITESPACE"," ",182],"{",["T_WHITESPACE","\n            ",182],["T_VARIABLE","$soapClient",183],["T_WHITESPACE"," ",183],"=",["T_WHITESPACE"," ",183],["T_VARIABLE","$this",183],["T_OBJECT_OPERATOR","->",183],["T_STRING","createVatNumberValidationSoapClient",183],"(",")",";",["T_WHITESPACE","\n\n            ",183],["T_VARIABLE","$requestParams",185],["T_WHITESPACE"," ",185],"=",["T_WHITESPACE"," ",185],"[","]",";",["T_WHITESPACE","\n            ",185],["T_VARIABLE","$requestParams",186],"[",["T_CONSTANT_ENCAPSED_STRING","'countryCode'",186],"]",["T_WHITESPACE"," ",186],"=",["T_WHITESPACE"," ",186],["T_VARIABLE","$countryCode",186],";",["T_WHITESPACE","\n            ",186],["T_VARIABLE","$requestParams",187],"[",["T_CONSTANT_ENCAPSED_STRING","'vatNumber'",187],"]",["T_WHITESPACE"," ",187],"=",["T_WHITESPACE"," ",187],["T_STRING","str_replace",187],"(","[",["T_CONSTANT_ENCAPSED_STRING","' '",187],",",["T_WHITESPACE"," ",187],["T_CONSTANT_ENCAPSED_STRING","'-'",187],"]",",",["T_WHITESPACE"," ",187],"[",["T_CONSTANT_ENCAPSED_STRING","''",187],",",["T_WHITESPACE"," ",187],["T_CONSTANT_ENCAPSED_STRING","''",187],"]",",",["T_WHITESPACE"," ",187],["T_VARIABLE","$vatNumber",187],")",";",["T_WHITESPACE","\n            ",187],["T_VARIABLE","$requestParams",188],"[",["T_CONSTANT_ENCAPSED_STRING","'requesterCountryCode'",188],"]",["T_WHITESPACE"," ",188],"=",["T_WHITESPACE"," ",188],["T_VARIABLE","$requesterCountryCode",188],";",["T_WHITESPACE","\n            ",188],["T_VARIABLE","$requestParams",189],"[",["T_CONSTANT_ENCAPSED_STRING","'requesterVatNumber'",189],"]",["T_WHITESPACE"," ",189],"=",["T_WHITESPACE"," ",189],["T_STRING","str_replace",189],"(","[",["T_CONSTANT_ENCAPSED_STRING","' '",189],",",["T_WHITESPACE"," ",189],["T_CONSTANT_ENCAPSED_STRING","'-'",189],"]",",",["T_WHITESPACE"," ",189],"[",["T_CONSTANT_ENCAPSED_STRING","''",189],",",["T_WHITESPACE"," ",189],["T_CONSTANT_ENCAPSED_STRING","''",189],"]",",",["T_WHITESPACE"," ",189],["T_VARIABLE","$requesterVatNumber",189],")",";",["T_WHITESPACE","\n\n            ",189],["T_COMMENT","\/\/ Send request to service\n",191],["T_WHITESPACE","            ",192],["T_VARIABLE","$result",192],["T_WHITESPACE"," ",192],"=",["T_WHITESPACE"," ",192],["T_VARIABLE","$soapClient",192],["T_OBJECT_OPERATOR","->",192],["T_STRING","checkVatApprox",192],"(",["T_VARIABLE","$requestParams",192],")",";",["T_WHITESPACE","\n\n            ",192],["T_VARIABLE","$gatewayResponse",194],["T_OBJECT_OPERATOR","->",194],["T_STRING","setIsValid",194],"(",["T_BOOL_CAST","(bool)",194],["T_VARIABLE","$result",194],["T_OBJECT_OPERATOR","->",194],["T_STRING","valid",194],")",";",["T_WHITESPACE","\n            ",194],["T_VARIABLE","$gatewayResponse",195],["T_OBJECT_OPERATOR","->",195],["T_STRING","setRequestDate",195],"(",["T_STRING_CAST","(string)",195],["T_VARIABLE","$result",195],["T_OBJECT_OPERATOR","->",195],["T_STRING","requestDate",195],")",";",["T_WHITESPACE","\n            ",195],["T_VARIABLE","$gatewayResponse",196],["T_OBJECT_OPERATOR","->",196],["T_STRING","setRequestIdentifier",196],"(",["T_STRING_CAST","(string)",196],["T_VARIABLE","$result",196],["T_OBJECT_OPERATOR","->",196],["T_STRING","requestIdentifier",196],")",";",["T_WHITESPACE","\n            ",196],["T_VARIABLE","$gatewayResponse",197],["T_OBJECT_OPERATOR","->",197],["T_STRING","setRequestSuccess",197],"(",["T_STRING","true",197],")",";",["T_WHITESPACE","\n\n            ",197],["T_IF","if",199],["T_WHITESPACE"," ",199],"(",["T_VARIABLE","$gatewayResponse",199],["T_OBJECT_OPERATOR","->",199],["T_STRING","getIsValid",199],"(",")",")",["T_WHITESPACE"," ",199],"{",["T_WHITESPACE","\n                ",199],["T_VARIABLE","$gatewayResponse",200],["T_OBJECT_OPERATOR","->",200],["T_STRING","setRequestMessage",200],"(",["T_STRING","__",200],"(",["T_CONSTANT_ENCAPSED_STRING","'VAT Number is valid.'",200],")",")",";",["T_WHITESPACE","\n            ",200],"}",["T_WHITESPACE"," ",201],["T_ELSE","else",201],["T_WHITESPACE"," ",201],"{",["T_WHITESPACE","\n                ",201],["T_VARIABLE","$gatewayResponse",202],["T_OBJECT_OPERATOR","->",202],["T_STRING","setRequestMessage",202],"(",["T_STRING","__",202],"(",["T_CONSTANT_ENCAPSED_STRING","'Please enter a valid VAT number.'",202],")",")",";",["T_WHITESPACE","\n            ",202],"}",["T_WHITESPACE","\n        ",203],"}",["T_WHITESPACE"," ",204],["T_CATCH","catch",204],["T_WHITESPACE"," ",204],"(",["T_NS_SEPARATOR","\\",204],["T_STRING","Exception",204],["T_WHITESPACE"," ",204],["T_VARIABLE","$exception",204],")",["T_WHITESPACE"," ",204],"{",["T_WHITESPACE","\n            ",204],["T_VARIABLE","$gatewayResponse",205],["T_OBJECT_OPERATOR","->",205],["T_STRING","setIsValid",205],"(",["T_STRING","false",205],")",";",["T_WHITESPACE","\n            ",205],["T_VARIABLE","$gatewayResponse",206],["T_OBJECT_OPERATOR","->",206],["T_STRING","setRequestDate",206],"(",["T_CONSTANT_ENCAPSED_STRING","''",206],")",";",["T_WHITESPACE","\n            ",206],["T_VARIABLE","$gatewayResponse",207],["T_OBJECT_OPERATOR","->",207],["T_STRING","setRequestIdentifier",207],"(",["T_CONSTANT_ENCAPSED_STRING","''",207],")",";",["T_WHITESPACE","\n        ",207],"}",["T_WHITESPACE","\n\n        ",208],["T_RETURN","return",210],["T_WHITESPACE"," ",210],["T_VARIABLE","$gatewayResponse",210],";",["T_WHITESPACE","\n    ",210],"}",["T_WHITESPACE","\n\n    ",211],["T_DOC_COMMENT","\/**\n     * Create SOAP client based on VAT validation service WSDL\n     *\n     * @param boolean $trace\n     * @return \\SoapClient\n     *\/",213],["T_WHITESPACE","\n    ",218],["T_PROTECTED","protected",219],["T_WHITESPACE"," ",219],["T_FUNCTION","function",219],["T_WHITESPACE"," ",219],["T_STRING","createVatNumberValidationSoapClient",219],"(",["T_VARIABLE","$trace",219],["T_WHITESPACE"," ",219],"=",["T_WHITESPACE"," ",219],["T_STRING","false",219],")",["T_WHITESPACE","\n    ",219],"{",["T_WHITESPACE","\n        ",220],["T_RETURN","return",221],["T_WHITESPACE"," ",221],["T_NEW","new",221],["T_WHITESPACE"," ",221],["T_NS_SEPARATOR","\\",221],["T_STRING","SoapClient",221],"(",["T_STRING","self",221],["T_DOUBLE_COLON","::",221],["T_STRING","VAT_VALIDATION_WSDL_URL",221],",",["T_WHITESPACE"," ",221],"[",["T_CONSTANT_ENCAPSED_STRING","'trace'",221],["T_WHITESPACE"," ",221],["T_DOUBLE_ARROW","=>",221],["T_WHITESPACE"," ",221],["T_VARIABLE","$trace",221],"]",")",";",["T_WHITESPACE","\n    ",221],"}",["T_WHITESPACE","\n\n    ",222],["T_DOC_COMMENT","\/**\n     * Check if parameters are valid to send to VAT validation service\n     *\n     * @param string $countryCode\n     * @param string $vatNumber\n     * @param string $requesterCountryCode\n     * @param string $requesterVatNumber\n     *\n     * @return boolean\n     *\n     * @SuppressWarnings(PHPMD.CyclomaticComplexity)\n     *\/",224],["T_WHITESPACE","\n    ",235],["T_PUBLIC","public",236],["T_WHITESPACE"," ",236],["T_FUNCTION","function",236],["T_WHITESPACE"," ",236],["T_STRING","canCheckVatNumber",236],"(",["T_VARIABLE","$countryCode",236],",",["T_WHITESPACE"," ",236],["T_VARIABLE","$vatNumber",236],",",["T_WHITESPACE"," ",236],["T_VARIABLE","$requesterCountryCode",236],",",["T_WHITESPACE"," ",236],["T_VARIABLE","$requesterVatNumber",236],")",["T_WHITESPACE","\n    ",236],"{",["T_WHITESPACE","\n        ",237],["T_RETURN","return",238],["T_WHITESPACE"," ",238],"!","(","!",["T_STRING","is_string",238],"(",["T_VARIABLE","$countryCode",238],")",["T_WHITESPACE","\n            ",238],["T_BOOLEAN_OR","||",239],["T_WHITESPACE"," ",239],"!",["T_STRING","is_string",239],"(",["T_VARIABLE","$vatNumber",239],")",["T_WHITESPACE","\n            ",239],["T_BOOLEAN_OR","||",240],["T_WHITESPACE"," ",240],"!",["T_STRING","is_string",240],"(",["T_VARIABLE","$requesterCountryCode",240],")",["T_WHITESPACE","\n            ",240],["T_BOOLEAN_OR","||",241],["T_WHITESPACE"," ",241],"!",["T_STRING","is_string",241],"(",["T_VARIABLE","$requesterVatNumber",241],")",["T_WHITESPACE","\n            ",241],["T_BOOLEAN_OR","||",242],["T_WHITESPACE"," ",242],["T_EMPTY","empty",242],"(",["T_VARIABLE","$countryCode",242],")",["T_WHITESPACE","\n            ",242],["T_BOOLEAN_OR","||",243],["T_WHITESPACE"," ",243],"!",["T_VARIABLE","$this",243],["T_OBJECT_OPERATOR","->",243],["T_STRING","isCountryInEU",243],"(",["T_VARIABLE","$countryCode",243],")",["T_WHITESPACE","\n            ",243],["T_BOOLEAN_OR","||",244],["T_WHITESPACE"," ",244],["T_EMPTY","empty",244],"(",["T_VARIABLE","$vatNumber",244],")",["T_WHITESPACE","\n            ",244],["T_BOOLEAN_OR","||",245],["T_WHITESPACE"," ",245],["T_EMPTY","empty",245],"(",["T_VARIABLE","$requesterCountryCode",245],")",["T_WHITESPACE"," ",245],["T_BOOLEAN_AND","&&",245],["T_WHITESPACE"," ",245],"!",["T_EMPTY","empty",245],"(",["T_VARIABLE","$requesterVatNumber",245],")",["T_WHITESPACE","\n            ",245],["T_BOOLEAN_OR","||",246],["T_WHITESPACE"," ",246],"!",["T_EMPTY","empty",246],"(",["T_VARIABLE","$requesterCountryCode",246],")",["T_WHITESPACE"," ",246],["T_BOOLEAN_AND","&&",246],["T_WHITESPACE"," ",246],["T_EMPTY","empty",246],"(",["T_VARIABLE","$requesterVatNumber",246],")",["T_WHITESPACE","\n            ",246],["T_BOOLEAN_OR","||",247],["T_WHITESPACE"," ",247],"!",["T_EMPTY","empty",247],"(",["T_VARIABLE","$requesterCountryCode",247],")",["T_WHITESPACE"," ",247],["T_BOOLEAN_AND","&&",247],["T_WHITESPACE"," ",247],"!",["T_VARIABLE","$this",247],["T_OBJECT_OPERATOR","->",247],["T_STRING","isCountryInEU",247],"(",["T_VARIABLE","$requesterCountryCode",247],")",["T_WHITESPACE","\n        ",247],")",";",["T_WHITESPACE","\n    ",248],"}",["T_WHITESPACE","\n\n    ",249],["T_DOC_COMMENT","\/**\n     * Get VAT class\n     *\n     * @param string $customerCountryCode\n     * @param DataObject $vatValidationResult\n     * @param Store|string|int|null $store\n     * @return null|string\n     *\/",251],["T_WHITESPACE","\n    ",258],["T_PUBLIC","public",259],["T_WHITESPACE"," ",259],["T_FUNCTION","function",259],["T_WHITESPACE"," ",259],["T_STRING","getCustomerVatClass",259],"(",["T_VARIABLE","$customerCountryCode",259],",",["T_WHITESPACE"," ",259],["T_VARIABLE","$vatValidationResult",259],",",["T_WHITESPACE"," ",259],["T_VARIABLE","$store",259],["T_WHITESPACE"," ",259],"=",["T_WHITESPACE"," ",259],["T_STRING","null",259],")",["T_WHITESPACE","\n    ",259],"{",["T_WHITESPACE","\n        ",260],["T_VARIABLE","$vatClass",261],["T_WHITESPACE"," ",261],"=",["T_WHITESPACE"," ",261],["T_STRING","null",261],";",["T_WHITESPACE","\n\n        ",261],["T_VARIABLE","$isVatNumberValid",263],["T_WHITESPACE"," ",263],"=",["T_WHITESPACE"," ",263],["T_VARIABLE","$vatValidationResult",263],["T_OBJECT_OPERATOR","->",263],["T_STRING","getIsValid",263],"(",")",";",["T_WHITESPACE","\n\n        ",263],["T_IF","if",265],["T_WHITESPACE"," ",265],"(",["T_STRING","is_string",265],"(",["T_VARIABLE","$customerCountryCode",265],")",["T_WHITESPACE","\n            ",265],["T_BOOLEAN_AND","&&",266],["T_WHITESPACE"," ",266],"!",["T_EMPTY","empty",266],"(",["T_VARIABLE","$customerCountryCode",266],")",["T_WHITESPACE","\n            ",266],["T_BOOLEAN_AND","&&",267],["T_WHITESPACE"," ",267],["T_VARIABLE","$customerCountryCode",267],["T_WHITESPACE"," ",267],["T_IS_IDENTICAL","===",267],["T_WHITESPACE"," ",267],["T_VARIABLE","$this",267],["T_OBJECT_OPERATOR","->",267],["T_STRING","getMerchantCountryCode",267],"(",["T_VARIABLE","$store",267],")",["T_WHITESPACE","\n            ",267],["T_BOOLEAN_AND","&&",268],["T_WHITESPACE"," ",268],["T_VARIABLE","$isVatNumberValid",268],["T_WHITESPACE","\n        ",268],")",["T_WHITESPACE"," ",269],"{",["T_WHITESPACE","\n            ",269],["T_VARIABLE","$vatClass",270],["T_WHITESPACE"," ",270],"=",["T_WHITESPACE"," ",270],["T_STRING","self",270],["T_DOUBLE_COLON","::",270],["T_STRING","VAT_CLASS_DOMESTIC",270],";",["T_WHITESPACE","\n        ",270],"}",["T_WHITESPACE"," ",271],["T_ELSEIF","elseif",271],["T_WHITESPACE"," ",271],"(",["T_VARIABLE","$isVatNumberValid",271],")",["T_WHITESPACE"," ",271],"{",["T_WHITESPACE","\n            ",271],["T_VARIABLE","$vatClass",272],["T_WHITESPACE"," ",272],"=",["T_WHITESPACE"," ",272],["T_STRING","self",272],["T_DOUBLE_COLON","::",272],["T_STRING","VAT_CLASS_INTRA_UNION",272],";",["T_WHITESPACE","\n        ",272],"}",["T_WHITESPACE"," ",273],["T_ELSE","else",273],["T_WHITESPACE"," ",273],"{",["T_WHITESPACE","\n            ",273],["T_VARIABLE","$vatClass",274],["T_WHITESPACE"," ",274],"=",["T_WHITESPACE"," ",274],["T_STRING","self",274],["T_DOUBLE_COLON","::",274],["T_STRING","VAT_CLASS_INVALID",274],";",["T_WHITESPACE","\n        ",274],"}",["T_WHITESPACE","\n\n        ",275],["T_IF","if",277],["T_WHITESPACE"," ",277],"(","!",["T_VARIABLE","$vatValidationResult",277],["T_OBJECT_OPERATOR","->",277],["T_STRING","getRequestSuccess",277],"(",")",")",["T_WHITESPACE"," ",277],"{",["T_WHITESPACE","\n            ",277],["T_VARIABLE","$vatClass",278],["T_WHITESPACE"," ",278],"=",["T_WHITESPACE"," ",278],["T_STRING","self",278],["T_DOUBLE_COLON","::",278],["T_STRING","VAT_CLASS_ERROR",278],";",["T_WHITESPACE","\n        ",278],"}",["T_WHITESPACE","\n\n        ",279],["T_RETURN","return",281],["T_WHITESPACE"," ",281],["T_VARIABLE","$vatClass",281],";",["T_WHITESPACE","\n    ",281],"}",["T_WHITESPACE","\n\n    ",282],["T_DOC_COMMENT","\/**\n     * Check whether specified country is in EU countries list\n     *\n     * @param string $countryCode\n     * @param null|int $storeId\n     * @return bool\n     *\/",284],["T_WHITESPACE","\n    ",290],["T_PUBLIC","public",291],["T_WHITESPACE"," ",291],["T_FUNCTION","function",291],["T_WHITESPACE"," ",291],["T_STRING","isCountryInEU",291],"(",["T_VARIABLE","$countryCode",291],",",["T_WHITESPACE"," ",291],["T_VARIABLE","$storeId",291],["T_WHITESPACE"," ",291],"=",["T_WHITESPACE"," ",291],["T_STRING","null",291],")",["T_WHITESPACE","\n    ",291],"{",["T_WHITESPACE","\n        ",292],["T_VARIABLE","$euCountries",293],["T_WHITESPACE"," ",293],"=",["T_WHITESPACE"," ",293],["T_STRING","explode",293],"(",["T_WHITESPACE","\n            ",293],["T_CONSTANT_ENCAPSED_STRING","','",294],",",["T_WHITESPACE","\n            ",294],["T_VARIABLE","$this",295],["T_OBJECT_OPERATOR","->",295],["T_STRING","scopeConfig",295],["T_OBJECT_OPERATOR","->",295],["T_STRING","getValue",295],"(",["T_STRING","self",295],["T_DOUBLE_COLON","::",295],["T_STRING","XML_PATH_EU_COUNTRIES_LIST",295],",",["T_WHITESPACE"," ",295],["T_STRING","ScopeInterface",295],["T_DOUBLE_COLON","::",295],["T_STRING","SCOPE_STORE",295],",",["T_WHITESPACE"," ",295],["T_VARIABLE","$storeId",295],")",["T_WHITESPACE","\n        ",295],")",";",["T_WHITESPACE","\n        ",296],["T_RETURN","return",297],["T_WHITESPACE"," ",297],["T_STRING","in_array",297],"(",["T_VARIABLE","$countryCode",297],",",["T_WHITESPACE"," ",297],["T_VARIABLE","$euCountries",297],")",";",["T_WHITESPACE","\n    ",297],"}",["T_WHITESPACE","\n",298],"}",["T_WHITESPACE","\n",299]]