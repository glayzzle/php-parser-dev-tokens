[["T_OPEN_TAG","<?php\n",1],["T_DOC_COMMENT","\/**\n * Copyright \u00c2\u00a9 2013-2017 Magento, Inc. All rights reserved.\n * See COPYING.txt for license details.\n *\/",2],["T_WHITESPACE","\n\n",5],["T_DOC_COMMENT","\/**\n * Reports Mysql resource helper model\n *\n * @author      Magento Core Team <core@magentocommerce.com>\n *\/",7],["T_WHITESPACE","\n",11],["T_NAMESPACE","namespace",12],["T_WHITESPACE"," ",12],["T_STRING","Magento",12],["T_NS_SEPARATOR","\\",12],["T_STRING","Reports",12],["T_NS_SEPARATOR","\\",12],["T_STRING","Model",12],["T_NS_SEPARATOR","\\",12],["T_STRING","ResourceModel",12],";",["T_WHITESPACE","\n\n",12],["T_CLASS","class",14],["T_WHITESPACE"," ",14],["T_STRING","Helper",14],["T_WHITESPACE"," ",14],["T_EXTENDS","extends",14],["T_WHITESPACE"," ",14],["T_NS_SEPARATOR","\\",14],["T_STRING","Magento",14],["T_NS_SEPARATOR","\\",14],["T_STRING","Framework",14],["T_NS_SEPARATOR","\\",14],["T_STRING","DB",14],["T_NS_SEPARATOR","\\",14],["T_STRING","Helper",14],["T_WHITESPACE"," ",14],["T_IMPLEMENTS","implements",14],["T_WHITESPACE"," ",14],["T_NS_SEPARATOR","\\",14],["T_STRING","Magento",14],["T_NS_SEPARATOR","\\",14],["T_STRING","Reports",14],["T_NS_SEPARATOR","\\",14],["T_STRING","Model",14],["T_NS_SEPARATOR","\\",14],["T_STRING","ResourceModel",14],["T_NS_SEPARATOR","\\",14],["T_STRING","HelperInterface",14],["T_WHITESPACE","\n",14],"{",["T_WHITESPACE","\n    ",15],["T_DOC_COMMENT","\/**\n     * @param \\Magento\\Framework\\App\\ResourceConnection $resource\n     * @param string $modulePrefix\n     *\/",16],["T_WHITESPACE","\n    ",19],["T_PUBLIC","public",20],["T_WHITESPACE"," ",20],["T_FUNCTION","function",20],["T_WHITESPACE"," ",20],["T_STRING","__construct",20],"(",["T_NS_SEPARATOR","\\",20],["T_STRING","Magento",20],["T_NS_SEPARATOR","\\",20],["T_STRING","Framework",20],["T_NS_SEPARATOR","\\",20],["T_STRING","App",20],["T_NS_SEPARATOR","\\",20],["T_STRING","ResourceConnection",20],["T_WHITESPACE"," ",20],["T_VARIABLE","$resource",20],",",["T_WHITESPACE"," ",20],["T_VARIABLE","$modulePrefix",20],["T_WHITESPACE"," ",20],"=",["T_WHITESPACE"," ",20],["T_CONSTANT_ENCAPSED_STRING","'reports'",20],")",["T_WHITESPACE","\n    ",20],"{",["T_WHITESPACE","\n        ",21],["T_STRING","parent",22],["T_DOUBLE_COLON","::",22],["T_STRING","__construct",22],"(",["T_VARIABLE","$resource",22],",",["T_WHITESPACE"," ",22],["T_VARIABLE","$modulePrefix",22],")",";",["T_WHITESPACE","\n    ",22],"}",["T_WHITESPACE","\n\n    ",23],["T_DOC_COMMENT","\/**\n     * Merge Index data\n     *\n     * @param string $mainTable\n     * @param array $data\n     * @param mixed $matchFields\n     * @SuppressWarnings(PHPMD.UnusedFormalParameter)\n     * @return string\n     *\/",25],["T_WHITESPACE","\n    ",33],["T_PUBLIC","public",34],["T_WHITESPACE"," ",34],["T_FUNCTION","function",34],["T_WHITESPACE"," ",34],["T_STRING","mergeVisitorProductIndex",34],"(",["T_VARIABLE","$mainTable",34],",",["T_WHITESPACE"," ",34],["T_VARIABLE","$data",34],",",["T_WHITESPACE"," ",34],["T_VARIABLE","$matchFields",34],")",["T_WHITESPACE","\n    ",34],"{",["T_WHITESPACE","\n        ",35],["T_VARIABLE","$result",36],["T_WHITESPACE"," ",36],"=",["T_WHITESPACE"," ",36],["T_VARIABLE","$this",36],["T_OBJECT_OPERATOR","->",36],["T_STRING","getConnection",36],"(",")",["T_OBJECT_OPERATOR","->",36],["T_STRING","insertOnDuplicate",36],"(",["T_VARIABLE","$mainTable",36],",",["T_WHITESPACE"," ",36],["T_VARIABLE","$data",36],",",["T_WHITESPACE"," ",36],["T_STRING","array_keys",36],"(",["T_VARIABLE","$data",36],")",")",";",["T_WHITESPACE","\n        ",36],["T_RETURN","return",37],["T_WHITESPACE"," ",37],["T_VARIABLE","$result",37],";",["T_WHITESPACE","\n    ",37],"}",["T_WHITESPACE","\n\n    ",38],["T_DOC_COMMENT","\/**\n     * @inheritdoc\n     *\/",40],["T_WHITESPACE","\n    ",42],["T_PUBLIC","public",43],["T_WHITESPACE"," ",43],["T_FUNCTION","function",43],["T_WHITESPACE"," ",43],["T_STRING","updateReportRatingPos",43],"(",["T_VARIABLE","$connection",43],",",["T_WHITESPACE"," ",43],["T_VARIABLE","$type",43],",",["T_WHITESPACE"," ",43],["T_VARIABLE","$column",43],",",["T_WHITESPACE"," ",43],["T_VARIABLE","$mainTable",43],",",["T_WHITESPACE"," ",43],["T_VARIABLE","$aggregationTable",43],")",["T_WHITESPACE","\n    ",43],"{",["T_WHITESPACE","\n        ",44],["T_VARIABLE","$periodSubSelect",45],["T_WHITESPACE"," ",45],"=",["T_WHITESPACE"," ",45],["T_VARIABLE","$connection",45],["T_OBJECT_OPERATOR","->",45],["T_STRING","select",45],"(",")",";",["T_WHITESPACE","\n        ",45],["T_VARIABLE","$ratingSubSelect",46],["T_WHITESPACE"," ",46],"=",["T_WHITESPACE"," ",46],["T_VARIABLE","$connection",46],["T_OBJECT_OPERATOR","->",46],["T_STRING","select",46],"(",")",";",["T_WHITESPACE","\n        ",46],["T_VARIABLE","$ratingSelect",47],["T_WHITESPACE"," ",47],"=",["T_WHITESPACE"," ",47],["T_VARIABLE","$connection",47],["T_OBJECT_OPERATOR","->",47],["T_STRING","select",47],"(",")",";",["T_WHITESPACE","\n\n        ",47],["T_SWITCH","switch",49],["T_WHITESPACE"," ",49],"(",["T_VARIABLE","$type",49],")",["T_WHITESPACE"," ",49],"{",["T_WHITESPACE","\n            ",49],["T_CASE","case",50],["T_WHITESPACE"," ",50],["T_CONSTANT_ENCAPSED_STRING","'year'",50],":",["T_WHITESPACE","\n                ",50],["T_VARIABLE","$periodCol",51],["T_WHITESPACE"," ",51],"=",["T_WHITESPACE"," ",51],["T_VARIABLE","$connection",51],["T_OBJECT_OPERATOR","->",51],["T_STRING","getDateFormatSql",51],"(",["T_CONSTANT_ENCAPSED_STRING","'t.period'",51],",",["T_WHITESPACE"," ",51],["T_CONSTANT_ENCAPSED_STRING","'%Y-01-01'",51],")",";",["T_WHITESPACE","\n                ",51],["T_BREAK","break",52],";",["T_WHITESPACE","\n            ",52],["T_CASE","case",53],["T_WHITESPACE"," ",53],["T_CONSTANT_ENCAPSED_STRING","'month'",53],":",["T_WHITESPACE","\n                ",53],["T_VARIABLE","$periodCol",54],["T_WHITESPACE"," ",54],"=",["T_WHITESPACE"," ",54],["T_VARIABLE","$connection",54],["T_OBJECT_OPERATOR","->",54],["T_STRING","getDateFormatSql",54],"(",["T_CONSTANT_ENCAPSED_STRING","'t.period'",54],",",["T_WHITESPACE"," ",54],["T_CONSTANT_ENCAPSED_STRING","'%Y-%m-01'",54],")",";",["T_WHITESPACE","\n                ",54],["T_BREAK","break",55],";",["T_WHITESPACE","\n            ",55],["T_DEFAULT","default",56],":",["T_WHITESPACE","\n                ",56],["T_VARIABLE","$periodCol",57],["T_WHITESPACE"," ",57],"=",["T_WHITESPACE"," ",57],["T_CONSTANT_ENCAPSED_STRING","'t.period'",57],";",["T_WHITESPACE","\n                ",57],["T_BREAK","break",58],";",["T_WHITESPACE","\n        ",58],"}",["T_WHITESPACE","\n\n        ",59],["T_VARIABLE","$columns",61],["T_WHITESPACE"," ",61],"=",["T_WHITESPACE"," ",61],"[",["T_WHITESPACE","\n            ",61],["T_CONSTANT_ENCAPSED_STRING","'period'",62],["T_WHITESPACE"," ",62],["T_DOUBLE_ARROW","=>",62],["T_WHITESPACE"," ",62],["T_CONSTANT_ENCAPSED_STRING","'t.period'",62],",",["T_WHITESPACE","\n            ",62],["T_CONSTANT_ENCAPSED_STRING","'store_id'",63],["T_WHITESPACE"," ",63],["T_DOUBLE_ARROW","=>",63],["T_WHITESPACE"," ",63],["T_CONSTANT_ENCAPSED_STRING","'t.store_id'",63],",",["T_WHITESPACE","\n            ",63],["T_CONSTANT_ENCAPSED_STRING","'product_id'",64],["T_WHITESPACE"," ",64],["T_DOUBLE_ARROW","=>",64],["T_WHITESPACE"," ",64],["T_CONSTANT_ENCAPSED_STRING","'t.product_id'",64],",",["T_WHITESPACE","\n            ",64],["T_CONSTANT_ENCAPSED_STRING","'product_name'",65],["T_WHITESPACE"," ",65],["T_DOUBLE_ARROW","=>",65],["T_WHITESPACE"," ",65],["T_CONSTANT_ENCAPSED_STRING","'t.product_name'",65],",",["T_WHITESPACE","\n            ",65],["T_CONSTANT_ENCAPSED_STRING","'product_price'",66],["T_WHITESPACE"," ",66],["T_DOUBLE_ARROW","=>",66],["T_WHITESPACE"," ",66],["T_CONSTANT_ENCAPSED_STRING","'t.product_price'",66],",",["T_WHITESPACE","\n        ",66],"]",";",["T_WHITESPACE","\n\n        ",67],["T_IF","if",69],["T_WHITESPACE"," ",69],"(",["T_VARIABLE","$type",69],["T_WHITESPACE"," ",69],["T_IS_EQUAL","==",69],["T_WHITESPACE"," ",69],["T_CONSTANT_ENCAPSED_STRING","'day'",69],")",["T_WHITESPACE"," ",69],"{",["T_WHITESPACE","\n            ",69],["T_VARIABLE","$columns",70],"[",["T_CONSTANT_ENCAPSED_STRING","'id'",70],"]",["T_WHITESPACE"," ",70],"=",["T_WHITESPACE"," ",70],["T_CONSTANT_ENCAPSED_STRING","'t.id'",70],";",["T_WHITESPACE","  ",70],["T_COMMENT","\/\/ to speed-up insert on duplicate key update\n",70],["T_WHITESPACE","        ",71],"}",["T_WHITESPACE","\n\n        ",71],["T_VARIABLE","$cols",73],["T_WHITESPACE"," ",73],"=",["T_WHITESPACE"," ",73],["T_STRING","array_keys",73],"(",["T_VARIABLE","$columns",73],")",";",["T_WHITESPACE","\n        ",73],["T_VARIABLE","$cols",74],"[",["T_CONSTANT_ENCAPSED_STRING","'total_qty'",74],"]",["T_WHITESPACE"," ",74],"=",["T_WHITESPACE"," ",74],["T_NEW","new",74],["T_WHITESPACE"," ",74],["T_NS_SEPARATOR","\\",74],["T_STRING","Zend_Db_Expr",74],"(",["T_CONSTANT_ENCAPSED_STRING","'SUM(t.'",74],["T_WHITESPACE"," ",74],".",["T_WHITESPACE"," ",74],["T_VARIABLE","$column",74],["T_WHITESPACE"," ",74],".",["T_WHITESPACE"," ",74],["T_CONSTANT_ENCAPSED_STRING","')'",74],")",";",["T_WHITESPACE","\n        ",74],["T_VARIABLE","$periodSubSelect",75],["T_OBJECT_OPERATOR","->",75],["T_STRING","from",75],"(",["T_WHITESPACE","\n            ",75],"[",["T_CONSTANT_ENCAPSED_STRING","'t'",76],["T_WHITESPACE"," ",76],["T_DOUBLE_ARROW","=>",76],["T_WHITESPACE"," ",76],["T_VARIABLE","$mainTable",76],"]",",",["T_WHITESPACE","\n            ",76],["T_VARIABLE","$cols",77],["T_WHITESPACE","\n        ",77],")",["T_OBJECT_OPERATOR","->",78],["T_STRING","group",78],"(",["T_WHITESPACE","\n            ",78],"[",["T_CONSTANT_ENCAPSED_STRING","'t.store_id'",79],",",["T_WHITESPACE"," ",79],["T_VARIABLE","$periodCol",79],",",["T_WHITESPACE"," ",79],["T_CONSTANT_ENCAPSED_STRING","'t.product_id'",79],"]",["T_WHITESPACE","\n        ",79],")",["T_OBJECT_OPERATOR","->",80],["T_STRING","order",80],"(",["T_WHITESPACE","\n            ",80],"[",["T_CONSTANT_ENCAPSED_STRING","'t.store_id'",81],",",["T_WHITESPACE"," ",81],["T_VARIABLE","$periodCol",81],",",["T_WHITESPACE"," ",81],["T_CONSTANT_ENCAPSED_STRING","'total_qty DESC'",81],"]",["T_WHITESPACE","\n        ",81],")",";",["T_WHITESPACE","\n\n        ",82],["T_VARIABLE","$cols",84],["T_WHITESPACE"," ",84],"=",["T_WHITESPACE"," ",84],["T_VARIABLE","$columns",84],";",["T_WHITESPACE","\n        ",84],["T_VARIABLE","$cols",85],"[",["T_VARIABLE","$column",85],"]",["T_WHITESPACE"," ",85],"=",["T_WHITESPACE"," ",85],["T_CONSTANT_ENCAPSED_STRING","'t.total_qty'",85],";",["T_WHITESPACE","\n        ",85],["T_VARIABLE","$cols",86],"[",["T_CONSTANT_ENCAPSED_STRING","'rating_pos'",86],"]",["T_WHITESPACE"," ",86],"=",["T_WHITESPACE"," ",86],["T_NEW","new",86],["T_WHITESPACE"," ",86],["T_NS_SEPARATOR","\\",86],["T_STRING","Zend_Db_Expr",86],"(",["T_WHITESPACE","\n            ",86],"\"",["T_ENCAPSED_AND_WHITESPACE","(@pos := IF(t.`store_id` <> @prevStoreId OR ",87],["T_CURLY_OPEN","{",87],["T_VARIABLE","$periodCol",87],"}",["T_ENCAPSED_AND_WHITESPACE"," <> @prevPeriod, 1, @pos+1))",87],"\"",["T_WHITESPACE","\n        ",87],")",";",["T_WHITESPACE","\n        ",88],["T_VARIABLE","$cols",89],"[",["T_CONSTANT_ENCAPSED_STRING","'prevStoreId'",89],"]",["T_WHITESPACE"," ",89],"=",["T_WHITESPACE"," ",89],["T_NEW","new",89],["T_WHITESPACE"," ",89],["T_NS_SEPARATOR","\\",89],["T_STRING","Zend_Db_Expr",89],"(",["T_CONSTANT_ENCAPSED_STRING","'(@prevStoreId := t.`store_id`)'",89],")",";",["T_WHITESPACE","\n        ",89],["T_VARIABLE","$cols",90],"[",["T_CONSTANT_ENCAPSED_STRING","'prevPeriod'",90],"]",["T_WHITESPACE"," ",90],"=",["T_WHITESPACE"," ",90],["T_NEW","new",90],["T_WHITESPACE"," ",90],["T_NS_SEPARATOR","\\",90],["T_STRING","Zend_Db_Expr",90],"(","\"",["T_ENCAPSED_AND_WHITESPACE","(@prevPeriod := ",90],["T_CURLY_OPEN","{",90],["T_VARIABLE","$periodCol",90],"}",["T_ENCAPSED_AND_WHITESPACE",")",90],"\"",")",";",["T_WHITESPACE","\n        ",90],["T_VARIABLE","$ratingSubSelect",91],["T_OBJECT_OPERATOR","->",91],["T_STRING","from",91],"(",["T_VARIABLE","$periodSubSelect",91],",",["T_WHITESPACE"," ",91],["T_VARIABLE","$cols",91],")",";",["T_WHITESPACE","\n\n        ",91],["T_VARIABLE","$cols",93],["T_WHITESPACE"," ",93],"=",["T_WHITESPACE"," ",93],["T_VARIABLE","$columns",93],";",["T_WHITESPACE","\n        ",93],["T_VARIABLE","$cols",94],"[",["T_CONSTANT_ENCAPSED_STRING","'period'",94],"]",["T_WHITESPACE"," ",94],"=",["T_WHITESPACE"," ",94],["T_VARIABLE","$periodCol",94],";",["T_WHITESPACE","\n        ",94],["T_VARIABLE","$cols",95],"[",["T_VARIABLE","$column",95],"]",["T_WHITESPACE"," ",95],"=",["T_WHITESPACE"," ",95],["T_CONSTANT_ENCAPSED_STRING","'t.'",95],["T_WHITESPACE"," ",95],".",["T_WHITESPACE"," ",95],["T_VARIABLE","$column",95],";",["T_WHITESPACE","\n        ",95],["T_VARIABLE","$cols",96],"[",["T_CONSTANT_ENCAPSED_STRING","'rating_pos'",96],"]",["T_WHITESPACE"," ",96],"=",["T_WHITESPACE"," ",96],["T_CONSTANT_ENCAPSED_STRING","'t.rating_pos'",96],";",["T_WHITESPACE","\n        ",96],["T_VARIABLE","$ratingSelect",97],["T_OBJECT_OPERATOR","->",97],["T_STRING","from",97],"(",["T_VARIABLE","$ratingSubSelect",97],",",["T_WHITESPACE"," ",97],["T_VARIABLE","$cols",97],")",";",["T_WHITESPACE","\n\n        ",97],["T_VARIABLE","$sql",99],["T_WHITESPACE"," ",99],"=",["T_WHITESPACE"," ",99],["T_VARIABLE","$ratingSelect",99],["T_OBJECT_OPERATOR","->",99],["T_STRING","insertFromSelect",99],"(",["T_VARIABLE","$aggregationTable",99],",",["T_WHITESPACE"," ",99],["T_STRING","array_keys",99],"(",["T_VARIABLE","$cols",99],")",")",";",["T_WHITESPACE","\n        ",99],["T_VARIABLE","$connection",100],["T_OBJECT_OPERATOR","->",100],["T_STRING","query",100],"(",["T_CONSTANT_ENCAPSED_STRING","\"SET @pos = 0, @prevStoreId = -1, @prevPeriod = '0000-00-00'\"",100],")",";",["T_WHITESPACE","\n        ",100],["T_VARIABLE","$connection",101],["T_OBJECT_OPERATOR","->",101],["T_STRING","query",101],"(",["T_VARIABLE","$sql",101],")",";",["T_WHITESPACE","\n        ",101],["T_RETURN","return",102],["T_WHITESPACE"," ",102],["T_VARIABLE","$this",102],";",["T_WHITESPACE","\n    ",102],"}",["T_WHITESPACE","\n",103],"}",["T_WHITESPACE","\n",104]]