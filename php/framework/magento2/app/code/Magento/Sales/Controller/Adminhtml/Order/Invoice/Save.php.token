[["T_OPEN_TAG","<?php\n",1],["T_DOC_COMMENT","\/**\n *\n * Copyright \u00c2\u00a9 2013-2017 Magento, Inc. All rights reserved.\n * See COPYING.txt for license details.\n *\/",2],["T_WHITESPACE","\n",6],["T_NAMESPACE","namespace",7],["T_WHITESPACE"," ",7],["T_STRING","Magento",7],["T_NS_SEPARATOR","\\",7],["T_STRING","Sales",7],["T_NS_SEPARATOR","\\",7],["T_STRING","Controller",7],["T_NS_SEPARATOR","\\",7],["T_STRING","Adminhtml",7],["T_NS_SEPARATOR","\\",7],["T_STRING","Order",7],["T_NS_SEPARATOR","\\",7],["T_STRING","Invoice",7],";",["T_WHITESPACE","\n\n",7],["T_USE","use",9],["T_WHITESPACE"," ",9],["T_STRING","Magento",9],["T_NS_SEPARATOR","\\",9],["T_STRING","Backend",9],["T_NS_SEPARATOR","\\",9],["T_STRING","App",9],["T_NS_SEPARATOR","\\",9],["T_STRING","Action",9],";",["T_WHITESPACE","\n",9],["T_USE","use",10],["T_WHITESPACE"," ",10],["T_STRING","Magento",10],["T_NS_SEPARATOR","\\",10],["T_STRING","Framework",10],["T_NS_SEPARATOR","\\",10],["T_STRING","Exception",10],["T_NS_SEPARATOR","\\",10],["T_STRING","LocalizedException",10],";",["T_WHITESPACE","\n",10],["T_USE","use",11],["T_WHITESPACE"," ",11],["T_STRING","Magento",11],["T_NS_SEPARATOR","\\",11],["T_STRING","Framework",11],["T_NS_SEPARATOR","\\",11],["T_STRING","Registry",11],";",["T_WHITESPACE","\n",11],["T_USE","use",12],["T_WHITESPACE"," ",12],["T_STRING","Magento",12],["T_NS_SEPARATOR","\\",12],["T_STRING","Sales",12],["T_NS_SEPARATOR","\\",12],["T_STRING","Model",12],["T_NS_SEPARATOR","\\",12],["T_STRING","Order",12],["T_NS_SEPARATOR","\\",12],["T_STRING","Email",12],["T_NS_SEPARATOR","\\",12],["T_STRING","Sender",12],["T_NS_SEPARATOR","\\",12],["T_STRING","InvoiceSender",12],";",["T_WHITESPACE","\n",12],["T_USE","use",13],["T_WHITESPACE"," ",13],["T_STRING","Magento",13],["T_NS_SEPARATOR","\\",13],["T_STRING","Sales",13],["T_NS_SEPARATOR","\\",13],["T_STRING","Model",13],["T_NS_SEPARATOR","\\",13],["T_STRING","Order",13],["T_NS_SEPARATOR","\\",13],["T_STRING","Email",13],["T_NS_SEPARATOR","\\",13],["T_STRING","Sender",13],["T_NS_SEPARATOR","\\",13],["T_STRING","ShipmentSender",13],";",["T_WHITESPACE","\n",13],["T_USE","use",14],["T_WHITESPACE"," ",14],["T_STRING","Magento",14],["T_NS_SEPARATOR","\\",14],["T_STRING","Sales",14],["T_NS_SEPARATOR","\\",14],["T_STRING","Model",14],["T_NS_SEPARATOR","\\",14],["T_STRING","Order",14],["T_NS_SEPARATOR","\\",14],["T_STRING","ShipmentFactory",14],";",["T_WHITESPACE","\n",14],["T_USE","use",15],["T_WHITESPACE"," ",15],["T_STRING","Magento",15],["T_NS_SEPARATOR","\\",15],["T_STRING","Sales",15],["T_NS_SEPARATOR","\\",15],["T_STRING","Model",15],["T_NS_SEPARATOR","\\",15],["T_STRING","Order",15],["T_NS_SEPARATOR","\\",15],["T_STRING","Invoice",15],";",["T_WHITESPACE","\n",15],["T_USE","use",16],["T_WHITESPACE"," ",16],["T_STRING","Magento",16],["T_NS_SEPARATOR","\\",16],["T_STRING","Sales",16],["T_NS_SEPARATOR","\\",16],["T_STRING","Model",16],["T_NS_SEPARATOR","\\",16],["T_STRING","Service",16],["T_NS_SEPARATOR","\\",16],["T_STRING","InvoiceService",16],";",["T_WHITESPACE","\n\n",16],["T_DOC_COMMENT","\/**\n * @SuppressWarnings(PHPMD.CouplingBetweenObjects)\n *\/",18],["T_WHITESPACE","\n",20],["T_CLASS","class",21],["T_WHITESPACE"," ",21],["T_STRING","Save",21],["T_WHITESPACE"," ",21],["T_EXTENDS","extends",21],["T_WHITESPACE"," ",21],["T_NS_SEPARATOR","\\",21],["T_STRING","Magento",21],["T_NS_SEPARATOR","\\",21],["T_STRING","Backend",21],["T_NS_SEPARATOR","\\",21],["T_STRING","App",21],["T_NS_SEPARATOR","\\",21],["T_STRING","Action",21],["T_WHITESPACE","\n",21],"{",["T_WHITESPACE","\n    ",22],["T_DOC_COMMENT","\/**\n     * Authorization level of a basic admin session\n     *\n     * @see _isAllowed()\n     *\/",23],["T_WHITESPACE","\n    ",27],["T_CONST","const",28],["T_WHITESPACE"," ",28],["T_STRING","ADMIN_RESOURCE",28],["T_WHITESPACE"," ",28],"=",["T_WHITESPACE"," ",28],["T_CONSTANT_ENCAPSED_STRING","'Magento_Sales::sales_invoice'",28],";",["T_WHITESPACE","\n\n    ",28],["T_DOC_COMMENT","\/**\n     * @var InvoiceSender\n     *\/",30],["T_WHITESPACE","\n    ",32],["T_PROTECTED","protected",33],["T_WHITESPACE"," ",33],["T_VARIABLE","$invoiceSender",33],";",["T_WHITESPACE","\n\n    ",33],["T_DOC_COMMENT","\/**\n     * @var ShipmentSender\n     *\/",35],["T_WHITESPACE","\n    ",37],["T_PROTECTED","protected",38],["T_WHITESPACE"," ",38],["T_VARIABLE","$shipmentSender",38],";",["T_WHITESPACE","\n\n    ",38],["T_DOC_COMMENT","\/**\n     * @var ShipmentFactory\n     *\/",40],["T_WHITESPACE","\n    ",42],["T_PROTECTED","protected",43],["T_WHITESPACE"," ",43],["T_VARIABLE","$shipmentFactory",43],";",["T_WHITESPACE","\n\n    ",43],["T_DOC_COMMENT","\/**\n     * @var Registry\n     *\/",45],["T_WHITESPACE","\n    ",47],["T_PROTECTED","protected",48],["T_WHITESPACE"," ",48],["T_VARIABLE","$registry",48],";",["T_WHITESPACE","\n\n    ",48],["T_DOC_COMMENT","\/**\n     * @var InvoiceService\n     *\/",50],["T_WHITESPACE","\n    ",52],["T_PRIVATE","private",53],["T_WHITESPACE"," ",53],["T_VARIABLE","$invoiceService",53],";",["T_WHITESPACE","\n\n    ",53],["T_DOC_COMMENT","\/**\n     * @param Action\\Context $context\n     * @param Registry $registry\n     * @param InvoiceSender $invoiceSender\n     * @param ShipmentSender $shipmentSender\n     * @param ShipmentFactory $shipmentFactory\n     * @param InvoiceService $invoiceService\n     *\/",55],["T_WHITESPACE","\n    ",62],["T_PUBLIC","public",63],["T_WHITESPACE"," ",63],["T_FUNCTION","function",63],["T_WHITESPACE"," ",63],["T_STRING","__construct",63],"(",["T_WHITESPACE","\n        ",63],["T_STRING","Action",64],["T_NS_SEPARATOR","\\",64],["T_STRING","Context",64],["T_WHITESPACE"," ",64],["T_VARIABLE","$context",64],",",["T_WHITESPACE","\n        ",64],["T_STRING","Registry",65],["T_WHITESPACE"," ",65],["T_VARIABLE","$registry",65],",",["T_WHITESPACE","\n        ",65],["T_STRING","InvoiceSender",66],["T_WHITESPACE"," ",66],["T_VARIABLE","$invoiceSender",66],",",["T_WHITESPACE","\n        ",66],["T_STRING","ShipmentSender",67],["T_WHITESPACE"," ",67],["T_VARIABLE","$shipmentSender",67],",",["T_WHITESPACE","\n        ",67],["T_STRING","ShipmentFactory",68],["T_WHITESPACE"," ",68],["T_VARIABLE","$shipmentFactory",68],",",["T_WHITESPACE","\n        ",68],["T_STRING","InvoiceService",69],["T_WHITESPACE"," ",69],["T_VARIABLE","$invoiceService",69],["T_WHITESPACE","\n    ",69],")",["T_WHITESPACE"," ",70],"{",["T_WHITESPACE","\n        ",70],["T_VARIABLE","$this",71],["T_OBJECT_OPERATOR","->",71],["T_STRING","registry",71],["T_WHITESPACE"," ",71],"=",["T_WHITESPACE"," ",71],["T_VARIABLE","$registry",71],";",["T_WHITESPACE","\n        ",71],["T_VARIABLE","$this",72],["T_OBJECT_OPERATOR","->",72],["T_STRING","invoiceSender",72],["T_WHITESPACE"," ",72],"=",["T_WHITESPACE"," ",72],["T_VARIABLE","$invoiceSender",72],";",["T_WHITESPACE","\n        ",72],["T_VARIABLE","$this",73],["T_OBJECT_OPERATOR","->",73],["T_STRING","shipmentSender",73],["T_WHITESPACE"," ",73],"=",["T_WHITESPACE"," ",73],["T_VARIABLE","$shipmentSender",73],";",["T_WHITESPACE","\n        ",73],["T_VARIABLE","$this",74],["T_OBJECT_OPERATOR","->",74],["T_STRING","shipmentFactory",74],["T_WHITESPACE"," ",74],"=",["T_WHITESPACE"," ",74],["T_VARIABLE","$shipmentFactory",74],";",["T_WHITESPACE","\n        ",74],["T_VARIABLE","$this",75],["T_OBJECT_OPERATOR","->",75],["T_STRING","invoiceService",75],["T_WHITESPACE"," ",75],"=",["T_WHITESPACE"," ",75],["T_VARIABLE","$invoiceService",75],";",["T_WHITESPACE","\n        ",75],["T_STRING","parent",76],["T_DOUBLE_COLON","::",76],["T_STRING","__construct",76],"(",["T_VARIABLE","$context",76],")",";",["T_WHITESPACE","\n    ",76],"}",["T_WHITESPACE","\n\n    ",77],["T_DOC_COMMENT","\/**\n     * Prepare shipment\n     *\n     * @param \\Magento\\Sales\\Model\\Order\\Invoice $invoice\n     * @return \\Magento\\Sales\\Model\\Order\\Shipment|false\n     *\/",79],["T_WHITESPACE","\n    ",84],["T_PROTECTED","protected",85],["T_WHITESPACE"," ",85],["T_FUNCTION","function",85],["T_WHITESPACE"," ",85],["T_STRING","_prepareShipment",85],"(",["T_VARIABLE","$invoice",85],")",["T_WHITESPACE","\n    ",85],"{",["T_WHITESPACE","\n        ",86],["T_VARIABLE","$invoiceData",87],["T_WHITESPACE"," ",87],"=",["T_WHITESPACE"," ",87],["T_VARIABLE","$this",87],["T_OBJECT_OPERATOR","->",87],["T_STRING","getRequest",87],"(",")",["T_OBJECT_OPERATOR","->",87],["T_STRING","getParam",87],"(",["T_CONSTANT_ENCAPSED_STRING","'invoice'",87],")",";",["T_WHITESPACE","\n\n        ",87],["T_VARIABLE","$shipment",89],["T_WHITESPACE"," ",89],"=",["T_WHITESPACE"," ",89],["T_VARIABLE","$this",89],["T_OBJECT_OPERATOR","->",89],["T_STRING","shipmentFactory",89],["T_OBJECT_OPERATOR","->",89],["T_STRING","create",89],"(",["T_WHITESPACE","\n            ",89],["T_VARIABLE","$invoice",90],["T_OBJECT_OPERATOR","->",90],["T_STRING","getOrder",90],"(",")",",",["T_WHITESPACE","\n            ",90],["T_ISSET","isset",91],"(",["T_VARIABLE","$invoiceData",91],"[",["T_CONSTANT_ENCAPSED_STRING","'items'",91],"]",")",["T_WHITESPACE"," ",91],"?",["T_WHITESPACE"," ",91],["T_VARIABLE","$invoiceData",91],"[",["T_CONSTANT_ENCAPSED_STRING","'items'",91],"]",["T_WHITESPACE"," ",91],":",["T_WHITESPACE"," ",91],"[","]",",",["T_WHITESPACE","\n            ",91],["T_VARIABLE","$this",92],["T_OBJECT_OPERATOR","->",92],["T_STRING","getRequest",92],"(",")",["T_OBJECT_OPERATOR","->",92],["T_STRING","getPost",92],"(",["T_CONSTANT_ENCAPSED_STRING","'tracking'",92],")",["T_WHITESPACE","\n        ",92],")",";",["T_WHITESPACE","\n\n        ",93],["T_IF","if",95],["T_WHITESPACE"," ",95],"(","!",["T_VARIABLE","$shipment",95],["T_OBJECT_OPERATOR","->",95],["T_STRING","getTotalQty",95],"(",")",")",["T_WHITESPACE"," ",95],"{",["T_WHITESPACE","\n            ",95],["T_RETURN","return",96],["T_WHITESPACE"," ",96],["T_STRING","false",96],";",["T_WHITESPACE","\n        ",96],"}",["T_WHITESPACE","\n\n        ",97],["T_RETURN","return",99],["T_WHITESPACE"," ",99],["T_VARIABLE","$shipment",99],["T_OBJECT_OPERATOR","->",99],["T_STRING","register",99],"(",")",";",["T_WHITESPACE","\n    ",99],"}",["T_WHITESPACE","\n\n    ",100],["T_DOC_COMMENT","\/**\n     * Save invoice\n     * We can save only new invoice. Existing invoices are not editable\n     *\n     * @return \\Magento\\Framework\\Controller\\ResultInterface\n     *\n     * @SuppressWarnings(PHPMD.CyclomaticComplexity)\n     * @SuppressWarnings(PHPMD.NPathComplexity)\n     * @SuppressWarnings(PHPMD.ExcessiveMethodLength)\n     *\/",102],["T_WHITESPACE","\n    ",111],["T_PUBLIC","public",112],["T_WHITESPACE"," ",112],["T_FUNCTION","function",112],["T_WHITESPACE"," ",112],["T_STRING","execute",112],"(",")",["T_WHITESPACE","\n    ",112],"{",["T_WHITESPACE","\n        ",113],["T_DOC_COMMENT","\/** @var \\Magento\\Backend\\Model\\View\\Result\\Redirect $resultRedirect *\/",114],["T_WHITESPACE","\n        ",114],["T_VARIABLE","$resultRedirect",115],["T_WHITESPACE"," ",115],"=",["T_WHITESPACE"," ",115],["T_VARIABLE","$this",115],["T_OBJECT_OPERATOR","->",115],["T_STRING","resultRedirectFactory",115],["T_OBJECT_OPERATOR","->",115],["T_STRING","create",115],"(",")",";",["T_WHITESPACE","\n\n        ",115],["T_VARIABLE","$formKeyIsValid",117],["T_WHITESPACE"," ",117],"=",["T_WHITESPACE"," ",117],["T_VARIABLE","$this",117],["T_OBJECT_OPERATOR","->",117],["T_STRING","_formKeyValidator",117],["T_OBJECT_OPERATOR","->",117],["T_STRING","validate",117],"(",["T_VARIABLE","$this",117],["T_OBJECT_OPERATOR","->",117],["T_STRING","getRequest",117],"(",")",")",";",["T_WHITESPACE","\n        ",117],["T_VARIABLE","$isPost",118],["T_WHITESPACE"," ",118],"=",["T_WHITESPACE"," ",118],["T_VARIABLE","$this",118],["T_OBJECT_OPERATOR","->",118],["T_STRING","getRequest",118],"(",")",["T_OBJECT_OPERATOR","->",118],["T_STRING","isPost",118],"(",")",";",["T_WHITESPACE","\n        ",118],["T_IF","if",119],["T_WHITESPACE"," ",119],"(","!",["T_VARIABLE","$formKeyIsValid",119],["T_WHITESPACE"," ",119],["T_BOOLEAN_OR","||",119],["T_WHITESPACE"," ",119],"!",["T_VARIABLE","$isPost",119],")",["T_WHITESPACE"," ",119],"{",["T_WHITESPACE","\n            ",119],["T_VARIABLE","$this",120],["T_OBJECT_OPERATOR","->",120],["T_STRING","messageManager",120],["T_OBJECT_OPERATOR","->",120],["T_STRING","addError",120],"(",["T_STRING","__",120],"(",["T_CONSTANT_ENCAPSED_STRING","'We can\\'t save the invoice right now.'",120],")",")",";",["T_WHITESPACE","\n            ",120],["T_RETURN","return",121],["T_WHITESPACE"," ",121],["T_VARIABLE","$resultRedirect",121],["T_OBJECT_OPERATOR","->",121],["T_STRING","setPath",121],"(",["T_CONSTANT_ENCAPSED_STRING","'sales\/order\/index'",121],")",";",["T_WHITESPACE","\n        ",121],"}",["T_WHITESPACE","\n\n        ",122],["T_VARIABLE","$data",124],["T_WHITESPACE"," ",124],"=",["T_WHITESPACE"," ",124],["T_VARIABLE","$this",124],["T_OBJECT_OPERATOR","->",124],["T_STRING","getRequest",124],"(",")",["T_OBJECT_OPERATOR","->",124],["T_STRING","getPost",124],"(",["T_CONSTANT_ENCAPSED_STRING","'invoice'",124],")",";",["T_WHITESPACE","\n        ",124],["T_VARIABLE","$orderId",125],["T_WHITESPACE"," ",125],"=",["T_WHITESPACE"," ",125],["T_VARIABLE","$this",125],["T_OBJECT_OPERATOR","->",125],["T_STRING","getRequest",125],"(",")",["T_OBJECT_OPERATOR","->",125],["T_STRING","getParam",125],"(",["T_CONSTANT_ENCAPSED_STRING","'order_id'",125],")",";",["T_WHITESPACE","\n\n        ",125],["T_IF","if",127],["T_WHITESPACE"," ",127],"(","!",["T_EMPTY","empty",127],"(",["T_VARIABLE","$data",127],"[",["T_CONSTANT_ENCAPSED_STRING","'comment_text'",127],"]",")",")",["T_WHITESPACE"," ",127],"{",["T_WHITESPACE","\n            ",127],["T_VARIABLE","$this",128],["T_OBJECT_OPERATOR","->",128],["T_STRING","_objectManager",128],["T_OBJECT_OPERATOR","->",128],["T_STRING","get",128],"(",["T_NS_SEPARATOR","\\",128],["T_STRING","Magento",128],["T_NS_SEPARATOR","\\",128],["T_STRING","Backend",128],["T_NS_SEPARATOR","\\",128],["T_STRING","Model",128],["T_NS_SEPARATOR","\\",128],["T_STRING","Session",128],["T_DOUBLE_COLON","::",128],["T_CLASS","class",128],")",["T_OBJECT_OPERATOR","->",128],["T_STRING","setCommentText",128],"(",["T_VARIABLE","$data",128],"[",["T_CONSTANT_ENCAPSED_STRING","'comment_text'",128],"]",")",";",["T_WHITESPACE","\n        ",128],"}",["T_WHITESPACE","\n\n        ",129],["T_TRY","try",131],["T_WHITESPACE"," ",131],"{",["T_WHITESPACE","\n            ",131],["T_VARIABLE","$invoiceData",132],["T_WHITESPACE"," ",132],"=",["T_WHITESPACE"," ",132],["T_VARIABLE","$this",132],["T_OBJECT_OPERATOR","->",132],["T_STRING","getRequest",132],"(",")",["T_OBJECT_OPERATOR","->",132],["T_STRING","getParam",132],"(",["T_CONSTANT_ENCAPSED_STRING","'invoice'",132],",",["T_WHITESPACE"," ",132],"[","]",")",";",["T_WHITESPACE","\n            ",132],["T_VARIABLE","$invoiceItems",133],["T_WHITESPACE"," ",133],"=",["T_WHITESPACE"," ",133],["T_ISSET","isset",133],"(",["T_VARIABLE","$invoiceData",133],"[",["T_CONSTANT_ENCAPSED_STRING","'items'",133],"]",")",["T_WHITESPACE"," ",133],"?",["T_WHITESPACE"," ",133],["T_VARIABLE","$invoiceData",133],"[",["T_CONSTANT_ENCAPSED_STRING","'items'",133],"]",["T_WHITESPACE"," ",133],":",["T_WHITESPACE"," ",133],"[","]",";",["T_WHITESPACE","\n            ",133],["T_DOC_COMMENT","\/** @var \\Magento\\Sales\\Model\\Order $order *\/",134],["T_WHITESPACE","\n            ",134],["T_VARIABLE","$order",135],["T_WHITESPACE"," ",135],"=",["T_WHITESPACE"," ",135],["T_VARIABLE","$this",135],["T_OBJECT_OPERATOR","->",135],["T_STRING","_objectManager",135],["T_OBJECT_OPERATOR","->",135],["T_STRING","create",135],"(",["T_NS_SEPARATOR","\\",135],["T_STRING","Magento",135],["T_NS_SEPARATOR","\\",135],["T_STRING","Sales",135],["T_NS_SEPARATOR","\\",135],["T_STRING","Model",135],["T_NS_SEPARATOR","\\",135],["T_STRING","Order",135],["T_DOUBLE_COLON","::",135],["T_CLASS","class",135],")",["T_OBJECT_OPERATOR","->",135],["T_STRING","load",135],"(",["T_VARIABLE","$orderId",135],")",";",["T_WHITESPACE","\n            ",135],["T_IF","if",136],["T_WHITESPACE"," ",136],"(","!",["T_VARIABLE","$order",136],["T_OBJECT_OPERATOR","->",136],["T_STRING","getId",136],"(",")",")",["T_WHITESPACE"," ",136],"{",["T_WHITESPACE","\n                ",136],["T_THROW","throw",137],["T_WHITESPACE"," ",137],["T_NEW","new",137],["T_WHITESPACE"," ",137],["T_NS_SEPARATOR","\\",137],["T_STRING","Magento",137],["T_NS_SEPARATOR","\\",137],["T_STRING","Framework",137],["T_NS_SEPARATOR","\\",137],["T_STRING","Exception",137],["T_NS_SEPARATOR","\\",137],["T_STRING","LocalizedException",137],"(",["T_STRING","__",137],"(",["T_CONSTANT_ENCAPSED_STRING","'The order no longer exists.'",137],")",")",";",["T_WHITESPACE","\n            ",137],"}",["T_WHITESPACE","\n\n            ",138],["T_IF","if",140],["T_WHITESPACE"," ",140],"(","!",["T_VARIABLE","$order",140],["T_OBJECT_OPERATOR","->",140],["T_STRING","canInvoice",140],"(",")",")",["T_WHITESPACE"," ",140],"{",["T_WHITESPACE","\n                ",140],["T_THROW","throw",141],["T_WHITESPACE"," ",141],["T_NEW","new",141],["T_WHITESPACE"," ",141],["T_NS_SEPARATOR","\\",141],["T_STRING","Magento",141],["T_NS_SEPARATOR","\\",141],["T_STRING","Framework",141],["T_NS_SEPARATOR","\\",141],["T_STRING","Exception",141],["T_NS_SEPARATOR","\\",141],["T_STRING","LocalizedException",141],"(",["T_WHITESPACE","\n                    ",141],["T_STRING","__",142],"(",["T_CONSTANT_ENCAPSED_STRING","'The order does not allow an invoice to be created.'",142],")",["T_WHITESPACE","\n                ",142],")",";",["T_WHITESPACE","\n            ",143],"}",["T_WHITESPACE","\n\n            ",144],["T_VARIABLE","$invoice",146],["T_WHITESPACE"," ",146],"=",["T_WHITESPACE"," ",146],["T_VARIABLE","$this",146],["T_OBJECT_OPERATOR","->",146],["T_STRING","invoiceService",146],["T_OBJECT_OPERATOR","->",146],["T_STRING","prepareInvoice",146],"(",["T_VARIABLE","$order",146],",",["T_WHITESPACE"," ",146],["T_VARIABLE","$invoiceItems",146],")",";",["T_WHITESPACE","\n\n            ",146],["T_IF","if",148],["T_WHITESPACE"," ",148],"(","!",["T_VARIABLE","$invoice",148],")",["T_WHITESPACE"," ",148],"{",["T_WHITESPACE","\n                ",148],["T_THROW","throw",149],["T_WHITESPACE"," ",149],["T_NEW","new",149],["T_WHITESPACE"," ",149],["T_STRING","LocalizedException",149],"(",["T_STRING","__",149],"(",["T_CONSTANT_ENCAPSED_STRING","'We can\\'t save the invoice right now.'",149],")",")",";",["T_WHITESPACE","\n            ",149],"}",["T_WHITESPACE","\n\n            ",150],["T_IF","if",152],["T_WHITESPACE"," ",152],"(","!",["T_VARIABLE","$invoice",152],["T_OBJECT_OPERATOR","->",152],["T_STRING","getTotalQty",152],"(",")",")",["T_WHITESPACE"," ",152],"{",["T_WHITESPACE","\n                ",152],["T_THROW","throw",153],["T_WHITESPACE"," ",153],["T_NEW","new",153],["T_WHITESPACE"," ",153],["T_NS_SEPARATOR","\\",153],["T_STRING","Magento",153],["T_NS_SEPARATOR","\\",153],["T_STRING","Framework",153],["T_NS_SEPARATOR","\\",153],["T_STRING","Exception",153],["T_NS_SEPARATOR","\\",153],["T_STRING","LocalizedException",153],"(",["T_WHITESPACE","\n                    ",153],["T_STRING","__",154],"(",["T_CONSTANT_ENCAPSED_STRING","'You can\\'t create an invoice without products.'",154],")",["T_WHITESPACE","\n                ",154],")",";",["T_WHITESPACE","\n            ",155],"}",["T_WHITESPACE","\n            ",156],["T_VARIABLE","$this",157],["T_OBJECT_OPERATOR","->",157],["T_STRING","registry",157],["T_OBJECT_OPERATOR","->",157],["T_STRING","register",157],"(",["T_CONSTANT_ENCAPSED_STRING","'current_invoice'",157],",",["T_WHITESPACE"," ",157],["T_VARIABLE","$invoice",157],")",";",["T_WHITESPACE","\n            ",157],["T_IF","if",158],["T_WHITESPACE"," ",158],"(","!",["T_EMPTY","empty",158],"(",["T_VARIABLE","$data",158],"[",["T_CONSTANT_ENCAPSED_STRING","'capture_case'",158],"]",")",")",["T_WHITESPACE"," ",158],"{",["T_WHITESPACE","\n                ",158],["T_VARIABLE","$invoice",159],["T_OBJECT_OPERATOR","->",159],["T_STRING","setRequestedCaptureCase",159],"(",["T_VARIABLE","$data",159],"[",["T_CONSTANT_ENCAPSED_STRING","'capture_case'",159],"]",")",";",["T_WHITESPACE","\n            ",159],"}",["T_WHITESPACE","\n\n            ",160],["T_IF","if",162],["T_WHITESPACE"," ",162],"(","!",["T_EMPTY","empty",162],"(",["T_VARIABLE","$data",162],"[",["T_CONSTANT_ENCAPSED_STRING","'comment_text'",162],"]",")",")",["T_WHITESPACE"," ",162],"{",["T_WHITESPACE","\n                ",162],["T_VARIABLE","$invoice",163],["T_OBJECT_OPERATOR","->",163],["T_STRING","addComment",163],"(",["T_WHITESPACE","\n                    ",163],["T_VARIABLE","$data",164],"[",["T_CONSTANT_ENCAPSED_STRING","'comment_text'",164],"]",",",["T_WHITESPACE","\n                    ",164],["T_ISSET","isset",165],"(",["T_VARIABLE","$data",165],"[",["T_CONSTANT_ENCAPSED_STRING","'comment_customer_notify'",165],"]",")",",",["T_WHITESPACE","\n                    ",165],["T_ISSET","isset",166],"(",["T_VARIABLE","$data",166],"[",["T_CONSTANT_ENCAPSED_STRING","'is_visible_on_front'",166],"]",")",["T_WHITESPACE","\n                ",166],")",";",["T_WHITESPACE","\n\n                ",167],["T_VARIABLE","$invoice",169],["T_OBJECT_OPERATOR","->",169],["T_STRING","setCustomerNote",169],"(",["T_VARIABLE","$data",169],"[",["T_CONSTANT_ENCAPSED_STRING","'comment_text'",169],"]",")",";",["T_WHITESPACE","\n                ",169],["T_VARIABLE","$invoice",170],["T_OBJECT_OPERATOR","->",170],["T_STRING","setCustomerNoteNotify",170],"(",["T_ISSET","isset",170],"(",["T_VARIABLE","$data",170],"[",["T_CONSTANT_ENCAPSED_STRING","'comment_customer_notify'",170],"]",")",")",";",["T_WHITESPACE","\n            ",170],"}",["T_WHITESPACE","\n\n            ",171],["T_VARIABLE","$invoice",173],["T_OBJECT_OPERATOR","->",173],["T_STRING","register",173],"(",")",";",["T_WHITESPACE","\n\n            ",173],["T_VARIABLE","$invoice",175],["T_OBJECT_OPERATOR","->",175],["T_STRING","getOrder",175],"(",")",["T_OBJECT_OPERATOR","->",175],["T_STRING","setCustomerNoteNotify",175],"(","!",["T_EMPTY","empty",175],"(",["T_VARIABLE","$data",175],"[",["T_CONSTANT_ENCAPSED_STRING","'send_email'",175],"]",")",")",";",["T_WHITESPACE","\n            ",175],["T_VARIABLE","$invoice",176],["T_OBJECT_OPERATOR","->",176],["T_STRING","getOrder",176],"(",")",["T_OBJECT_OPERATOR","->",176],["T_STRING","setIsInProcess",176],"(",["T_STRING","true",176],")",";",["T_WHITESPACE","\n\n            ",176],["T_VARIABLE","$transactionSave",178],["T_WHITESPACE"," ",178],"=",["T_WHITESPACE"," ",178],["T_VARIABLE","$this",178],["T_OBJECT_OPERATOR","->",178],["T_STRING","_objectManager",178],["T_OBJECT_OPERATOR","->",178],["T_STRING","create",178],"(",["T_WHITESPACE","\n                ",178],["T_NS_SEPARATOR","\\",179],["T_STRING","Magento",179],["T_NS_SEPARATOR","\\",179],["T_STRING","Framework",179],["T_NS_SEPARATOR","\\",179],["T_STRING","DB",179],["T_NS_SEPARATOR","\\",179],["T_STRING","Transaction",179],["T_DOUBLE_COLON","::",179],["T_CLASS","class",179],["T_WHITESPACE","\n            ",179],")",["T_OBJECT_OPERATOR","->",180],["T_STRING","addObject",180],"(",["T_WHITESPACE","\n                ",180],["T_VARIABLE","$invoice",181],["T_WHITESPACE","\n            ",181],")",["T_OBJECT_OPERATOR","->",182],["T_STRING","addObject",182],"(",["T_WHITESPACE","\n                ",182],["T_VARIABLE","$invoice",183],["T_OBJECT_OPERATOR","->",183],["T_STRING","getOrder",183],"(",")",["T_WHITESPACE","\n            ",183],")",";",["T_WHITESPACE","\n            ",184],["T_VARIABLE","$shipment",185],["T_WHITESPACE"," ",185],"=",["T_WHITESPACE"," ",185],["T_STRING","false",185],";",["T_WHITESPACE","\n            ",185],["T_IF","if",186],["T_WHITESPACE"," ",186],"(","!",["T_EMPTY","empty",186],"(",["T_VARIABLE","$data",186],"[",["T_CONSTANT_ENCAPSED_STRING","'do_shipment'",186],"]",")",["T_WHITESPACE"," ",186],["T_BOOLEAN_OR","||",186],["T_WHITESPACE"," ",186],["T_INT_CAST","(int)",186],["T_VARIABLE","$invoice",186],["T_OBJECT_OPERATOR","->",186],["T_STRING","getOrder",186],"(",")",["T_OBJECT_OPERATOR","->",186],["T_STRING","getForcedShipmentWithInvoice",186],"(",")",")",["T_WHITESPACE"," ",186],"{",["T_WHITESPACE","\n                ",186],["T_VARIABLE","$shipment",187],["T_WHITESPACE"," ",187],"=",["T_WHITESPACE"," ",187],["T_VARIABLE","$this",187],["T_OBJECT_OPERATOR","->",187],["T_STRING","_prepareShipment",187],"(",["T_VARIABLE","$invoice",187],")",";",["T_WHITESPACE","\n                ",187],["T_IF","if",188],["T_WHITESPACE"," ",188],"(",["T_VARIABLE","$shipment",188],")",["T_WHITESPACE"," ",188],"{",["T_WHITESPACE","\n                    ",188],["T_VARIABLE","$transactionSave",189],["T_OBJECT_OPERATOR","->",189],["T_STRING","addObject",189],"(",["T_VARIABLE","$shipment",189],")",";",["T_WHITESPACE","\n                ",189],"}",["T_WHITESPACE","\n            ",190],"}",["T_WHITESPACE","\n            ",191],["T_VARIABLE","$transactionSave",192],["T_OBJECT_OPERATOR","->",192],["T_STRING","save",192],"(",")",";",["T_WHITESPACE","\n\n            ",192],["T_IF","if",194],["T_WHITESPACE"," ",194],"(",["T_ISSET","isset",194],"(",["T_VARIABLE","$shippingResponse",194],")",["T_WHITESPACE"," ",194],["T_BOOLEAN_AND","&&",194],["T_WHITESPACE"," ",194],["T_VARIABLE","$shippingResponse",194],["T_OBJECT_OPERATOR","->",194],["T_STRING","hasErrors",194],"(",")",")",["T_WHITESPACE"," ",194],"{",["T_WHITESPACE","\n                ",194],["T_VARIABLE","$this",195],["T_OBJECT_OPERATOR","->",195],["T_STRING","messageManager",195],["T_OBJECT_OPERATOR","->",195],["T_STRING","addError",195],"(",["T_WHITESPACE","\n                    ",195],["T_STRING","__",196],"(",["T_WHITESPACE","\n                        ",196],["T_CONSTANT_ENCAPSED_STRING","'The invoice and the shipment  have been created. '",197],["T_WHITESPACE"," ",197],".",["T_WHITESPACE","\n                        ",197],["T_CONSTANT_ENCAPSED_STRING","'The shipping label cannot be created now.'",198],["T_WHITESPACE","\n                    ",198],")",["T_WHITESPACE","\n                ",199],")",";",["T_WHITESPACE","\n            ",200],"}",["T_WHITESPACE"," ",201],["T_ELSEIF","elseif",201],["T_WHITESPACE"," ",201],"(","!",["T_EMPTY","empty",201],"(",["T_VARIABLE","$data",201],"[",["T_CONSTANT_ENCAPSED_STRING","'do_shipment'",201],"]",")",")",["T_WHITESPACE"," ",201],"{",["T_WHITESPACE","\n                ",201],["T_VARIABLE","$this",202],["T_OBJECT_OPERATOR","->",202],["T_STRING","messageManager",202],["T_OBJECT_OPERATOR","->",202],["T_STRING","addSuccess",202],"(",["T_STRING","__",202],"(",["T_CONSTANT_ENCAPSED_STRING","'You created the invoice and shipment.'",202],")",")",";",["T_WHITESPACE","\n            ",202],"}",["T_WHITESPACE"," ",203],["T_ELSE","else",203],["T_WHITESPACE"," ",203],"{",["T_WHITESPACE","\n                ",203],["T_VARIABLE","$this",204],["T_OBJECT_OPERATOR","->",204],["T_STRING","messageManager",204],["T_OBJECT_OPERATOR","->",204],["T_STRING","addSuccess",204],"(",["T_STRING","__",204],"(",["T_CONSTANT_ENCAPSED_STRING","'The invoice has been created.'",204],")",")",";",["T_WHITESPACE","\n            ",204],"}",["T_WHITESPACE","\n\n            ",205],["T_COMMENT","\/\/ send invoice\/shipment emails\n",207],["T_WHITESPACE","            ",208],["T_TRY","try",208],["T_WHITESPACE"," ",208],"{",["T_WHITESPACE","\n                ",208],["T_IF","if",209],["T_WHITESPACE"," ",209],"(","!",["T_EMPTY","empty",209],"(",["T_VARIABLE","$data",209],"[",["T_CONSTANT_ENCAPSED_STRING","'send_email'",209],"]",")",")",["T_WHITESPACE"," ",209],"{",["T_WHITESPACE","\n                    ",209],["T_VARIABLE","$this",210],["T_OBJECT_OPERATOR","->",210],["T_STRING","invoiceSender",210],["T_OBJECT_OPERATOR","->",210],["T_STRING","send",210],"(",["T_VARIABLE","$invoice",210],")",";",["T_WHITESPACE","\n                ",210],"}",["T_WHITESPACE","\n            ",211],"}",["T_WHITESPACE"," ",212],["T_CATCH","catch",212],["T_WHITESPACE"," ",212],"(",["T_NS_SEPARATOR","\\",212],["T_STRING","Exception",212],["T_WHITESPACE"," ",212],["T_VARIABLE","$e",212],")",["T_WHITESPACE"," ",212],"{",["T_WHITESPACE","\n                ",212],["T_VARIABLE","$this",213],["T_OBJECT_OPERATOR","->",213],["T_STRING","_objectManager",213],["T_OBJECT_OPERATOR","->",213],["T_STRING","get",213],"(",["T_NS_SEPARATOR","\\",213],["T_STRING","Psr",213],["T_NS_SEPARATOR","\\",213],["T_STRING","Log",213],["T_NS_SEPARATOR","\\",213],["T_STRING","LoggerInterface",213],["T_DOUBLE_COLON","::",213],["T_CLASS","class",213],")",["T_OBJECT_OPERATOR","->",213],["T_STRING","critical",213],"(",["T_VARIABLE","$e",213],")",";",["T_WHITESPACE","\n                ",213],["T_VARIABLE","$this",214],["T_OBJECT_OPERATOR","->",214],["T_STRING","messageManager",214],["T_OBJECT_OPERATOR","->",214],["T_STRING","addError",214],"(",["T_STRING","__",214],"(",["T_CONSTANT_ENCAPSED_STRING","'We can\\'t send the invoice email right now.'",214],")",")",";",["T_WHITESPACE","\n            ",214],"}",["T_WHITESPACE","\n            ",215],["T_IF","if",216],["T_WHITESPACE"," ",216],"(",["T_VARIABLE","$shipment",216],")",["T_WHITESPACE"," ",216],"{",["T_WHITESPACE","\n                ",216],["T_TRY","try",217],["T_WHITESPACE"," ",217],"{",["T_WHITESPACE","\n                    ",217],["T_IF","if",218],["T_WHITESPACE"," ",218],"(","!",["T_EMPTY","empty",218],"(",["T_VARIABLE","$data",218],"[",["T_CONSTANT_ENCAPSED_STRING","'send_email'",218],"]",")",")",["T_WHITESPACE"," ",218],"{",["T_WHITESPACE","\n                        ",218],["T_VARIABLE","$this",219],["T_OBJECT_OPERATOR","->",219],["T_STRING","shipmentSender",219],["T_OBJECT_OPERATOR","->",219],["T_STRING","send",219],"(",["T_VARIABLE","$shipment",219],")",";",["T_WHITESPACE","\n                    ",219],"}",["T_WHITESPACE","\n                ",220],"}",["T_WHITESPACE"," ",221],["T_CATCH","catch",221],["T_WHITESPACE"," ",221],"(",["T_NS_SEPARATOR","\\",221],["T_STRING","Exception",221],["T_WHITESPACE"," ",221],["T_VARIABLE","$e",221],")",["T_WHITESPACE"," ",221],"{",["T_WHITESPACE","\n                    ",221],["T_VARIABLE","$this",222],["T_OBJECT_OPERATOR","->",222],["T_STRING","_objectManager",222],["T_OBJECT_OPERATOR","->",222],["T_STRING","get",222],"(",["T_NS_SEPARATOR","\\",222],["T_STRING","Psr",222],["T_NS_SEPARATOR","\\",222],["T_STRING","Log",222],["T_NS_SEPARATOR","\\",222],["T_STRING","LoggerInterface",222],["T_DOUBLE_COLON","::",222],["T_CLASS","class",222],")",["T_OBJECT_OPERATOR","->",222],["T_STRING","critical",222],"(",["T_VARIABLE","$e",222],")",";",["T_WHITESPACE","\n                    ",222],["T_VARIABLE","$this",223],["T_OBJECT_OPERATOR","->",223],["T_STRING","messageManager",223],["T_OBJECT_OPERATOR","->",223],["T_STRING","addError",223],"(",["T_STRING","__",223],"(",["T_CONSTANT_ENCAPSED_STRING","'We can\\'t send the shipment right now.'",223],")",")",";",["T_WHITESPACE","\n                ",223],"}",["T_WHITESPACE","\n            ",224],"}",["T_WHITESPACE","\n            ",225],["T_VARIABLE","$this",226],["T_OBJECT_OPERATOR","->",226],["T_STRING","_objectManager",226],["T_OBJECT_OPERATOR","->",226],["T_STRING","get",226],"(",["T_NS_SEPARATOR","\\",226],["T_STRING","Magento",226],["T_NS_SEPARATOR","\\",226],["T_STRING","Backend",226],["T_NS_SEPARATOR","\\",226],["T_STRING","Model",226],["T_NS_SEPARATOR","\\",226],["T_STRING","Session",226],["T_DOUBLE_COLON","::",226],["T_CLASS","class",226],")",["T_OBJECT_OPERATOR","->",226],["T_STRING","getCommentText",226],"(",["T_STRING","true",226],")",";",["T_WHITESPACE","\n            ",226],["T_RETURN","return",227],["T_WHITESPACE"," ",227],["T_VARIABLE","$resultRedirect",227],["T_OBJECT_OPERATOR","->",227],["T_STRING","setPath",227],"(",["T_CONSTANT_ENCAPSED_STRING","'sales\/order\/view'",227],",",["T_WHITESPACE"," ",227],"[",["T_CONSTANT_ENCAPSED_STRING","'order_id'",227],["T_WHITESPACE"," ",227],["T_DOUBLE_ARROW","=>",227],["T_WHITESPACE"," ",227],["T_VARIABLE","$orderId",227],"]",")",";",["T_WHITESPACE","\n        ",227],"}",["T_WHITESPACE"," ",228],["T_CATCH","catch",228],["T_WHITESPACE"," ",228],"(",["T_STRING","LocalizedException",228],["T_WHITESPACE"," ",228],["T_VARIABLE","$e",228],")",["T_WHITESPACE"," ",228],"{",["T_WHITESPACE","\n            ",228],["T_VARIABLE","$this",229],["T_OBJECT_OPERATOR","->",229],["T_STRING","messageManager",229],["T_OBJECT_OPERATOR","->",229],["T_STRING","addError",229],"(",["T_VARIABLE","$e",229],["T_OBJECT_OPERATOR","->",229],["T_STRING","getMessage",229],"(",")",")",";",["T_WHITESPACE","\n        ",229],"}",["T_WHITESPACE"," ",230],["T_CATCH","catch",230],["T_WHITESPACE"," ",230],"(",["T_NS_SEPARATOR","\\",230],["T_STRING","Exception",230],["T_WHITESPACE"," ",230],["T_VARIABLE","$e",230],")",["T_WHITESPACE"," ",230],"{",["T_WHITESPACE","\n            ",230],["T_VARIABLE","$this",231],["T_OBJECT_OPERATOR","->",231],["T_STRING","messageManager",231],["T_OBJECT_OPERATOR","->",231],["T_STRING","addError",231],"(",["T_STRING","__",231],"(",["T_CONSTANT_ENCAPSED_STRING","'We can\\'t save the invoice right now.'",231],")",")",";",["T_WHITESPACE","\n            ",231],["T_VARIABLE","$this",232],["T_OBJECT_OPERATOR","->",232],["T_STRING","_objectManager",232],["T_OBJECT_OPERATOR","->",232],["T_STRING","get",232],"(",["T_NS_SEPARATOR","\\",232],["T_STRING","Psr",232],["T_NS_SEPARATOR","\\",232],["T_STRING","Log",232],["T_NS_SEPARATOR","\\",232],["T_STRING","LoggerInterface",232],["T_DOUBLE_COLON","::",232],["T_CLASS","class",232],")",["T_OBJECT_OPERATOR","->",232],["T_STRING","critical",232],"(",["T_VARIABLE","$e",232],")",";",["T_WHITESPACE","\n        ",232],"}",["T_WHITESPACE","\n        ",233],["T_RETURN","return",234],["T_WHITESPACE"," ",234],["T_VARIABLE","$resultRedirect",234],["T_OBJECT_OPERATOR","->",234],["T_STRING","setPath",234],"(",["T_CONSTANT_ENCAPSED_STRING","'sales\/*\/new'",234],",",["T_WHITESPACE"," ",234],"[",["T_CONSTANT_ENCAPSED_STRING","'order_id'",234],["T_WHITESPACE"," ",234],["T_DOUBLE_ARROW","=>",234],["T_WHITESPACE"," ",234],["T_VARIABLE","$orderId",234],"]",")",";",["T_WHITESPACE","\n    ",234],"}",["T_WHITESPACE","\n",235],"}",["T_WHITESPACE","\n",236]]