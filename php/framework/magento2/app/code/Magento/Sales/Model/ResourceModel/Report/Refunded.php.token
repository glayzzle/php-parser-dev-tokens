[["T_OPEN_TAG","<?php\n",1],["T_DOC_COMMENT","\/**\n * Copyright \u00c2\u00a9 2013-2017 Magento, Inc. All rights reserved.\n * See COPYING.txt for license details.\n *\/",2],["T_WHITESPACE","\n",5],["T_NAMESPACE","namespace",6],["T_WHITESPACE"," ",6],["T_STRING","Magento",6],["T_NS_SEPARATOR","\\",6],["T_STRING","Sales",6],["T_NS_SEPARATOR","\\",6],["T_STRING","Model",6],["T_NS_SEPARATOR","\\",6],["T_STRING","ResourceModel",6],["T_NS_SEPARATOR","\\",6],["T_STRING","Report",6],";",["T_WHITESPACE","\n\n",6],["T_DOC_COMMENT","\/**\n * Refund report resource model\n *\n * @author      Magento Core Team <core@magentocommerce.com>\n *\/",8],["T_WHITESPACE","\n",12],["T_CLASS","class",13],["T_WHITESPACE"," ",13],["T_STRING","Refunded",13],["T_WHITESPACE"," ",13],["T_EXTENDS","extends",13],["T_WHITESPACE"," ",13],["T_STRING","AbstractReport",13],["T_WHITESPACE","\n",13],"{",["T_WHITESPACE","\n    ",14],["T_DOC_COMMENT","\/**\n     * Model initialization\n     *\n     * @return void\n     *\/",15],["T_WHITESPACE","\n    ",19],["T_PROTECTED","protected",20],["T_WHITESPACE"," ",20],["T_FUNCTION","function",20],["T_WHITESPACE"," ",20],["T_STRING","_construct",20],"(",")",["T_WHITESPACE","\n    ",20],"{",["T_WHITESPACE","\n        ",21],["T_VARIABLE","$this",22],["T_OBJECT_OPERATOR","->",22],["T_STRING","_setResource",22],"(",["T_CONSTANT_ENCAPSED_STRING","'sales'",22],")",";",["T_WHITESPACE","\n    ",22],"}",["T_WHITESPACE","\n\n    ",23],["T_DOC_COMMENT","\/**\n     * Aggregate Refunded data\n     *\n     * @param string|int|\\DateTime|array|null $from\n     * @param string|int|\\DateTime|array|null $to\n     * @return $this\n     *\/",25],["T_WHITESPACE","\n    ",31],["T_PUBLIC","public",32],["T_WHITESPACE"," ",32],["T_FUNCTION","function",32],["T_WHITESPACE"," ",32],["T_STRING","aggregate",32],"(",["T_VARIABLE","$from",32],["T_WHITESPACE"," ",32],"=",["T_WHITESPACE"," ",32],["T_STRING","null",32],",",["T_WHITESPACE"," ",32],["T_VARIABLE","$to",32],["T_WHITESPACE"," ",32],"=",["T_WHITESPACE"," ",32],["T_STRING","null",32],")",["T_WHITESPACE","\n    ",32],"{",["T_WHITESPACE","\n        ",33],["T_VARIABLE","$this",34],["T_OBJECT_OPERATOR","->",34],["T_STRING","_aggregateByOrderCreatedAt",34],"(",["T_VARIABLE","$from",34],",",["T_WHITESPACE"," ",34],["T_VARIABLE","$to",34],")",";",["T_WHITESPACE","\n        ",34],["T_VARIABLE","$this",35],["T_OBJECT_OPERATOR","->",35],["T_STRING","_aggregateByRefundCreatedAt",35],"(",["T_VARIABLE","$from",35],",",["T_WHITESPACE"," ",35],["T_VARIABLE","$to",35],")",";",["T_WHITESPACE","\n\n        ",35],["T_VARIABLE","$this",37],["T_OBJECT_OPERATOR","->",37],["T_STRING","_setFlagData",37],"(",["T_NS_SEPARATOR","\\",37],["T_STRING","Magento",37],["T_NS_SEPARATOR","\\",37],["T_STRING","Reports",37],["T_NS_SEPARATOR","\\",37],["T_STRING","Model",37],["T_NS_SEPARATOR","\\",37],["T_STRING","Flag",37],["T_DOUBLE_COLON","::",37],["T_STRING","REPORT_REFUNDED_FLAG_CODE",37],")",";",["T_WHITESPACE","\n        ",37],["T_RETURN","return",38],["T_WHITESPACE"," ",38],["T_VARIABLE","$this",38],";",["T_WHITESPACE","\n    ",38],"}",["T_WHITESPACE","\n\n    ",39],["T_DOC_COMMENT","\/**\n     * Aggregate refunded data by order created at as period\n     *\n     * @param string|null $from\n     * @param string|null $to\n     * @return $this\n     * @throws \\Exception\n     *\/",41],["T_WHITESPACE","\n    ",48],["T_PROTECTED","protected",49],["T_WHITESPACE"," ",49],["T_FUNCTION","function",49],["T_WHITESPACE"," ",49],["T_STRING","_aggregateByOrderCreatedAt",49],"(",["T_VARIABLE","$from",49],",",["T_WHITESPACE"," ",49],["T_VARIABLE","$to",49],")",["T_WHITESPACE","\n    ",49],"{",["T_WHITESPACE","\n        ",50],["T_VARIABLE","$table",51],["T_WHITESPACE"," ",51],"=",["T_WHITESPACE"," ",51],["T_VARIABLE","$this",51],["T_OBJECT_OPERATOR","->",51],["T_STRING","getTable",51],"(",["T_CONSTANT_ENCAPSED_STRING","'sales_refunded_aggregated_order'",51],")",";",["T_WHITESPACE","\n        ",51],["T_VARIABLE","$sourceTable",52],["T_WHITESPACE"," ",52],"=",["T_WHITESPACE"," ",52],["T_VARIABLE","$this",52],["T_OBJECT_OPERATOR","->",52],["T_STRING","getTable",52],"(",["T_CONSTANT_ENCAPSED_STRING","'sales_order'",52],")",";",["T_WHITESPACE","\n        ",52],["T_VARIABLE","$connection",53],["T_WHITESPACE"," ",53],"=",["T_WHITESPACE"," ",53],["T_VARIABLE","$this",53],["T_OBJECT_OPERATOR","->",53],["T_STRING","getConnection",53],"(",")",";",["T_WHITESPACE","\n        ",53],["T_VARIABLE","$connection",54],["T_OBJECT_OPERATOR","->",54],["T_STRING","beginTransaction",54],"(",")",";",["T_WHITESPACE","\n\n        ",54],["T_TRY","try",56],["T_WHITESPACE"," ",56],"{",["T_WHITESPACE","\n            ",56],["T_IF","if",57],["T_WHITESPACE"," ",57],"(",["T_VARIABLE","$from",57],["T_WHITESPACE"," ",57],["T_IS_NOT_IDENTICAL","!==",57],["T_WHITESPACE"," ",57],["T_STRING","null",57],["T_WHITESPACE"," ",57],["T_BOOLEAN_OR","||",57],["T_WHITESPACE"," ",57],["T_VARIABLE","$to",57],["T_WHITESPACE"," ",57],["T_IS_NOT_IDENTICAL","!==",57],["T_WHITESPACE"," ",57],["T_STRING","null",57],")",["T_WHITESPACE"," ",57],"{",["T_WHITESPACE","\n                ",57],["T_VARIABLE","$subSelect",58],["T_WHITESPACE"," ",58],"=",["T_WHITESPACE"," ",58],["T_VARIABLE","$this",58],["T_OBJECT_OPERATOR","->",58],["T_STRING","_getTableDateRangeSelect",58],"(",["T_VARIABLE","$sourceTable",58],",",["T_WHITESPACE"," ",58],["T_CONSTANT_ENCAPSED_STRING","'created_at'",58],",",["T_WHITESPACE"," ",58],["T_CONSTANT_ENCAPSED_STRING","'updated_at'",58],",",["T_WHITESPACE"," ",58],["T_VARIABLE","$from",58],",",["T_WHITESPACE"," ",58],["T_VARIABLE","$to",58],")",";",["T_WHITESPACE","\n            ",58],"}",["T_WHITESPACE"," ",59],["T_ELSE","else",59],["T_WHITESPACE"," ",59],"{",["T_WHITESPACE","\n                ",59],["T_VARIABLE","$subSelect",60],["T_WHITESPACE"," ",60],"=",["T_WHITESPACE"," ",60],["T_STRING","null",60],";",["T_WHITESPACE","\n            ",60],"}",["T_WHITESPACE","\n\n            ",61],["T_VARIABLE","$this",63],["T_OBJECT_OPERATOR","->",63],["T_STRING","_clearTableByDateRange",63],"(",["T_VARIABLE","$table",63],",",["T_WHITESPACE"," ",63],["T_VARIABLE","$from",63],",",["T_WHITESPACE"," ",63],["T_VARIABLE","$to",63],",",["T_WHITESPACE"," ",63],["T_VARIABLE","$subSelect",63],")",";",["T_WHITESPACE","\n            ",63],["T_COMMENT","\/\/ convert dates to current admin timezone\n",64],["T_WHITESPACE","            ",65],["T_VARIABLE","$periodExpr",65],["T_WHITESPACE"," ",65],"=",["T_WHITESPACE"," ",65],["T_VARIABLE","$connection",65],["T_OBJECT_OPERATOR","->",65],["T_STRING","getDatePartSql",65],"(",["T_WHITESPACE","\n                ",65],["T_VARIABLE","$this",66],["T_OBJECT_OPERATOR","->",66],["T_STRING","getStoreTZOffsetQuery",66],"(",["T_VARIABLE","$sourceTable",66],",",["T_WHITESPACE"," ",66],["T_CONSTANT_ENCAPSED_STRING","'created_at'",66],",",["T_WHITESPACE"," ",66],["T_VARIABLE","$from",66],",",["T_WHITESPACE"," ",66],["T_VARIABLE","$to",66],")",["T_WHITESPACE","\n            ",66],")",";",["T_WHITESPACE","\n            ",67],["T_VARIABLE","$columns",68],["T_WHITESPACE"," ",68],"=",["T_WHITESPACE"," ",68],"[",["T_WHITESPACE","\n                ",68],["T_CONSTANT_ENCAPSED_STRING","'period'",69],["T_WHITESPACE"," ",69],["T_DOUBLE_ARROW","=>",69],["T_WHITESPACE"," ",69],["T_VARIABLE","$periodExpr",69],",",["T_WHITESPACE","\n                ",69],["T_CONSTANT_ENCAPSED_STRING","'store_id'",70],["T_WHITESPACE"," ",70],["T_DOUBLE_ARROW","=>",70],["T_WHITESPACE"," ",70],["T_CONSTANT_ENCAPSED_STRING","'store_id'",70],",",["T_WHITESPACE","\n                ",70],["T_CONSTANT_ENCAPSED_STRING","'order_status'",71],["T_WHITESPACE"," ",71],["T_DOUBLE_ARROW","=>",71],["T_WHITESPACE"," ",71],["T_CONSTANT_ENCAPSED_STRING","'status'",71],",",["T_WHITESPACE","\n                ",71],["T_CONSTANT_ENCAPSED_STRING","'orders_count'",72],["T_WHITESPACE"," ",72],["T_DOUBLE_ARROW","=>",72],["T_WHITESPACE"," ",72],["T_NEW","new",72],["T_WHITESPACE"," ",72],["T_NS_SEPARATOR","\\",72],["T_STRING","Zend_Db_Expr",72],"(",["T_CONSTANT_ENCAPSED_STRING","'COUNT(total_refunded)'",72],")",",",["T_WHITESPACE","\n                ",72],["T_CONSTANT_ENCAPSED_STRING","'refunded'",73],["T_WHITESPACE"," ",73],["T_DOUBLE_ARROW","=>",73],["T_WHITESPACE"," ",73],["T_NEW","new",73],["T_WHITESPACE"," ",73],["T_NS_SEPARATOR","\\",73],["T_STRING","Zend_Db_Expr",73],"(",["T_CONSTANT_ENCAPSED_STRING","'SUM(base_total_refunded * base_to_global_rate)'",73],")",",",["T_WHITESPACE","\n                ",73],["T_CONSTANT_ENCAPSED_STRING","'online_refunded'",74],["T_WHITESPACE"," ",74],["T_DOUBLE_ARROW","=>",74],["T_WHITESPACE"," ",74],["T_NEW","new",74],["T_WHITESPACE"," ",74],["T_NS_SEPARATOR","\\",74],["T_STRING","Zend_Db_Expr",74],"(",["T_CONSTANT_ENCAPSED_STRING","'SUM(base_total_online_refunded * base_to_global_rate)'",74],")",",",["T_WHITESPACE","\n                ",74],["T_CONSTANT_ENCAPSED_STRING","'offline_refunded'",75],["T_WHITESPACE"," ",75],["T_DOUBLE_ARROW","=>",75],["T_WHITESPACE"," ",75],["T_NEW","new",75],["T_WHITESPACE"," ",75],["T_NS_SEPARATOR","\\",75],["T_STRING","Zend_Db_Expr",75],"(",["T_CONSTANT_ENCAPSED_STRING","'SUM(base_total_offline_refunded * base_to_global_rate)'",75],")",",",["T_WHITESPACE","\n            ",75],"]",";",["T_WHITESPACE","\n\n            ",76],["T_VARIABLE","$select",78],["T_WHITESPACE"," ",78],"=",["T_WHITESPACE"," ",78],["T_VARIABLE","$connection",78],["T_OBJECT_OPERATOR","->",78],["T_STRING","select",78],"(",")",";",["T_WHITESPACE","\n            ",78],["T_VARIABLE","$select",79],["T_OBJECT_OPERATOR","->",79],["T_STRING","from",79],"(",["T_WHITESPACE","\n                ",79],["T_VARIABLE","$sourceTable",80],",",["T_WHITESPACE","\n                ",80],["T_VARIABLE","$columns",81],["T_WHITESPACE","\n            ",81],")",["T_OBJECT_OPERATOR","->",82],["T_STRING","where",82],"(",["T_WHITESPACE","\n                ",82],["T_CONSTANT_ENCAPSED_STRING","'state != ?'",83],",",["T_WHITESPACE","\n                ",83],["T_NS_SEPARATOR","\\",84],["T_STRING","Magento",84],["T_NS_SEPARATOR","\\",84],["T_STRING","Sales",84],["T_NS_SEPARATOR","\\",84],["T_STRING","Model",84],["T_NS_SEPARATOR","\\",84],["T_STRING","Order",84],["T_DOUBLE_COLON","::",84],["T_STRING","STATE_CANCELED",84],["T_WHITESPACE","\n            ",84],")",["T_OBJECT_OPERATOR","->",85],["T_STRING","where",85],"(",["T_WHITESPACE","\n                ",85],["T_CONSTANT_ENCAPSED_STRING","'base_total_refunded > ?'",86],",",["T_WHITESPACE","\n                ",86],["T_LNUMBER","0",87],["T_WHITESPACE","\n            ",87],")",";",["T_WHITESPACE","\n\n            ",88],["T_IF","if",90],["T_WHITESPACE"," ",90],"(",["T_VARIABLE","$subSelect",90],["T_WHITESPACE"," ",90],["T_IS_NOT_IDENTICAL","!==",90],["T_WHITESPACE"," ",90],["T_STRING","null",90],")",["T_WHITESPACE"," ",90],"{",["T_WHITESPACE","\n                ",90],["T_VARIABLE","$select",91],["T_OBJECT_OPERATOR","->",91],["T_STRING","having",91],"(",["T_VARIABLE","$this",91],["T_OBJECT_OPERATOR","->",91],["T_STRING","_makeConditionFromDateRangeSelect",91],"(",["T_VARIABLE","$subSelect",91],",",["T_WHITESPACE"," ",91],["T_CONSTANT_ENCAPSED_STRING","'period'",91],")",")",";",["T_WHITESPACE","\n            ",91],"}",["T_WHITESPACE","\n\n            ",92],["T_VARIABLE","$select",94],["T_OBJECT_OPERATOR","->",94],["T_STRING","group",94],"(","[",["T_VARIABLE","$periodExpr",94],",",["T_WHITESPACE"," ",94],["T_CONSTANT_ENCAPSED_STRING","'store_id'",94],",",["T_WHITESPACE"," ",94],["T_CONSTANT_ENCAPSED_STRING","'status'",94],"]",")",";",["T_WHITESPACE","\n            ",94],["T_VARIABLE","$select",95],["T_OBJECT_OPERATOR","->",95],["T_STRING","having",95],"(",["T_CONSTANT_ENCAPSED_STRING","'orders_count > 0'",95],")",";",["T_WHITESPACE","\n            ",95],["T_VARIABLE","$insertQuery",96],["T_WHITESPACE"," ",96],"=",["T_WHITESPACE"," ",96],["T_VARIABLE","$select",96],["T_OBJECT_OPERATOR","->",96],["T_STRING","insertFromSelect",96],"(",["T_VARIABLE","$table",96],",",["T_WHITESPACE"," ",96],["T_STRING","array_keys",96],"(",["T_VARIABLE","$columns",96],")",")",";",["T_WHITESPACE","\n            ",96],["T_VARIABLE","$connection",97],["T_OBJECT_OPERATOR","->",97],["T_STRING","query",97],"(",["T_VARIABLE","$insertQuery",97],")",";",["T_WHITESPACE","\n            ",97],["T_VARIABLE","$select",98],["T_OBJECT_OPERATOR","->",98],["T_STRING","reset",98],"(",")",";",["T_WHITESPACE","\n\n            ",98],["T_VARIABLE","$columns",100],["T_WHITESPACE"," ",100],"=",["T_WHITESPACE"," ",100],"[",["T_WHITESPACE","\n                ",100],["T_CONSTANT_ENCAPSED_STRING","'period'",101],["T_WHITESPACE"," ",101],["T_DOUBLE_ARROW","=>",101],["T_WHITESPACE"," ",101],["T_CONSTANT_ENCAPSED_STRING","'period'",101],",",["T_WHITESPACE","\n                ",101],["T_CONSTANT_ENCAPSED_STRING","'store_id'",102],["T_WHITESPACE"," ",102],["T_DOUBLE_ARROW","=>",102],["T_WHITESPACE"," ",102],["T_NEW","new",102],["T_WHITESPACE"," ",102],["T_NS_SEPARATOR","\\",102],["T_STRING","Zend_Db_Expr",102],"(",["T_CONSTANT_ENCAPSED_STRING","'0'",102],")",",",["T_WHITESPACE","\n                ",102],["T_CONSTANT_ENCAPSED_STRING","'order_status'",103],["T_WHITESPACE"," ",103],["T_DOUBLE_ARROW","=>",103],["T_WHITESPACE"," ",103],["T_CONSTANT_ENCAPSED_STRING","'order_status'",103],",",["T_WHITESPACE","\n                ",103],["T_CONSTANT_ENCAPSED_STRING","'orders_count'",104],["T_WHITESPACE"," ",104],["T_DOUBLE_ARROW","=>",104],["T_WHITESPACE"," ",104],["T_NEW","new",104],["T_WHITESPACE"," ",104],["T_NS_SEPARATOR","\\",104],["T_STRING","Zend_Db_Expr",104],"(",["T_CONSTANT_ENCAPSED_STRING","'SUM(orders_count)'",104],")",",",["T_WHITESPACE","\n                ",104],["T_CONSTANT_ENCAPSED_STRING","'refunded'",105],["T_WHITESPACE"," ",105],["T_DOUBLE_ARROW","=>",105],["T_WHITESPACE"," ",105],["T_NEW","new",105],["T_WHITESPACE"," ",105],["T_NS_SEPARATOR","\\",105],["T_STRING","Zend_Db_Expr",105],"(",["T_CONSTANT_ENCAPSED_STRING","'SUM(refunded)'",105],")",",",["T_WHITESPACE","\n                ",105],["T_CONSTANT_ENCAPSED_STRING","'online_refunded'",106],["T_WHITESPACE"," ",106],["T_DOUBLE_ARROW","=>",106],["T_WHITESPACE"," ",106],["T_NEW","new",106],["T_WHITESPACE"," ",106],["T_NS_SEPARATOR","\\",106],["T_STRING","Zend_Db_Expr",106],"(",["T_CONSTANT_ENCAPSED_STRING","'SUM(online_refunded)'",106],")",",",["T_WHITESPACE","\n                ",106],["T_CONSTANT_ENCAPSED_STRING","'offline_refunded'",107],["T_WHITESPACE"," ",107],["T_DOUBLE_ARROW","=>",107],["T_WHITESPACE"," ",107],["T_NEW","new",107],["T_WHITESPACE"," ",107],["T_NS_SEPARATOR","\\",107],["T_STRING","Zend_Db_Expr",107],"(",["T_CONSTANT_ENCAPSED_STRING","'SUM(offline_refunded)'",107],")",",",["T_WHITESPACE","\n            ",107],"]",";",["T_WHITESPACE","\n\n            ",108],["T_VARIABLE","$select",110],["T_OBJECT_OPERATOR","->",110],["T_STRING","from",110],"(",["T_VARIABLE","$table",110],",",["T_WHITESPACE"," ",110],["T_VARIABLE","$columns",110],")",["T_OBJECT_OPERATOR","->",110],["T_STRING","where",110],"(",["T_CONSTANT_ENCAPSED_STRING","'store_id != ?'",110],",",["T_WHITESPACE"," ",110],["T_LNUMBER","0",110],")",";",["T_WHITESPACE","\n\n            ",110],["T_IF","if",112],["T_WHITESPACE"," ",112],"(",["T_VARIABLE","$subSelect",112],["T_WHITESPACE"," ",112],["T_IS_NOT_IDENTICAL","!==",112],["T_WHITESPACE"," ",112],["T_STRING","null",112],")",["T_WHITESPACE"," ",112],"{",["T_WHITESPACE","\n                ",112],["T_VARIABLE","$select",113],["T_OBJECT_OPERATOR","->",113],["T_STRING","where",113],"(",["T_VARIABLE","$this",113],["T_OBJECT_OPERATOR","->",113],["T_STRING","_makeConditionFromDateRangeSelect",113],"(",["T_VARIABLE","$subSelect",113],",",["T_WHITESPACE"," ",113],["T_CONSTANT_ENCAPSED_STRING","'period'",113],")",")",";",["T_WHITESPACE","\n            ",113],"}",["T_WHITESPACE","\n\n            ",114],["T_VARIABLE","$select",116],["T_OBJECT_OPERATOR","->",116],["T_STRING","group",116],"(","[",["T_CONSTANT_ENCAPSED_STRING","'period'",116],",",["T_WHITESPACE"," ",116],["T_CONSTANT_ENCAPSED_STRING","'order_status'",116],"]",")",";",["T_WHITESPACE","\n            ",116],["T_VARIABLE","$insertQuery",117],["T_WHITESPACE"," ",117],"=",["T_WHITESPACE"," ",117],["T_VARIABLE","$select",117],["T_OBJECT_OPERATOR","->",117],["T_STRING","insertFromSelect",117],"(",["T_VARIABLE","$table",117],",",["T_WHITESPACE"," ",117],["T_STRING","array_keys",117],"(",["T_VARIABLE","$columns",117],")",")",";",["T_WHITESPACE","\n            ",117],["T_VARIABLE","$connection",118],["T_OBJECT_OPERATOR","->",118],["T_STRING","query",118],"(",["T_VARIABLE","$insertQuery",118],")",";",["T_WHITESPACE","\n            ",118],["T_VARIABLE","$connection",119],["T_OBJECT_OPERATOR","->",119],["T_STRING","commit",119],"(",")",";",["T_WHITESPACE","\n        ",119],"}",["T_WHITESPACE"," ",120],["T_CATCH","catch",120],["T_WHITESPACE"," ",120],"(",["T_NS_SEPARATOR","\\",120],["T_STRING","Exception",120],["T_WHITESPACE"," ",120],["T_VARIABLE","$e",120],")",["T_WHITESPACE"," ",120],"{",["T_WHITESPACE","\n            ",120],["T_VARIABLE","$connection",121],["T_OBJECT_OPERATOR","->",121],["T_STRING","rollBack",121],"(",")",";",["T_WHITESPACE","\n            ",121],["T_THROW","throw",122],["T_WHITESPACE"," ",122],["T_VARIABLE","$e",122],";",["T_WHITESPACE","\n        ",122],"}",["T_WHITESPACE","\n\n        ",123],["T_RETURN","return",125],["T_WHITESPACE"," ",125],["T_VARIABLE","$this",125],";",["T_WHITESPACE","\n    ",125],"}",["T_WHITESPACE","\n\n    ",126],["T_DOC_COMMENT","\/**\n     * Aggregate refunded data by creditmemo created at as period\n     *\n     * @param string|null $from\n     * @param string|null $to\n     * @return $this\n     * @throws \\Exception\n     * @SuppressWarnings(PHPMD.ExcessiveMethodLength)\n     *\/",128],["T_WHITESPACE","\n    ",136],["T_PROTECTED","protected",137],["T_WHITESPACE"," ",137],["T_FUNCTION","function",137],["T_WHITESPACE"," ",137],["T_STRING","_aggregateByRefundCreatedAt",137],"(",["T_VARIABLE","$from",137],",",["T_WHITESPACE"," ",137],["T_VARIABLE","$to",137],")",["T_WHITESPACE","\n    ",137],"{",["T_WHITESPACE","\n        ",138],["T_VARIABLE","$table",139],["T_WHITESPACE"," ",139],"=",["T_WHITESPACE"," ",139],["T_VARIABLE","$this",139],["T_OBJECT_OPERATOR","->",139],["T_STRING","getTable",139],"(",["T_CONSTANT_ENCAPSED_STRING","'sales_refunded_aggregated'",139],")",";",["T_WHITESPACE","\n        ",139],["T_VARIABLE","$sourceTable",140],["T_WHITESPACE"," ",140],"=",["T_WHITESPACE"," ",140],["T_VARIABLE","$this",140],["T_OBJECT_OPERATOR","->",140],["T_STRING","getTable",140],"(",["T_CONSTANT_ENCAPSED_STRING","'sales_creditmemo'",140],")",";",["T_WHITESPACE","\n        ",140],["T_VARIABLE","$orderTable",141],["T_WHITESPACE"," ",141],"=",["T_WHITESPACE"," ",141],["T_VARIABLE","$this",141],["T_OBJECT_OPERATOR","->",141],["T_STRING","getTable",141],"(",["T_CONSTANT_ENCAPSED_STRING","'sales_order'",141],")",";",["T_WHITESPACE","\n        ",141],["T_VARIABLE","$connection",142],["T_WHITESPACE"," ",142],"=",["T_WHITESPACE"," ",142],["T_VARIABLE","$this",142],["T_OBJECT_OPERATOR","->",142],["T_STRING","getConnection",142],"(",")",";",["T_WHITESPACE","\n        ",142],["T_VARIABLE","$connection",143],["T_OBJECT_OPERATOR","->",143],["T_STRING","beginTransaction",143],"(",")",";",["T_WHITESPACE","\n\n        ",143],["T_TRY","try",145],["T_WHITESPACE"," ",145],"{",["T_WHITESPACE","\n            ",145],["T_IF","if",146],["T_WHITESPACE"," ",146],"(",["T_VARIABLE","$from",146],["T_WHITESPACE"," ",146],["T_IS_NOT_IDENTICAL","!==",146],["T_WHITESPACE"," ",146],["T_STRING","null",146],["T_WHITESPACE"," ",146],["T_BOOLEAN_OR","||",146],["T_WHITESPACE"," ",146],["T_VARIABLE","$to",146],["T_WHITESPACE"," ",146],["T_IS_NOT_IDENTICAL","!==",146],["T_WHITESPACE"," ",146],["T_STRING","null",146],")",["T_WHITESPACE"," ",146],"{",["T_WHITESPACE","\n                ",146],["T_VARIABLE","$subSelect",147],["T_WHITESPACE"," ",147],"=",["T_WHITESPACE"," ",147],["T_VARIABLE","$this",147],["T_OBJECT_OPERATOR","->",147],["T_STRING","_getTableDateRangeRelatedSelect",147],"(",["T_WHITESPACE","\n                    ",147],["T_VARIABLE","$sourceTable",148],",",["T_WHITESPACE","\n                    ",148],["T_VARIABLE","$orderTable",149],",",["T_WHITESPACE","\n                    ",149],"[",["T_CONSTANT_ENCAPSED_STRING","'order_id'",150],["T_WHITESPACE"," ",150],["T_DOUBLE_ARROW","=>",150],["T_WHITESPACE"," ",150],["T_CONSTANT_ENCAPSED_STRING","'entity_id'",150],"]",",",["T_WHITESPACE","\n                    ",150],["T_CONSTANT_ENCAPSED_STRING","'created_at'",151],",",["T_WHITESPACE","\n                    ",151],["T_CONSTANT_ENCAPSED_STRING","'updated_at'",152],",",["T_WHITESPACE","\n                    ",152],["T_VARIABLE","$from",153],",",["T_WHITESPACE","\n                    ",153],["T_VARIABLE","$to",154],["T_WHITESPACE","\n                ",154],")",";",["T_WHITESPACE","\n            ",155],"}",["T_WHITESPACE"," ",156],["T_ELSE","else",156],["T_WHITESPACE"," ",156],"{",["T_WHITESPACE","\n                ",156],["T_VARIABLE","$subSelect",157],["T_WHITESPACE"," ",157],"=",["T_WHITESPACE"," ",157],["T_STRING","null",157],";",["T_WHITESPACE","\n            ",157],"}",["T_WHITESPACE","\n\n            ",158],["T_VARIABLE","$this",160],["T_OBJECT_OPERATOR","->",160],["T_STRING","_clearTableByDateRange",160],"(",["T_VARIABLE","$table",160],",",["T_WHITESPACE"," ",160],["T_VARIABLE","$from",160],",",["T_WHITESPACE"," ",160],["T_VARIABLE","$to",160],",",["T_WHITESPACE"," ",160],["T_VARIABLE","$subSelect",160],")",";",["T_WHITESPACE","\n            ",160],["T_COMMENT","\/\/ convert dates to current admin timezone\n",161],["T_WHITESPACE","            ",162],["T_VARIABLE","$periodExpr",162],["T_WHITESPACE"," ",162],"=",["T_WHITESPACE"," ",162],["T_VARIABLE","$connection",162],["T_OBJECT_OPERATOR","->",162],["T_STRING","getDatePartSql",162],"(",["T_WHITESPACE","\n                ",162],["T_VARIABLE","$this",163],["T_OBJECT_OPERATOR","->",163],["T_STRING","getStoreTZOffsetQuery",163],"(",["T_WHITESPACE","\n                    ",163],"[",["T_CONSTANT_ENCAPSED_STRING","'source_table'",164],["T_WHITESPACE"," ",164],["T_DOUBLE_ARROW","=>",164],["T_WHITESPACE"," ",164],["T_VARIABLE","$sourceTable",164],"]",",",["T_WHITESPACE","\n                    ",164],["T_CONSTANT_ENCAPSED_STRING","'source_table.created_at'",165],",",["T_WHITESPACE","\n                    ",165],["T_VARIABLE","$from",166],",",["T_WHITESPACE","\n                    ",166],["T_VARIABLE","$to",167],["T_WHITESPACE","\n                ",167],")",["T_WHITESPACE","\n            ",168],")",";",["T_WHITESPACE","\n\n            ",169],["T_VARIABLE","$columns",171],["T_WHITESPACE"," ",171],"=",["T_WHITESPACE"," ",171],"[",["T_WHITESPACE","\n                ",171],["T_CONSTANT_ENCAPSED_STRING","'period'",172],["T_WHITESPACE"," ",172],["T_DOUBLE_ARROW","=>",172],["T_WHITESPACE"," ",172],["T_VARIABLE","$periodExpr",172],",",["T_WHITESPACE","\n                ",172],["T_CONSTANT_ENCAPSED_STRING","'store_id'",173],["T_WHITESPACE"," ",173],["T_DOUBLE_ARROW","=>",173],["T_WHITESPACE"," ",173],["T_CONSTANT_ENCAPSED_STRING","'order_table.store_id'",173],",",["T_WHITESPACE","\n                ",173],["T_CONSTANT_ENCAPSED_STRING","'order_status'",174],["T_WHITESPACE"," ",174],["T_DOUBLE_ARROW","=>",174],["T_WHITESPACE"," ",174],["T_CONSTANT_ENCAPSED_STRING","'order_table.status'",174],",",["T_WHITESPACE","\n                ",174],["T_CONSTANT_ENCAPSED_STRING","'orders_count'",175],["T_WHITESPACE"," ",175],["T_DOUBLE_ARROW","=>",175],["T_WHITESPACE"," ",175],["T_NEW","new",175],["T_WHITESPACE"," ",175],["T_NS_SEPARATOR","\\",175],["T_STRING","Zend_Db_Expr",175],"(",["T_CONSTANT_ENCAPSED_STRING","'COUNT(order_table.entity_id)'",175],")",",",["T_WHITESPACE","\n                ",175],["T_CONSTANT_ENCAPSED_STRING","'refunded'",176],["T_WHITESPACE"," ",176],["T_DOUBLE_ARROW","=>",176],["T_WHITESPACE"," ",176],["T_NEW","new",176],["T_WHITESPACE"," ",176],["T_NS_SEPARATOR","\\",176],["T_STRING","Zend_Db_Expr",176],"(",["T_WHITESPACE","\n                    ",176],["T_CONSTANT_ENCAPSED_STRING","'SUM(order_table.base_total_refunded * order_table.base_to_global_rate)'",177],["T_WHITESPACE","\n                ",177],")",",",["T_WHITESPACE","\n                ",178],["T_CONSTANT_ENCAPSED_STRING","'online_refunded'",179],["T_WHITESPACE"," ",179],["T_DOUBLE_ARROW","=>",179],["T_WHITESPACE"," ",179],["T_NEW","new",179],["T_WHITESPACE"," ",179],["T_NS_SEPARATOR","\\",179],["T_STRING","Zend_Db_Expr",179],"(",["T_WHITESPACE","\n                    ",179],["T_CONSTANT_ENCAPSED_STRING","'SUM(order_table.base_total_online_refunded * order_table.base_to_global_rate)'",180],["T_WHITESPACE","\n                ",180],")",",",["T_WHITESPACE","\n                ",181],["T_CONSTANT_ENCAPSED_STRING","'offline_refunded'",182],["T_WHITESPACE"," ",182],["T_DOUBLE_ARROW","=>",182],["T_WHITESPACE"," ",182],["T_NEW","new",182],["T_WHITESPACE"," ",182],["T_NS_SEPARATOR","\\",182],["T_STRING","Zend_Db_Expr",182],"(",["T_WHITESPACE","\n                    ",182],["T_CONSTANT_ENCAPSED_STRING","'SUM(order_table.base_total_offline_refunded * order_table.base_to_global_rate)'",183],["T_WHITESPACE","\n                ",183],")",",",["T_WHITESPACE","\n            ",184],"]",";",["T_WHITESPACE","\n\n            ",185],["T_VARIABLE","$select",187],["T_WHITESPACE"," ",187],"=",["T_WHITESPACE"," ",187],["T_VARIABLE","$connection",187],["T_OBJECT_OPERATOR","->",187],["T_STRING","select",187],"(",")",";",["T_WHITESPACE","\n            ",187],["T_VARIABLE","$select",188],["T_OBJECT_OPERATOR","->",188],["T_STRING","from",188],"(",["T_WHITESPACE","\n                ",188],"[",["T_CONSTANT_ENCAPSED_STRING","'source_table'",189],["T_WHITESPACE"," ",189],["T_DOUBLE_ARROW","=>",189],["T_WHITESPACE"," ",189],["T_VARIABLE","$sourceTable",189],"]",",",["T_WHITESPACE","\n                ",189],["T_VARIABLE","$columns",190],["T_WHITESPACE","\n            ",190],")",["T_OBJECT_OPERATOR","->",191],["T_STRING","joinInner",191],"(",["T_WHITESPACE","\n                ",191],"[",["T_CONSTANT_ENCAPSED_STRING","'order_table'",192],["T_WHITESPACE"," ",192],["T_DOUBLE_ARROW","=>",192],["T_WHITESPACE"," ",192],["T_VARIABLE","$orderTable",192],"]",",",["T_WHITESPACE","\n                ",192],["T_CONSTANT_ENCAPSED_STRING","'source_table.order_id = order_table.entity_id AND '",193],["T_WHITESPACE"," ",193],".",["T_WHITESPACE"," ",193],["T_VARIABLE","$connection",193],["T_OBJECT_OPERATOR","->",193],["T_STRING","quoteInto",193],"(",["T_WHITESPACE","\n                    ",193],["T_CONSTANT_ENCAPSED_STRING","'order_table.state != ?'",194],",",["T_WHITESPACE","\n                    ",194],["T_NS_SEPARATOR","\\",195],["T_STRING","Magento",195],["T_NS_SEPARATOR","\\",195],["T_STRING","Sales",195],["T_NS_SEPARATOR","\\",195],["T_STRING","Model",195],["T_NS_SEPARATOR","\\",195],["T_STRING","Order",195],["T_DOUBLE_COLON","::",195],["T_STRING","STATE_CANCELED",195],["T_WHITESPACE","\n                ",195],")",["T_WHITESPACE"," ",196],".",["T_WHITESPACE"," ",196],["T_CONSTANT_ENCAPSED_STRING","' AND order_table.base_total_refunded > 0'",196],",",["T_WHITESPACE","\n                ",196],"[","]",["T_WHITESPACE","\n            ",197],")",";",["T_WHITESPACE","\n\n            ",198],["T_VARIABLE","$filterSubSelect",200],["T_WHITESPACE"," ",200],"=",["T_WHITESPACE"," ",200],["T_VARIABLE","$connection",200],["T_OBJECT_OPERATOR","->",200],["T_STRING","select",200],"(",")",";",["T_WHITESPACE","\n            ",200],["T_VARIABLE","$filterSubSelect",201],["T_OBJECT_OPERATOR","->",201],["T_STRING","from",201],"(",["T_WHITESPACE","\n                ",201],"[",["T_CONSTANT_ENCAPSED_STRING","'filter_source_table'",202],["T_WHITESPACE"," ",202],["T_DOUBLE_ARROW","=>",202],["T_WHITESPACE"," ",202],["T_VARIABLE","$sourceTable",202],"]",",",["T_WHITESPACE","\n                ",202],["T_NEW","new",203],["T_WHITESPACE"," ",203],["T_NS_SEPARATOR","\\",203],["T_STRING","Zend_Db_Expr",203],"(",["T_CONSTANT_ENCAPSED_STRING","'MAX(filter_source_table.entity_id)'",203],")",["T_WHITESPACE","\n            ",203],")",["T_OBJECT_OPERATOR","->",204],["T_STRING","where",204],"(",["T_WHITESPACE","\n                ",204],["T_CONSTANT_ENCAPSED_STRING","'filter_source_table.order_id = source_table.order_id'",205],["T_WHITESPACE","\n            ",205],")",";",["T_WHITESPACE","\n\n            ",206],["T_IF","if",208],["T_WHITESPACE"," ",208],"(",["T_VARIABLE","$subSelect",208],["T_WHITESPACE"," ",208],["T_IS_NOT_IDENTICAL","!==",208],["T_WHITESPACE"," ",208],["T_STRING","null",208],")",["T_WHITESPACE"," ",208],"{",["T_WHITESPACE","\n                ",208],["T_VARIABLE","$select",209],["T_OBJECT_OPERATOR","->",209],["T_STRING","having",209],"(",["T_VARIABLE","$this",209],["T_OBJECT_OPERATOR","->",209],["T_STRING","_makeConditionFromDateRangeSelect",209],"(",["T_VARIABLE","$subSelect",209],",",["T_WHITESPACE"," ",209],["T_CONSTANT_ENCAPSED_STRING","'period'",209],")",")",";",["T_WHITESPACE","\n            ",209],"}",["T_WHITESPACE","\n\n            ",210],["T_VARIABLE","$select",212],["T_OBJECT_OPERATOR","->",212],["T_STRING","where",212],"(",["T_CONSTANT_ENCAPSED_STRING","'source_table.entity_id = (?)'",212],",",["T_WHITESPACE"," ",212],["T_NEW","new",212],["T_WHITESPACE"," ",212],["T_NS_SEPARATOR","\\",212],["T_STRING","Zend_Db_Expr",212],"(",["T_VARIABLE","$filterSubSelect",212],")",")",";",["T_WHITESPACE","\n            ",212],["T_UNSET","unset",213],"(",["T_VARIABLE","$filterSubSelect",213],")",";",["T_WHITESPACE","\n\n            ",213],["T_VARIABLE","$select",215],["T_OBJECT_OPERATOR","->",215],["T_STRING","group",215],"(","[",["T_VARIABLE","$periodExpr",215],",",["T_WHITESPACE"," ",215],["T_CONSTANT_ENCAPSED_STRING","'order_table.store_id'",215],",",["T_WHITESPACE"," ",215],["T_CONSTANT_ENCAPSED_STRING","'order_table.status'",215],"]",")",";",["T_WHITESPACE","\n            ",215],["T_VARIABLE","$select",216],["T_OBJECT_OPERATOR","->",216],["T_STRING","having",216],"(",["T_CONSTANT_ENCAPSED_STRING","'orders_count > 0'",216],")",";",["T_WHITESPACE","\n\n            ",216],["T_VARIABLE","$insertQuery",218],["T_WHITESPACE"," ",218],"=",["T_WHITESPACE"," ",218],["T_VARIABLE","$select",218],["T_OBJECT_OPERATOR","->",218],["T_STRING","insertFromSelect",218],"(",["T_VARIABLE","$table",218],",",["T_WHITESPACE"," ",218],["T_STRING","array_keys",218],"(",["T_VARIABLE","$columns",218],")",")",";",["T_WHITESPACE","\n            ",218],["T_VARIABLE","$connection",219],["T_OBJECT_OPERATOR","->",219],["T_STRING","query",219],"(",["T_VARIABLE","$insertQuery",219],")",";",["T_WHITESPACE","\n            ",219],["T_VARIABLE","$select",220],["T_OBJECT_OPERATOR","->",220],["T_STRING","reset",220],"(",")",";",["T_WHITESPACE","\n\n            ",220],["T_VARIABLE","$columns",222],["T_WHITESPACE"," ",222],"=",["T_WHITESPACE"," ",222],"[",["T_WHITESPACE","\n                ",222],["T_CONSTANT_ENCAPSED_STRING","'period'",223],["T_WHITESPACE"," ",223],["T_DOUBLE_ARROW","=>",223],["T_WHITESPACE"," ",223],["T_CONSTANT_ENCAPSED_STRING","'period'",223],",",["T_WHITESPACE","\n                ",223],["T_CONSTANT_ENCAPSED_STRING","'store_id'",224],["T_WHITESPACE"," ",224],["T_DOUBLE_ARROW","=>",224],["T_WHITESPACE"," ",224],["T_NEW","new",224],["T_WHITESPACE"," ",224],["T_NS_SEPARATOR","\\",224],["T_STRING","Zend_Db_Expr",224],"(",["T_CONSTANT_ENCAPSED_STRING","'0'",224],")",",",["T_WHITESPACE","\n                ",224],["T_CONSTANT_ENCAPSED_STRING","'order_status'",225],["T_WHITESPACE"," ",225],["T_DOUBLE_ARROW","=>",225],["T_WHITESPACE"," ",225],["T_CONSTANT_ENCAPSED_STRING","'order_status'",225],",",["T_WHITESPACE","\n                ",225],["T_CONSTANT_ENCAPSED_STRING","'orders_count'",226],["T_WHITESPACE"," ",226],["T_DOUBLE_ARROW","=>",226],["T_WHITESPACE"," ",226],["T_NEW","new",226],["T_WHITESPACE"," ",226],["T_NS_SEPARATOR","\\",226],["T_STRING","Zend_Db_Expr",226],"(",["T_CONSTANT_ENCAPSED_STRING","'SUM(orders_count)'",226],")",",",["T_WHITESPACE","\n                ",226],["T_CONSTANT_ENCAPSED_STRING","'refunded'",227],["T_WHITESPACE"," ",227],["T_DOUBLE_ARROW","=>",227],["T_WHITESPACE"," ",227],["T_NEW","new",227],["T_WHITESPACE"," ",227],["T_NS_SEPARATOR","\\",227],["T_STRING","Zend_Db_Expr",227],"(",["T_CONSTANT_ENCAPSED_STRING","'SUM(refunded)'",227],")",",",["T_WHITESPACE","\n                ",227],["T_CONSTANT_ENCAPSED_STRING","'online_refunded'",228],["T_WHITESPACE"," ",228],["T_DOUBLE_ARROW","=>",228],["T_WHITESPACE"," ",228],["T_NEW","new",228],["T_WHITESPACE"," ",228],["T_NS_SEPARATOR","\\",228],["T_STRING","Zend_Db_Expr",228],"(",["T_CONSTANT_ENCAPSED_STRING","'SUM(online_refunded)'",228],")",",",["T_WHITESPACE","\n                ",228],["T_CONSTANT_ENCAPSED_STRING","'offline_refunded'",229],["T_WHITESPACE"," ",229],["T_DOUBLE_ARROW","=>",229],["T_WHITESPACE"," ",229],["T_NEW","new",229],["T_WHITESPACE"," ",229],["T_NS_SEPARATOR","\\",229],["T_STRING","Zend_Db_Expr",229],"(",["T_CONSTANT_ENCAPSED_STRING","'SUM(offline_refunded)'",229],")",",",["T_WHITESPACE","\n            ",229],"]",";",["T_WHITESPACE","\n\n            ",230],["T_VARIABLE","$select",232],["T_OBJECT_OPERATOR","->",232],["T_STRING","from",232],"(",["T_VARIABLE","$table",232],",",["T_WHITESPACE"," ",232],["T_VARIABLE","$columns",232],")",["T_OBJECT_OPERATOR","->",232],["T_STRING","where",232],"(",["T_CONSTANT_ENCAPSED_STRING","'store_id != ?'",232],",",["T_WHITESPACE"," ",232],["T_LNUMBER","0",232],")",";",["T_WHITESPACE","\n\n            ",232],["T_IF","if",234],["T_WHITESPACE"," ",234],"(",["T_VARIABLE","$subSelect",234],["T_WHITESPACE"," ",234],["T_IS_NOT_IDENTICAL","!==",234],["T_WHITESPACE"," ",234],["T_STRING","null",234],")",["T_WHITESPACE"," ",234],"{",["T_WHITESPACE","\n                ",234],["T_VARIABLE","$select",235],["T_OBJECT_OPERATOR","->",235],["T_STRING","where",235],"(",["T_VARIABLE","$this",235],["T_OBJECT_OPERATOR","->",235],["T_STRING","_makeConditionFromDateRangeSelect",235],"(",["T_VARIABLE","$subSelect",235],",",["T_WHITESPACE"," ",235],["T_CONSTANT_ENCAPSED_STRING","'period'",235],")",")",";",["T_WHITESPACE","\n            ",235],"}",["T_WHITESPACE","\n\n            ",236],["T_VARIABLE","$select",238],["T_OBJECT_OPERATOR","->",238],["T_STRING","group",238],"(","[",["T_CONSTANT_ENCAPSED_STRING","'period'",238],",",["T_WHITESPACE"," ",238],["T_CONSTANT_ENCAPSED_STRING","'order_status'",238],"]",")",";",["T_WHITESPACE","\n            ",238],["T_VARIABLE","$insertQuery",239],["T_WHITESPACE"," ",239],"=",["T_WHITESPACE"," ",239],["T_VARIABLE","$select",239],["T_OBJECT_OPERATOR","->",239],["T_STRING","insertFromSelect",239],"(",["T_VARIABLE","$table",239],",",["T_WHITESPACE"," ",239],["T_STRING","array_keys",239],"(",["T_VARIABLE","$columns",239],")",")",";",["T_WHITESPACE","\n            ",239],["T_VARIABLE","$connection",240],["T_OBJECT_OPERATOR","->",240],["T_STRING","query",240],"(",["T_VARIABLE","$insertQuery",240],")",";",["T_WHITESPACE","\n        ",240],"}",["T_WHITESPACE"," ",241],["T_CATCH","catch",241],["T_WHITESPACE"," ",241],"(",["T_NS_SEPARATOR","\\",241],["T_STRING","Exception",241],["T_WHITESPACE"," ",241],["T_VARIABLE","$e",241],")",["T_WHITESPACE"," ",241],"{",["T_WHITESPACE","\n            ",241],["T_VARIABLE","$connection",242],["T_OBJECT_OPERATOR","->",242],["T_STRING","rollBack",242],"(",")",";",["T_WHITESPACE","\n            ",242],["T_THROW","throw",243],["T_WHITESPACE"," ",243],["T_VARIABLE","$e",243],";",["T_WHITESPACE","\n        ",243],"}",["T_WHITESPACE","\n        ",244],["T_VARIABLE","$connection",245],["T_OBJECT_OPERATOR","->",245],["T_STRING","commit",245],"(",")",";",["T_WHITESPACE","\n        ",245],["T_RETURN","return",246],["T_WHITESPACE"," ",246],["T_VARIABLE","$this",246],";",["T_WHITESPACE","\n    ",246],"}",["T_WHITESPACE","\n",247],"}",["T_WHITESPACE","\n",248]]