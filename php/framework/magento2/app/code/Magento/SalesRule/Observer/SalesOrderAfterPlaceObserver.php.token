[["T_OPEN_TAG","<?php\n",1],["T_DOC_COMMENT","\/**\n * Copyright \u00c2\u00a9 2013-2017 Magento, Inc. All rights reserved.\n * See COPYING.txt for license details.\n *\/",2],["T_WHITESPACE","\n",5],["T_NAMESPACE","namespace",6],["T_WHITESPACE"," ",6],["T_STRING","Magento",6],["T_NS_SEPARATOR","\\",6],["T_STRING","SalesRule",6],["T_NS_SEPARATOR","\\",6],["T_STRING","Observer",6],";",["T_WHITESPACE","\n\n",6],["T_USE","use",8],["T_WHITESPACE"," ",8],["T_STRING","Magento",8],["T_NS_SEPARATOR","\\",8],["T_STRING","Framework",8],["T_NS_SEPARATOR","\\",8],["T_STRING","Event",8],["T_NS_SEPARATOR","\\",8],["T_STRING","Observer",8],["T_WHITESPACE"," ",8],["T_AS","as",8],["T_WHITESPACE"," ",8],["T_STRING","EventObserver",8],";",["T_WHITESPACE","\n",8],["T_USE","use",9],["T_WHITESPACE"," ",9],["T_STRING","Magento",9],["T_NS_SEPARATOR","\\",9],["T_STRING","Framework",9],["T_NS_SEPARATOR","\\",9],["T_STRING","Event",9],["T_NS_SEPARATOR","\\",9],["T_STRING","ObserverInterface",9],";",["T_WHITESPACE","\n\n",9],["T_CLASS","class",11],["T_WHITESPACE"," ",11],["T_STRING","SalesOrderAfterPlaceObserver",11],["T_WHITESPACE"," ",11],["T_IMPLEMENTS","implements",11],["T_WHITESPACE"," ",11],["T_STRING","ObserverInterface",11],["T_WHITESPACE","\n",11],"{",["T_WHITESPACE","\n    ",12],["T_DOC_COMMENT","\/**\n     * @var \\Magento\\SalesRule\\Model\\RuleFactory\n     *\/",13],["T_WHITESPACE","\n    ",15],["T_PROTECTED","protected",16],["T_WHITESPACE"," ",16],["T_VARIABLE","$_ruleFactory",16],";",["T_WHITESPACE","\n\n    ",16],["T_DOC_COMMENT","\/**\n     * @var \\Magento\\SalesRule\\Model\\RuleFactory\n     *\/",18],["T_WHITESPACE","\n    ",20],["T_PROTECTED","protected",21],["T_WHITESPACE"," ",21],["T_VARIABLE","$_ruleCustomerFactory",21],";",["T_WHITESPACE","\n\n    ",21],["T_DOC_COMMENT","\/**\n     * @var \\Magento\\SalesRule\\Model\\Coupon\n     *\/",23],["T_WHITESPACE","\n    ",25],["T_PROTECTED","protected",26],["T_WHITESPACE"," ",26],["T_VARIABLE","$_coupon",26],";",["T_WHITESPACE","\n\n    ",26],["T_DOC_COMMENT","\/**\n     * @var \\Magento\\SalesRule\\Model\\ResourceModel\\Coupon\\Usage\n     *\/",28],["T_WHITESPACE","\n    ",30],["T_PROTECTED","protected",31],["T_WHITESPACE"," ",31],["T_VARIABLE","$_couponUsage",31],";",["T_WHITESPACE","\n\n    ",31],["T_DOC_COMMENT","\/**\n     * @param \\Magento\\SalesRule\\Model\\RuleFactory $ruleFactory\n     * @param \\Magento\\SalesRule\\Model\\Rule\\CustomerFactory $ruleCustomerFactory\n     * @param \\Magento\\SalesRule\\Model\\Coupon $coupon\n     * @param \\Magento\\SalesRule\\Model\\ResourceModel\\Coupon\\Usage $couponUsage\n     *\/",33],["T_WHITESPACE","\n    ",38],["T_PUBLIC","public",39],["T_WHITESPACE"," ",39],["T_FUNCTION","function",39],["T_WHITESPACE"," ",39],["T_STRING","__construct",39],"(",["T_WHITESPACE","\n        ",39],["T_NS_SEPARATOR","\\",40],["T_STRING","Magento",40],["T_NS_SEPARATOR","\\",40],["T_STRING","SalesRule",40],["T_NS_SEPARATOR","\\",40],["T_STRING","Model",40],["T_NS_SEPARATOR","\\",40],["T_STRING","RuleFactory",40],["T_WHITESPACE"," ",40],["T_VARIABLE","$ruleFactory",40],",",["T_WHITESPACE","\n        ",40],["T_NS_SEPARATOR","\\",41],["T_STRING","Magento",41],["T_NS_SEPARATOR","\\",41],["T_STRING","SalesRule",41],["T_NS_SEPARATOR","\\",41],["T_STRING","Model",41],["T_NS_SEPARATOR","\\",41],["T_STRING","Rule",41],["T_NS_SEPARATOR","\\",41],["T_STRING","CustomerFactory",41],["T_WHITESPACE"," ",41],["T_VARIABLE","$ruleCustomerFactory",41],",",["T_WHITESPACE","\n        ",41],["T_NS_SEPARATOR","\\",42],["T_STRING","Magento",42],["T_NS_SEPARATOR","\\",42],["T_STRING","SalesRule",42],["T_NS_SEPARATOR","\\",42],["T_STRING","Model",42],["T_NS_SEPARATOR","\\",42],["T_STRING","Coupon",42],["T_WHITESPACE"," ",42],["T_VARIABLE","$coupon",42],",",["T_WHITESPACE","\n        ",42],["T_NS_SEPARATOR","\\",43],["T_STRING","Magento",43],["T_NS_SEPARATOR","\\",43],["T_STRING","SalesRule",43],["T_NS_SEPARATOR","\\",43],["T_STRING","Model",43],["T_NS_SEPARATOR","\\",43],["T_STRING","ResourceModel",43],["T_NS_SEPARATOR","\\",43],["T_STRING","Coupon",43],["T_NS_SEPARATOR","\\",43],["T_STRING","Usage",43],["T_WHITESPACE"," ",43],["T_VARIABLE","$couponUsage",43],["T_WHITESPACE","\n    ",43],")",["T_WHITESPACE"," ",44],"{",["T_WHITESPACE","\n        ",44],["T_VARIABLE","$this",45],["T_OBJECT_OPERATOR","->",45],["T_STRING","_ruleFactory",45],["T_WHITESPACE"," ",45],"=",["T_WHITESPACE"," ",45],["T_VARIABLE","$ruleFactory",45],";",["T_WHITESPACE","\n        ",45],["T_VARIABLE","$this",46],["T_OBJECT_OPERATOR","->",46],["T_STRING","_ruleCustomerFactory",46],["T_WHITESPACE"," ",46],"=",["T_WHITESPACE"," ",46],["T_VARIABLE","$ruleCustomerFactory",46],";",["T_WHITESPACE","\n        ",46],["T_VARIABLE","$this",47],["T_OBJECT_OPERATOR","->",47],["T_STRING","_coupon",47],["T_WHITESPACE"," ",47],"=",["T_WHITESPACE"," ",47],["T_VARIABLE","$coupon",47],";",["T_WHITESPACE","\n        ",47],["T_VARIABLE","$this",48],["T_OBJECT_OPERATOR","->",48],["T_STRING","_couponUsage",48],["T_WHITESPACE"," ",48],"=",["T_WHITESPACE"," ",48],["T_VARIABLE","$couponUsage",48],";",["T_WHITESPACE","\n    ",48],"}",["T_WHITESPACE","\n\n    ",49],["T_DOC_COMMENT","\/**\n     * @param EventObserver $observer\n     * @return $this\n     * @SuppressWarnings(PHPMD.CyclomaticComplexity)\n     *\/",51],["T_WHITESPACE","\n    ",55],["T_PUBLIC","public",56],["T_WHITESPACE"," ",56],["T_FUNCTION","function",56],["T_WHITESPACE"," ",56],["T_STRING","execute",56],"(",["T_STRING","EventObserver",56],["T_WHITESPACE"," ",56],["T_VARIABLE","$observer",56],")",["T_WHITESPACE","\n    ",56],"{",["T_WHITESPACE","\n        ",57],["T_VARIABLE","$order",58],["T_WHITESPACE"," ",58],"=",["T_WHITESPACE"," ",58],["T_VARIABLE","$observer",58],["T_OBJECT_OPERATOR","->",58],["T_STRING","getEvent",58],"(",")",["T_OBJECT_OPERATOR","->",58],["T_STRING","getOrder",58],"(",")",";",["T_WHITESPACE","\n\n        ",58],["T_IF","if",60],["T_WHITESPACE"," ",60],"(","!",["T_VARIABLE","$order",60],["T_WHITESPACE"," ",60],["T_BOOLEAN_OR","||",60],["T_WHITESPACE"," ",60],"!",["T_VARIABLE","$order",60],["T_OBJECT_OPERATOR","->",60],["T_STRING","getAppliedRuleIds",60],"(",")",")",["T_WHITESPACE"," ",60],"{",["T_WHITESPACE","\n            ",60],["T_RETURN","return",61],["T_WHITESPACE"," ",61],["T_VARIABLE","$this",61],";",["T_WHITESPACE","\n        ",61],"}",["T_WHITESPACE","\n\n        ",62],["T_COMMENT","\/\/ lookup rule ids\n",64],["T_WHITESPACE","        ",65],["T_VARIABLE","$ruleIds",65],["T_WHITESPACE"," ",65],"=",["T_WHITESPACE"," ",65],["T_STRING","explode",65],"(",["T_CONSTANT_ENCAPSED_STRING","','",65],",",["T_WHITESPACE"," ",65],["T_VARIABLE","$order",65],["T_OBJECT_OPERATOR","->",65],["T_STRING","getAppliedRuleIds",65],"(",")",")",";",["T_WHITESPACE","\n        ",65],["T_VARIABLE","$ruleIds",66],["T_WHITESPACE"," ",66],"=",["T_WHITESPACE"," ",66],["T_STRING","array_unique",66],"(",["T_VARIABLE","$ruleIds",66],")",";",["T_WHITESPACE","\n\n        ",66],["T_VARIABLE","$ruleCustomer",68],["T_WHITESPACE"," ",68],"=",["T_WHITESPACE"," ",68],["T_STRING","null",68],";",["T_WHITESPACE","\n        ",68],["T_VARIABLE","$customerId",69],["T_WHITESPACE"," ",69],"=",["T_WHITESPACE"," ",69],["T_VARIABLE","$order",69],["T_OBJECT_OPERATOR","->",69],["T_STRING","getCustomerId",69],"(",")",";",["T_WHITESPACE","\n\n        ",69],["T_COMMENT","\/\/ use each rule (and apply to customer, if applicable)\n",71],["T_WHITESPACE","        ",72],["T_FOREACH","foreach",72],["T_WHITESPACE"," ",72],"(",["T_VARIABLE","$ruleIds",72],["T_WHITESPACE"," ",72],["T_AS","as",72],["T_WHITESPACE"," ",72],["T_VARIABLE","$ruleId",72],")",["T_WHITESPACE"," ",72],"{",["T_WHITESPACE","\n            ",72],["T_IF","if",73],["T_WHITESPACE"," ",73],"(","!",["T_VARIABLE","$ruleId",73],")",["T_WHITESPACE"," ",73],"{",["T_WHITESPACE","\n                ",73],["T_CONTINUE","continue",74],";",["T_WHITESPACE","\n            ",74],"}",["T_WHITESPACE","\n            ",75],["T_DOC_COMMENT","\/** @var \\Magento\\SalesRule\\Model\\Rule $rule *\/",76],["T_WHITESPACE","\n            ",76],["T_VARIABLE","$rule",77],["T_WHITESPACE"," ",77],"=",["T_WHITESPACE"," ",77],["T_VARIABLE","$this",77],["T_OBJECT_OPERATOR","->",77],["T_STRING","_ruleFactory",77],["T_OBJECT_OPERATOR","->",77],["T_STRING","create",77],"(",")",";",["T_WHITESPACE","\n            ",77],["T_VARIABLE","$rule",78],["T_OBJECT_OPERATOR","->",78],["T_STRING","load",78],"(",["T_VARIABLE","$ruleId",78],")",";",["T_WHITESPACE","\n            ",78],["T_IF","if",79],["T_WHITESPACE"," ",79],"(",["T_VARIABLE","$rule",79],["T_OBJECT_OPERATOR","->",79],["T_STRING","getId",79],"(",")",")",["T_WHITESPACE"," ",79],"{",["T_WHITESPACE","\n                ",79],["T_VARIABLE","$rule",80],["T_OBJECT_OPERATOR","->",80],["T_STRING","loadCouponCode",80],"(",")",";",["T_WHITESPACE","\n                ",80],["T_VARIABLE","$rule",81],["T_OBJECT_OPERATOR","->",81],["T_STRING","setTimesUsed",81],"(",["T_VARIABLE","$rule",81],["T_OBJECT_OPERATOR","->",81],["T_STRING","getTimesUsed",81],"(",")",["T_WHITESPACE"," ",81],"+",["T_WHITESPACE"," ",81],["T_LNUMBER","1",81],")",";",["T_WHITESPACE","\n                ",81],["T_VARIABLE","$rule",82],["T_OBJECT_OPERATOR","->",82],["T_STRING","save",82],"(",")",";",["T_WHITESPACE","\n\n                ",82],["T_IF","if",84],["T_WHITESPACE"," ",84],"(",["T_VARIABLE","$customerId",84],")",["T_WHITESPACE"," ",84],"{",["T_WHITESPACE","\n                    ",84],["T_DOC_COMMENT","\/** @var \\Magento\\SalesRule\\Model\\Rule\\Customer $ruleCustomer *\/",85],["T_WHITESPACE","\n                    ",85],["T_VARIABLE","$ruleCustomer",86],["T_WHITESPACE"," ",86],"=",["T_WHITESPACE"," ",86],["T_VARIABLE","$this",86],["T_OBJECT_OPERATOR","->",86],["T_STRING","_ruleCustomerFactory",86],["T_OBJECT_OPERATOR","->",86],["T_STRING","create",86],"(",")",";",["T_WHITESPACE","\n                    ",86],["T_VARIABLE","$ruleCustomer",87],["T_OBJECT_OPERATOR","->",87],["T_STRING","loadByCustomerRule",87],"(",["T_VARIABLE","$customerId",87],",",["T_WHITESPACE"," ",87],["T_VARIABLE","$ruleId",87],")",";",["T_WHITESPACE","\n\n                    ",87],["T_IF","if",89],["T_WHITESPACE"," ",89],"(",["T_VARIABLE","$ruleCustomer",89],["T_OBJECT_OPERATOR","->",89],["T_STRING","getId",89],"(",")",")",["T_WHITESPACE"," ",89],"{",["T_WHITESPACE","\n                        ",89],["T_VARIABLE","$ruleCustomer",90],["T_OBJECT_OPERATOR","->",90],["T_STRING","setTimesUsed",90],"(",["T_VARIABLE","$ruleCustomer",90],["T_OBJECT_OPERATOR","->",90],["T_STRING","getTimesUsed",90],"(",")",["T_WHITESPACE"," ",90],"+",["T_WHITESPACE"," ",90],["T_LNUMBER","1",90],")",";",["T_WHITESPACE","\n                    ",90],"}",["T_WHITESPACE"," ",91],["T_ELSE","else",91],["T_WHITESPACE"," ",91],"{",["T_WHITESPACE","\n                        ",91],["T_VARIABLE","$ruleCustomer",92],["T_OBJECT_OPERATOR","->",92],["T_STRING","setCustomerId",92],"(",["T_VARIABLE","$customerId",92],")",["T_OBJECT_OPERATOR","->",92],["T_STRING","setRuleId",92],"(",["T_VARIABLE","$ruleId",92],")",["T_OBJECT_OPERATOR","->",92],["T_STRING","setTimesUsed",92],"(",["T_LNUMBER","1",92],")",";",["T_WHITESPACE","\n                    ",92],"}",["T_WHITESPACE","\n                    ",93],["T_VARIABLE","$ruleCustomer",94],["T_OBJECT_OPERATOR","->",94],["T_STRING","save",94],"(",")",";",["T_WHITESPACE","\n                ",94],"}",["T_WHITESPACE","\n            ",95],"}",["T_WHITESPACE","\n        ",96],"}",["T_WHITESPACE","\n\n        ",97],["T_VARIABLE","$this",99],["T_OBJECT_OPERATOR","->",99],["T_STRING","_coupon",99],["T_OBJECT_OPERATOR","->",99],["T_STRING","load",99],"(",["T_VARIABLE","$order",99],["T_OBJECT_OPERATOR","->",99],["T_STRING","getCouponCode",99],"(",")",",",["T_WHITESPACE"," ",99],["T_CONSTANT_ENCAPSED_STRING","'code'",99],")",";",["T_WHITESPACE","\n        ",99],["T_IF","if",100],["T_WHITESPACE"," ",100],"(",["T_VARIABLE","$this",100],["T_OBJECT_OPERATOR","->",100],["T_STRING","_coupon",100],["T_OBJECT_OPERATOR","->",100],["T_STRING","getId",100],"(",")",")",["T_WHITESPACE"," ",100],"{",["T_WHITESPACE","\n            ",100],["T_VARIABLE","$this",101],["T_OBJECT_OPERATOR","->",101],["T_STRING","_coupon",101],["T_OBJECT_OPERATOR","->",101],["T_STRING","setTimesUsed",101],"(",["T_VARIABLE","$this",101],["T_OBJECT_OPERATOR","->",101],["T_STRING","_coupon",101],["T_OBJECT_OPERATOR","->",101],["T_STRING","getTimesUsed",101],"(",")",["T_WHITESPACE"," ",101],"+",["T_WHITESPACE"," ",101],["T_LNUMBER","1",101],")",";",["T_WHITESPACE","\n            ",101],["T_VARIABLE","$this",102],["T_OBJECT_OPERATOR","->",102],["T_STRING","_coupon",102],["T_OBJECT_OPERATOR","->",102],["T_STRING","save",102],"(",")",";",["T_WHITESPACE","\n            ",102],["T_IF","if",103],["T_WHITESPACE"," ",103],"(",["T_VARIABLE","$customerId",103],")",["T_WHITESPACE"," ",103],"{",["T_WHITESPACE","\n                ",103],["T_VARIABLE","$this",104],["T_OBJECT_OPERATOR","->",104],["T_STRING","_couponUsage",104],["T_OBJECT_OPERATOR","->",104],["T_STRING","updateCustomerCouponTimesUsed",104],"(",["T_VARIABLE","$customerId",104],",",["T_WHITESPACE"," ",104],["T_VARIABLE","$this",104],["T_OBJECT_OPERATOR","->",104],["T_STRING","_coupon",104],["T_OBJECT_OPERATOR","->",104],["T_STRING","getId",104],"(",")",")",";",["T_WHITESPACE","\n            ",104],"}",["T_WHITESPACE","\n        ",105],"}",["T_WHITESPACE","\n\n        ",106],["T_RETURN","return",108],["T_WHITESPACE"," ",108],["T_VARIABLE","$this",108],";",["T_WHITESPACE","\n    ",108],"}",["T_WHITESPACE","\n",109],"}",["T_WHITESPACE","\n",110]]