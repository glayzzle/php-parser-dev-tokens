[["T_OPEN_TAG","<?php\n",1],["T_DOC_COMMENT","\/**\n * Copyright \u00c2\u00a9 2013-2017 Magento, Inc. All rights reserved.\n * See COPYING.txt for license details.\n *\/",2],["T_WHITESPACE","\n",5],["T_NAMESPACE","namespace",6],["T_WHITESPACE"," ",6],["T_STRING","Magento",6],["T_NS_SEPARATOR","\\",6],["T_STRING","SalesRule",6],["T_NS_SEPARATOR","\\",6],["T_STRING","Model",6],["T_NS_SEPARATOR","\\",6],["T_STRING","ResourceModel",6],";",["T_WHITESPACE","\n\n",6],["T_USE","use",8],["T_WHITESPACE"," ",8],["T_STRING","Magento",8],["T_NS_SEPARATOR","\\",8],["T_STRING","Framework",8],["T_NS_SEPARATOR","\\",8],["T_STRING","Model",8],["T_NS_SEPARATOR","\\",8],["T_STRING","AbstractModel",8],";",["T_WHITESPACE","\n\n",8],["T_DOC_COMMENT","\/**\n * SalesRule Resource Coupon\n *\n * @author      Magento Core Team <core@magentocommerce.com>\n *\/",10],["T_WHITESPACE","\n",14],["T_CLASS","class",15],["T_WHITESPACE"," ",15],["T_STRING","Coupon",15],["T_WHITESPACE"," ",15],["T_EXTENDS","extends",15],["T_WHITESPACE"," ",15],["T_NS_SEPARATOR","\\",15],["T_STRING","Magento",15],["T_NS_SEPARATOR","\\",15],["T_STRING","Framework",15],["T_NS_SEPARATOR","\\",15],["T_STRING","Model",15],["T_NS_SEPARATOR","\\",15],["T_STRING","ResourceModel",15],["T_NS_SEPARATOR","\\",15],["T_STRING","Db",15],["T_NS_SEPARATOR","\\",15],["T_STRING","AbstractDb",15],["T_WHITESPACE"," ",15],["T_IMPLEMENTS","implements",15],["T_WHITESPACE","\n    ",15],["T_NS_SEPARATOR","\\",16],["T_STRING","Magento",16],["T_NS_SEPARATOR","\\",16],["T_STRING","SalesRule",16],["T_NS_SEPARATOR","\\",16],["T_STRING","Model",16],["T_NS_SEPARATOR","\\",16],["T_STRING","Spi",16],["T_NS_SEPARATOR","\\",16],["T_STRING","CouponResourceInterface",16],["T_WHITESPACE","\n",16],"{",["T_WHITESPACE","\n    ",17],["T_DOC_COMMENT","\/**\n     * Constructor adds unique fields\n     *\n     * @return void\n     *\/",18],["T_WHITESPACE","\n    ",22],["T_PROTECTED","protected",23],["T_WHITESPACE"," ",23],["T_FUNCTION","function",23],["T_WHITESPACE"," ",23],["T_STRING","_construct",23],"(",")",["T_WHITESPACE","\n    ",23],"{",["T_WHITESPACE","\n        ",24],["T_VARIABLE","$this",25],["T_OBJECT_OPERATOR","->",25],["T_STRING","_init",25],"(",["T_CONSTANT_ENCAPSED_STRING","'salesrule_coupon'",25],",",["T_WHITESPACE"," ",25],["T_CONSTANT_ENCAPSED_STRING","'coupon_id'",25],")",";",["T_WHITESPACE","\n        ",25],["T_VARIABLE","$this",26],["T_OBJECT_OPERATOR","->",26],["T_STRING","addUniqueField",26],"(","[",["T_CONSTANT_ENCAPSED_STRING","'field'",26],["T_WHITESPACE"," ",26],["T_DOUBLE_ARROW","=>",26],["T_WHITESPACE"," ",26],["T_CONSTANT_ENCAPSED_STRING","'code'",26],",",["T_WHITESPACE"," ",26],["T_CONSTANT_ENCAPSED_STRING","'title'",26],["T_WHITESPACE"," ",26],["T_DOUBLE_ARROW","=>",26],["T_WHITESPACE"," ",26],["T_STRING","__",26],"(",["T_CONSTANT_ENCAPSED_STRING","'Coupon with the same code'",26],")","]",")",";",["T_WHITESPACE","\n    ",26],"}",["T_WHITESPACE","\n\n    ",27],["T_DOC_COMMENT","\/**\n     * Perform actions before object save\n     *\n     * @param AbstractModel $object\n     * @return $this\n     *\/",29],["T_WHITESPACE","\n    ",34],["T_PUBLIC","public",35],["T_WHITESPACE"," ",35],["T_FUNCTION","function",35],["T_WHITESPACE"," ",35],["T_STRING","_beforeSave",35],"(",["T_STRING","AbstractModel",35],["T_WHITESPACE"," ",35],["T_VARIABLE","$object",35],")",["T_WHITESPACE","\n    ",35],"{",["T_WHITESPACE","\n        ",36],["T_IF","if",37],["T_WHITESPACE"," ",37],"(","!",["T_VARIABLE","$object",37],["T_OBJECT_OPERATOR","->",37],["T_STRING","getExpirationDate",37],"(",")",")",["T_WHITESPACE"," ",37],"{",["T_WHITESPACE","\n            ",37],["T_VARIABLE","$object",38],["T_OBJECT_OPERATOR","->",38],["T_STRING","setExpirationDate",38],"(",["T_STRING","null",38],")",";",["T_WHITESPACE","\n        ",38],"}",["T_WHITESPACE"," ",39],["T_ELSEIF","elseif",39],["T_WHITESPACE"," ",39],"(",["T_VARIABLE","$object",39],["T_OBJECT_OPERATOR","->",39],["T_STRING","getExpirationDate",39],"(",")",["T_WHITESPACE"," ",39],["T_INSTANCEOF","instanceof",39],["T_WHITESPACE"," ",39],["T_NS_SEPARATOR","\\",39],["T_STRING","DateTimeInterface",39],")",["T_WHITESPACE"," ",39],"{",["T_WHITESPACE","\n            ",39],["T_VARIABLE","$object",40],["T_OBJECT_OPERATOR","->",40],["T_STRING","setExpirationDate",40],"(",["T_WHITESPACE","\n                ",40],["T_VARIABLE","$object",41],["T_OBJECT_OPERATOR","->",41],["T_STRING","getExpirationDate",41],"(",")",["T_OBJECT_OPERATOR","->",41],["T_STRING","format",41],"(",["T_CONSTANT_ENCAPSED_STRING","'Y-m-d H:i:s'",41],")",["T_WHITESPACE","\n            ",41],")",";",["T_WHITESPACE","\n        ",42],"}",["T_WHITESPACE","\n\n        ",43],["T_COMMENT","\/\/ maintain single primary coupon per rule\n",45],["T_WHITESPACE","        ",46],["T_VARIABLE","$object",46],["T_OBJECT_OPERATOR","->",46],["T_STRING","setIsPrimary",46],"(",["T_VARIABLE","$object",46],["T_OBJECT_OPERATOR","->",46],["T_STRING","getIsPrimary",46],"(",")",["T_WHITESPACE"," ",46],"?",["T_WHITESPACE"," ",46],["T_LNUMBER","1",46],["T_WHITESPACE"," ",46],":",["T_WHITESPACE"," ",46],["T_STRING","null",46],")",";",["T_WHITESPACE","\n\n        ",46],["T_RETURN","return",48],["T_WHITESPACE"," ",48],["T_STRING","parent",48],["T_DOUBLE_COLON","::",48],["T_STRING","_beforeSave",48],"(",["T_VARIABLE","$object",48],")",";",["T_WHITESPACE","\n    ",48],"}",["T_WHITESPACE","\n\n    ",49],["T_DOC_COMMENT","\/**\n     * Load primary coupon (is_primary = 1) for specified rule\n     *\n     *\n     * @param \\Magento\\SalesRule\\Model\\Coupon $object\n     * @param \\Magento\\SalesRule\\Model\\Rule|int $rule\n     * @return bool\n     *\/",51],["T_WHITESPACE","\n    ",58],["T_PUBLIC","public",59],["T_WHITESPACE"," ",59],["T_FUNCTION","function",59],["T_WHITESPACE"," ",59],["T_STRING","loadPrimaryByRule",59],"(",["T_NS_SEPARATOR","\\",59],["T_STRING","Magento",59],["T_NS_SEPARATOR","\\",59],["T_STRING","SalesRule",59],["T_NS_SEPARATOR","\\",59],["T_STRING","Model",59],["T_NS_SEPARATOR","\\",59],["T_STRING","Coupon",59],["T_WHITESPACE"," ",59],["T_VARIABLE","$object",59],",",["T_WHITESPACE"," ",59],["T_VARIABLE","$rule",59],")",["T_WHITESPACE","\n    ",59],"{",["T_WHITESPACE","\n        ",60],["T_VARIABLE","$connection",61],["T_WHITESPACE"," ",61],"=",["T_WHITESPACE"," ",61],["T_VARIABLE","$this",61],["T_OBJECT_OPERATOR","->",61],["T_STRING","getConnection",61],"(",")",";",["T_WHITESPACE","\n\n        ",61],["T_IF","if",63],["T_WHITESPACE"," ",63],"(",["T_VARIABLE","$rule",63],["T_WHITESPACE"," ",63],["T_INSTANCEOF","instanceof",63],["T_WHITESPACE"," ",63],["T_NS_SEPARATOR","\\",63],["T_STRING","Magento",63],["T_NS_SEPARATOR","\\",63],["T_STRING","SalesRule",63],["T_NS_SEPARATOR","\\",63],["T_STRING","Model",63],["T_NS_SEPARATOR","\\",63],["T_STRING","Rule",63],")",["T_WHITESPACE"," ",63],"{",["T_WHITESPACE","\n            ",63],["T_VARIABLE","$ruleId",64],["T_WHITESPACE"," ",64],"=",["T_WHITESPACE"," ",64],["T_VARIABLE","$rule",64],["T_OBJECT_OPERATOR","->",64],["T_STRING","getId",64],"(",")",";",["T_WHITESPACE","\n        ",64],"}",["T_WHITESPACE"," ",65],["T_ELSE","else",65],["T_WHITESPACE"," ",65],"{",["T_WHITESPACE","\n            ",65],["T_VARIABLE","$ruleId",66],["T_WHITESPACE"," ",66],"=",["T_WHITESPACE"," ",66],["T_INT_CAST","(int)",66],["T_VARIABLE","$rule",66],";",["T_WHITESPACE","\n        ",66],"}",["T_WHITESPACE","\n\n        ",67],["T_VARIABLE","$select",69],["T_WHITESPACE"," ",69],"=",["T_WHITESPACE"," ",69],["T_VARIABLE","$connection",69],["T_OBJECT_OPERATOR","->",69],["T_STRING","select",69],"(",")",["T_OBJECT_OPERATOR","->",69],["T_STRING","from",69],"(",["T_WHITESPACE","\n            ",69],["T_VARIABLE","$this",70],["T_OBJECT_OPERATOR","->",70],["T_STRING","getMainTable",70],"(",")",["T_WHITESPACE","\n        ",70],")",["T_OBJECT_OPERATOR","->",71],["T_STRING","where",71],"(",["T_WHITESPACE","\n            ",71],["T_CONSTANT_ENCAPSED_STRING","'rule_id = :rule_id'",72],["T_WHITESPACE","\n        ",72],")",["T_OBJECT_OPERATOR","->",73],["T_STRING","where",73],"(",["T_WHITESPACE","\n            ",73],["T_CONSTANT_ENCAPSED_STRING","'is_primary = :is_primary'",74],["T_WHITESPACE","\n        ",74],")",";",["T_WHITESPACE","\n\n        ",75],["T_VARIABLE","$data",77],["T_WHITESPACE"," ",77],"=",["T_WHITESPACE"," ",77],["T_VARIABLE","$connection",77],["T_OBJECT_OPERATOR","->",77],["T_STRING","fetchRow",77],"(",["T_VARIABLE","$select",77],",",["T_WHITESPACE"," ",77],"[",["T_CONSTANT_ENCAPSED_STRING","':rule_id'",77],["T_WHITESPACE"," ",77],["T_DOUBLE_ARROW","=>",77],["T_WHITESPACE"," ",77],["T_VARIABLE","$ruleId",77],",",["T_WHITESPACE"," ",77],["T_CONSTANT_ENCAPSED_STRING","':is_primary'",77],["T_WHITESPACE"," ",77],["T_DOUBLE_ARROW","=>",77],["T_WHITESPACE"," ",77],["T_LNUMBER","1",77],"]",")",";",["T_WHITESPACE","\n\n        ",77],["T_IF","if",79],["T_WHITESPACE"," ",79],"(","!",["T_VARIABLE","$data",79],")",["T_WHITESPACE"," ",79],"{",["T_WHITESPACE","\n            ",79],["T_RETURN","return",80],["T_WHITESPACE"," ",80],["T_STRING","false",80],";",["T_WHITESPACE","\n        ",80],"}",["T_WHITESPACE","\n\n        ",81],["T_VARIABLE","$object",83],["T_OBJECT_OPERATOR","->",83],["T_STRING","setData",83],"(",["T_VARIABLE","$data",83],")",";",["T_WHITESPACE","\n\n        ",83],["T_VARIABLE","$this",85],["T_OBJECT_OPERATOR","->",85],["T_STRING","_afterLoad",85],"(",["T_VARIABLE","$object",85],")",";",["T_WHITESPACE","\n        ",85],["T_RETURN","return",86],["T_WHITESPACE"," ",86],["T_STRING","true",86],";",["T_WHITESPACE","\n    ",86],"}",["T_WHITESPACE","\n\n    ",87],["T_DOC_COMMENT","\/**\n     * Check if code exists\n     *\n     * @param string $code\n     * @return bool\n     *\/",89],["T_WHITESPACE","\n    ",94],["T_PUBLIC","public",95],["T_WHITESPACE"," ",95],["T_FUNCTION","function",95],["T_WHITESPACE"," ",95],["T_STRING","exists",95],"(",["T_VARIABLE","$code",95],")",["T_WHITESPACE","\n    ",95],"{",["T_WHITESPACE","\n        ",96],["T_VARIABLE","$connection",97],["T_WHITESPACE"," ",97],"=",["T_WHITESPACE"," ",97],["T_VARIABLE","$this",97],["T_OBJECT_OPERATOR","->",97],["T_STRING","getConnection",97],"(",")",";",["T_WHITESPACE","\n        ",97],["T_VARIABLE","$select",98],["T_WHITESPACE"," ",98],"=",["T_WHITESPACE"," ",98],["T_VARIABLE","$connection",98],["T_OBJECT_OPERATOR","->",98],["T_STRING","select",98],"(",")",";",["T_WHITESPACE","\n        ",98],["T_VARIABLE","$select",99],["T_OBJECT_OPERATOR","->",99],["T_STRING","from",99],"(",["T_VARIABLE","$this",99],["T_OBJECT_OPERATOR","->",99],["T_STRING","getMainTable",99],"(",")",",",["T_WHITESPACE"," ",99],["T_CONSTANT_ENCAPSED_STRING","'code'",99],")",";",["T_WHITESPACE","\n        ",99],["T_VARIABLE","$select",100],["T_OBJECT_OPERATOR","->",100],["T_STRING","where",100],"(",["T_CONSTANT_ENCAPSED_STRING","'code = :code'",100],")",";",["T_WHITESPACE","\n\n        ",100],["T_IF","if",102],["T_WHITESPACE"," ",102],"(",["T_VARIABLE","$connection",102],["T_OBJECT_OPERATOR","->",102],["T_STRING","fetchOne",102],"(",["T_VARIABLE","$select",102],",",["T_WHITESPACE"," ",102],"[",["T_CONSTANT_ENCAPSED_STRING","'code'",102],["T_WHITESPACE"," ",102],["T_DOUBLE_ARROW","=>",102],["T_WHITESPACE"," ",102],["T_VARIABLE","$code",102],"]",")",["T_WHITESPACE"," ",102],["T_IS_IDENTICAL","===",102],["T_WHITESPACE"," ",102],["T_STRING","false",102],")",["T_WHITESPACE"," ",102],"{",["T_WHITESPACE","\n            ",102],["T_RETURN","return",103],["T_WHITESPACE"," ",103],["T_STRING","false",103],";",["T_WHITESPACE","\n        ",103],"}",["T_WHITESPACE","\n        ",104],["T_RETURN","return",105],["T_WHITESPACE"," ",105],["T_STRING","true",105],";",["T_WHITESPACE","\n    ",105],"}",["T_WHITESPACE","\n\n    ",106],["T_DOC_COMMENT","\/**\n     * Update auto generated Specific Coupon if it's rule changed\n     *\n     * @param \\Magento\\SalesRule\\Model\\Rule $rule\n     * @return $this\n     *\/",108],["T_WHITESPACE","\n    ",113],["T_PUBLIC","public",114],["T_WHITESPACE"," ",114],["T_FUNCTION","function",114],["T_WHITESPACE"," ",114],["T_STRING","updateSpecificCoupons",114],"(",["T_NS_SEPARATOR","\\",114],["T_STRING","Magento",114],["T_NS_SEPARATOR","\\",114],["T_STRING","SalesRule",114],["T_NS_SEPARATOR","\\",114],["T_STRING","Model",114],["T_NS_SEPARATOR","\\",114],["T_STRING","Rule",114],["T_WHITESPACE"," ",114],["T_VARIABLE","$rule",114],")",["T_WHITESPACE","\n    ",114],"{",["T_WHITESPACE","\n        ",115],["T_IF","if",116],["T_WHITESPACE"," ",116],"(","!",["T_VARIABLE","$rule",116],["T_WHITESPACE"," ",116],["T_BOOLEAN_OR","||",116],["T_WHITESPACE"," ",116],"!",["T_VARIABLE","$rule",116],["T_OBJECT_OPERATOR","->",116],["T_STRING","getId",116],"(",")",["T_WHITESPACE"," ",116],["T_BOOLEAN_OR","||",116],["T_WHITESPACE"," ",116],"!",["T_VARIABLE","$rule",116],["T_OBJECT_OPERATOR","->",116],["T_STRING","hasDataChanges",116],"(",")",")",["T_WHITESPACE"," ",116],"{",["T_WHITESPACE","\n            ",116],["T_RETURN","return",117],["T_WHITESPACE"," ",117],["T_VARIABLE","$this",117],";",["T_WHITESPACE","\n        ",117],"}",["T_WHITESPACE","\n\n        ",118],["T_VARIABLE","$updateArray",120],["T_WHITESPACE"," ",120],"=",["T_WHITESPACE"," ",120],"[","]",";",["T_WHITESPACE","\n        ",120],["T_IF","if",121],["T_WHITESPACE"," ",121],"(",["T_VARIABLE","$rule",121],["T_OBJECT_OPERATOR","->",121],["T_STRING","dataHasChangedFor",121],"(",["T_CONSTANT_ENCAPSED_STRING","'uses_per_coupon'",121],")",")",["T_WHITESPACE"," ",121],"{",["T_WHITESPACE","\n            ",121],["T_VARIABLE","$updateArray",122],"[",["T_CONSTANT_ENCAPSED_STRING","'usage_limit'",122],"]",["T_WHITESPACE"," ",122],"=",["T_WHITESPACE"," ",122],["T_VARIABLE","$rule",122],["T_OBJECT_OPERATOR","->",122],["T_STRING","getUsesPerCoupon",122],"(",")",";",["T_WHITESPACE","\n        ",122],"}",["T_WHITESPACE","\n\n        ",123],["T_IF","if",125],["T_WHITESPACE"," ",125],"(",["T_VARIABLE","$rule",125],["T_OBJECT_OPERATOR","->",125],["T_STRING","dataHasChangedFor",125],"(",["T_CONSTANT_ENCAPSED_STRING","'uses_per_customer'",125],")",")",["T_WHITESPACE"," ",125],"{",["T_WHITESPACE","\n            ",125],["T_VARIABLE","$updateArray",126],"[",["T_CONSTANT_ENCAPSED_STRING","'usage_per_customer'",126],"]",["T_WHITESPACE"," ",126],"=",["T_WHITESPACE"," ",126],["T_VARIABLE","$rule",126],["T_OBJECT_OPERATOR","->",126],["T_STRING","getUsesPerCustomer",126],"(",")",";",["T_WHITESPACE","\n        ",126],"}",["T_WHITESPACE","\n\n        ",127],["T_VARIABLE","$ruleNewDate",129],["T_WHITESPACE"," ",129],"=",["T_WHITESPACE"," ",129],["T_NEW","new",129],["T_WHITESPACE"," ",129],["T_NS_SEPARATOR","\\",129],["T_STRING","DateTime",129],"(",["T_VARIABLE","$rule",129],["T_OBJECT_OPERATOR","->",129],["T_STRING","getToDate",129],"(",")",")",";",["T_WHITESPACE","\n        ",129],["T_VARIABLE","$ruleOldDate",130],["T_WHITESPACE"," ",130],"=",["T_WHITESPACE"," ",130],["T_NEW","new",130],["T_WHITESPACE"," ",130],["T_NS_SEPARATOR","\\",130],["T_STRING","DateTime",130],"(",["T_VARIABLE","$rule",130],["T_OBJECT_OPERATOR","->",130],["T_STRING","getOrigData",130],"(",["T_CONSTANT_ENCAPSED_STRING","'to_date'",130],")",")",";",["T_WHITESPACE","\n\n        ",130],["T_IF","if",132],["T_WHITESPACE"," ",132],"(",["T_VARIABLE","$ruleNewDate",132],["T_WHITESPACE"," ",132],["T_IS_NOT_EQUAL","!=",132],["T_WHITESPACE"," ",132],["T_VARIABLE","$ruleOldDate",132],")",["T_WHITESPACE"," ",132],"{",["T_WHITESPACE","\n            ",132],["T_VARIABLE","$updateArray",133],"[",["T_CONSTANT_ENCAPSED_STRING","'expiration_date'",133],"]",["T_WHITESPACE"," ",133],"=",["T_WHITESPACE"," ",133],["T_VARIABLE","$rule",133],["T_OBJECT_OPERATOR","->",133],["T_STRING","getToDate",133],"(",")",";",["T_WHITESPACE","\n        ",133],"}",["T_WHITESPACE","\n\n        ",134],["T_IF","if",136],["T_WHITESPACE"," ",136],"(","!",["T_EMPTY","empty",136],"(",["T_VARIABLE","$updateArray",136],")",")",["T_WHITESPACE"," ",136],"{",["T_WHITESPACE","\n            ",136],["T_VARIABLE","$this",137],["T_OBJECT_OPERATOR","->",137],["T_STRING","getConnection",137],"(",")",["T_OBJECT_OPERATOR","->",137],["T_STRING","update",137],"(",["T_WHITESPACE","\n                ",137],["T_VARIABLE","$this",138],["T_OBJECT_OPERATOR","->",138],["T_STRING","getTable",138],"(",["T_CONSTANT_ENCAPSED_STRING","'salesrule_coupon'",138],")",",",["T_WHITESPACE","\n                ",138],["T_VARIABLE","$updateArray",139],",",["T_WHITESPACE","\n                ",139],"[",["T_CONSTANT_ENCAPSED_STRING","'rule_id = ?'",140],["T_WHITESPACE"," ",140],["T_DOUBLE_ARROW","=>",140],["T_WHITESPACE"," ",140],["T_VARIABLE","$rule",140],["T_OBJECT_OPERATOR","->",140],["T_STRING","getId",140],"(",")","]",["T_WHITESPACE","\n            ",140],")",";",["T_WHITESPACE","\n        ",141],"}",["T_WHITESPACE","\n\n        ",142],["T_RETURN","return",144],["T_WHITESPACE"," ",144],["T_VARIABLE","$this",144],";",["T_WHITESPACE","\n    ",144],"}",["T_WHITESPACE","\n",145],"}",["T_WHITESPACE","\n",146]]