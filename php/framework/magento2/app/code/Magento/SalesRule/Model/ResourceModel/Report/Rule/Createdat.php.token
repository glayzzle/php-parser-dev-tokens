[["T_OPEN_TAG","<?php\n",1],["T_DOC_COMMENT","\/**\n * Copyright \u00c2\u00a9 2013-2017 Magento, Inc. All rights reserved.\n * See COPYING.txt for license details.\n *\/",2],["T_WHITESPACE","\n\n",5],["T_COMMENT","\/\/ @codingStandardsIgnoreFile\n",7],["T_WHITESPACE","\n",8],["T_NAMESPACE","namespace",9],["T_WHITESPACE"," ",9],["T_STRING","Magento",9],["T_NS_SEPARATOR","\\",9],["T_STRING","SalesRule",9],["T_NS_SEPARATOR","\\",9],["T_STRING","Model",9],["T_NS_SEPARATOR","\\",9],["T_STRING","ResourceModel",9],["T_NS_SEPARATOR","\\",9],["T_STRING","Report",9],["T_NS_SEPARATOR","\\",9],["T_STRING","Rule",9],";",["T_WHITESPACE","\n\n",9],["T_DOC_COMMENT","\/**\n * Rule report resource model with aggregation by created at\n *\n * @author      Magento Core Team <core@magentocommerce.com>\n *\/",11],["T_WHITESPACE","\n",15],["T_CLASS","class",16],["T_WHITESPACE"," ",16],["T_STRING","Createdat",16],["T_WHITESPACE"," ",16],["T_EXTENDS","extends",16],["T_WHITESPACE"," ",16],["T_NS_SEPARATOR","\\",16],["T_STRING","Magento",16],["T_NS_SEPARATOR","\\",16],["T_STRING","Reports",16],["T_NS_SEPARATOR","\\",16],["T_STRING","Model",16],["T_NS_SEPARATOR","\\",16],["T_STRING","ResourceModel",16],["T_NS_SEPARATOR","\\",16],["T_STRING","Report",16],["T_NS_SEPARATOR","\\",16],["T_STRING","AbstractReport",16],["T_WHITESPACE","\n",16],"{",["T_WHITESPACE","\n    ",17],["T_DOC_COMMENT","\/**\n     * Resource Report Rule constructor\n     *\n     * @return void\n     *\/",18],["T_WHITESPACE","\n    ",22],["T_PROTECTED","protected",23],["T_WHITESPACE"," ",23],["T_FUNCTION","function",23],["T_WHITESPACE"," ",23],["T_STRING","_construct",23],"(",")",["T_WHITESPACE","\n    ",23],"{",["T_WHITESPACE","\n        ",24],["T_VARIABLE","$this",25],["T_OBJECT_OPERATOR","->",25],["T_STRING","_init",25],"(",["T_CONSTANT_ENCAPSED_STRING","'salesrule_coupon_aggregated'",25],",",["T_WHITESPACE"," ",25],["T_CONSTANT_ENCAPSED_STRING","'id'",25],")",";",["T_WHITESPACE","\n    ",25],"}",["T_WHITESPACE","\n\n    ",26],["T_DOC_COMMENT","\/**\n     * Aggregate Coupons data by order created at\n     *\n     * @param mixed|null $from\n     * @param mixed|null $to\n     * @return $this\n     *\/",28],["T_WHITESPACE","\n    ",34],["T_PUBLIC","public",35],["T_WHITESPACE"," ",35],["T_FUNCTION","function",35],["T_WHITESPACE"," ",35],["T_STRING","aggregate",35],"(",["T_VARIABLE","$from",35],["T_WHITESPACE"," ",35],"=",["T_WHITESPACE"," ",35],["T_STRING","null",35],",",["T_WHITESPACE"," ",35],["T_VARIABLE","$to",35],["T_WHITESPACE"," ",35],"=",["T_WHITESPACE"," ",35],["T_STRING","null",35],")",["T_WHITESPACE","\n    ",35],"{",["T_WHITESPACE","\n        ",36],["T_RETURN","return",37],["T_WHITESPACE"," ",37],["T_VARIABLE","$this",37],["T_OBJECT_OPERATOR","->",37],["T_STRING","_aggregateByOrder",37],"(",["T_CONSTANT_ENCAPSED_STRING","'created_at'",37],",",["T_WHITESPACE"," ",37],["T_VARIABLE","$from",37],",",["T_WHITESPACE"," ",37],["T_VARIABLE","$to",37],")",";",["T_WHITESPACE","\n    ",37],"}",["T_WHITESPACE","\n\n    ",38],["T_DOC_COMMENT","\/**\n     * Aggregate coupons reports by orders\n     *\n     * @throws \\Exception\n     * @param string $aggregationField\n     * @param mixed $from\n     * @param mixed $to\n     * @return $this\n     * @SuppressWarnings(PHPMD.ExcessiveMethodLength)\n     *\/",40],["T_WHITESPACE","\n    ",49],["T_PROTECTED","protected",50],["T_WHITESPACE"," ",50],["T_FUNCTION","function",50],["T_WHITESPACE"," ",50],["T_STRING","_aggregateByOrder",50],"(",["T_VARIABLE","$aggregationField",50],",",["T_WHITESPACE"," ",50],["T_VARIABLE","$from",50],",",["T_WHITESPACE"," ",50],["T_VARIABLE","$to",50],")",["T_WHITESPACE","\n    ",50],"{",["T_WHITESPACE","\n        ",51],["T_VARIABLE","$table",52],["T_WHITESPACE"," ",52],"=",["T_WHITESPACE"," ",52],["T_VARIABLE","$this",52],["T_OBJECT_OPERATOR","->",52],["T_STRING","getMainTable",52],"(",")",";",["T_WHITESPACE","\n        ",52],["T_VARIABLE","$sourceTable",53],["T_WHITESPACE"," ",53],"=",["T_WHITESPACE"," ",53],["T_VARIABLE","$this",53],["T_OBJECT_OPERATOR","->",53],["T_STRING","getTable",53],"(",["T_CONSTANT_ENCAPSED_STRING","'sales_order'",53],")",";",["T_WHITESPACE","\n        ",53],["T_VARIABLE","$connection",54],["T_WHITESPACE"," ",54],"=",["T_WHITESPACE"," ",54],["T_VARIABLE","$this",54],["T_OBJECT_OPERATOR","->",54],["T_STRING","getConnection",54],"(",")",";",["T_WHITESPACE","\n        ",54],["T_VARIABLE","$salesAdapter",55],["T_WHITESPACE"," ",55],"=",["T_WHITESPACE"," ",55],["T_VARIABLE","$this",55],["T_OBJECT_OPERATOR","->",55],["T_STRING","_resources",55],["T_OBJECT_OPERATOR","->",55],["T_STRING","getConnection",55],"(",["T_CONSTANT_ENCAPSED_STRING","'sales'",55],")",";",["T_WHITESPACE","\n        ",55],["T_VARIABLE","$connection",56],["T_OBJECT_OPERATOR","->",56],["T_STRING","beginTransaction",56],"(",")",";",["T_WHITESPACE","\n\n        ",56],["T_TRY","try",58],["T_WHITESPACE"," ",58],"{",["T_WHITESPACE","\n            ",58],["T_IF","if",59],["T_WHITESPACE"," ",59],"(",["T_VARIABLE","$from",59],["T_WHITESPACE"," ",59],["T_IS_NOT_IDENTICAL","!==",59],["T_WHITESPACE"," ",59],["T_STRING","null",59],["T_WHITESPACE"," ",59],["T_BOOLEAN_OR","||",59],["T_WHITESPACE"," ",59],["T_VARIABLE","$to",59],["T_WHITESPACE"," ",59],["T_IS_NOT_IDENTICAL","!==",59],["T_WHITESPACE"," ",59],["T_STRING","null",59],")",["T_WHITESPACE"," ",59],"{",["T_WHITESPACE","\n                ",59],["T_VARIABLE","$subSelect",60],["T_WHITESPACE"," ",60],"=",["T_WHITESPACE"," ",60],["T_VARIABLE","$this",60],["T_OBJECT_OPERATOR","->",60],["T_STRING","_getTableDateRangeSelect",60],"(",["T_VARIABLE","$sourceTable",60],",",["T_WHITESPACE"," ",60],["T_CONSTANT_ENCAPSED_STRING","'created_at'",60],",",["T_WHITESPACE"," ",60],["T_CONSTANT_ENCAPSED_STRING","'updated_at'",60],",",["T_WHITESPACE"," ",60],["T_VARIABLE","$from",60],",",["T_WHITESPACE"," ",60],["T_VARIABLE","$to",60],")",";",["T_WHITESPACE","\n            ",60],"}",["T_WHITESPACE"," ",61],["T_ELSE","else",61],["T_WHITESPACE"," ",61],"{",["T_WHITESPACE","\n                ",61],["T_VARIABLE","$subSelect",62],["T_WHITESPACE"," ",62],"=",["T_WHITESPACE"," ",62],["T_STRING","null",62],";",["T_WHITESPACE","\n            ",62],"}",["T_WHITESPACE","\n\n            ",63],["T_VARIABLE","$this",65],["T_OBJECT_OPERATOR","->",65],["T_STRING","_clearTableByDateRange",65],"(",["T_VARIABLE","$table",65],",",["T_WHITESPACE"," ",65],["T_VARIABLE","$from",65],",",["T_WHITESPACE"," ",65],["T_VARIABLE","$to",65],",",["T_WHITESPACE"," ",65],["T_VARIABLE","$subSelect",65],",",["T_WHITESPACE"," ",65],["T_STRING","false",65],",",["T_WHITESPACE"," ",65],["T_VARIABLE","$salesAdapter",65],")",";",["T_WHITESPACE","\n\n            ",65],["T_COMMENT","\/\/ convert dates to current admin timezone\n",67],["T_WHITESPACE","            ",68],["T_VARIABLE","$periodExpr",68],["T_WHITESPACE"," ",68],"=",["T_WHITESPACE"," ",68],["T_VARIABLE","$connection",68],["T_OBJECT_OPERATOR","->",68],["T_STRING","getDatePartSql",68],"(",["T_WHITESPACE","\n                ",68],["T_VARIABLE","$this",69],["T_OBJECT_OPERATOR","->",69],["T_STRING","getStoreTZOffsetQuery",69],"(",["T_VARIABLE","$sourceTable",69],",",["T_WHITESPACE"," ",69],["T_VARIABLE","$aggregationField",69],",",["T_WHITESPACE"," ",69],["T_VARIABLE","$from",69],",",["T_WHITESPACE"," ",69],["T_VARIABLE","$to",69],",",["T_WHITESPACE"," ",69],["T_STRING","null",69],",",["T_WHITESPACE"," ",69],["T_VARIABLE","$salesAdapter",69],")",["T_WHITESPACE","\n            ",69],")",";",["T_WHITESPACE","\n\n            ",70],["T_VARIABLE","$columns",72],["T_WHITESPACE"," ",72],"=",["T_WHITESPACE"," ",72],"[",["T_WHITESPACE","\n                ",72],["T_CONSTANT_ENCAPSED_STRING","'period'",73],["T_WHITESPACE"," ",73],["T_DOUBLE_ARROW","=>",73],["T_WHITESPACE"," ",73],["T_VARIABLE","$periodExpr",73],",",["T_WHITESPACE","\n                ",73],["T_CONSTANT_ENCAPSED_STRING","'store_id'",74],["T_WHITESPACE"," ",74],["T_DOUBLE_ARROW","=>",74],["T_WHITESPACE"," ",74],["T_CONSTANT_ENCAPSED_STRING","'store_id'",74],",",["T_WHITESPACE","\n                ",74],["T_CONSTANT_ENCAPSED_STRING","'order_status'",75],["T_WHITESPACE"," ",75],["T_DOUBLE_ARROW","=>",75],["T_WHITESPACE"," ",75],["T_CONSTANT_ENCAPSED_STRING","'status'",75],",",["T_WHITESPACE","\n                ",75],["T_CONSTANT_ENCAPSED_STRING","'coupon_code'",76],["T_WHITESPACE"," ",76],["T_DOUBLE_ARROW","=>",76],["T_WHITESPACE"," ",76],["T_CONSTANT_ENCAPSED_STRING","'coupon_code'",76],",",["T_WHITESPACE","\n                ",76],["T_CONSTANT_ENCAPSED_STRING","'rule_name'",77],["T_WHITESPACE"," ",77],["T_DOUBLE_ARROW","=>",77],["T_WHITESPACE"," ",77],["T_CONSTANT_ENCAPSED_STRING","'coupon_rule_name'",77],",",["T_WHITESPACE","\n                ",77],["T_CONSTANT_ENCAPSED_STRING","'coupon_uses'",78],["T_WHITESPACE"," ",78],["T_DOUBLE_ARROW","=>",78],["T_WHITESPACE"," ",78],["T_CONSTANT_ENCAPSED_STRING","'COUNT(entity_id)'",78],",",["T_WHITESPACE","\n                ",78],["T_CONSTANT_ENCAPSED_STRING","'subtotal_amount'",79],["T_WHITESPACE"," ",79],["T_DOUBLE_ARROW","=>",79],["T_WHITESPACE"," ",79],["T_VARIABLE","$connection",79],["T_OBJECT_OPERATOR","->",79],["T_STRING","getIfNullSql",79],"(",["T_WHITESPACE","\n                    ",79],["T_CONSTANT_ENCAPSED_STRING","'SUM((base_subtotal - '",80],["T_WHITESPACE"," ",80],".",["T_WHITESPACE"," ",80],["T_VARIABLE","$connection",80],["T_OBJECT_OPERATOR","->",80],["T_STRING","getIfNullSql",80],"(",["T_WHITESPACE","\n                        ",80],["T_CONSTANT_ENCAPSED_STRING","'base_subtotal_canceled'",81],",",["T_WHITESPACE","\n                        ",81],["T_LNUMBER","0",82],["T_WHITESPACE","\n                    ",82],")",["T_WHITESPACE"," ",83],".",["T_WHITESPACE"," ",83],["T_CONSTANT_ENCAPSED_STRING","') * base_to_global_rate)'",83],",",["T_WHITESPACE","\n                    ",83],["T_LNUMBER","0",84],["T_WHITESPACE","\n                ",84],")",",",["T_WHITESPACE","\n                ",85],["T_CONSTANT_ENCAPSED_STRING","'discount_amount'",86],["T_WHITESPACE"," ",86],["T_DOUBLE_ARROW","=>",86],["T_WHITESPACE"," ",86],["T_VARIABLE","$connection",86],["T_OBJECT_OPERATOR","->",86],["T_STRING","getIfNullSql",86],"(",["T_WHITESPACE","\n                    ",86],["T_CONSTANT_ENCAPSED_STRING","'SUM((ABS(base_discount_amount) - '",87],["T_WHITESPACE"," ",87],".",["T_WHITESPACE"," ",87],["T_VARIABLE","$connection",87],["T_OBJECT_OPERATOR","->",87],["T_STRING","getIfNullSql",87],"(",["T_WHITESPACE","\n                        ",87],["T_CONSTANT_ENCAPSED_STRING","'base_discount_canceled'",88],",",["T_WHITESPACE","\n                        ",88],["T_LNUMBER","0",89],["T_WHITESPACE","\n                    ",89],")",["T_WHITESPACE"," ",90],".",["T_WHITESPACE"," ",90],["T_CONSTANT_ENCAPSED_STRING","') * base_to_global_rate)'",90],",",["T_WHITESPACE","\n                    ",90],["T_LNUMBER","0",91],["T_WHITESPACE","\n                ",91],")",",",["T_WHITESPACE","\n                ",92],["T_CONSTANT_ENCAPSED_STRING","'total_amount'",93],["T_WHITESPACE"," ",93],["T_DOUBLE_ARROW","=>",93],["T_WHITESPACE"," ",93],["T_VARIABLE","$connection",93],["T_OBJECT_OPERATOR","->",93],["T_STRING","getIfNullSql",93],"(",["T_WHITESPACE","\n                    ",93],["T_CONSTANT_ENCAPSED_STRING","'SUM((base_subtotal - '",94],["T_WHITESPACE"," ",94],".",["T_WHITESPACE"," ",94],["T_VARIABLE","$connection",94],["T_OBJECT_OPERATOR","->",94],["T_STRING","getIfNullSql",94],"(",["T_WHITESPACE","\n                        ",94],["T_CONSTANT_ENCAPSED_STRING","'base_subtotal_canceled'",95],",",["T_WHITESPACE","\n                        ",95],["T_LNUMBER","0",96],["T_WHITESPACE","\n                    ",96],")",["T_WHITESPACE"," ",97],".",["T_WHITESPACE"," ",97],["T_CONSTANT_ENCAPSED_STRING","' - '",97],["T_WHITESPACE"," ",97],".",["T_WHITESPACE"," ",97],["T_VARIABLE","$connection",97],["T_OBJECT_OPERATOR","->",97],["T_STRING","getIfNullSql",97],"(",["T_WHITESPACE","\n                        ",97],["T_CONSTANT_ENCAPSED_STRING","'ABS(base_discount_amount) - ABS('",98],["T_WHITESPACE"," ",98],".",["T_WHITESPACE"," ",98],["T_VARIABLE","$connection",98],["T_OBJECT_OPERATOR","->",98],["T_STRING","getIfNullSql",98],"(",["T_CONSTANT_ENCAPSED_STRING","'base_discount_canceled'",98],",",["T_WHITESPACE"," ",98],["T_LNUMBER","0",98],")",["T_WHITESPACE"," ",98],".",["T_WHITESPACE"," ",98],["T_CONSTANT_ENCAPSED_STRING","')'",98],",",["T_WHITESPACE","\n                        ",98],["T_LNUMBER","0",99],["T_WHITESPACE","\n                    ",99],")",["T_WHITESPACE"," ",100],".",["T_WHITESPACE"," ",100],["T_CONSTANT_ENCAPSED_STRING","' + '",100],["T_WHITESPACE"," ",100],".",["T_WHITESPACE"," ",100],["T_VARIABLE","$connection",100],["T_OBJECT_OPERATOR","->",100],["T_STRING","getIfNullSql",100],"(",["T_WHITESPACE","\n                        ",100],["T_CONSTANT_ENCAPSED_STRING","'base_tax_amount - '",101],["T_WHITESPACE"," ",101],".",["T_WHITESPACE"," ",101],["T_VARIABLE","$connection",101],["T_OBJECT_OPERATOR","->",101],["T_STRING","getIfNullSql",101],"(",["T_CONSTANT_ENCAPSED_STRING","'base_tax_canceled'",101],",",["T_WHITESPACE"," ",101],["T_LNUMBER","0",101],")",",",["T_WHITESPACE","\n                        ",101],["T_LNUMBER","0",102],["T_WHITESPACE","\n                    ",102],")",["T_WHITESPACE"," ",103],".",["T_WHITESPACE"," ",103],["T_CONSTANT_ENCAPSED_STRING","')\n                        * base_to_global_rate)'",103],",",["T_WHITESPACE","\n                    ",104],["T_LNUMBER","0",105],["T_WHITESPACE","\n                ",105],")",",",["T_WHITESPACE","\n                ",106],["T_CONSTANT_ENCAPSED_STRING","'subtotal_amount_actual'",107],["T_WHITESPACE"," ",107],["T_DOUBLE_ARROW","=>",107],["T_WHITESPACE"," ",107],["T_VARIABLE","$connection",107],["T_OBJECT_OPERATOR","->",107],["T_STRING","getIfNullSql",107],"(",["T_WHITESPACE","\n                    ",107],["T_CONSTANT_ENCAPSED_STRING","'SUM((base_subtotal_invoiced - '",108],["T_WHITESPACE"," ",108],".",["T_WHITESPACE"," ",108],["T_VARIABLE","$connection",108],["T_OBJECT_OPERATOR","->",108],["T_STRING","getIfNullSql",108],"(",["T_WHITESPACE","\n                        ",108],["T_CONSTANT_ENCAPSED_STRING","'base_subtotal_refunded'",109],",",["T_WHITESPACE","\n                        ",109],["T_LNUMBER","0",110],["T_WHITESPACE","\n                    ",110],")",["T_WHITESPACE"," ",111],".",["T_WHITESPACE"," ",111],["T_CONSTANT_ENCAPSED_STRING","') * base_to_global_rate)'",111],",",["T_WHITESPACE","\n                    ",111],["T_LNUMBER","0",112],["T_WHITESPACE","\n                ",112],")",",",["T_WHITESPACE","\n                ",113],["T_CONSTANT_ENCAPSED_STRING","'discount_amount_actual'",114],["T_WHITESPACE"," ",114],["T_DOUBLE_ARROW","=>",114],["T_WHITESPACE"," ",114],["T_VARIABLE","$connection",114],["T_OBJECT_OPERATOR","->",114],["T_STRING","getIfNullSql",114],"(",["T_WHITESPACE","\n                    ",114],["T_CONSTANT_ENCAPSED_STRING","'SUM((base_discount_invoiced - '",115],["T_WHITESPACE"," ",115],".",["T_WHITESPACE"," ",115],["T_VARIABLE","$connection",115],["T_OBJECT_OPERATOR","->",115],["T_STRING","getIfNullSql",115],"(",["T_WHITESPACE","\n                        ",115],["T_CONSTANT_ENCAPSED_STRING","'base_discount_refunded'",116],",",["T_WHITESPACE","\n                        ",116],["T_LNUMBER","0",117],["T_WHITESPACE","\n                    ",117],")",["T_WHITESPACE"," ",118],".",["T_WHITESPACE"," ",118],["T_CONSTANT_ENCAPSED_STRING","')\n                        * base_to_global_rate)'",118],",",["T_WHITESPACE","\n                    ",119],["T_LNUMBER","0",120],["T_WHITESPACE","\n                ",120],")",",",["T_WHITESPACE","\n                ",121],["T_CONSTANT_ENCAPSED_STRING","'total_amount_actual'",122],["T_WHITESPACE"," ",122],["T_DOUBLE_ARROW","=>",122],["T_WHITESPACE"," ",122],["T_VARIABLE","$connection",122],["T_OBJECT_OPERATOR","->",122],["T_STRING","getIfNullSql",122],"(",["T_WHITESPACE","\n                    ",122],["T_CONSTANT_ENCAPSED_STRING","'SUM((base_subtotal_invoiced - '",123],["T_WHITESPACE"," ",123],".",["T_WHITESPACE"," ",123],["T_VARIABLE","$connection",123],["T_OBJECT_OPERATOR","->",123],["T_STRING","getIfNullSql",123],"(",["T_WHITESPACE","\n                        ",123],["T_CONSTANT_ENCAPSED_STRING","'base_subtotal_refunded'",124],",",["T_WHITESPACE","\n                        ",124],["T_LNUMBER","0",125],["T_WHITESPACE","\n                    ",125],")",["T_WHITESPACE"," ",126],".",["T_WHITESPACE"," ",126],["T_CONSTANT_ENCAPSED_STRING","' - '",126],["T_WHITESPACE"," ",126],".",["T_WHITESPACE"," ",126],["T_VARIABLE","$connection",126],["T_OBJECT_OPERATOR","->",126],["T_STRING","getIfNullSql",126],"(",["T_WHITESPACE","\n                        ",126],["T_CONSTANT_ENCAPSED_STRING","'ABS(base_discount_invoiced) - ABS('",127],["T_WHITESPACE"," ",127],".",["T_WHITESPACE"," ",127],["T_VARIABLE","$connection",127],["T_OBJECT_OPERATOR","->",127],["T_STRING","getIfNullSql",127],"(",["T_CONSTANT_ENCAPSED_STRING","'base_discount_refunded'",127],",",["T_WHITESPACE"," ",127],["T_LNUMBER","0",127],")",["T_WHITESPACE"," ",127],".",["T_WHITESPACE"," ",127],["T_CONSTANT_ENCAPSED_STRING","')'",127],",",["T_WHITESPACE","\n                        ",127],["T_LNUMBER","0",128],["T_WHITESPACE","\n                    ",128],")",["T_WHITESPACE"," ",129],".",["T_WHITESPACE"," ",129],["T_CONSTANT_ENCAPSED_STRING","' + '",129],["T_WHITESPACE"," ",129],".",["T_WHITESPACE"," ",129],["T_VARIABLE","$connection",129],["T_OBJECT_OPERATOR","->",129],["T_STRING","getIfNullSql",129],"(",["T_WHITESPACE","\n                        ",129],["T_CONSTANT_ENCAPSED_STRING","'base_tax_invoiced - '",130],["T_WHITESPACE"," ",130],".",["T_WHITESPACE"," ",130],["T_VARIABLE","$connection",130],["T_OBJECT_OPERATOR","->",130],["T_STRING","getIfNullSql",130],"(",["T_CONSTANT_ENCAPSED_STRING","'base_tax_refunded'",130],",",["T_WHITESPACE"," ",130],["T_LNUMBER","0",130],")",",",["T_WHITESPACE","\n                        ",130],["T_LNUMBER","0",131],["T_WHITESPACE","\n                    ",131],")",["T_WHITESPACE","   ",132],".",["T_WHITESPACE"," ",132],["T_CONSTANT_ENCAPSED_STRING","') * base_to_global_rate)'",132],",",["T_WHITESPACE","\n                    ",132],["T_LNUMBER","0",133],["T_WHITESPACE","\n                ",133],")",",",["T_WHITESPACE","\n            ",134],"]",";",["T_WHITESPACE","\n\n            ",135],["T_VARIABLE","$select",137],["T_WHITESPACE"," ",137],"=",["T_WHITESPACE"," ",137],["T_VARIABLE","$connection",137],["T_OBJECT_OPERATOR","->",137],["T_STRING","select",137],"(",")",";",["T_WHITESPACE","\n            ",137],["T_VARIABLE","$select",138],["T_OBJECT_OPERATOR","->",138],["T_STRING","from",138],"(","[",["T_CONSTANT_ENCAPSED_STRING","'source_table'",138],["T_WHITESPACE"," ",138],["T_DOUBLE_ARROW","=>",138],["T_WHITESPACE"," ",138],["T_VARIABLE","$sourceTable",138],"]",",",["T_WHITESPACE"," ",138],["T_VARIABLE","$columns",138],")",["T_OBJECT_OPERATOR","->",138],["T_STRING","where",138],"(",["T_CONSTANT_ENCAPSED_STRING","'coupon_code IS NOT NULL'",138],")",";",["T_WHITESPACE","\n\n            ",138],["T_IF","if",140],["T_WHITESPACE"," ",140],"(",["T_VARIABLE","$subSelect",140],["T_WHITESPACE"," ",140],["T_IS_NOT_IDENTICAL","!==",140],["T_WHITESPACE"," ",140],["T_STRING","null",140],")",["T_WHITESPACE"," ",140],"{",["T_WHITESPACE","\n                ",140],["T_VARIABLE","$select",141],["T_OBJECT_OPERATOR","->",141],["T_STRING","having",141],"(",["T_VARIABLE","$this",141],["T_OBJECT_OPERATOR","->",141],["T_STRING","_makeConditionFromDateRangeSelect",141],"(",["T_VARIABLE","$subSelect",141],",",["T_WHITESPACE"," ",141],["T_CONSTANT_ENCAPSED_STRING","'period'",141],",",["T_WHITESPACE"," ",141],["T_VARIABLE","$salesAdapter",141],")",")",";",["T_WHITESPACE","\n            ",141],"}",["T_WHITESPACE","\n\n            ",142],["T_VARIABLE","$select",144],["T_OBJECT_OPERATOR","->",144],["T_STRING","group",144],"(","[",["T_VARIABLE","$periodExpr",144],",",["T_WHITESPACE"," ",144],["T_CONSTANT_ENCAPSED_STRING","'store_id'",144],",",["T_WHITESPACE"," ",144],["T_CONSTANT_ENCAPSED_STRING","'status'",144],",",["T_WHITESPACE"," ",144],["T_CONSTANT_ENCAPSED_STRING","'coupon_code'",144],"]",")",";",["T_WHITESPACE","\n\n            ",144],["T_VARIABLE","$select",146],["T_OBJECT_OPERATOR","->",146],["T_STRING","having",146],"(",["T_CONSTANT_ENCAPSED_STRING","'COUNT(entity_id) > 0'",146],")",";",["T_WHITESPACE","\n\n            ",146],["T_VARIABLE","$aggregatedData",148],["T_WHITESPACE"," ",148],"=",["T_WHITESPACE"," ",148],["T_VARIABLE","$salesAdapter",148],["T_OBJECT_OPERATOR","->",148],["T_STRING","fetchAll",148],"(",["T_VARIABLE","$select",148],")",";",["T_WHITESPACE","\n\n            ",148],["T_IF","if",150],["T_WHITESPACE"," ",150],"(",["T_VARIABLE","$aggregatedData",150],")",["T_WHITESPACE"," ",150],"{",["T_WHITESPACE","\n                ",150],["T_VARIABLE","$connection",151],["T_OBJECT_OPERATOR","->",151],["T_STRING","insertOnDuplicate",151],"(",["T_VARIABLE","$table",151],",",["T_WHITESPACE"," ",151],["T_VARIABLE","$aggregatedData",151],",",["T_WHITESPACE"," ",151],["T_STRING","array_keys",151],"(",["T_VARIABLE","$columns",151],")",")",";",["T_WHITESPACE","\n            ",151],"}",["T_WHITESPACE","\n\n            ",152],["T_VARIABLE","$select",154],["T_OBJECT_OPERATOR","->",154],["T_STRING","reset",154],"(",")",";",["T_WHITESPACE","\n\n            ",154],["T_VARIABLE","$columns",156],["T_WHITESPACE"," ",156],"=",["T_WHITESPACE"," ",156],"[",["T_WHITESPACE","\n                ",156],["T_CONSTANT_ENCAPSED_STRING","'period'",157],["T_WHITESPACE"," ",157],["T_DOUBLE_ARROW","=>",157],["T_WHITESPACE"," ",157],["T_CONSTANT_ENCAPSED_STRING","'period'",157],",",["T_WHITESPACE","\n                ",157],["T_CONSTANT_ENCAPSED_STRING","'store_id'",158],["T_WHITESPACE"," ",158],["T_DOUBLE_ARROW","=>",158],["T_WHITESPACE"," ",158],["T_NEW","new",158],["T_WHITESPACE"," ",158],["T_NS_SEPARATOR","\\",158],["T_STRING","Zend_Db_Expr",158],"(",["T_CONSTANT_ENCAPSED_STRING","'0'",158],")",",",["T_WHITESPACE","\n                ",158],["T_CONSTANT_ENCAPSED_STRING","'order_status'",159],["T_WHITESPACE"," ",159],["T_DOUBLE_ARROW","=>",159],["T_WHITESPACE"," ",159],["T_CONSTANT_ENCAPSED_STRING","'order_status'",159],",",["T_WHITESPACE","\n                ",159],["T_CONSTANT_ENCAPSED_STRING","'coupon_code'",160],["T_WHITESPACE"," ",160],["T_DOUBLE_ARROW","=>",160],["T_WHITESPACE"," ",160],["T_CONSTANT_ENCAPSED_STRING","'coupon_code'",160],",",["T_WHITESPACE","\n                ",160],["T_CONSTANT_ENCAPSED_STRING","'rule_name'",161],["T_WHITESPACE"," ",161],["T_DOUBLE_ARROW","=>",161],["T_WHITESPACE"," ",161],["T_CONSTANT_ENCAPSED_STRING","'rule_name'",161],",",["T_WHITESPACE","\n                ",161],["T_CONSTANT_ENCAPSED_STRING","'coupon_uses'",162],["T_WHITESPACE"," ",162],["T_DOUBLE_ARROW","=>",162],["T_WHITESPACE"," ",162],["T_CONSTANT_ENCAPSED_STRING","'SUM(coupon_uses)'",162],",",["T_WHITESPACE","\n                ",162],["T_CONSTANT_ENCAPSED_STRING","'subtotal_amount'",163],["T_WHITESPACE"," ",163],["T_DOUBLE_ARROW","=>",163],["T_WHITESPACE"," ",163],["T_CONSTANT_ENCAPSED_STRING","'SUM(subtotal_amount)'",163],",",["T_WHITESPACE","\n                ",163],["T_CONSTANT_ENCAPSED_STRING","'discount_amount'",164],["T_WHITESPACE"," ",164],["T_DOUBLE_ARROW","=>",164],["T_WHITESPACE"," ",164],["T_CONSTANT_ENCAPSED_STRING","'SUM(discount_amount)'",164],",",["T_WHITESPACE","\n                ",164],["T_CONSTANT_ENCAPSED_STRING","'total_amount'",165],["T_WHITESPACE"," ",165],["T_DOUBLE_ARROW","=>",165],["T_WHITESPACE"," ",165],["T_CONSTANT_ENCAPSED_STRING","'SUM(total_amount)'",165],",",["T_WHITESPACE","\n                ",165],["T_CONSTANT_ENCAPSED_STRING","'subtotal_amount_actual'",166],["T_WHITESPACE"," ",166],["T_DOUBLE_ARROW","=>",166],["T_WHITESPACE"," ",166],["T_CONSTANT_ENCAPSED_STRING","'SUM(subtotal_amount_actual)'",166],",",["T_WHITESPACE","\n                ",166],["T_CONSTANT_ENCAPSED_STRING","'discount_amount_actual'",167],["T_WHITESPACE"," ",167],["T_DOUBLE_ARROW","=>",167],["T_WHITESPACE"," ",167],["T_CONSTANT_ENCAPSED_STRING","'SUM(discount_amount_actual)'",167],",",["T_WHITESPACE","\n                ",167],["T_CONSTANT_ENCAPSED_STRING","'total_amount_actual'",168],["T_WHITESPACE"," ",168],["T_DOUBLE_ARROW","=>",168],["T_WHITESPACE"," ",168],["T_CONSTANT_ENCAPSED_STRING","'SUM(total_amount_actual)'",168],",",["T_WHITESPACE","\n            ",168],"]",";",["T_WHITESPACE","\n\n            ",169],["T_VARIABLE","$select",171],["T_OBJECT_OPERATOR","->",171],["T_STRING","from",171],"(",["T_VARIABLE","$table",171],",",["T_WHITESPACE"," ",171],["T_VARIABLE","$columns",171],")",["T_OBJECT_OPERATOR","->",171],["T_STRING","where",171],"(",["T_CONSTANT_ENCAPSED_STRING","'store_id <> 0'",171],")",";",["T_WHITESPACE","\n\n            ",171],["T_IF","if",173],["T_WHITESPACE"," ",173],"(",["T_VARIABLE","$subSelect",173],["T_WHITESPACE"," ",173],["T_IS_NOT_IDENTICAL","!==",173],["T_WHITESPACE"," ",173],["T_STRING","null",173],")",["T_WHITESPACE"," ",173],"{",["T_WHITESPACE","\n                ",173],["T_VARIABLE","$select",174],["T_OBJECT_OPERATOR","->",174],["T_STRING","where",174],"(",["T_VARIABLE","$this",174],["T_OBJECT_OPERATOR","->",174],["T_STRING","_makeConditionFromDateRangeSelect",174],"(",["T_VARIABLE","$subSelect",174],",",["T_WHITESPACE"," ",174],["T_CONSTANT_ENCAPSED_STRING","'period'",174],",",["T_WHITESPACE"," ",174],["T_VARIABLE","$salesAdapter",174],")",")",";",["T_WHITESPACE","\n            ",174],"}",["T_WHITESPACE","\n\n            ",175],["T_VARIABLE","$select",177],["T_OBJECT_OPERATOR","->",177],["T_STRING","group",177],"(","[",["T_CONSTANT_ENCAPSED_STRING","'period'",177],",",["T_WHITESPACE"," ",177],["T_CONSTANT_ENCAPSED_STRING","'order_status'",177],",",["T_WHITESPACE"," ",177],["T_CONSTANT_ENCAPSED_STRING","'coupon_code'",177],"]",")",";",["T_WHITESPACE","\n\n            ",177],["T_VARIABLE","$connection",179],["T_OBJECT_OPERATOR","->",179],["T_STRING","query",179],"(",["T_VARIABLE","$select",179],["T_OBJECT_OPERATOR","->",179],["T_STRING","insertFromSelect",179],"(",["T_VARIABLE","$table",179],",",["T_WHITESPACE"," ",179],["T_STRING","array_keys",179],"(",["T_VARIABLE","$columns",179],")",")",")",";",["T_WHITESPACE","\n            ",179],["T_VARIABLE","$connection",180],["T_OBJECT_OPERATOR","->",180],["T_STRING","commit",180],"(",")",";",["T_WHITESPACE","\n        ",180],"}",["T_WHITESPACE"," ",181],["T_CATCH","catch",181],["T_WHITESPACE"," ",181],"(",["T_NS_SEPARATOR","\\",181],["T_STRING","Exception",181],["T_WHITESPACE"," ",181],["T_VARIABLE","$e",181],")",["T_WHITESPACE"," ",181],"{",["T_WHITESPACE","\n            ",181],["T_VARIABLE","$connection",182],["T_OBJECT_OPERATOR","->",182],["T_STRING","rollBack",182],"(",")",";",["T_WHITESPACE","\n            ",182],["T_THROW","throw",183],["T_WHITESPACE"," ",183],["T_VARIABLE","$e",183],";",["T_WHITESPACE","\n        ",183],"}",["T_WHITESPACE","\n\n        ",184],["T_RETURN","return",186],["T_WHITESPACE"," ",186],["T_VARIABLE","$this",186],";",["T_WHITESPACE","\n    ",186],"}",["T_WHITESPACE","\n",187],"}",["T_WHITESPACE","\n",188]]