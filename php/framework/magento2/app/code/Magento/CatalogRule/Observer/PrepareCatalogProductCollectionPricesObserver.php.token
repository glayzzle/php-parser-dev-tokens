[["T_OPEN_TAG","<?php\n",1],["T_DOC_COMMENT","\/**\n * Copyright \u00c2\u00a9 2013-2017 Magento, Inc. All rights reserved.\n * See COPYING.txt for license details.\n *\/",2],["T_WHITESPACE","\n\n",5],["T_DOC_COMMENT","\/**\n * Catalog Price rules observer model\n *\/",7],["T_WHITESPACE","\n",9],["T_NAMESPACE","namespace",10],["T_WHITESPACE"," ",10],["T_STRING","Magento",10],["T_NS_SEPARATOR","\\",10],["T_STRING","CatalogRule",10],["T_NS_SEPARATOR","\\",10],["T_STRING","Observer",10],";",["T_WHITESPACE","\n\n",10],["T_USE","use",12],["T_WHITESPACE"," ",12],["T_STRING","Magento",12],["T_NS_SEPARATOR","\\",12],["T_STRING","Catalog",12],["T_NS_SEPARATOR","\\",12],["T_STRING","Model",12],["T_NS_SEPARATOR","\\",12],["T_STRING","Product",12],";",["T_WHITESPACE","\n",12],["T_USE","use",13],["T_WHITESPACE"," ",13],["T_STRING","Magento",13],["T_NS_SEPARATOR","\\",13],["T_STRING","CatalogRule",13],["T_NS_SEPARATOR","\\",13],["T_STRING","Model",13],["T_NS_SEPARATOR","\\",13],["T_STRING","Rule",13],";",["T_WHITESPACE","\n",13],["T_USE","use",14],["T_WHITESPACE"," ",14],["T_STRING","Magento",14],["T_NS_SEPARATOR","\\",14],["T_STRING","Store",14],["T_NS_SEPARATOR","\\",14],["T_STRING","Model",14],["T_NS_SEPARATOR","\\",14],["T_STRING","StoreManagerInterface",14],";",["T_WHITESPACE","\n",14],["T_USE","use",15],["T_WHITESPACE"," ",15],["T_STRING","Magento",15],["T_NS_SEPARATOR","\\",15],["T_STRING","Framework",15],["T_NS_SEPARATOR","\\",15],["T_STRING","Stdlib",15],["T_NS_SEPARATOR","\\",15],["T_STRING","DateTime",15],["T_NS_SEPARATOR","\\",15],["T_STRING","TimezoneInterface",15],";",["T_WHITESPACE","\n",15],["T_USE","use",16],["T_WHITESPACE"," ",16],["T_STRING","Magento",16],["T_NS_SEPARATOR","\\",16],["T_STRING","Customer",16],["T_NS_SEPARATOR","\\",16],["T_STRING","Model",16],["T_NS_SEPARATOR","\\",16],["T_STRING","Session",16],["T_WHITESPACE"," ",16],["T_AS","as",16],["T_WHITESPACE"," ",16],["T_STRING","CustomerModelSession",16],";",["T_WHITESPACE","\n",16],["T_USE","use",17],["T_WHITESPACE"," ",17],["T_STRING","Magento",17],["T_NS_SEPARATOR","\\",17],["T_STRING","Framework",17],["T_NS_SEPARATOR","\\",17],["T_STRING","Event",17],["T_NS_SEPARATOR","\\",17],["T_STRING","Observer",17],["T_WHITESPACE"," ",17],["T_AS","as",17],["T_WHITESPACE"," ",17],["T_STRING","EventObserver",17],";",["T_WHITESPACE","\n",17],["T_USE","use",18],["T_WHITESPACE"," ",18],["T_STRING","Magento",18],["T_NS_SEPARATOR","\\",18],["T_STRING","Customer",18],["T_NS_SEPARATOR","\\",18],["T_STRING","Api",18],["T_NS_SEPARATOR","\\",18],["T_STRING","GroupManagementInterface",18],";",["T_WHITESPACE","\n",18],["T_USE","use",19],["T_WHITESPACE"," ",19],["T_STRING","Magento",19],["T_NS_SEPARATOR","\\",19],["T_STRING","Framework",19],["T_NS_SEPARATOR","\\",19],["T_STRING","Event",19],["T_NS_SEPARATOR","\\",19],["T_STRING","ObserverInterface",19],";",["T_WHITESPACE","\n\n",19],["T_DOC_COMMENT","\/**\n * @SuppressWarnings(PHPMD.CouplingBetweenObjects)\n *\/",21],["T_WHITESPACE","\n",23],["T_CLASS","class",24],["T_WHITESPACE"," ",24],["T_STRING","PrepareCatalogProductCollectionPricesObserver",24],["T_WHITESPACE"," ",24],["T_IMPLEMENTS","implements",24],["T_WHITESPACE"," ",24],["T_STRING","ObserverInterface",24],["T_WHITESPACE","\n",24],"{",["T_WHITESPACE","\n    ",25],["T_DOC_COMMENT","\/**\n     * @var CustomerModelSession\n     *\/",26],["T_WHITESPACE","\n    ",28],["T_PROTECTED","protected",29],["T_WHITESPACE"," ",29],["T_VARIABLE","$customerSession",29],";",["T_WHITESPACE","\n\n    ",29],["T_DOC_COMMENT","\/**\n     * @var StoreManagerInterface\n     *\/",31],["T_WHITESPACE","\n    ",33],["T_PROTECTED","protected",34],["T_WHITESPACE"," ",34],["T_VARIABLE","$storeManager",34],";",["T_WHITESPACE","\n\n    ",34],["T_DOC_COMMENT","\/**\n     * @var \\Magento\\Framework\\Stdlib\\DateTime\\TimezoneInterface\n     *\/",36],["T_WHITESPACE","\n    ",38],["T_PROTECTED","protected",39],["T_WHITESPACE"," ",39],["T_VARIABLE","$localeDate",39],";",["T_WHITESPACE","\n\n    ",39],["T_DOC_COMMENT","\/**\n     * @var \\Magento\\CatalogRule\\Model\\ResourceModel\\RuleFactory\n     *\/",41],["T_WHITESPACE","\n    ",43],["T_PROTECTED","protected",44],["T_WHITESPACE"," ",44],["T_VARIABLE","$resourceRuleFactory",44],";",["T_WHITESPACE","\n\n    ",44],["T_DOC_COMMENT","\/** @var RulePricesStorage  *\/",46],["T_WHITESPACE","\n    ",46],["T_PROTECTED","protected",47],["T_WHITESPACE"," ",47],["T_VARIABLE","$rulePricesStorage",47],";",["T_WHITESPACE","\n\n    ",47],["T_DOC_COMMENT","\/**\n     * @var GroupManagementInterface\n     *\/",49],["T_WHITESPACE","\n    ",51],["T_PROTECTED","protected",52],["T_WHITESPACE"," ",52],["T_VARIABLE","$groupManagement",52],";",["T_WHITESPACE","\n\n    ",52],["T_DOC_COMMENT","\/**\n     * @param RulePricesStorage $rulePricesStorage\n     * @param \\Magento\\CatalogRule\\Model\\ResourceModel\\RuleFactory $resourceRuleFactory\n     * @param StoreManagerInterface $storeManager\n     * @param TimezoneInterface $localeDate\n     * @param CustomerModelSession $customerSession\n     * @param GroupManagementInterface $groupManagement\n     *\/",54],["T_WHITESPACE","\n    ",61],["T_PUBLIC","public",62],["T_WHITESPACE"," ",62],["T_FUNCTION","function",62],["T_WHITESPACE"," ",62],["T_STRING","__construct",62],"(",["T_WHITESPACE","\n        ",62],["T_STRING","RulePricesStorage",63],["T_WHITESPACE"," ",63],["T_VARIABLE","$rulePricesStorage",63],",",["T_WHITESPACE","\n        ",63],["T_NS_SEPARATOR","\\",64],["T_STRING","Magento",64],["T_NS_SEPARATOR","\\",64],["T_STRING","CatalogRule",64],["T_NS_SEPARATOR","\\",64],["T_STRING","Model",64],["T_NS_SEPARATOR","\\",64],["T_STRING","ResourceModel",64],["T_NS_SEPARATOR","\\",64],["T_STRING","RuleFactory",64],["T_WHITESPACE"," ",64],["T_VARIABLE","$resourceRuleFactory",64],",",["T_WHITESPACE","\n        ",64],["T_STRING","StoreManagerInterface",65],["T_WHITESPACE"," ",65],["T_VARIABLE","$storeManager",65],",",["T_WHITESPACE","\n        ",65],["T_STRING","TimezoneInterface",66],["T_WHITESPACE"," ",66],["T_VARIABLE","$localeDate",66],",",["T_WHITESPACE","\n        ",66],["T_STRING","CustomerModelSession",67],["T_WHITESPACE"," ",67],["T_VARIABLE","$customerSession",67],",",["T_WHITESPACE","\n        ",67],["T_STRING","GroupManagementInterface",68],["T_WHITESPACE"," ",68],["T_VARIABLE","$groupManagement",68],["T_WHITESPACE","\n    ",68],")",["T_WHITESPACE"," ",69],"{",["T_WHITESPACE","\n        ",69],["T_VARIABLE","$this",70],["T_OBJECT_OPERATOR","->",70],["T_STRING","rulePricesStorage",70],["T_WHITESPACE"," ",70],"=",["T_WHITESPACE"," ",70],["T_VARIABLE","$rulePricesStorage",70],";",["T_WHITESPACE","\n        ",70],["T_VARIABLE","$this",71],["T_OBJECT_OPERATOR","->",71],["T_STRING","resourceRuleFactory",71],["T_WHITESPACE"," ",71],"=",["T_WHITESPACE"," ",71],["T_VARIABLE","$resourceRuleFactory",71],";",["T_WHITESPACE","\n        ",71],["T_VARIABLE","$this",72],["T_OBJECT_OPERATOR","->",72],["T_STRING","storeManager",72],["T_WHITESPACE"," ",72],"=",["T_WHITESPACE"," ",72],["T_VARIABLE","$storeManager",72],";",["T_WHITESPACE","\n        ",72],["T_VARIABLE","$this",73],["T_OBJECT_OPERATOR","->",73],["T_STRING","localeDate",73],["T_WHITESPACE"," ",73],"=",["T_WHITESPACE"," ",73],["T_VARIABLE","$localeDate",73],";",["T_WHITESPACE","\n        ",73],["T_VARIABLE","$this",74],["T_OBJECT_OPERATOR","->",74],["T_STRING","customerSession",74],["T_WHITESPACE"," ",74],"=",["T_WHITESPACE"," ",74],["T_VARIABLE","$customerSession",74],";",["T_WHITESPACE","\n        ",74],["T_VARIABLE","$this",75],["T_OBJECT_OPERATOR","->",75],["T_STRING","groupManagement",75],["T_WHITESPACE"," ",75],"=",["T_WHITESPACE"," ",75],["T_VARIABLE","$groupManagement",75],";",["T_WHITESPACE","\n    ",75],"}",["T_WHITESPACE","\n\n    ",76],["T_DOC_COMMENT","\/**\n     * Apply catalog price rules to product on frontend\n     *\n     * @param \\Magento\\Framework\\Event\\Observer $observer\n     * @return $this\n     *\/",78],["T_WHITESPACE","\n    ",83],["T_PUBLIC","public",84],["T_WHITESPACE"," ",84],["T_FUNCTION","function",84],["T_WHITESPACE"," ",84],["T_STRING","execute",84],"(",["T_NS_SEPARATOR","\\",84],["T_STRING","Magento",84],["T_NS_SEPARATOR","\\",84],["T_STRING","Framework",84],["T_NS_SEPARATOR","\\",84],["T_STRING","Event",84],["T_NS_SEPARATOR","\\",84],["T_STRING","Observer",84],["T_WHITESPACE"," ",84],["T_VARIABLE","$observer",84],")",["T_WHITESPACE","\n    ",84],"{",["T_WHITESPACE","\n        ",85],["T_COMMENT","\/* @var $collection ProductCollection *\/",86],["T_WHITESPACE","\n        ",86],["T_VARIABLE","$collection",87],["T_WHITESPACE"," ",87],"=",["T_WHITESPACE"," ",87],["T_VARIABLE","$observer",87],["T_OBJECT_OPERATOR","->",87],["T_STRING","getEvent",87],"(",")",["T_OBJECT_OPERATOR","->",87],["T_STRING","getCollection",87],"(",")",";",["T_WHITESPACE","\n        ",87],["T_VARIABLE","$store",88],["T_WHITESPACE"," ",88],"=",["T_WHITESPACE"," ",88],["T_VARIABLE","$this",88],["T_OBJECT_OPERATOR","->",88],["T_STRING","storeManager",88],["T_OBJECT_OPERATOR","->",88],["T_STRING","getStore",88],"(",["T_VARIABLE","$observer",88],["T_OBJECT_OPERATOR","->",88],["T_STRING","getEvent",88],"(",")",["T_OBJECT_OPERATOR","->",88],["T_STRING","getStoreId",88],"(",")",")",";",["T_WHITESPACE","\n        ",88],["T_VARIABLE","$websiteId",89],["T_WHITESPACE"," ",89],"=",["T_WHITESPACE"," ",89],["T_VARIABLE","$store",89],["T_OBJECT_OPERATOR","->",89],["T_STRING","getWebsiteId",89],"(",")",";",["T_WHITESPACE","\n        ",89],["T_IF","if",90],["T_WHITESPACE"," ",90],"(",["T_VARIABLE","$observer",90],["T_OBJECT_OPERATOR","->",90],["T_STRING","getEvent",90],"(",")",["T_OBJECT_OPERATOR","->",90],["T_STRING","hasCustomerGroupId",90],"(",")",")",["T_WHITESPACE"," ",90],"{",["T_WHITESPACE","\n            ",90],["T_VARIABLE","$groupId",91],["T_WHITESPACE"," ",91],"=",["T_WHITESPACE"," ",91],["T_VARIABLE","$observer",91],["T_OBJECT_OPERATOR","->",91],["T_STRING","getEvent",91],"(",")",["T_OBJECT_OPERATOR","->",91],["T_STRING","getCustomerGroupId",91],"(",")",";",["T_WHITESPACE","\n        ",91],"}",["T_WHITESPACE"," ",92],["T_ELSE","else",92],["T_WHITESPACE"," ",92],"{",["T_WHITESPACE","\n            ",92],["T_IF","if",93],["T_WHITESPACE"," ",93],"(",["T_VARIABLE","$this",93],["T_OBJECT_OPERATOR","->",93],["T_STRING","customerSession",93],["T_OBJECT_OPERATOR","->",93],["T_STRING","isLoggedIn",93],"(",")",")",["T_WHITESPACE"," ",93],"{",["T_WHITESPACE","\n                ",93],["T_VARIABLE","$groupId",94],["T_WHITESPACE"," ",94],"=",["T_WHITESPACE"," ",94],["T_VARIABLE","$this",94],["T_OBJECT_OPERATOR","->",94],["T_STRING","customerSession",94],["T_OBJECT_OPERATOR","->",94],["T_STRING","getCustomerGroupId",94],"(",")",";",["T_WHITESPACE","\n            ",94],"}",["T_WHITESPACE"," ",95],["T_ELSE","else",95],["T_WHITESPACE"," ",95],"{",["T_WHITESPACE","\n                ",95],["T_VARIABLE","$groupId",96],["T_WHITESPACE"," ",96],"=",["T_WHITESPACE"," ",96],["T_VARIABLE","$this",96],["T_OBJECT_OPERATOR","->",96],["T_STRING","groupManagement",96],["T_OBJECT_OPERATOR","->",96],["T_STRING","getNotLoggedInGroup",96],"(",")",["T_OBJECT_OPERATOR","->",96],["T_STRING","getId",96],"(",")",";",["T_WHITESPACE","\n            ",96],"}",["T_WHITESPACE","\n        ",97],"}",["T_WHITESPACE","\n        ",98],["T_IF","if",99],["T_WHITESPACE"," ",99],"(",["T_VARIABLE","$observer",99],["T_OBJECT_OPERATOR","->",99],["T_STRING","getEvent",99],"(",")",["T_OBJECT_OPERATOR","->",99],["T_STRING","hasDate",99],"(",")",")",["T_WHITESPACE"," ",99],"{",["T_WHITESPACE","\n            ",99],["T_VARIABLE","$date",100],["T_WHITESPACE"," ",100],"=",["T_WHITESPACE"," ",100],["T_NEW","new",100],["T_WHITESPACE"," ",100],["T_NS_SEPARATOR","\\",100],["T_STRING","DateTime",100],"(",["T_VARIABLE","$observer",100],["T_OBJECT_OPERATOR","->",100],["T_STRING","getEvent",100],"(",")",["T_OBJECT_OPERATOR","->",100],["T_STRING","getDate",100],"(",")",")",";",["T_WHITESPACE","\n        ",100],"}",["T_WHITESPACE"," ",101],["T_ELSE","else",101],["T_WHITESPACE"," ",101],"{",["T_WHITESPACE","\n            ",101],["T_VARIABLE","$date",102],["T_WHITESPACE"," ",102],"=",["T_WHITESPACE"," ",102],"(",["T_NEW","new",102],["T_WHITESPACE"," ",102],["T_NS_SEPARATOR","\\",102],["T_STRING","DateTime",102],"(",")",")",["T_OBJECT_OPERATOR","->",102],["T_STRING","setTimestamp",102],"(",["T_VARIABLE","$this",102],["T_OBJECT_OPERATOR","->",102],["T_STRING","localeDate",102],["T_OBJECT_OPERATOR","->",102],["T_STRING","scopeTimeStamp",102],"(",["T_VARIABLE","$store",102],")",")",";",["T_WHITESPACE","\n        ",102],"}",["T_WHITESPACE","\n\n        ",103],["T_VARIABLE","$productIds",105],["T_WHITESPACE"," ",105],"=",["T_WHITESPACE"," ",105],"[","]",";",["T_WHITESPACE","\n        ",105],["T_COMMENT","\/* @var $product Product *\/",106],["T_WHITESPACE","\n        ",106],["T_FOREACH","foreach",107],["T_WHITESPACE"," ",107],"(",["T_VARIABLE","$collection",107],["T_WHITESPACE"," ",107],["T_AS","as",107],["T_WHITESPACE"," ",107],["T_VARIABLE","$product",107],")",["T_WHITESPACE"," ",107],"{",["T_WHITESPACE","\n            ",107],["T_VARIABLE","$key",108],["T_WHITESPACE"," ",108],"=",["T_WHITESPACE"," ",108],["T_STRING","implode",108],"(",["T_CONSTANT_ENCAPSED_STRING","'|'",108],",",["T_WHITESPACE"," ",108],"[",["T_VARIABLE","$date",108],["T_OBJECT_OPERATOR","->",108],["T_STRING","format",108],"(",["T_CONSTANT_ENCAPSED_STRING","'Y-m-d H:i:s'",108],")",",",["T_WHITESPACE"," ",108],["T_VARIABLE","$websiteId",108],",",["T_WHITESPACE"," ",108],["T_VARIABLE","$groupId",108],",",["T_WHITESPACE"," ",108],["T_VARIABLE","$product",108],["T_OBJECT_OPERATOR","->",108],["T_STRING","getId",108],"(",")","]",")",";",["T_WHITESPACE","\n            ",108],["T_IF","if",109],["T_WHITESPACE"," ",109],"(","!",["T_VARIABLE","$this",109],["T_OBJECT_OPERATOR","->",109],["T_STRING","rulePricesStorage",109],["T_OBJECT_OPERATOR","->",109],["T_STRING","hasRulePrice",109],"(",["T_VARIABLE","$key",109],")",")",["T_WHITESPACE"," ",109],"{",["T_WHITESPACE","\n                ",109],["T_VARIABLE","$productIds",110],"[","]",["T_WHITESPACE"," ",110],"=",["T_WHITESPACE"," ",110],["T_VARIABLE","$product",110],["T_OBJECT_OPERATOR","->",110],["T_STRING","getId",110],"(",")",";",["T_WHITESPACE","\n            ",110],"}",["T_WHITESPACE","\n        ",111],"}",["T_WHITESPACE","\n\n        ",112],["T_IF","if",114],["T_WHITESPACE"," ",114],"(",["T_VARIABLE","$productIds",114],")",["T_WHITESPACE"," ",114],"{",["T_WHITESPACE","\n            ",114],["T_VARIABLE","$rulePrices",115],["T_WHITESPACE"," ",115],"=",["T_WHITESPACE"," ",115],["T_VARIABLE","$this",115],["T_OBJECT_OPERATOR","->",115],["T_STRING","resourceRuleFactory",115],["T_OBJECT_OPERATOR","->",115],["T_STRING","create",115],"(",")",["T_OBJECT_OPERATOR","->",115],["T_STRING","getRulePrices",115],"(",["T_WHITESPACE","\n                ",115],["T_VARIABLE","$date",116],",",["T_WHITESPACE","\n                ",116],["T_VARIABLE","$websiteId",117],",",["T_WHITESPACE","\n                ",117],["T_VARIABLE","$groupId",118],",",["T_WHITESPACE","\n                ",118],["T_VARIABLE","$productIds",119],["T_WHITESPACE","\n            ",119],")",";",["T_WHITESPACE","\n            ",120],["T_FOREACH","foreach",121],["T_WHITESPACE"," ",121],"(",["T_VARIABLE","$productIds",121],["T_WHITESPACE"," ",121],["T_AS","as",121],["T_WHITESPACE"," ",121],["T_VARIABLE","$productId",121],")",["T_WHITESPACE"," ",121],"{",["T_WHITESPACE","\n                ",121],["T_VARIABLE","$key",122],["T_WHITESPACE"," ",122],"=",["T_WHITESPACE"," ",122],["T_STRING","implode",122],"(",["T_CONSTANT_ENCAPSED_STRING","'|'",122],",",["T_WHITESPACE"," ",122],"[",["T_VARIABLE","$date",122],["T_OBJECT_OPERATOR","->",122],["T_STRING","format",122],"(",["T_CONSTANT_ENCAPSED_STRING","'Y-m-d H:i:s'",122],")",",",["T_WHITESPACE"," ",122],["T_VARIABLE","$websiteId",122],",",["T_WHITESPACE"," ",122],["T_VARIABLE","$groupId",122],",",["T_WHITESPACE"," ",122],["T_VARIABLE","$productId",122],"]",")",";",["T_WHITESPACE","\n                ",122],["T_VARIABLE","$this",123],["T_OBJECT_OPERATOR","->",123],["T_STRING","rulePricesStorage",123],["T_OBJECT_OPERATOR","->",123],["T_STRING","setRulePrice",123],"(",["T_WHITESPACE","\n                    ",123],["T_VARIABLE","$key",124],",",["T_WHITESPACE","\n                    ",124],["T_ISSET","isset",125],"(",["T_VARIABLE","$rulePrices",125],"[",["T_VARIABLE","$productId",125],"]",")",["T_WHITESPACE"," ",125],"?",["T_WHITESPACE"," ",125],["T_VARIABLE","$rulePrices",125],"[",["T_VARIABLE","$productId",125],"]",["T_WHITESPACE"," ",125],":",["T_WHITESPACE"," ",125],["T_STRING","false",125],["T_WHITESPACE","\n                ",125],")",";",["T_WHITESPACE","\n            ",126],"}",["T_WHITESPACE","\n        ",127],"}",["T_WHITESPACE","\n\n        ",128],["T_RETURN","return",130],["T_WHITESPACE"," ",130],["T_VARIABLE","$this",130],";",["T_WHITESPACE","\n    ",130],"}",["T_WHITESPACE","\n",131],"}",["T_WHITESPACE","\n",132]]