[["T_OPEN_TAG","<?php\n",1],["T_WHITESPACE","\n",2],["T_NAMESPACE","namespace",3],["T_WHITESPACE"," ",3],["T_STRING","Drupal",3],["T_NS_SEPARATOR","\\",3],["T_STRING","Tests",3],["T_NS_SEPARATOR","\\",3],["T_STRING","Component",3],["T_NS_SEPARATOR","\\",3],["T_STRING","PhpStorage",3],";",["T_WHITESPACE","\n\n",3],["T_DOC_COMMENT","\/**\n * Base test class for MTime protected storage.\n *\/",5],["T_WHITESPACE","\n",7],["T_ABSTRACT","abstract",8],["T_WHITESPACE"," ",8],["T_CLASS","class",8],["T_WHITESPACE"," ",8],["T_STRING","MTimeProtectedFileStorageBase",8],["T_WHITESPACE"," ",8],["T_EXTENDS","extends",8],["T_WHITESPACE"," ",8],["T_STRING","PhpStorageTestBase",8],["T_WHITESPACE"," ",8],"{",["T_WHITESPACE","\n\n  ",8],["T_DOC_COMMENT","\/**\n   * The PHP storage class to test.\n   *\n   * This should be overridden by extending classes.\n   *\/",10],["T_WHITESPACE","\n  ",14],["T_PROTECTED","protected",15],["T_WHITESPACE"," ",15],["T_VARIABLE","$storageClass",15],";",["T_WHITESPACE","\n\n  ",15],["T_DOC_COMMENT","\/**\n   * The secret string to use for file creation.\n   *\n   * @var string\n   *\/",17],["T_WHITESPACE","\n  ",21],["T_PROTECTED","protected",22],["T_WHITESPACE"," ",22],["T_VARIABLE","$secret",22],";",["T_WHITESPACE","\n\n  ",22],["T_DOC_COMMENT","\/**\n   * Test settings to pass to storage instances.\n   *\n   * @var array\n   *\/",24],["T_WHITESPACE","\n  ",28],["T_PROTECTED","protected",29],["T_WHITESPACE"," ",29],["T_VARIABLE","$settings",29],";",["T_WHITESPACE","\n\n  ",29],["T_DOC_COMMENT","\/**\n   * {@inheritdoc}\n   *\/",31],["T_WHITESPACE","\n  ",33],["T_PROTECTED","protected",34],["T_WHITESPACE"," ",34],["T_FUNCTION","function",34],["T_WHITESPACE"," ",34],["T_STRING","setUp",34],"(",")",["T_WHITESPACE"," ",34],"{",["T_WHITESPACE","\n    ",34],["T_STRING","parent",35],["T_DOUBLE_COLON","::",35],["T_STRING","setUp",35],"(",")",";",["T_WHITESPACE","\n\n    ",35],["T_VARIABLE","$this",37],["T_OBJECT_OPERATOR","->",37],["T_STRING","secret",37],["T_WHITESPACE"," ",37],"=",["T_WHITESPACE"," ",37],["T_VARIABLE","$this",37],["T_OBJECT_OPERATOR","->",37],["T_STRING","randomMachineName",37],"(",")",";",["T_WHITESPACE","\n\n    ",37],["T_VARIABLE","$this",39],["T_OBJECT_OPERATOR","->",39],["T_STRING","settings",39],["T_WHITESPACE"," ",39],"=",["T_WHITESPACE"," ",39],["T_ARRAY","array",39],"(",["T_WHITESPACE","\n      ",39],["T_CONSTANT_ENCAPSED_STRING","'directory'",40],["T_WHITESPACE"," ",40],["T_DOUBLE_ARROW","=>",40],["T_WHITESPACE"," ",40],["T_VARIABLE","$this",40],["T_OBJECT_OPERATOR","->",40],["T_STRING","directory",40],",",["T_WHITESPACE","\n      ",40],["T_CONSTANT_ENCAPSED_STRING","'bin'",41],["T_WHITESPACE"," ",41],["T_DOUBLE_ARROW","=>",41],["T_WHITESPACE"," ",41],["T_CONSTANT_ENCAPSED_STRING","'test'",41],",",["T_WHITESPACE","\n      ",41],["T_CONSTANT_ENCAPSED_STRING","'secret'",42],["T_WHITESPACE"," ",42],["T_DOUBLE_ARROW","=>",42],["T_WHITESPACE"," ",42],["T_VARIABLE","$this",42],["T_OBJECT_OPERATOR","->",42],["T_STRING","secret",42],",",["T_WHITESPACE","\n    ",42],")",";",["T_WHITESPACE","\n  ",43],"}",["T_WHITESPACE","\n\n  ",44],["T_DOC_COMMENT","\/**\n   * Tests basic load\/save\/delete operations.\n   *\n   * @covers ::load\n   * @covers ::save\n   * @covers ::delete\n   * @covers ::exists\n   *\/",46],["T_WHITESPACE","\n  ",53],["T_PUBLIC","public",54],["T_WHITESPACE"," ",54],["T_FUNCTION","function",54],["T_WHITESPACE"," ",54],["T_STRING","testCRUD",54],"(",")",["T_WHITESPACE"," ",54],"{",["T_WHITESPACE","\n    ",54],["T_VARIABLE","$php",55],["T_WHITESPACE"," ",55],"=",["T_WHITESPACE"," ",55],["T_NEW","new",55],["T_WHITESPACE"," ",55],["T_VARIABLE","$this",55],["T_OBJECT_OPERATOR","->",55],["T_STRING","storageClass",55],"(",["T_VARIABLE","$this",55],["T_OBJECT_OPERATOR","->",55],["T_STRING","settings",55],")",";",["T_WHITESPACE","\n    ",55],["T_VARIABLE","$this",56],["T_OBJECT_OPERATOR","->",56],["T_STRING","assertCRUD",56],"(",["T_VARIABLE","$php",56],")",";",["T_WHITESPACE","\n  ",56],"}",["T_WHITESPACE","\n\n  ",57],["T_DOC_COMMENT","\/**\n   * Tests the security of the MTimeProtectedFileStorage implementation.\n   *\n   * We test two attacks: first changes the file mtime, then the directory\n   * mtime too.\n   *\n   * We need to delay over 1 second for mtime test.\n   * @medium\n   *\/",59],["T_WHITESPACE","\n  ",67],["T_PUBLIC","public",68],["T_WHITESPACE"," ",68],["T_FUNCTION","function",68],["T_WHITESPACE"," ",68],["T_STRING","testSecurity",68],"(",")",["T_WHITESPACE"," ",68],"{",["T_WHITESPACE","\n    ",68],["T_VARIABLE","$php",69],["T_WHITESPACE"," ",69],"=",["T_WHITESPACE"," ",69],["T_NEW","new",69],["T_WHITESPACE"," ",69],["T_VARIABLE","$this",69],["T_OBJECT_OPERATOR","->",69],["T_STRING","storageClass",69],"(",["T_VARIABLE","$this",69],["T_OBJECT_OPERATOR","->",69],["T_STRING","settings",69],")",";",["T_WHITESPACE","\n    ",69],["T_VARIABLE","$name",70],["T_WHITESPACE"," ",70],"=",["T_WHITESPACE"," ",70],["T_CONSTANT_ENCAPSED_STRING","'simpletest.php'",70],";",["T_WHITESPACE","\n    ",70],["T_VARIABLE","$php",71],["T_OBJECT_OPERATOR","->",71],["T_STRING","save",71],"(",["T_VARIABLE","$name",71],",",["T_WHITESPACE"," ",71],["T_CONSTANT_ENCAPSED_STRING","'<?php'",71],")",";",["T_WHITESPACE","\n    ",71],["T_VARIABLE","$expected_root_directory",72],["T_WHITESPACE"," ",72],"=",["T_WHITESPACE"," ",72],["T_VARIABLE","$this",72],["T_OBJECT_OPERATOR","->",72],["T_STRING","directory",72],["T_WHITESPACE"," ",72],".",["T_WHITESPACE"," ",72],["T_CONSTANT_ENCAPSED_STRING","'\/test'",72],";",["T_WHITESPACE","\n    ",72],["T_IF","if",73],["T_WHITESPACE"," ",73],"(",["T_STRING","substr",73],"(",["T_VARIABLE","$name",73],",",["T_WHITESPACE"," ",73],"-",["T_LNUMBER","4",73],")",["T_WHITESPACE"," ",73],["T_IS_IDENTICAL","===",73],["T_WHITESPACE"," ",73],["T_CONSTANT_ENCAPSED_STRING","'.php'",73],")",["T_WHITESPACE"," ",73],"{",["T_WHITESPACE","\n      ",73],["T_VARIABLE","$expected_directory",74],["T_WHITESPACE"," ",74],"=",["T_WHITESPACE"," ",74],["T_VARIABLE","$expected_root_directory",74],["T_WHITESPACE"," ",74],".",["T_WHITESPACE"," ",74],["T_CONSTANT_ENCAPSED_STRING","'\/'",74],["T_WHITESPACE"," ",74],".",["T_WHITESPACE"," ",74],["T_STRING","substr",74],"(",["T_VARIABLE","$name",74],",",["T_WHITESPACE"," ",74],["T_LNUMBER","0",74],",",["T_WHITESPACE"," ",74],"-",["T_LNUMBER","4",74],")",";",["T_WHITESPACE","\n    ",74],"}",["T_WHITESPACE","\n    ",75],["T_ELSE","else",76],["T_WHITESPACE"," ",76],"{",["T_WHITESPACE","\n      ",76],["T_VARIABLE","$expected_directory",77],["T_WHITESPACE"," ",77],"=",["T_WHITESPACE"," ",77],["T_VARIABLE","$expected_root_directory",77],["T_WHITESPACE"," ",77],".",["T_WHITESPACE"," ",77],["T_CONSTANT_ENCAPSED_STRING","'\/'",77],["T_WHITESPACE"," ",77],".",["T_WHITESPACE"," ",77],["T_VARIABLE","$name",77],";",["T_WHITESPACE","\n    ",77],"}",["T_WHITESPACE","\n    ",78],["T_VARIABLE","$directory_mtime",79],["T_WHITESPACE"," ",79],"=",["T_WHITESPACE"," ",79],["T_STRING","filemtime",79],"(",["T_VARIABLE","$expected_directory",79],")",";",["T_WHITESPACE","\n    ",79],["T_VARIABLE","$expected_filename",80],["T_WHITESPACE"," ",80],"=",["T_WHITESPACE"," ",80],["T_VARIABLE","$expected_directory",80],["T_WHITESPACE"," ",80],".",["T_WHITESPACE"," ",80],["T_CONSTANT_ENCAPSED_STRING","'\/'",80],["T_WHITESPACE"," ",80],".",["T_WHITESPACE"," ",80],["T_STRING","hash_hmac",80],"(",["T_CONSTANT_ENCAPSED_STRING","'sha256'",80],",",["T_WHITESPACE"," ",80],["T_VARIABLE","$name",80],",",["T_WHITESPACE"," ",80],["T_VARIABLE","$this",80],["T_OBJECT_OPERATOR","->",80],["T_STRING","secret",80],["T_WHITESPACE"," ",80],".",["T_WHITESPACE"," ",80],["T_VARIABLE","$directory_mtime",80],")",["T_WHITESPACE"," ",80],".",["T_WHITESPACE"," ",80],["T_CONSTANT_ENCAPSED_STRING","'.php'",80],";",["T_WHITESPACE","\n\n    ",80],["T_COMMENT","\/\/ Ensure the file exists and that it and the containing directory have\n",82],["T_WHITESPACE","    ",83],["T_COMMENT","\/\/ minimal permissions. fileperms() can return high bits unrelated to\n",83],["T_WHITESPACE","    ",84],["T_COMMENT","\/\/ permissions, so mask with 0777.\n",84],["T_WHITESPACE","    ",85],["T_VARIABLE","$this",85],["T_OBJECT_OPERATOR","->",85],["T_STRING","assertTrue",85],"(",["T_STRING","file_exists",85],"(",["T_VARIABLE","$expected_filename",85],")",")",";",["T_WHITESPACE","\n    ",85],["T_VARIABLE","$this",86],["T_OBJECT_OPERATOR","->",86],["T_STRING","assertSame",86],"(",["T_STRING","fileperms",86],"(",["T_VARIABLE","$expected_filename",86],")",["T_WHITESPACE"," ",86],"&",["T_WHITESPACE"," ",86],["T_LNUMBER","0777",86],",",["T_WHITESPACE"," ",86],["T_LNUMBER","0444",86],")",";",["T_WHITESPACE","\n    ",86],["T_VARIABLE","$this",87],["T_OBJECT_OPERATOR","->",87],["T_STRING","assertSame",87],"(",["T_STRING","fileperms",87],"(",["T_VARIABLE","$expected_directory",87],")",["T_WHITESPACE"," ",87],"&",["T_WHITESPACE"," ",87],["T_LNUMBER","0777",87],",",["T_WHITESPACE"," ",87],["T_LNUMBER","0777",87],")",";",["T_WHITESPACE","\n\n    ",87],["T_COMMENT","\/\/ Ensure the root directory for the bin has a .htaccess file denying web\n",89],["T_WHITESPACE","    ",90],["T_COMMENT","\/\/ access.\n",90],["T_WHITESPACE","    ",91],["T_VARIABLE","$this",91],["T_OBJECT_OPERATOR","->",91],["T_STRING","assertSame",91],"(",["T_STRING","file_get_contents",91],"(",["T_VARIABLE","$expected_root_directory",91],["T_WHITESPACE"," ",91],".",["T_WHITESPACE"," ",91],["T_CONSTANT_ENCAPSED_STRING","'\/.htaccess'",91],")",",",["T_WHITESPACE"," ",91],["T_STRING","call_user_func",91],"(",["T_ARRAY","array",91],"(",["T_VARIABLE","$this",91],["T_OBJECT_OPERATOR","->",91],["T_STRING","storageClass",91],",",["T_WHITESPACE"," ",91],["T_CONSTANT_ENCAPSED_STRING","'htaccessLines'",91],")",")",")",";",["T_WHITESPACE","\n\n    ",91],["T_COMMENT","\/\/ Ensure that if the file is replaced with an untrusted one (due to another\n",93],["T_WHITESPACE","    ",94],["T_COMMENT","\/\/ script's file upload vulnerability), it does not get loaded. Since mtime\n",94],["T_WHITESPACE","    ",95],["T_COMMENT","\/\/ granularity is 1 second, we cannot prevent an attack that happens within\n",95],["T_WHITESPACE","    ",96],["T_COMMENT","\/\/ a second of the initial save().\n",96],["T_WHITESPACE","    ",97],["T_STRING","sleep",97],"(",["T_LNUMBER","1",97],")",";",["T_WHITESPACE","\n    ",97],["T_FOR","for",98],["T_WHITESPACE"," ",98],"(",["T_VARIABLE","$i",98],["T_WHITESPACE"," ",98],"=",["T_WHITESPACE"," ",98],["T_LNUMBER","0",98],";",["T_WHITESPACE"," ",98],["T_VARIABLE","$i",98],["T_WHITESPACE"," ",98],"<",["T_WHITESPACE"," ",98],["T_LNUMBER","2",98],";",["T_WHITESPACE"," ",98],["T_VARIABLE","$i",98],["T_INC","++",98],")",["T_WHITESPACE"," ",98],"{",["T_WHITESPACE","\n      ",98],["T_VARIABLE","$php",99],["T_WHITESPACE"," ",99],"=",["T_WHITESPACE"," ",99],["T_NEW","new",99],["T_WHITESPACE"," ",99],["T_VARIABLE","$this",99],["T_OBJECT_OPERATOR","->",99],["T_STRING","storageClass",99],"(",["T_VARIABLE","$this",99],["T_OBJECT_OPERATOR","->",99],["T_STRING","settings",99],")",";",["T_WHITESPACE","\n      ",99],["T_VARIABLE","$GLOBALS",100],"[",["T_CONSTANT_ENCAPSED_STRING","'hacked'",100],"]",["T_WHITESPACE"," ",100],"=",["T_WHITESPACE"," ",100],["T_STRING","FALSE",100],";",["T_WHITESPACE","\n      ",100],["T_VARIABLE","$untrusted_code",101],["T_WHITESPACE"," ",101],"=",["T_WHITESPACE"," ",101],["T_CONSTANT_ENCAPSED_STRING","\"<?php\\n\"",101],["T_WHITESPACE"," ",101],".",["T_WHITESPACE"," ",101],["T_CONSTANT_ENCAPSED_STRING","'$GLOBALS[\"hacked\"] = TRUE;'",101],";",["T_WHITESPACE","\n      ",101],["T_STRING","chmod",102],"(",["T_VARIABLE","$expected_directory",102],",",["T_WHITESPACE"," ",102],["T_LNUMBER","0700",102],")",";",["T_WHITESPACE","\n      ",102],["T_STRING","chmod",103],"(",["T_VARIABLE","$expected_filename",103],",",["T_WHITESPACE"," ",103],["T_LNUMBER","0700",103],")",";",["T_WHITESPACE","\n      ",103],["T_IF","if",104],["T_WHITESPACE"," ",104],"(",["T_VARIABLE","$i",104],")",["T_WHITESPACE"," ",104],"{",["T_WHITESPACE","\n        ",104],["T_COMMENT","\/\/ Now try to write the file in such a way that the directory mtime\n",105],["T_WHITESPACE","        ",106],["T_COMMENT","\/\/ changes and invalidates the hash.\n",106],["T_WHITESPACE","        ",107],["T_STRING","file_put_contents",107],"(",["T_VARIABLE","$expected_filename",107],["T_WHITESPACE"," ",107],".",["T_WHITESPACE"," ",107],["T_CONSTANT_ENCAPSED_STRING","'.tmp'",107],",",["T_WHITESPACE"," ",107],["T_VARIABLE","$untrusted_code",107],")",";",["T_WHITESPACE","\n        ",107],["T_STRING","rename",108],"(",["T_VARIABLE","$expected_filename",108],["T_WHITESPACE"," ",108],".",["T_WHITESPACE"," ",108],["T_CONSTANT_ENCAPSED_STRING","'.tmp'",108],",",["T_WHITESPACE"," ",108],["T_VARIABLE","$expected_filename",108],")",";",["T_WHITESPACE","\n      ",108],"}",["T_WHITESPACE","\n      ",109],["T_ELSE","else",110],["T_WHITESPACE"," ",110],"{",["T_WHITESPACE","\n        ",110],["T_COMMENT","\/\/ On the first try do not change the directory mtime but the filemtime\n",111],["T_WHITESPACE","        ",112],["T_COMMENT","\/\/ is now larger than the directory mtime.\n",112],["T_WHITESPACE","        ",113],["T_STRING","file_put_contents",113],"(",["T_VARIABLE","$expected_filename",113],",",["T_WHITESPACE"," ",113],["T_VARIABLE","$untrusted_code",113],")",";",["T_WHITESPACE","\n      ",113],"}",["T_WHITESPACE","\n      ",114],["T_STRING","chmod",115],"(",["T_VARIABLE","$expected_filename",115],",",["T_WHITESPACE"," ",115],["T_LNUMBER","0400",115],")",";",["T_WHITESPACE","\n      ",115],["T_STRING","chmod",116],"(",["T_VARIABLE","$expected_directory",116],",",["T_WHITESPACE"," ",116],["T_LNUMBER","0100",116],")",";",["T_WHITESPACE","\n      ",116],["T_VARIABLE","$this",117],["T_OBJECT_OPERATOR","->",117],["T_STRING","assertSame",117],"(",["T_STRING","file_get_contents",117],"(",["T_VARIABLE","$expected_filename",117],")",",",["T_WHITESPACE"," ",117],["T_VARIABLE","$untrusted_code",117],")",";",["T_WHITESPACE","\n      ",117],["T_VARIABLE","$this",118],["T_OBJECT_OPERATOR","->",118],["T_STRING","assertSame",118],"(",["T_VARIABLE","$php",118],["T_OBJECT_OPERATOR","->",118],["T_STRING","exists",118],"(",["T_VARIABLE","$name",118],")",",",["T_WHITESPACE"," ",118],["T_VARIABLE","$this",118],["T_OBJECT_OPERATOR","->",118],["T_STRING","expected",118],"[",["T_VARIABLE","$i",118],"]",")",";",["T_WHITESPACE","\n      ",118],["T_VARIABLE","$this",119],["T_OBJECT_OPERATOR","->",119],["T_STRING","assertSame",119],"(",["T_VARIABLE","$php",119],["T_OBJECT_OPERATOR","->",119],["T_STRING","load",119],"(",["T_VARIABLE","$name",119],")",",",["T_WHITESPACE"," ",119],["T_VARIABLE","$this",119],["T_OBJECT_OPERATOR","->",119],["T_STRING","expected",119],"[",["T_VARIABLE","$i",119],"]",")",";",["T_WHITESPACE","\n      ",119],["T_VARIABLE","$this",120],["T_OBJECT_OPERATOR","->",120],["T_STRING","assertSame",120],"(",["T_VARIABLE","$GLOBALS",120],"[",["T_CONSTANT_ENCAPSED_STRING","'hacked'",120],"]",",",["T_WHITESPACE"," ",120],["T_VARIABLE","$this",120],["T_OBJECT_OPERATOR","->",120],["T_STRING","expected",120],"[",["T_VARIABLE","$i",120],"]",")",";",["T_WHITESPACE","\n    ",120],"}",["T_WHITESPACE","\n    ",121],["T_UNSET","unset",122],"(",["T_VARIABLE","$GLOBALS",122],"[",["T_CONSTANT_ENCAPSED_STRING","'hacked'",122],"]",")",";",["T_WHITESPACE","\n  ",122],"}",["T_WHITESPACE","\n\n",123],"}",["T_WHITESPACE","\n",125]]