[["T_OPEN_TAG","<?php\n",1],["T_WHITESPACE","\n",2],["T_NAMESPACE","namespace",3],["T_WHITESPACE"," ",3],["T_STRING","Drupal",3],["T_NS_SEPARATOR","\\",3],["T_STRING","Core",3],["T_NS_SEPARATOR","\\",3],["T_STRING","Lock",3],";",["T_WHITESPACE","\n\n",3],["T_USE","use",5],["T_WHITESPACE"," ",5],["T_STRING","Drupal",5],["T_NS_SEPARATOR","\\",5],["T_STRING","Core",5],["T_NS_SEPARATOR","\\",5],["T_STRING","Database",5],["T_NS_SEPARATOR","\\",5],["T_STRING","Connection",5],";",["T_WHITESPACE","\n",5],["T_USE","use",6],["T_WHITESPACE"," ",6],["T_STRING","Drupal",6],["T_NS_SEPARATOR","\\",6],["T_STRING","Core",6],["T_NS_SEPARATOR","\\",6],["T_STRING","Database",6],["T_NS_SEPARATOR","\\",6],["T_STRING","IntegrityConstraintViolationException",6],";",["T_WHITESPACE","\n",6],["T_USE","use",7],["T_WHITESPACE"," ",7],["T_STRING","Drupal",7],["T_NS_SEPARATOR","\\",7],["T_STRING","Core",7],["T_NS_SEPARATOR","\\",7],["T_STRING","Database",7],["T_NS_SEPARATOR","\\",7],["T_STRING","SchemaObjectExistsException",7],";",["T_WHITESPACE","\n\n",7],["T_DOC_COMMENT","\/**\n * Defines the database lock backend. This is the default backend in Drupal.\n *\n * @ingroup lock\n *\/",9],["T_WHITESPACE","\n",13],["T_CLASS","class",14],["T_WHITESPACE"," ",14],["T_STRING","DatabaseLockBackend",14],["T_WHITESPACE"," ",14],["T_EXTENDS","extends",14],["T_WHITESPACE"," ",14],["T_STRING","LockBackendAbstract",14],["T_WHITESPACE"," ",14],"{",["T_WHITESPACE","\n\n  ",14],["T_DOC_COMMENT","\/**\n   * The database table name.\n   *\/",16],["T_WHITESPACE","\n  ",18],["T_CONST","const",19],["T_WHITESPACE"," ",19],["T_STRING","TABLE_NAME",19],["T_WHITESPACE"," ",19],"=",["T_WHITESPACE"," ",19],["T_CONSTANT_ENCAPSED_STRING","'semaphore'",19],";",["T_WHITESPACE","\n\n  ",19],["T_DOC_COMMENT","\/**\n   * The database connection.\n   *\n   * @var \\Drupal\\Core\\Database\\Connection\n   *\/",21],["T_WHITESPACE","\n  ",25],["T_PROTECTED","protected",26],["T_WHITESPACE"," ",26],["T_VARIABLE","$database",26],";",["T_WHITESPACE","\n\n  ",26],["T_DOC_COMMENT","\/**\n   * Constructs a new DatabaseLockBackend.\n   *\n   * @param \\Drupal\\Core\\Database\\Connection $database\n   *   The database connection.\n   *\/",28],["T_WHITESPACE","\n  ",33],["T_PUBLIC","public",34],["T_WHITESPACE"," ",34],["T_FUNCTION","function",34],["T_WHITESPACE"," ",34],["T_STRING","__construct",34],"(",["T_STRING","Connection",34],["T_WHITESPACE"," ",34],["T_VARIABLE","$database",34],")",["T_WHITESPACE"," ",34],"{",["T_WHITESPACE","\n    ",34],["T_COMMENT","\/\/ __destruct() is causing problems with garbage collections, register a\n",35],["T_WHITESPACE","    ",36],["T_COMMENT","\/\/ shutdown function instead.\n",36],["T_WHITESPACE","    ",37],["T_STRING","drupal_register_shutdown_function",37],"(",["T_ARRAY","array",37],"(",["T_VARIABLE","$this",37],",",["T_WHITESPACE"," ",37],["T_CONSTANT_ENCAPSED_STRING","'releaseAll'",37],")",")",";",["T_WHITESPACE","\n    ",37],["T_VARIABLE","$this",38],["T_OBJECT_OPERATOR","->",38],["T_STRING","database",38],["T_WHITESPACE"," ",38],"=",["T_WHITESPACE"," ",38],["T_VARIABLE","$database",38],";",["T_WHITESPACE","\n  ",38],"}",["T_WHITESPACE","\n\n  ",39],["T_DOC_COMMENT","\/**\n   * {@inheritdoc}\n   *\/",41],["T_WHITESPACE","\n  ",43],["T_PUBLIC","public",44],["T_WHITESPACE"," ",44],["T_FUNCTION","function",44],["T_WHITESPACE"," ",44],["T_STRING","acquire",44],"(",["T_VARIABLE","$name",44],",",["T_WHITESPACE"," ",44],["T_VARIABLE","$timeout",44],["T_WHITESPACE"," ",44],"=",["T_WHITESPACE"," ",44],["T_DNUMBER","30.0",44],")",["T_WHITESPACE"," ",44],"{",["T_WHITESPACE","\n    ",44],["T_COMMENT","\/\/ Insure that the timeout is at least 1 ms.\n",45],["T_WHITESPACE","    ",46],["T_VARIABLE","$timeout",46],["T_WHITESPACE"," ",46],"=",["T_WHITESPACE"," ",46],["T_STRING","max",46],"(",["T_VARIABLE","$timeout",46],",",["T_WHITESPACE"," ",46],["T_DNUMBER","0.001",46],")",";",["T_WHITESPACE","\n    ",46],["T_VARIABLE","$expire",47],["T_WHITESPACE"," ",47],"=",["T_WHITESPACE"," ",47],["T_STRING","microtime",47],"(",["T_STRING","TRUE",47],")",["T_WHITESPACE"," ",47],"+",["T_WHITESPACE"," ",47],["T_VARIABLE","$timeout",47],";",["T_WHITESPACE","\n    ",47],["T_IF","if",48],["T_WHITESPACE"," ",48],"(",["T_ISSET","isset",48],"(",["T_VARIABLE","$this",48],["T_OBJECT_OPERATOR","->",48],["T_STRING","locks",48],"[",["T_VARIABLE","$name",48],"]",")",")",["T_WHITESPACE"," ",48],"{",["T_WHITESPACE","\n      ",48],["T_COMMENT","\/\/ Try to extend the expiration of a lock we already acquired.\n",49],["T_WHITESPACE","      ",50],["T_VARIABLE","$success",50],["T_WHITESPACE"," ",50],"=",["T_WHITESPACE"," ",50],["T_BOOL_CAST","(bool)",50],["T_WHITESPACE"," ",50],["T_VARIABLE","$this",50],["T_OBJECT_OPERATOR","->",50],["T_STRING","database",50],["T_OBJECT_OPERATOR","->",50],["T_STRING","update",50],"(",["T_CONSTANT_ENCAPSED_STRING","'semaphore'",50],")",["T_WHITESPACE","\n        ",50],["T_OBJECT_OPERATOR","->",51],["T_STRING","fields",51],"(",["T_ARRAY","array",51],"(",["T_CONSTANT_ENCAPSED_STRING","'expire'",51],["T_WHITESPACE"," ",51],["T_DOUBLE_ARROW","=>",51],["T_WHITESPACE"," ",51],["T_VARIABLE","$expire",51],")",")",["T_WHITESPACE","\n        ",51],["T_OBJECT_OPERATOR","->",52],["T_STRING","condition",52],"(",["T_CONSTANT_ENCAPSED_STRING","'name'",52],",",["T_WHITESPACE"," ",52],["T_VARIABLE","$name",52],")",["T_WHITESPACE","\n        ",52],["T_OBJECT_OPERATOR","->",53],["T_STRING","condition",53],"(",["T_CONSTANT_ENCAPSED_STRING","'value'",53],",",["T_WHITESPACE"," ",53],["T_VARIABLE","$this",53],["T_OBJECT_OPERATOR","->",53],["T_STRING","getLockId",53],"(",")",")",["T_WHITESPACE","\n        ",53],["T_OBJECT_OPERATOR","->",54],["T_STRING","execute",54],"(",")",";",["T_WHITESPACE","\n      ",54],["T_IF","if",55],["T_WHITESPACE"," ",55],"(","!",["T_VARIABLE","$success",55],")",["T_WHITESPACE"," ",55],"{",["T_WHITESPACE","\n        ",55],["T_COMMENT","\/\/ The lock was broken.\n",56],["T_WHITESPACE","        ",57],["T_UNSET","unset",57],"(",["T_VARIABLE","$this",57],["T_OBJECT_OPERATOR","->",57],["T_STRING","locks",57],"[",["T_VARIABLE","$name",57],"]",")",";",["T_WHITESPACE","\n      ",57],"}",["T_WHITESPACE","\n      ",58],["T_RETURN","return",59],["T_WHITESPACE"," ",59],["T_VARIABLE","$success",59],";",["T_WHITESPACE","\n    ",59],"}",["T_WHITESPACE","\n    ",60],["T_ELSE","else",61],["T_WHITESPACE"," ",61],"{",["T_WHITESPACE","\n      ",61],["T_COMMENT","\/\/ Optimistically try to acquire the lock, then retry once if it fails.\n",62],["T_WHITESPACE","      ",63],["T_COMMENT","\/\/ The first time through the loop cannot be a retry.\n",63],["T_WHITESPACE","      ",64],["T_VARIABLE","$retry",64],["T_WHITESPACE"," ",64],"=",["T_WHITESPACE"," ",64],["T_STRING","FALSE",64],";",["T_WHITESPACE","\n      ",64],["T_COMMENT","\/\/ We always want to do this code at least once.\n",65],["T_WHITESPACE","      ",66],["T_DO","do",66],["T_WHITESPACE"," ",66],"{",["T_WHITESPACE","\n        ",66],["T_TRY","try",67],["T_WHITESPACE"," ",67],"{",["T_WHITESPACE","\n          ",67],["T_VARIABLE","$this",68],["T_OBJECT_OPERATOR","->",68],["T_STRING","database",68],["T_OBJECT_OPERATOR","->",68],["T_STRING","insert",68],"(",["T_CONSTANT_ENCAPSED_STRING","'semaphore'",68],")",["T_WHITESPACE","\n            ",68],["T_OBJECT_OPERATOR","->",69],["T_STRING","fields",69],"(",["T_ARRAY","array",69],"(",["T_WHITESPACE","\n              ",69],["T_CONSTANT_ENCAPSED_STRING","'name'",70],["T_WHITESPACE"," ",70],["T_DOUBLE_ARROW","=>",70],["T_WHITESPACE"," ",70],["T_VARIABLE","$name",70],",",["T_WHITESPACE","\n              ",70],["T_CONSTANT_ENCAPSED_STRING","'value'",71],["T_WHITESPACE"," ",71],["T_DOUBLE_ARROW","=>",71],["T_WHITESPACE"," ",71],["T_VARIABLE","$this",71],["T_OBJECT_OPERATOR","->",71],["T_STRING","getLockId",71],"(",")",",",["T_WHITESPACE","\n              ",71],["T_CONSTANT_ENCAPSED_STRING","'expire'",72],["T_WHITESPACE"," ",72],["T_DOUBLE_ARROW","=>",72],["T_WHITESPACE"," ",72],["T_VARIABLE","$expire",72],",",["T_WHITESPACE","\n            ",72],")",")",["T_WHITESPACE","\n            ",73],["T_OBJECT_OPERATOR","->",74],["T_STRING","execute",74],"(",")",";",["T_WHITESPACE","\n          ",74],["T_COMMENT","\/\/ We track all acquired locks in the global variable.\n",75],["T_WHITESPACE","          ",76],["T_VARIABLE","$this",76],["T_OBJECT_OPERATOR","->",76],["T_STRING","locks",76],"[",["T_VARIABLE","$name",76],"]",["T_WHITESPACE"," ",76],"=",["T_WHITESPACE"," ",76],["T_STRING","TRUE",76],";",["T_WHITESPACE","\n          ",76],["T_COMMENT","\/\/ We never need to try again.\n",77],["T_WHITESPACE","          ",78],["T_VARIABLE","$retry",78],["T_WHITESPACE"," ",78],"=",["T_WHITESPACE"," ",78],["T_STRING","FALSE",78],";",["T_WHITESPACE","\n        ",78],"}",["T_WHITESPACE","\n        ",79],["T_CATCH","catch",80],["T_WHITESPACE"," ",80],"(",["T_STRING","IntegrityConstraintViolationException",80],["T_WHITESPACE"," ",80],["T_VARIABLE","$e",80],")",["T_WHITESPACE"," ",80],"{",["T_WHITESPACE","\n          ",80],["T_COMMENT","\/\/ Suppress the error. If this is our first pass through the loop,\n",81],["T_WHITESPACE","          ",82],["T_COMMENT","\/\/ then $retry is FALSE. In this case, the insert failed because some\n",82],["T_WHITESPACE","          ",83],["T_COMMENT","\/\/ other request acquired the lock but did not release it. We decide\n",83],["T_WHITESPACE","          ",84],["T_COMMENT","\/\/ whether to retry by checking lockMayBeAvailable(). This will clear\n",84],["T_WHITESPACE","          ",85],["T_COMMENT","\/\/ the offending row from the database table in case it has expired.\n",85],["T_WHITESPACE","          ",86],["T_VARIABLE","$retry",86],["T_WHITESPACE"," ",86],"=",["T_WHITESPACE"," ",86],["T_VARIABLE","$retry",86],["T_WHITESPACE"," ",86],"?",["T_WHITESPACE"," ",86],["T_STRING","FALSE",86],["T_WHITESPACE"," ",86],":",["T_WHITESPACE"," ",86],["T_VARIABLE","$this",86],["T_OBJECT_OPERATOR","->",86],["T_STRING","lockMayBeAvailable",86],"(",["T_VARIABLE","$name",86],")",";",["T_WHITESPACE","\n        ",86],"}",["T_WHITESPACE","\n        ",87],["T_CATCH","catch",88],["T_WHITESPACE"," ",88],"(",["T_NS_SEPARATOR","\\",88],["T_STRING","Exception",88],["T_WHITESPACE"," ",88],["T_VARIABLE","$e",88],")",["T_WHITESPACE"," ",88],"{",["T_WHITESPACE","\n          ",88],["T_COMMENT","\/\/ Create the semaphore table if it does not exist and retry.\n",89],["T_WHITESPACE","          ",90],["T_IF","if",90],["T_WHITESPACE"," ",90],"(",["T_VARIABLE","$this",90],["T_OBJECT_OPERATOR","->",90],["T_STRING","ensureTableExists",90],"(",")",")",["T_WHITESPACE"," ",90],"{",["T_WHITESPACE","\n            ",90],["T_COMMENT","\/\/ Retry only once.\n",91],["T_WHITESPACE","            ",92],["T_VARIABLE","$retry",92],["T_WHITESPACE"," ",92],"=",["T_WHITESPACE"," ",92],"!",["T_VARIABLE","$retry",92],";",["T_WHITESPACE","\n          ",92],"}",["T_WHITESPACE","\n          ",93],["T_ELSE","else",94],["T_WHITESPACE"," ",94],"{",["T_WHITESPACE","\n            ",94],["T_THROW","throw",95],["T_WHITESPACE"," ",95],["T_VARIABLE","$e",95],";",["T_WHITESPACE","\n          ",95],"}",["T_WHITESPACE","\n        ",96],"}",["T_WHITESPACE","\n        ",97],["T_COMMENT","\/\/ We only retry in case the first attempt failed, but we then broke\n",98],["T_WHITESPACE","        ",99],["T_COMMENT","\/\/ an expired lock.\n",99],["T_WHITESPACE","      ",100],"}",["T_WHITESPACE"," ",100],["T_WHILE","while",100],["T_WHITESPACE"," ",100],"(",["T_VARIABLE","$retry",100],")",";",["T_WHITESPACE","\n    ",100],"}",["T_WHITESPACE","\n    ",101],["T_RETURN","return",102],["T_WHITESPACE"," ",102],["T_ISSET","isset",102],"(",["T_VARIABLE","$this",102],["T_OBJECT_OPERATOR","->",102],["T_STRING","locks",102],"[",["T_VARIABLE","$name",102],"]",")",";",["T_WHITESPACE","\n  ",102],"}",["T_WHITESPACE","\n\n  ",103],["T_DOC_COMMENT","\/**\n   * {@inheritdoc}\n   *\/",105],["T_WHITESPACE","\n  ",107],["T_PUBLIC","public",108],["T_WHITESPACE"," ",108],["T_FUNCTION","function",108],["T_WHITESPACE"," ",108],["T_STRING","lockMayBeAvailable",108],"(",["T_VARIABLE","$name",108],")",["T_WHITESPACE"," ",108],"{",["T_WHITESPACE","\n    ",108],["T_TRY","try",109],["T_WHITESPACE"," ",109],"{",["T_WHITESPACE","\n      ",109],["T_VARIABLE","$lock",110],["T_WHITESPACE"," ",110],"=",["T_WHITESPACE"," ",110],["T_VARIABLE","$this",110],["T_OBJECT_OPERATOR","->",110],["T_STRING","database",110],["T_OBJECT_OPERATOR","->",110],["T_STRING","query",110],"(",["T_CONSTANT_ENCAPSED_STRING","'SELECT expire, value FROM {semaphore} WHERE name = :name'",110],",",["T_WHITESPACE"," ",110],["T_ARRAY","array",110],"(",["T_CONSTANT_ENCAPSED_STRING","':name'",110],["T_WHITESPACE"," ",110],["T_DOUBLE_ARROW","=>",110],["T_WHITESPACE"," ",110],["T_VARIABLE","$name",110],")",")",["T_OBJECT_OPERATOR","->",110],["T_STRING","fetchAssoc",110],"(",")",";",["T_WHITESPACE","\n    ",110],"}",["T_WHITESPACE","\n    ",111],["T_CATCH","catch",112],["T_WHITESPACE"," ",112],"(",["T_NS_SEPARATOR","\\",112],["T_STRING","Exception",112],["T_WHITESPACE"," ",112],["T_VARIABLE","$e",112],")",["T_WHITESPACE"," ",112],"{",["T_WHITESPACE","\n      ",112],["T_VARIABLE","$this",113],["T_OBJECT_OPERATOR","->",113],["T_STRING","catchException",113],"(",["T_VARIABLE","$e",113],")",";",["T_WHITESPACE","\n      ",113],["T_COMMENT","\/\/ If the table does not exist yet then the lock may be available.\n",114],["T_WHITESPACE","      ",115],["T_VARIABLE","$lock",115],["T_WHITESPACE"," ",115],"=",["T_WHITESPACE"," ",115],["T_STRING","FALSE",115],";",["T_WHITESPACE","\n    ",115],"}",["T_WHITESPACE","\n    ",116],["T_IF","if",117],["T_WHITESPACE"," ",117],"(","!",["T_VARIABLE","$lock",117],")",["T_WHITESPACE"," ",117],"{",["T_WHITESPACE","\n      ",117],["T_RETURN","return",118],["T_WHITESPACE"," ",118],["T_STRING","TRUE",118],";",["T_WHITESPACE","\n    ",118],"}",["T_WHITESPACE","\n    ",119],["T_VARIABLE","$expire",120],["T_WHITESPACE"," ",120],"=",["T_WHITESPACE"," ",120],["T_DOUBLE_CAST","(float)",120],["T_WHITESPACE"," ",120],["T_VARIABLE","$lock",120],"[",["T_CONSTANT_ENCAPSED_STRING","'expire'",120],"]",";",["T_WHITESPACE","\n    ",120],["T_VARIABLE","$now",121],["T_WHITESPACE"," ",121],"=",["T_WHITESPACE"," ",121],["T_STRING","microtime",121],"(",["T_STRING","TRUE",121],")",";",["T_WHITESPACE","\n    ",121],["T_IF","if",122],["T_WHITESPACE"," ",122],"(",["T_VARIABLE","$now",122],["T_WHITESPACE"," ",122],">",["T_WHITESPACE"," ",122],["T_VARIABLE","$expire",122],")",["T_WHITESPACE"," ",122],"{",["T_WHITESPACE","\n      ",122],["T_COMMENT","\/\/ We check two conditions to prevent a race condition where another\n",123],["T_WHITESPACE","      ",124],["T_COMMENT","\/\/ request acquired the lock and set a new expire time. We add a small\n",124],["T_WHITESPACE","      ",125],["T_COMMENT","\/\/ number to $expire to avoid errors with float to string conversion.\n",125],["T_WHITESPACE","      ",126],["T_RETURN","return",126],["T_WHITESPACE"," ",126],["T_BOOL_CAST","(bool)",126],["T_WHITESPACE"," ",126],["T_VARIABLE","$this",126],["T_OBJECT_OPERATOR","->",126],["T_STRING","database",126],["T_OBJECT_OPERATOR","->",126],["T_STRING","delete",126],"(",["T_CONSTANT_ENCAPSED_STRING","'semaphore'",126],")",["T_WHITESPACE","\n        ",126],["T_OBJECT_OPERATOR","->",127],["T_STRING","condition",127],"(",["T_CONSTANT_ENCAPSED_STRING","'name'",127],",",["T_WHITESPACE"," ",127],["T_VARIABLE","$name",127],")",["T_WHITESPACE","\n        ",127],["T_OBJECT_OPERATOR","->",128],["T_STRING","condition",128],"(",["T_CONSTANT_ENCAPSED_STRING","'value'",128],",",["T_WHITESPACE"," ",128],["T_VARIABLE","$lock",128],"[",["T_CONSTANT_ENCAPSED_STRING","'value'",128],"]",")",["T_WHITESPACE","\n        ",128],["T_OBJECT_OPERATOR","->",129],["T_STRING","condition",129],"(",["T_CONSTANT_ENCAPSED_STRING","'expire'",129],",",["T_WHITESPACE"," ",129],["T_DNUMBER","0.0001",129],["T_WHITESPACE"," ",129],"+",["T_WHITESPACE"," ",129],["T_VARIABLE","$expire",129],",",["T_WHITESPACE"," ",129],["T_CONSTANT_ENCAPSED_STRING","'<='",129],")",["T_WHITESPACE","\n        ",129],["T_OBJECT_OPERATOR","->",130],["T_STRING","execute",130],"(",")",";",["T_WHITESPACE","\n    ",130],"}",["T_WHITESPACE","\n    ",131],["T_RETURN","return",132],["T_WHITESPACE"," ",132],["T_STRING","FALSE",132],";",["T_WHITESPACE","\n  ",132],"}",["T_WHITESPACE","\n\n  ",133],["T_DOC_COMMENT","\/**\n   * {@inheritdoc}\n   *\/",135],["T_WHITESPACE","\n  ",137],["T_PUBLIC","public",138],["T_WHITESPACE"," ",138],["T_FUNCTION","function",138],["T_WHITESPACE"," ",138],["T_STRING","release",138],"(",["T_VARIABLE","$name",138],")",["T_WHITESPACE"," ",138],"{",["T_WHITESPACE","\n    ",138],["T_UNSET","unset",139],"(",["T_VARIABLE","$this",139],["T_OBJECT_OPERATOR","->",139],["T_STRING","locks",139],"[",["T_VARIABLE","$name",139],"]",")",";",["T_WHITESPACE","\n    ",139],["T_TRY","try",140],["T_WHITESPACE"," ",140],"{",["T_WHITESPACE","\n      ",140],["T_VARIABLE","$this",141],["T_OBJECT_OPERATOR","->",141],["T_STRING","database",141],["T_OBJECT_OPERATOR","->",141],["T_STRING","delete",141],"(",["T_CONSTANT_ENCAPSED_STRING","'semaphore'",141],")",["T_WHITESPACE","\n        ",141],["T_OBJECT_OPERATOR","->",142],["T_STRING","condition",142],"(",["T_CONSTANT_ENCAPSED_STRING","'name'",142],",",["T_WHITESPACE"," ",142],["T_VARIABLE","$name",142],")",["T_WHITESPACE","\n        ",142],["T_OBJECT_OPERATOR","->",143],["T_STRING","condition",143],"(",["T_CONSTANT_ENCAPSED_STRING","'value'",143],",",["T_WHITESPACE"," ",143],["T_VARIABLE","$this",143],["T_OBJECT_OPERATOR","->",143],["T_STRING","getLockId",143],"(",")",")",["T_WHITESPACE","\n        ",143],["T_OBJECT_OPERATOR","->",144],["T_STRING","execute",144],"(",")",";",["T_WHITESPACE","\n    ",144],"}",["T_WHITESPACE","\n    ",145],["T_CATCH","catch",146],["T_WHITESPACE"," ",146],"(",["T_NS_SEPARATOR","\\",146],["T_STRING","Exception",146],["T_WHITESPACE"," ",146],["T_VARIABLE","$e",146],")",["T_WHITESPACE"," ",146],"{",["T_WHITESPACE","\n      ",146],["T_VARIABLE","$this",147],["T_OBJECT_OPERATOR","->",147],["T_STRING","catchException",147],"(",["T_VARIABLE","$e",147],")",";",["T_WHITESPACE","\n    ",147],"}",["T_WHITESPACE","\n  ",148],"}",["T_WHITESPACE","\n\n  ",149],["T_DOC_COMMENT","\/**\n   * {@inheritdoc}\n   *\/",151],["T_WHITESPACE","\n  ",153],["T_PUBLIC","public",154],["T_WHITESPACE"," ",154],["T_FUNCTION","function",154],["T_WHITESPACE"," ",154],["T_STRING","releaseAll",154],"(",["T_VARIABLE","$lock_id",154],["T_WHITESPACE"," ",154],"=",["T_WHITESPACE"," ",154],["T_STRING","NULL",154],")",["T_WHITESPACE"," ",154],"{",["T_WHITESPACE","\n    ",154],["T_COMMENT","\/\/ Only attempt to release locks if any were acquired.\n",155],["T_WHITESPACE","    ",156],["T_IF","if",156],["T_WHITESPACE"," ",156],"(","!",["T_EMPTY","empty",156],"(",["T_VARIABLE","$this",156],["T_OBJECT_OPERATOR","->",156],["T_STRING","locks",156],")",")",["T_WHITESPACE"," ",156],"{",["T_WHITESPACE","\n      ",156],["T_VARIABLE","$this",157],["T_OBJECT_OPERATOR","->",157],["T_STRING","locks",157],["T_WHITESPACE"," ",157],"=",["T_WHITESPACE"," ",157],["T_ARRAY","array",157],"(",")",";",["T_WHITESPACE","\n      ",157],["T_IF","if",158],["T_WHITESPACE"," ",158],"(",["T_EMPTY","empty",158],"(",["T_VARIABLE","$lock_id",158],")",")",["T_WHITESPACE"," ",158],"{",["T_WHITESPACE","\n        ",158],["T_VARIABLE","$lock_id",159],["T_WHITESPACE"," ",159],"=",["T_WHITESPACE"," ",159],["T_VARIABLE","$this",159],["T_OBJECT_OPERATOR","->",159],["T_STRING","getLockId",159],"(",")",";",["T_WHITESPACE","\n      ",159],"}",["T_WHITESPACE","\n      ",160],["T_VARIABLE","$this",161],["T_OBJECT_OPERATOR","->",161],["T_STRING","database",161],["T_OBJECT_OPERATOR","->",161],["T_STRING","delete",161],"(",["T_CONSTANT_ENCAPSED_STRING","'semaphore'",161],")",["T_WHITESPACE","\n        ",161],["T_OBJECT_OPERATOR","->",162],["T_STRING","condition",162],"(",["T_CONSTANT_ENCAPSED_STRING","'value'",162],",",["T_WHITESPACE"," ",162],["T_VARIABLE","$lock_id",162],")",["T_WHITESPACE","\n        ",162],["T_OBJECT_OPERATOR","->",163],["T_STRING","execute",163],"(",")",";",["T_WHITESPACE","\n    ",163],"}",["T_WHITESPACE","\n  ",164],"}",["T_WHITESPACE","\n\n  ",165],["T_DOC_COMMENT","\/**\n   * Check if the semaphore table exists and create it if not.\n   *\/",167],["T_WHITESPACE","\n  ",169],["T_PROTECTED","protected",170],["T_WHITESPACE"," ",170],["T_FUNCTION","function",170],["T_WHITESPACE"," ",170],["T_STRING","ensureTableExists",170],"(",")",["T_WHITESPACE"," ",170],"{",["T_WHITESPACE","\n    ",170],["T_TRY","try",171],["T_WHITESPACE"," ",171],"{",["T_WHITESPACE","\n      ",171],["T_VARIABLE","$database_schema",172],["T_WHITESPACE"," ",172],"=",["T_WHITESPACE"," ",172],["T_VARIABLE","$this",172],["T_OBJECT_OPERATOR","->",172],["T_STRING","database",172],["T_OBJECT_OPERATOR","->",172],["T_STRING","schema",172],"(",")",";",["T_WHITESPACE","\n      ",172],["T_IF","if",173],["T_WHITESPACE"," ",173],"(","!",["T_VARIABLE","$database_schema",173],["T_OBJECT_OPERATOR","->",173],["T_STRING","tableExists",173],"(",["T_STATIC","static",173],["T_DOUBLE_COLON","::",173],["T_STRING","TABLE_NAME",173],")",")",["T_WHITESPACE"," ",173],"{",["T_WHITESPACE","\n        ",173],["T_VARIABLE","$schema_definition",174],["T_WHITESPACE"," ",174],"=",["T_WHITESPACE"," ",174],["T_VARIABLE","$this",174],["T_OBJECT_OPERATOR","->",174],["T_STRING","schemaDefinition",174],"(",")",";",["T_WHITESPACE","\n        ",174],["T_VARIABLE","$database_schema",175],["T_OBJECT_OPERATOR","->",175],["T_STRING","createTable",175],"(",["T_STATIC","static",175],["T_DOUBLE_COLON","::",175],["T_STRING","TABLE_NAME",175],",",["T_WHITESPACE"," ",175],["T_VARIABLE","$schema_definition",175],")",";",["T_WHITESPACE","\n        ",175],["T_RETURN","return",176],["T_WHITESPACE"," ",176],["T_STRING","TRUE",176],";",["T_WHITESPACE","\n      ",176],"}",["T_WHITESPACE","\n    ",177],"}",["T_WHITESPACE","\n    ",178],["T_COMMENT","\/\/ If another process has already created the semaphore table, attempting to\n",179],["T_WHITESPACE","    ",180],["T_COMMENT","\/\/ recreate it will throw an exception. In this case just catch the\n",180],["T_WHITESPACE","    ",181],["T_COMMENT","\/\/ exception and do nothing.\n",181],["T_WHITESPACE","    ",182],["T_CATCH","catch",182],["T_WHITESPACE"," ",182],"(",["T_STRING","SchemaObjectExistsException",182],["T_WHITESPACE"," ",182],["T_VARIABLE","$e",182],")",["T_WHITESPACE"," ",182],"{",["T_WHITESPACE","\n      ",182],["T_RETURN","return",183],["T_WHITESPACE"," ",183],["T_STRING","TRUE",183],";",["T_WHITESPACE","\n    ",183],"}",["T_WHITESPACE","\n    ",184],["T_RETURN","return",185],["T_WHITESPACE"," ",185],["T_STRING","FALSE",185],";",["T_WHITESPACE","\n  ",185],"}",["T_WHITESPACE","\n\n  ",186],["T_DOC_COMMENT","\/**\n   * Act on an exception when semaphore might be stale.\n   *\n   * If the table does not yet exist, that's fine, but if the table exists and\n   * yet the query failed, then the semaphore is stale and the exception needs\n   * to propagate.\n   *\n   * @param $e\n   *   The exception.\n   *\n   * @throws \\Exception\n   *\/",188],["T_WHITESPACE","\n  ",199],["T_PROTECTED","protected",200],["T_WHITESPACE"," ",200],["T_FUNCTION","function",200],["T_WHITESPACE"," ",200],["T_STRING","catchException",200],"(",["T_NS_SEPARATOR","\\",200],["T_STRING","Exception",200],["T_WHITESPACE"," ",200],["T_VARIABLE","$e",200],")",["T_WHITESPACE"," ",200],"{",["T_WHITESPACE","\n    ",200],["T_IF","if",201],["T_WHITESPACE"," ",201],"(",["T_VARIABLE","$this",201],["T_OBJECT_OPERATOR","->",201],["T_STRING","database",201],["T_OBJECT_OPERATOR","->",201],["T_STRING","schema",201],"(",")",["T_OBJECT_OPERATOR","->",201],["T_STRING","tableExists",201],"(",["T_STATIC","static",201],["T_DOUBLE_COLON","::",201],["T_STRING","TABLE_NAME",201],")",")",["T_WHITESPACE"," ",201],"{",["T_WHITESPACE","\n      ",201],["T_THROW","throw",202],["T_WHITESPACE"," ",202],["T_VARIABLE","$e",202],";",["T_WHITESPACE","\n    ",202],"}",["T_WHITESPACE","\n  ",203],"}",["T_WHITESPACE","\n\n  ",204],["T_DOC_COMMENT","\/**\n   * Defines the schema for the semaphore table.\n   *\/",206],["T_WHITESPACE","\n  ",208],["T_PUBLIC","public",209],["T_WHITESPACE"," ",209],["T_FUNCTION","function",209],["T_WHITESPACE"," ",209],["T_STRING","schemaDefinition",209],"(",")",["T_WHITESPACE"," ",209],"{",["T_WHITESPACE","\n    ",209],["T_RETURN","return",210],["T_WHITESPACE"," ",210],"[",["T_WHITESPACE","\n      ",210],["T_CONSTANT_ENCAPSED_STRING","'description'",211],["T_WHITESPACE"," ",211],["T_DOUBLE_ARROW","=>",211],["T_WHITESPACE"," ",211],["T_CONSTANT_ENCAPSED_STRING","'Table for holding semaphores, locks, flags, etc. that cannot be stored as state since they must not be cached.'",211],",",["T_WHITESPACE","\n      ",211],["T_CONSTANT_ENCAPSED_STRING","'fields'",212],["T_WHITESPACE"," ",212],["T_DOUBLE_ARROW","=>",212],["T_WHITESPACE"," ",212],"[",["T_WHITESPACE","\n        ",212],["T_CONSTANT_ENCAPSED_STRING","'name'",213],["T_WHITESPACE"," ",213],["T_DOUBLE_ARROW","=>",213],["T_WHITESPACE"," ",213],"[",["T_WHITESPACE","\n          ",213],["T_CONSTANT_ENCAPSED_STRING","'description'",214],["T_WHITESPACE"," ",214],["T_DOUBLE_ARROW","=>",214],["T_WHITESPACE"," ",214],["T_CONSTANT_ENCAPSED_STRING","'Primary Key: Unique name.'",214],",",["T_WHITESPACE","\n          ",214],["T_CONSTANT_ENCAPSED_STRING","'type'",215],["T_WHITESPACE"," ",215],["T_DOUBLE_ARROW","=>",215],["T_WHITESPACE"," ",215],["T_CONSTANT_ENCAPSED_STRING","'varchar_ascii'",215],",",["T_WHITESPACE","\n          ",215],["T_CONSTANT_ENCAPSED_STRING","'length'",216],["T_WHITESPACE"," ",216],["T_DOUBLE_ARROW","=>",216],["T_WHITESPACE"," ",216],["T_LNUMBER","255",216],",",["T_WHITESPACE","\n          ",216],["T_CONSTANT_ENCAPSED_STRING","'not null'",217],["T_WHITESPACE"," ",217],["T_DOUBLE_ARROW","=>",217],["T_WHITESPACE"," ",217],["T_STRING","TRUE",217],",",["T_WHITESPACE","\n          ",217],["T_CONSTANT_ENCAPSED_STRING","'default'",218],["T_WHITESPACE"," ",218],["T_DOUBLE_ARROW","=>",218],["T_WHITESPACE"," ",218],["T_CONSTANT_ENCAPSED_STRING","''",218],["T_WHITESPACE","\n        ",218],"]",",",["T_WHITESPACE","\n        ",219],["T_CONSTANT_ENCAPSED_STRING","'value'",220],["T_WHITESPACE"," ",220],["T_DOUBLE_ARROW","=>",220],["T_WHITESPACE"," ",220],"[",["T_WHITESPACE","\n          ",220],["T_CONSTANT_ENCAPSED_STRING","'description'",221],["T_WHITESPACE"," ",221],["T_DOUBLE_ARROW","=>",221],["T_WHITESPACE"," ",221],["T_CONSTANT_ENCAPSED_STRING","'A value for the semaphore.'",221],",",["T_WHITESPACE","\n          ",221],["T_CONSTANT_ENCAPSED_STRING","'type'",222],["T_WHITESPACE"," ",222],["T_DOUBLE_ARROW","=>",222],["T_WHITESPACE"," ",222],["T_CONSTANT_ENCAPSED_STRING","'varchar_ascii'",222],",",["T_WHITESPACE","\n          ",222],["T_CONSTANT_ENCAPSED_STRING","'length'",223],["T_WHITESPACE"," ",223],["T_DOUBLE_ARROW","=>",223],["T_WHITESPACE"," ",223],["T_LNUMBER","255",223],",",["T_WHITESPACE","\n          ",223],["T_CONSTANT_ENCAPSED_STRING","'not null'",224],["T_WHITESPACE"," ",224],["T_DOUBLE_ARROW","=>",224],["T_WHITESPACE"," ",224],["T_STRING","TRUE",224],",",["T_WHITESPACE","\n          ",224],["T_CONSTANT_ENCAPSED_STRING","'default'",225],["T_WHITESPACE"," ",225],["T_DOUBLE_ARROW","=>",225],["T_WHITESPACE"," ",225],["T_CONSTANT_ENCAPSED_STRING","''",225],["T_WHITESPACE","\n        ",225],"]",",",["T_WHITESPACE","\n        ",226],["T_CONSTANT_ENCAPSED_STRING","'expire'",227],["T_WHITESPACE"," ",227],["T_DOUBLE_ARROW","=>",227],["T_WHITESPACE"," ",227],"[",["T_WHITESPACE","\n          ",227],["T_CONSTANT_ENCAPSED_STRING","'description'",228],["T_WHITESPACE"," ",228],["T_DOUBLE_ARROW","=>",228],["T_WHITESPACE"," ",228],["T_CONSTANT_ENCAPSED_STRING","'A Unix timestamp with microseconds indicating when the semaphore should expire.'",228],",",["T_WHITESPACE","\n          ",228],["T_CONSTANT_ENCAPSED_STRING","'type'",229],["T_WHITESPACE"," ",229],["T_DOUBLE_ARROW","=>",229],["T_WHITESPACE"," ",229],["T_CONSTANT_ENCAPSED_STRING","'float'",229],",",["T_WHITESPACE","\n          ",229],["T_CONSTANT_ENCAPSED_STRING","'size'",230],["T_WHITESPACE"," ",230],["T_DOUBLE_ARROW","=>",230],["T_WHITESPACE"," ",230],["T_CONSTANT_ENCAPSED_STRING","'big'",230],",",["T_WHITESPACE","\n          ",230],["T_CONSTANT_ENCAPSED_STRING","'not null'",231],["T_WHITESPACE"," ",231],["T_DOUBLE_ARROW","=>",231],["T_WHITESPACE"," ",231],["T_STRING","TRUE",231],["T_WHITESPACE","\n        ",231],"]",",",["T_WHITESPACE","\n      ",232],"]",",",["T_WHITESPACE","\n      ",233],["T_CONSTANT_ENCAPSED_STRING","'indexes'",234],["T_WHITESPACE"," ",234],["T_DOUBLE_ARROW","=>",234],["T_WHITESPACE"," ",234],"[",["T_WHITESPACE","\n        ",234],["T_CONSTANT_ENCAPSED_STRING","'value'",235],["T_WHITESPACE"," ",235],["T_DOUBLE_ARROW","=>",235],["T_WHITESPACE"," ",235],"[",["T_CONSTANT_ENCAPSED_STRING","'value'",235],"]",",",["T_WHITESPACE","\n        ",235],["T_CONSTANT_ENCAPSED_STRING","'expire'",236],["T_WHITESPACE"," ",236],["T_DOUBLE_ARROW","=>",236],["T_WHITESPACE"," ",236],"[",["T_CONSTANT_ENCAPSED_STRING","'expire'",236],"]",",",["T_WHITESPACE","\n      ",236],"]",",",["T_WHITESPACE","\n      ",237],["T_CONSTANT_ENCAPSED_STRING","'primary key'",238],["T_WHITESPACE"," ",238],["T_DOUBLE_ARROW","=>",238],["T_WHITESPACE"," ",238],"[",["T_CONSTANT_ENCAPSED_STRING","'name'",238],"]",",",["T_WHITESPACE","\n    ",238],"]",";",["T_WHITESPACE","\n  ",239],"}",["T_WHITESPACE","\n\n",240],"}",["T_WHITESPACE","\n",242]]