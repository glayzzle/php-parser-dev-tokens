[["T_OPEN_TAG","<?php\n",1],["T_WHITESPACE","\n",2],["T_NAMESPACE","namespace",3],["T_WHITESPACE"," ",3],["T_STRING","Drupal",3],["T_NS_SEPARATOR","\\",3],["T_STRING","Core",3],["T_NS_SEPARATOR","\\",3],["T_STRING","Database",3],["T_NS_SEPARATOR","\\",3],["T_STRING","Driver",3],["T_NS_SEPARATOR","\\",3],["T_STRING","pgsql",3],";",["T_WHITESPACE","\n\n",3],["T_USE","use",5],["T_WHITESPACE"," ",5],["T_STRING","Drupal",5],["T_NS_SEPARATOR","\\",5],["T_STRING","Core",5],["T_NS_SEPARATOR","\\",5],["T_STRING","Database",5],["T_NS_SEPARATOR","\\",5],["T_STRING","Query",5],["T_NS_SEPARATOR","\\",5],["T_STRING","Upsert",5],["T_WHITESPACE"," ",5],["T_AS","as",5],["T_WHITESPACE"," ",5],["T_STRING","QueryUpsert",5],";",["T_WHITESPACE","\n\n",5],["T_DOC_COMMENT","\/**\n * PostgreSQL implementation of \\Drupal\\Core\\Database\\Query\\Upsert.\n *\/",7],["T_WHITESPACE","\n",9],["T_CLASS","class",10],["T_WHITESPACE"," ",10],["T_STRING","Upsert",10],["T_WHITESPACE"," ",10],["T_EXTENDS","extends",10],["T_WHITESPACE"," ",10],["T_STRING","QueryUpsert",10],["T_WHITESPACE"," ",10],"{",["T_WHITESPACE","\n\n  ",10],["T_DOC_COMMENT","\/**\n   * {@inheritdoc}\n   *\/",12],["T_WHITESPACE","\n  ",14],["T_PUBLIC","public",15],["T_WHITESPACE"," ",15],["T_FUNCTION","function",15],["T_WHITESPACE"," ",15],["T_STRING","execute",15],"(",")",["T_WHITESPACE"," ",15],"{",["T_WHITESPACE","\n    ",15],["T_IF","if",16],["T_WHITESPACE"," ",16],"(","!",["T_VARIABLE","$this",16],["T_OBJECT_OPERATOR","->",16],["T_STRING","preExecute",16],"(",")",")",["T_WHITESPACE"," ",16],"{",["T_WHITESPACE","\n      ",16],["T_RETURN","return",17],["T_WHITESPACE"," ",17],["T_STRING","NULL",17],";",["T_WHITESPACE","\n    ",17],"}",["T_WHITESPACE","\n\n    ",18],["T_COMMENT","\/\/ Default options for upsert queries.\n",20],["T_WHITESPACE","    ",21],["T_VARIABLE","$this",21],["T_OBJECT_OPERATOR","->",21],["T_STRING","queryOptions",21],["T_WHITESPACE"," ",21],["T_PLUS_EQUAL","+=",21],["T_WHITESPACE"," ",21],["T_ARRAY","array",21],"(",["T_WHITESPACE","\n      ",21],["T_CONSTANT_ENCAPSED_STRING","'throw_exception'",22],["T_WHITESPACE"," ",22],["T_DOUBLE_ARROW","=>",22],["T_WHITESPACE"," ",22],["T_STRING","TRUE",22],",",["T_WHITESPACE","\n    ",22],")",";",["T_WHITESPACE","\n\n    ",23],["T_COMMENT","\/\/ Default fields are always placed first for consistency.\n",25],["T_WHITESPACE","    ",26],["T_VARIABLE","$insert_fields",26],["T_WHITESPACE"," ",26],"=",["T_WHITESPACE"," ",26],["T_STRING","array_merge",26],"(",["T_VARIABLE","$this",26],["T_OBJECT_OPERATOR","->",26],["T_STRING","defaultFields",26],",",["T_WHITESPACE"," ",26],["T_VARIABLE","$this",26],["T_OBJECT_OPERATOR","->",26],["T_STRING","insertFields",26],")",";",["T_WHITESPACE","\n\n    ",26],["T_VARIABLE","$table",28],["T_WHITESPACE"," ",28],"=",["T_WHITESPACE"," ",28],["T_VARIABLE","$this",28],["T_OBJECT_OPERATOR","->",28],["T_STRING","connection",28],["T_OBJECT_OPERATOR","->",28],["T_STRING","escapeTable",28],"(",["T_VARIABLE","$this",28],["T_OBJECT_OPERATOR","->",28],["T_STRING","table",28],")",";",["T_WHITESPACE","\n\n    ",28],["T_COMMENT","\/\/ We have to execute multiple queries, therefore we wrap everything in a\n",30],["T_WHITESPACE","    ",31],["T_COMMENT","\/\/ transaction so that it is atomic where possible.\n",31],["T_WHITESPACE","    ",32],["T_VARIABLE","$transaction",32],["T_WHITESPACE"," ",32],"=",["T_WHITESPACE"," ",32],["T_VARIABLE","$this",32],["T_OBJECT_OPERATOR","->",32],["T_STRING","connection",32],["T_OBJECT_OPERATOR","->",32],["T_STRING","startTransaction",32],"(",")",";",["T_WHITESPACE","\n\n    ",32],["T_TRY","try",34],["T_WHITESPACE"," ",34],"{",["T_WHITESPACE","\n      ",34],["T_COMMENT","\/\/ First, lock the table we're upserting into.\n",35],["T_WHITESPACE","      ",36],["T_VARIABLE","$this",36],["T_OBJECT_OPERATOR","->",36],["T_STRING","connection",36],["T_OBJECT_OPERATOR","->",36],["T_STRING","query",36],"(",["T_CONSTANT_ENCAPSED_STRING","'LOCK TABLE {'",36],["T_WHITESPACE"," ",36],".",["T_WHITESPACE"," ",36],["T_VARIABLE","$table",36],["T_WHITESPACE"," ",36],".",["T_WHITESPACE"," ",36],["T_CONSTANT_ENCAPSED_STRING","'} IN SHARE ROW EXCLUSIVE MODE'",36],",",["T_WHITESPACE"," ",36],"[","]",",",["T_WHITESPACE"," ",36],["T_VARIABLE","$this",36],["T_OBJECT_OPERATOR","->",36],["T_STRING","queryOptions",36],")",";",["T_WHITESPACE","\n\n      ",36],["T_COMMENT","\/\/ Second, delete all items first so we can do one insert.\n",38],["T_WHITESPACE","      ",39],["T_VARIABLE","$unique_key_position",39],["T_WHITESPACE"," ",39],"=",["T_WHITESPACE"," ",39],["T_STRING","array_search",39],"(",["T_VARIABLE","$this",39],["T_OBJECT_OPERATOR","->",39],["T_STRING","key",39],",",["T_WHITESPACE"," ",39],["T_VARIABLE","$insert_fields",39],")",";",["T_WHITESPACE","\n      ",39],["T_VARIABLE","$delete_ids",40],["T_WHITESPACE"," ",40],"=",["T_WHITESPACE"," ",40],"[","]",";",["T_WHITESPACE","\n      ",40],["T_FOREACH","foreach",41],["T_WHITESPACE"," ",41],"(",["T_VARIABLE","$this",41],["T_OBJECT_OPERATOR","->",41],["T_STRING","insertValues",41],["T_WHITESPACE"," ",41],["T_AS","as",41],["T_WHITESPACE"," ",41],["T_VARIABLE","$insert_values",41],")",["T_WHITESPACE"," ",41],"{",["T_WHITESPACE","\n        ",41],["T_VARIABLE","$delete_ids",42],"[","]",["T_WHITESPACE"," ",42],"=",["T_WHITESPACE"," ",42],["T_VARIABLE","$insert_values",42],"[",["T_VARIABLE","$unique_key_position",42],"]",";",["T_WHITESPACE","\n      ",42],"}",["T_WHITESPACE","\n\n      ",43],["T_COMMENT","\/\/ Delete in chunks when a large array is passed.\n",45],["T_WHITESPACE","      ",46],["T_FOREACH","foreach",46],["T_WHITESPACE"," ",46],"(",["T_STRING","array_chunk",46],"(",["T_VARIABLE","$delete_ids",46],",",["T_WHITESPACE"," ",46],["T_LNUMBER","1000",46],")",["T_WHITESPACE"," ",46],["T_AS","as",46],["T_WHITESPACE"," ",46],["T_VARIABLE","$delete_ids_chunk",46],")",["T_WHITESPACE"," ",46],"{",["T_WHITESPACE","\n        ",46],["T_VARIABLE","$this",47],["T_OBJECT_OPERATOR","->",47],["T_STRING","connection",47],["T_OBJECT_OPERATOR","->",47],["T_STRING","delete",47],"(",["T_VARIABLE","$this",47],["T_OBJECT_OPERATOR","->",47],["T_STRING","table",47],",",["T_WHITESPACE"," ",47],["T_VARIABLE","$this",47],["T_OBJECT_OPERATOR","->",47],["T_STRING","queryOptions",47],")",["T_WHITESPACE","\n          ",47],["T_OBJECT_OPERATOR","->",48],["T_STRING","condition",48],"(",["T_VARIABLE","$this",48],["T_OBJECT_OPERATOR","->",48],["T_STRING","key",48],",",["T_WHITESPACE"," ",48],["T_VARIABLE","$delete_ids_chunk",48],",",["T_WHITESPACE"," ",48],["T_CONSTANT_ENCAPSED_STRING","'IN'",48],")",["T_WHITESPACE","\n          ",48],["T_OBJECT_OPERATOR","->",49],["T_STRING","execute",49],"(",")",";",["T_WHITESPACE","\n      ",49],"}",["T_WHITESPACE","\n\n      ",50],["T_COMMENT","\/\/ Third, insert all the values.\n",52],["T_WHITESPACE","      ",53],["T_VARIABLE","$insert",53],["T_WHITESPACE"," ",53],"=",["T_WHITESPACE"," ",53],["T_VARIABLE","$this",53],["T_OBJECT_OPERATOR","->",53],["T_STRING","connection",53],["T_OBJECT_OPERATOR","->",53],["T_STRING","insert",53],"(",["T_VARIABLE","$this",53],["T_OBJECT_OPERATOR","->",53],["T_STRING","table",53],",",["T_WHITESPACE"," ",53],["T_VARIABLE","$this",53],["T_OBJECT_OPERATOR","->",53],["T_STRING","queryOptions",53],")",["T_WHITESPACE","\n        ",53],["T_OBJECT_OPERATOR","->",54],["T_STRING","fields",54],"(",["T_VARIABLE","$insert_fields",54],")",";",["T_WHITESPACE","\n      ",54],["T_FOREACH","foreach",55],["T_WHITESPACE"," ",55],"(",["T_VARIABLE","$this",55],["T_OBJECT_OPERATOR","->",55],["T_STRING","insertValues",55],["T_WHITESPACE"," ",55],["T_AS","as",55],["T_WHITESPACE"," ",55],["T_VARIABLE","$insert_values",55],")",["T_WHITESPACE"," ",55],"{",["T_WHITESPACE","\n        ",55],["T_VARIABLE","$insert",56],["T_OBJECT_OPERATOR","->",56],["T_STRING","values",56],"(",["T_VARIABLE","$insert_values",56],")",";",["T_WHITESPACE","\n      ",56],"}",["T_WHITESPACE","\n      ",57],["T_VARIABLE","$insert",58],["T_OBJECT_OPERATOR","->",58],["T_STRING","execute",58],"(",")",";",["T_WHITESPACE","\n    ",58],"}",["T_WHITESPACE","\n    ",59],["T_CATCH","catch",60],["T_WHITESPACE"," ",60],"(",["T_NS_SEPARATOR","\\",60],["T_STRING","Exception",60],["T_WHITESPACE"," ",60],["T_VARIABLE","$e",60],")",["T_WHITESPACE"," ",60],"{",["T_WHITESPACE","\n      ",60],["T_COMMENT","\/\/ One of the queries failed, rollback the whole batch.\n",61],["T_WHITESPACE","      ",62],["T_VARIABLE","$transaction",62],["T_OBJECT_OPERATOR","->",62],["T_STRING","rollback",62],"(",")",";",["T_WHITESPACE","\n\n      ",62],["T_COMMENT","\/\/ Rethrow the exception for the calling code.\n",64],["T_WHITESPACE","      ",65],["T_THROW","throw",65],["T_WHITESPACE"," ",65],["T_VARIABLE","$e",65],";",["T_WHITESPACE","\n    ",65],"}",["T_WHITESPACE","\n\n    ",66],["T_COMMENT","\/\/ Re-initialize the values array so that we can re-use this query.\n",68],["T_WHITESPACE","    ",69],["T_VARIABLE","$this",69],["T_OBJECT_OPERATOR","->",69],["T_STRING","insertValues",69],["T_WHITESPACE"," ",69],"=",["T_WHITESPACE"," ",69],["T_ARRAY","array",69],"(",")",";",["T_WHITESPACE","\n\n    ",69],["T_COMMENT","\/\/ Transaction commits here where $transaction looses scope.\n",71],["T_WHITESPACE","\n    ",72],["T_RETURN","return",73],["T_WHITESPACE"," ",73],["T_STRING","TRUE",73],";",["T_WHITESPACE","\n  ",73],"}",["T_WHITESPACE","\n\n  ",74],["T_DOC_COMMENT","\/**\n   * {@inheritdoc}\n   *\/",76],["T_WHITESPACE","\n  ",78],["T_PUBLIC","public",79],["T_WHITESPACE"," ",79],["T_FUNCTION","function",79],["T_WHITESPACE"," ",79],["T_STRING","__toString",79],"(",")",["T_WHITESPACE"," ",79],"{",["T_WHITESPACE","\n    ",79],["T_COMMENT","\/\/ Nothing to do.\n",80],["T_WHITESPACE","  ",81],"}",["T_WHITESPACE","\n\n",81],"}",["T_WHITESPACE","\n",83]]