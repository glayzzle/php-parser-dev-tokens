[["T_OPEN_TAG","<?php\n",1],["T_WHITESPACE","\n",2],["T_NAMESPACE","namespace",3],["T_WHITESPACE"," ",3],["T_STRING","Drupal",3],["T_NS_SEPARATOR","\\",3],["T_STRING","image",3],["T_NS_SEPARATOR","\\",3],["T_STRING","Tests",3],";",["T_WHITESPACE","\n\n",3],["T_USE","use",5],["T_WHITESPACE"," ",5],["T_STRING","Drupal",5],["T_NS_SEPARATOR","\\",5],["T_STRING","image",5],["T_NS_SEPARATOR","\\",5],["T_STRING","Entity",5],["T_NS_SEPARATOR","\\",5],["T_STRING","ImageStyle",5],";",["T_WHITESPACE","\n",5],["T_USE","use",6],["T_WHITESPACE"," ",6],["T_STRING","Drupal",6],["T_NS_SEPARATOR","\\",6],["T_STRING","simpletest",6],["T_NS_SEPARATOR","\\",6],["T_STRING","WebTestBase",6],";",["T_WHITESPACE","\n\n",6],["T_DOC_COMMENT","\/**\n * Tests the functions for generating paths and URLs for image styles.\n *\n * @group image\n *\/",8],["T_WHITESPACE","\n",12],["T_CLASS","class",13],["T_WHITESPACE"," ",13],["T_STRING","ImageStylesPathAndUrlTest",13],["T_WHITESPACE"," ",13],["T_EXTENDS","extends",13],["T_WHITESPACE"," ",13],["T_STRING","WebTestBase",13],["T_WHITESPACE"," ",13],"{",["T_WHITESPACE","\n\n  ",13],["T_DOC_COMMENT","\/**\n   * Modules to enable.\n   *\n   * @var array\n   *\/",15],["T_WHITESPACE","\n  ",19],["T_PUBLIC","public",20],["T_WHITESPACE"," ",20],["T_STATIC","static",20],["T_WHITESPACE"," ",20],["T_VARIABLE","$modules",20],["T_WHITESPACE"," ",20],"=",["T_WHITESPACE"," ",20],["T_ARRAY","array",20],"(",["T_CONSTANT_ENCAPSED_STRING","'image'",20],",",["T_WHITESPACE"," ",20],["T_CONSTANT_ENCAPSED_STRING","'image_module_test'",20],")",";",["T_WHITESPACE","\n\n  ",20],["T_DOC_COMMENT","\/**\n   * @var \\Drupal\\image\\ImageStyleInterface\n   *\/",22],["T_WHITESPACE","\n  ",24],["T_PROTECTED","protected",25],["T_WHITESPACE"," ",25],["T_VARIABLE","$style",25],";",["T_WHITESPACE","\n\n  ",25],["T_PROTECTED","protected",27],["T_WHITESPACE"," ",27],["T_FUNCTION","function",27],["T_WHITESPACE"," ",27],["T_STRING","setUp",27],"(",")",["T_WHITESPACE"," ",27],"{",["T_WHITESPACE","\n    ",27],["T_STRING","parent",28],["T_DOUBLE_COLON","::",28],["T_STRING","setUp",28],"(",")",";",["T_WHITESPACE","\n\n    ",28],["T_VARIABLE","$this",30],["T_OBJECT_OPERATOR","->",30],["T_STRING","style",30],["T_WHITESPACE"," ",30],"=",["T_WHITESPACE"," ",30],["T_STRING","ImageStyle",30],["T_DOUBLE_COLON","::",30],["T_STRING","create",30],"(",["T_ARRAY","array",30],"(",["T_CONSTANT_ENCAPSED_STRING","'name'",30],["T_WHITESPACE"," ",30],["T_DOUBLE_ARROW","=>",30],["T_WHITESPACE"," ",30],["T_CONSTANT_ENCAPSED_STRING","'style_foo'",30],",",["T_WHITESPACE"," ",30],["T_CONSTANT_ENCAPSED_STRING","'label'",30],["T_WHITESPACE"," ",30],["T_DOUBLE_ARROW","=>",30],["T_WHITESPACE"," ",30],["T_VARIABLE","$this",30],["T_OBJECT_OPERATOR","->",30],["T_STRING","randomString",30],"(",")",")",")",";",["T_WHITESPACE","\n    ",30],["T_VARIABLE","$this",31],["T_OBJECT_OPERATOR","->",31],["T_STRING","style",31],["T_OBJECT_OPERATOR","->",31],["T_STRING","save",31],"(",")",";",["T_WHITESPACE","\n  ",31],"}",["T_WHITESPACE","\n\n  ",32],["T_DOC_COMMENT","\/**\n   * Tests \\Drupal\\image\\ImageStyleInterface::buildUri().\n   *\/",34],["T_WHITESPACE","\n  ",36],["T_FUNCTION","function",37],["T_WHITESPACE"," ",37],["T_STRING","testImageStylePath",37],"(",")",["T_WHITESPACE"," ",37],"{",["T_WHITESPACE","\n    ",37],["T_VARIABLE","$scheme",38],["T_WHITESPACE"," ",38],"=",["T_WHITESPACE"," ",38],["T_CONSTANT_ENCAPSED_STRING","'public'",38],";",["T_WHITESPACE","\n    ",38],["T_VARIABLE","$actual",39],["T_WHITESPACE"," ",39],"=",["T_WHITESPACE"," ",39],["T_VARIABLE","$this",39],["T_OBJECT_OPERATOR","->",39],["T_STRING","style",39],["T_OBJECT_OPERATOR","->",39],["T_STRING","buildUri",39],"(","\"",["T_VARIABLE","$scheme",39],["T_ENCAPSED_AND_WHITESPACE",":\/\/foo\/bar.gif",39],"\"",")",";",["T_WHITESPACE","\n    ",39],["T_VARIABLE","$expected",40],["T_WHITESPACE"," ",40],"=",["T_WHITESPACE"," ",40],"\"",["T_VARIABLE","$scheme",40],["T_ENCAPSED_AND_WHITESPACE",":\/\/styles\/",40],"\"",["T_WHITESPACE"," ",40],".",["T_WHITESPACE"," ",40],["T_VARIABLE","$this",40],["T_OBJECT_OPERATOR","->",40],["T_STRING","style",40],["T_OBJECT_OPERATOR","->",40],["T_STRING","id",40],"(",")",["T_WHITESPACE"," ",40],".",["T_WHITESPACE"," ",40],"\"",["T_ENCAPSED_AND_WHITESPACE","\/",40],["T_VARIABLE","$scheme",40],["T_ENCAPSED_AND_WHITESPACE","\/foo\/bar.gif",40],"\"",";",["T_WHITESPACE","\n    ",40],["T_VARIABLE","$this",41],["T_OBJECT_OPERATOR","->",41],["T_STRING","assertEqual",41],"(",["T_VARIABLE","$actual",41],",",["T_WHITESPACE"," ",41],["T_VARIABLE","$expected",41],",",["T_WHITESPACE"," ",41],["T_CONSTANT_ENCAPSED_STRING","'Got the path for a file URI.'",41],")",";",["T_WHITESPACE","\n\n    ",41],["T_VARIABLE","$actual",43],["T_WHITESPACE"," ",43],"=",["T_WHITESPACE"," ",43],["T_VARIABLE","$this",43],["T_OBJECT_OPERATOR","->",43],["T_STRING","style",43],["T_OBJECT_OPERATOR","->",43],["T_STRING","buildUri",43],"(",["T_CONSTANT_ENCAPSED_STRING","'foo\/bar.gif'",43],")",";",["T_WHITESPACE","\n    ",43],["T_VARIABLE","$expected",44],["T_WHITESPACE"," ",44],"=",["T_WHITESPACE"," ",44],"\"",["T_VARIABLE","$scheme",44],["T_ENCAPSED_AND_WHITESPACE",":\/\/styles\/",44],"\"",["T_WHITESPACE"," ",44],".",["T_WHITESPACE"," ",44],["T_VARIABLE","$this",44],["T_OBJECT_OPERATOR","->",44],["T_STRING","style",44],["T_OBJECT_OPERATOR","->",44],["T_STRING","id",44],"(",")",["T_WHITESPACE"," ",44],".",["T_WHITESPACE"," ",44],"\"",["T_ENCAPSED_AND_WHITESPACE","\/",44],["T_VARIABLE","$scheme",44],["T_ENCAPSED_AND_WHITESPACE","\/foo\/bar.gif",44],"\"",";",["T_WHITESPACE","\n    ",44],["T_VARIABLE","$this",45],["T_OBJECT_OPERATOR","->",45],["T_STRING","assertEqual",45],"(",["T_VARIABLE","$actual",45],",",["T_WHITESPACE"," ",45],["T_VARIABLE","$expected",45],",",["T_WHITESPACE"," ",45],["T_CONSTANT_ENCAPSED_STRING","'Got the path for a relative file path.'",45],")",";",["T_WHITESPACE","\n  ",45],"}",["T_WHITESPACE","\n\n  ",46],["T_DOC_COMMENT","\/**\n   * Tests an image style URL using the \"public:\/\/\" scheme.\n   *\/",48],["T_WHITESPACE","\n  ",50],["T_FUNCTION","function",51],["T_WHITESPACE"," ",51],["T_STRING","testImageStyleUrlAndPathPublic",51],"(",")",["T_WHITESPACE"," ",51],"{",["T_WHITESPACE","\n    ",51],["T_VARIABLE","$this",52],["T_OBJECT_OPERATOR","->",52],["T_STRING","doImageStyleUrlAndPathTests",52],"(",["T_CONSTANT_ENCAPSED_STRING","'public'",52],")",";",["T_WHITESPACE","\n  ",52],"}",["T_WHITESPACE","\n\n  ",53],["T_DOC_COMMENT","\/**\n   * Tests an image style URL using the \"private:\/\/\" scheme.\n   *\/",55],["T_WHITESPACE","\n  ",57],["T_FUNCTION","function",58],["T_WHITESPACE"," ",58],["T_STRING","testImageStyleUrlAndPathPrivate",58],"(",")",["T_WHITESPACE"," ",58],"{",["T_WHITESPACE","\n    ",58],["T_VARIABLE","$this",59],["T_OBJECT_OPERATOR","->",59],["T_STRING","doImageStyleUrlAndPathTests",59],"(",["T_CONSTANT_ENCAPSED_STRING","'private'",59],")",";",["T_WHITESPACE","\n  ",59],"}",["T_WHITESPACE","\n\n  ",60],["T_DOC_COMMENT","\/**\n   * Tests an image style URL with the \"public:\/\/\" scheme and unclean URLs.\n   *\/",62],["T_WHITESPACE","\n  ",64],["T_FUNCTION","function",65],["T_WHITESPACE"," ",65],["T_STRING","testImageStyleUrlAndPathPublicUnclean",65],"(",")",["T_WHITESPACE"," ",65],"{",["T_WHITESPACE","\n    ",65],["T_VARIABLE","$this",66],["T_OBJECT_OPERATOR","->",66],["T_STRING","doImageStyleUrlAndPathTests",66],"(",["T_CONSTANT_ENCAPSED_STRING","'public'",66],",",["T_WHITESPACE"," ",66],["T_STRING","FALSE",66],")",";",["T_WHITESPACE","\n  ",66],"}",["T_WHITESPACE","\n\n  ",67],["T_DOC_COMMENT","\/**\n   * Tests an image style URL with the \"private:\/\/\" schema and unclean URLs.\n   *\/",69],["T_WHITESPACE","\n  ",71],["T_FUNCTION","function",72],["T_WHITESPACE"," ",72],["T_STRING","testImageStyleUrlAndPathPrivateUnclean",72],"(",")",["T_WHITESPACE"," ",72],"{",["T_WHITESPACE","\n    ",72],["T_VARIABLE","$this",73],["T_OBJECT_OPERATOR","->",73],["T_STRING","doImageStyleUrlAndPathTests",73],"(",["T_CONSTANT_ENCAPSED_STRING","'private'",73],",",["T_WHITESPACE"," ",73],["T_STRING","FALSE",73],")",";",["T_WHITESPACE","\n  ",73],"}",["T_WHITESPACE","\n\n  ",74],["T_DOC_COMMENT","\/**\n   * Tests an image style URL with a file URL that has an extra slash in it.\n   *\/",76],["T_WHITESPACE","\n  ",78],["T_FUNCTION","function",79],["T_WHITESPACE"," ",79],["T_STRING","testImageStyleUrlExtraSlash",79],"(",")",["T_WHITESPACE"," ",79],"{",["T_WHITESPACE","\n    ",79],["T_VARIABLE","$this",80],["T_OBJECT_OPERATOR","->",80],["T_STRING","doImageStyleUrlAndPathTests",80],"(",["T_CONSTANT_ENCAPSED_STRING","'public'",80],",",["T_WHITESPACE"," ",80],["T_STRING","TRUE",80],",",["T_WHITESPACE"," ",80],["T_STRING","TRUE",80],")",";",["T_WHITESPACE","\n  ",80],"}",["T_WHITESPACE","\n\n  ",81],["T_DOC_COMMENT","\/**\n   * Tests that an invalid source image returns a 404.\n   *\/",83],["T_WHITESPACE","\n  ",85],["T_FUNCTION","function",86],["T_WHITESPACE"," ",86],["T_STRING","testImageStyleUrlForMissingSourceImage",86],"(",")",["T_WHITESPACE"," ",86],"{",["T_WHITESPACE","\n    ",86],["T_VARIABLE","$non_existent_uri",87],["T_WHITESPACE"," ",87],"=",["T_WHITESPACE"," ",87],["T_CONSTANT_ENCAPSED_STRING","'public:\/\/foo.png'",87],";",["T_WHITESPACE","\n    ",87],["T_VARIABLE","$generated_url",88],["T_WHITESPACE"," ",88],"=",["T_WHITESPACE"," ",88],["T_VARIABLE","$this",88],["T_OBJECT_OPERATOR","->",88],["T_STRING","style",88],["T_OBJECT_OPERATOR","->",88],["T_STRING","buildUrl",88],"(",["T_VARIABLE","$non_existent_uri",88],")",";",["T_WHITESPACE","\n    ",88],["T_VARIABLE","$this",89],["T_OBJECT_OPERATOR","->",89],["T_STRING","drupalGet",89],"(",["T_VARIABLE","$generated_url",89],")",";",["T_WHITESPACE","\n    ",89],["T_VARIABLE","$this",90],["T_OBJECT_OPERATOR","->",90],["T_STRING","assertResponse",90],"(",["T_LNUMBER","404",90],",",["T_WHITESPACE"," ",90],["T_CONSTANT_ENCAPSED_STRING","'Accessing an image style URL with a source image that does not exist provides a 404 error response.'",90],")",";",["T_WHITESPACE","\n  ",90],"}",["T_WHITESPACE","\n\n  ",91],["T_DOC_COMMENT","\/**\n   * Tests building an image style URL.\n   *\/",93],["T_WHITESPACE","\n  ",95],["T_FUNCTION","function",96],["T_WHITESPACE"," ",96],["T_STRING","doImageStyleUrlAndPathTests",96],"(",["T_VARIABLE","$scheme",96],",",["T_WHITESPACE"," ",96],["T_VARIABLE","$clean_url",96],["T_WHITESPACE"," ",96],"=",["T_WHITESPACE"," ",96],["T_STRING","TRUE",96],",",["T_WHITESPACE"," ",96],["T_VARIABLE","$extra_slash",96],["T_WHITESPACE"," ",96],"=",["T_WHITESPACE"," ",96],["T_STRING","FALSE",96],")",["T_WHITESPACE"," ",96],"{",["T_WHITESPACE","\n    ",96],["T_VARIABLE","$this",97],["T_OBJECT_OPERATOR","->",97],["T_STRING","prepareRequestForGenerator",97],"(",["T_VARIABLE","$clean_url",97],")",";",["T_WHITESPACE","\n\n    ",97],["T_COMMENT","\/\/ Make the default scheme neither \"public\" nor \"private\" to verify the\n",99],["T_WHITESPACE","    ",100],["T_COMMENT","\/\/ functions work for other than the default scheme.\n",100],["T_WHITESPACE","    ",101],["T_VARIABLE","$this",101],["T_OBJECT_OPERATOR","->",101],["T_STRING","config",101],"(",["T_CONSTANT_ENCAPSED_STRING","'system.file'",101],")",["T_OBJECT_OPERATOR","->",101],["T_STRING","set",101],"(",["T_CONSTANT_ENCAPSED_STRING","'default_scheme'",101],",",["T_WHITESPACE"," ",101],["T_CONSTANT_ENCAPSED_STRING","'temporary'",101],")",["T_OBJECT_OPERATOR","->",101],["T_STRING","save",101],"(",")",";",["T_WHITESPACE","\n\n    ",101],["T_COMMENT","\/\/ Create the directories for the styles.\n",103],["T_WHITESPACE","    ",104],["T_VARIABLE","$directory",104],["T_WHITESPACE"," ",104],"=",["T_WHITESPACE"," ",104],["T_VARIABLE","$scheme",104],["T_WHITESPACE"," ",104],".",["T_WHITESPACE"," ",104],["T_CONSTANT_ENCAPSED_STRING","':\/\/styles\/'",104],["T_WHITESPACE"," ",104],".",["T_WHITESPACE"," ",104],["T_VARIABLE","$this",104],["T_OBJECT_OPERATOR","->",104],["T_STRING","style",104],["T_OBJECT_OPERATOR","->",104],["T_STRING","id",104],"(",")",";",["T_WHITESPACE","\n    ",104],["T_VARIABLE","$status",105],["T_WHITESPACE"," ",105],"=",["T_WHITESPACE"," ",105],["T_STRING","file_prepare_directory",105],"(",["T_VARIABLE","$directory",105],",",["T_WHITESPACE"," ",105],["T_STRING","FILE_CREATE_DIRECTORY",105],")",";",["T_WHITESPACE","\n    ",105],["T_VARIABLE","$this",106],["T_OBJECT_OPERATOR","->",106],["T_STRING","assertNotIdentical",106],"(",["T_STRING","FALSE",106],",",["T_WHITESPACE"," ",106],["T_VARIABLE","$status",106],",",["T_WHITESPACE"," ",106],["T_CONSTANT_ENCAPSED_STRING","'Created the directory for the generated images for the test style.'",106],")",";",["T_WHITESPACE","\n\n    ",106],["T_COMMENT","\/\/ Create a working copy of the file.\n",108],["T_WHITESPACE","    ",109],["T_VARIABLE","$files",109],["T_WHITESPACE"," ",109],"=",["T_WHITESPACE"," ",109],["T_VARIABLE","$this",109],["T_OBJECT_OPERATOR","->",109],["T_STRING","drupalGetTestFiles",109],"(",["T_CONSTANT_ENCAPSED_STRING","'image'",109],")",";",["T_WHITESPACE","\n    ",109],["T_VARIABLE","$file",110],["T_WHITESPACE"," ",110],"=",["T_WHITESPACE"," ",110],["T_STRING","array_shift",110],"(",["T_VARIABLE","$files",110],")",";",["T_WHITESPACE","\n    ",110],["T_VARIABLE","$original_uri",111],["T_WHITESPACE"," ",111],"=",["T_WHITESPACE"," ",111],["T_STRING","file_unmanaged_copy",111],"(",["T_VARIABLE","$file",111],["T_OBJECT_OPERATOR","->",111],["T_STRING","uri",111],",",["T_WHITESPACE"," ",111],["T_VARIABLE","$scheme",111],["T_WHITESPACE"," ",111],".",["T_WHITESPACE"," ",111],["T_CONSTANT_ENCAPSED_STRING","':\/\/'",111],",",["T_WHITESPACE"," ",111],["T_STRING","FILE_EXISTS_RENAME",111],")",";",["T_WHITESPACE","\n    ",111],["T_COMMENT","\/\/ Let the image_module_test module know about this file, so it can claim\n",112],["T_WHITESPACE","    ",113],["T_COMMENT","\/\/ ownership in hook_file_download().\n",113],["T_WHITESPACE","    ",114],["T_NS_SEPARATOR","\\",114],["T_STRING","Drupal",114],["T_DOUBLE_COLON","::",114],["T_STRING","state",114],"(",")",["T_OBJECT_OPERATOR","->",114],["T_STRING","set",114],"(",["T_CONSTANT_ENCAPSED_STRING","'image.test_file_download'",114],",",["T_WHITESPACE"," ",114],["T_VARIABLE","$original_uri",114],")",";",["T_WHITESPACE","\n    ",114],["T_VARIABLE","$this",115],["T_OBJECT_OPERATOR","->",115],["T_STRING","assertNotIdentical",115],"(",["T_STRING","FALSE",115],",",["T_WHITESPACE"," ",115],["T_VARIABLE","$original_uri",115],",",["T_WHITESPACE"," ",115],["T_CONSTANT_ENCAPSED_STRING","'Created the generated image file.'",115],")",";",["T_WHITESPACE","\n\n    ",115],["T_COMMENT","\/\/ Get the URL of a file that has not been generated and try to create it.\n",117],["T_WHITESPACE","    ",118],["T_VARIABLE","$generated_uri",118],["T_WHITESPACE"," ",118],"=",["T_WHITESPACE"," ",118],["T_VARIABLE","$this",118],["T_OBJECT_OPERATOR","->",118],["T_STRING","style",118],["T_OBJECT_OPERATOR","->",118],["T_STRING","buildUri",118],"(",["T_VARIABLE","$original_uri",118],")",";",["T_WHITESPACE","\n    ",118],["T_VARIABLE","$this",119],["T_OBJECT_OPERATOR","->",119],["T_STRING","assertFalse",119],"(",["T_STRING","file_exists",119],"(",["T_VARIABLE","$generated_uri",119],")",",",["T_WHITESPACE"," ",119],["T_CONSTANT_ENCAPSED_STRING","'Generated file does not exist.'",119],")",";",["T_WHITESPACE","\n    ",119],["T_VARIABLE","$generate_url",120],["T_WHITESPACE"," ",120],"=",["T_WHITESPACE"," ",120],["T_VARIABLE","$this",120],["T_OBJECT_OPERATOR","->",120],["T_STRING","style",120],["T_OBJECT_OPERATOR","->",120],["T_STRING","buildUrl",120],"(",["T_VARIABLE","$original_uri",120],",",["T_WHITESPACE"," ",120],["T_VARIABLE","$clean_url",120],")",";",["T_WHITESPACE","\n\n    ",120],["T_COMMENT","\/\/ Ensure that the tests still pass when the file is generated by accessing\n",122],["T_WHITESPACE","    ",123],["T_COMMENT","\/\/ a poorly constructed (but still valid) file URL that has an extra slash\n",123],["T_WHITESPACE","    ",124],["T_COMMENT","\/\/ in it.\n",124],["T_WHITESPACE","    ",125],["T_IF","if",125],["T_WHITESPACE"," ",125],"(",["T_VARIABLE","$extra_slash",125],")",["T_WHITESPACE"," ",125],"{",["T_WHITESPACE","\n      ",125],["T_VARIABLE","$modified_uri",126],["T_WHITESPACE"," ",126],"=",["T_WHITESPACE"," ",126],["T_STRING","str_replace",126],"(",["T_CONSTANT_ENCAPSED_STRING","':\/\/'",126],",",["T_WHITESPACE"," ",126],["T_CONSTANT_ENCAPSED_STRING","':\/\/\/'",126],",",["T_WHITESPACE"," ",126],["T_VARIABLE","$original_uri",126],")",";",["T_WHITESPACE","\n      ",126],["T_VARIABLE","$this",127],["T_OBJECT_OPERATOR","->",127],["T_STRING","assertNotEqual",127],"(",["T_VARIABLE","$original_uri",127],",",["T_WHITESPACE"," ",127],["T_VARIABLE","$modified_uri",127],",",["T_WHITESPACE"," ",127],["T_CONSTANT_ENCAPSED_STRING","'An extra slash was added to the generated file URI.'",127],")",";",["T_WHITESPACE","\n      ",127],["T_VARIABLE","$generate_url",128],["T_WHITESPACE"," ",128],"=",["T_WHITESPACE"," ",128],["T_VARIABLE","$this",128],["T_OBJECT_OPERATOR","->",128],["T_STRING","style",128],["T_OBJECT_OPERATOR","->",128],["T_STRING","buildUrl",128],"(",["T_VARIABLE","$modified_uri",128],",",["T_WHITESPACE"," ",128],["T_VARIABLE","$clean_url",128],")",";",["T_WHITESPACE","\n    ",128],"}",["T_WHITESPACE","\n    ",129],["T_IF","if",130],["T_WHITESPACE"," ",130],"(","!",["T_VARIABLE","$clean_url",130],")",["T_WHITESPACE"," ",130],"{",["T_WHITESPACE","\n      ",130],["T_VARIABLE","$this",131],["T_OBJECT_OPERATOR","->",131],["T_STRING","assertTrue",131],"(",["T_STRING","strpos",131],"(",["T_VARIABLE","$generate_url",131],",",["T_WHITESPACE"," ",131],["T_CONSTANT_ENCAPSED_STRING","'index.php\/'",131],")",["T_WHITESPACE"," ",131],["T_IS_NOT_IDENTICAL","!==",131],["T_WHITESPACE"," ",131],["T_STRING","FALSE",131],",",["T_WHITESPACE"," ",131],["T_CONSTANT_ENCAPSED_STRING","'When using non-clean URLS, the system path contains the script name.'",131],")",";",["T_WHITESPACE","\n    ",131],"}",["T_WHITESPACE","\n    ",132],["T_COMMENT","\/\/ Add some extra chars to the token.\n",133],["T_WHITESPACE","    ",134],["T_VARIABLE","$this",134],["T_OBJECT_OPERATOR","->",134],["T_STRING","drupalGet",134],"(",["T_STRING","str_replace",134],"(",["T_STRING","IMAGE_DERIVATIVE_TOKEN",134],["T_WHITESPACE"," ",134],".",["T_WHITESPACE"," ",134],["T_CONSTANT_ENCAPSED_STRING","'='",134],",",["T_WHITESPACE"," ",134],["T_STRING","IMAGE_DERIVATIVE_TOKEN",134],["T_WHITESPACE"," ",134],".",["T_WHITESPACE"," ",134],["T_CONSTANT_ENCAPSED_STRING","'=Zo'",134],",",["T_WHITESPACE"," ",134],["T_VARIABLE","$generate_url",134],")",")",";",["T_WHITESPACE","\n    ",134],["T_VARIABLE","$this",135],["T_OBJECT_OPERATOR","->",135],["T_STRING","assertResponse",135],"(",["T_LNUMBER","403",135],",",["T_WHITESPACE"," ",135],["T_CONSTANT_ENCAPSED_STRING","'Image was inaccessible at the URL with an invalid token.'",135],")",";",["T_WHITESPACE","\n    ",135],["T_COMMENT","\/\/ Change the parameter name so the token is missing.\n",136],["T_WHITESPACE","    ",137],["T_VARIABLE","$this",137],["T_OBJECT_OPERATOR","->",137],["T_STRING","drupalGet",137],"(",["T_STRING","str_replace",137],"(",["T_STRING","IMAGE_DERIVATIVE_TOKEN",137],["T_WHITESPACE"," ",137],".",["T_WHITESPACE"," ",137],["T_CONSTANT_ENCAPSED_STRING","'='",137],",",["T_WHITESPACE"," ",137],["T_CONSTANT_ENCAPSED_STRING","'wrongparam='",137],",",["T_WHITESPACE"," ",137],["T_VARIABLE","$generate_url",137],")",")",";",["T_WHITESPACE","\n    ",137],["T_VARIABLE","$this",138],["T_OBJECT_OPERATOR","->",138],["T_STRING","assertResponse",138],"(",["T_LNUMBER","403",138],",",["T_WHITESPACE"," ",138],["T_CONSTANT_ENCAPSED_STRING","'Image was inaccessible at the URL with a missing token.'",138],")",";",["T_WHITESPACE","\n\n    ",138],["T_COMMENT","\/\/ Check that the generated URL is the same when we pass in a relative path\n",140],["T_WHITESPACE","    ",141],["T_COMMENT","\/\/ rather than a URI. We need to temporarily switch the default scheme to\n",141],["T_WHITESPACE","    ",142],["T_COMMENT","\/\/ match the desired scheme before testing this, then switch it back to the\n",142],["T_WHITESPACE","    ",143],["T_COMMENT","\/\/ \"temporary\" scheme used throughout this test afterwards.\n",143],["T_WHITESPACE","    ",144],["T_VARIABLE","$this",144],["T_OBJECT_OPERATOR","->",144],["T_STRING","config",144],"(",["T_CONSTANT_ENCAPSED_STRING","'system.file'",144],")",["T_OBJECT_OPERATOR","->",144],["T_STRING","set",144],"(",["T_CONSTANT_ENCAPSED_STRING","'default_scheme'",144],",",["T_WHITESPACE"," ",144],["T_VARIABLE","$scheme",144],")",["T_OBJECT_OPERATOR","->",144],["T_STRING","save",144],"(",")",";",["T_WHITESPACE","\n    ",144],["T_VARIABLE","$relative_path",145],["T_WHITESPACE"," ",145],"=",["T_WHITESPACE"," ",145],["T_STRING","file_uri_target",145],"(",["T_VARIABLE","$original_uri",145],")",";",["T_WHITESPACE","\n    ",145],["T_VARIABLE","$generate_url_from_relative_path",146],["T_WHITESPACE"," ",146],"=",["T_WHITESPACE"," ",146],["T_VARIABLE","$this",146],["T_OBJECT_OPERATOR","->",146],["T_STRING","style",146],["T_OBJECT_OPERATOR","->",146],["T_STRING","buildUrl",146],"(",["T_VARIABLE","$relative_path",146],",",["T_WHITESPACE"," ",146],["T_VARIABLE","$clean_url",146],")",";",["T_WHITESPACE","\n    ",146],["T_VARIABLE","$this",147],["T_OBJECT_OPERATOR","->",147],["T_STRING","assertEqual",147],"(",["T_VARIABLE","$generate_url",147],",",["T_WHITESPACE"," ",147],["T_VARIABLE","$generate_url_from_relative_path",147],")",";",["T_WHITESPACE","\n    ",147],["T_VARIABLE","$this",148],["T_OBJECT_OPERATOR","->",148],["T_STRING","config",148],"(",["T_CONSTANT_ENCAPSED_STRING","'system.file'",148],")",["T_OBJECT_OPERATOR","->",148],["T_STRING","set",148],"(",["T_CONSTANT_ENCAPSED_STRING","'default_scheme'",148],",",["T_WHITESPACE"," ",148],["T_CONSTANT_ENCAPSED_STRING","'temporary'",148],")",["T_OBJECT_OPERATOR","->",148],["T_STRING","save",148],"(",")",";",["T_WHITESPACE","\n\n    ",148],["T_COMMENT","\/\/ Fetch the URL that generates the file.\n",150],["T_WHITESPACE","    ",151],["T_VARIABLE","$this",151],["T_OBJECT_OPERATOR","->",151],["T_STRING","drupalGet",151],"(",["T_VARIABLE","$generate_url",151],")",";",["T_WHITESPACE","\n    ",151],["T_VARIABLE","$this",152],["T_OBJECT_OPERATOR","->",152],["T_STRING","assertResponse",152],"(",["T_LNUMBER","200",152],",",["T_WHITESPACE"," ",152],["T_CONSTANT_ENCAPSED_STRING","'Image was generated at the URL.'",152],")",";",["T_WHITESPACE","\n    ",152],["T_VARIABLE","$this",153],["T_OBJECT_OPERATOR","->",153],["T_STRING","assertTrue",153],"(",["T_STRING","file_exists",153],"(",["T_VARIABLE","$generated_uri",153],")",",",["T_WHITESPACE"," ",153],["T_CONSTANT_ENCAPSED_STRING","'Generated file does exist after we accessed it.'",153],")",";",["T_WHITESPACE","\n    ",153],["T_VARIABLE","$this",154],["T_OBJECT_OPERATOR","->",154],["T_STRING","assertRaw",154],"(",["T_STRING","file_get_contents",154],"(",["T_VARIABLE","$generated_uri",154],")",",",["T_WHITESPACE"," ",154],["T_CONSTANT_ENCAPSED_STRING","'URL returns expected file.'",154],")",";",["T_WHITESPACE","\n    ",154],["T_VARIABLE","$image",155],["T_WHITESPACE"," ",155],"=",["T_WHITESPACE"," ",155],["T_VARIABLE","$this",155],["T_OBJECT_OPERATOR","->",155],["T_STRING","container",155],["T_OBJECT_OPERATOR","->",155],["T_STRING","get",155],"(",["T_CONSTANT_ENCAPSED_STRING","'image.factory'",155],")",["T_OBJECT_OPERATOR","->",155],["T_STRING","get",155],"(",["T_VARIABLE","$generated_uri",155],")",";",["T_WHITESPACE","\n    ",155],["T_VARIABLE","$this",156],["T_OBJECT_OPERATOR","->",156],["T_STRING","assertEqual",156],"(",["T_VARIABLE","$this",156],["T_OBJECT_OPERATOR","->",156],["T_STRING","drupalGetHeader",156],"(",["T_CONSTANT_ENCAPSED_STRING","'Content-Type'",156],")",",",["T_WHITESPACE"," ",156],["T_VARIABLE","$image",156],["T_OBJECT_OPERATOR","->",156],["T_STRING","getMimeType",156],"(",")",",",["T_WHITESPACE"," ",156],["T_CONSTANT_ENCAPSED_STRING","'Expected Content-Type was reported.'",156],")",";",["T_WHITESPACE","\n    ",156],["T_VARIABLE","$this",157],["T_OBJECT_OPERATOR","->",157],["T_STRING","assertEqual",157],"(",["T_VARIABLE","$this",157],["T_OBJECT_OPERATOR","->",157],["T_STRING","drupalGetHeader",157],"(",["T_CONSTANT_ENCAPSED_STRING","'Content-Length'",157],")",",",["T_WHITESPACE"," ",157],["T_VARIABLE","$image",157],["T_OBJECT_OPERATOR","->",157],["T_STRING","getFileSize",157],"(",")",",",["T_WHITESPACE"," ",157],["T_CONSTANT_ENCAPSED_STRING","'Expected Content-Length was reported.'",157],")",";",["T_WHITESPACE","\n\n    ",157],["T_COMMENT","\/\/ Check that we did not download the original file.\n",159],["T_WHITESPACE","    ",160],["T_VARIABLE","$original_image",160],["T_WHITESPACE"," ",160],"=",["T_WHITESPACE"," ",160],["T_VARIABLE","$this",160],["T_OBJECT_OPERATOR","->",160],["T_STRING","container",160],["T_OBJECT_OPERATOR","->",160],["T_STRING","get",160],"(",["T_CONSTANT_ENCAPSED_STRING","'image.factory'",160],")",["T_OBJECT_OPERATOR","->",160],["T_STRING","get",160],"(",["T_VARIABLE","$original_uri",160],")",";",["T_WHITESPACE","\n    ",160],["T_VARIABLE","$this",161],["T_OBJECT_OPERATOR","->",161],["T_STRING","assertNotEqual",161],"(",["T_VARIABLE","$this",161],["T_OBJECT_OPERATOR","->",161],["T_STRING","drupalGetHeader",161],"(",["T_CONSTANT_ENCAPSED_STRING","'Content-Length'",161],")",",",["T_WHITESPACE"," ",161],["T_VARIABLE","$original_image",161],["T_OBJECT_OPERATOR","->",161],["T_STRING","getFileSize",161],"(",")",")",";",["T_WHITESPACE","\n\n    ",161],["T_IF","if",163],["T_WHITESPACE"," ",163],"(",["T_VARIABLE","$scheme",163],["T_WHITESPACE"," ",163],["T_IS_EQUAL","==",163],["T_WHITESPACE"," ",163],["T_CONSTANT_ENCAPSED_STRING","'private'",163],")",["T_WHITESPACE"," ",163],"{",["T_WHITESPACE","\n      ",163],["T_VARIABLE","$this",164],["T_OBJECT_OPERATOR","->",164],["T_STRING","assertEqual",164],"(",["T_VARIABLE","$this",164],["T_OBJECT_OPERATOR","->",164],["T_STRING","drupalGetHeader",164],"(",["T_CONSTANT_ENCAPSED_STRING","'Expires'",164],")",",",["T_WHITESPACE"," ",164],["T_CONSTANT_ENCAPSED_STRING","'Sun, 19 Nov 1978 05:00:00 GMT'",164],",",["T_WHITESPACE"," ",164],["T_CONSTANT_ENCAPSED_STRING","'Expires header was sent.'",164],")",";",["T_WHITESPACE","\n      ",164],["T_VARIABLE","$this",165],["T_OBJECT_OPERATOR","->",165],["T_STRING","assertNotEqual",165],"(",["T_STRING","strpos",165],"(",["T_VARIABLE","$this",165],["T_OBJECT_OPERATOR","->",165],["T_STRING","drupalGetHeader",165],"(",["T_CONSTANT_ENCAPSED_STRING","'Cache-Control'",165],")",",",["T_WHITESPACE"," ",165],["T_CONSTANT_ENCAPSED_STRING","'no-cache'",165],")",",",["T_WHITESPACE"," ",165],["T_STRING","FALSE",165],",",["T_WHITESPACE"," ",165],["T_CONSTANT_ENCAPSED_STRING","'Cache-Control header contains \\'no-cache\\' to prevent caching.'",165],")",";",["T_WHITESPACE","\n      ",165],["T_VARIABLE","$this",166],["T_OBJECT_OPERATOR","->",166],["T_STRING","assertEqual",166],"(",["T_VARIABLE","$this",166],["T_OBJECT_OPERATOR","->",166],["T_STRING","drupalGetHeader",166],"(",["T_CONSTANT_ENCAPSED_STRING","'X-Image-Owned-By'",166],")",",",["T_WHITESPACE"," ",166],["T_CONSTANT_ENCAPSED_STRING","'image_module_test'",166],",",["T_WHITESPACE"," ",166],["T_CONSTANT_ENCAPSED_STRING","'Expected custom header has been added.'",166],")",";",["T_WHITESPACE","\n\n      ",166],["T_COMMENT","\/\/ Make sure that a second request to the already existing derivative\n",168],["T_WHITESPACE","      ",169],["T_COMMENT","\/\/ works too.\n",169],["T_WHITESPACE","      ",170],["T_VARIABLE","$this",170],["T_OBJECT_OPERATOR","->",170],["T_STRING","drupalGet",170],"(",["T_VARIABLE","$generate_url",170],")",";",["T_WHITESPACE","\n      ",170],["T_VARIABLE","$this",171],["T_OBJECT_OPERATOR","->",171],["T_STRING","assertResponse",171],"(",["T_LNUMBER","200",171],",",["T_WHITESPACE"," ",171],["T_CONSTANT_ENCAPSED_STRING","'Image was generated at the URL.'",171],")",";",["T_WHITESPACE","\n\n      ",171],["T_COMMENT","\/\/ Check that the second request also returned the generated image.\n",173],["T_WHITESPACE","      ",174],["T_VARIABLE","$this",174],["T_OBJECT_OPERATOR","->",174],["T_STRING","assertEqual",174],"(",["T_VARIABLE","$this",174],["T_OBJECT_OPERATOR","->",174],["T_STRING","drupalGetHeader",174],"(",["T_CONSTANT_ENCAPSED_STRING","'Content-Length'",174],")",",",["T_WHITESPACE"," ",174],["T_VARIABLE","$image",174],["T_OBJECT_OPERATOR","->",174],["T_STRING","getFileSize",174],"(",")",")",";",["T_WHITESPACE","\n\n      ",174],["T_COMMENT","\/\/ Check that we did not download the original file.\n",176],["T_WHITESPACE","      ",177],["T_VARIABLE","$this",177],["T_OBJECT_OPERATOR","->",177],["T_STRING","assertNotEqual",177],"(",["T_VARIABLE","$this",177],["T_OBJECT_OPERATOR","->",177],["T_STRING","drupalGetHeader",177],"(",["T_CONSTANT_ENCAPSED_STRING","'Content-Length'",177],")",",",["T_WHITESPACE"," ",177],["T_VARIABLE","$original_image",177],["T_OBJECT_OPERATOR","->",177],["T_STRING","getFileSize",177],"(",")",")",";",["T_WHITESPACE","\n\n      ",177],["T_COMMENT","\/\/ Make sure that access is denied for existing style files if we do not\n",179],["T_WHITESPACE","      ",180],["T_COMMENT","\/\/ have access.\n",180],["T_WHITESPACE","      ",181],["T_NS_SEPARATOR","\\",181],["T_STRING","Drupal",181],["T_DOUBLE_COLON","::",181],["T_STRING","state",181],"(",")",["T_OBJECT_OPERATOR","->",181],["T_STRING","delete",181],"(",["T_CONSTANT_ENCAPSED_STRING","'image.test_file_download'",181],")",";",["T_WHITESPACE","\n      ",181],["T_VARIABLE","$this",182],["T_OBJECT_OPERATOR","->",182],["T_STRING","drupalGet",182],"(",["T_VARIABLE","$generate_url",182],")",";",["T_WHITESPACE","\n      ",182],["T_VARIABLE","$this",183],["T_OBJECT_OPERATOR","->",183],["T_STRING","assertResponse",183],"(",["T_LNUMBER","403",183],",",["T_WHITESPACE"," ",183],["T_CONSTANT_ENCAPSED_STRING","'Confirmed that access is denied for the private image style.'",183],")",";",["T_WHITESPACE","\n\n      ",183],["T_COMMENT","\/\/ Repeat this with a different file that we do not have access to and\n",185],["T_WHITESPACE","      ",186],["T_COMMENT","\/\/ make sure that access is denied.\n",186],["T_WHITESPACE","      ",187],["T_VARIABLE","$file_noaccess",187],["T_WHITESPACE"," ",187],"=",["T_WHITESPACE"," ",187],["T_STRING","array_shift",187],"(",["T_VARIABLE","$files",187],")",";",["T_WHITESPACE","\n      ",187],["T_VARIABLE","$original_uri_noaccess",188],["T_WHITESPACE"," ",188],"=",["T_WHITESPACE"," ",188],["T_STRING","file_unmanaged_copy",188],"(",["T_VARIABLE","$file_noaccess",188],["T_OBJECT_OPERATOR","->",188],["T_STRING","uri",188],",",["T_WHITESPACE"," ",188],["T_VARIABLE","$scheme",188],["T_WHITESPACE"," ",188],".",["T_WHITESPACE"," ",188],["T_CONSTANT_ENCAPSED_STRING","':\/\/'",188],",",["T_WHITESPACE"," ",188],["T_STRING","FILE_EXISTS_RENAME",188],")",";",["T_WHITESPACE","\n      ",188],["T_VARIABLE","$generated_uri_noaccess",189],["T_WHITESPACE"," ",189],"=",["T_WHITESPACE"," ",189],["T_VARIABLE","$scheme",189],["T_WHITESPACE"," ",189],".",["T_WHITESPACE"," ",189],["T_CONSTANT_ENCAPSED_STRING","':\/\/styles\/'",189],["T_WHITESPACE"," ",189],".",["T_WHITESPACE"," ",189],["T_VARIABLE","$this",189],["T_OBJECT_OPERATOR","->",189],["T_STRING","style",189],["T_OBJECT_OPERATOR","->",189],["T_STRING","id",189],"(",")",["T_WHITESPACE"," ",189],".",["T_WHITESPACE"," ",189],["T_CONSTANT_ENCAPSED_STRING","'\/'",189],["T_WHITESPACE"," ",189],".",["T_WHITESPACE"," ",189],["T_VARIABLE","$scheme",189],["T_WHITESPACE"," ",189],".",["T_WHITESPACE"," ",189],["T_CONSTANT_ENCAPSED_STRING","'\/'",189],["T_WHITESPACE"," ",189],".",["T_WHITESPACE"," ",189],["T_STRING","drupal_basename",189],"(",["T_VARIABLE","$original_uri_noaccess",189],")",";",["T_WHITESPACE","\n      ",189],["T_VARIABLE","$this",190],["T_OBJECT_OPERATOR","->",190],["T_STRING","assertFalse",190],"(",["T_STRING","file_exists",190],"(",["T_VARIABLE","$generated_uri_noaccess",190],")",",",["T_WHITESPACE"," ",190],["T_CONSTANT_ENCAPSED_STRING","'Generated file does not exist.'",190],")",";",["T_WHITESPACE","\n      ",190],["T_VARIABLE","$generate_url_noaccess",191],["T_WHITESPACE"," ",191],"=",["T_WHITESPACE"," ",191],["T_VARIABLE","$this",191],["T_OBJECT_OPERATOR","->",191],["T_STRING","style",191],["T_OBJECT_OPERATOR","->",191],["T_STRING","buildUrl",191],"(",["T_VARIABLE","$original_uri_noaccess",191],")",";",["T_WHITESPACE","\n\n      ",191],["T_VARIABLE","$this",193],["T_OBJECT_OPERATOR","->",193],["T_STRING","drupalGet",193],"(",["T_VARIABLE","$generate_url_noaccess",193],")",";",["T_WHITESPACE","\n      ",193],["T_VARIABLE","$this",194],["T_OBJECT_OPERATOR","->",194],["T_STRING","assertResponse",194],"(",["T_LNUMBER","403",194],",",["T_WHITESPACE"," ",194],["T_CONSTANT_ENCAPSED_STRING","'Confirmed that access is denied for the private image style.'",194],")",";",["T_WHITESPACE","\n      ",194],["T_COMMENT","\/\/ Verify that images are not appended to the response. Currently this test only uses PNG images.\n",195],["T_WHITESPACE","      ",196],["T_IF","if",196],["T_WHITESPACE"," ",196],"(",["T_STRING","strpos",196],"(",["T_VARIABLE","$generate_url",196],",",["T_WHITESPACE"," ",196],["T_CONSTANT_ENCAPSED_STRING","'.png'",196],")",["T_WHITESPACE"," ",196],["T_IS_IDENTICAL","===",196],["T_WHITESPACE"," ",196],["T_STRING","FALSE",196],["T_WHITESPACE"," ",196],")",["T_WHITESPACE"," ",196],"{",["T_WHITESPACE","\n        ",196],["T_VARIABLE","$this",197],["T_OBJECT_OPERATOR","->",197],["T_STRING","fail",197],"(",["T_CONSTANT_ENCAPSED_STRING","'Confirming that private image styles are not appended require PNG file.'",197],")",";",["T_WHITESPACE","\n      ",197],"}",["T_WHITESPACE","\n      ",198],["T_ELSE","else",199],["T_WHITESPACE"," ",199],"{",["T_WHITESPACE","\n        ",199],["T_COMMENT","\/\/ Check for PNG-Signature (cf. http:\/\/www.libpng.org\/pub\/png\/book\/chapter08.html#png.ch08.div.2) in the\n",200],["T_WHITESPACE","        ",201],["T_COMMENT","\/\/ response body.\n",201],["T_WHITESPACE","        ",202],["T_VARIABLE","$this",202],["T_OBJECT_OPERATOR","->",202],["T_STRING","assertNoRaw",202],"(",["T_WHITESPACE"," ",202],["T_STRING","chr",202],"(",["T_LNUMBER","137",202],")",["T_WHITESPACE"," ",202],".",["T_WHITESPACE"," ",202],["T_STRING","chr",202],"(",["T_LNUMBER","80",202],")",["T_WHITESPACE"," ",202],".",["T_WHITESPACE"," ",202],["T_STRING","chr",202],"(",["T_LNUMBER","78",202],")",["T_WHITESPACE"," ",202],".",["T_WHITESPACE"," ",202],["T_STRING","chr",202],"(",["T_LNUMBER","71",202],")",["T_WHITESPACE"," ",202],".",["T_WHITESPACE"," ",202],["T_STRING","chr",202],"(",["T_LNUMBER","13",202],")",["T_WHITESPACE"," ",202],".",["T_WHITESPACE"," ",202],["T_STRING","chr",202],"(",["T_LNUMBER","10",202],")",["T_WHITESPACE"," ",202],".",["T_WHITESPACE"," ",202],["T_STRING","chr",202],"(",["T_LNUMBER","26",202],")",["T_WHITESPACE"," ",202],".",["T_WHITESPACE"," ",202],["T_STRING","chr",202],"(",["T_LNUMBER","10",202],")",",",["T_WHITESPACE"," ",202],["T_CONSTANT_ENCAPSED_STRING","'No PNG signature found in the response body.'",202],")",";",["T_WHITESPACE","\n      ",202],"}",["T_WHITESPACE","\n    ",203],"}",["T_WHITESPACE","\n    ",204],["T_ELSE","else",205],["T_WHITESPACE"," ",205],"{",["T_WHITESPACE","\n      ",205],["T_VARIABLE","$this",206],["T_OBJECT_OPERATOR","->",206],["T_STRING","assertEqual",206],"(",["T_VARIABLE","$this",206],["T_OBJECT_OPERATOR","->",206],["T_STRING","drupalGetHeader",206],"(",["T_CONSTANT_ENCAPSED_STRING","'Expires'",206],")",",",["T_WHITESPACE"," ",206],["T_CONSTANT_ENCAPSED_STRING","'Sun, 19 Nov 1978 05:00:00 GMT'",206],",",["T_WHITESPACE"," ",206],["T_CONSTANT_ENCAPSED_STRING","'Expires header was sent.'",206],")",";",["T_WHITESPACE","\n      ",206],["T_VARIABLE","$this",207],["T_OBJECT_OPERATOR","->",207],["T_STRING","assertEqual",207],"(",["T_STRING","strpos",207],"(",["T_VARIABLE","$this",207],["T_OBJECT_OPERATOR","->",207],["T_STRING","drupalGetHeader",207],"(",["T_CONSTANT_ENCAPSED_STRING","'Cache-Control'",207],")",",",["T_WHITESPACE"," ",207],["T_CONSTANT_ENCAPSED_STRING","'no-cache'",207],")",",",["T_WHITESPACE"," ",207],["T_STRING","FALSE",207],",",["T_WHITESPACE"," ",207],["T_CONSTANT_ENCAPSED_STRING","'Cache-Control header contains \\'no-cache\\' to prevent caching.'",207],")",";",["T_WHITESPACE","\n\n      ",207],["T_IF","if",209],["T_WHITESPACE"," ",209],"(",["T_VARIABLE","$clean_url",209],")",["T_WHITESPACE"," ",209],"{",["T_WHITESPACE","\n        ",209],["T_COMMENT","\/\/ Add some extra chars to the token.\n",210],["T_WHITESPACE","        ",211],["T_VARIABLE","$this",211],["T_OBJECT_OPERATOR","->",211],["T_STRING","drupalGet",211],"(",["T_STRING","str_replace",211],"(",["T_STRING","IMAGE_DERIVATIVE_TOKEN",211],["T_WHITESPACE"," ",211],".",["T_WHITESPACE"," ",211],["T_CONSTANT_ENCAPSED_STRING","'='",211],",",["T_WHITESPACE"," ",211],["T_STRING","IMAGE_DERIVATIVE_TOKEN",211],["T_WHITESPACE"," ",211],".",["T_WHITESPACE"," ",211],["T_CONSTANT_ENCAPSED_STRING","'=Zo'",211],",",["T_WHITESPACE"," ",211],["T_VARIABLE","$generate_url",211],")",")",";",["T_WHITESPACE","\n        ",211],["T_VARIABLE","$this",212],["T_OBJECT_OPERATOR","->",212],["T_STRING","assertResponse",212],"(",["T_LNUMBER","200",212],",",["T_WHITESPACE"," ",212],["T_CONSTANT_ENCAPSED_STRING","'Existing image was accessible at the URL with an invalid token.'",212],")",";",["T_WHITESPACE","\n      ",212],"}",["T_WHITESPACE","\n    ",213],"}",["T_WHITESPACE","\n\n    ",214],["T_COMMENT","\/\/ Allow insecure image derivatives to be created for the remainder of this\n",216],["T_WHITESPACE","    ",217],["T_COMMENT","\/\/ test.\n",217],["T_WHITESPACE","    ",218],["T_VARIABLE","$this",218],["T_OBJECT_OPERATOR","->",218],["T_STRING","config",218],"(",["T_CONSTANT_ENCAPSED_STRING","'image.settings'",218],")",["T_OBJECT_OPERATOR","->",218],["T_STRING","set",218],"(",["T_CONSTANT_ENCAPSED_STRING","'allow_insecure_derivatives'",218],",",["T_WHITESPACE"," ",218],["T_STRING","TRUE",218],")",["T_OBJECT_OPERATOR","->",218],["T_STRING","save",218],"(",")",";",["T_WHITESPACE","\n\n    ",218],["T_COMMENT","\/\/ Create another working copy of the file.\n",220],["T_WHITESPACE","    ",221],["T_VARIABLE","$files",221],["T_WHITESPACE"," ",221],"=",["T_WHITESPACE"," ",221],["T_VARIABLE","$this",221],["T_OBJECT_OPERATOR","->",221],["T_STRING","drupalGetTestFiles",221],"(",["T_CONSTANT_ENCAPSED_STRING","'image'",221],")",";",["T_WHITESPACE","\n    ",221],["T_VARIABLE","$file",222],["T_WHITESPACE"," ",222],"=",["T_WHITESPACE"," ",222],["T_STRING","array_shift",222],"(",["T_VARIABLE","$files",222],")",";",["T_WHITESPACE","\n    ",222],["T_VARIABLE","$original_uri",223],["T_WHITESPACE"," ",223],"=",["T_WHITESPACE"," ",223],["T_STRING","file_unmanaged_copy",223],"(",["T_VARIABLE","$file",223],["T_OBJECT_OPERATOR","->",223],["T_STRING","uri",223],",",["T_WHITESPACE"," ",223],["T_VARIABLE","$scheme",223],["T_WHITESPACE"," ",223],".",["T_WHITESPACE"," ",223],["T_CONSTANT_ENCAPSED_STRING","':\/\/'",223],",",["T_WHITESPACE"," ",223],["T_STRING","FILE_EXISTS_RENAME",223],")",";",["T_WHITESPACE","\n    ",223],["T_COMMENT","\/\/ Let the image_module_test module know about this file, so it can claim\n",224],["T_WHITESPACE","    ",225],["T_COMMENT","\/\/ ownership in hook_file_download().\n",225],["T_WHITESPACE","    ",226],["T_NS_SEPARATOR","\\",226],["T_STRING","Drupal",226],["T_DOUBLE_COLON","::",226],["T_STRING","state",226],"(",")",["T_OBJECT_OPERATOR","->",226],["T_STRING","set",226],"(",["T_CONSTANT_ENCAPSED_STRING","'image.test_file_download'",226],",",["T_WHITESPACE"," ",226],["T_VARIABLE","$original_uri",226],")",";",["T_WHITESPACE","\n\n    ",226],["T_COMMENT","\/\/ Suppress the security token in the URL, then get the URL of a file that\n",228],["T_WHITESPACE","    ",229],["T_COMMENT","\/\/ has not been created and try to create it. Check that the security token\n",229],["T_WHITESPACE","    ",230],["T_COMMENT","\/\/ is not present in the URL but that the image is still accessible.\n",230],["T_WHITESPACE","    ",231],["T_VARIABLE","$this",231],["T_OBJECT_OPERATOR","->",231],["T_STRING","config",231],"(",["T_CONSTANT_ENCAPSED_STRING","'image.settings'",231],")",["T_OBJECT_OPERATOR","->",231],["T_STRING","set",231],"(",["T_CONSTANT_ENCAPSED_STRING","'suppress_itok_output'",231],",",["T_WHITESPACE"," ",231],["T_STRING","TRUE",231],")",["T_OBJECT_OPERATOR","->",231],["T_STRING","save",231],"(",")",";",["T_WHITESPACE","\n    ",231],["T_VARIABLE","$generated_uri",232],["T_WHITESPACE"," ",232],"=",["T_WHITESPACE"," ",232],["T_VARIABLE","$this",232],["T_OBJECT_OPERATOR","->",232],["T_STRING","style",232],["T_OBJECT_OPERATOR","->",232],["T_STRING","buildUri",232],"(",["T_VARIABLE","$original_uri",232],")",";",["T_WHITESPACE","\n    ",232],["T_VARIABLE","$this",233],["T_OBJECT_OPERATOR","->",233],["T_STRING","assertFalse",233],"(",["T_STRING","file_exists",233],"(",["T_VARIABLE","$generated_uri",233],")",",",["T_WHITESPACE"," ",233],["T_CONSTANT_ENCAPSED_STRING","'Generated file does not exist.'",233],")",";",["T_WHITESPACE","\n    ",233],["T_VARIABLE","$generate_url",234],["T_WHITESPACE"," ",234],"=",["T_WHITESPACE"," ",234],["T_VARIABLE","$this",234],["T_OBJECT_OPERATOR","->",234],["T_STRING","style",234],["T_OBJECT_OPERATOR","->",234],["T_STRING","buildUrl",234],"(",["T_VARIABLE","$original_uri",234],",",["T_WHITESPACE"," ",234],["T_VARIABLE","$clean_url",234],")",";",["T_WHITESPACE","\n    ",234],["T_VARIABLE","$this",235],["T_OBJECT_OPERATOR","->",235],["T_STRING","assertIdentical",235],"(",["T_STRING","strpos",235],"(",["T_VARIABLE","$generate_url",235],",",["T_WHITESPACE"," ",235],["T_STRING","IMAGE_DERIVATIVE_TOKEN",235],["T_WHITESPACE"," ",235],".",["T_WHITESPACE"," ",235],["T_CONSTANT_ENCAPSED_STRING","'='",235],")",",",["T_WHITESPACE"," ",235],["T_STRING","FALSE",235],",",["T_WHITESPACE"," ",235],["T_CONSTANT_ENCAPSED_STRING","'The security token does not appear in the image style URL.'",235],")",";",["T_WHITESPACE","\n    ",235],["T_VARIABLE","$this",236],["T_OBJECT_OPERATOR","->",236],["T_STRING","drupalGet",236],"(",["T_VARIABLE","$generate_url",236],")",";",["T_WHITESPACE","\n    ",236],["T_VARIABLE","$this",237],["T_OBJECT_OPERATOR","->",237],["T_STRING","assertResponse",237],"(",["T_LNUMBER","200",237],",",["T_WHITESPACE"," ",237],["T_CONSTANT_ENCAPSED_STRING","'Image was accessible at the URL with a missing token.'",237],")",";",["T_WHITESPACE","\n\n    ",237],["T_COMMENT","\/\/ Stop supressing the security token in the URL.\n",239],["T_WHITESPACE","    ",240],["T_VARIABLE","$this",240],["T_OBJECT_OPERATOR","->",240],["T_STRING","config",240],"(",["T_CONSTANT_ENCAPSED_STRING","'image.settings'",240],")",["T_OBJECT_OPERATOR","->",240],["T_STRING","set",240],"(",["T_CONSTANT_ENCAPSED_STRING","'suppress_itok_output'",240],",",["T_WHITESPACE"," ",240],["T_STRING","FALSE",240],")",["T_OBJECT_OPERATOR","->",240],["T_STRING","save",240],"(",")",";",["T_WHITESPACE","\n    ",240],["T_COMMENT","\/\/ Ensure allow_insecure_derivatives is enabled.\n",241],["T_WHITESPACE","    ",242],["T_VARIABLE","$this",242],["T_OBJECT_OPERATOR","->",242],["T_STRING","assertEqual",242],"(",["T_VARIABLE","$this",242],["T_OBJECT_OPERATOR","->",242],["T_STRING","config",242],"(",["T_CONSTANT_ENCAPSED_STRING","'image.settings'",242],")",["T_OBJECT_OPERATOR","->",242],["T_STRING","get",242],"(",["T_CONSTANT_ENCAPSED_STRING","'allow_insecure_derivatives'",242],")",",",["T_WHITESPACE"," ",242],["T_STRING","TRUE",242],")",";",["T_WHITESPACE","\n    ",242],["T_COMMENT","\/\/ Check that a security token is still required when generating a second\n",243],["T_WHITESPACE","    ",244],["T_COMMENT","\/\/ image derivative using the first one as a source.\n",244],["T_WHITESPACE","    ",245],["T_VARIABLE","$nested_url",245],["T_WHITESPACE"," ",245],"=",["T_WHITESPACE"," ",245],["T_VARIABLE","$this",245],["T_OBJECT_OPERATOR","->",245],["T_STRING","style",245],["T_OBJECT_OPERATOR","->",245],["T_STRING","buildUrl",245],"(",["T_VARIABLE","$generated_uri",245],",",["T_WHITESPACE"," ",245],["T_VARIABLE","$clean_url",245],")",";",["T_WHITESPACE","\n    ",245],["T_VARIABLE","$matches_expected_url_format",246],["T_WHITESPACE"," ",246],"=",["T_WHITESPACE"," ",246],["T_BOOL_CAST","(boolean)",246],["T_WHITESPACE"," ",246],["T_STRING","preg_match",246],"(",["T_CONSTANT_ENCAPSED_STRING","'\/styles\\\/'",246],["T_WHITESPACE"," ",246],".",["T_WHITESPACE"," ",246],["T_VARIABLE","$this",246],["T_OBJECT_OPERATOR","->",246],["T_STRING","style",246],["T_OBJECT_OPERATOR","->",246],["T_STRING","id",246],"(",")",["T_WHITESPACE"," ",246],".",["T_WHITESPACE"," ",246],["T_CONSTANT_ENCAPSED_STRING","'\\\/'",246],["T_WHITESPACE"," ",246],".",["T_WHITESPACE"," ",246],["T_VARIABLE","$scheme",246],["T_WHITESPACE"," ",246],".",["T_WHITESPACE"," ",246],["T_CONSTANT_ENCAPSED_STRING","'\\\/styles\\\/'",246],["T_WHITESPACE"," ",246],".",["T_WHITESPACE"," ",246],["T_VARIABLE","$this",246],["T_OBJECT_OPERATOR","->",246],["T_STRING","style",246],["T_OBJECT_OPERATOR","->",246],["T_STRING","id",246],"(",")",["T_WHITESPACE"," ",246],".",["T_WHITESPACE"," ",246],["T_CONSTANT_ENCAPSED_STRING","'\\\/'",246],["T_WHITESPACE"," ",246],".",["T_WHITESPACE"," ",246],["T_VARIABLE","$scheme",246],["T_WHITESPACE"," ",246],".",["T_WHITESPACE"," ",246],["T_CONSTANT_ENCAPSED_STRING","'\/'",246],",",["T_WHITESPACE"," ",246],["T_VARIABLE","$nested_url",246],")",";",["T_WHITESPACE","\n    ",246],["T_VARIABLE","$this",247],["T_OBJECT_OPERATOR","->",247],["T_STRING","assertTrue",247],"(",["T_VARIABLE","$matches_expected_url_format",247],",",["T_WHITESPACE"," ",247],["T_CONSTANT_ENCAPSED_STRING","\"URL for a derivative of an image style matches expected format.\"",247],")",";",["T_WHITESPACE","\n    ",247],["T_VARIABLE","$nested_url_with_wrong_token",248],["T_WHITESPACE"," ",248],"=",["T_WHITESPACE"," ",248],["T_STRING","str_replace",248],"(",["T_STRING","IMAGE_DERIVATIVE_TOKEN",248],["T_WHITESPACE"," ",248],".",["T_WHITESPACE"," ",248],["T_CONSTANT_ENCAPSED_STRING","'='",248],",",["T_WHITESPACE"," ",248],["T_CONSTANT_ENCAPSED_STRING","'wrongparam='",248],",",["T_WHITESPACE"," ",248],["T_VARIABLE","$nested_url",248],")",";",["T_WHITESPACE","\n    ",248],["T_VARIABLE","$this",249],["T_OBJECT_OPERATOR","->",249],["T_STRING","drupalGet",249],"(",["T_VARIABLE","$nested_url_with_wrong_token",249],")",";",["T_WHITESPACE","\n    ",249],["T_VARIABLE","$this",250],["T_OBJECT_OPERATOR","->",250],["T_STRING","assertResponse",250],"(",["T_LNUMBER","403",250],",",["T_WHITESPACE"," ",250],["T_CONSTANT_ENCAPSED_STRING","'Image generated from an earlier derivative was inaccessible at the URL with a missing token.'",250],")",";",["T_WHITESPACE","\n    ",250],["T_COMMENT","\/\/ Check that this restriction cannot be bypassed by adding extra slashes\n",251],["T_WHITESPACE","    ",252],["T_COMMENT","\/\/ to the URL.\n",252],["T_WHITESPACE","    ",253],["T_VARIABLE","$this",253],["T_OBJECT_OPERATOR","->",253],["T_STRING","drupalGet",253],"(",["T_STRING","substr_replace",253],"(",["T_VARIABLE","$nested_url_with_wrong_token",253],",",["T_WHITESPACE"," ",253],["T_CONSTANT_ENCAPSED_STRING","'\/\/styles\/'",253],",",["T_WHITESPACE"," ",253],["T_STRING","strrpos",253],"(",["T_VARIABLE","$nested_url_with_wrong_token",253],",",["T_WHITESPACE"," ",253],["T_CONSTANT_ENCAPSED_STRING","'\/styles\/'",253],")",",",["T_WHITESPACE"," ",253],["T_STRING","strlen",253],"(",["T_CONSTANT_ENCAPSED_STRING","'\/styles\/'",253],")",")",")",";",["T_WHITESPACE","\n    ",253],["T_VARIABLE","$this",254],["T_OBJECT_OPERATOR","->",254],["T_STRING","assertResponse",254],"(",["T_LNUMBER","403",254],",",["T_WHITESPACE"," ",254],["T_CONSTANT_ENCAPSED_STRING","'Image generated from an earlier derivative was inaccessible at the URL with a missing token, even with an extra forward slash in the URL.'",254],")",";",["T_WHITESPACE","\n    ",254],["T_VARIABLE","$this",255],["T_OBJECT_OPERATOR","->",255],["T_STRING","drupalGet",255],"(",["T_STRING","substr_replace",255],"(",["T_VARIABLE","$nested_url_with_wrong_token",255],",",["T_WHITESPACE"," ",255],["T_CONSTANT_ENCAPSED_STRING","'\/\/\/\/styles\/'",255],",",["T_WHITESPACE"," ",255],["T_STRING","strrpos",255],"(",["T_VARIABLE","$nested_url_with_wrong_token",255],",",["T_WHITESPACE"," ",255],["T_CONSTANT_ENCAPSED_STRING","'\/styles\/'",255],")",",",["T_WHITESPACE"," ",255],["T_STRING","strlen",255],"(",["T_CONSTANT_ENCAPSED_STRING","'\/styles\/'",255],")",")",")",";",["T_WHITESPACE","\n    ",255],["T_VARIABLE","$this",256],["T_OBJECT_OPERATOR","->",256],["T_STRING","assertResponse",256],"(",["T_LNUMBER","403",256],",",["T_WHITESPACE"," ",256],["T_CONSTANT_ENCAPSED_STRING","'Image generated from an earlier derivative was inaccessible at the URL with a missing token, even with multiple forward slashes in the URL.'",256],")",";",["T_WHITESPACE","\n    ",256],["T_COMMENT","\/\/ Make sure the image can still be generated if a correct token is used.\n",257],["T_WHITESPACE","    ",258],["T_VARIABLE","$this",258],["T_OBJECT_OPERATOR","->",258],["T_STRING","drupalGet",258],"(",["T_VARIABLE","$nested_url",258],")",";",["T_WHITESPACE","\n    ",258],["T_VARIABLE","$this",259],["T_OBJECT_OPERATOR","->",259],["T_STRING","assertResponse",259],"(",["T_LNUMBER","200",259],",",["T_WHITESPACE"," ",259],["T_CONSTANT_ENCAPSED_STRING","'Image was accessible when a correct token was provided in the URL.'",259],")",";",["T_WHITESPACE","\n\n    ",259],["T_COMMENT","\/\/ Check that requesting a nonexistent image does not create any new\n",261],["T_WHITESPACE","    ",262],["T_COMMENT","\/\/ directories in the file system.\n",262],["T_WHITESPACE","    ",263],["T_VARIABLE","$directory",263],["T_WHITESPACE"," ",263],"=",["T_WHITESPACE"," ",263],["T_VARIABLE","$scheme",263],["T_WHITESPACE"," ",263],".",["T_WHITESPACE"," ",263],["T_CONSTANT_ENCAPSED_STRING","':\/\/styles\/'",263],["T_WHITESPACE"," ",263],".",["T_WHITESPACE"," ",263],["T_VARIABLE","$this",263],["T_OBJECT_OPERATOR","->",263],["T_STRING","style",263],["T_OBJECT_OPERATOR","->",263],["T_STRING","id",263],"(",")",["T_WHITESPACE"," ",263],".",["T_WHITESPACE"," ",263],["T_CONSTANT_ENCAPSED_STRING","'\/'",263],["T_WHITESPACE"," ",263],".",["T_WHITESPACE"," ",263],["T_VARIABLE","$scheme",263],["T_WHITESPACE"," ",263],".",["T_WHITESPACE"," ",263],["T_CONSTANT_ENCAPSED_STRING","'\/'",263],["T_WHITESPACE"," ",263],".",["T_WHITESPACE"," ",263],["T_VARIABLE","$this",263],["T_OBJECT_OPERATOR","->",263],["T_STRING","randomMachineName",263],"(",")",";",["T_WHITESPACE","\n    ",263],["T_VARIABLE","$this",264],["T_OBJECT_OPERATOR","->",264],["T_STRING","drupalGet",264],"(",["T_STRING","file_create_url",264],"(",["T_VARIABLE","$directory",264],["T_WHITESPACE"," ",264],".",["T_WHITESPACE"," ",264],["T_CONSTANT_ENCAPSED_STRING","'\/'",264],["T_WHITESPACE"," ",264],".",["T_WHITESPACE"," ",264],["T_VARIABLE","$this",264],["T_OBJECT_OPERATOR","->",264],["T_STRING","randomString",264],"(",")",")",")",";",["T_WHITESPACE","\n    ",264],["T_VARIABLE","$this",265],["T_OBJECT_OPERATOR","->",265],["T_STRING","assertFalse",265],"(",["T_STRING","file_exists",265],"(",["T_VARIABLE","$directory",265],")",",",["T_WHITESPACE"," ",265],["T_CONSTANT_ENCAPSED_STRING","'New directory was not created in the filesystem when requesting an unauthorized image.'",265],")",";",["T_WHITESPACE","\n  ",265],"}",["T_WHITESPACE","\n\n",266],"}",["T_WHITESPACE","\n",268]]