[["T_OPEN_TAG","<?php\n",1],["T_WHITESPACE","\n",2],["T_NAMESPACE","namespace",3],["T_WHITESPACE"," ",3],["T_STRING","Drupal",3],["T_NS_SEPARATOR","\\",3],["T_STRING","file",3],["T_NS_SEPARATOR","\\",3],["T_STRING","Tests",3],";",["T_WHITESPACE","\n\n",3],["T_USE","use",5],["T_WHITESPACE"," ",5],["T_STRING","Drupal",5],["T_NS_SEPARATOR","\\",5],["T_STRING","file",5],["T_NS_SEPARATOR","\\",5],["T_STRING","Entity",5],["T_NS_SEPARATOR","\\",5],["T_STRING","File",5],";",["T_WHITESPACE","\n\n",5],["T_DOC_COMMENT","\/**\n * Tests creating and deleting revisions with files attached.\n *\n * @group file\n *\/",7],["T_WHITESPACE","\n",11],["T_CLASS","class",12],["T_WHITESPACE"," ",12],["T_STRING","FileFieldRevisionTest",12],["T_WHITESPACE"," ",12],["T_EXTENDS","extends",12],["T_WHITESPACE"," ",12],["T_STRING","FileFieldTestBase",12],["T_WHITESPACE"," ",12],"{",["T_WHITESPACE","\n  ",12],["T_DOC_COMMENT","\/**\n   * Tests creating multiple revisions of a node and managing attached files.\n   *\n   * Expected behaviors:\n   *  - Adding a new revision will make another entry in the field table, but\n   *    the original file will not be duplicated.\n   *  - Deleting a revision should not delete the original file if the file\n   *    is in use by another revision.\n   *  - When the last revision that uses a file is deleted, the original file\n   *    should be deleted also.\n   *\/",13],["T_WHITESPACE","\n  ",23],["T_FUNCTION","function",24],["T_WHITESPACE"," ",24],["T_STRING","testRevisions",24],"(",")",["T_WHITESPACE"," ",24],"{",["T_WHITESPACE","\n    ",24],["T_VARIABLE","$node_storage",25],["T_WHITESPACE"," ",25],"=",["T_WHITESPACE"," ",25],["T_VARIABLE","$this",25],["T_OBJECT_OPERATOR","->",25],["T_STRING","container",25],["T_OBJECT_OPERATOR","->",25],["T_STRING","get",25],"(",["T_CONSTANT_ENCAPSED_STRING","'entity.manager'",25],")",["T_OBJECT_OPERATOR","->",25],["T_STRING","getStorage",25],"(",["T_CONSTANT_ENCAPSED_STRING","'node'",25],")",";",["T_WHITESPACE","\n    ",25],["T_VARIABLE","$type_name",26],["T_WHITESPACE"," ",26],"=",["T_WHITESPACE"," ",26],["T_CONSTANT_ENCAPSED_STRING","'article'",26],";",["T_WHITESPACE","\n    ",26],["T_VARIABLE","$field_name",27],["T_WHITESPACE"," ",27],"=",["T_WHITESPACE"," ",27],["T_STRING","strtolower",27],"(",["T_VARIABLE","$this",27],["T_OBJECT_OPERATOR","->",27],["T_STRING","randomMachineName",27],"(",")",")",";",["T_WHITESPACE","\n    ",27],["T_VARIABLE","$this",28],["T_OBJECT_OPERATOR","->",28],["T_STRING","createFileField",28],"(",["T_VARIABLE","$field_name",28],",",["T_WHITESPACE"," ",28],["T_CONSTANT_ENCAPSED_STRING","'node'",28],",",["T_WHITESPACE"," ",28],["T_VARIABLE","$type_name",28],")",";",["T_WHITESPACE","\n    ",28],["T_COMMENT","\/\/ Create the same fields for users.\n",29],["T_WHITESPACE","    ",30],["T_VARIABLE","$this",30],["T_OBJECT_OPERATOR","->",30],["T_STRING","createFileField",30],"(",["T_VARIABLE","$field_name",30],",",["T_WHITESPACE"," ",30],["T_CONSTANT_ENCAPSED_STRING","'user'",30],",",["T_WHITESPACE"," ",30],["T_CONSTANT_ENCAPSED_STRING","'user'",30],")",";",["T_WHITESPACE","\n\n    ",30],["T_VARIABLE","$test_file",32],["T_WHITESPACE"," ",32],"=",["T_WHITESPACE"," ",32],["T_VARIABLE","$this",32],["T_OBJECT_OPERATOR","->",32],["T_STRING","getTestFile",32],"(",["T_CONSTANT_ENCAPSED_STRING","'text'",32],")",";",["T_WHITESPACE","\n\n    ",32],["T_COMMENT","\/\/ Create a new node with the uploaded file.\n",34],["T_WHITESPACE","    ",35],["T_VARIABLE","$nid",35],["T_WHITESPACE"," ",35],"=",["T_WHITESPACE"," ",35],["T_VARIABLE","$this",35],["T_OBJECT_OPERATOR","->",35],["T_STRING","uploadNodeFile",35],"(",["T_VARIABLE","$test_file",35],",",["T_WHITESPACE"," ",35],["T_VARIABLE","$field_name",35],",",["T_WHITESPACE"," ",35],["T_VARIABLE","$type_name",35],")",";",["T_WHITESPACE","\n\n    ",35],["T_COMMENT","\/\/ Check that the file exists on disk and in the database.\n",37],["T_WHITESPACE","    ",38],["T_VARIABLE","$node_storage",38],["T_OBJECT_OPERATOR","->",38],["T_STRING","resetCache",38],"(",["T_ARRAY","array",38],"(",["T_VARIABLE","$nid",38],")",")",";",["T_WHITESPACE","\n    ",38],["T_VARIABLE","$node",39],["T_WHITESPACE"," ",39],"=",["T_WHITESPACE"," ",39],["T_VARIABLE","$node_storage",39],["T_OBJECT_OPERATOR","->",39],["T_STRING","load",39],"(",["T_VARIABLE","$nid",39],")",";",["T_WHITESPACE","\n    ",39],["T_VARIABLE","$node_file_r1",40],["T_WHITESPACE"," ",40],"=",["T_WHITESPACE"," ",40],["T_STRING","File",40],["T_DOUBLE_COLON","::",40],["T_STRING","load",40],"(",["T_VARIABLE","$node",40],["T_OBJECT_OPERATOR","->",40],"{",["T_VARIABLE","$field_name",40],"}",["T_OBJECT_OPERATOR","->",40],["T_STRING","target_id",40],")",";",["T_WHITESPACE","\n    ",40],["T_VARIABLE","$node_vid_r1",41],["T_WHITESPACE"," ",41],"=",["T_WHITESPACE"," ",41],["T_VARIABLE","$node",41],["T_OBJECT_OPERATOR","->",41],["T_STRING","getRevisionId",41],"(",")",";",["T_WHITESPACE","\n    ",41],["T_VARIABLE","$this",42],["T_OBJECT_OPERATOR","->",42],["T_STRING","assertFileExists",42],"(",["T_VARIABLE","$node_file_r1",42],",",["T_WHITESPACE"," ",42],["T_CONSTANT_ENCAPSED_STRING","'New file saved to disk on node creation.'",42],")",";",["T_WHITESPACE","\n    ",42],["T_VARIABLE","$this",43],["T_OBJECT_OPERATOR","->",43],["T_STRING","assertFileEntryExists",43],"(",["T_VARIABLE","$node_file_r1",43],",",["T_WHITESPACE"," ",43],["T_CONSTANT_ENCAPSED_STRING","'File entry exists in database on node creation.'",43],")",";",["T_WHITESPACE","\n    ",43],["T_VARIABLE","$this",44],["T_OBJECT_OPERATOR","->",44],["T_STRING","assertFileIsPermanent",44],"(",["T_VARIABLE","$node_file_r1",44],",",["T_WHITESPACE"," ",44],["T_CONSTANT_ENCAPSED_STRING","'File is permanent.'",44],")",";",["T_WHITESPACE","\n\n    ",44],["T_COMMENT","\/\/ Upload another file to the same node in a new revision.\n",46],["T_WHITESPACE","    ",47],["T_VARIABLE","$this",47],["T_OBJECT_OPERATOR","->",47],["T_STRING","replaceNodeFile",47],"(",["T_VARIABLE","$test_file",47],",",["T_WHITESPACE"," ",47],["T_VARIABLE","$field_name",47],",",["T_WHITESPACE"," ",47],["T_VARIABLE","$nid",47],")",";",["T_WHITESPACE","\n    ",47],["T_VARIABLE","$node_storage",48],["T_OBJECT_OPERATOR","->",48],["T_STRING","resetCache",48],"(",["T_ARRAY","array",48],"(",["T_VARIABLE","$nid",48],")",")",";",["T_WHITESPACE","\n    ",48],["T_VARIABLE","$node",49],["T_WHITESPACE"," ",49],"=",["T_WHITESPACE"," ",49],["T_VARIABLE","$node_storage",49],["T_OBJECT_OPERATOR","->",49],["T_STRING","load",49],"(",["T_VARIABLE","$nid",49],")",";",["T_WHITESPACE","\n    ",49],["T_VARIABLE","$node_file_r2",50],["T_WHITESPACE"," ",50],"=",["T_WHITESPACE"," ",50],["T_STRING","File",50],["T_DOUBLE_COLON","::",50],["T_STRING","load",50],"(",["T_VARIABLE","$node",50],["T_OBJECT_OPERATOR","->",50],"{",["T_VARIABLE","$field_name",50],"}",["T_OBJECT_OPERATOR","->",50],["T_STRING","target_id",50],")",";",["T_WHITESPACE","\n    ",50],["T_VARIABLE","$node_vid_r2",51],["T_WHITESPACE"," ",51],"=",["T_WHITESPACE"," ",51],["T_VARIABLE","$node",51],["T_OBJECT_OPERATOR","->",51],["T_STRING","getRevisionId",51],"(",")",";",["T_WHITESPACE","\n    ",51],["T_VARIABLE","$this",52],["T_OBJECT_OPERATOR","->",52],["T_STRING","assertFileExists",52],"(",["T_VARIABLE","$node_file_r2",52],",",["T_WHITESPACE"," ",52],["T_CONSTANT_ENCAPSED_STRING","'Replacement file exists on disk after creating new revision.'",52],")",";",["T_WHITESPACE","\n    ",52],["T_VARIABLE","$this",53],["T_OBJECT_OPERATOR","->",53],["T_STRING","assertFileEntryExists",53],"(",["T_VARIABLE","$node_file_r2",53],",",["T_WHITESPACE"," ",53],["T_CONSTANT_ENCAPSED_STRING","'Replacement file entry exists in database after creating new revision.'",53],")",";",["T_WHITESPACE","\n    ",53],["T_VARIABLE","$this",54],["T_OBJECT_OPERATOR","->",54],["T_STRING","assertFileIsPermanent",54],"(",["T_VARIABLE","$node_file_r2",54],",",["T_WHITESPACE"," ",54],["T_CONSTANT_ENCAPSED_STRING","'Replacement file is permanent.'",54],")",";",["T_WHITESPACE","\n\n    ",54],["T_COMMENT","\/\/ Check that the original file is still in place on the first revision.\n",56],["T_WHITESPACE","    ",57],["T_VARIABLE","$node",57],["T_WHITESPACE"," ",57],"=",["T_WHITESPACE"," ",57],["T_STRING","node_revision_load",57],"(",["T_VARIABLE","$node_vid_r1",57],")",";",["T_WHITESPACE","\n    ",57],["T_VARIABLE","$current_file",58],["T_WHITESPACE"," ",58],"=",["T_WHITESPACE"," ",58],["T_STRING","File",58],["T_DOUBLE_COLON","::",58],["T_STRING","load",58],"(",["T_VARIABLE","$node",58],["T_OBJECT_OPERATOR","->",58],"{",["T_VARIABLE","$field_name",58],"}",["T_OBJECT_OPERATOR","->",58],["T_STRING","target_id",58],")",";",["T_WHITESPACE","\n    ",58],["T_VARIABLE","$this",59],["T_OBJECT_OPERATOR","->",59],["T_STRING","assertEqual",59],"(",["T_VARIABLE","$node_file_r1",59],["T_OBJECT_OPERATOR","->",59],["T_STRING","id",59],"(",")",",",["T_WHITESPACE"," ",59],["T_VARIABLE","$current_file",59],["T_OBJECT_OPERATOR","->",59],["T_STRING","id",59],"(",")",",",["T_WHITESPACE"," ",59],["T_CONSTANT_ENCAPSED_STRING","'Original file still in place after replacing file in new revision.'",59],")",";",["T_WHITESPACE","\n    ",59],["T_VARIABLE","$this",60],["T_OBJECT_OPERATOR","->",60],["T_STRING","assertFileExists",60],"(",["T_VARIABLE","$node_file_r1",60],",",["T_WHITESPACE"," ",60],["T_CONSTANT_ENCAPSED_STRING","'Original file still in place after replacing file in new revision.'",60],")",";",["T_WHITESPACE","\n    ",60],["T_VARIABLE","$this",61],["T_OBJECT_OPERATOR","->",61],["T_STRING","assertFileEntryExists",61],"(",["T_VARIABLE","$node_file_r1",61],",",["T_WHITESPACE"," ",61],["T_CONSTANT_ENCAPSED_STRING","'Original file entry still in place after replacing file in new revision'",61],")",";",["T_WHITESPACE","\n    ",61],["T_VARIABLE","$this",62],["T_OBJECT_OPERATOR","->",62],["T_STRING","assertFileIsPermanent",62],"(",["T_VARIABLE","$node_file_r1",62],",",["T_WHITESPACE"," ",62],["T_CONSTANT_ENCAPSED_STRING","'Original file is still permanent.'",62],")",";",["T_WHITESPACE","\n\n    ",62],["T_COMMENT","\/\/ Save a new version of the node without any changes.\n",64],["T_WHITESPACE","    ",65],["T_COMMENT","\/\/ Check that the file is still the same as the previous revision.\n",65],["T_WHITESPACE","    ",66],["T_VARIABLE","$this",66],["T_OBJECT_OPERATOR","->",66],["T_STRING","drupalPostForm",66],"(",["T_CONSTANT_ENCAPSED_STRING","'node\/'",66],["T_WHITESPACE"," ",66],".",["T_WHITESPACE"," ",66],["T_VARIABLE","$nid",66],["T_WHITESPACE"," ",66],".",["T_WHITESPACE"," ",66],["T_CONSTANT_ENCAPSED_STRING","'\/edit'",66],",",["T_WHITESPACE"," ",66],["T_ARRAY","array",66],"(",["T_CONSTANT_ENCAPSED_STRING","'revision'",66],["T_WHITESPACE"," ",66],["T_DOUBLE_ARROW","=>",66],["T_WHITESPACE"," ",66],["T_CONSTANT_ENCAPSED_STRING","'1'",66],")",",",["T_WHITESPACE"," ",66],["T_STRING","t",66],"(",["T_CONSTANT_ENCAPSED_STRING","'Save and keep published'",66],")",")",";",["T_WHITESPACE","\n    ",66],["T_VARIABLE","$node_storage",67],["T_OBJECT_OPERATOR","->",67],["T_STRING","resetCache",67],"(",["T_ARRAY","array",67],"(",["T_VARIABLE","$nid",67],")",")",";",["T_WHITESPACE","\n    ",67],["T_VARIABLE","$node",68],["T_WHITESPACE"," ",68],"=",["T_WHITESPACE"," ",68],["T_VARIABLE","$node_storage",68],["T_OBJECT_OPERATOR","->",68],["T_STRING","load",68],"(",["T_VARIABLE","$nid",68],")",";",["T_WHITESPACE","\n    ",68],["T_VARIABLE","$node_file_r3",69],["T_WHITESPACE"," ",69],"=",["T_WHITESPACE"," ",69],["T_STRING","File",69],["T_DOUBLE_COLON","::",69],["T_STRING","load",69],"(",["T_VARIABLE","$node",69],["T_OBJECT_OPERATOR","->",69],"{",["T_VARIABLE","$field_name",69],"}",["T_OBJECT_OPERATOR","->",69],["T_STRING","target_id",69],")",";",["T_WHITESPACE","\n    ",69],["T_VARIABLE","$node_vid_r3",70],["T_WHITESPACE"," ",70],"=",["T_WHITESPACE"," ",70],["T_VARIABLE","$node",70],["T_OBJECT_OPERATOR","->",70],["T_STRING","getRevisionId",70],"(",")",";",["T_WHITESPACE","\n    ",70],["T_VARIABLE","$this",71],["T_OBJECT_OPERATOR","->",71],["T_STRING","assertEqual",71],"(",["T_VARIABLE","$node_file_r2",71],["T_OBJECT_OPERATOR","->",71],["T_STRING","id",71],"(",")",",",["T_WHITESPACE"," ",71],["T_VARIABLE","$node_file_r3",71],["T_OBJECT_OPERATOR","->",71],["T_STRING","id",71],"(",")",",",["T_WHITESPACE"," ",71],["T_CONSTANT_ENCAPSED_STRING","'Previous revision file still in place after creating a new revision without a new file.'",71],")",";",["T_WHITESPACE","\n    ",71],["T_VARIABLE","$this",72],["T_OBJECT_OPERATOR","->",72],["T_STRING","assertFileIsPermanent",72],"(",["T_VARIABLE","$node_file_r3",72],",",["T_WHITESPACE"," ",72],["T_CONSTANT_ENCAPSED_STRING","'New revision file is permanent.'",72],")",";",["T_WHITESPACE","\n\n    ",72],["T_COMMENT","\/\/ Revert to the first revision and check that the original file is active.\n",74],["T_WHITESPACE","    ",75],["T_VARIABLE","$this",75],["T_OBJECT_OPERATOR","->",75],["T_STRING","drupalPostForm",75],"(",["T_CONSTANT_ENCAPSED_STRING","'node\/'",75],["T_WHITESPACE"," ",75],".",["T_WHITESPACE"," ",75],["T_VARIABLE","$nid",75],["T_WHITESPACE"," ",75],".",["T_WHITESPACE"," ",75],["T_CONSTANT_ENCAPSED_STRING","'\/revisions\/'",75],["T_WHITESPACE"," ",75],".",["T_WHITESPACE"," ",75],["T_VARIABLE","$node_vid_r1",75],["T_WHITESPACE"," ",75],".",["T_WHITESPACE"," ",75],["T_CONSTANT_ENCAPSED_STRING","'\/revert'",75],",",["T_WHITESPACE"," ",75],["T_ARRAY","array",75],"(",")",",",["T_WHITESPACE"," ",75],["T_STRING","t",75],"(",["T_CONSTANT_ENCAPSED_STRING","'Revert'",75],")",")",";",["T_WHITESPACE","\n    ",75],["T_VARIABLE","$node_storage",76],["T_OBJECT_OPERATOR","->",76],["T_STRING","resetCache",76],"(",["T_ARRAY","array",76],"(",["T_VARIABLE","$nid",76],")",")",";",["T_WHITESPACE","\n    ",76],["T_VARIABLE","$node",77],["T_WHITESPACE"," ",77],"=",["T_WHITESPACE"," ",77],["T_VARIABLE","$node_storage",77],["T_OBJECT_OPERATOR","->",77],["T_STRING","load",77],"(",["T_VARIABLE","$nid",77],")",";",["T_WHITESPACE","\n    ",77],["T_VARIABLE","$node_file_r4",78],["T_WHITESPACE"," ",78],"=",["T_WHITESPACE"," ",78],["T_STRING","File",78],["T_DOUBLE_COLON","::",78],["T_STRING","load",78],"(",["T_VARIABLE","$node",78],["T_OBJECT_OPERATOR","->",78],"{",["T_VARIABLE","$field_name",78],"}",["T_OBJECT_OPERATOR","->",78],["T_STRING","target_id",78],")",";",["T_WHITESPACE","\n    ",78],["T_VARIABLE","$this",79],["T_OBJECT_OPERATOR","->",79],["T_STRING","assertEqual",79],"(",["T_VARIABLE","$node_file_r1",79],["T_OBJECT_OPERATOR","->",79],["T_STRING","id",79],"(",")",",",["T_WHITESPACE"," ",79],["T_VARIABLE","$node_file_r4",79],["T_OBJECT_OPERATOR","->",79],["T_STRING","id",79],"(",")",",",["T_WHITESPACE"," ",79],["T_CONSTANT_ENCAPSED_STRING","'Original revision file still in place after reverting to the original revision.'",79],")",";",["T_WHITESPACE","\n    ",79],["T_VARIABLE","$this",80],["T_OBJECT_OPERATOR","->",80],["T_STRING","assertFileIsPermanent",80],"(",["T_VARIABLE","$node_file_r4",80],",",["T_WHITESPACE"," ",80],["T_CONSTANT_ENCAPSED_STRING","'Original revision file still permanent after reverting to the original revision.'",80],")",";",["T_WHITESPACE","\n\n    ",80],["T_COMMENT","\/\/ Delete the second revision and check that the file is kept (since it is\n",82],["T_WHITESPACE","    ",83],["T_COMMENT","\/\/ still being used by the third revision).\n",83],["T_WHITESPACE","    ",84],["T_VARIABLE","$this",84],["T_OBJECT_OPERATOR","->",84],["T_STRING","drupalPostForm",84],"(",["T_CONSTANT_ENCAPSED_STRING","'node\/'",84],["T_WHITESPACE"," ",84],".",["T_WHITESPACE"," ",84],["T_VARIABLE","$nid",84],["T_WHITESPACE"," ",84],".",["T_WHITESPACE"," ",84],["T_CONSTANT_ENCAPSED_STRING","'\/revisions\/'",84],["T_WHITESPACE"," ",84],".",["T_WHITESPACE"," ",84],["T_VARIABLE","$node_vid_r2",84],["T_WHITESPACE"," ",84],".",["T_WHITESPACE"," ",84],["T_CONSTANT_ENCAPSED_STRING","'\/delete'",84],",",["T_WHITESPACE"," ",84],["T_ARRAY","array",84],"(",")",",",["T_WHITESPACE"," ",84],["T_STRING","t",84],"(",["T_CONSTANT_ENCAPSED_STRING","'Delete'",84],")",")",";",["T_WHITESPACE","\n    ",84],["T_VARIABLE","$this",85],["T_OBJECT_OPERATOR","->",85],["T_STRING","assertFileExists",85],"(",["T_VARIABLE","$node_file_r3",85],",",["T_WHITESPACE"," ",85],["T_CONSTANT_ENCAPSED_STRING","'Second file is still available after deleting second revision, since it is being used by the third revision.'",85],")",";",["T_WHITESPACE","\n    ",85],["T_VARIABLE","$this",86],["T_OBJECT_OPERATOR","->",86],["T_STRING","assertFileEntryExists",86],"(",["T_VARIABLE","$node_file_r3",86],",",["T_WHITESPACE"," ",86],["T_CONSTANT_ENCAPSED_STRING","'Second file entry is still available after deleting second revision, since it is being used by the third revision.'",86],")",";",["T_WHITESPACE","\n    ",86],["T_VARIABLE","$this",87],["T_OBJECT_OPERATOR","->",87],["T_STRING","assertFileIsPermanent",87],"(",["T_VARIABLE","$node_file_r3",87],",",["T_WHITESPACE"," ",87],["T_CONSTANT_ENCAPSED_STRING","'Second file entry is still permanent after deleting second revision, since it is being used by the third revision.'",87],")",";",["T_WHITESPACE","\n\n    ",87],["T_COMMENT","\/\/ Attach the second file to a user.\n",89],["T_WHITESPACE","    ",90],["T_VARIABLE","$user",90],["T_WHITESPACE"," ",90],"=",["T_WHITESPACE"," ",90],["T_VARIABLE","$this",90],["T_OBJECT_OPERATOR","->",90],["T_STRING","drupalCreateUser",90],"(",")",";",["T_WHITESPACE","\n    ",90],["T_VARIABLE","$user",91],["T_OBJECT_OPERATOR","->",91],["T_VARIABLE","$field_name",91],["T_OBJECT_OPERATOR","->",91],["T_STRING","target_id",91],["T_WHITESPACE"," ",91],"=",["T_WHITESPACE"," ",91],["T_VARIABLE","$node_file_r3",91],["T_OBJECT_OPERATOR","->",91],["T_STRING","id",91],"(",")",";",["T_WHITESPACE","\n    ",91],["T_VARIABLE","$user",92],["T_OBJECT_OPERATOR","->",92],["T_VARIABLE","$field_name",92],["T_OBJECT_OPERATOR","->",92],["T_STRING","display",92],["T_WHITESPACE"," ",92],"=",["T_WHITESPACE"," ",92],["T_LNUMBER","1",92],";",["T_WHITESPACE","\n    ",92],["T_VARIABLE","$user",93],["T_OBJECT_OPERATOR","->",93],["T_STRING","save",93],"(",")",";",["T_WHITESPACE","\n    ",93],["T_VARIABLE","$this",94],["T_OBJECT_OPERATOR","->",94],["T_STRING","drupalGet",94],"(",["T_CONSTANT_ENCAPSED_STRING","'user\/'",94],["T_WHITESPACE"," ",94],".",["T_WHITESPACE"," ",94],["T_VARIABLE","$user",94],["T_OBJECT_OPERATOR","->",94],["T_STRING","id",94],"(",")",["T_WHITESPACE"," ",94],".",["T_WHITESPACE"," ",94],["T_CONSTANT_ENCAPSED_STRING","'\/edit'",94],")",";",["T_WHITESPACE","\n\n    ",94],["T_COMMENT","\/\/ Delete the third revision and check that the file is not deleted yet.\n",96],["T_WHITESPACE","    ",97],["T_VARIABLE","$this",97],["T_OBJECT_OPERATOR","->",97],["T_STRING","drupalPostForm",97],"(",["T_CONSTANT_ENCAPSED_STRING","'node\/'",97],["T_WHITESPACE"," ",97],".",["T_WHITESPACE"," ",97],["T_VARIABLE","$nid",97],["T_WHITESPACE"," ",97],".",["T_WHITESPACE"," ",97],["T_CONSTANT_ENCAPSED_STRING","'\/revisions\/'",97],["T_WHITESPACE"," ",97],".",["T_WHITESPACE"," ",97],["T_VARIABLE","$node_vid_r3",97],["T_WHITESPACE"," ",97],".",["T_WHITESPACE"," ",97],["T_CONSTANT_ENCAPSED_STRING","'\/delete'",97],",",["T_WHITESPACE"," ",97],["T_ARRAY","array",97],"(",")",",",["T_WHITESPACE"," ",97],["T_STRING","t",97],"(",["T_CONSTANT_ENCAPSED_STRING","'Delete'",97],")",")",";",["T_WHITESPACE","\n    ",97],["T_VARIABLE","$this",98],["T_OBJECT_OPERATOR","->",98],["T_STRING","assertFileExists",98],"(",["T_VARIABLE","$node_file_r3",98],",",["T_WHITESPACE"," ",98],["T_CONSTANT_ENCAPSED_STRING","'Second file is still available after deleting third revision, since it is being used by the user.'",98],")",";",["T_WHITESPACE","\n    ",98],["T_VARIABLE","$this",99],["T_OBJECT_OPERATOR","->",99],["T_STRING","assertFileEntryExists",99],"(",["T_VARIABLE","$node_file_r3",99],",",["T_WHITESPACE"," ",99],["T_CONSTANT_ENCAPSED_STRING","'Second file entry is still available after deleting third revision, since it is being used by the user.'",99],")",";",["T_WHITESPACE","\n    ",99],["T_VARIABLE","$this",100],["T_OBJECT_OPERATOR","->",100],["T_STRING","assertFileIsPermanent",100],"(",["T_VARIABLE","$node_file_r3",100],",",["T_WHITESPACE"," ",100],["T_CONSTANT_ENCAPSED_STRING","'Second file entry is still permanent after deleting third revision, since it is being used by the user.'",100],")",";",["T_WHITESPACE","\n\n    ",100],["T_COMMENT","\/\/ Delete the user and check that the file is also deleted.\n",102],["T_WHITESPACE","    ",103],["T_VARIABLE","$user",103],["T_OBJECT_OPERATOR","->",103],["T_STRING","delete",103],"(",")",";",["T_WHITESPACE","\n    ",103],["T_COMMENT","\/\/ TODO: This seems like a bug in File API. Clearing the stat cache should\n",104],["T_WHITESPACE","    ",105],["T_COMMENT","\/\/ not be necessary here. The file really is deleted, but stream wrappers\n",105],["T_WHITESPACE","    ",106],["T_COMMENT","\/\/ doesn't seem to think so unless we clear the PHP file stat() cache.\n",106],["T_WHITESPACE","    ",107],["T_STRING","clearstatcache",107],"(",["T_VARIABLE","$node_file_r1",107],["T_OBJECT_OPERATOR","->",107],["T_STRING","getFileUri",107],"(",")",")",";",["T_WHITESPACE","\n    ",107],["T_STRING","clearstatcache",108],"(",["T_VARIABLE","$node_file_r2",108],["T_OBJECT_OPERATOR","->",108],["T_STRING","getFileUri",108],"(",")",")",";",["T_WHITESPACE","\n    ",108],["T_STRING","clearstatcache",109],"(",["T_VARIABLE","$node_file_r3",109],["T_OBJECT_OPERATOR","->",109],["T_STRING","getFileUri",109],"(",")",")",";",["T_WHITESPACE","\n    ",109],["T_STRING","clearstatcache",110],"(",["T_VARIABLE","$node_file_r4",110],["T_OBJECT_OPERATOR","->",110],["T_STRING","getFileUri",110],"(",")",")",";",["T_WHITESPACE","\n\n    ",110],["T_COMMENT","\/\/ Call file_cron() to clean up the file. Make sure the changed timestamp\n",112],["T_WHITESPACE","    ",113],["T_COMMENT","\/\/ of the file is older than the system.file.temporary_maximum_age\n",113],["T_WHITESPACE","    ",114],["T_COMMENT","\/\/ configuration value.\n",114],["T_WHITESPACE","    ",115],["T_STRING","db_update",115],"(",["T_CONSTANT_ENCAPSED_STRING","'file_managed'",115],")",["T_WHITESPACE","\n      ",115],["T_OBJECT_OPERATOR","->",116],["T_STRING","fields",116],"(",["T_ARRAY","array",116],"(",["T_WHITESPACE","\n        ",116],["T_CONSTANT_ENCAPSED_STRING","'changed'",117],["T_WHITESPACE"," ",117],["T_DOUBLE_ARROW","=>",117],["T_WHITESPACE"," ",117],["T_STRING","REQUEST_TIME",117],["T_WHITESPACE"," ",117],"-",["T_WHITESPACE"," ",117],"(",["T_VARIABLE","$this",117],["T_OBJECT_OPERATOR","->",117],["T_STRING","config",117],"(",["T_CONSTANT_ENCAPSED_STRING","'system.file'",117],")",["T_OBJECT_OPERATOR","->",117],["T_STRING","get",117],"(",["T_CONSTANT_ENCAPSED_STRING","'temporary_maximum_age'",117],")",["T_WHITESPACE"," ",117],"+",["T_WHITESPACE"," ",117],["T_LNUMBER","1",117],")",",",["T_WHITESPACE","\n      ",117],")",")",["T_WHITESPACE","\n      ",118],["T_OBJECT_OPERATOR","->",119],["T_STRING","condition",119],"(",["T_CONSTANT_ENCAPSED_STRING","'fid'",119],",",["T_WHITESPACE"," ",119],["T_VARIABLE","$node_file_r3",119],["T_OBJECT_OPERATOR","->",119],["T_STRING","id",119],"(",")",")",["T_WHITESPACE","\n      ",119],["T_OBJECT_OPERATOR","->",120],["T_STRING","execute",120],"(",")",";",["T_WHITESPACE","\n    ",120],["T_NS_SEPARATOR","\\",121],["T_STRING","Drupal",121],["T_DOUBLE_COLON","::",121],["T_STRING","service",121],"(",["T_CONSTANT_ENCAPSED_STRING","'cron'",121],")",["T_OBJECT_OPERATOR","->",121],["T_STRING","run",121],"(",")",";",["T_WHITESPACE","\n\n    ",121],["T_VARIABLE","$this",123],["T_OBJECT_OPERATOR","->",123],["T_STRING","assertFileNotExists",123],"(",["T_VARIABLE","$node_file_r3",123],",",["T_WHITESPACE"," ",123],["T_CONSTANT_ENCAPSED_STRING","'Second file is now deleted after deleting third revision, since it is no longer being used by any other nodes.'",123],")",";",["T_WHITESPACE","\n    ",123],["T_VARIABLE","$this",124],["T_OBJECT_OPERATOR","->",124],["T_STRING","assertFileEntryNotExists",124],"(",["T_VARIABLE","$node_file_r3",124],",",["T_WHITESPACE"," ",124],["T_CONSTANT_ENCAPSED_STRING","'Second file entry is now deleted after deleting third revision, since it is no longer being used by any other nodes.'",124],")",";",["T_WHITESPACE","\n\n    ",124],["T_COMMENT","\/\/ Delete the entire node and check that the original file is deleted.\n",126],["T_WHITESPACE","    ",127],["T_VARIABLE","$this",127],["T_OBJECT_OPERATOR","->",127],["T_STRING","drupalPostForm",127],"(",["T_CONSTANT_ENCAPSED_STRING","'node\/'",127],["T_WHITESPACE"," ",127],".",["T_WHITESPACE"," ",127],["T_VARIABLE","$nid",127],["T_WHITESPACE"," ",127],".",["T_WHITESPACE"," ",127],["T_CONSTANT_ENCAPSED_STRING","'\/delete'",127],",",["T_WHITESPACE"," ",127],["T_ARRAY","array",127],"(",")",",",["T_WHITESPACE"," ",127],["T_STRING","t",127],"(",["T_CONSTANT_ENCAPSED_STRING","'Delete'",127],")",")",";",["T_WHITESPACE","\n    ",127],["T_COMMENT","\/\/ Call file_cron() to clean up the file. Make sure the changed timestamp\n",128],["T_WHITESPACE","    ",129],["T_COMMENT","\/\/ of the file is older than the system.file.temporary_maximum_age\n",129],["T_WHITESPACE","    ",130],["T_COMMENT","\/\/ configuration value.\n",130],["T_WHITESPACE","    ",131],["T_STRING","db_update",131],"(",["T_CONSTANT_ENCAPSED_STRING","'file_managed'",131],")",["T_WHITESPACE","\n      ",131],["T_OBJECT_OPERATOR","->",132],["T_STRING","fields",132],"(",["T_ARRAY","array",132],"(",["T_WHITESPACE","\n        ",132],["T_CONSTANT_ENCAPSED_STRING","'changed'",133],["T_WHITESPACE"," ",133],["T_DOUBLE_ARROW","=>",133],["T_WHITESPACE"," ",133],["T_STRING","REQUEST_TIME",133],["T_WHITESPACE"," ",133],"-",["T_WHITESPACE"," ",133],"(",["T_VARIABLE","$this",133],["T_OBJECT_OPERATOR","->",133],["T_STRING","config",133],"(",["T_CONSTANT_ENCAPSED_STRING","'system.file'",133],")",["T_OBJECT_OPERATOR","->",133],["T_STRING","get",133],"(",["T_CONSTANT_ENCAPSED_STRING","'temporary_maximum_age'",133],")",["T_WHITESPACE"," ",133],"+",["T_WHITESPACE"," ",133],["T_LNUMBER","1",133],")",",",["T_WHITESPACE","\n      ",133],")",")",["T_WHITESPACE","\n      ",134],["T_OBJECT_OPERATOR","->",135],["T_STRING","condition",135],"(",["T_CONSTANT_ENCAPSED_STRING","'fid'",135],",",["T_WHITESPACE"," ",135],["T_VARIABLE","$node_file_r1",135],["T_OBJECT_OPERATOR","->",135],["T_STRING","id",135],"(",")",")",["T_WHITESPACE","\n      ",135],["T_OBJECT_OPERATOR","->",136],["T_STRING","execute",136],"(",")",";",["T_WHITESPACE","\n    ",136],["T_NS_SEPARATOR","\\",137],["T_STRING","Drupal",137],["T_DOUBLE_COLON","::",137],["T_STRING","service",137],"(",["T_CONSTANT_ENCAPSED_STRING","'cron'",137],")",["T_OBJECT_OPERATOR","->",137],["T_STRING","run",137],"(",")",";",["T_WHITESPACE","\n    ",137],["T_VARIABLE","$this",138],["T_OBJECT_OPERATOR","->",138],["T_STRING","assertFileNotExists",138],"(",["T_VARIABLE","$node_file_r1",138],",",["T_WHITESPACE"," ",138],["T_CONSTANT_ENCAPSED_STRING","'Original file is deleted after deleting the entire node with two revisions remaining.'",138],")",";",["T_WHITESPACE","\n    ",138],["T_VARIABLE","$this",139],["T_OBJECT_OPERATOR","->",139],["T_STRING","assertFileEntryNotExists",139],"(",["T_VARIABLE","$node_file_r1",139],",",["T_WHITESPACE"," ",139],["T_CONSTANT_ENCAPSED_STRING","'Original file entry is deleted after deleting the entire node with two revisions remaining.'",139],")",";",["T_WHITESPACE","\n  ",139],"}",["T_WHITESPACE","\n\n",140],"}",["T_WHITESPACE","\n",142]]