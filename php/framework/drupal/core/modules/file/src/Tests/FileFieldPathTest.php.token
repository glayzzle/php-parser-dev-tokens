[["T_OPEN_TAG","<?php\n",1],["T_WHITESPACE","\n",2],["T_NAMESPACE","namespace",3],["T_WHITESPACE"," ",3],["T_STRING","Drupal",3],["T_NS_SEPARATOR","\\",3],["T_STRING","file",3],["T_NS_SEPARATOR","\\",3],["T_STRING","Tests",3],";",["T_WHITESPACE","\n\n",3],["T_USE","use",5],["T_WHITESPACE"," ",5],["T_STRING","Drupal",5],["T_NS_SEPARATOR","\\",5],["T_STRING","file",5],["T_NS_SEPARATOR","\\",5],["T_STRING","Entity",5],["T_NS_SEPARATOR","\\",5],["T_STRING","File",5],";",["T_WHITESPACE","\n\n",5],["T_DOC_COMMENT","\/**\n * Tests that files are uploaded to proper locations.\n *\n * @group file\n *\/",7],["T_WHITESPACE","\n",11],["T_CLASS","class",12],["T_WHITESPACE"," ",12],["T_STRING","FileFieldPathTest",12],["T_WHITESPACE"," ",12],["T_EXTENDS","extends",12],["T_WHITESPACE"," ",12],["T_STRING","FileFieldTestBase",12],["T_WHITESPACE"," ",12],"{",["T_WHITESPACE","\n  ",12],["T_DOC_COMMENT","\/**\n   * Tests the normal formatter display on node display.\n   *\/",13],["T_WHITESPACE","\n  ",15],["T_FUNCTION","function",16],["T_WHITESPACE"," ",16],["T_STRING","testUploadPath",16],"(",")",["T_WHITESPACE"," ",16],"{",["T_WHITESPACE","\n    ",16],["T_DOC_COMMENT","\/** @var \\Drupal\\node\\NodeStorageInterface $node_storage *\/",17],["T_WHITESPACE","\n    ",17],["T_VARIABLE","$node_storage",18],["T_WHITESPACE"," ",18],"=",["T_WHITESPACE"," ",18],["T_VARIABLE","$this",18],["T_OBJECT_OPERATOR","->",18],["T_STRING","container",18],["T_OBJECT_OPERATOR","->",18],["T_STRING","get",18],"(",["T_CONSTANT_ENCAPSED_STRING","'entity.manager'",18],")",["T_OBJECT_OPERATOR","->",18],["T_STRING","getStorage",18],"(",["T_CONSTANT_ENCAPSED_STRING","'node'",18],")",";",["T_WHITESPACE","\n    ",18],["T_VARIABLE","$field_name",19],["T_WHITESPACE"," ",19],"=",["T_WHITESPACE"," ",19],["T_STRING","strtolower",19],"(",["T_VARIABLE","$this",19],["T_OBJECT_OPERATOR","->",19],["T_STRING","randomMachineName",19],"(",")",")",";",["T_WHITESPACE","\n    ",19],["T_VARIABLE","$type_name",20],["T_WHITESPACE"," ",20],"=",["T_WHITESPACE"," ",20],["T_CONSTANT_ENCAPSED_STRING","'article'",20],";",["T_WHITESPACE","\n    ",20],["T_VARIABLE","$this",21],["T_OBJECT_OPERATOR","->",21],["T_STRING","createFileField",21],"(",["T_VARIABLE","$field_name",21],",",["T_WHITESPACE"," ",21],["T_CONSTANT_ENCAPSED_STRING","'node'",21],",",["T_WHITESPACE"," ",21],["T_VARIABLE","$type_name",21],")",";",["T_WHITESPACE","\n    ",21],["T_DOC_COMMENT","\/** @var \\Drupal\\file\\FileInterface $test_file *\/",22],["T_WHITESPACE","\n    ",22],["T_VARIABLE","$test_file",23],["T_WHITESPACE"," ",23],"=",["T_WHITESPACE"," ",23],["T_VARIABLE","$this",23],["T_OBJECT_OPERATOR","->",23],["T_STRING","getTestFile",23],"(",["T_CONSTANT_ENCAPSED_STRING","'text'",23],")",";",["T_WHITESPACE","\n\n    ",23],["T_COMMENT","\/\/ Create a new node.\n",25],["T_WHITESPACE","    ",26],["T_VARIABLE","$nid",26],["T_WHITESPACE"," ",26],"=",["T_WHITESPACE"," ",26],["T_VARIABLE","$this",26],["T_OBJECT_OPERATOR","->",26],["T_STRING","uploadNodeFile",26],"(",["T_VARIABLE","$test_file",26],",",["T_WHITESPACE"," ",26],["T_VARIABLE","$field_name",26],",",["T_WHITESPACE"," ",26],["T_VARIABLE","$type_name",26],")",";",["T_WHITESPACE","\n\n    ",26],["T_COMMENT","\/\/ Check that the file was uploaded to the correct location.\n",28],["T_WHITESPACE","    ",29],["T_VARIABLE","$node_storage",29],["T_OBJECT_OPERATOR","->",29],["T_STRING","resetCache",29],"(",["T_ARRAY","array",29],"(",["T_VARIABLE","$nid",29],")",")",";",["T_WHITESPACE","\n    ",29],["T_VARIABLE","$node",30],["T_WHITESPACE"," ",30],"=",["T_WHITESPACE"," ",30],["T_VARIABLE","$node_storage",30],["T_OBJECT_OPERATOR","->",30],["T_STRING","load",30],"(",["T_VARIABLE","$nid",30],")",";",["T_WHITESPACE","\n    ",30],["T_DOC_COMMENT","\/** @var \\Drupal\\file\\FileInterface $node_file *\/",31],["T_WHITESPACE","\n    ",31],["T_VARIABLE","$node_file",32],["T_WHITESPACE"," ",32],"=",["T_WHITESPACE"," ",32],["T_VARIABLE","$node",32],["T_OBJECT_OPERATOR","->",32],"{",["T_VARIABLE","$field_name",32],"}",["T_OBJECT_OPERATOR","->",32],["T_STRING","entity",32],";",["T_WHITESPACE","\n    ",32],["T_VARIABLE","$date_formatter",33],["T_WHITESPACE"," ",33],"=",["T_WHITESPACE"," ",33],["T_VARIABLE","$this",33],["T_OBJECT_OPERATOR","->",33],["T_STRING","container",33],["T_OBJECT_OPERATOR","->",33],["T_STRING","get",33],"(",["T_CONSTANT_ENCAPSED_STRING","'date.formatter'",33],")",";",["T_WHITESPACE","\n    ",33],["T_VARIABLE","$expected_filename",34],["T_WHITESPACE"," ",34],"=",["T_WHITESPACE","\n      ",34],["T_CONSTANT_ENCAPSED_STRING","'public:\/\/'",35],["T_WHITESPACE"," ",35],".",["T_WHITESPACE","\n      ",35],["T_VARIABLE","$date_formatter",36],["T_OBJECT_OPERATOR","->",36],["T_STRING","format",36],"(",["T_STRING","REQUEST_TIME",36],",",["T_WHITESPACE"," ",36],["T_CONSTANT_ENCAPSED_STRING","'custom'",36],",",["T_WHITESPACE"," ",36],["T_CONSTANT_ENCAPSED_STRING","'Y'",36],")",["T_WHITESPACE"," ",36],".",["T_WHITESPACE"," ",36],["T_CONSTANT_ENCAPSED_STRING","'-'",36],["T_WHITESPACE"," ",36],".",["T_WHITESPACE","\n      ",36],["T_VARIABLE","$date_formatter",37],["T_OBJECT_OPERATOR","->",37],["T_STRING","format",37],"(",["T_STRING","REQUEST_TIME",37],",",["T_WHITESPACE"," ",37],["T_CONSTANT_ENCAPSED_STRING","'custom'",37],",",["T_WHITESPACE"," ",37],["T_CONSTANT_ENCAPSED_STRING","'m'",37],")",["T_WHITESPACE"," ",37],".",["T_WHITESPACE"," ",37],["T_CONSTANT_ENCAPSED_STRING","'\/'",37],["T_WHITESPACE"," ",37],".",["T_WHITESPACE","\n      ",37],["T_VARIABLE","$test_file",38],["T_OBJECT_OPERATOR","->",38],["T_STRING","getFilename",38],"(",")",";",["T_WHITESPACE","\n    ",38],["T_VARIABLE","$this",39],["T_OBJECT_OPERATOR","->",39],["T_STRING","assertPathMatch",39],"(",["T_VARIABLE","$expected_filename",39],",",["T_WHITESPACE"," ",39],["T_VARIABLE","$node_file",39],["T_OBJECT_OPERATOR","->",39],["T_STRING","getFileUri",39],"(",")",",",["T_WHITESPACE"," ",39],["T_STRING","format_string",39],"(",["T_CONSTANT_ENCAPSED_STRING","'The file %file was uploaded to the correct path.'",39],",",["T_WHITESPACE"," ",39],["T_ARRAY","array",39],"(",["T_CONSTANT_ENCAPSED_STRING","'%file'",39],["T_WHITESPACE"," ",39],["T_DOUBLE_ARROW","=>",39],["T_WHITESPACE"," ",39],["T_VARIABLE","$node_file",39],["T_OBJECT_OPERATOR","->",39],["T_STRING","getFileUri",39],"(",")",")",")",")",";",["T_WHITESPACE","\n\n    ",39],["T_COMMENT","\/\/ Change the path to contain multiple subdirectories.\n",41],["T_WHITESPACE","    ",42],["T_VARIABLE","$this",42],["T_OBJECT_OPERATOR","->",42],["T_STRING","updateFileField",42],"(",["T_VARIABLE","$field_name",42],",",["T_WHITESPACE"," ",42],["T_VARIABLE","$type_name",42],",",["T_WHITESPACE"," ",42],["T_ARRAY","array",42],"(",["T_CONSTANT_ENCAPSED_STRING","'file_directory'",42],["T_WHITESPACE"," ",42],["T_DOUBLE_ARROW","=>",42],["T_WHITESPACE"," ",42],["T_CONSTANT_ENCAPSED_STRING","'foo\/bar\/baz'",42],")",")",";",["T_WHITESPACE","\n\n    ",42],["T_COMMENT","\/\/ Upload a new file into the subdirectories.\n",44],["T_WHITESPACE","    ",45],["T_VARIABLE","$nid",45],["T_WHITESPACE"," ",45],"=",["T_WHITESPACE"," ",45],["T_VARIABLE","$this",45],["T_OBJECT_OPERATOR","->",45],["T_STRING","uploadNodeFile",45],"(",["T_VARIABLE","$test_file",45],",",["T_WHITESPACE"," ",45],["T_VARIABLE","$field_name",45],",",["T_WHITESPACE"," ",45],["T_VARIABLE","$type_name",45],")",";",["T_WHITESPACE","\n\n    ",45],["T_COMMENT","\/\/ Check that the file was uploaded into the subdirectory.\n",47],["T_WHITESPACE","    ",48],["T_VARIABLE","$node_storage",48],["T_OBJECT_OPERATOR","->",48],["T_STRING","resetCache",48],"(",["T_ARRAY","array",48],"(",["T_VARIABLE","$nid",48],")",")",";",["T_WHITESPACE","\n    ",48],["T_VARIABLE","$node",49],["T_WHITESPACE"," ",49],"=",["T_WHITESPACE"," ",49],["T_VARIABLE","$node_storage",49],["T_OBJECT_OPERATOR","->",49],["T_STRING","load",49],"(",["T_VARIABLE","$nid",49],")",";",["T_WHITESPACE","\n    ",49],["T_VARIABLE","$node_file",50],["T_WHITESPACE"," ",50],"=",["T_WHITESPACE"," ",50],["T_STRING","File",50],["T_DOUBLE_COLON","::",50],["T_STRING","load",50],"(",["T_VARIABLE","$node",50],["T_OBJECT_OPERATOR","->",50],"{",["T_VARIABLE","$field_name",50],"}",["T_OBJECT_OPERATOR","->",50],["T_STRING","target_id",50],")",";",["T_WHITESPACE","\n    ",50],["T_VARIABLE","$this",51],["T_OBJECT_OPERATOR","->",51],["T_STRING","assertPathMatch",51],"(",["T_CONSTANT_ENCAPSED_STRING","'public:\/\/foo\/bar\/baz\/'",51],["T_WHITESPACE"," ",51],".",["T_WHITESPACE"," ",51],["T_VARIABLE","$test_file",51],["T_OBJECT_OPERATOR","->",51],["T_STRING","getFilename",51],"(",")",",",["T_WHITESPACE"," ",51],["T_VARIABLE","$node_file",51],["T_OBJECT_OPERATOR","->",51],["T_STRING","getFileUri",51],"(",")",",",["T_WHITESPACE"," ",51],["T_STRING","format_string",51],"(",["T_CONSTANT_ENCAPSED_STRING","'The file %file was uploaded to the correct path.'",51],",",["T_WHITESPACE"," ",51],["T_ARRAY","array",51],"(",["T_CONSTANT_ENCAPSED_STRING","'%file'",51],["T_WHITESPACE"," ",51],["T_DOUBLE_ARROW","=>",51],["T_WHITESPACE"," ",51],["T_VARIABLE","$node_file",51],["T_OBJECT_OPERATOR","->",51],["T_STRING","getFileUri",51],"(",")",")",")",")",";",["T_WHITESPACE","\n\n    ",51],["T_COMMENT","\/\/ Check the path when used with tokens.\n",53],["T_WHITESPACE","    ",54],["T_COMMENT","\/\/ Change the path to contain multiple token directories.\n",54],["T_WHITESPACE","    ",55],["T_VARIABLE","$this",55],["T_OBJECT_OPERATOR","->",55],["T_STRING","updateFileField",55],"(",["T_VARIABLE","$field_name",55],",",["T_WHITESPACE"," ",55],["T_VARIABLE","$type_name",55],",",["T_WHITESPACE"," ",55],["T_ARRAY","array",55],"(",["T_CONSTANT_ENCAPSED_STRING","'file_directory'",55],["T_WHITESPACE"," ",55],["T_DOUBLE_ARROW","=>",55],["T_WHITESPACE"," ",55],["T_CONSTANT_ENCAPSED_STRING","'[current-user:uid]\/[current-user:name]'",55],")",")",";",["T_WHITESPACE","\n\n    ",55],["T_COMMENT","\/\/ Upload a new file into the token subdirectories.\n",57],["T_WHITESPACE","    ",58],["T_VARIABLE","$nid",58],["T_WHITESPACE"," ",58],"=",["T_WHITESPACE"," ",58],["T_VARIABLE","$this",58],["T_OBJECT_OPERATOR","->",58],["T_STRING","uploadNodeFile",58],"(",["T_VARIABLE","$test_file",58],",",["T_WHITESPACE"," ",58],["T_VARIABLE","$field_name",58],",",["T_WHITESPACE"," ",58],["T_VARIABLE","$type_name",58],")",";",["T_WHITESPACE","\n\n    ",58],["T_COMMENT","\/\/ Check that the file was uploaded into the subdirectory.\n",60],["T_WHITESPACE","    ",61],["T_VARIABLE","$node_storage",61],["T_OBJECT_OPERATOR","->",61],["T_STRING","resetCache",61],"(",["T_ARRAY","array",61],"(",["T_VARIABLE","$nid",61],")",")",";",["T_WHITESPACE","\n    ",61],["T_VARIABLE","$node",62],["T_WHITESPACE"," ",62],"=",["T_WHITESPACE"," ",62],["T_VARIABLE","$node_storage",62],["T_OBJECT_OPERATOR","->",62],["T_STRING","load",62],"(",["T_VARIABLE","$nid",62],")",";",["T_WHITESPACE","\n    ",62],["T_VARIABLE","$node_file",63],["T_WHITESPACE"," ",63],"=",["T_WHITESPACE"," ",63],["T_STRING","File",63],["T_DOUBLE_COLON","::",63],["T_STRING","load",63],"(",["T_VARIABLE","$node",63],["T_OBJECT_OPERATOR","->",63],"{",["T_VARIABLE","$field_name",63],"}",["T_OBJECT_OPERATOR","->",63],["T_STRING","target_id",63],")",";",["T_WHITESPACE","\n    ",63],["T_COMMENT","\/\/ Do token replacement using the same user which uploaded the file, not\n",64],["T_WHITESPACE","    ",65],["T_COMMENT","\/\/ the user running the test case.\n",65],["T_WHITESPACE","    ",66],["T_VARIABLE","$data",66],["T_WHITESPACE"," ",66],"=",["T_WHITESPACE"," ",66],["T_ARRAY","array",66],"(",["T_CONSTANT_ENCAPSED_STRING","'user'",66],["T_WHITESPACE"," ",66],["T_DOUBLE_ARROW","=>",66],["T_WHITESPACE"," ",66],["T_VARIABLE","$this",66],["T_OBJECT_OPERATOR","->",66],["T_STRING","adminUser",66],")",";",["T_WHITESPACE","\n    ",66],["T_VARIABLE","$subdirectory",67],["T_WHITESPACE"," ",67],"=",["T_WHITESPACE"," ",67],["T_NS_SEPARATOR","\\",67],["T_STRING","Drupal",67],["T_DOUBLE_COLON","::",67],["T_STRING","token",67],"(",")",["T_OBJECT_OPERATOR","->",67],["T_STRING","replace",67],"(",["T_CONSTANT_ENCAPSED_STRING","'[user:uid]\/[user:name]'",67],",",["T_WHITESPACE"," ",67],["T_VARIABLE","$data",67],")",";",["T_WHITESPACE","\n    ",67],["T_VARIABLE","$this",68],["T_OBJECT_OPERATOR","->",68],["T_STRING","assertPathMatch",68],"(",["T_CONSTANT_ENCAPSED_STRING","'public:\/\/'",68],["T_WHITESPACE"," ",68],".",["T_WHITESPACE"," ",68],["T_VARIABLE","$subdirectory",68],["T_WHITESPACE"," ",68],".",["T_WHITESPACE"," ",68],["T_CONSTANT_ENCAPSED_STRING","'\/'",68],["T_WHITESPACE"," ",68],".",["T_WHITESPACE"," ",68],["T_VARIABLE","$test_file",68],["T_OBJECT_OPERATOR","->",68],["T_STRING","getFilename",68],"(",")",",",["T_WHITESPACE"," ",68],["T_VARIABLE","$node_file",68],["T_OBJECT_OPERATOR","->",68],["T_STRING","getFileUri",68],"(",")",",",["T_WHITESPACE"," ",68],["T_STRING","format_string",68],"(",["T_CONSTANT_ENCAPSED_STRING","'The file %file was uploaded to the correct path with token replacements.'",68],",",["T_WHITESPACE"," ",68],["T_ARRAY","array",68],"(",["T_CONSTANT_ENCAPSED_STRING","'%file'",68],["T_WHITESPACE"," ",68],["T_DOUBLE_ARROW","=>",68],["T_WHITESPACE"," ",68],["T_VARIABLE","$node_file",68],["T_OBJECT_OPERATOR","->",68],["T_STRING","getFileUri",68],"(",")",")",")",")",";",["T_WHITESPACE","\n  ",68],"}",["T_WHITESPACE","\n\n  ",69],["T_DOC_COMMENT","\/**\n   * Asserts that a file is uploaded to the right location.\n   *\n   * @param string $expected_path\n   *   The location where the file is expected to be uploaded. Duplicate file\n   *   names to not need to be taken into account.\n   * @param string $actual_path\n   *   Where the file was actually uploaded.\n   * @param string $message\n   *   The message to display with this assertion.\n   *\/",71],["T_WHITESPACE","\n  ",81],["T_FUNCTION","function",82],["T_WHITESPACE"," ",82],["T_STRING","assertPathMatch",82],"(",["T_VARIABLE","$expected_path",82],",",["T_WHITESPACE"," ",82],["T_VARIABLE","$actual_path",82],",",["T_WHITESPACE"," ",82],["T_VARIABLE","$message",82],")",["T_WHITESPACE"," ",82],"{",["T_WHITESPACE","\n    ",82],["T_COMMENT","\/\/ Strip off the extension of the expected path to allow for _0, _1, etc.\n",83],["T_WHITESPACE","    ",84],["T_COMMENT","\/\/ suffixes when the file hits a duplicate name.\n",84],["T_WHITESPACE","    ",85],["T_VARIABLE","$pos",85],["T_WHITESPACE"," ",85],"=",["T_WHITESPACE"," ",85],["T_STRING","strrpos",85],"(",["T_VARIABLE","$expected_path",85],",",["T_WHITESPACE"," ",85],["T_CONSTANT_ENCAPSED_STRING","'.'",85],")",";",["T_WHITESPACE","\n    ",85],["T_VARIABLE","$base_path",86],["T_WHITESPACE"," ",86],"=",["T_WHITESPACE"," ",86],["T_STRING","substr",86],"(",["T_VARIABLE","$expected_path",86],",",["T_WHITESPACE"," ",86],["T_LNUMBER","0",86],",",["T_WHITESPACE"," ",86],["T_VARIABLE","$pos",86],")",";",["T_WHITESPACE","\n    ",86],["T_VARIABLE","$extension",87],["T_WHITESPACE"," ",87],"=",["T_WHITESPACE"," ",87],["T_STRING","substr",87],"(",["T_VARIABLE","$expected_path",87],",",["T_WHITESPACE"," ",87],["T_VARIABLE","$pos",87],["T_WHITESPACE"," ",87],"+",["T_WHITESPACE"," ",87],["T_LNUMBER","1",87],")",";",["T_WHITESPACE","\n\n    ",87],["T_VARIABLE","$result",89],["T_WHITESPACE"," ",89],"=",["T_WHITESPACE"," ",89],["T_STRING","preg_match",89],"(",["T_CONSTANT_ENCAPSED_STRING","'\/'",89],["T_WHITESPACE"," ",89],".",["T_WHITESPACE"," ",89],["T_STRING","preg_quote",89],"(",["T_VARIABLE","$base_path",89],",",["T_WHITESPACE"," ",89],["T_CONSTANT_ENCAPSED_STRING","'\/'",89],")",["T_WHITESPACE"," ",89],".",["T_WHITESPACE"," ",89],["T_CONSTANT_ENCAPSED_STRING","'(_[0-9]+)?\\.'",89],["T_WHITESPACE"," ",89],".",["T_WHITESPACE"," ",89],["T_STRING","preg_quote",89],"(",["T_VARIABLE","$extension",89],",",["T_WHITESPACE"," ",89],["T_CONSTANT_ENCAPSED_STRING","'\/'",89],")",["T_WHITESPACE"," ",89],".",["T_WHITESPACE"," ",89],["T_CONSTANT_ENCAPSED_STRING","'\/'",89],",",["T_WHITESPACE"," ",89],["T_VARIABLE","$actual_path",89],")",";",["T_WHITESPACE","\n    ",89],["T_VARIABLE","$this",90],["T_OBJECT_OPERATOR","->",90],["T_STRING","assertTrue",90],"(",["T_VARIABLE","$result",90],",",["T_WHITESPACE"," ",90],["T_VARIABLE","$message",90],")",";",["T_WHITESPACE","\n  ",90],"}",["T_WHITESPACE","\n\n",91],"}",["T_WHITESPACE","\n",93]]