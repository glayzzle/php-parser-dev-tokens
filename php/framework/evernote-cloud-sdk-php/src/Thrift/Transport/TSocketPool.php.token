[["T_OPEN_TAG","<?php\n",1],["T_COMMENT","\/*\n * Licensed to the Apache Software Foundation (ASF) under one\n * or more contributor license agreements. See the NOTICE file\n * distributed with this work for additional information\n * regarding copyright ownership. The ASF licenses this file\n * to you under the Apache License, Version 2.0 (the\n * \"License\"); you may not use this file except in compliance\n * with the License. You may obtain a copy of the License at\n *\n *   http:\/\/www.apache.org\/licenses\/LICENSE-2.0\n *\n * Unless required by applicable law or agreed to in writing,\n * software distributed under the License is distributed on an\n * \"AS IS\" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY\n * KIND, either express or implied. See the License for the\n * specific language governing permissions and limitations\n * under the License.\n *\n * @package thrift.transport\n *\/",2],["T_WHITESPACE","\n\n",21],["T_NAMESPACE","namespace",23],["T_WHITESPACE"," ",23],["T_STRING","Thrift",23],["T_NS_SEPARATOR","\\",23],["T_STRING","Transport",23],";",["T_WHITESPACE","\n\n",23],["T_USE","use",25],["T_WHITESPACE"," ",25],["T_STRING","Thrift",25],["T_NS_SEPARATOR","\\",25],["T_STRING","Transport",25],["T_NS_SEPARATOR","\\",25],["T_STRING","TSocket",25],";",["T_WHITESPACE","\n",25],["T_USE","use",26],["T_WHITESPACE"," ",26],["T_STRING","Thrift",26],["T_NS_SEPARATOR","\\",26],["T_STRING","Exception",26],["T_NS_SEPARATOR","\\",26],["T_STRING","TException",26],";",["T_WHITESPACE","\n\n",26],["T_DOC_COMMENT","\/**\n * This library makes use of APC cache to make hosts as down in a web\n * environment. If you are running from the CLI or on a system without APC\n * installed, then these null functions will step in and act like cache\n * misses.\n *\/",28],["T_WHITESPACE","\n",33],["T_IF","if",34],["T_WHITESPACE"," ",34],"(","!",["T_STRING","function_exists",34],"(",["T_CONSTANT_ENCAPSED_STRING","'apc_fetch'",34],")",")",["T_WHITESPACE"," ",34],"{",["T_WHITESPACE","\n  ",34],["T_FUNCTION","function",35],["T_WHITESPACE"," ",35],["T_STRING","apc_fetch",35],"(",["T_VARIABLE","$key",35],")",["T_WHITESPACE"," ",35],"{",["T_WHITESPACE"," ",35],["T_RETURN","return",35],["T_WHITESPACE"," ",35],["T_STRING","FALSE",35],";",["T_WHITESPACE"," ",35],"}",["T_WHITESPACE","\n  ",35],["T_FUNCTION","function",36],["T_WHITESPACE"," ",36],["T_STRING","apc_store",36],"(",["T_VARIABLE","$key",36],",",["T_WHITESPACE"," ",36],["T_VARIABLE","$var",36],",",["T_WHITESPACE"," ",36],["T_VARIABLE","$ttl",36],"=",["T_LNUMBER","0",36],")",["T_WHITESPACE"," ",36],"{",["T_WHITESPACE"," ",36],["T_RETURN","return",36],["T_WHITESPACE"," ",36],["T_STRING","FALSE",36],";",["T_WHITESPACE"," ",36],"}",["T_WHITESPACE","\n",36],"}",["T_WHITESPACE","\n\n",37],["T_DOC_COMMENT","\/**\n * Sockets implementation of the TTransport interface that allows connection\n * to a pool of servers.\n *\n * @package thrift.transport\n *\/",39],["T_WHITESPACE","\n",44],["T_CLASS","class",45],["T_WHITESPACE"," ",45],["T_STRING","TSocketPool",45],["T_WHITESPACE"," ",45],["T_EXTENDS","extends",45],["T_WHITESPACE"," ",45],["T_STRING","TSocket",45],["T_WHITESPACE"," ",45],"{",["T_WHITESPACE","\n\n  ",45],["T_DOC_COMMENT","\/**\n   * Remote servers. Array of associative arrays with 'host' and 'port' keys\n   *\/",47],["T_WHITESPACE","\n  ",49],["T_PRIVATE","private",50],["T_WHITESPACE"," ",50],["T_VARIABLE","$servers_",50],["T_WHITESPACE"," ",50],"=",["T_WHITESPACE"," ",50],["T_ARRAY","array",50],"(",")",";",["T_WHITESPACE","\n\n  ",50],["T_DOC_COMMENT","\/**\n   * How many times to retry each host in connect\n   *\n   * @var int\n   *\/",52],["T_WHITESPACE","\n  ",56],["T_PRIVATE","private",57],["T_WHITESPACE"," ",57],["T_VARIABLE","$numRetries_",57],["T_WHITESPACE"," ",57],"=",["T_WHITESPACE"," ",57],["T_LNUMBER","1",57],";",["T_WHITESPACE","\n\n  ",57],["T_DOC_COMMENT","\/**\n   * Retry interval in seconds, how long to not try a host if it has been\n   * marked as down.\n   *\n   * @var int\n   *\/",59],["T_WHITESPACE","\n  ",64],["T_PRIVATE","private",65],["T_WHITESPACE"," ",65],["T_VARIABLE","$retryInterval_",65],["T_WHITESPACE"," ",65],"=",["T_WHITESPACE"," ",65],["T_LNUMBER","60",65],";",["T_WHITESPACE","\n\n  ",65],["T_DOC_COMMENT","\/**\n   * Max consecutive failures before marking a host down.\n   *\n   * @var int\n   *\/",67],["T_WHITESPACE","\n  ",71],["T_PRIVATE","private",72],["T_WHITESPACE"," ",72],["T_VARIABLE","$maxConsecutiveFailures_",72],["T_WHITESPACE"," ",72],"=",["T_WHITESPACE"," ",72],["T_LNUMBER","1",72],";",["T_WHITESPACE","\n\n  ",72],["T_DOC_COMMENT","\/**\n   * Try hosts in order? or Randomized?\n   *\n   * @var bool\n   *\/",74],["T_WHITESPACE","\n  ",78],["T_PRIVATE","private",79],["T_WHITESPACE"," ",79],["T_VARIABLE","$randomize_",79],["T_WHITESPACE"," ",79],"=",["T_WHITESPACE"," ",79],["T_STRING","TRUE",79],";",["T_WHITESPACE","\n\n  ",79],["T_DOC_COMMENT","\/**\n   * Always try last host, even if marked down?\n   *\n   * @var bool\n   *\/",81],["T_WHITESPACE","\n  ",85],["T_PRIVATE","private",86],["T_WHITESPACE"," ",86],["T_VARIABLE","$alwaysTryLast_",86],["T_WHITESPACE"," ",86],"=",["T_WHITESPACE"," ",86],["T_STRING","TRUE",86],";",["T_WHITESPACE","\n\n  ",86],["T_DOC_COMMENT","\/**\n   * Socket pool constructor\n   *\n   * @param array  $hosts        List of remote hostnames\n   * @param mixed  $ports        Array of remote ports, or a single common port\n   * @param bool   $persist      Whether to use a persistent socket\n   * @param mixed  $debugHandler Function for error logging\n   *\/",88],["T_WHITESPACE","\n  ",95],["T_PUBLIC","public",96],["T_WHITESPACE"," ",96],["T_FUNCTION","function",96],["T_WHITESPACE"," ",96],["T_STRING","__construct",96],"(",["T_VARIABLE","$hosts",96],"=",["T_ARRAY","array",96],"(",["T_CONSTANT_ENCAPSED_STRING","'localhost'",96],")",",",["T_WHITESPACE","\n                              ",96],["T_VARIABLE","$ports",97],"=",["T_ARRAY","array",97],"(",["T_LNUMBER","9090",97],")",",",["T_WHITESPACE","\n                              ",97],["T_VARIABLE","$persist",98],"=",["T_STRING","FALSE",98],",",["T_WHITESPACE","\n                              ",98],["T_VARIABLE","$debugHandler",99],"=",["T_STRING","null",99],")",["T_WHITESPACE"," ",99],"{",["T_WHITESPACE","\n    ",99],["T_STRING","parent",100],["T_DOUBLE_COLON","::",100],["T_STRING","__construct",100],"(",["T_STRING","null",100],",",["T_WHITESPACE"," ",100],["T_LNUMBER","0",100],",",["T_WHITESPACE"," ",100],["T_VARIABLE","$persist",100],",",["T_WHITESPACE"," ",100],["T_VARIABLE","$debugHandler",100],")",";",["T_WHITESPACE","\n\n    ",100],["T_IF","if",102],["T_WHITESPACE"," ",102],"(","!",["T_STRING","is_array",102],"(",["T_VARIABLE","$ports",102],")",")",["T_WHITESPACE"," ",102],"{",["T_WHITESPACE","\n      ",102],["T_VARIABLE","$port",103],["T_WHITESPACE"," ",103],"=",["T_WHITESPACE"," ",103],["T_VARIABLE","$ports",103],";",["T_WHITESPACE","\n      ",103],["T_VARIABLE","$ports",104],["T_WHITESPACE"," ",104],"=",["T_WHITESPACE"," ",104],["T_ARRAY","array",104],"(",")",";",["T_WHITESPACE","\n      ",104],["T_FOREACH","foreach",105],["T_WHITESPACE"," ",105],"(",["T_VARIABLE","$hosts",105],["T_WHITESPACE"," ",105],["T_AS","as",105],["T_WHITESPACE"," ",105],["T_VARIABLE","$key",105],["T_WHITESPACE"," ",105],["T_DOUBLE_ARROW","=>",105],["T_WHITESPACE"," ",105],["T_VARIABLE","$val",105],")",["T_WHITESPACE"," ",105],"{",["T_WHITESPACE","\n        ",105],["T_VARIABLE","$ports",106],"[",["T_VARIABLE","$key",106],"]",["T_WHITESPACE"," ",106],"=",["T_WHITESPACE"," ",106],["T_VARIABLE","$port",106],";",["T_WHITESPACE","\n      ",106],"}",["T_WHITESPACE","\n    ",107],"}",["T_WHITESPACE","\n\n    ",108],["T_FOREACH","foreach",110],["T_WHITESPACE"," ",110],"(",["T_VARIABLE","$hosts",110],["T_WHITESPACE"," ",110],["T_AS","as",110],["T_WHITESPACE"," ",110],["T_VARIABLE","$key",110],["T_WHITESPACE"," ",110],["T_DOUBLE_ARROW","=>",110],["T_WHITESPACE"," ",110],["T_VARIABLE","$host",110],")",["T_WHITESPACE"," ",110],"{",["T_WHITESPACE","\n      ",110],["T_VARIABLE","$this",111],["T_OBJECT_OPERATOR","->",111],["T_STRING","servers_",111],["T_WHITESPACE"," ",111],"[","]","=",["T_WHITESPACE"," ",111],["T_ARRAY","array",111],"(",["T_CONSTANT_ENCAPSED_STRING","'host'",111],["T_WHITESPACE"," ",111],["T_DOUBLE_ARROW","=>",111],["T_WHITESPACE"," ",111],["T_VARIABLE","$host",111],",",["T_WHITESPACE","\n                                ",111],["T_CONSTANT_ENCAPSED_STRING","'port'",112],["T_WHITESPACE"," ",112],["T_DOUBLE_ARROW","=>",112],["T_WHITESPACE"," ",112],["T_VARIABLE","$ports",112],"[",["T_VARIABLE","$key",112],"]",")",";",["T_WHITESPACE","\n    ",112],"}",["T_WHITESPACE","\n  ",113],"}",["T_WHITESPACE","\n\n  ",114],["T_DOC_COMMENT","\/**\n   * Add a server to the pool\n   *\n   * This function does not prevent you from adding a duplicate server entry.\n   *\n   * @param string $host hostname or IP\n   * @param int $port port\n   *\/",116],["T_WHITESPACE","\n  ",123],["T_PUBLIC","public",124],["T_WHITESPACE"," ",124],["T_FUNCTION","function",124],["T_WHITESPACE"," ",124],["T_STRING","addServer",124],"(",["T_VARIABLE","$host",124],",",["T_WHITESPACE"," ",124],["T_VARIABLE","$port",124],")",["T_WHITESPACE"," ",124],"{",["T_WHITESPACE","\n    ",124],["T_VARIABLE","$this",125],["T_OBJECT_OPERATOR","->",125],["T_STRING","servers_",125],"[","]",["T_WHITESPACE"," ",125],"=",["T_WHITESPACE"," ",125],["T_ARRAY","array",125],"(",["T_CONSTANT_ENCAPSED_STRING","'host'",125],["T_WHITESPACE"," ",125],["T_DOUBLE_ARROW","=>",125],["T_WHITESPACE"," ",125],["T_VARIABLE","$host",125],",",["T_WHITESPACE"," ",125],["T_CONSTANT_ENCAPSED_STRING","'port'",125],["T_WHITESPACE"," ",125],["T_DOUBLE_ARROW","=>",125],["T_WHITESPACE"," ",125],["T_VARIABLE","$port",125],")",";",["T_WHITESPACE","\n  ",125],"}",["T_WHITESPACE","\n\n  ",126],["T_DOC_COMMENT","\/**\n   * Sets how many time to keep retrying a host in the connect function.\n   *\n   * @param int $numRetries\n   *\/",128],["T_WHITESPACE","\n  ",132],["T_PUBLIC","public",133],["T_WHITESPACE"," ",133],["T_FUNCTION","function",133],["T_WHITESPACE"," ",133],["T_STRING","setNumRetries",133],"(",["T_VARIABLE","$numRetries",133],")",["T_WHITESPACE"," ",133],"{",["T_WHITESPACE","\n    ",133],["T_VARIABLE","$this",134],["T_OBJECT_OPERATOR","->",134],["T_STRING","numRetries_",134],["T_WHITESPACE"," ",134],"=",["T_WHITESPACE"," ",134],["T_VARIABLE","$numRetries",134],";",["T_WHITESPACE","\n  ",134],"}",["T_WHITESPACE","\n\n  ",135],["T_DOC_COMMENT","\/**\n   * Sets how long to wait until retrying a host if it was marked down\n   *\n   * @param int $numRetries\n   *\/",137],["T_WHITESPACE","\n  ",141],["T_PUBLIC","public",142],["T_WHITESPACE"," ",142],["T_FUNCTION","function",142],["T_WHITESPACE"," ",142],["T_STRING","setRetryInterval",142],"(",["T_VARIABLE","$retryInterval",142],")",["T_WHITESPACE"," ",142],"{",["T_WHITESPACE","\n    ",142],["T_VARIABLE","$this",143],["T_OBJECT_OPERATOR","->",143],["T_STRING","retryInterval_",143],["T_WHITESPACE"," ",143],"=",["T_WHITESPACE"," ",143],["T_VARIABLE","$retryInterval",143],";",["T_WHITESPACE","\n  ",143],"}",["T_WHITESPACE","\n\n  ",144],["T_DOC_COMMENT","\/**\n   * Sets how many time to keep retrying a host before marking it as down.\n   *\n   * @param int $numRetries\n   *\/",146],["T_WHITESPACE","\n  ",150],["T_PUBLIC","public",151],["T_WHITESPACE"," ",151],["T_FUNCTION","function",151],["T_WHITESPACE"," ",151],["T_STRING","setMaxConsecutiveFailures",151],"(",["T_VARIABLE","$maxConsecutiveFailures",151],")",["T_WHITESPACE"," ",151],"{",["T_WHITESPACE","\n    ",151],["T_VARIABLE","$this",152],["T_OBJECT_OPERATOR","->",152],["T_STRING","maxConsecutiveFailures_",152],["T_WHITESPACE"," ",152],"=",["T_WHITESPACE"," ",152],["T_VARIABLE","$maxConsecutiveFailures",152],";",["T_WHITESPACE","\n  ",152],"}",["T_WHITESPACE","\n\n  ",153],["T_DOC_COMMENT","\/**\n   * Turns randomization in connect order on or off.\n   *\n   * @param bool $randomize\n   *\/",155],["T_WHITESPACE","\n  ",159],["T_PUBLIC","public",160],["T_WHITESPACE"," ",160],["T_FUNCTION","function",160],["T_WHITESPACE"," ",160],["T_STRING","setRandomize",160],"(",["T_VARIABLE","$randomize",160],")",["T_WHITESPACE"," ",160],"{",["T_WHITESPACE","\n    ",160],["T_VARIABLE","$this",161],["T_OBJECT_OPERATOR","->",161],["T_STRING","randomize_",161],["T_WHITESPACE"," ",161],"=",["T_WHITESPACE"," ",161],["T_VARIABLE","$randomize",161],";",["T_WHITESPACE","\n  ",161],"}",["T_WHITESPACE","\n\n  ",162],["T_DOC_COMMENT","\/**\n   * Whether to always try the last server.\n   *\n   * @param bool $alwaysTryLast\n   *\/",164],["T_WHITESPACE","\n  ",168],["T_PUBLIC","public",169],["T_WHITESPACE"," ",169],["T_FUNCTION","function",169],["T_WHITESPACE"," ",169],["T_STRING","setAlwaysTryLast",169],"(",["T_VARIABLE","$alwaysTryLast",169],")",["T_WHITESPACE"," ",169],"{",["T_WHITESPACE","\n    ",169],["T_VARIABLE","$this",170],["T_OBJECT_OPERATOR","->",170],["T_STRING","alwaysTryLast_",170],["T_WHITESPACE"," ",170],"=",["T_WHITESPACE"," ",170],["T_VARIABLE","$alwaysTryLast",170],";",["T_WHITESPACE","\n  ",170],"}",["T_WHITESPACE","\n\n\n  ",171],["T_DOC_COMMENT","\/**\n   * Connects the socket by iterating through all the servers in the pool\n   * and trying to find one that works.\n   *\/",174],["T_WHITESPACE","\n  ",177],["T_PUBLIC","public",178],["T_WHITESPACE"," ",178],["T_FUNCTION","function",178],["T_WHITESPACE"," ",178],["T_STRING","open",178],"(",")",["T_WHITESPACE"," ",178],"{",["T_WHITESPACE","\n    ",178],["T_COMMENT","\/\/ Check if we want order randomization\n",179],["T_WHITESPACE","    ",180],["T_IF","if",180],["T_WHITESPACE"," ",180],"(",["T_VARIABLE","$this",180],["T_OBJECT_OPERATOR","->",180],["T_STRING","randomize_",180],")",["T_WHITESPACE"," ",180],"{",["T_WHITESPACE","\n      ",180],["T_STRING","shuffle",181],"(",["T_VARIABLE","$this",181],["T_OBJECT_OPERATOR","->",181],["T_STRING","servers_",181],")",";",["T_WHITESPACE","\n    ",181],"}",["T_WHITESPACE","\n\n    ",182],["T_COMMENT","\/\/ Count servers to identify the \"last\" one\n",184],["T_WHITESPACE","    ",185],["T_VARIABLE","$numServers",185],["T_WHITESPACE"," ",185],"=",["T_WHITESPACE"," ",185],["T_STRING","count",185],"(",["T_VARIABLE","$this",185],["T_OBJECT_OPERATOR","->",185],["T_STRING","servers_",185],")",";",["T_WHITESPACE","\n\n    ",185],["T_FOR","for",187],["T_WHITESPACE"," ",187],"(",["T_VARIABLE","$i",187],["T_WHITESPACE"," ",187],"=",["T_WHITESPACE"," ",187],["T_LNUMBER","0",187],";",["T_WHITESPACE"," ",187],["T_VARIABLE","$i",187],["T_WHITESPACE"," ",187],"<",["T_WHITESPACE"," ",187],["T_VARIABLE","$numServers",187],";",["T_WHITESPACE"," ",187],["T_INC","++",187],["T_VARIABLE","$i",187],")",["T_WHITESPACE"," ",187],"{",["T_WHITESPACE","\n\n      ",187],["T_COMMENT","\/\/ This extracts the $host and $port variables\n",189],["T_WHITESPACE","      ",190],["T_STRING","extract",190],"(",["T_VARIABLE","$this",190],["T_OBJECT_OPERATOR","->",190],["T_STRING","servers_",190],"[",["T_VARIABLE","$i",190],"]",")",";",["T_WHITESPACE","\n\n      ",190],["T_COMMENT","\/\/ Check APC cache for a record of this server being down\n",192],["T_WHITESPACE","      ",193],["T_VARIABLE","$failtimeKey",193],["T_WHITESPACE"," ",193],"=",["T_WHITESPACE"," ",193],["T_CONSTANT_ENCAPSED_STRING","'thrift_failtime:'",193],".",["T_VARIABLE","$host",193],".",["T_CONSTANT_ENCAPSED_STRING","':'",193],".",["T_VARIABLE","$port",193],".",["T_CONSTANT_ENCAPSED_STRING","'~'",193],";",["T_WHITESPACE","\n\n      ",193],["T_COMMENT","\/\/ Cache miss? Assume it's OK\n",195],["T_WHITESPACE","      ",196],["T_VARIABLE","$lastFailtime",196],["T_WHITESPACE"," ",196],"=",["T_WHITESPACE"," ",196],["T_STRING","apc_fetch",196],"(",["T_VARIABLE","$failtimeKey",196],")",";",["T_WHITESPACE","\n      ",196],["T_IF","if",197],["T_WHITESPACE"," ",197],"(",["T_VARIABLE","$lastFailtime",197],["T_WHITESPACE"," ",197],["T_IS_IDENTICAL","===",197],["T_WHITESPACE"," ",197],["T_STRING","FALSE",197],")",["T_WHITESPACE"," ",197],"{",["T_WHITESPACE","\n        ",197],["T_VARIABLE","$lastFailtime",198],["T_WHITESPACE"," ",198],"=",["T_WHITESPACE"," ",198],["T_LNUMBER","0",198],";",["T_WHITESPACE","\n      ",198],"}",["T_WHITESPACE","\n\n      ",199],["T_VARIABLE","$retryIntervalPassed",201],["T_WHITESPACE"," ",201],"=",["T_WHITESPACE"," ",201],["T_STRING","FALSE",201],";",["T_WHITESPACE","\n\n      ",201],["T_COMMENT","\/\/ Cache hit...make sure enough the retry interval has elapsed\n",203],["T_WHITESPACE","      ",204],["T_IF","if",204],["T_WHITESPACE"," ",204],"(",["T_VARIABLE","$lastFailtime",204],["T_WHITESPACE"," ",204],">",["T_WHITESPACE"," ",204],["T_LNUMBER","0",204],")",["T_WHITESPACE"," ",204],"{",["T_WHITESPACE","\n        ",204],["T_VARIABLE","$elapsed",205],["T_WHITESPACE"," ",205],"=",["T_WHITESPACE"," ",205],["T_STRING","time",205],"(",")",["T_WHITESPACE"," ",205],"-",["T_WHITESPACE"," ",205],["T_VARIABLE","$lastFailtime",205],";",["T_WHITESPACE","\n        ",205],["T_IF","if",206],["T_WHITESPACE"," ",206],"(",["T_VARIABLE","$elapsed",206],["T_WHITESPACE"," ",206],">",["T_WHITESPACE"," ",206],["T_VARIABLE","$this",206],["T_OBJECT_OPERATOR","->",206],["T_STRING","retryInterval_",206],")",["T_WHITESPACE"," ",206],"{",["T_WHITESPACE","\n          ",206],["T_VARIABLE","$retryIntervalPassed",207],["T_WHITESPACE"," ",207],"=",["T_WHITESPACE"," ",207],["T_STRING","TRUE",207],";",["T_WHITESPACE","\n          ",207],["T_IF","if",208],["T_WHITESPACE"," ",208],"(",["T_VARIABLE","$this",208],["T_OBJECT_OPERATOR","->",208],["T_STRING","debug_",208],")",["T_WHITESPACE"," ",208],"{",["T_WHITESPACE","\n            ",208],["T_STRING","call_user_func",209],"(",["T_VARIABLE","$this",209],["T_OBJECT_OPERATOR","->",209],["T_STRING","debugHandler_",209],",",["T_WHITESPACE","\n                           ",209],["T_CONSTANT_ENCAPSED_STRING","'TSocketPool: retryInterval '",210],".",["T_WHITESPACE","\n                           ",210],["T_CONSTANT_ENCAPSED_STRING","'('",211],".",["T_VARIABLE","$this",211],["T_OBJECT_OPERATOR","->",211],["T_STRING","retryInterval_",211],".",["T_CONSTANT_ENCAPSED_STRING","') '",211],".",["T_WHITESPACE","\n                           ",211],["T_CONSTANT_ENCAPSED_STRING","'has passed for host '",212],".",["T_VARIABLE","$host",212],".",["T_CONSTANT_ENCAPSED_STRING","':'",212],".",["T_VARIABLE","$port",212],")",";",["T_WHITESPACE","\n          ",212],"}",["T_WHITESPACE","\n        ",213],"}",["T_WHITESPACE","\n      ",214],"}",["T_WHITESPACE","\n\n      ",215],["T_COMMENT","\/\/ Only connect if not in the middle of a fail interval, OR if this\n",217],["T_WHITESPACE","      ",218],["T_COMMENT","\/\/ is the LAST server we are trying, just hammer away on it\n",218],["T_WHITESPACE","      ",219],["T_VARIABLE","$isLastServer",219],["T_WHITESPACE"," ",219],"=",["T_WHITESPACE"," ",219],["T_STRING","FALSE",219],";",["T_WHITESPACE","\n      ",219],["T_IF","if",220],["T_WHITESPACE"," ",220],"(",["T_VARIABLE","$this",220],["T_OBJECT_OPERATOR","->",220],["T_STRING","alwaysTryLast_",220],")",["T_WHITESPACE"," ",220],"{",["T_WHITESPACE","\n        ",220],["T_VARIABLE","$isLastServer",221],["T_WHITESPACE"," ",221],"=",["T_WHITESPACE"," ",221],"(",["T_VARIABLE","$i",221],["T_WHITESPACE"," ",221],["T_IS_EQUAL","==",221],["T_WHITESPACE"," ",221],"(",["T_VARIABLE","$numServers",221],["T_WHITESPACE"," ",221],"-",["T_WHITESPACE"," ",221],["T_LNUMBER","1",221],")",")",";",["T_WHITESPACE","\n      ",221],"}",["T_WHITESPACE","\n\n      ",222],["T_IF","if",224],["T_WHITESPACE"," ",224],"(","(",["T_VARIABLE","$lastFailtime",224],["T_WHITESPACE"," ",224],["T_IS_IDENTICAL","===",224],["T_WHITESPACE"," ",224],["T_LNUMBER","0",224],")",["T_WHITESPACE"," ",224],["T_BOOLEAN_OR","||",224],["T_WHITESPACE","\n          ",224],"(",["T_VARIABLE","$isLastServer",225],")",["T_WHITESPACE"," ",225],["T_BOOLEAN_OR","||",225],["T_WHITESPACE","\n          ",225],"(",["T_VARIABLE","$lastFailtime",226],["T_WHITESPACE"," ",226],">",["T_WHITESPACE"," ",226],["T_LNUMBER","0",226],["T_WHITESPACE"," ",226],["T_BOOLEAN_AND","&&",226],["T_WHITESPACE"," ",226],["T_VARIABLE","$retryIntervalPassed",226],")",")",["T_WHITESPACE"," ",226],"{",["T_WHITESPACE","\n\n        ",226],["T_COMMENT","\/\/ Set underlying TSocket params to this one\n",228],["T_WHITESPACE","        ",229],["T_VARIABLE","$this",229],["T_OBJECT_OPERATOR","->",229],["T_STRING","host_",229],["T_WHITESPACE"," ",229],"=",["T_WHITESPACE"," ",229],["T_VARIABLE","$host",229],";",["T_WHITESPACE","\n        ",229],["T_VARIABLE","$this",230],["T_OBJECT_OPERATOR","->",230],["T_STRING","port_",230],["T_WHITESPACE"," ",230],"=",["T_WHITESPACE"," ",230],["T_VARIABLE","$port",230],";",["T_WHITESPACE","\n\n        ",230],["T_COMMENT","\/\/ Try up to numRetries_ connections per server\n",232],["T_WHITESPACE","        ",233],["T_FOR","for",233],["T_WHITESPACE"," ",233],"(",["T_VARIABLE","$attempt",233],["T_WHITESPACE"," ",233],"=",["T_WHITESPACE"," ",233],["T_LNUMBER","0",233],";",["T_WHITESPACE"," ",233],["T_VARIABLE","$attempt",233],["T_WHITESPACE"," ",233],"<",["T_WHITESPACE"," ",233],["T_VARIABLE","$this",233],["T_OBJECT_OPERATOR","->",233],["T_STRING","numRetries_",233],";",["T_WHITESPACE"," ",233],["T_VARIABLE","$attempt",233],["T_INC","++",233],")",["T_WHITESPACE"," ",233],"{",["T_WHITESPACE","\n          ",233],["T_TRY","try",234],["T_WHITESPACE"," ",234],"{",["T_WHITESPACE","\n            ",234],["T_COMMENT","\/\/ Use the underlying TSocket open function\n",235],["T_WHITESPACE","            ",236],["T_STRING","parent",236],["T_DOUBLE_COLON","::",236],["T_STRING","open",236],"(",")",";",["T_WHITESPACE","\n\n            ",236],["T_COMMENT","\/\/ Only clear the failure counts if required to do so\n",238],["T_WHITESPACE","            ",239],["T_IF","if",239],["T_WHITESPACE"," ",239],"(",["T_VARIABLE","$lastFailtime",239],["T_WHITESPACE"," ",239],">",["T_WHITESPACE"," ",239],["T_LNUMBER","0",239],")",["T_WHITESPACE"," ",239],"{",["T_WHITESPACE","\n              ",239],["T_STRING","apc_store",240],"(",["T_VARIABLE","$failtimeKey",240],",",["T_WHITESPACE"," ",240],["T_LNUMBER","0",240],")",";",["T_WHITESPACE","\n            ",240],"}",["T_WHITESPACE","\n\n            ",241],["T_COMMENT","\/\/ Successful connection, return now\n",243],["T_WHITESPACE","            ",244],["T_RETURN","return",244],";",["T_WHITESPACE","\n\n          ",244],"}",["T_WHITESPACE"," ",246],["T_CATCH","catch",246],["T_WHITESPACE"," ",246],"(",["T_STRING","TException",246],["T_WHITESPACE"," ",246],["T_VARIABLE","$tx",246],")",["T_WHITESPACE"," ",246],"{",["T_WHITESPACE","\n            ",246],["T_COMMENT","\/\/ Connection failed\n",247],["T_WHITESPACE","          ",248],"}",["T_WHITESPACE","\n        ",248],"}",["T_WHITESPACE","\n\n        ",249],["T_COMMENT","\/\/ Mark failure of this host in the cache\n",251],["T_WHITESPACE","        ",252],["T_VARIABLE","$consecfailsKey",252],["T_WHITESPACE"," ",252],"=",["T_WHITESPACE"," ",252],["T_CONSTANT_ENCAPSED_STRING","'thrift_consecfails:'",252],".",["T_VARIABLE","$host",252],".",["T_CONSTANT_ENCAPSED_STRING","':'",252],".",["T_VARIABLE","$port",252],".",["T_CONSTANT_ENCAPSED_STRING","'~'",252],";",["T_WHITESPACE","\n\n        ",252],["T_COMMENT","\/\/ Ignore cache misses\n",254],["T_WHITESPACE","        ",255],["T_VARIABLE","$consecfails",255],["T_WHITESPACE"," ",255],"=",["T_WHITESPACE"," ",255],["T_STRING","apc_fetch",255],"(",["T_VARIABLE","$consecfailsKey",255],")",";",["T_WHITESPACE","\n        ",255],["T_IF","if",256],["T_WHITESPACE"," ",256],"(",["T_VARIABLE","$consecfails",256],["T_WHITESPACE"," ",256],["T_IS_IDENTICAL","===",256],["T_WHITESPACE"," ",256],["T_STRING","FALSE",256],")",["T_WHITESPACE"," ",256],"{",["T_WHITESPACE","\n          ",256],["T_VARIABLE","$consecfails",257],["T_WHITESPACE"," ",257],"=",["T_WHITESPACE"," ",257],["T_LNUMBER","0",257],";",["T_WHITESPACE","\n        ",257],"}",["T_WHITESPACE","\n\n        ",258],["T_COMMENT","\/\/ Increment by one\n",260],["T_WHITESPACE","        ",261],["T_VARIABLE","$consecfails",261],["T_INC","++",261],";",["T_WHITESPACE","\n\n        ",261],["T_COMMENT","\/\/ Log and cache this failure\n",263],["T_WHITESPACE","        ",264],["T_IF","if",264],["T_WHITESPACE"," ",264],"(",["T_VARIABLE","$consecfails",264],["T_WHITESPACE"," ",264],["T_IS_GREATER_OR_EQUAL",">=",264],["T_WHITESPACE"," ",264],["T_VARIABLE","$this",264],["T_OBJECT_OPERATOR","->",264],["T_STRING","maxConsecutiveFailures_",264],")",["T_WHITESPACE"," ",264],"{",["T_WHITESPACE","\n          ",264],["T_IF","if",265],["T_WHITESPACE"," ",265],"(",["T_VARIABLE","$this",265],["T_OBJECT_OPERATOR","->",265],["T_STRING","debug_",265],")",["T_WHITESPACE"," ",265],"{",["T_WHITESPACE","\n            ",265],["T_STRING","call_user_func",266],"(",["T_VARIABLE","$this",266],["T_OBJECT_OPERATOR","->",266],["T_STRING","debugHandler_",266],",",["T_WHITESPACE","\n                           ",266],["T_CONSTANT_ENCAPSED_STRING","'TSocketPool: marking '",267],".",["T_VARIABLE","$host",267],".",["T_CONSTANT_ENCAPSED_STRING","':'",267],".",["T_VARIABLE","$port",267],".",["T_WHITESPACE","\n                           ",267],["T_CONSTANT_ENCAPSED_STRING","' as down for '",268],".",["T_VARIABLE","$this",268],["T_OBJECT_OPERATOR","->",268],["T_STRING","retryInterval_",268],".",["T_CONSTANT_ENCAPSED_STRING","' secs '",268],".",["T_WHITESPACE","\n                           ",268],["T_CONSTANT_ENCAPSED_STRING","'after '",269],".",["T_VARIABLE","$consecfails",269],".",["T_CONSTANT_ENCAPSED_STRING","' failed attempts.'",269],")",";",["T_WHITESPACE","\n          ",269],"}",["T_WHITESPACE","\n          ",270],["T_COMMENT","\/\/ Store the failure time\n",271],["T_WHITESPACE","          ",272],["T_STRING","apc_store",272],"(",["T_VARIABLE","$failtimeKey",272],",",["T_WHITESPACE"," ",272],["T_STRING","time",272],"(",")",")",";",["T_WHITESPACE","\n\n          ",272],["T_COMMENT","\/\/ Clear the count of consecutive failures\n",274],["T_WHITESPACE","          ",275],["T_STRING","apc_store",275],"(",["T_VARIABLE","$consecfailsKey",275],",",["T_WHITESPACE"," ",275],["T_LNUMBER","0",275],")",";",["T_WHITESPACE","\n        ",275],"}",["T_WHITESPACE"," ",276],["T_ELSE","else",276],["T_WHITESPACE"," ",276],"{",["T_WHITESPACE","\n          ",276],["T_STRING","apc_store",277],"(",["T_VARIABLE","$consecfailsKey",277],",",["T_WHITESPACE"," ",277],["T_VARIABLE","$consecfails",277],")",";",["T_WHITESPACE","\n        ",277],"}",["T_WHITESPACE","\n      ",278],"}",["T_WHITESPACE","\n    ",279],"}",["T_WHITESPACE","\n\n    ",280],["T_COMMENT","\/\/ Oh no; we failed them all. The system is totally ill!\n",282],["T_WHITESPACE","    ",283],["T_VARIABLE","$error",283],["T_WHITESPACE"," ",283],"=",["T_WHITESPACE"," ",283],["T_CONSTANT_ENCAPSED_STRING","'TSocketPool: All hosts in pool are down. '",283],";",["T_WHITESPACE","\n    ",283],["T_VARIABLE","$hosts",284],["T_WHITESPACE"," ",284],"=",["T_WHITESPACE"," ",284],["T_ARRAY","array",284],"(",")",";",["T_WHITESPACE","\n    ",284],["T_FOREACH","foreach",285],["T_WHITESPACE"," ",285],"(",["T_VARIABLE","$this",285],["T_OBJECT_OPERATOR","->",285],["T_STRING","servers_",285],["T_WHITESPACE"," ",285],["T_AS","as",285],["T_WHITESPACE"," ",285],["T_VARIABLE","$server",285],")",["T_WHITESPACE"," ",285],"{",["T_WHITESPACE","\n      ",285],["T_VARIABLE","$hosts",286],["T_WHITESPACE"," ",286],"[","]","=",["T_WHITESPACE"," ",286],["T_VARIABLE","$server",286],"[",["T_CONSTANT_ENCAPSED_STRING","'host'",286],"]",".",["T_CONSTANT_ENCAPSED_STRING","':'",286],".",["T_VARIABLE","$server",286],"[",["T_CONSTANT_ENCAPSED_STRING","'port'",286],"]",";",["T_WHITESPACE","\n    ",286],"}",["T_WHITESPACE","\n    ",287],["T_VARIABLE","$hostlist",288],["T_WHITESPACE"," ",288],"=",["T_WHITESPACE"," ",288],["T_STRING","implode",288],"(",["T_CONSTANT_ENCAPSED_STRING","','",288],",",["T_WHITESPACE"," ",288],["T_VARIABLE","$hosts",288],")",";",["T_WHITESPACE","\n    ",288],["T_VARIABLE","$error",289],["T_WHITESPACE"," ",289],["T_CONCAT_EQUAL",".=",289],["T_WHITESPACE"," ",289],["T_CONSTANT_ENCAPSED_STRING","'('",289],".",["T_VARIABLE","$hostlist",289],".",["T_CONSTANT_ENCAPSED_STRING","')'",289],";",["T_WHITESPACE","\n    ",289],["T_IF","if",290],["T_WHITESPACE"," ",290],"(",["T_VARIABLE","$this",290],["T_OBJECT_OPERATOR","->",290],["T_STRING","debug_",290],")",["T_WHITESPACE"," ",290],"{",["T_WHITESPACE","\n      ",290],["T_STRING","call_user_func",291],"(",["T_VARIABLE","$this",291],["T_OBJECT_OPERATOR","->",291],["T_STRING","debugHandler_",291],",",["T_WHITESPACE"," ",291],["T_VARIABLE","$error",291],")",";",["T_WHITESPACE","\n    ",291],"}",["T_WHITESPACE","\n    ",292],["T_THROW","throw",293],["T_WHITESPACE"," ",293],["T_NEW","new",293],["T_WHITESPACE"," ",293],["T_STRING","TException",293],"(",["T_VARIABLE","$error",293],")",";",["T_WHITESPACE","\n  ",293],"}",["T_WHITESPACE","\n",294],"}",["T_WHITESPACE","\n",295]]